var t={};function e(e,s){var i;t[e]=!0,void 0!==s&&(i=s,window.console&&window.console.error&&window.console.error(i))}var s=function t(e){var s=e.gl;this.ext=e,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(e.maxVertexAttribs);for(var i=0;i<this.attribs.length;i++){var n=new t.VertexAttrib(s);this.attribs[i]=n}this.maxAttrib=0};s.VertexAttrib=function(t){this.enabled=!1,this.buffer=null,this.size=4,this.type=t.FLOAT,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()},s.VertexAttrib.prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var i=function(e){var s=this;this.gl=e,function(e){var s=e.getError;e.getError=function(){do{(i=s.apply(e))!=e.NO_ERROR&&(t[i]=!0)}while(i!=e.NO_ERROR);for(var i in t)if(t[i])return delete t[i],parseInt(i);return e.NO_ERROR}}(e);var i=this.original={getParameter:e.getParameter,enableVertexAttribArray:e.enableVertexAttribArray,disableVertexAttribArray:e.disableVertexAttribArray,bindBuffer:e.bindBuffer,getVertexAttrib:e.getVertexAttrib,vertexAttribPointer:e.vertexAttribPointer};e.getParameter=function(t){return t==s.VERTEX_ARRAY_BINDING_OES?s.currentVertexArrayObject==s.defaultVertexArrayObject?null:s.currentVertexArrayObject:i.getParameter.apply(this,arguments)},e.enableVertexAttribArray=function(t){var e=s.currentVertexArrayObject;return e.maxAttrib=Math.max(e.maxAttrib,t),e.attribs[t].enabled=!0,i.enableVertexAttribArray.apply(this,arguments)},e.disableVertexAttribArray=function(t){var e=s.currentVertexArrayObject;return e.maxAttrib=Math.max(e.maxAttrib,t),e.attribs[t].enabled=!1,i.disableVertexAttribArray.apply(this,arguments)},e.bindBuffer=function(t,n){switch(t){case e.ARRAY_BUFFER:s.currentArrayBuffer=n;break;case e.ELEMENT_ARRAY_BUFFER:s.currentVertexArrayObject.elementArrayBuffer=n}return i.bindBuffer.apply(this,arguments)},e.getVertexAttrib=function(t,n){var r=s.currentVertexArrayObject.attribs[t];switch(n){case e.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return r.buffer;case e.VERTEX_ATTRIB_ARRAY_ENABLED:return r.enabled;case e.VERTEX_ATTRIB_ARRAY_SIZE:return r.size;case e.VERTEX_ATTRIB_ARRAY_STRIDE:return r.stride;case e.VERTEX_ATTRIB_ARRAY_TYPE:return r.type;case e.VERTEX_ATTRIB_ARRAY_NORMALIZED:return r.normalized;default:return i.getVertexAttrib.apply(this,arguments)}},e.vertexAttribPointer=function(t,e,n,r,a,o){var l=s.currentVertexArrayObject;l.maxAttrib=Math.max(l.maxAttrib,t);var h=l.attribs[t];return h.buffer=s.currentArrayBuffer,h.size=e,h.type=n,h.normalized=r,h.stride=a,h.offset=o,h.recache(),i.vertexAttribPointer.apply(this,arguments)},e.instrumentExtension&&e.instrumentExtension(this,"OES_vertex_array_object"),e.canvas.addEventListener("webglcontextrestored",(function(){var t;t="OESVertexArrayObject emulation library context restored",window.console&&window.console.log&&window.console.log(t),s.reset_()}),!0),this.reset_()};i.prototype.VERTEX_ARRAY_BINDING_OES=34229,i.prototype.reset_=function(){if(void 0!==this.vertexArrayObjects)for(var t=0;t<this.vertexArrayObjects.length;++t)this.vertexArrayObjects.isAlive=!1;var e=this.gl;this.maxVertexAttribs=e.getParameter(e.MAX_VERTEX_ATTRIBS),this.defaultVertexArrayObject=new s(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)},i.prototype.createVertexArrayOES=function(){var t=new s(this);return this.vertexArrayObjects.push(t),t},i.prototype.deleteVertexArrayOES=function(t){t.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(t),1),this.currentVertexArrayObject==t&&this.bindVertexArrayOES(null)},i.prototype.isVertexArrayOES=function(t){return!!(t&&t instanceof s&&t.hasBeenBound&&t.ext==this)},i.prototype.bindVertexArrayOES=function(t){var s=this.gl;if(!t||t.isAlive){var i=this.original,n=this.currentVertexArrayObject;this.currentVertexArrayObject=t||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;var r=this.currentVertexArrayObject;if(n!=r){n&&r.elementArrayBuffer==n.elementArrayBuffer||i.bindBuffer.call(s,s.ELEMENT_ARRAY_BUFFER,r.elementArrayBuffer);for(var a=this.currentArrayBuffer,o=Math.max(n?n.maxAttrib:0,r.maxAttrib),l=0;l<=o;l++){var h=r.attribs[l],c=n?n.attribs[l]:null;if(n&&h.enabled==c.enabled||(h.enabled?i.enableVertexAttribArray.call(s,l):i.disableVertexAttribArray.call(s,l)),h.enabled){var d=!1;n&&h.buffer==c.buffer||(a!=h.buffer&&(i.bindBuffer.call(s,s.ARRAY_BUFFER,h.buffer),a=h.buffer),d=!0),(d||h.cached!=c.cached)&&i.vertexAttribPointer.call(s,l,h.size,h.type,h.normalized,h.stride,h.offset)}}this.currentArrayBuffer!=a&&i.bindBuffer.call(s,s.ARRAY_BUFFER,this.currentArrayBuffer)}}else e(s.INVALID_OPERATION,"bindVertexArrayOES: attempt to bind deleted arrayObject")};const n="1.64.4",r="7fc5c5c22",a=function(){const t={},e=["Array","Object","Function","Date","RegExp","Float32Array"];for(let s=0;s<e.length;s++)t["[object "+e[s]+"]"]=e[s].toLowerCase();return t}();function o(t){if(null===t)return"null";const e=typeof t;return"undefined"===e||"number"===e||"string"===e||"boolean"===e?e:a[Object.prototype.toString.call(t)]}function l(t,e){for(const s in e){const i=e[s];"object"===o(i)?t[s]=l({},i):"array"===o(i)?t[s]=l([],i):t[s]=i}return t}class h{constructor(){this._callbacks={},this._callbackActive={}}initEventHandler(){this._callbacks={},this._callbackActive={}}_addCallback(t,e,s,i=!1){t&&"string"==typeof t&&e&&(this._callbacks[t]||(this._callbacks[t]=[]),this._callbackActive[t]&&this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice()),this._callbacks[t].push({callback:e,scope:s||this,once:i}))}on(t,e,s){return this._addCallback(t,e,s,!1),this}off(t,e,s){if(t)this._callbackActive[t]&&this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice());else for(const t in this._callbackActive)this._callbacks[t]&&this._callbacks[t]===this._callbackActive[t]&&(this._callbackActive[t]=this._callbackActive[t].slice());if(t)if(e){const i=this._callbacks[t];if(!i)return this;let n=i.length;for(let t=0;t<n;t++)i[t].callback===e&&(s&&i[t].scope!==s||(i[t--]=i[--n]));i.length=n}else this._callbacks[t]&&(this._callbacks[t]=[]);else this._callbacks={};return this}fire(t,e,s,i,n,r,a,o,l){if(!t||!this._callbacks[t])return this;let h;this._callbackActive[t]?(this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice()),h=this._callbacks[t].slice()):this._callbackActive[t]=this._callbacks[t];for(let c=0;(h||this._callbackActive[t])&&c<(h||this._callbackActive[t]).length;c++){const d=(h||this._callbackActive[t])[c];if(d.callback.call(d.scope,e,s,i,n,r,a,o,l),d.once){const e=this._callbacks[t],s=e?e.indexOf(d):-1;-1!==s&&(this._callbackActive[t]===e&&(this._callbackActive[t]=this._callbackActive[t].slice()),this._callbacks[t].splice(s,1))}}return h||(this._callbackActive[t]=null),this}once(t,e,s){return this._addCallback(t,e,s,!0),this}hasEvent(t){return this._callbacks[t]&&0!==this._callbacks[t].length||!1}}const c={attach:function(t){const e=c;return t._addCallback=e._addCallback,t.on=e.on,t.off=e.off,t.fire=e.fire,t.once=e.once,t.hasEvent=e.hasEvent,t._callbacks={},t._callbackActive={},t},_addCallback:h.prototype._addCallback,on:h.prototype.on,off:h.prototype.off,fire:h.prototype.fire,once:h.prototype.once,hasEvent:h.prototype.hasEvent},d=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}))},u={delimiter:"/",join:function(){const t=arguments.length;let e=arguments[0];for(let s=0;s<t-1;++s){const t=arguments[s],i=arguments[s+1];i[0]!==u.delimiter?t&&i&&t[t.length-1]!==u.delimiter&&i[0]!==u.delimiter?e+=u.delimiter+i:e+=i:e=i}return e},normalize:function(t){const e=t.startsWith(u.delimiter),s=t.endsWith(u.delimiter),i=t.split("/");let n="",r=[];for(let t=0;t<i.length;t++)""!==i[t]&&"."!==i[t]&&(".."===i[t]&&r.length>0?r=r.slice(0,r.length-2):(t>0&&r.push(u.delimiter),r.push(i[t])));return n=r.join(""),e||n[0]!==u.delimiter||(n=n.slice(1)),s&&n[n.length-1]!==u.delimiter&&(n+=u.delimiter),n},split:function(t){const e=t.lastIndexOf(u.delimiter);return-1!==e?[t.substring(0,e),t.substring(e+1)]:["",t]},getBasename:function(t){return u.split(t)[1]},getDirectory:function(t){return u.split(t)[0]},getExtension:function(t){const e=t.split("?")[0].split(".").pop();return e!==t?"."+e:""},isRelativePath:function(t){return"/"!==t.charAt(0)&&null===t.match(/:\/\//)},extractPath:function(t){let e="";const s=t.split("/");let i=0;if(s.length>1)if(u.isRelativePath(t))if("."===s[0])for(i=0;i<s.length-1;++i)e+=0===i?s[i]:"/"+s[i];else if(".."===s[0])for(i=0;i<s.length-1;++i)e+=0===i?s[i]:"/"+s[i];else for(e=".",i=0;i<s.length-1;++i)e+="/"+s[i];else for(i=0;i<s.length-1;++i)e+=0===i?s[i]:"/"+s[i];return e}},p="undefined"!=typeof navigator?navigator.userAgent:"",f="undefined"!=typeof window?"browser":"node",m=/android/i.test(p)?"android":/ip([ao]d|hone)/i.test(p)?"ios":/windows/i.test(p)?"windows":/mac os/i.test(p)?"osx":/linux/i.test(p)?"linux":/cros/i.test(p)?"cros":null,g="browser"!==f?null:/(Chrome\/|Chromium\/|Edg.*\/)/.test(p)?"chrome":/Safari\//.test(p)?"safari":/Firefox\//.test(p)?"firefox":"other",_=/xbox/i.test(p),v="browser"===f&&("ontouchstart"in window||"maxTouchPoints"in navigator&&navigator.maxTouchPoints>0),b=!("browser"!==f||!navigator.getGamepads&&!navigator.webkitGetGamepads),y="undefined"!=typeof Worker,x=(()=>{let t=!1;try{const e=Object.defineProperty({},"passive",{get:function(){return t=!0,!1}});window.addEventListener("testpassive",null,e),window.removeEventListener("testpassive",null,e)}catch(t){}return t})(),w={environment:f,global:"browser"===f?window:global,browser:"browser"===f,desktop:["windows","osx","linux","cros"].includes(m),mobile:["android","ios"].includes(m),ios:"ios"===m,android:"android"===m,xbox:_,gamepads:b,touch:v,workers:y,passiveEvents:x,browserName:g};class S{static loadScript(t,e){const s=document.createElement("script");s.setAttribute("src",t),s.onload=()=>{e(null)},s.onerror=()=>{e(`Failed to load script='${t}'`)},document.body.appendChild(s)}static loadWasm(t,e,s){const i=S.wasmSupported()&&e.glueUrl&&e.wasmUrl?e.glueUrl:e.fallbackUrl;i?S.loadScript(i,(i=>{if(i)s(i,null);else{const i=window[t];window[t]=void 0,i({locateFile:()=>e.wasmUrl,onAbort:()=>{s("wasm module aborted.")}}).then((t=>{s(null,t)}))}})):s("No supported wasm modules found.",null)}static getModule(t){return S.modules.hasOwnProperty(t)||(S.modules[t]={config:null,initializing:!1,instance:null,callbacks:[]}),S.modules[t]}static initialize(t,e){if(e.initializing)return;const s=e.config;(s.glueUrl||s.wasmUrl||s.fallbackUrl)&&(e.initializing=!0,S.loadWasm(t,s,((i,n)=>{i?s.errorHandler?s.errorHandler(i):console.error(`failed to initialize module=${t} error=${i}`):(e.instance=n,e.callbacks.forEach((t=>{t(n)})))})))}}S.modules={},S.wasmSupported=(t=>{const e={};let s=e;return()=>(s===e&&(s=t()),s)})((()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const t=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(t instanceof WebAssembly.Module)return new WebAssembly.Instance(t)instanceof WebAssembly.Instance}}catch(t){}return!1}));class C{static setConfig(t,e){const s=S.getModule(t);s.config=e,s.callbacks.length>0&&S.initialize(t,s)}static getConfig(t){var e,s;return null==(e=S.modules)||null==(s=e[t])?void 0:s.config}static getInstance(t,e){const s=S.getModule(t);s.instance?e(s.instance):(s.callbacks.push(e),s.config&&S.initialize(t,s))}}class T{constructor(t){this.arraybuffer=t,this.dataView=new DataView(t),this.offset=0,this.stack=[]}get remainingBytes(){return this.dataView.byteLength-this.offset}reset(t=0){this.offset=t}skip(t){this.offset+=t}align(t){this.offset=this.offset+t-1&~(t-1)}_inc(t){return this.offset+=t,this.offset-t}readChar(){return String.fromCharCode(this.dataView.getUint8(this.offset++))}readChars(t){let e="";for(let s=0;s<t;++s)e+=this.readChar();return e}readU8(){return this.dataView.getUint8(this.offset++)}readU16(){return this.dataView.getUint16(this._inc(2),!0)}readU32(){return this.dataView.getUint32(this._inc(4),!0)}readU64(){return this.readU32()+2**32*this.readU32()}readU32be(){return this.dataView.getUint32(this._inc(4),!1)}readArray(t){for(let e=0;e<t.length;++e)t[e]=this.readU8()}readLine(){const t=this.dataView;let e="";for(;!(this.offset>=t.byteLength);){const t=String.fromCharCode(this.readU8());if("\n"===t)break;e+=t}return e}}class E extends h{constructor(t){super(),this._index={},this._list=[],this._parent=t}add(){let t=!1;const e=this._processArguments(arguments,!0);if(!e.length)return t;for(let s=0;s<e.length;s++)this._index[e[s]]||(t=!0,this._index[e[s]]=!0,this._list.push(e[s]),this.fire("add",e[s],this._parent));return t&&this.fire("change",this._parent),t}remove(){let t=!1;if(!this._list.length)return t;const e=this._processArguments(arguments,!0);if(!e.length)return t;for(let s=0;s<e.length;s++)this._index[e[s]]&&(t=!0,delete this._index[e[s]],this._list.splice(this._list.indexOf(e[s]),1),this.fire("remove",e[s],this._parent));return t&&this.fire("change",this._parent),t}clear(){if(!this._list.length)return;const t=this._list.slice(0);this._list=[],this._index={};for(let e=0;e<t.length;e++)this.fire("remove",t[e],this._parent);this.fire("change",this._parent)}has(){return!!this._list.length&&this._has(this._processArguments(arguments))}_has(t){if(!this._list.length||!t.length)return!1;for(let e=0;e<t.length;e++)if(1===t[e].length){if(this._index[t[e][0]])return!0}else{let s=!0;for(let i=0;i<t[e].length;i++)if(!this._index[t[e][i]]){s=!1;break}if(s)return!0}return!1}list(){return this._list.slice(0)}_processArguments(t,e){const s=[];let i=[];if(!t||!t.length)return s;for(let n=0;n<t.length;n++)if(t[n]instanceof Array){e||(i=[]);for(let r=0;r<t[n].length;r++)"string"==typeof t[n][r]&&(e?s.push(t[n][r]):i.push(t[n][r]));!e&&i.length&&s.push(i)}else"string"==typeof t[n]&&(e?s.push(t[n]):s.push([t[n]]));return s}get size(){return this._list.length}}const P="undefined"!=typeof window&&window.performance&&window.performance.now&&window.performance.timing?performance.now.bind(performance):Date.now,M=/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/;class A{constructor(t){this.scheme=void 0,this.authority=void 0,this.path=void 0,this.query=void 0,this.fragment=void 0;const e=t.match(M);this.scheme=e[2],this.authority=e[4],this.path=e[5],this.query=e[7],this.fragment=e[9]}toString(){let t="";return this.scheme&&(t+=this.scheme+":"),this.authority&&(t+="//"+this.authority),t+=this.path,this.query&&(t+="?"+this.query),this.fragment&&(t+="#"+this.fragment),t}getQuery(){const t={};if(this.query){const e=decodeURIComponent(this.query).split("&");for(const s of e){const e=s.split("=");t[e[0]]=e[1]}}return t}setQuery(t){let e="";for(const s in t)t.hasOwnProperty(s)&&(""!==e&&(e+="&"),e+=encodeURIComponent(s)+"="+encodeURIComponent(t[s]));this.query=e}}const k={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:function(t,e,s){return t>=s?s:t<=e?e:t},intToBytes24:function(t){return[t>>16&255,t>>8&255,255&t]},intToBytes32:function(t){return[t>>24&255,t>>16&255,t>>8&255,255&t]},bytesToInt24:function(t,e,s){return t.length&&(s=t[2],e=t[1],t=t[0]),t<<16|e<<8|s},bytesToInt32:function(t,e,s,i){return t.length&&(i=t[3],s=t[2],e=t[1],t=t[0]),(t<<24|e<<16|s<<8|i)>>>0},lerp:function(t,e,s){return t+(e-t)*k.clamp(s,0,1)},lerpAngle:function(t,e,s){return e-t>180&&(e-=360),e-t<-180&&(e+=360),k.lerp(t,e,k.clamp(s,0,1))},powerOfTwo:function(t){return 0!==t&&!(t&t-1)},nextPowerOfTwo:function(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t},nearestPowerOfTwo:function(t){return Math.pow(2,Math.round(Math.log(t)/Math.log(2)))},random:function(t,e){const s=e-t;return Math.random()*s+t},smoothstep:function(t,e,s){return s<=t?0:s>=e?1:(s=(s-t)/(e-t))*s*(3-2*s)},smootherstep:function(t,e,s){return s<=t?0:s>=e?1:(s=(s-t)/(e-t))*s*s*(s*(6*s-15)+10)},roundUp:function(t,e){return 0===e?t:Math.ceil(t/e)*e},between:function(t,e,s,i){const n=Math.min(e,s),r=Math.max(e,s);return i?t>=n&&t<=r:t>n&&t<r}};class D{constructor(t=0,e=0,s=0,i=1){this.r=void 0,this.g=void 0,this.b=void 0,this.a=void 0;const n=t.length;3===n||4===n?(this.r=t[0],this.g=t[1],this.b=t[2],this.a=void 0!==t[3]?t[3]:1):(this.r=t,this.g=e,this.b=s,this.a=i)}clone(){return new(0,this.constructor)(this.r,this.g,this.b,this.a)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this}equals(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a}set(t,e,s,i=1){return this.r=t,this.g=e,this.b=s,this.a=i,this}lerp(t,e,s){return this.r=t.r+s*(e.r-t.r),this.g=t.g+s*(e.g-t.g),this.b=t.b+s*(e.b-t.b),this.a=t.a+s*(e.a-t.a),this}fromString(t){const e=parseInt(t.replace("#","0x"),16);let s;return t.length>7?s=k.intToBytes32(e):(s=k.intToBytes24(e),s[3]=255),this.set(s[0]/255,s[1]/255,s[2]/255,s[3]/255),this}toString(t){let e="#"+((1<<24)+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1);if(!0===t){const t=Math.round(255*this.a).toString(16);this.a<16/255?e+="0"+t:e+=t}return e}}D.BLACK=Object.freeze(new D(0,0,0,1)),D.BLUE=Object.freeze(new D(0,0,1,1)),D.CYAN=Object.freeze(new D(0,1,1,1)),D.GRAY=Object.freeze(new D(.5,.5,.5,1)),D.GREEN=Object.freeze(new D(0,1,0,1)),D.MAGENTA=Object.freeze(new D(1,0,1,1)),D.RED=Object.freeze(new D(1,0,0,1)),D.WHITE=Object.freeze(new D(1,1,1,1)),D.YELLOW=Object.freeze(new D(1,1,0,1));class R{constructor(t=0,e=0,s=0){this.x=void 0,this.y=void 0,this.z=void 0,3===t.length?(this.x=t[0],this.y=t[1],this.z=t[2]):(this.x=t,this.y=e,this.z=s)}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}add2(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}clone(){return new(0,this.constructor)(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}cross(t,e){const s=t.x,i=t.y,n=t.z,r=e.x,a=e.y,o=e.z;return this.x=i*o-a*n,this.y=n*r-o*s,this.z=s*a-r*i,this}distance(t){const e=this.x-t.x,s=this.y-t.y,i=this.z-t.z;return Math.sqrt(e*e+s*s+i*i)}div(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}div2(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this.z=t.z/e.z,this}divScalar(t){return this.x/=t,this.y/=t,this.z/=t,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}lerp(t,e,s){return this.x=t.x+s*(e.x-t.x),this.y=t.y+s*(e.y-t.y),this.z=t.z+s*(e.z-t.z),this}mul(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}mul2(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}mulScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}normalize(){const t=this.x*this.x+this.y*this.y+this.z*this.z;if(t>0){const e=1/Math.sqrt(t);this.x*=e,this.y*=e,this.z*=e}return this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}min(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),this}max(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),this}project(t){const e=(this.x*t.x+this.y*t.y+this.z*t.z)/(t.x*t.x+t.y*t.y+t.z*t.z);return this.x=t.x*e,this.y=t.y*e,this.z=t.z*e,this}set(t,e,s){return this.x=t,this.y=e,this.z=s,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}sub2(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}toString(){return`[${this.x}, ${this.y}, ${this.z}]`}}R.ZERO=Object.freeze(new R(0,0,0)),R.ONE=Object.freeze(new R(1,1,1)),R.UP=Object.freeze(new R(0,1,0)),R.DOWN=Object.freeze(new R(0,-1,0)),R.RIGHT=Object.freeze(new R(1,0,0)),R.LEFT=Object.freeze(new R(-1,0,0)),R.FORWARD=Object.freeze(new R(0,0,-1)),R.BACK=Object.freeze(new R(0,0,1));class L{constructor(){this.data=new Float32Array(9),this.data[0]=this.data[4]=this.data[8]=1}clone(){return(new(0,this.constructor)).copy(this)}copy(t){const e=t.data,s=this.data;return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[8]=e[8],this}set(t){const e=this.data;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],this}equals(t){const e=this.data,s=t.data;return e[0]===s[0]&&e[1]===s[1]&&e[2]===s[2]&&e[3]===s[3]&&e[4]===s[4]&&e[5]===s[5]&&e[6]===s[6]&&e[7]===s[7]&&e[8]===s[8]}isIdentity(){const t=this.data;return 1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&1===t[4]&&0===t[5]&&0===t[6]&&0===t[7]&&1===t[8]}setIdentity(){const t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this}toString(){return"["+this.data.join(", ")+"]"}transpose(){const t=this.data;let e;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}setFromMat4(t){const e=t.data,s=this.data;return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[4],s[4]=e[5],s[5]=e[6],s[6]=e[8],s[7]=e[9],s[8]=e[10],this}transformVector(t,e=new R){const s=this.data,i=t.x,n=t.y,r=t.z;return e.x=i*s[0]+n*s[3]+r*s[6],e.y=i*s[1]+n*s[4]+r*s[7],e.z=i*s[2]+n*s[5]+r*s[8],e}}L.IDENTITY=Object.freeze(new L),L.ZERO=Object.freeze((new L).set([0,0,0,0,0,0,0,0,0]));class I{constructor(t=0,e=0){this.x=void 0,this.y=void 0,2===t.length?(this.x=t[0],this.y=t[1]):(this.x=t,this.y=e)}add(t){return this.x+=t.x,this.y+=t.y,this}add2(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScalar(t){return this.x+=t,this.y+=t,this}clone(){return new(0,this.constructor)(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}cross(t){return this.x*t.y-this.y*t.x}distance(t){const e=this.x-t.x,s=this.y-t.y;return Math.sqrt(e*e+s*s)}div(t){return this.x/=t.x,this.y/=t.y,this}div2(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this}divScalar(t){return this.x/=t,this.y/=t,this}dot(t){return this.x*t.x+this.y*t.y}equals(t){return this.x===t.x&&this.y===t.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSq(){return this.x*this.x+this.y*this.y}lerp(t,e,s){return this.x=t.x+s*(e.x-t.x),this.y=t.y+s*(e.y-t.y),this}mul(t){return this.x*=t.x,this.y*=t.y,this}mul2(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this}mulScalar(t){return this.x*=t,this.y*=t,this}normalize(){const t=this.x*this.x+this.y*this.y;if(t>0){const e=1/Math.sqrt(t);this.x*=e,this.y*=e}return this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}min(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),this}max(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),this}set(t,e){return this.x=t,this.y=e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}sub2(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}subScalar(t){return this.x-=t,this.y-=t,this}toString(){return`[${this.x}, ${this.y}]`}static angleRad(t,e){return Math.atan2(t.x*e.y-t.y*e.x,t.x*e.x+t.y*e.y)}}I.ZERO=Object.freeze(new I(0,0)),I.ONE=Object.freeze(new I(1,1)),I.UP=Object.freeze(new I(0,1)),I.DOWN=Object.freeze(new I(0,-1)),I.RIGHT=Object.freeze(new I(1,0)),I.LEFT=Object.freeze(new I(-1,0));class O{constructor(t=0,e=0,s=0,i=0){this.x=void 0,this.y=void 0,this.z=void 0,this.w=void 0,4===t.length?(this.x=t[0],this.y=t[1],this.z=t[2],this.w=t[3]):(this.x=t,this.y=e,this.z=s,this.w=i)}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}add2(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}clone(){return new(0,this.constructor)(this.x,this.y,this.z,this.w)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}div(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this}div2(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this.z=t.z/e.z,this.w=t.w/e.w,this}divScalar(t){return this.x/=t,this.y/=t,this.z/=t,this.w/=t,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}lerp(t,e,s){return this.x=t.x+s*(e.x-t.x),this.y=t.y+s*(e.y-t.y),this.z=t.z+s*(e.z-t.z),this.w=t.w+s*(e.w-t.w),this}mul(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}mul2(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this.w=t.w*e.w,this}mulScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}normalize(){const t=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;if(t>0){const e=1/Math.sqrt(t);this.x*=e,this.y*=e,this.z*=e,this.w*=e}return this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}min(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),t.w<this.w&&(this.w=t.w),this}max(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),t.w>this.w&&(this.w=t.w),this}set(t,e,s,i){return this.x=t,this.y=e,this.z=s,this.w=i,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}sub2(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}}O.ZERO=Object.freeze(new O(0,0,0,0)),O.ONE=Object.freeze(new O(1,1,1,1));const F=new I,B=new R,z=new R,N=new R,U=new R;class V{constructor(){this.data=new Float32Array(16),this.data[0]=this.data[5]=this.data[10]=this.data[15]=1}static _getPerspectiveHalfSize(t,e,s,i,n){n?(t.x=i*Math.tan(e*Math.PI/360),t.y=t.x/s):(t.y=i*Math.tan(e*Math.PI/360),t.x=t.y*s)}add2(t,e){const s=t.data,i=e.data,n=this.data;return n[0]=s[0]+i[0],n[1]=s[1]+i[1],n[2]=s[2]+i[2],n[3]=s[3]+i[3],n[4]=s[4]+i[4],n[5]=s[5]+i[5],n[6]=s[6]+i[6],n[7]=s[7]+i[7],n[8]=s[8]+i[8],n[9]=s[9]+i[9],n[10]=s[10]+i[10],n[11]=s[11]+i[11],n[12]=s[12]+i[12],n[13]=s[13]+i[13],n[14]=s[14]+i[14],n[15]=s[15]+i[15],this}add(t){return this.add2(this,t)}clone(){return(new(0,this.constructor)).copy(this)}copy(t){const e=t.data,s=this.data;return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[8]=e[8],s[9]=e[9],s[10]=e[10],s[11]=e[11],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15],this}equals(t){const e=this.data,s=t.data;return e[0]===s[0]&&e[1]===s[1]&&e[2]===s[2]&&e[3]===s[3]&&e[4]===s[4]&&e[5]===s[5]&&e[6]===s[6]&&e[7]===s[7]&&e[8]===s[8]&&e[9]===s[9]&&e[10]===s[10]&&e[11]===s[11]&&e[12]===s[12]&&e[13]===s[13]&&e[14]===s[14]&&e[15]===s[15]}isIdentity(){const t=this.data;return 1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&0===t[4]&&1===t[5]&&0===t[6]&&0===t[7]&&0===t[8]&&0===t[9]&&1===t[10]&&0===t[11]&&0===t[12]&&0===t[13]&&0===t[14]&&1===t[15]}mul2(t,e){const s=t.data,i=e.data,n=this.data,r=s[0],a=s[1],o=s[2],l=s[3],h=s[4],c=s[5],d=s[6],u=s[7],p=s[8],f=s[9],m=s[10],g=s[11],_=s[12],v=s[13],b=s[14],y=s[15];let x,w,S,C;return x=i[0],w=i[1],S=i[2],C=i[3],n[0]=r*x+h*w+p*S+_*C,n[1]=a*x+c*w+f*S+v*C,n[2]=o*x+d*w+m*S+b*C,n[3]=l*x+u*w+g*S+y*C,x=i[4],w=i[5],S=i[6],C=i[7],n[4]=r*x+h*w+p*S+_*C,n[5]=a*x+c*w+f*S+v*C,n[6]=o*x+d*w+m*S+b*C,n[7]=l*x+u*w+g*S+y*C,x=i[8],w=i[9],S=i[10],C=i[11],n[8]=r*x+h*w+p*S+_*C,n[9]=a*x+c*w+f*S+v*C,n[10]=o*x+d*w+m*S+b*C,n[11]=l*x+u*w+g*S+y*C,x=i[12],w=i[13],S=i[14],C=i[15],n[12]=r*x+h*w+p*S+_*C,n[13]=a*x+c*w+f*S+v*C,n[14]=o*x+d*w+m*S+b*C,n[15]=l*x+u*w+g*S+y*C,this}mulAffine2(t,e){const s=t.data,i=e.data,n=this.data,r=s[0],a=s[1],o=s[2],l=s[4],h=s[5],c=s[6],d=s[8],u=s[9],p=s[10],f=s[12],m=s[13],g=s[14];let _,v,b;return _=i[0],v=i[1],b=i[2],n[0]=r*_+l*v+d*b,n[1]=a*_+h*v+u*b,n[2]=o*_+c*v+p*b,n[3]=0,_=i[4],v=i[5],b=i[6],n[4]=r*_+l*v+d*b,n[5]=a*_+h*v+u*b,n[6]=o*_+c*v+p*b,n[7]=0,_=i[8],v=i[9],b=i[10],n[8]=r*_+l*v+d*b,n[9]=a*_+h*v+u*b,n[10]=o*_+c*v+p*b,n[11]=0,_=i[12],v=i[13],b=i[14],n[12]=r*_+l*v+d*b+f,n[13]=a*_+h*v+u*b+m,n[14]=o*_+c*v+p*b+g,n[15]=1,this}mul(t){return this.mul2(this,t)}transformPoint(t,e=new R){const s=this.data,i=t.x,n=t.y,r=t.z;return e.x=i*s[0]+n*s[4]+r*s[8]+s[12],e.y=i*s[1]+n*s[5]+r*s[9]+s[13],e.z=i*s[2]+n*s[6]+r*s[10]+s[14],e}transformVector(t,e=new R){const s=this.data,i=t.x,n=t.y,r=t.z;return e.x=i*s[0]+n*s[4]+r*s[8],e.y=i*s[1]+n*s[5]+r*s[9],e.z=i*s[2]+n*s[6]+r*s[10],e}transformVec4(t,e=new O){const s=this.data,i=t.x,n=t.y,r=t.z,a=t.w;return e.x=i*s[0]+n*s[4]+r*s[8]+a*s[12],e.y=i*s[1]+n*s[5]+r*s[9]+a*s[13],e.z=i*s[2]+n*s[6]+r*s[10]+a*s[14],e.w=i*s[3]+n*s[7]+r*s[11]+a*s[15],e}setLookAt(t,e,s){N.sub2(t,e).normalize(),z.copy(s).normalize(),B.cross(z,N).normalize(),z.cross(N,B);const i=this.data;return i[0]=B.x,i[1]=B.y,i[2]=B.z,i[3]=0,i[4]=z.x,i[5]=z.y,i[6]=z.z,i[7]=0,i[8]=N.x,i[9]=N.y,i[10]=N.z,i[11]=0,i[12]=t.x,i[13]=t.y,i[14]=t.z,i[15]=1,this}setFrustum(t,e,s,i,n,r){const a=2*n,o=e-t,l=i-s,h=r-n,c=this.data;return c[0]=a/o,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=a/l,c[6]=0,c[7]=0,c[8]=(e+t)/o,c[9]=(i+s)/l,c[10]=(-r-n)/h,c[11]=-1,c[12]=0,c[13]=0,c[14]=-a*r/h,c[15]=0,this}setPerspective(t,e,s,i,n){return V._getPerspectiveHalfSize(F,t,e,s,n),this.setFrustum(-F.x,F.x,-F.y,F.y,s,i)}setOrtho(t,e,s,i,n,r){const a=this.data;return a[0]=2/(e-t),a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/(i-s),a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/(r-n),a[11]=0,a[12]=-(e+t)/(e-t),a[13]=-(i+s)/(i-s),a[14]=-(r+n)/(r-n),a[15]=1,this}setFromAxisAngle(t,e){e*=k.DEG_TO_RAD;const s=t.x,i=t.y,n=t.z,r=Math.cos(e),a=Math.sin(e),o=1-r,l=o*s,h=o*i,c=this.data;return c[0]=l*s+r,c[1]=l*i+a*n,c[2]=l*n-a*i,c[3]=0,c[4]=l*i-a*n,c[5]=h*i+r,c[6]=h*n+a*s,c[7]=0,c[8]=l*n+a*i,c[9]=h*n-s*a,c[10]=o*n*n+r,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,this}setTranslate(t,e,s){const i=this.data;return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=t,i[13]=e,i[14]=s,i[15]=1,this}setScale(t,e,s){const i=this.data;return i[0]=t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=e,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}setViewport(t,e,s,i){const n=this.data;return n[0]=.5*s,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=.5*i,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=.5,n[11]=0,n[12]=t+.5*s,n[13]=e+.5*i,n[14]=.5,n[15]=1,this}setReflection(t,e){const s=t.x,i=t.y,n=t.z,r=this.data;return r[0]=1-2*s*s,r[1]=-2*s*i,r[2]=-2*s*n,r[3]=0,r[4]=-2*s*i,r[5]=1-2*i*i,r[6]=-2*i*n,r[7]=0,r[8]=-2*s*n,r[9]=-2*i*n,r[10]=1-2*n*n,r[11]=0,r[12]=-2*s*e,r[13]=-2*i*e,r[14]=-2*n*e,r[15]=1,this}invert(){const t=this.data,e=t[0],s=t[1],i=t[2],n=t[3],r=t[4],a=t[5],o=t[6],l=t[7],h=t[8],c=t[9],d=t[10],u=t[11],p=t[12],f=t[13],m=t[14],g=t[15],_=e*a-s*r,v=e*o-i*r,b=e*l-n*r,y=s*o-i*a,x=s*l-n*a,w=i*l-n*o,S=h*f-c*p,C=h*m-d*p,T=h*g-u*p,E=c*m-d*f,P=c*g-u*f,M=d*g-u*m,A=_*M-v*P+b*E+y*T-x*C+w*S;if(0===A)this.setIdentity();else{const k=1/A;t[0]=(a*M-o*P+l*E)*k,t[1]=(-s*M+i*P-n*E)*k,t[2]=(f*w-m*x+g*y)*k,t[3]=(-c*w+d*x-u*y)*k,t[4]=(-r*M+o*T-l*C)*k,t[5]=(e*M-i*T+n*C)*k,t[6]=(-p*w+m*b-g*v)*k,t[7]=(h*w-d*b+u*v)*k,t[8]=(r*P-a*T+l*S)*k,t[9]=(-e*P+s*T-n*S)*k,t[10]=(p*x-f*b+g*_)*k,t[11]=(-h*x+c*b-u*_)*k,t[12]=(-r*E+a*C-o*S)*k,t[13]=(e*E-s*C+i*S)*k,t[14]=(-p*y+f*v-m*_)*k,t[15]=(h*y-c*v+d*_)*k}return this}set(t){const e=this.data;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],this}setIdentity(){const t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}setTRS(t,e,s){const i=e.x,n=e.y,r=e.z,a=e.w,o=s.x,l=s.y,h=s.z,c=i+i,d=n+n,u=r+r,p=i*c,f=i*d,m=i*u,g=n*d,_=n*u,v=r*u,b=a*c,y=a*d,x=a*u,w=this.data;return w[0]=(1-(g+v))*o,w[1]=(f+x)*o,w[2]=(m-y)*o,w[3]=0,w[4]=(f-x)*l,w[5]=(1-(p+v))*l,w[6]=(_+b)*l,w[7]=0,w[8]=(m+y)*h,w[9]=(_-b)*h,w[10]=(1-(p+g))*h,w[11]=0,w[12]=t.x,w[13]=t.y,w[14]=t.z,w[15]=1,this}transpose(){let t;const e=this.data;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}invertTo3x3(t){const e=this.data,s=t.data,i=e[0],n=e[1],r=e[2],a=e[4],o=e[5],l=e[6],h=e[8],c=e[9],d=e[10],u=d*o-l*c,p=-d*n+r*c,f=l*n-r*o,m=-d*a+l*h,g=d*i-r*h,_=-l*i+r*a,v=c*a-o*h,b=-c*i+n*h,y=o*i-n*a,x=i*u+n*m+r*v;if(0===x)return this;const w=1/x;return s[0]=w*u,s[1]=w*p,s[2]=w*f,s[3]=w*m,s[4]=w*g,s[5]=w*_,s[6]=w*v,s[7]=w*b,s[8]=w*y,this}getTranslation(t=new R){return t.set(this.data[12],this.data[13],this.data[14])}getX(t=new R){return t.set(this.data[0],this.data[1],this.data[2])}getY(t=new R){return t.set(this.data[4],this.data[5],this.data[6])}getZ(t=new R){return t.set(this.data[8],this.data[9],this.data[10])}getScale(t=new R){return this.getX(B),this.getY(z),this.getZ(N),t.set(B.length(),z.length(),N.length()),t}get scaleSign(){return this.getX(B),this.getY(z),this.getZ(N),B.cross(B,z),B.dot(N)<0?-1:1}setFromEulerAngles(t,e,s){t*=k.DEG_TO_RAD,e*=k.DEG_TO_RAD,s*=k.DEG_TO_RAD;const i=Math.sin(-t),n=Math.cos(-t),r=Math.sin(-e),a=Math.cos(-e),o=Math.sin(-s),l=Math.cos(-s),h=this.data;return h[0]=a*l,h[1]=-a*o,h[2]=r,h[3]=0,h[4]=n*o+l*i*r,h[5]=n*l-i*r*o,h[6]=-a*i,h[7]=0,h[8]=i*o-n*l*r,h[9]=l*i+n*r*o,h[10]=n*a,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,this}getEulerAngles(t=new R){this.getScale(U);const e=U.x,s=U.y,i=U.z;if(0===e||0===s||0===i)return t.set(0,0,0);const n=this.data,r=Math.asin(-n[2]/e),a=.5*Math.PI;let o,l;return r<a?r>-a?(o=Math.atan2(n[6]/s,n[10]/i),l=Math.atan2(n[1]/e,n[0]/e)):(l=0,o=-Math.atan2(n[4]/s,n[5]/s)):(l=0,o=Math.atan2(n[4]/s,n[5]/s)),t.set(o,r,l).mulScalar(k.RAD_TO_DEG)}toString(){return"["+this.data.join(", ")+"]"}}V.IDENTITY=Object.freeze(new V),V.ZERO=Object.freeze((new V).set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));class H{constructor(t=0,e=0,s=0,i=1){this.x=void 0,this.y=void 0,this.z=void 0,this.w=void 0,4===t.length?(this.x=t[0],this.y=t[1],this.z=t[2],this.w=t[3]):(this.x=t,this.y=e,this.z=s,this.w=i)}clone(){return new(0,this.constructor)(this.x,this.y,this.z,this.w)}conjugate(){return this.x*=-1,this.y*=-1,this.z*=-1,this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}equalsApprox(t,e=1e-6){return Math.abs(this.x-t.x)<e&&Math.abs(this.y-t.y)<e&&Math.abs(this.z-t.z)<e&&Math.abs(this.w-t.w)<e}getAxisAngle(t){let e=2*Math.acos(this.w);const s=Math.sin(e/2);return 0!==s?(t.x=this.x/s,t.y=this.y/s,t.z=this.z/s,(t.x<0||t.y<0||t.z<0)&&(t.x*=-1,t.y*=-1,t.z*=-1,e*=-1)):(t.x=1,t.y=0,t.z=0),e*k.RAD_TO_DEG}getEulerAngles(t=new R){let e,s,i;const n=this.x,r=this.y,a=this.z,o=this.w,l=2*(o*r-n*a);return l<=-.99999?(e=2*Math.atan2(n,o),s=-Math.PI/2,i=0):l>=.99999?(e=2*Math.atan2(n,o),s=Math.PI/2,i=0):(e=Math.atan2(2*(o*n+r*a),1-2*(n*n+r*r)),s=Math.asin(l),i=Math.atan2(2*(o*a+n*r),1-2*(r*r+a*a))),t.set(e,s,i).mulScalar(k.RAD_TO_DEG)}invert(){return this.conjugate().normalize()}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}mul(t){const e=this.x,s=this.y,i=this.z,n=this.w,r=t.x,a=t.y,o=t.z,l=t.w;return this.x=n*r+e*l+s*o-i*a,this.y=n*a+s*l+i*r-e*o,this.z=n*o+i*l+e*a-s*r,this.w=n*l-e*r-s*a-i*o,this}mul2(t,e){const s=t.x,i=t.y,n=t.z,r=t.w,a=e.x,o=e.y,l=e.z,h=e.w;return this.x=r*a+s*h+i*l-n*o,this.y=r*o+i*h+n*a-s*l,this.z=r*l+n*h+s*o-i*a,this.w=r*h-s*a-i*o-n*l,this}normalize(){let t=this.length();return 0===t?(this.x=this.y=this.z=0,this.w=1):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t),this}set(t,e,s,i){return this.x=t,this.y=e,this.z=s,this.w=i,this}setFromAxisAngle(t,e){e*=.5*k.DEG_TO_RAD;const s=Math.sin(e),i=Math.cos(e);return this.x=s*t.x,this.y=s*t.y,this.z=s*t.z,this.w=i,this}setFromEulerAngles(t,e,s){if(t instanceof R){const i=t;t=i.x,e=i.y,s=i.z}const i=.5*k.DEG_TO_RAD;t*=i,e*=i,s*=i;const n=Math.sin(t),r=Math.cos(t),a=Math.sin(e),o=Math.cos(e),l=Math.sin(s),h=Math.cos(s);return this.x=n*o*h-r*a*l,this.y=r*a*h+n*o*l,this.z=r*o*l-n*a*h,this.w=r*o*h+n*a*l,this}setFromMat4(t){let e,s,i,n,r,a,o,l,h,c,d,u,p,f;if(e=(t=t.data)[0],s=t[1],i=t[2],n=t[4],r=t[5],a=t[6],o=t[8],l=t[9],h=t[10],u=e*e+s*s+i*i,0===u)return this;if(u=1/Math.sqrt(u),p=n*n+r*r+a*a,0===p)return this;if(p=1/Math.sqrt(p),f=o*o+l*l+h*h,0===f)return this;f=1/Math.sqrt(f),e*=u,s*=u,i*=u,n*=p,r*=p,a*=p,o*=f,l*=f,h*=f;const m=e+r+h;return m>=0?(c=Math.sqrt(m+1),this.w=.5*c,c=.5/c,this.x=(a-l)*c,this.y=(o-i)*c,this.z=(s-n)*c):e>r?e>h?(d=e-(r+h)+1,d=Math.sqrt(d),this.x=.5*d,d=.5/d,this.w=(a-l)*d,this.y=(s+n)*d,this.z=(i+o)*d):(d=h-(e+r)+1,d=Math.sqrt(d),this.z=.5*d,d=.5/d,this.w=(s-n)*d,this.x=(o+i)*d,this.y=(l+a)*d):r>h?(d=r-(h+e)+1,d=Math.sqrt(d),this.y=.5*d,d=.5/d,this.w=(o-i)*d,this.z=(a+l)*d,this.x=(n+s)*d):(d=h-(e+r)+1,d=Math.sqrt(d),this.z=.5*d,d=.5/d,this.w=(s-n)*d,this.x=(o+i)*d,this.y=(l+a)*d),this}setFromDirections(t,e){const s=1+t.dot(e);return s<Number.EPSILON?Math.abs(t.x)>Math.abs(t.y)?(this.x=-t.z,this.y=0,this.z=t.x,this.w=0):(this.x=0,this.y=-t.z,this.z=t.y,this.w=0):(this.x=t.y*e.z-t.z*e.y,this.y=t.z*e.x-t.x*e.z,this.z=t.x*e.y-t.y*e.x,this.w=s),this.normalize()}slerp(t,e,s){const i=t.x,n=t.y,r=t.z,a=t.w;let o=e.x,l=e.y,h=e.z,c=e.w,d=a*c+i*o+n*l+r*h;if(d<0&&(c=-c,o=-o,l=-l,h=-h,d=-d),Math.abs(d)>=1)return this.w=a,this.x=i,this.y=n,this.z=r,this;const u=Math.acos(d),p=Math.sqrt(1-d*d);if(Math.abs(p)<.001)return this.w=.5*a+.5*c,this.x=.5*i+.5*o,this.y=.5*n+.5*l,this.z=.5*r+.5*h,this;const f=Math.sin((1-s)*u)/p,m=Math.sin(s*u)/p;return this.w=a*f+c*m,this.x=i*f+o*m,this.y=n*f+l*m,this.z=r*f+h*m,this}transformVector(t,e=new R){const s=t.x,i=t.y,n=t.z,r=this.x,a=this.y,o=this.z,l=this.w,h=l*s+a*n-o*i,c=l*i+o*s-r*n,d=l*n+r*i-a*s,u=-r*s-a*i-o*n;return e.x=h*l+u*-r+c*-o-d*-a,e.y=c*l+u*-a+d*-r-h*-o,e.z=d*l+u*-o+h*-a-c*-r,e}toString(){return`[${this.x}, ${this.y}, ${this.z}, ${this.w}]`}}H.IDENTITY=Object.freeze(new H(0,0,0,1)),H.ZERO=Object.freeze(new H(0,0,0,0));const G=new R,W=new R,j=new R,q=new R,X=new R;class ${constructor(t=new R,e=new R(.5,.5,.5)){this.center=void 0,this.halfExtents=void 0,this._min=new R,this._max=new R,this.center=t,this.halfExtents=e}add(t){const e=this.center,s=e.x,i=e.y,n=e.z,r=this.halfExtents,a=r.x,o=r.y,l=r.z;let h=s-a,c=s+a,d=i-o,u=i+o,p=n-l,f=n+l;const m=t.center,g=m.x,_=m.y,v=m.z,b=t.halfExtents,y=b.x,x=b.y,w=b.z,S=g-y,C=g+y,T=_-x,E=_+x,P=v-w,M=v+w;S<h&&(h=S),C>c&&(c=C),T<d&&(d=T),E>u&&(u=E),P<p&&(p=P),M>f&&(f=M),e.x=.5*(h+c),e.y=.5*(d+u),e.z=.5*(p+f),r.x=.5*(c-h),r.y=.5*(u-d),r.z=.5*(f-p)}copy(t){this.center.copy(t.center),this.halfExtents.copy(t.halfExtents)}clone(){return new $(this.center.clone(),this.halfExtents.clone())}intersects(t){const e=this.getMax(),s=this.getMin(),i=t.getMax(),n=t.getMin();return s.x<=i.x&&e.x>=n.x&&s.y<=i.y&&e.y>=n.y&&s.z<=i.z&&e.z>=n.z}_intersectsRay(t,e){const s=G.copy(this.getMin()).sub(t.origin),i=W.copy(this.getMax()).sub(t.origin),n=t.direction;0===n.x?(s.x=s.x<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.x=i.x<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.x/=n.x,i.x/=n.x),0===n.y?(s.y=s.y<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.y=i.y<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.y/=n.y,i.y/=n.y),0===n.z?(s.z=s.z<0?-Number.MAX_VALUE:Number.MAX_VALUE,i.z=i.z<0?-Number.MAX_VALUE:Number.MAX_VALUE):(s.z/=n.z,i.z/=n.z);const r=j.set(Math.min(s.x,i.x),Math.min(s.y,i.y),Math.min(s.z,i.z)),a=q.set(Math.max(s.x,i.x),Math.max(s.y,i.y),Math.max(s.z,i.z)),o=Math.min(Math.min(a.x,a.y),a.z),l=Math.max(Math.max(r.x,r.y),r.z),h=o>=l&&l>=0;return h&&e.copy(t.direction).mulScalar(l).add(t.origin),h}_fastIntersectsRay(t){const e=G,s=W,i=j,n=q,r=X,a=t.direction;return e.sub2(t.origin,this.center),n.set(Math.abs(e.x),Math.abs(e.y),Math.abs(e.z)),i.mul2(e,a),!(n.x>this.halfExtents.x&&i.x>=0)&&(!(n.y>this.halfExtents.y&&i.y>=0)&&(!(n.z>this.halfExtents.z&&i.z>=0)&&(r.set(Math.abs(a.x),Math.abs(a.y),Math.abs(a.z)),s.cross(a,e),s.set(Math.abs(s.x),Math.abs(s.y),Math.abs(s.z)),!(s.x>this.halfExtents.y*r.z+this.halfExtents.z*r.y)&&(!(s.y>this.halfExtents.x*r.z+this.halfExtents.z*r.x)&&!(s.z>this.halfExtents.x*r.y+this.halfExtents.y*r.x)))))}intersectsRay(t,e){return e?this._intersectsRay(t,e):this._fastIntersectsRay(t)}setMinMax(t,e){this.center.add2(e,t).mulScalar(.5),this.halfExtents.sub2(e,t).mulScalar(.5)}getMin(){return this._min.copy(this.center).sub(this.halfExtents)}getMax(){return this._max.copy(this.center).add(this.halfExtents)}containsPoint(t){const e=this.getMin(),s=this.getMax();return!(t.x<e.x||t.x>s.x||t.y<e.y||t.y>s.y||t.z<e.z||t.z>s.z)}setFromTransformedAabb(t,e,s=!1){const i=t.center,n=t.halfExtents,r=e.data;let a=r[0],o=r[4],l=r[8],h=r[1],c=r[5],d=r[9],u=r[2],p=r[6],f=r[10];if(s){let t=a*a+o*o+l*l;if(t>0){const e=1/Math.sqrt(t);a*=e,o*=e,l*=e}if(t=h*h+c*c+d*d,t>0){const e=1/Math.sqrt(t);h*=e,c*=e,d*=e}if(t=u*u+p*p+f*f,t>0){const e=1/Math.sqrt(t);u*=e,p*=e,f*=e}}this.center.set(r[12]+a*i.x+o*i.y+l*i.z,r[13]+h*i.x+c*i.y+d*i.z,r[14]+u*i.x+p*i.y+f*i.z),this.halfExtents.set(Math.abs(a)*n.x+Math.abs(o)*n.y+Math.abs(l)*n.z,Math.abs(h)*n.x+Math.abs(c)*n.y+Math.abs(d)*n.z,Math.abs(u)*n.x+Math.abs(p)*n.y+Math.abs(f)*n.z)}static computeMinMax(t,e,s,i=t.length/3){if(i>0){let n=t[0],r=t[1],a=t[2],o=n,l=r,h=a;const c=3*i;for(let e=3;e<c;e+=3){const s=t[e],i=t[e+1],c=t[e+2];s<n&&(n=s),i<r&&(r=i),c<a&&(a=c),s>o&&(o=s),i>l&&(l=i),c>h&&(h=c)}e.set(n,r,a),s.set(o,l,h)}}compute(t,e){$.computeMinMax(t,G,W,e),this.setMinMax(G,W)}intersectsBoundingSphere(t){return this._distanceToBoundingSphereSq(t)<=t.radius*t.radius}_distanceToBoundingSphereSq(t){const e=this.getMin(),s=this.getMax();let i=0;const n=["x","y","z"];for(let r=0;r<3;++r){let a=0;const o=t.center[n[r]],l=e[n[r]],h=s[n[r]];let c=0;o<l&&(c=l-o,a+=c*c),o>h&&(c=o-h,a+=c*c),i+=a}return i}_expand(t,e){G.add2(this.getMin(),t),W.add2(this.getMax(),e),this.setMinMax(G,W)}}const K=new R,Y=new R;class Q{constructor(t=new R,e=.5){this.center=void 0,this.radius=void 0,this.center=t,this.radius=e}containsPoint(t){const e=K.sub2(t,this.center).lengthSq(),s=this.radius;return e<s*s}intersectsRay(t,e){const s=K.copy(t.origin).sub(this.center),i=s.dot(Y.copy(t.direction).normalize()),n=s.dot(s)-this.radius*this.radius;if(n>0&&i>0)return!1;const r=i*i-n;if(r<0)return!1;const a=Math.abs(-i-Math.sqrt(r));return e&&e.copy(t.direction).mulScalar(a).add(t.origin),!0}intersectsBoundingSphere(t){K.sub2(t.center,this.center);const e=t.radius+this.radius;return K.lengthSq()<=e*e}}class J{constructor(){this.planes=[];for(let t=0;t<6;t++)this.planes[t]=[]}setFromMat4(t){const e=t.data;let s;const i=this.planes;s=i[0],s[0]=e[3]-e[0],s[1]=e[7]-e[4],s[2]=e[11]-e[8],s[3]=e[15]-e[12];let n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]);s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[1],s[0]=e[3]+e[0],s[1]=e[7]+e[4],s[2]=e[11]+e[8],s[3]=e[15]+e[12],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[2],s[0]=e[3]+e[1],s[1]=e[7]+e[5],s[2]=e[11]+e[9],s[3]=e[15]+e[13],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[3],s[0]=e[3]-e[1],s[1]=e[7]-e[5],s[2]=e[11]-e[9],s[3]=e[15]-e[13],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[4],s[0]=e[3]-e[2],s[1]=e[7]-e[6],s[2]=e[11]-e[10],s[3]=e[15]-e[14],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n,s=i[5],s[0]=e[3]+e[2],s[1]=e[7]+e[6],s[2]=e[11]+e[10],s[3]=e[15]+e[14],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),s[0]/=n,s[1]/=n,s[2]/=n,s[3]/=n}containsPoint(t){let e,s;for(e=0;e<6;e++)if(s=this.planes[e],s[0]*t.x+s[1]*t.y+s[2]*t.z+s[3]<=0)return!1;return!0}containsSphere(t){let e,s,i=0;const n=t.radius,r=t.center,a=r.x,o=r.y,l=r.z,h=this.planes;let c;for(s=0;s<6;s++){if(c=h[s],e=c[0]*a+c[1]*o+c[2]*l+c[3],e<=-n)return 0;e>n&&i++}return 6===i?2:1}}class Z{constructor(t,e){this.origin=new R,this.direction=R.FORWARD.clone(),t&&this.origin.copy(t),e&&this.direction.copy(e)}set(t,e){return this.origin.copy(t),this.direction.copy(e),this}copy(t){return this.set(t.origin,t.direction)}clone(){return new this.constructor(this.origin,this.direction)}}const tt=0,et=12,st=14,it=16,nt=new Map([[0,{name:"A8",size:1}],[1,{name:"L8",size:1}],[2,{name:"LA8",size:2}],[3,{name:"RGB565",size:2}],[4,{name:"RGBA5551",size:2}],[5,{name:"RGBA4",size:2}],[6,{name:"RGB8",size:4}],[7,{name:"RGBA8",size:4}],[11,{name:"RGB16F",size:8}],[et,{name:"RGBA16F",size:8}],[13,{name:"RGB32F",size:16}],[st,{name:"RGBA32F",size:16}],[15,{name:"R32F",size:4}],[it,{name:"DEPTH",size:4}],[17,{name:"DEPTHSTENCIL",size:4}],[18,{name:"111110F",size:4}],[19,{name:"SRGB",size:4}],[20,{name:"SRGBA",size:4}],[31,{name:"BGRA8",size:4}],[8,{name:"DXT1",blockSize:8}],[9,{name:"DXT3",blockSize:16}],[10,{name:"DXT5",blockSize:16}],[21,{name:"ETC1",blockSize:8}],[22,{name:"ETC2_RGB",blockSize:8}],[23,{name:"ETC2_RGBA",blockSize:16}],[24,{name:"PVRTC_2BPP_RGB_1",blockSize:8}],[25,{name:"PVRTC_2BPP_RGBA_1",blockSize:8}],[26,{name:"PVRTC_4BPP_RGB_1",blockSize:8}],[27,{name:"PVRTC_4BPP_RGBA_1",blockSize:8}],[28,{name:"ASTC_4x4",blockSize:16}],[29,{name:"ATC_RGB",blockSize:8}],[30,{name:"ATC_RGBA",blockSize:16}]]),rt=5,at="POSITION",ot="NORMAL",lt="TANGENT",ht="BLENDWEIGHT",ct="BLENDINDICES",dt="COLOR",ut="TEXCOORD",pt="TEXCOORD0",ft="TEXCOORD1",mt="TEXCOORD2",gt="TEXCOORD3",_t="TEXCOORD4",vt="TEXCOORD5",bt="TEXCOORD6",yt="TEXCOORD7",xt="ATTR0",wt="ATTR8",St="ATTR9",Ct="ATTR10",Tt="ATTR11",Et="ATTR12",Pt="ATTR13",Mt="ATTR14",At="ATTR15",kt="default",Dt="rgbm",Rt="rgbe",Lt="rgbp",It="swizzleGGGR",Ot="2d",Ft="cube",Bt="equirect",zt=1,Nt=14,Ut=["bool","int","float","vec2","vec3","vec4","ivec2","ivec3","ivec4","bec2","bec3","bec4","mat2","mat3","mat4","sampler2D","samplerCube","","sampler2DShadow","samplerCubeShadow","sampler3D","","",""],Vt="default",Ht=["view","mesh"],Gt=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array],Wt=[1,1,2,2,4,4,4],jt=[Uint8Array,Uint16Array,Uint32Array],qt=[1,2,4],Xt={};Xt[at]=0,Xt[ot]=1,Xt[ht]=2,Xt[ct]=3,Xt[dt]=4,Xt[pt]=5,Xt[ft]=6,Xt[mt]=7,Xt[gt]=8,Xt[_t]=9,Xt[vt]=10,Xt[bt]=11,Xt[yt]=12,Xt[lt]=13,Xt[xt]=0,Xt.ATTR1=1,Xt.ATTR2=2,Xt.ATTR3=3,Xt.ATTR4=4,Xt.ATTR5=5,Xt.ATTR6=6,Xt.ATTR7=7,Xt[wt]=8,Xt[St]=9,Xt[Ct]=10,Xt[Tt]=11,Xt[Et]=12,Xt[Pt]=13,Xt[Mt]=14,Xt[At]=15;function $t(){return $t=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var s=arguments[e];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(t[i]=s[i])}return t},$t.apply(this,arguments)}const Kt=function(t,e,s,i=1){return t&~(i<<s)|e<<s},Yt=function(t,e,s=1){return t>>e&s},Qt=function(t,e,s=1){const i=s<<e;return(t&i)===i},Jt=15;class Zt{constructor(t=!1,e=0,s=1,i=0,n,r,a,o=!0,l=!0,h=!0,c=!0){this.target0=0,this.setColorBlend(e,s,i),this.setAlphaBlend(null!=n?n:e,null!=r?r:s,null!=a?a:i),this.setColorWrite(o,l,h,c),this.blend=t}set blend(t){this.target0=Kt(this.target0,t?1:0,26)}get blend(){return Qt(this.target0,26)}setColorBlend(t,e,s){this.target0=Kt(this.target0,t,0,7),this.target0=Kt(this.target0,e,3,Jt),this.target0=Kt(this.target0,s,7,Jt)}setAlphaBlend(t,e,s){this.target0=Kt(this.target0,t,11,7),this.target0=Kt(this.target0,e,14,Jt),this.target0=Kt(this.target0,s,18,Jt)}setColorWrite(t,e,s,i){this.redWrite=t,this.greenWrite=e,this.blueWrite=s,this.alphaWrite=i}get colorOp(){return Yt(this.target0,0,7)}get colorSrcFactor(){return Yt(this.target0,3,Jt)}get colorDstFactor(){return Yt(this.target0,7,Jt)}get alphaOp(){return Yt(this.target0,11,7)}get alphaSrcFactor(){return Yt(this.target0,14,Jt)}get alphaDstFactor(){return Yt(this.target0,18,Jt)}set redWrite(t){this.target0=Kt(this.target0,t?1:0,22)}get redWrite(){return Qt(this.target0,22)}set greenWrite(t){this.target0=Kt(this.target0,t?1:0,23)}get greenWrite(){return Qt(this.target0,23)}set blueWrite(t){this.target0=Kt(this.target0,t?1:0,24)}get blueWrite(){return Qt(this.target0,24)}set alphaWrite(t){this.target0=Kt(this.target0,t?1:0,25)}get alphaWrite(){return Qt(this.target0,25)}get allWrite(){return Yt(this.target0,22,15)}copy(t){return this.target0=t.target0,this}clone(){return(new this.constructor).copy(this)}get key(){return this.target0}equals(t){return this.target0===t.target0}}Zt.NOBLEND=Object.freeze(new Zt),Zt.NOWRITE=Object.freeze(new Zt(void 0,void 0,void 0,void 0,void 0,void 0,void 0,!1,!1,!1,!1)),Zt.ALPHABLEND=Object.freeze(new Zt(!0,0,6,8));class te{constructor(t=3,e=!0){this.data=0,this.func=t,this.write=e}set test(t){this.func=t?3:7}get test(){return 7!==this.func}set write(t){this.data=Kt(this.data,t?1:0,3)}get write(){return Qt(this.data,3)}set func(t){this.data=Kt(this.data,t,0,7)}get func(){return Yt(this.data,0,7)}copy(t){return this.data=t.data,this}clone(){return(new this.constructor).copy(this)}get key(){return this.data}equals(t){return this.data===t.data}}te.DEFAULT=Object.freeze(new te),te.NODEPTH=Object.freeze(new te(7,!1)),te.WRITEDEPTH=Object.freeze(new te(7,!0));class ee{constructor(){this.globalId=0,this.revision=0}equals(t){return this.globalId===t.globalId&&this.revision===t.revision}copy(t){this.globalId=t.globalId,this.revision=t.revision}reset(){this.globalId=0,this.revision=0}}let se=0;class ie{constructor(){se++,this.version=new ee,this.version.globalId=se}increment(){this.version.revision++}}class ne{constructor(t){this.name=t,this.value=null,this.versionObject=new ie}toJSON(t){}setValue(t){this.value=t,this.versionObject.increment()}getValue(){return this.value}}class re{constructor(t){this.name=t,this.variables=new Map}resolve(t){return this.variables.has(t)||this.variables.set(t,new ne(t)),this.variables.get(t)}removeValue(t){for(const e in this.variables){const s=this.variables[e];s.value===t&&(s.value=null)}}}let ae=0;class oe{constructor(t,e,s,i=0,n){this.device=t,this.format=e,this.numVertices=s,this.usage=i,this.id=ae++,this.impl=t.createVertexBufferImpl(this,e),this.numBytes=e.verticesByteSize?e.verticesByteSize:e.size*s,this.adjustVramSizeTracking(t._vram,this.numBytes),n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),this.device.buffers.push(this)}destroy(){const t=this.device,e=t.buffers.indexOf(this);-1!==e&&t.buffers.splice(e,1),this.impl.initialized&&(this.impl.destroy(t),this.adjustVramSizeTracking(t._vram,-this.storage.byteLength))}adjustVramSizeTracking(t,e){t.vb+=e}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getUsage(){return this.usage}getNumVertices(){return this.numVertices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(t){return t.byteLength===this.numBytes&&(this.storage=t,this.unlock(),!0)}}function le(t){let e=0;for(let s=0,i=t.length;s<i;s++)e=(e<<5)-e+t.charCodeAt(s),e|=0;return e}class he{constructor(t,e,s){this.device=t,this._elements=[],this.hasUv0=!1,this.hasUv1=!1,this.hasColor=!1,this.hasTangents=!1,this.verticesByteSize=0,this.vertexCount=s,this.interleaved=void 0===s,this.instancing=!1,this.size=e.reduce(((t,e)=>t+4*Math.ceil(e.components*Wt[e.type]/4)),0);let i,n=0;for(let t=0,a=e.length;t<a;t++){var r;const a=e[t];i=a.components*Wt[a.type],s&&(n=k.roundUp(n,i));const o={name:a.semantic,offset:s?n:a.hasOwnProperty("offset")?a.offset:n,stride:s?i:a.hasOwnProperty("stride")?a.stride:this.size,dataType:a.type,numComponents:a.components,normalize:null!=(r=a.normalize)&&r,size:i};this._elements.push(o),n+=s?i*s:4*Math.ceil(i/4),a.semantic===pt?this.hasUv0=!0:a.semantic===ft?this.hasUv1=!0:a.semantic===dt?this.hasColor=!0:a.semantic===lt&&(this.hasTangents=!0)}s&&(this.verticesByteSize=n),this._evaluateHash()}get elements(){return this._elements}static getDefaultInstancingFormat(t){return he._defaultInstancingFormat||(he._defaultInstancingFormat=new he(t,[{semantic:Et,components:4,type:6},{semantic:Pt,components:4,type:6},{semantic:Mt,components:4,type:6},{semantic:At,components:4,type:6}])),he._defaultInstancingFormat}update(){this._evaluateHash()}_evaluateHash(){let t;const e=[];let s;const i=[],n=this._elements.length;for(let r=0;r<n;r++){const n=this._elements[r];t=n.name,t+=n.dataType,t+=n.numComponents,t+=n.normalize,e.push(t),s=t,s+=n.offset,s+=n.stride,s+=n.size,i.push(s)}e.sort(),this.batchingHash=le(e.join()),this.renderingHashString=i.join("_"),this.renderingHash=le(this.renderingHashString)}}he._defaultInstancingFormat=null;class ce{constructor(t={}){var e,s,i,n,r,a,o;this.func=void 0,this.ref=void 0,this.fail=void 0,this.zfail=void 0,this.zpass=void 0,this.readMask=void 0,this.writeMask=void 0,this.func=null!=(e=t.func)?e:7,this.ref=null!=(s=t.ref)?s:0,this.readMask=null!=(i=t.readMask)?i:255,this.writeMask=null!=(n=t.writeMask)?n:255,this.fail=null!=(r=t.fail)?r:0,this.zfail=null!=(a=t.zfail)?a:0,this.zpass=null!=(o=t.zpass)?o:0}get key(){const{func:t,ref:e,fail:s,zfail:i,zpass:n,readMask:r,writeMask:a}=this;return`${t},${e},${s},${i},${n},${r},${a}`}copy(t){return this.func=t.func,this.ref=t.ref,this.readMask=t.readMask,this.writeMask=t.writeMask,this.fail=t.fail,this.zfail=t.zfail,this.zpass=t.zpass,this}clone(){return(new this.constructor).copy(this)}}ce.DEFAULT=Object.freeze(new ce);class de extends h{constructor(t,e){var s,i,n,r;super(),this.canvas=void 0,this.isWebGPU=!1,this.scope=void 0,this.boneLimit=void 0,this.maxAnisotropy=void 0,this.maxCubeMapSize=void 0,this.maxTextureSize=void 0,this.maxVolumeSize=void 0,this.maxColorAttachments=1,this.precision=void 0,this.samples=void 0,this.supportsStencil=void 0,this.supportsMrt=!1,this.supportsVolumeTextures=!1,this.renderTarget=null,this.renderVersion=0,this.renderPassIndex=void 0,this.insideRenderPass=!1,this.supportsInstancing=void 0,this.supportsUniformBuffers=!1,this.textureFloatRenderable=void 0,this.textureHalfFloatRenderable=void 0,this.quadVertexBuffer=void 0,this.blendState=new Zt,this.depthState=new te,this.stencilEnabled=!1,this.stencilFront=new ce,this.stencilBack=new ce,this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:3},this.canvas=t,this.initOptions=$t({},e),null!=(s=this.initOptions).depth||(s.depth=!0),null!=(i=this.initOptions).stencil||(i.stencil=!0),null!=(n=this.initOptions).antialias||(n.antialias=!0),null!=(r=this.initOptions).powerPreference||(r.powerPreference="high-performance"),this._width=0,this._height=0,this._maxPixelRatio=w.browser?Math.min(1,window.devicePixelRatio):1,this.shaders=[],this.buffers=[],this.textures=[],this.targets=[],this._vram={tex:0,vb:0,ib:0,ub:0},this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},this.initializeContextCaches(),this._drawCallsPerFrame=0,this._shaderSwitchesPerFrame=0,this._primsPerFrame=[];for(let t=0;t<=6;t++)this._primsPerFrame[t]=0;this._renderTargetCreationTime=0,this.scope=new re("Device"),this.textureBias=this.scope.resolve("textureBias"),this.textureBias.setValue(0)}postInit(){const t=new he(this,[{semantic:at,components:2,type:6}]),e=new Float32Array([-1,-1,1,-1,-1,1,1,1]);this.quadVertexBuffer=new oe(this,t,4,0,e)}destroy(){var t;this.fire("destroy"),null==(t=this.quadVertexBuffer)||t.destroy(),this.quadVertexBuffer=null}onDestroyShader(t){this.fire("destroy:shader",t);const e=this.shaders.indexOf(t);-1!==e&&this.shaders.splice(e,1)}postDestroy(){this.scope=null,this.canvas=null}toJSON(t){}initializeContextCaches(){this.indexBuffer=null,this.vertexBuffers=[],this.shader=null,this.renderTarget=null}initializeRenderState(){this.blendState=new Zt,this.depthState=new te,this.cullMode=1,this.vx=this.vy=this.vw=this.vh=0,this.sx=this.sy=this.sw=this.sh=0}setStencilState(t,e){}setBlendState(t){}setDepthState(t){}setCullMode(t){}setRenderTarget(t){this.renderTarget=t}setIndexBuffer(t){this.indexBuffer=t}setVertexBuffer(t){t&&this.vertexBuffers.push(t)}getRenderTarget(){return this.renderTarget}initRenderTarget(t){t.initialized||(t.init(),this.targets.push(t))}_isBrowserInterface(t){return this._isImageBrowserInterface(t)||this._isImageCanvasInterface(t)||this._isImageVideoInterface(t)}_isImageBrowserInterface(t){return"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap||"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement}_isImageCanvasInterface(t){return"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement}_isImageVideoInterface(t){return"undefined"!=typeof HTMLVideoElement&&t instanceof HTMLVideoElement}resizeCanvas(t,e){}setResolution(t,e){this._width=t,this._height=e,this.canvas.width=t,this.canvas.height=e,this.fire(de.EVENT_RESIZE,t,e)}updateClientRect(){this.clientRect=this.canvas.getBoundingClientRect()}get width(){return this.canvas.width}get height(){return this.canvas.height}set fullscreen(t){}get fullscreen(){return!1}set maxPixelRatio(t){this._maxPixelRatio!==t&&(this._maxPixelRatio=t,this.resizeCanvas(this._width,this._height))}get maxPixelRatio(){return this._maxPixelRatio}get deviceType(){return this._deviceType}getBoneLimit(){return this.boneLimit}setBoneLimit(t){this.boneLimit=t}frameStart(){this.renderPassIndex=0,this.renderVersion++}}de.EVENT_RESIZE="resizecanvas";let ue=0;class pe{constructor(t={}){var e,s,i,n,r,a,o;this.name=void 0,this._device=void 0,this._colorBuffer=void 0,this._colorBuffers=void 0,this._depthBuffer=void 0,this._depth=void 0,this._stencil=void 0,this._samples=void 0,this.autoResolve=void 0,this._face=void 0,this.flipY=void 0,this.id=ue++;const l=arguments[1],h=arguments[2];if(t instanceof de?(this._colorBuffer=l,t=h):this._colorBuffer=t.colorBuffer,this._colorBuffer&&(this._colorBuffers=[this._colorBuffer]),this._depthBuffer=t.depthBuffer,this._face=null!=(e=t.face)?e:0,this._depthBuffer){const t=this._depthBuffer._format;t===it?(this._depth=!0,this._stencil=!1):17===t?(this._depth=!0,this._stencil=!0):(this._depth=!1,this._stencil=!1)}else{var c,d;this._depth=null==(c=t.depth)||c,this._stencil=null!=(d=t.stencil)&&d}t.colorBuffers&&(this._colorBuffers||(this._colorBuffers=[...t.colorBuffers],this._colorBuffer=t.colorBuffers[0]));const u=(null==(s=this._colorBuffer)?void 0:s.device)||(null==(i=this._depthBuffer)?void 0:i.device)||t.graphicsDevice;this._device=u,null==(n=this._colorBuffers)||n.forEach((t=>{t._isRenderTarget=!0}));const{maxSamples:p}=this._device;var f,m;(this._samples=Math.min(null!=(r=t.samples)?r:1,p),u.isWebGPU&&(this._samples=this._samples>1?p:1),this.autoResolve=null==(a=t.autoResolve)||a,this.name=t.name,this.name)||(this.name=null==(f=this._colorBuffer)?void 0:f.name);this.name||(this.name=null==(m=this._depthBuffer)?void 0:m.name);this.name||(this.name="Untitled"),this.flipY=null!=(o=t.flipY)&&o,this.validateMrt(),this.impl=u.createRenderTargetImpl(this)}destroy(){const t=this._device;if(t){const e=t.targets.indexOf(this);-1!==e&&t.targets.splice(e,1),t.renderTarget===this&&t.setRenderTarget(null),this.destroyFrameBuffers()}}destroyFrameBuffers(){const t=this._device;t&&this.impl.destroy(t)}destroyTextureBuffers(){var t,e;null==(t=this._depthBuffer)||t.destroy(),this._depthBuffer=null,null==(e=this._colorBuffers)||e.forEach((t=>{t.destroy()})),this._colorBuffers=null,this._colorBuffer=null}validateMrt(){}init(){this.impl.init(this._device,this)}get initialized(){return this.impl.initialized}loseContext(){this.impl.loseContext()}resolve(t=!0,e=!!this._depthBuffer){this._device&&this._samples>1&&this.impl.resolve(this._device,this,t,e)}copy(t,e,s){if(!this._device){if(!t._device)return!1;this._device=t._device}return this._device.copyRenderTarget(t,this,e,s)}get samples(){return this._samples}get depth(){return this._depth}get stencil(){return this._stencil}get colorBuffer(){return this._colorBuffer}getColorBuffer(t){var e;return null==(e=this._colorBuffers)?void 0:e[t]}get depthBuffer(){return this._depthBuffer}get face(){return this._face}get width(){var t,e;return(null==(t=this._colorBuffer)?void 0:t.width)||(null==(e=this._depthBuffer)?void 0:e.width)||this._device.width}get height(){var t,e;return(null==(t=this._colorBuffer)?void 0:t.height)||(null==(e=this._depthBuffer)?void 0:e.height)||this._device.height}}const fe=[];fe[2]=1,fe[3]=2,fe[4]=3,fe[5]=4,fe[1]=1,fe[6]=2,fe[7]=3,fe[8]=4,fe[0]=1,fe[9]=2,fe[10]=3,fe[11]=4,fe[12]=8,fe[13]=12,fe[14]=16;class me{constructor(t,e,s=0){if(this.name=void 0,this.type=void 0,this.byteSize=void 0,this.offset=void 0,this.scopeId=void 0,this.count=void 0,this.shortName=t,this.name=s?`${t}[0]`:t,this.type=e,this.updateType=e,s)switch(e){case 2:this.updateType=17;break;case 3:this.updateType=21;break;case 4:this.updateType=22;break;case 5:this.updateType=23;break;case Nt:this.updateType=24}this.count=s;let i=fe[e];s&&(i=k.roundUp(i,4)),this.byteSize=4*i,s&&(this.byteSize*=s)}calculateOffset(t){let e=this.byteSize<=8?this.byteSize:16;this.count&&(e=16),t=k.roundUp(t,e),this.offset=t/4}}class ge{constructor(t,e){this.byteSize=0,this.map=new Map,this.scope=t.scope,this.uniforms=e;let s=0;for(let t=0;t<e.length;t++){const i=e[t];i.calculateOffset(s),s=4*i.offset+i.byteSize,i.scopeId=this.scope.resolve(i.name),this.map.set(i.name,i)}this.byteSize=k.roundUp(s,16)}get(t){return this.map.get(t)}getShaderDeclaration(t,e){let s=`layout(set = ${t}, binding = ${e}, std140) uniform ub_${Ht[t]} {\n`;return this.uniforms.forEach((t=>{const e=Ut[t.type];s+=`    ${e} ${t.shortName}${t.count?`[${t.count}]`:""};\n`})),s+"};\n"}}let _e=0;const ve={[Ot]:"texture2D",cube:"textureCube","3d":"texture3D"};class be{constructor(t,e){this.name=t,this.visibility=e}}class ye{constructor(t,e,s=Ot,i=0){this.scopeId=void 0,this.name=t,this.visibility=e,this.textureDimension=s,this.sampleType=i}}class xe{constructor(t,e=[],s=[]){this.id=_e++,this.device=t,this.bufferFormats=e,this.bufferFormatsMap=new Map,e.forEach(((t,e)=>this.bufferFormatsMap.set(t.name,e))),this.textureFormats=s;const i=t.scope;this.textureFormatsMap=new Map,s.forEach(((t,e)=>{this.textureFormatsMap.set(t.name,e),t.scopeId=i.resolve(t.name)})),this.impl=t.createBindGroupFormatImpl(this)}destroy(){this.impl.destroy()}getTexture(t){const e=this.textureFormatsMap.get(t);return void 0!==e?this.textureFormats[e]:null}getShaderDeclarationTextures(t){let e="",s=this.bufferFormats.length;return this.textureFormats.forEach((i=>{const n=ve[i.textureDimension];e+=`layout(set = ${t}, binding = ${s++}) uniform ${n} ${i.name};\nlayout(set = ${t}, binding = ${s++}) uniform sampler ${i.name}_sampler;\n`})),e}loseContext(){}}class we{static calcLevelDimension(t,e){return Math.max(t>>e,1)}static calcLevelGpuSize(t,e,s){var i,n,r;const a=nt.get(s),o=null!=(i=null==(n=nt.get(s))?void 0:n.size)?i:0;if(o>0)return t*e*o;const l=null!=(r=a.blockSize)?r:0;let h=Math.floor((t+3)/4);const c=Math.floor((e+3)/4);return 24!==s&&25!==s||(h=Math.max(Math.floor(h/2),1)),h*c*l}static calcGpuSize(t,e,s,i,n,r){let a=0;for(;a+=we.calcLevelGpuSize(t,e,i),n&&(1!==t||1!==e||1!==s);)t=Math.max(t>>1,1),e=Math.max(e>>1,1),s=Math.max(s>>1,1);return a*(r?6:1)}}const Se=/[ \t]*#(ifn?def|if|endif|else|elif|define|undef|extension)/g,Ce=/define[ \t]+([^\n]+)\r?(?:\n|$)/g,Te=/extension[ \t]+([\w-]+)[ \t]*:[ \t]*(enable|require)/g,Ee=/undef[ \t]+([^\n]+)\r?(?:\n|$)/g,Pe=/(ifdef|ifndef|if)[ \t]*([^\r\n]+)\r?\n/g,Me=/(endif|else|elif)([ \t]+[^\r\n]+)?\r?(?:\n|$)/g,Ae=/([\w-]+)/,ke=/(!|\s)?defined\(([\w-]+)\)/,De=/[><=|&+-]/g;class Re{static run(t,e=!1){t=(t=t.replace(/\/\*[\s\S]*?\*\/|([^\\:]|^)\/\/.*$/gm,"$1")).split(/\r?\n/).map((t=>t.trimEnd())).join("\n");const s=new Map;if(e){const e=new Map,i=/(pcFragColor[1-8])\b/g,n=t.match(i);null==n||n.forEach((t=>{var s;const i=parseInt(t.charAt(t.length-1),10);e.set(i,(null!=(s=e.get(i))?s:0)+1)})),e.forEach(((t,e)=>{1===t&&s.set(`REMOVE_COLOR_ATTACHMENT_${e}`,"")}))}return null!==(t=this._preprocess(t,s))&&(t=(t=t.split(/\r?\n/).map((t=>""===t.trim()?"":t)).join("\n")).replace(/(\n\n){3,}/gm,"\n\n")),t}static _preprocess(t,e=new Map){const s=t,i=[];let n,r=!1;for(;null!==(n=Se.exec(t));){const s=n[1];switch(s){case"define":{Ce.lastIndex=n.index;const s=Ce.exec(t);r||(r=null===s);const a=s[1];Ae.lastIndex=s.index;const o=Ae.exec(a)[1];let l=a.substring(o.length).trim();""===l&&(l="true");Re._keep(i)&&e.set(o,l),Se.lastIndex=s.index+s[0].length;break}case"undef":{Ee.lastIndex=n.index;const s=Ee.exec(t),r=s[1].trim();Re._keep(i)&&e.delete(r),Se.lastIndex=s.index+s[0].length;break}case"extension":{Te.lastIndex=n.index;const s=Te.exec(t);if(r||(r=null===s),s){const t=s[1];Re._keep(i)&&e.set(t,"true")}Se.lastIndex=s.index+s[0].length;break}case"ifdef":case"ifndef":case"if":{Pe.lastIndex=n.index;const a=Pe.exec(t),o=a[2],l=Re.evaluate(o,e);r||(r=l.error);let h=l.result;"ifndef"===s&&(h=!h),i.push({anyKeep:h,keep:h,start:n.index,end:Pe.lastIndex}),Se.lastIndex=a.index+a[0].length;break}case"endif":case"else":case"elif":{Me.lastIndex=n.index;const s=Me.exec(t),a=i.pop(),o=a.keep?t.substring(a.end,n.index):"";t=t.substring(0,a.start)+o+t.substring(Me.lastIndex),Se.lastIndex=a.start+o.length;const l=s[1];if("else"===l||"elif"===l){let t=!1;if(!a.anyKeep)if("else"===l)t=!a.keep;else{const i=Re.evaluate(s[2],e);t=i.result,r||(r=i.error)}i.push({anyKeep:a.anyKeep||t,keep:t,start:Se.lastIndex,end:Se.lastIndex})}break}}}return r?(console.warn("Failed to preprocess shader: ",{source:s}),s):t}static _keep(t){for(let e=0;e<t.length;e++)if(!t[e].keep)return!1;return!0}static evaluate(t,e){const s=null===De.exec(t);let i=!1;const n=ke.exec(t);n&&(i="!"===n[1],t=n[2]),t=t.trim();let r=e.has(t);return i&&(r=!r),{result:r,error:!s}}}let Le=0;class Ie{constructor(t,e){this.meshUniformBufferFormat=void 0,this.meshBindGroupFormat=void 0,this.id=Le++,this.device=t,this.definition=e,this.name=e.name||"Untitled",e.vshader=Re.run(e.vshader),e.fshader=Re.run(e.fshader,t.webgl2),this.init(),this.impl=t.createShaderImpl(this)}init(){this.ready=!1,this.failed=!1}get label(){return`Shader Id ${this.id} ${this.name}`}destroy(){this.device.onDestroyShader(this),this.impl.destroy(this)}loseContext(){this.init(),this.impl.loseContext()}restoreContext(){this.impl.restoreContext(this.device,this)}}let Oe=0;class Fe{constructor(t,e,s){this.renderVersionUpdated=-1,this.id=Oe++,this.device=t,this.format=e,this.dirty=!0,this.impl=t.createBindGroupImpl(this),this.textures=[],this.uniformBuffers=[],this.defaultUniformBuffer=s,s&&this.setUniformBuffer(Vt,s)}destroy(){this.impl.destroy(),this.impl=null,this.format=null,this.defaultUniformBuffer=null}setUniformBuffer(t,e){const s=this.format.bufferFormatsMap.get(t);this.uniformBuffers[s]!==e&&(this.uniformBuffers[s]=e,this.dirty=!0)}setTexture(t,e){const s=this.format.textureFormatsMap.get(t);this.textures[s]!==e?(this.textures[s]=e,this.dirty=!0):this.renderVersionUpdated<e.renderVersionDirty&&(this.dirty=!0)}update(){const t=this.format.textureFormats;for(let e=0;e<t.length;e++){const s=t[e],i=s.scopeId.value;this.setTexture(s.name,i)}this.dirty&&(this.dirty=!1,this.renderVersionUpdated=this.device.renderVersion,this.impl.update(this))}}const Be=[];Be[2]=function(t,e,s){t.storageFloat32[s]=e},Be[3]=(t,e,s)=>{const i=t.storageFloat32;i[s]=e[0],i[s+1]=e[1]},Be[4]=(t,e,s)=>{const i=t.storageFloat32;i[s]=e[0],i[s+1]=e[1],i[s+2]=e[2]},Be[5]=(t,e,s)=>{const i=t.storageFloat32;i[s]=e[0],i[s+1]=e[1],i[s+2]=e[2],i[s+3]=e[3]},Be[1]=function(t,e,s){t.storageInt32[s]=e},Be[6]=function(t,e,s){const i=t.storageInt32;i[s]=e[0],i[s+1]=e[1]},Be[7]=function(t,e,s){const i=t.storageInt32;i[s]=e[0],i[s+1]=e[1],i[s+2]=e[2]},Be[8]=function(t,e,s){const i=t.storageInt32;i[s]=e[0],i[s+1]=e[1],i[s+2]=e[2],i[s+3]=e[3]},Be[12]=(t,e,s)=>{const i=t.storageFloat32;i[s]=e[0],i[s+1]=e[1],i[s+4]=e[2],i[s+5]=e[3],i[s+8]=e[4],i[s+9]=e[5]},Be[13]=(t,e,s)=>{const i=t.storageFloat32;i[s]=e[0],i[s+1]=e[1],i[s+2]=e[2],i[s+4]=e[3],i[s+5]=e[4],i[s+6]=e[5],i[s+8]=e[6],i[s+9]=e[7],i[s+10]=e[8]},Be[17]=function(t,e,s,i){const n=t.storageFloat32;for(let t=0;t<i;t++)n[s+4*t]=e[t]},Be[21]=(t,e,s,i)=>{const n=t.storageFloat32;for(let t=0;t<i;t++)n[s+4*t]=e[2*t],n[s+4*t+1]=e[2*t+1]},Be[22]=(t,e,s,i)=>{const n=t.storageFloat32;for(let t=0;t<i;t++)n[s+4*t]=e[3*t],n[s+4*t+1]=e[3*t+1],n[s+4*t+2]=e[3*t+2]};class ze{constructor(t,e){this.device=t,this.format=e,this.impl=t.createUniformBufferImpl(this),this.storage=new ArrayBuffer(e.byteSize),this.storageFloat32=new Float32Array(this.storage),this.storageInt32=new Int32Array(this.storage),t._vram.ub+=this.format.byteSize}destroy(){const t=this.device;this.impl.destroy(t),t._vram.ub-=this.format.byteSize}loseContext(){this.impl.loseContext()}setUniform(t){const e=t.offset,s=t.scopeId.value;if(null!=s){const i=Be[t.updateType];i?i(this,s,e,t.count):this.storageFloat32.set(s,e)}}set(t){const e=this.format.map.get(t);e&&this.setUniform(e)}update(){const t=this.format.uniforms;for(let e=0;e<t.length;e++)this.setUniform(t[e]);this.impl.unlock(this)}}let Ne=0;class Ue{constructor(t,e={}){var s,i,n,r,a,o,l,h,c,d,u,p,f,m,g,_,v,b,y,x,w;(this.name=void 0,this._isRenderTarget=!1,this._gpuSize=0,this.id=Ne++,this._invalid=!1,this._lockedLevel=-1,this.renderVersionDirty=0,this.device=t,this.name=null!=(s=e.name)?s:null,this._width=null!=(i=e.width)?i:4,this._height=null!=(n=e.height)?n:4,this._format=null!=(r=e.format)?r:7,this._compressed=(y=this._format,void 0!==nt.get(y).blockSize),t.supportsVolumeTextures)?(this._volume=null!=(x=e.volume)&&x,this._depth=null!=(w=e.depth)?w:1):(this._volume=!1,this._depth=1);this._cubemap=null!=(a=e.cubemap)&&a,this.fixCubemapSeams=null!=(o=e.fixCubemapSeams)&&o,this._flipY=null!=(l=e.flipY)&&l,this._premultiplyAlpha=null!=(h=e.premultiplyAlpha)&&h,this._mipmaps=null==(c=null!=(d=e.mipmaps)?d:e.autoMipmap)||c,this._minFilter=null!=(u=e.minFilter)?u:5,this._magFilter=null!=(p=e.magFilter)?p:1,this._anisotropy=null!=(f=e.anisotropy)?f:1,this._addressU=null!=(m=e.addressU)?m:0,this._addressV=null!=(g=e.addressV)?g:0,this._addressW=null!=(_=e.addressW)?_:0,this._compareOnRead=null!=(v=e.compareOnRead)&&v,this._compareFunc=null!=(b=e.compareFunc)?b:1,this.type=kt,e.hasOwnProperty("type")?this.type=e.type:e.hasOwnProperty("rgbm")?this.type=e.rgbm?Dt:kt:e.hasOwnProperty("swizzleGGGR")&&(this.type=e.swizzleGGGR?It:kt),this.projection="none",this._cubemap?this.projection=Ft:e.projection&&e.projection!==Ft&&(this.projection=e.projection),this.impl=t.createTextureImpl(this),this.dirtyAll(),this._levels=e.levels,this._levels?this.upload():this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null],t.textures.push(this)}destroy(){if(this.device){const t=this.device,e=t.textures.indexOf(this);-1!==e&&t.textures.splice(e,1),t.scope.removeValue(this),this.impl.destroy(t),this.adjustVramSizeTracking(t._vram,-this._gpuSize),this._levels=null,this.device=null}}loseContext(){this.impl.loseContext(),this.dirtyAll()}adjustVramSizeTracking(t,e){t.tex+=e}propertyChanged(t){this.impl.propertyChanged(t),this.renderVersionDirty=this.device.renderVersion}get requiredMipLevels(){return this.mipmaps?Math.floor(Math.log2(Math.max(this.width,this.height)))+1:1}set minFilter(t){this._minFilter!==t&&(this._minFilter=t,this.propertyChanged(1))}get minFilter(){return this._minFilter}set magFilter(t){this._magFilter!==t&&(this._magFilter=t,this.propertyChanged(2))}get magFilter(){return this._magFilter}set addressU(t){this._addressU!==t&&(this._addressU=t,this.propertyChanged(4))}get addressU(){return this._addressU}set addressV(t){this._addressV!==t&&(this._addressV=t,this.propertyChanged(8))}get addressV(){return this._addressV}set addressW(t){this.device.supportsVolumeTextures&&this._volume&&t!==this._addressW&&(this._addressW=t,this.propertyChanged(16))}get addressW(){return this._addressW}set compareOnRead(t){this._compareOnRead!==t&&(this._compareOnRead=t,this.propertyChanged(32))}get compareOnRead(){return this._compareOnRead}set compareFunc(t){this._compareFunc!==t&&(this._compareFunc=t,this.propertyChanged(64))}get compareFunc(){return this._compareFunc}set anisotropy(t){this._anisotropy!==t&&(this._anisotropy=t,this.propertyChanged(128))}get anisotropy(){return this._anisotropy}set mipmaps(t){this._mipmaps!==t&&(this._mipmaps=t,t&&(this._needsMipmapsUpload=!0))}get mipmaps(){return this._mipmaps}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get format(){return this._format}get cubemap(){return this._cubemap}get gpuSize(){const t=this.pot&&this._mipmaps&&!(this._compressed&&1===this._levels.length);return we.calcGpuSize(this._width,this._height,this._depth,this._format,t,this._cubemap)}get volume(){return this._volume}set flipY(t){this._flipY!==t&&(this._flipY=t,this._needsUpload=!0)}get flipY(){return this._flipY}set premultiplyAlpha(t){this._premultiplyAlpha!==t&&(this._premultiplyAlpha=t,this._needsUpload=!0)}get premultiplyAlpha(){return this._premultiplyAlpha}get pot(){return k.powerOfTwo(this._width)&&k.powerOfTwo(this._height)}get encoding(){switch(this.type){case Dt:return"rgbm";case Rt:return"rgbe";case Lt:return"rgbp";default:return 11===this.format||13===this.format||this.format===et||this.format===st?"linear":"srgb"}}dirtyAll(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this.propertyChanged(255)}lock(t={}){void 0===t.level&&(t.level=0),void 0===t.face&&(t.face=0),void 0===t.mode&&(t.mode=2),this._lockedLevel=t.level;const e=this.cubemap?this._levels[t.face]:this._levels;if(null===e[t.level]){const s=Math.max(1,this._width>>t.level),i=Math.max(1,this._height>>t.level),n=new ArrayBuffer(we.calcLevelGpuSize(s,i,this._format));e[t.level]=new((t=>{switch(t){case 13:case st:return Float32Array;case 3:case 4:case 5:case 11:case et:return Uint16Array;default:return Uint8Array}})(this._format))(n)}return e[t.level]}setSource(t,e=0){let s,i,n=!1;if(this._cubemap){if(t[0]){s=t[0].width||0,i=t[0].height||0;for(let e=0;e<6;e++){const r=t[e];if(!r||r.width!==s||r.height!==i||!this.device._isBrowserInterface(r)){n=!0;break}}}else n=!0;if(!n)for(let s=0;s<6;s++)this._levels[e][s]!==t[s]&&(this._levelsUpdated[e][s]=!0)}else this.device._isBrowserInterface(t)||(n=!0),n||(t!==this._levels[e]&&(this._levelsUpdated[e]=!0),s=t.width,i=t.height);if(n)if(this._width=4,this._height=4,this._cubemap)for(let t=0;t<6;t++)this._levels[e][t]=null,this._levelsUpdated[e][t]=!0;else this._levels[e]=null,this._levelsUpdated[e]=!0;else 0===e&&(this._width=s,this._height=i),this._levels[e]=t;this._invalid===n&&n||(this._invalid=n,this.upload())}getSource(t=0){return this._levels[t]}unlock(){this.upload(),this._lockedLevel=-1}upload(){var t,e;this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,null==(t=(e=this.impl).uploadImmediate)||t.call(e,this.device,this)}async downloadAsync(){const t=[];for(let i=0;i<(this.cubemap?6:1);i++){var e,s;const n=new pe({colorBuffer:this,depth:!1,face:i});this.device.setRenderTarget(n),this.device.initRenderTarget(n);const r=this.cubemap?this._levels[i]:this._levels;let a=r[0];r[0]&&this.device._isBrowserInterface(r[0])&&(r[0]=null),a=this.lock({face:i});const o=null==(e=(s=this.device).readPixelsAsync)?void 0:e.call(s,0,0,this.width,this.height,a).then((()=>n.destroy()));t.push(o)}await Promise.all(t)}getDds(){let t=128,e=0;for(;this._levels[e];){if(this.cubemap)for(let s=0;s<6;s++){if(!this._levels[e][s])return;const i=this._levels[e][s].length;if(!i)return;t+=i}else{const s=this._levels[e].length;if(!s)return;t+=s}t+=this._levels[e].length,e++}const s=new ArrayBuffer(t),i=new Uint32Array(s,0,32);let n=528391;this._levels.length>1&&(n|=131072);let r=4096;this._levels.length>1&&(r|=4194304),(this._levels.length>1||this.cubemap)&&(r|=8);const a=this.cubemap?65024:0;i[0]=542327876,i[1]=124,i[2]=n,i[3]=this.height,i[4]=this.width,i[5]=this.width*this.height*4,i[6]=0,i[7]=this._levels.length;for(let t=0;t<11;t++)i[8+t]=0;i[19]=32,i[20]=65,i[21]=0,i[22]=32,i[23]=16711680,i[24]=65280,i[25]=255,i[26]=4278190080,i[27]=r,i[28]=a,i[29]=0,i[30]=0,i[31]=0;let o=128;if(this.cubemap)for(let t=0;t<6;t++)for(let e=0;e<this._levels.length;e++){const i=this._levels[e][t],n=new Uint8Array(s,o,i.length);for(let t=0;t<i.length;t++)n[t]=i[t];o+=i.length}else for(let t=0;t<this._levels.length;t++){const e=this._levels[t],i=new Uint8Array(s,o,e.length);for(let t=0;t<e.length;t++)i[t]=e[t];o+=e.length}return s}}class Ve{constructor(){this.bufferId=null}destroy(t){this.bufferId&&(t.gl.deleteBuffer(this.bufferId),this.bufferId=null)}get initialized(){return!!this.bufferId}loseContext(){this.bufferId=null}unlock(t,e,s,i){const n=t.gl;let r;switch(this.bufferId||(this.bufferId=n.createBuffer()),e){case 0:r=n.STATIC_DRAW;break;case 1:r=n.DYNAMIC_DRAW;break;case 2:r=n.STREAM_DRAW;break;case 3:r=t.webgl2?n.DYNAMIC_COPY:n.STATIC_DRAW}n.bindBuffer(s,this.bufferId),n.bufferData(s,i,r)}}class He extends Ve{constructor(...t){super(...t),this.vao=null}destroy(t){super.destroy(t),t.boundVao=null,t.gl.bindVertexArray(null)}loseContext(){super.loseContext(),this.vao=null}unlock(t){const e=t.device;super.unlock(e,t.usage,e.gl.ARRAY_BUFFER,t.storage)}}class Ge extends Ve{constructor(t){super();const e=t.device.gl,s=t.format;0===s?this.glFormat=e.UNSIGNED_BYTE:1===s?this.glFormat=e.UNSIGNED_SHORT:2===s&&(this.glFormat=e.UNSIGNED_INT)}unlock(t){const e=t.device;super.unlock(e,t.usage,e.gl.ELEMENT_ARRAY_BUFFER,t.storage)}}class We{constructor(t,e,s,i){if(this.locationId=i,this.scopeId=t.scope.resolve(e),this.version=new ee,"[0]"===e.substring(e.length-3))switch(s){case 2:s=17;break;case 3:s=21;break;case 4:s=22;break;case 5:s=23}this.dataType=s,this.value=[null,null,null,null],this.array=[]}}class je{constructor(){this._cache=new Map}get(t,e){return this._cache.has(t)||(this._cache.set(t,e()),t.on("destroy",(()=>{this.remove(t)})),t.on("devicelost",(()=>{var e;null==(e=this._cache.get(t))||null==e.loseContext||e.loseContext(t)}))),this._cache.get(t)}remove(t){var e;null==(e=this._cache.get(t))||null==e.destroy||e.destroy(t),this._cache.delete(t)}}const qe=["gl_VertexID","gl_InstanceID","gl_DrawID","gl_BaseVertex","gl_BaseInstance"];class Xe{constructor(){this.map=new Map}destroy(t){this.map.forEach((e=>{t.gl.deleteShader(e)}))}loseContext(t){this.map.clear()}}class $e{constructor(){this.shaders=[]}loseContext(t){this.shaders=[]}}const Ke=new je,Ye=new je,Qe=new je;class Je{constructor(t){this.compileDuration=0,this.init(),this.compile(t.device,t),Je.getBatchShaders(t.device).push(t),t.device.shaders.push(t)}destroy(t){this.glProgram&&(t.device.gl.deleteProgram(this.glProgram),this.glProgram=null)}init(){this.uniforms=[],this.samplers=[],this.attributes=[],this.glProgram=null,this.glVertexShader=null,this.glFragmentShader=null}static getBatchShaders(t){return Qe.get(t,(()=>new $e)).shaders}static endShaderBatch(t){const e=Je.getBatchShaders(t);e.forEach((e=>e.impl.link(t,e))),e.length=0}loseContext(){this.init()}restoreContext(t,e){this.compile(t,e)}compile(t,e){const s=e.definition;this.glVertexShader=this._compileShaderSource(t,s.vshader,!0),this.glFragmentShader=this._compileShaderSource(t,s.fshader,!1)}link(t,e){if(this.glProgram)return;const s=t.gl,i=s.createProgram();this.glProgram=i,s.attachShader(i,this.glVertexShader),s.attachShader(i,this.glFragmentShader);const n=e.definition,r=n.attributes;if(t.webgl2&&n.useTransformFeedback){const t=[];for(const e in r)r.hasOwnProperty(e)&&t.push("out_"+e);s.transformFeedbackVaryings(i,t,s.INTERLEAVED_ATTRIBS)}for(const t in r)if(r.hasOwnProperty(t)){const e=r[t],n=Xt[e];s.bindAttribLocation(i,n,t)}s.linkProgram(i)}_compileShaderSource(t,e,s){const i=t.gl,n=(s?Ke:Ye).get(t,(()=>new Xe));let r=n.map.get(e);return r||(r=i.createShader(s?i.VERTEX_SHADER:i.FRAGMENT_SHADER),i.shaderSource(r,e),i.compileShader(r),n.map.set(e,r)),r}finalize(t,e){this.glProgram||this.link(t,e);const s=t.gl,i=this.glProgram,n=e.definition;if(!s.getProgramParameter(i,s.LINK_STATUS)){if(!this._isCompiled(t,e,this.glVertexShader,n.vshader,"vertex"))return!1;if(!this._isCompiled(t,e,this.glFragmentShader,n.fshader,"fragment"))return!1;const r="Failed to link shader program. Error: "+s.getProgramInfoLog(i);return console.error(r),!1}let r=0;const a=s.getProgramParameter(i,s.ACTIVE_ATTRIBUTES);for(;r<a;){const a=s.getActiveAttrib(i,r++),o=s.getAttribLocation(i,a.name);if(-1!==qe.indexOf(a.name))continue;void 0===n.attributes[a.name]&&(console.error(`Vertex shader attribute "${a.name}" is not mapped to a semantic in shader definition, shader [${e.label}]`,e),e.failed=!0);const l=new We(t,n.attributes[a.name],t.pcUniformType[a.type],o);this.attributes.push(l)}r=0;const o=s.getProgramParameter(i,s.ACTIVE_UNIFORMS);for(;r<o;){const e=s.getActiveUniform(i,r++),n=s.getUniformLocation(i,e.name),a=new We(t,e.name,t.pcUniformType[e.type],n);e.type===s.SAMPLER_2D||e.type===s.SAMPLER_CUBE||t.webgl2&&(e.type===s.SAMPLER_2D_SHADOW||e.type===s.SAMPLER_CUBE_SHADOW||e.type===s.SAMPLER_3D)?this.samplers.push(a):this.uniforms.push(a)}return e.ready=!0,!0}_isCompiled(t,e,s,i,n){const r=t.gl;if(!r.getShaderParameter(s,r.COMPILE_STATUS)){const t=r.getShaderInfoLog(s),[e,a]=this._processError(i,t),o=`Failed to compile ${n} shader:\n\n${t}\n${e}`;return console.error(o),!1}return!0}_processError(t,e){const s={};let i="";if(t){const n=t.split("\n");let r=0,a=n.length;if(e&&e.startsWith("ERROR:")){const t=e.match(/^ERROR:\s([0-9]+):([0-9]+):\s*(.+)/);t&&(s.message=t[3],s.line=parseInt(t[2],10),r=Math.max(0,s.line-6),a=Math.min(n.length,s.line+5))}for(let t=r;t<a;t++)i+=t+1+":\t"+n[t]+"\n";s.source=t}return[i,s]}}function Ze(t,e){const s=t.width,i=t.height;if(s>e||i>e){const n=e/Math.max(s,i),r=Math.floor(s*n),a=Math.floor(i*n),o=document.createElement("canvas");o.width=r,o.height=a;return o.getContext("2d").drawImage(t,0,0,s,i,0,0,r,a),o}return t}class ts{constructor(){this._glTexture=null,this._glTarget=void 0,this._glFormat=void 0,this._glInternalFormat=void 0,this._glPixelType=void 0,this.dirtyParameterFlags=0}destroy(t){if(this._glTexture){for(let e=0;e<t.textureUnits.length;e++){const s=t.textureUnits[e];for(let t=0;t<s.length;t++)s[t]===this._glTexture&&(s[t]=null)}t.gl.deleteTexture(this._glTexture),this._glTexture=null}}loseContext(){this._glTexture=null}propertyChanged(t){this.dirtyParameterFlags|=t}initialize(t,e){const s=t.gl;switch(this._glTexture=s.createTexture(),this._glTarget=e._cubemap?s.TEXTURE_CUBE_MAP:e._volume?s.TEXTURE_3D:s.TEXTURE_2D,e._format){case 0:this._glFormat=s.ALPHA,this._glInternalFormat=s.ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case 1:this._glFormat=s.LUMINANCE,this._glInternalFormat=s.LUMINANCE,this._glPixelType=s.UNSIGNED_BYTE;break;case 2:this._glFormat=s.LUMINANCE_ALPHA,this._glInternalFormat=s.LUMINANCE_ALPHA,this._glPixelType=s.UNSIGNED_BYTE;break;case 3:this._glFormat=s.RGB,this._glInternalFormat=s.RGB,this._glPixelType=s.UNSIGNED_SHORT_5_6_5;break;case 4:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA,this._glPixelType=s.UNSIGNED_SHORT_5_5_5_1;break;case 5:this._glFormat=s.RGBA,this._glInternalFormat=s.RGBA,this._glPixelType=s.UNSIGNED_SHORT_4_4_4_4;break;case 6:this._glFormat=s.RGB,this._glInternalFormat=t.webgl2?s.RGB8:s.RGB,this._glPixelType=s.UNSIGNED_BYTE;break;case 7:this._glFormat=s.RGBA,this._glInternalFormat=t.webgl2?s.RGBA8:s.RGBA,this._glPixelType=s.UNSIGNED_BYTE;break;case 8:this._glFormat=s.RGB,this._glInternalFormat=t.extCompressedTextureS3TC.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case 9:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case 10:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTextureS3TC.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case 21:this._glFormat=s.RGB,this._glInternalFormat=t.extCompressedTextureETC1.COMPRESSED_RGB_ETC1_WEBGL;break;case 24:this._glFormat=s.RGB,this._glInternalFormat=t.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case 25:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case 26:this._glFormat=s.RGB,this._glInternalFormat=t.extCompressedTexturePVRTC.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case 27:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTexturePVRTC.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case 22:this._glFormat=s.RGB,this._glInternalFormat=t.extCompressedTextureETC.COMPRESSED_RGB8_ETC2;break;case 23:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;break;case 28:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case 29:this._glFormat=s.RGB,this._glInternalFormat=t.extCompressedTextureATC.COMPRESSED_RGB_ATC_WEBGL;break;case 30:this._glFormat=s.RGBA,this._glInternalFormat=t.extCompressedTextureATC.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case 11:this._glFormat=s.RGB,t.webgl2?(this._glInternalFormat=s.RGB16F,this._glPixelType=s.HALF_FLOAT):(this._glInternalFormat=s.RGB,this._glPixelType=t.extTextureHalfFloat.HALF_FLOAT_OES);break;case et:this._glFormat=s.RGBA,t.webgl2?(this._glInternalFormat=s.RGBA16F,this._glPixelType=s.HALF_FLOAT):(this._glInternalFormat=s.RGBA,this._glPixelType=t.extTextureHalfFloat.HALF_FLOAT_OES);break;case 13:this._glFormat=s.RGB,t.webgl2?this._glInternalFormat=s.RGB32F:this._glInternalFormat=s.RGB,this._glPixelType=s.FLOAT;break;case st:this._glFormat=s.RGBA,t.webgl2?this._glInternalFormat=s.RGBA32F:this._glInternalFormat=s.RGBA,this._glPixelType=s.FLOAT;break;case 15:this._glFormat=s.RED,this._glInternalFormat=s.R32F,this._glPixelType=s.FLOAT;break;case it:t.webgl2?(this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT32F,this._glPixelType=s.FLOAT):(this._glFormat=s.DEPTH_COMPONENT,this._glInternalFormat=s.DEPTH_COMPONENT,this._glPixelType=s.UNSIGNED_SHORT);break;case 17:this._glFormat=s.DEPTH_STENCIL,t.webgl2?(this._glInternalFormat=s.DEPTH24_STENCIL8,this._glPixelType=s.UNSIGNED_INT_24_8):(this._glInternalFormat=s.DEPTH_STENCIL,this._glPixelType=t.extDepthTexture.UNSIGNED_INT_24_8_WEBGL);break;case 18:this._glFormat=s.RGB,this._glInternalFormat=s.R11F_G11F_B10F,this._glPixelType=s.UNSIGNED_INT_10F_11F_11F_REV;break;case 19:this._glFormat=s.RGB,this._glInternalFormat=s.SRGB8,this._glPixelType=s.UNSIGNED_BYTE;break;case 20:this._glFormat=s.RGBA,this._glInternalFormat=s.SRGB8_ALPHA8,this._glPixelType=s.UNSIGNED_BYTE}}upload(t,e){const s=t.gl;if(!e._needsUpload&&(e._needsMipmapsUpload&&e._mipmapsUploaded||!e.pot))return;let i,n,r=0;const a=e.requiredMipLevels;for(;e._levels[r]||0===r;)if(e._needsUpload||0!==r){if(r&&(!e._needsMipmapsUpload||!e._mipmaps))break;if(i=e._levels[r],1===r&&!e._compressed&&e._levels.length<a&&(s.generateMipmap(this._glTarget),e._mipmapsUploaded=!0),e._cubemap){let a;if(t._isBrowserInterface(i[0]))for(a=0;a<6;a++){if(!e._levelsUpdated[0][a])continue;let n=i[a];t._isImageBrowserInterface(n)&&(n.width>t.maxCubeMapSize||n.height>t.maxCubeMapSize)&&(n=Ze(n,t.maxCubeMapSize),0===r&&(e._width=n.width,e._height=n.height)),t.setUnpackFlipY(!1),t.setUnpackPremultiplyAlpha(e._premultiplyAlpha),s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,this._glInternalFormat,this._glFormat,this._glPixelType,n)}else for(n=1/Math.pow(2,r),a=0;a<6;a++){if(!e._levelsUpdated[0][a])continue;const o=i[a];e._compressed?s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,this._glInternalFormat,Math.max(e._width*n,1),Math.max(e._height*n,1),0,o):(t.setUnpackFlipY(!1),t.setUnpackPremultiplyAlpha(e._premultiplyAlpha),s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r,this._glInternalFormat,Math.max(e._width*n,1),Math.max(e._height*n,1),0,this._glFormat,this._glPixelType,o))}}else e._volume?(n=1/Math.pow(2,r),e._compressed?s.compressedTexImage3D(s.TEXTURE_3D,r,this._glInternalFormat,Math.max(e._width*n,1),Math.max(e._height*n,1),Math.max(e._depth*n,1),0,i):(t.setUnpackFlipY(!1),t.setUnpackPremultiplyAlpha(e._premultiplyAlpha),s.texImage3D(s.TEXTURE_3D,r,this._glInternalFormat,Math.max(e._width*n,1),Math.max(e._height*n,1),Math.max(e._depth*n,1),0,this._glFormat,this._glPixelType,i))):(t._isBrowserInterface(i)?(t._isImageBrowserInterface(i)&&(i.width>t.maxTextureSize||i.height>t.maxTextureSize)&&(i=Ze(i,t.maxTextureSize),0===r&&(e._width=i.width,e._height=i.height)),t.setUnpackFlipY(e._flipY),t.setUnpackPremultiplyAlpha(e._premultiplyAlpha),s.texImage2D(s.TEXTURE_2D,r,this._glInternalFormat,this._glFormat,this._glPixelType,i)):(n=1/Math.pow(2,r),e._compressed?s.compressedTexImage2D(s.TEXTURE_2D,r,this._glInternalFormat,Math.max(Math.floor(e._width*n),1),Math.max(Math.floor(e._height*n),1),0,i):(t.setUnpackFlipY(!1),t.setUnpackPremultiplyAlpha(e._premultiplyAlpha),s.texImage2D(s.TEXTURE_2D,r,this._glInternalFormat,Math.max(e._width*n,1),Math.max(e._height*n,1),0,this._glFormat,this._glPixelType,i))),e._mipmapsUploaded=0!==r);r++}else r++;if(e._needsUpload)if(e._cubemap)for(let t=0;t<6;t++)e._levelsUpdated[0][t]=!1;else e._levelsUpdated[0]=!1;!e._compressed&&e._mipmaps&&e._needsMipmapsUpload&&(e.pot||t.webgl2)&&1===e._levels.length&&(s.generateMipmap(this._glTarget),e._mipmapsUploaded=!0),e._gpuSize&&e.adjustVramSizeTracking(t._vram,-e._gpuSize),e._gpuSize=e.gpuSize,e.adjustVramSizeTracking(t._vram,e._gpuSize)}}class es{constructor(t,e){this.msaaFB=void 0,this.resolveFB=void 0,this.msaaFB=t,this.resolveFB=e}destroy(t){this.msaaFB&&(t.deleteRenderbuffer(this.msaaFB),this.msaaFB=null),this.resolveFB&&(t.deleteRenderbuffer(this.resolveFB),this.resolveFB=null)}}class ss{constructor(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this.colorMrtFramebuffers=null,this._glMsaaColorBuffers=[],this._glMsaaDepthBuffer=null}destroy(t){var e;const s=t.gl;this._glFrameBuffer&&(s.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(s.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(s.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffers.forEach((t=>{s.deleteRenderbuffer(t)})),this._glMsaaColorBuffers.length=0,null==(e=this.colorMrtFramebuffers)||e.forEach((t=>{t.destroy(s)})),this.colorMrtFramebuffers=null,this._glMsaaDepthBuffer&&(s.deleteRenderbuffer(this._glMsaaDepthBuffer),this._glMsaaDepthBuffer=null)}get initialized(){return null!==this._glFrameBuffer}init(t,e){var s,i,n,r;const a=t.gl;this._glFrameBuffer=a.createFramebuffer(),t.setFramebuffer(this._glFrameBuffer);const o=null!=(s=null==(i=e._colorBuffers)?void 0:i.length)?s:0,l=t.webgl2?a.COLOR_ATTACHMENT0:null!=(n=null==(r=t.extDrawBuffers)?void 0:r.COLOR_ATTACHMENT0_WEBGL)?n:a.COLOR_ATTACHMENT0,h=[];for(let s=0;s<o;++s){const i=e.getColorBuffer(s);i&&(i.impl._glTexture||(i._width=Math.min(i.width,t.maxRenderBufferSize),i._height=Math.min(i.height,t.maxRenderBufferSize),t.setTexture(i,0)),a.framebufferTexture2D(a.FRAMEBUFFER,l+s,i._cubemap?a.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:a.TEXTURE_2D,i.impl._glTexture,0),h.push(l+s))}t.drawBuffers&&t.drawBuffers(h);const c=e._depthBuffer;if(c)c.impl._glTexture||(c._width=Math.min(c.width,t.maxRenderBufferSize),c._height=Math.min(c.height,t.maxRenderBufferSize),t.setTexture(c,0)),e._stencil?a.framebufferTexture2D(a.FRAMEBUFFER,a.DEPTH_STENCIL_ATTACHMENT,c._cubemap?a.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:a.TEXTURE_2D,e._depthBuffer.impl._glTexture,0):a.framebufferTexture2D(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,c._cubemap?a.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:a.TEXTURE_2D,e._depthBuffer.impl._glTexture,0);else if(e._depth){if(!(e._samples>1&&t.webgl2)){if(this._glDepthBuffer||(this._glDepthBuffer=a.createRenderbuffer()),a.bindRenderbuffer(a.RENDERBUFFER,this._glDepthBuffer),e._stencil)a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_STENCIL,e.width,e.height),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_STENCIL_ATTACHMENT,a.RENDERBUFFER,this._glDepthBuffer);else{const s=t.webgl2?a.DEPTH_COMPONENT32F:a.DEPTH_COMPONENT16;a.renderbufferStorage(a.RENDERBUFFER,s,e.width,e.height),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,this._glDepthBuffer)}a.bindRenderbuffer(a.RENDERBUFFER,null)}}if(t.webgl2&&e._samples>1){var d,u;this._glResolveFrameBuffer=this._glFrameBuffer,this._glFrameBuffer=a.createFramebuffer(),t.setFramebuffer(this._glFrameBuffer);const s=null!=(d=null==(u=e._colorBuffers)?void 0:u.length)?d:0;for(let t=0;t<s;++t){const s=e.getColorBuffer(t);if(s){const i=a.createRenderbuffer();this._glMsaaColorBuffers.push(i),a.bindRenderbuffer(a.RENDERBUFFER,i),a.renderbufferStorageMultisample(a.RENDERBUFFER,e._samples,s.impl._glInternalFormat,e.width,e.height),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0+t,a.RENDERBUFFER,i)}}e._depth&&(this._glMsaaDepthBuffer||(this._glMsaaDepthBuffer=a.createRenderbuffer()),a.bindRenderbuffer(a.RENDERBUFFER,this._glMsaaDepthBuffer),e._stencil?(a.renderbufferStorageMultisample(a.RENDERBUFFER,e._samples,a.DEPTH24_STENCIL8,e.width,e.height),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_STENCIL_ATTACHMENT,a.RENDERBUFFER,this._glMsaaDepthBuffer)):(a.renderbufferStorageMultisample(a.RENDERBUFFER,e._samples,a.DEPTH_COMPONENT32F,e.width,e.height),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,this._glMsaaDepthBuffer))),s>1&&(this._createMsaaMrtFramebuffers(t,e,s),t.setFramebuffer(this._glFrameBuffer),t.drawBuffers(h))}}_createMsaaMrtFramebuffers(t,e,s){const i=t.gl;this.colorMrtFramebuffers=[];for(let n=0;n<s;++n){const s=e.getColorBuffer(n),r=i.createFramebuffer();t.setFramebuffer(r);const a=this._glMsaaColorBuffers[n];i.bindRenderbuffer(i.RENDERBUFFER,a),i.renderbufferStorageMultisample(i.RENDERBUFFER,e._samples,s.impl._glInternalFormat,e.width,e.height),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.RENDERBUFFER,a),t.drawBuffers([i.COLOR_ATTACHMENT0]);const o=i.createFramebuffer();t.setFramebuffer(o),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,s._cubemap?i.TEXTURE_CUBE_MAP_POSITIVE_X+e._face:i.TEXTURE_2D,s.impl._glTexture,0),this.colorMrtFramebuffers[n]=new es(r,o)}}_checkFbo(t,e,s=""){const i=t.gl;i.checkFramebufferStatus(i.FRAMEBUFFER)}loseContext(){this._glFrameBuffer=null,this._glDepthBuffer=null,this._glResolveFrameBuffer=null,this._glMsaaColorBuffers.length=0,this._glMsaaDepthBuffer=null,this.colorMrtFramebuffers=null}internalResolve(t,e,s,i,n){const r=t.gl;r.bindFramebuffer(r.READ_FRAMEBUFFER,e),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,s),r.blitFramebuffer(0,0,i.width,i.height,0,0,i.width,i.height,n,r.NEAREST)}resolve(t,e,s,i){if(t.webgl2){const n=t.gl;if(this.colorMrtFramebuffers){if(s)for(let s=0;s<this.colorMrtFramebuffers.length;s++){const i=this.colorMrtFramebuffers[s];this.internalResolve(t,i.msaaFB,i.resolveFB,e,n.COLOR_BUFFER_BIT)}i&&this.internalResolve(t,this._glFrameBuffer,this._glResolveFrameBuffer,e,n.DEPTH_BUFFER_BIT)}else this.internalResolve(t,this._glFrameBuffer,this._glResolveFrameBuffer,e,(s?n.COLOR_BUFFER_BIT:0)|(i?n.DEPTH_BUFFER_BIT:0));n.bindFramebuffer(n.FRAMEBUFFER,this._glFrameBuffer)}}}var is="\n\n#define pcFragColor0 gl_FragData[0]\n\n#if COLOR_ATTACHMENT_1\n#define pcFragColor1 gl_FragData[1]\n#endif\n\n#if COLOR_ATTACHMENT_2\n#define pcFragColor2 gl_FragData[2]\n#endif\n\n#if COLOR_ATTACHMENT_3\n#define pcFragColor3 gl_FragData[3]\n#endif\n\n#if COLOR_ATTACHMENT_4\n#define pcFragColor4 gl_FragData[4]\n#endif\n\n#if COLOR_ATTACHMENT_5\n#define pcFragColor5 gl_FragData[5]\n#endif\n\n#if COLOR_ATTACHMENT_6\n#define pcFragColor6 gl_FragData[6]\n#endif\n\n#if COLOR_ATTACHMENT_7\n#define pcFragColor7 gl_FragData[7]\n#endif\n\n#define texture2DBias texture2D\n\n// pass / accept shadow map or texture as a function parameter, on webgl this is simply passed as is\n// but this is needed for WebGPU\n#define SHADOWMAP_PASS(name) name\n#define SHADOWMAP_ACCEPT(name) sampler2D name\n#define TEXTURE_PASS(name) name\n#define TEXTURE_ACCEPT(name) sampler2D name\n\n#ifndef SUPPORTS_TEXLOD\n\n\t\t// fallback for lod instructions\n\t\t#define texture2DLodEXT texture2D\n\t\t#define texture2DProjLodEXT textureProj\n\t\t#define textureCubeLodEXT textureCube\n\t\t#define textureShadow texture2D\n\n#else\n\n\t\t#define textureShadow(res, uv) texture2DGradEXT(res, uv, vec2(1, 1), vec2(1, 1))\n\n#endif\n\n#ifdef SUPPORTS_MRT\n\t\t#define gl_FragColor pcFragColor0\n#endif\n\n",ns="\nlayout(location = 0) out highp vec4 pc_fragColor;\n\n#ifndef REMOVE_COLOR_ATTACHMENT_1\n#if COLOR_ATTACHMENT_1\nlayout(location = 1) out highp vec4 pc_fragColor1;\n#endif\n#endif\n\n#ifndef REMOVE_COLOR_ATTACHMENT_2\n#if COLOR_ATTACHMENT_2\nlayout(location = 2) out highp vec4 pc_fragColor2;\n#endif\n#endif\n\n#ifndef REMOVE_COLOR_ATTACHMENT_3\n#if COLOR_ATTACHMENT_3\nlayout(location = 3) out highp vec4 pc_fragColor3;\n#endif\n#endif\n\n#ifndef REMOVE_COLOR_ATTACHMENT_4\n#if COLOR_ATTACHMENT_4\nlayout(location = 4) out highp vec4 pc_fragColor4;\n#endif\n#endif\n\n#ifndef REMOVE_COLOR_ATTACHMENT_5\n#if COLOR_ATTACHMENT_5\nlayout(location = 5) out highp vec4 pc_fragColor5;\n#endif\n#endif\n\n#ifndef REMOVE_COLOR_ATTACHMENT_6\n#if COLOR_ATTACHMENT_6\nlayout(location = 6) out highp vec4 pc_fragColor6;\n#endif\n#endif\n\n#ifndef REMOVE_COLOR_ATTACHMENT_7\n#if COLOR_ATTACHMENT_7\nlayout(location = 7) out highp vec4 pc_fragColor7;\n#endif\n#endif\n\n#define gl_FragColor pc_fragColor\n\n#define pcFragColor0 pc_fragColor\n#define pcFragColor1 pc_fragColor1\n#define pcFragColor2 pc_fragColor2\n#define pcFragColor3 pc_fragColor3\n#define pcFragColor4 pc_fragColor4\n#define pcFragColor5 pc_fragColor5\n#define pcFragColor6 pc_fragColor6\n#define pcFragColor7 pc_fragColor7\n\n#define varying in\n\n#define texture2D texture\n#define texture2DBias texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n\n// sample shadows using textureGrad to remove derivatives in the dynamic loops (which are used by\n// clustered lighting) - as DirectX shader compiler tries to unroll the loops and takes long time\n// to compile the shader. Using textureLod would be even better, but WebGl does not translate it to\n// lod instruction for DirectX correctly and uses SampleCmp instead of SampleCmpLevelZero or similar.\n#define textureShadow(res, uv) textureGrad(res, uv, vec2(1, 1), vec2(1, 1))\n\n// pass / accept shadow map or texture as a function parameter, on webgl this is simply passed as is\n// but this is needed for WebGPU\n#define SHADOWMAP_PASS(name) name\n#define SHADOWMAP_ACCEPT(name) sampler2DShadow name\n#define TEXTURE_PASS(name) name\n#define TEXTURE_ACCEPT(name) sampler2D name\n\n#define GL2\n#define SUPPORTS_TEXLOD\n#define SUPPORTS_MRT\n",rs="\n#define attribute in\n#define varying out\n#define texture2D texture\n#define GL2\n#define VERTEXSHADER\n",as="\n\n// texelFetch support and others\n#extension GL_EXT_samplerless_texture_functions : require\n\nlayout(location = 0) out highp vec4 pc_fragColor;\nlayout(location = 1) out highp vec4 pc_fragColor1;\nlayout(location = 2) out highp vec4 pc_fragColor2;\nlayout(location = 3) out highp vec4 pc_fragColor3;\nlayout(location = 4) out highp vec4 pc_fragColor4;\nlayout(location = 5) out highp vec4 pc_fragColor5;\nlayout(location = 6) out highp vec4 pc_fragColor6;\nlayout(location = 7) out highp vec4 pc_fragColor7;\n\n#define gl_FragColor pc_fragColor\n\n#define pcFragColor0 pc_fragColor\n#define pcFragColor1 pc_fragColor1\n#define pcFragColor2 pc_fragColor2\n#define pcFragColor3 pc_fragColor3\n#define pcFragColor4 pc_fragColor4\n#define pcFragColor5 pc_fragColor5\n#define pcFragColor6 pc_fragColor6\n#define pcFragColor7 pc_fragColor7\n\n#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)\n#define texture2DBias(res, uv, bias) texture(sampler2D(res, res ## _sampler), uv, bias)\n#define texture2DLodEXT(res, uv, lod) textureLod(sampler2D(res, res ## _sampler), uv, lod)\n#define textureCube(res, uv) texture(samplerCube(res, res ## _sampler), uv)\n#define textureCubeLodEXT(res, uv, lod) textureLod(samplerCube(res, res ## _sampler), uv, lod)\n#define textureShadow(res, uv) textureLod(sampler2DShadow(res, res ## _sampler), uv, 0.0)\n\n// TODO: implement other texture sampling macros\n// #define texture2DProj textureProj\n// #define texture2DProjLodEXT textureProjLod\n// #define texture2DGradEXT textureGrad\n// #define texture2DProjGradEXT textureProjGrad\n// #define textureCubeGradEXT textureGrad\n\n// pass / accept shadow map as a function parameter, passes both the texture as well as sampler\n// as the combined sampler can be only created at a point of use\n#define SHADOWMAP_PASS(name) name, name ## _sampler\n#define SHADOWMAP_ACCEPT(name) texture2D name, sampler name ## _sampler\n#define TEXTURE_PASS(name) name, name ## _sampler\n#define TEXTURE_ACCEPT(name) texture2D name, sampler name ## _sampler\n\n#define GL2\n#define WEBGPU\n#define SUPPORTS_TEXLOD\n#define SUPPORTS_MRT\n",os="\n\n// texelFetch support and others\n#extension GL_EXT_samplerless_texture_functions : require\n\n#define texture2D(res, uv) texture(sampler2D(res, res ## _sampler), uv)\n\n#define GL2\n#define WEBGPU\n#define VERTEXSHADER\n",ls="\n\n// convert clip space position into texture coordinates to sample scene grab textures\nvec2 getGrabScreenPos(vec4 clipPos) {\n\t\tvec2 uv = (clipPos.xy / clipPos.w) * 0.5 + 0.5;\n\n\t\t#ifdef WEBGPU\n\t\t\t\tuv.y = 1.0 - uv.y;\n\t\t#endif\n\n\t\treturn uv;\n}\n\n// convert uv coordinates to sample image effect texture (render target texture rendered without\n// forward renderer which does the flip in the projection matrix)\nvec2 getImageEffectUV(vec2 uv) {\n\t\t#ifdef WEBGPU\n\t\t\t\tuv.y = 1.0 - uv.y;\n\t\t#endif\n\n\t\treturn uv;\n}\n";const hs={vertex_position:at,vertex_normal:ot,vertex_tangent:lt,vertex_texCoord0:pt,vertex_texCoord1:ft,vertex_texCoord2:mt,vertex_texCoord3:gt,vertex_texCoord4:_t,vertex_texCoord5:vt,vertex_texCoord6:bt,vertex_texCoord7:yt,vertex_color:dt,vertex_boneIndices:ct,vertex_boneWeights:ht};class cs{static createDefinition(t,e){var s,i;const n=(s,i,n,r)=>{const a=t.isWebGPU?s:t.webgl2?i:cs.gl1Extensions(t,e)+n;let o="";for(let e=0;e<t.maxColorAttachments;e++)o+=`#define COLOR_ATTACHMENT_${e}\n`;return o+a},r=null!=(s=e.name)?s:"Untitled",a=e.vertexDefines||n(os,rs,""),o=cs.versionCode(t)+a+ls+cs.getShaderNameCode(r)+e.vertexCode,l=e.fragmentDefines||n(as,ns,is),h=(e.fragmentPreamble||"")+cs.versionCode(t)+l+cs.precisionCode(t)+"\n"+ls+cs.getShaderNameCode(r)+(e.fragmentCode||cs.dummyFragmentCode());return{name:r,attributes:null!=(i=e.attributes)?i:cs.collectAttributes(e.vertexCode),vshader:o,fshader:h,useTransformFeedback:e.useTransformFeedback}}static getShaderNameCode(t){return`#define SHADER_NAME ${t}\n`}static gl1Extensions(t,e,s){let i;return s?i=e.vertexExtensions?`${e.vertexExtensions}\n`:"":(i=e.fragmentExtensions?`${e.fragmentExtensions}\n`:"",t.extStandardDerivatives&&(i+="#extension GL_OES_standard_derivatives : enable\n"),t.extTextureLod&&(i+="#extension GL_EXT_shader_texture_lod : enable\n",i+="#define SUPPORTS_TEXLOD\n"),t.extDrawBuffers&&(i+="#extension GL_EXT_draw_buffers : require\n",i+="#define SUPPORTS_MRT\n")),i}static dummyFragmentCode(){return"void main(void) {gl_FragColor = vec4(0.0);}"}static versionCode(t){return t.isWebGPU?"#version 450\n":t.webgl2?"#version 300 es\n":""}static precisionCode(t,e){let s="";e&&"highp"!==e&&"mediump"!==e&&"lowp"!==e&&(e=null),e&&("highp"===e&&"highp"!==t.maxPrecision&&(e="mediump"),"mediump"===e&&"lowp"===t.maxPrecision&&(e="lowp"));const i=e||t.precision;return t.isWebGPU?s=`precision ${i} float;\nprecision ${i} int;\n`:(s=`precision ${i} float;\n`,t.webgl2&&(s+=`precision ${i} sampler2DShadow;\n`)),s}static collectAttributes(t){const e={};let s=0,i=t.indexOf("attribute");for(;i>=0&&!(i>0&&"/"===t[i-1]);){const n=t.indexOf(";",i),r=t.lastIndexOf(" ",n),a=t.substring(r+1,n),o=hs[a];void 0!==o?e[a]=o:(e[a]="ATTR"+s,s++),i=t.indexOf("attribute",i+1)}return e}}const ds=[],us="\nattribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tvUv0 = vertex_position.xy*0.5+0.5;\n}\n";function ps(t,e,s){const i=t.renderTarget;t.setRenderTarget(e),t.updateBegin(),t.setCullMode(tt),t.setBlendState(Zt.NOBLEND),t.setDepthState(te.NODEPTH),t.setStencilState(null,null),t.setVertexBuffer(t.quadVertexBuffer,0),t.setShader(s),t.draw({type:rt,base:0,count:4,indexed:!1}),t.updateEnd(),t.setRenderTarget(i),t.updateBegin()}function fs(t,e){let s=!0;const i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,2,2,0,t.RGBA,e,null);const n=t.createFramebuffer();return t.bindFramebuffer(t.FRAMEBUFFER,n),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,i,0),t.checkFramebufferStatus(t.FRAMEBUFFER)!==t.FRAMEBUFFER_COMPLETE&&(s=!1),t.bindTexture(t.TEXTURE_2D,null),t.deleteTexture(i),t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteFramebuffer(n),s}class ms extends de{constructor(t,e={}){super(t,e),this.gl=void 0,this.webgl2=void 0,e=this.initOptions,this.defaultFramebuffer=null,this.updateClientRect(),this.contextLost=!1,this._contextLostHandler=t=>{t.preventDefault(),this.contextLost=!0,this.loseContext(),this.fire("devicelost")},this._contextRestoredHandler=()=>{this.restoreContext(),this.contextLost=!1,this.fire("devicerestored")};const s="undefined"!=typeof navigator&&navigator.userAgent;this.forceDisableMultisampling=s&&s.includes("AppleWebKit")&&(s.includes("15.4")||s.includes("15_4")),this.forceDisableMultisampling&&(e.antialias=!1);let n=null;if(e.gl)n=e.gl;else{const s=void 0===e.preferWebGl2||e.preferWebGl2?["webgl2","webgl","experimental-webgl"]:["webgl","experimental-webgl"];for(let i=0;i<s.length&&(n=t.getContext(s[i],e),!n);i++);}if(!n)throw new Error("WebGL not supported");this.gl=n,this.webgl2="undefined"!=typeof WebGL2RenderingContext&&n instanceof WebGL2RenderingContext,this._deviceType=this.webgl2?"webgl2":"webgl1";const r=n.getParameter(n.ALPHA_BITS);this.framebufferFormat=r?7:6;const a="chrome"===w.browserName,o="safari"===w.browserName,l=w.browser&&-1!==navigator.appVersion.indexOf("Mac");let h,c,d,u,p;this._tempEnableSafariTextureUnitWorkaround=o,this._tempMacChromeBlitFramebufferWorkaround=l&&a&&!e.alpha,this.webgl2||function(t){if(t.getSupportedExtensions){if(-1!=t.getSupportedExtensions().indexOf("OES_vertex_array_object"))return}else if(t.getExtension&&t.getExtension("OES_vertex_array_object"))return;if(t.getSupportedExtensions){var e=t.getSupportedExtensions;t.getSupportedExtensions=function(){var t=e.call(this)||[];return t.push("OES_vertex_array_object"),t}}var s=t.getExtension;t.getExtension=function(e){return"OES_vertex_array_object"==e?(t.__OESVertexArrayObject||(t.__OESVertexArrayObject=new i(t)),t.__OESVertexArrayObject):s?s.call(this,e):null}}(n),t.addEventListener("webglcontextlost",this._contextLostHandler,!1),t.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches(),this.supportsImageBitmap=!o&&"undefined"!=typeof ImageBitmap,this.glAddress=[n.REPEAT,n.CLAMP_TO_EDGE,n.MIRRORED_REPEAT],this.glBlendEquation=[n.FUNC_ADD,n.FUNC_SUBTRACT,n.FUNC_REVERSE_SUBTRACT,this.webgl2?n.MIN:this.extBlendMinmax?this.extBlendMinmax.MIN_EXT:n.FUNC_ADD,this.webgl2?n.MAX:this.extBlendMinmax?this.extBlendMinmax.MAX_EXT:n.FUNC_ADD],this.glBlendFunctionColor=[n.ZERO,n.ONE,n.SRC_COLOR,n.ONE_MINUS_SRC_COLOR,n.DST_COLOR,n.ONE_MINUS_DST_COLOR,n.SRC_ALPHA,n.SRC_ALPHA_SATURATE,n.ONE_MINUS_SRC_ALPHA,n.DST_ALPHA,n.ONE_MINUS_DST_ALPHA,n.CONSTANT_COLOR,n.ONE_MINUS_CONSTANT_COLOR],this.glBlendFunctionAlpha=[n.ZERO,n.ONE,n.SRC_COLOR,n.ONE_MINUS_SRC_COLOR,n.DST_COLOR,n.ONE_MINUS_DST_COLOR,n.SRC_ALPHA,n.SRC_ALPHA_SATURATE,n.ONE_MINUS_SRC_ALPHA,n.DST_ALPHA,n.ONE_MINUS_DST_ALPHA,n.CONSTANT_ALPHA,n.ONE_MINUS_CONSTANT_ALPHA],this.glComparison=[n.NEVER,n.LESS,n.EQUAL,n.LEQUAL,n.GREATER,n.NOTEQUAL,n.GEQUAL,n.ALWAYS],this.glStencilOp=[n.KEEP,n.ZERO,n.REPLACE,n.INCR,n.INCR_WRAP,n.DECR,n.DECR_WRAP,n.INVERT],this.glClearFlag=[0,n.COLOR_BUFFER_BIT,n.DEPTH_BUFFER_BIT,n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT,n.STENCIL_BUFFER_BIT,n.STENCIL_BUFFER_BIT|n.COLOR_BUFFER_BIT,n.STENCIL_BUFFER_BIT|n.DEPTH_BUFFER_BIT,n.STENCIL_BUFFER_BIT|n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT],this.glCull=[0,n.BACK,n.FRONT,n.FRONT_AND_BACK],this.glFilter=[n.NEAREST,n.LINEAR,n.NEAREST_MIPMAP_NEAREST,n.NEAREST_MIPMAP_LINEAR,n.LINEAR_MIPMAP_NEAREST,n.LINEAR_MIPMAP_LINEAR],this.glPrimitive=[n.POINTS,n.LINES,n.LINE_LOOP,n.LINE_STRIP,n.TRIANGLES,n.TRIANGLE_STRIP,n.TRIANGLE_FAN],this.glType=[n.BYTE,n.UNSIGNED_BYTE,n.SHORT,n.UNSIGNED_SHORT,n.INT,n.UNSIGNED_INT,n.FLOAT],this.pcUniformType={},this.pcUniformType[n.BOOL]=0,this.pcUniformType[n.INT]=1,this.pcUniformType[n.FLOAT]=2,this.pcUniformType[n.FLOAT_VEC2]=3,this.pcUniformType[n.FLOAT_VEC3]=4,this.pcUniformType[n.FLOAT_VEC4]=5,this.pcUniformType[n.INT_VEC2]=6,this.pcUniformType[n.INT_VEC3]=7,this.pcUniformType[n.INT_VEC4]=8,this.pcUniformType[n.BOOL_VEC2]=9,this.pcUniformType[n.BOOL_VEC3]=10,this.pcUniformType[n.BOOL_VEC4]=11,this.pcUniformType[n.FLOAT_MAT2]=12,this.pcUniformType[n.FLOAT_MAT3]=13,this.pcUniformType[n.FLOAT_MAT4]=Nt,this.pcUniformType[n.SAMPLER_2D]=15,this.pcUniformType[n.SAMPLER_CUBE]=16,this.webgl2&&(this.pcUniformType[n.SAMPLER_2D_SHADOW]=18,this.pcUniformType[n.SAMPLER_CUBE_SHADOW]=19,this.pcUniformType[n.SAMPLER_3D]=20),this.targetToSlot={},this.targetToSlot[n.TEXTURE_2D]=0,this.targetToSlot[n.TEXTURE_CUBE_MAP]=1,this.targetToSlot[n.TEXTURE_3D]=2,this.commitFunction=[],this.commitFunction[0]=function(t,e){t.value!==e&&(n.uniform1i(t.locationId,e),t.value=e)},this.commitFunction[1]=this.commitFunction[0],this.commitFunction[2]=function(t,e){t.value!==e&&(n.uniform1f(t.locationId,e),t.value=e)},this.commitFunction[3]=function(t,e){p=t.value,h=e[0],c=e[1],p[0]===h&&p[1]===c||(n.uniform2fv(t.locationId,e),p[0]=h,p[1]=c)},this.commitFunction[4]=function(t,e){p=t.value,h=e[0],c=e[1],d=e[2],p[0]===h&&p[1]===c&&p[2]===d||(n.uniform3fv(t.locationId,e),p[0]=h,p[1]=c,p[2]=d)},this.commitFunction[5]=function(t,e){p=t.value,h=e[0],c=e[1],d=e[2],u=e[3],p[0]===h&&p[1]===c&&p[2]===d&&p[3]===u||(n.uniform4fv(t.locationId,e),p[0]=h,p[1]=c,p[2]=d,p[3]=u)},this.commitFunction[6]=function(t,e){p=t.value,h=e[0],c=e[1],p[0]===h&&p[1]===c||(n.uniform2iv(t.locationId,e),p[0]=h,p[1]=c)},this.commitFunction[9]=this.commitFunction[6],this.commitFunction[7]=function(t,e){p=t.value,h=e[0],c=e[1],d=e[2],p[0]===h&&p[1]===c&&p[2]===d||(n.uniform3iv(t.locationId,e),p[0]=h,p[1]=c,p[2]=d)},this.commitFunction[10]=this.commitFunction[7],this.commitFunction[8]=function(t,e){p=t.value,h=e[0],c=e[1],d=e[2],u=e[3],p[0]===h&&p[1]===c&&p[2]===d&&p[3]===u||(n.uniform4iv(t.locationId,e),p[0]=h,p[1]=c,p[2]=d,p[3]=u)},this.commitFunction[11]=this.commitFunction[8],this.commitFunction[12]=function(t,e){n.uniformMatrix2fv(t.locationId,!1,e)},this.commitFunction[13]=function(t,e){n.uniformMatrix3fv(t.locationId,!1,e)},this.commitFunction[14]=function(t,e){n.uniformMatrix4fv(t.locationId,!1,e)},this.commitFunction[17]=function(t,e){n.uniform1fv(t.locationId,e)},this.commitFunction[21]=function(t,e){n.uniform2fv(t.locationId,e)},this.commitFunction[22]=function(t,e){n.uniform3fv(t.locationId,e)},this.commitFunction[23]=function(t,e){n.uniform4fv(t.locationId,e)},this.supportsBoneTextures=this.extTextureFloat&&this.maxVertexTextures>0;let f=this.vertexUniformsCount;f-=16,f-=8,f-=1,f-=16,this.boneLimit=Math.floor(f/3),this.boneLimit=Math.min(this.boneLimit,128),"Mali-450 MP"===this.unmaskedRenderer&&(this.boneLimit=34),this.constantTexSource=this.scope.resolve("source"),this.extTextureFloat?this.webgl2?this.textureFloatRenderable=!!this.extColorBufferFloat:this.textureFloatRenderable=fs(n,n.FLOAT):this.textureFloatRenderable=!1,this.extColorBufferHalfFloat?this.textureHalfFloatRenderable=!!this.extColorBufferHalfFloat:this.extTextureHalfFloat?this.webgl2?this.textureHalfFloatRenderable=!!this.extColorBufferFloat:this.textureHalfFloatRenderable=fs(n,this.extTextureHalfFloat.HALF_FLOAT_OES):this.textureHalfFloatRenderable=!1,this.supportsMorphTargetTexturesCore="highp"===this.maxPrecision&&this.maxVertexTextures>=2,this.supportsDepthShadow=this.webgl2,this._textureFloatHighPrecision=void 0,this._textureHalfFloatUpdatable=void 0,this.areaLightLutFormat=7,this.extTextureHalfFloat&&this.textureHalfFloatUpdatable&&this.extTextureHalfFloatLinear?this.areaLightLutFormat=et:this.extTextureFloat&&this.extTextureFloatLinear&&(this.areaLightLutFormat=st),this.postInit()}destroy(){super.destroy();const t=this.gl;this.webgl2&&this.feedback&&t.deleteTransformFeedback(this.feedback),this.clearVertexArrayObjectCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this._contextLostHandler=null,this._contextRestoredHandler=null,this.gl=null,super.postDestroy()}createVertexBufferImpl(t,e){return new He}createIndexBufferImpl(t){return new Ge(t)}createShaderImpl(t){return new Je(t)}createTextureImpl(t){return new ts}createRenderTargetImpl(t){return new ss}getPrecision(){const t=this.gl;let e="highp";if(t.getShaderPrecisionFormat){const s=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT),i=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT),n=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT),r=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT),a=s.precision>0&&n.precision>0,o=i.precision>0&&r.precision>0;a||(e=o?"mediump":"lowp")}return e}getExtension(){for(let t=0;t<arguments.length;t++)if(-1!==this.supportedExtensions.indexOf(arguments[t]))return this.gl.getExtension(arguments[t]);return null}get extDisjointTimerQuery(){return this._extDisjointTimerQuery||this.webgl2&&(this._extDisjointTimerQuery=this.getExtension("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query")),this._extDisjointTimerQuery}initializeExtensions(){const t=this.gl,e=t.getSupportedExtensions();if(this.supportedExtensions=e,this.webgl2)this.extBlendMinmax=!0,this.extDrawBuffers=!0,this.drawBuffers=t.drawBuffers.bind(t),this.extInstancing=!0,this.extStandardDerivatives=!0,this.extTextureFloat=!0,this.extTextureHalfFloat=!0,this.extTextureLod=!0,this.extUintElement=!0,this.extVertexArrayObject=!0,this.extColorBufferFloat=this.getExtension("EXT_color_buffer_float"),this.extDepthTexture=!0;else{var s;if(this.extBlendMinmax=this.getExtension("EXT_blend_minmax"),this.extDrawBuffers=this.getExtension("WEBGL_draw_buffers"),this.extInstancing=this.getExtension("ANGLE_instanced_arrays"),this.drawBuffers=null==(s=this.extDrawBuffers)?void 0:s.drawBuffersWEBGL.bind(this.extDrawBuffers),this.extInstancing){const e=this.extInstancing;t.drawArraysInstanced=e.drawArraysInstancedANGLE.bind(e),t.drawElementsInstanced=e.drawElementsInstancedANGLE.bind(e),t.vertexAttribDivisor=e.vertexAttribDivisorANGLE.bind(e)}if(this.extStandardDerivatives=this.getExtension("OES_standard_derivatives"),this.extTextureFloat=this.getExtension("OES_texture_float"),this.extTextureHalfFloat=this.getExtension("OES_texture_half_float"),this.extTextureLod=this.getExtension("EXT_shader_texture_lod"),this.extUintElement=this.getExtension("OES_element_index_uint"),this.extVertexArrayObject=this.getExtension("OES_vertex_array_object"),this.extVertexArrayObject){const e=this.extVertexArrayObject;t.createVertexArray=e.createVertexArrayOES.bind(e),t.deleteVertexArray=e.deleteVertexArrayOES.bind(e),t.isVertexArray=e.isVertexArrayOES.bind(e),t.bindVertexArray=e.bindVertexArrayOES.bind(e)}this.extColorBufferFloat=null,this.extDepthTexture=t.getExtension("WEBGL_depth_texture")}this.extDebugRendererInfo=this.getExtension("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=this.getExtension("OES_texture_float_linear"),this.extTextureHalfFloatLinear=this.getExtension("OES_texture_half_float_linear"),this.extFloatBlend=this.getExtension("EXT_float_blend"),this.extTextureFilterAnisotropic=this.getExtension("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extCompressedTextureETC1=this.getExtension("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=this.getExtension("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=this.getExtension("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=this.getExtension("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extCompressedTextureATC=this.getExtension("WEBGL_compressed_texture_atc"),this.extCompressedTextureASTC=this.getExtension("WEBGL_compressed_texture_astc"),this.extParallelShaderCompile=this.getExtension("KHR_parallel_shader_compile"),this.extColorBufferHalfFloat=this.getExtension("EXT_color_buffer_half_float")}initializeCapabilities(){const t=this.gl;let e;const s="undefined"!=typeof navigator?navigator.userAgent:"";this.maxPrecision=this.precision=this.getPrecision();const i=t.getContextAttributes();this.supportsMsaa=i.antialias,this.supportsStencil=i.stencil,this.supportsInstancing=!!this.extInstancing,this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxCubeMapSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=t.getParameter(t.MAX_RENDERBUFFER_SIZE),this.maxTextures=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this.webgl2?(this.maxDrawBuffers=t.getParameter(t.MAX_DRAW_BUFFERS),this.maxColorAttachments=t.getParameter(t.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE),this.supportsMrt=!0,this.supportsVolumeTextures=!0):(e=this.extDrawBuffers,this.supportsMrt=!!e,this.maxDrawBuffers=e?t.getParameter(e.MAX_DRAW_BUFFERS_WEBGL):1,this.maxColorAttachments=e?t.getParameter(e.MAX_COLOR_ATTACHMENTS_WEBGL):1,this.maxVolumeSize=1),e=this.extDebugRendererInfo,this.unmaskedRenderer=e?t.getParameter(e.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=e?t.getParameter(e.UNMASKED_VENDOR_WEBGL):"";this.supportsGpuParticles=!("ARM"===this.unmaskedVendor&&s.match(/SM-[a-zA-Z0-9]+/)||this.unmaskedRenderer.match(/\bMali-G52+/)),e=this.extTextureFilterAnisotropic,this.maxAnisotropy=e?t.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1,this.samples=t.getParameter(t.SAMPLES),this.maxSamples=this.webgl2&&!this.forceDisableMultisampling?t.getParameter(t.MAX_SAMPLES):1,this.supportsAreaLights=this.webgl2||!w.android,this.supportsTextureFetch=this.webgl2,this.maxTextures<=8&&(this.supportsAreaLights=!1)}initializeRenderState(){super.initializeRenderState();const t=this.gl;t.disable(t.BLEND),t.blendFunc(t.ONE,t.ZERO),t.blendEquation(t.FUNC_ADD),t.colorMask(!0,!0,!0,!0),this.blendColor=new D(0,0,0,0),t.blendColor(0,0,0,0),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.depthMask(!0),this.stencil=!1,t.disable(t.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=7,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,t.stencilFunc(t.ALWAYS,0,255),this.stencilFailFront=this.stencilFailBack=0,this.stencilZfailFront=this.stencilZfailBack=0,this.stencilZpassFront=this.stencilZpassBack=0,this.stencilWriteMaskFront=255,this.stencilWriteMaskBack=255,t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.stencilMask(255),this.alphaToCoverage=!1,this.raster=!0,this.webgl2&&(t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.RASTERIZER_DISCARD)),this.depthBiasEnabled=!1,t.disable(t.POLYGON_OFFSET_FILL),this.clearDepth=1,t.clearDepth(1),this.clearColor=new D(0,0,0,0),t.clearColor(0,0,0,0),this.clearStencil=0,t.clearStencil(0),this.webgl2?t.hint(t.FRAGMENT_SHADER_DERIVATIVE_HINT,t.NICEST):this.extStandardDerivatives&&t.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,t.NICEST),t.enable(t.SCISSOR_TEST),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,t.NONE),this.unpackFlipY=!1,t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this.unpackPremultiplyAlpha=!1,t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.pixelStorei(t.UNPACK_ALIGNMENT,1)}initializeContextCaches(){super.initializeContextCaches(),this._vaoMap=new Map,this.boundVao=null,this.activeFramebuffer=null,this.feedback=null,this.transformFeedbackBuffer=null,this.textureUnit=0,this.textureUnits=[];for(let t=0;t<this.maxCombinedTextures;t++)this.textureUnits.push([null,null,null])}loseContext(){for(const t of this.shaders)t.loseContext();for(const t of this.textures)t.loseContext();for(const t of this.buffers)t.loseContext();for(const t of this.targets)t.loseContext()}restoreContext(){this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),this.initializeContextCaches();for(const t of this.shaders)t.restoreContext();for(const t of this.buffers)t.unlock()}endShaderBatch(){Je.endShaderBatch(this)}setViewport(t,e,s,i){this.vx===t&&this.vy===e&&this.vw===s&&this.vh===i||(this.gl.viewport(t,e,s,i),this.vx=t,this.vy=e,this.vw=s,this.vh=i)}setScissor(t,e,s,i){this.sx===t&&this.sy===e&&this.sw===s&&this.sh===i||(this.gl.scissor(t,e,s,i),this.sx=t,this.sy=e,this.sw=s,this.sh=i)}setFramebuffer(t){if(this.activeFramebuffer!==t){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,t),this.activeFramebuffer=t}}copyRenderTarget(t,e,s,i){const n=this.gl;if(!this.webgl2&&i)return!1;if(s)if(e){if(t){if(!t._colorBuffer||!e._colorBuffer)return!1;if(t._colorBuffer._format!==e._colorBuffer._format)return!1}}else if(!t._colorBuffer)return!1;if(i&&t&&!t._depth){if(!t._depthBuffer||!e._depthBuffer)return!1;if(t._depthBuffer._format!==e._depthBuffer._format)return!1}if(this.webgl2&&e){const r=this.renderTarget;this.renderTarget=e,this.updateBegin(),n.bindFramebuffer(n.READ_FRAMEBUFFER,t?t.impl._glFrameBuffer:null),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,e.impl._glFrameBuffer);const a=t?t.width:e.width,o=t?t.height:e.height;n.blitFramebuffer(0,0,a,o,0,0,a,o,(s?n.COLOR_BUFFER_BIT:0)|(i?n.DEPTH_BUFFER_BIT:0),n.NEAREST),this.renderTarget=r,n.bindFramebuffer(n.FRAMEBUFFER,r?r.impl._glFrameBuffer:null)}else{const s=this.getCopyShader();this.constantTexSource.setValue(t._colorBuffer),ps(this,e,s)}return!0}getCopyShader(){return this._copyShader||(this._copyShader=new Ie(this,cs.createDefinition(this,{name:"outputTex2D",vertexCode:us,fragmentCode:"\nvarying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\t\tgl_FragColor = texture2D(source, vUv0);\n}\n"}))),this._copyShader}startPass(t){this.setRenderTarget(t.renderTarget),this.updateBegin();const e=t.colorOps,s=t.depthStencilOps;if(null!=e&&e.clear||s.clearDepth||s.clearStencil){const i=t.renderTarget,n=i?i.width:this.width,r=i?i.height:this.height;this.setViewport(0,0,n,r),this.setScissor(0,0,n,r);let a=0;const o={};null!=e&&e.clear&&(a|=1,o.color=[e.clearValue.r,e.clearValue.g,e.clearValue.b,e.clearValue.a]),s.clearDepth&&(a|=2,o.depth=s.clearDepthValue),s.clearStencil&&(a|=4,o.stencil=s.clearStencilValue),o.flags=a,this.clear(o)}this.insideRenderPass=!0}endPass(t){this.unbindVertexArray();const e=this.renderTarget,s=t.colorArrayOps.length;if(e){var i;if(this.webgl2){ds.length=0;const e=this.gl;for(let i=0;i<s;i++){const s=t.colorArrayOps[i];s.store||s.resolve||ds.push(e.COLOR_ATTACHMENT0+i)}t.depthStencilOps.storeDepth||ds.push(e.DEPTH_ATTACHMENT),t.depthStencilOps.storeStencil||ds.push(e.STENCIL_ATTACHMENT),ds.length>0&&t.fullSizeClearRect&&e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,ds)}null!=(i=t.colorOps)&&i.resolve&&this.webgl2&&t.samples>1&&e.autoResolve&&e.resolve(!0,!1);for(let i=0;i<s;i++){if(t.colorArrayOps[i].mipmaps){const t=e._colorBuffers[i];t&&t.impl._glTexture&&t.mipmaps&&(t.pot||this.webgl2)&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(t),this.gl.generateMipmap(t.impl._glTarget))}}}this.insideRenderPass=!1}updateBegin(){if(this.boundVao=null,this._tempEnableSafariTextureUnitWorkaround)for(let t=0;t<this.textureUnits.length;++t)for(let e=0;e<3;++e)this.textureUnits[t][e]=null;const t=this.renderTarget;t?t.impl.initialized?this.setFramebuffer(t.impl._glFrameBuffer):this.initRenderTarget(t):this.setFramebuffer(this.defaultFramebuffer)}updateEnd(){this.unbindVertexArray();const t=this.renderTarget;if(t){this.webgl2&&t._samples>1&&t.autoResolve&&t.resolve();const e=t._colorBuffer;e&&e.impl._glTexture&&e.mipmaps&&(e.pot||this.webgl2)&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(e),this.gl.generateMipmap(e.impl._glTarget))}}setUnpackFlipY(t){if(this.unpackFlipY!==t){this.unpackFlipY=t;const e=this.gl;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t)}}setUnpackPremultiplyAlpha(t){if(this.unpackPremultiplyAlpha!==t){this.unpackPremultiplyAlpha=t;const e=this.gl;e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t)}}activeTexture(t){this.textureUnit!==t&&(this.gl.activeTexture(this.gl.TEXTURE0+t),this.textureUnit=t)}bindTexture(t){const e=t.impl,s=e._glTarget,i=e._glTexture,n=this.textureUnit,r=this.targetToSlot[s];this.textureUnits[n][r]!==i&&(this.gl.bindTexture(s,i),this.textureUnits[n][r]=i)}bindTextureOnUnit(t,e){const s=t.impl,i=s._glTarget,n=s._glTexture,r=this.targetToSlot[i];this.textureUnits[e][r]!==n&&(this.activeTexture(e),this.gl.bindTexture(i,n),this.textureUnits[e][r]=n)}setTextureParameters(t){const e=this.gl,s=t.impl.dirtyParameterFlags,i=t.impl._glTarget;if(1&s){let s=t._minFilter;(!t.pot&&!this.webgl2||!t._mipmaps||t._compressed&&1===t._levels.length)&&(2===s||3===s?s=0:4!==s&&5!==s||(s=1)),e.texParameteri(i,e.TEXTURE_MIN_FILTER,this.glFilter[s])}if(2&s&&e.texParameteri(i,e.TEXTURE_MAG_FILTER,this.glFilter[t._magFilter]),4&s&&(this.webgl2?e.texParameteri(i,e.TEXTURE_WRAP_S,this.glAddress[t._addressU]):e.texParameteri(i,e.TEXTURE_WRAP_S,this.glAddress[t.pot?t._addressU:1])),8&s&&(this.webgl2?e.texParameteri(i,e.TEXTURE_WRAP_T,this.glAddress[t._addressV]):e.texParameteri(i,e.TEXTURE_WRAP_T,this.glAddress[t.pot?t._addressV:1])),16&s&&this.webgl2&&e.texParameteri(i,e.TEXTURE_WRAP_R,this.glAddress[t._addressW]),32&s&&this.webgl2&&e.texParameteri(i,e.TEXTURE_COMPARE_MODE,t._compareOnRead?e.COMPARE_REF_TO_TEXTURE:e.NONE),64&s&&this.webgl2&&e.texParameteri(i,e.TEXTURE_COMPARE_FUNC,this.glComparison[t._compareFunc]),128&s){const s=this.extTextureFilterAnisotropic;s&&e.texParameterf(i,s.TEXTURE_MAX_ANISOTROPY_EXT,k.clamp(Math.round(t._anisotropy),1,this.maxAnisotropy))}}setTexture(t,e){const s=t.impl;s._glTexture||s.initialize(this,t),s.dirtyParameterFlags>0||t._needsUpload||t._needsMipmapsUpload?(this.activeTexture(e),this.bindTexture(t),s.dirtyParameterFlags&&(this.setTextureParameters(t),s.dirtyParameterFlags=0),(t._needsUpload||t._needsMipmapsUpload)&&(s.upload(this,t),t._needsUpload=!1,t._needsMipmapsUpload=!1)):this.bindTextureOnUnit(t,e)}createVertexArray(t){let e,s;const i=t.length>1;if(i){e="";for(let s=0;s<t.length;s++){const i=t[s];e+=i.id+i.format.renderingHash}s=this._vaoMap.get(e)}if(!s){const n=this.gl;s=n.createVertexArray(),n.bindVertexArray(s),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null);for(let e=0;e<t.length;e++){const s=t[e];n.bindBuffer(n.ARRAY_BUFFER,s.impl.bufferId);const i=s.format.elements;for(let t=0;t<i.length;t++){const e=i[t],r=Xt[e.name];n.vertexAttribPointer(r,e.numComponents,this.glType[e.dataType],e.normalize,e.stride,e.offset),n.enableVertexAttribArray(r),s.format.instancing&&n.vertexAttribDivisor(r,1)}}n.bindVertexArray(null),n.bindBuffer(n.ARRAY_BUFFER,null),i&&this._vaoMap.set(e,s)}return s}unbindVertexArray(){this.boundVao&&(this.boundVao=null,this.gl.bindVertexArray(null))}setBuffers(){const t=this.gl;let e;if(1===this.vertexBuffers.length){const t=this.vertexBuffers[0];t.impl.vao||(t.impl.vao=this.createVertexArray(this.vertexBuffers)),e=t.impl.vao}else e=this.createVertexArray(this.vertexBuffers);this.boundVao!==e&&(this.boundVao=e,t.bindVertexArray(e)),this.vertexBuffers.length=0;const s=this.indexBuffer?this.indexBuffer.impl.bufferId:null;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,s)}draw(t,e,s){const i=this.gl;let n,r,a,o,l,h,c,d;const u=this.shader;if(!u)return;const p=u.impl.samplers,f=u.impl.uniforms;s||this.setBuffers();let m=0;for(let t=0,e=p.length;t<e;t++){if(n=p[t],r=n.scopeId.value,!r)return;if(r instanceof Ue)a=r,this.setTexture(a,m),n.slot!==m&&(i.uniform1i(n.locationId,m),n.slot=m),m++;else{n.array.length=0,o=r.length;for(let t=0;t<o;t++)a=r[t],this.setTexture(a,m),n.array[t]=m,m++;i.uniform1iv(n.locationId,n.array)}}for(let t=0,e=f.length;t<e;t++)l=f[t],h=l.scopeId,c=l.version,d=h.versionObject.version,c.globalId===d.globalId&&c.revision===d.revision||(c.globalId=d.globalId,c.revision=d.revision,null!==h.value&&this.commitFunction[l.dataType](l,h.value));this.webgl2&&this.transformFeedbackBuffer&&(i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.impl.bufferId),i.beginTransformFeedback(i.POINTS));const g=this.glPrimitive[t.type],_=t.count;if(t.indexed){const s=this.indexBuffer,n=s.impl.glFormat,r=t.base*s.bytesPerIndex;e>0?i.drawElementsInstanced(g,_,n,r,e):i.drawElements(g,_,n,r)}else{const s=t.base;e>0?i.drawArraysInstanced(g,s,_,e):i.drawArrays(g,s,_)}this.webgl2&&this.transformFeedbackBuffer&&(i.endTransformFeedback(),i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,0,null)),this._drawCallsPerFrame++}clear(t){var e;const s=this.defaultClearOptions,i=null!=(e=(t=t||s).flags)?e:s.flags;if(0!==i){const e=this.gl;if(1&i){var n;const e=null!=(n=t.color)?n:s.color,i=e[0],r=e[1],a=e[2],o=e[3],l=this.clearColor;i===l.r&&r===l.g&&a===l.b&&o===l.a||(this.gl.clearColor(i,r,a,o),this.clearColor.set(i,r,a,o)),this.setBlendState(Zt.NOBLEND)}if(2&i){var r;const e=null!=(r=t.depth)?r:s.depth;e!==this.clearDepth&&(this.gl.clearDepth(e),this.clearDepth=e),this.setDepthState(te.WRITEDEPTH)}if(4&i){var a;const e=null!=(a=t.stencil)?a:s.stencil;e!==this.clearStencil&&(this.gl.clearStencil(e),this.clearStencil=e)}e.clear(this.glClearFlag[i])}}readPixels(t,e,s,i,n){const r=this.gl;r.readPixels(t,e,s,i,r.RGBA,r.UNSIGNED_BYTE,n)}async readPixelsAsync(t,e,s,i,n){var r,a,o;const l=this.gl;if(!this.webgl2)return this.readPixels(t,e,s,i,n);const h=null==(r=this.renderTarget.colorBuffer)?void 0:r.impl,c=null!=(a=null==h?void 0:h._glFormat)?a:l.RGBA,d=null!=(o=null==h?void 0:h._glPixelType)?o:l.UNSIGNED_BYTE,u=l.createBuffer();l.bindBuffer(l.PIXEL_PACK_BUFFER,u),l.bufferData(l.PIXEL_PACK_BUFFER,n.byteLength,l.STREAM_READ),l.readPixels(t,e,s,i,c,d,0),l.bindBuffer(l.PIXEL_PACK_BUFFER,null),await((t,e)=>{const s=l.fenceSync(l.SYNC_GPU_COMMANDS_COMPLETE,0);return l.flush(),new Promise(((i,n)=>{!function r(){const a=l.clientWaitSync(s,t,0);a===l.WAIT_FAILED?(l.deleteSync(s),n(new Error("webgl clientWaitSync sync failed"))):a===l.TIMEOUT_EXPIRED?setTimeout(r,e):(l.deleteSync(s),i())}()}))})(0,20),l.bindBuffer(l.PIXEL_PACK_BUFFER,u),l.getBufferSubData(l.PIXEL_PACK_BUFFER,0,n),l.bindBuffer(l.PIXEL_PACK_BUFFER,null),l.deleteBuffer(u)}setAlphaToCoverage(t){this.webgl2&&this.alphaToCoverage!==t&&(this.alphaToCoverage=t,t?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))}setTransformFeedbackBuffer(t){if(this.transformFeedbackBuffer!==t&&(this.transformFeedbackBuffer=t,this.webgl2)){const e=this.gl;t?(this.feedback||(this.feedback=e.createTransformFeedback()),e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,this.feedback)):e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,null)}}setRaster(t){this.raster!==t&&(this.raster=t,this.webgl2&&(t?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD)))}setDepthBias(t){this.depthBiasEnabled!==t&&(this.depthBiasEnabled=t,t?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL))}setDepthBiasValues(t,e){this.gl.polygonOffset(e,t)}setStencilTest(t){if(this.stencil!==t){const e=this.gl;t?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this.stencil=t}}setStencilFunc(t,e,s){this.stencilFuncFront===t&&this.stencilRefFront===e&&this.stencilMaskFront===s&&this.stencilFuncBack===t&&this.stencilRefBack===e&&this.stencilMaskBack===s||(this.gl.stencilFunc(this.glComparison[t],e,s),this.stencilFuncFront=this.stencilFuncBack=t,this.stencilRefFront=this.stencilRefBack=e,this.stencilMaskFront=this.stencilMaskBack=s)}setStencilFuncFront(t,e,s){if(this.stencilFuncFront!==t||this.stencilRefFront!==e||this.stencilMaskFront!==s){const i=this.gl;i.stencilFuncSeparate(i.FRONT,this.glComparison[t],e,s),this.stencilFuncFront=t,this.stencilRefFront=e,this.stencilMaskFront=s}}setStencilFuncBack(t,e,s){if(this.stencilFuncBack!==t||this.stencilRefBack!==e||this.stencilMaskBack!==s){const i=this.gl;i.stencilFuncSeparate(i.BACK,this.glComparison[t],e,s),this.stencilFuncBack=t,this.stencilRefBack=e,this.stencilMaskBack=s}}setStencilOperation(t,e,s,i){this.stencilFailFront===t&&this.stencilZfailFront===e&&this.stencilZpassFront===s&&this.stencilFailBack===t&&this.stencilZfailBack===e&&this.stencilZpassBack===s||(this.gl.stencilOp(this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[s]),this.stencilFailFront=this.stencilFailBack=t,this.stencilZfailFront=this.stencilZfailBack=e,this.stencilZpassFront=this.stencilZpassBack=s),this.stencilWriteMaskFront===i&&this.stencilWriteMaskBack===i||(this.gl.stencilMask(i),this.stencilWriteMaskFront=i,this.stencilWriteMaskBack=i)}setStencilOperationFront(t,e,s,i){this.stencilFailFront===t&&this.stencilZfailFront===e&&this.stencilZpassFront===s||(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[s]),this.stencilFailFront=t,this.stencilZfailFront=e,this.stencilZpassFront=s),this.stencilWriteMaskFront!==i&&(this.gl.stencilMaskSeparate(this.gl.FRONT,i),this.stencilWriteMaskFront=i)}setStencilOperationBack(t,e,s,i){this.stencilFailBack===t&&this.stencilZfailBack===e&&this.stencilZpassBack===s||(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[s]),this.stencilFailBack=t,this.stencilZfailBack=e,this.stencilZpassBack=s),this.stencilWriteMaskBack!==i&&(this.gl.stencilMaskSeparate(this.gl.BACK,i),this.stencilWriteMaskBack=i)}setBlendState(t){const e=this.blendState;if(!e.equals(t)){const s=this.gl,{blend:i,colorOp:n,alphaOp:r,colorSrcFactor:a,colorDstFactor:o,alphaSrcFactor:l,alphaDstFactor:h}=t;if(e.blend!==i&&(i?s.enable(s.BLEND):s.disable(s.BLEND)),e.colorOp!==n||e.alphaOp!==r){const t=this.glBlendEquation;s.blendEquationSeparate(t[n],t[r])}e.colorSrcFactor===a&&e.colorDstFactor===o&&e.alphaSrcFactor===l&&e.alphaDstFactor===h||s.blendFuncSeparate(this.glBlendFunctionColor[a],this.glBlendFunctionColor[o],this.glBlendFunctionAlpha[l],this.glBlendFunctionAlpha[h]),e.allWrite!==t.allWrite&&this.gl.colorMask(t.redWrite,t.greenWrite,t.blueWrite,t.alphaWrite),e.copy(t)}}setBlendColor(t,e,s,i){const n=this.blendColor;t===n.r&&e===n.g&&s===n.b&&i===n.a||(this.gl.blendColor(t,e,s,i),n.set(t,e,s,i))}setStencilState(t,e){t||e?(this.setStencilTest(!0),t===e?(this.setStencilFunc(t.func,t.ref,t.readMask),this.setStencilOperation(t.fail,t.zfail,t.zpass,t.writeMask)):(null!=t||(t=ce.DEFAULT),this.setStencilFuncFront(t.func,t.ref,t.readMask),this.setStencilOperationFront(t.fail,t.zfail,t.zpass,t.writeMask),null!=e||(e=ce.DEFAULT),this.setStencilFuncBack(e.func,e.ref,e.readMask),this.setStencilOperationBack(e.fail,e.zfail,e.zpass,e.writeMask))):this.setStencilTest(!1)}setDepthState(t){const e=this.depthState;if(!e.equals(t)){const s=this.gl,i=t.write;e.write!==i&&s.depthMask(i);let{func:n,test:r}=t;!r&&i&&(r=!0,n=7),e.func!==n&&s.depthFunc(this.glComparison[n]),e.test!==r&&(r?s.enable(s.DEPTH_TEST):s.disable(s.DEPTH_TEST)),e.copy(t)}}setCullMode(t){if(this.cullMode!==t){if(t===tt)this.gl.disable(this.gl.CULL_FACE);else{this.cullMode===tt&&this.gl.enable(this.gl.CULL_FACE);const e=this.glCull[t];this.cullFace!==e&&(this.gl.cullFace(e),this.cullFace=e)}this.cullMode=t}}setShader(t){if(t!==this.shader){if(t.failed)return!1;if(!t.ready&&!t.impl.finalize(this,t))return t.failed=!0,!1;this.shader=t,this.gl.useProgram(t.impl.glProgram),this.attributesInvalidated=!0}return!0}getHdrFormat(t,e,s,i){const n=this.extTextureHalfFloat&&(!e||this.textureHalfFloatRenderable)&&(!s||this.textureHalfFloatUpdatable)&&(!i||this.extTextureHalfFloatLinear),r=this.extTextureFloat&&(!e||this.textureFloatRenderable)&&(!i||this.extTextureFloatLinear);return n&&r?t?st:et:n?et:r?st:null}clearVertexArrayObjectCache(){const t=this.gl;this._vaoMap.forEach(((e,s,i)=>{t.deleteVertexArray(e)})),this._vaoMap.clear()}resizeCanvas(t,e){this._width=t,this._height=e;const s=Math.min(this._maxPixelRatio,w.browser?window.devicePixelRatio:1);t=Math.floor(t*s),e=Math.floor(e*s),this.canvas.width===t&&this.canvas.height===e||(this.canvas.width=t,this.canvas.height=e,this.fire(de.EVENT_RESIZE,t,e))}get width(){return this.gl.drawingBufferWidth||this.canvas.width}get height(){return this.gl.drawingBufferHeight||this.canvas.height}set fullscreen(t){if(t){this.gl.canvas.requestFullscreen()}else document.exitFullscreen()}get fullscreen(){return!!document.fullscreenElement}get textureFloatHighPrecision(){return void 0===this._textureFloatHighPrecision&&(this._textureFloatHighPrecision=function(t){if(!t.textureFloatRenderable)return!1;const e=new Ie(t,cs.createDefinition(t,{name:"ptest1",vertexCode:us,fragmentCode:"\nvoid main(void) { \n\t\tgl_FragColor = vec4(2147483648.0);\n}\n"})),s=new Ie(t,cs.createDefinition(t,{name:"ptest2",vertexCode:us,fragmentCode:"\nuniform sampler2D source;\nvec4 packFloat(float depth) {\n\t\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\t\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\t\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\t\tres -= res.xxyz * bit_mask;\n\t\treturn res;\n}\nvoid main(void) {\n\t\tfloat c = texture2D(source, vec2(0.0)).r;\n\t\tfloat diff = abs(c - 2147483648.0) / 2147483648.0;\n\t\tgl_FragColor = packFloat(diff);\n}\n"})),i={format:st,width:1,height:1,mipmaps:!1,minFilter:0,magFilter:0,name:"testFHP"},n=new Ue(t,i),r=new pe({colorBuffer:n,depth:!1});ps(t,r,e),i.format=7;const a=new Ue(t,i),o=new pe({colorBuffer:a,depth:!1});t.constantTexSource.setValue(n),ps(t,o,s);const l=t.activeFramebuffer;t.setFramebuffer(o.impl._glFrameBuffer);const h=new Uint8Array(4);t.readPixels(0,0,1,1,h),t.setFramebuffer(l);const c=h[0]/255/16777216+h[1]/255/65536+h[2]/255/256+h[3]/255;return n.destroy(),r.destroy(),a.destroy(),o.destroy(),e.destroy(),s.destroy(),0===c}(this)),this._textureFloatHighPrecision}get textureHalfFloatUpdatable(){return void 0===this._textureHalfFloatUpdatable&&(this.webgl2?this._textureHalfFloatUpdatable=!0:this._textureHalfFloatUpdatable=function(t,e){let s=!0;const i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const n=new Uint16Array(16);return t.texImage2D(t.TEXTURE_2D,0,t.RGBA,2,2,0,t.RGBA,e,n),t.getError()!==t.NO_ERROR&&(s=!1,console.log("Above error related to HALF_FLOAT_OES can be ignored, it was triggered by testing half float texture support")),t.bindTexture(t.TEXTURE_2D,null),t.deleteTexture(i),s}(this.gl,this.extTextureHalfFloat.HALF_FLOAT_OES)),this._textureHalfFloatUpdatable}}let gs=0;class _s{constructor(t,e,s,i=0,n){this.device=t,this.format=e,this.numIndices=s,this.usage=i,this.id=gs++,this.impl=t.createIndexBufferImpl(this);const r=qt[e];this.bytesPerIndex=r,this.numBytes=this.numIndices*r,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),this.adjustVramSizeTracking(t._vram,this.numBytes),this.device.buffers.push(this)}destroy(){const t=this.device,e=t.buffers.indexOf(this);-1!==e&&t.buffers.splice(e,1),this.device.indexBuffer===this&&(this.device.indexBuffer=null),this.impl.initialized&&(this.impl.destroy(t),this.adjustVramSizeTracking(t._vram,-this.storage.byteLength))}adjustVramSizeTracking(t,e){t.ib+=e}loseContext(){this.impl.loseContext()}getFormat(){return this.format}getNumIndices(){return this.numIndices}lock(){return this.storage}unlock(){this.impl.unlock(this)}setData(t){return t.byteLength===this.numBytes&&(this.storage=t,this.unlock(),!0)}_lockTypedArray(){const t=this.lock();return 2===this.format?new Uint32Array(t):1===this.format?new Uint16Array(t):new Uint8Array(t)}writeData(t,e){const s=this._lockTypedArray();if(t.length>e)if(ArrayBuffer.isView(t))t=t.subarray(0,e),s.set(t);else for(let i=0;i<e;i++)s[i]=t[i];else s.set(t);this.unlock()}readData(t){const e=this._lockTypedArray(),s=this.numIndices;if(ArrayBuffer.isView(t))t.set(e);else{t.length=0;for(let i=0;i<s;i++)t[i]=e[i]}return s}}function vs(t){this.array[this.index]=t}function bs(t,e){this.array[this.index]=t,this.array[this.index+1]=e}function ys(t,e,s){this.array[this.index]=t,this.array[this.index+1]=e,this.array[this.index+2]=s}function xs(t,e,s,i){this.array[this.index]=t,this.array[this.index+1]=e,this.array[this.index+2]=s,this.array[this.index+3]=i}function ws(t,e,s){this.array[t]=e[s]}function Ss(t,e,s){this.array[t]=e[s],this.array[t+1]=e[s+1]}function Cs(t,e,s){this.array[t]=e[s],this.array[t+1]=e[s+1],this.array[t+2]=e[s+2]}function Ts(t,e,s){this.array[t]=e[s],this.array[t+1]=e[s+1],this.array[t+2]=e[s+2],this.array[t+3]=e[s+3]}function Es(t,e,s){e[s]=this.array[t]}function Ps(t,e,s){e[s]=this.array[t],e[s+1]=this.array[t+1]}function Ms(t,e,s){e[s]=this.array[t],e[s+1]=this.array[t+1],e[s+2]=this.array[t+2]}function As(t,e,s){e[s]=this.array[t],e[s+1]=this.array[t+1],e[s+2]=this.array[t+2],e[s+3]=this.array[t+3]}class ks{constructor(t,e,s){switch(this.index=0,this.numComponents=e.numComponents,s.interleaved?this.array=new Gt[e.dataType](t,e.offset):this.array=new Gt[e.dataType](t,e.offset,s.vertexCount*e.numComponents),this.stride=e.stride/this.array.constructor.BYTES_PER_ELEMENT,e.numComponents){case 1:this.set=vs,this.getToArray=Es,this.setFromArray=ws;break;case 2:this.set=bs,this.getToArray=Ps,this.setFromArray=Ss;break;case 3:this.set=ys,this.getToArray=Ms,this.setFromArray=Cs;break;case 4:this.set=xs,this.getToArray=As,this.setFromArray=Ts}}get(t){return this.array[this.index+t]}set(t,e,s,i){}getToArray(t,e,s){}setFromArray(t,e,s){}}class Ds{constructor(t){this.vertexBuffer=t,this.vertexFormatSize=t.getFormat().size,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={};const e=this.vertexBuffer.getFormat();for(let t=0;t<e.elements.length;t++){const s=e.elements[t];this.accessors[t]=new ks(this.buffer,s,e),this.element[s.name]=this.accessors[t]}}next(t=1){let e=0;const s=this.accessors,i=this.accessors.length;for(;e<i;){const i=s[e++];i.index+=t*i.stride}}end(){this.vertexBuffer.unlock()}writeData(t,e,s){const i=this.element[t];if(i){s>this.vertexBuffer.numVertices&&(s=this.vertexBuffer.numVertices);const t=i.numComponents;if(this.vertexBuffer.getFormat().interleaved){let n=0;for(let r=0;r<s;r++)i.setFromArray(n,e,r*t),n+=i.stride}else if(e.length>s*t){const n=s*t;if(ArrayBuffer.isView(e))e=e.subarray(0,n),i.array.set(e);else for(let t=0;t<n;t++)i.array[t]=e[t]}else i.array.set(e)}}readData(t,e){const s=this.element[t];let i=0;if(s){let t;i=this.vertexBuffer.numVertices;const n=s.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(e)&&(e.length=0),s.index=0;let r=0;for(t=0;t<i;t++)s.getToArray(r,e,t*n),r+=s.stride}else if(ArrayBuffer.isView(e))e.set(s.array);else{e.length=0;const r=i*n;for(t=0;t<r;t++)e[t]=s.array[t]}}return i}}const Rs="mousedown",Ls="mousemove",Is="mouseup",Os="mousewheel",Fs="touchstart",Bs="touchend",zs="touchmove",Ns="touchcancel";const Us=new class{constructor(t,e){e?(this.key=e.keyCode,this.element=e.target,this.event=e):(this.key=null,this.element=null,this.event=null)}};function Vs(t){return Us.key=t.keyCode,Us.element=t.target,Us.event=t,Us}function Hs(t){return"string"==typeof t?t.toUpperCase().charCodeAt(0):t}const Gs={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"};class Ws extends h{constructor(t,e={}){super(),this._element=null,this._keyDownHandler=this._handleKeyDown.bind(this),this._keyUpHandler=this._handleKeyUp.bind(this),this._keyPressHandler=this._handleKeyPress.bind(this),this._visibilityChangeHandler=this._handleVisibilityChange.bind(this),this._windowBlurHandler=this._handleWindowBlur.bind(this),this._keymap={},this._lastmap={},t&&this.attach(t),this.preventDefault=e.preventDefault||!1,this.stopPropagation=e.stopPropagation||!1}attach(t){this._element&&this.detach(),this._element=t,this._element.addEventListener("keydown",this._keyDownHandler,!1),this._element.addEventListener("keypress",this._keyPressHandler,!1),this._element.addEventListener("keyup",this._keyUpHandler,!1),document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.addEventListener("blur",this._windowBlurHandler,!1)}detach(){this._element&&(this._element.removeEventListener("keydown",this._keyDownHandler),this._element.removeEventListener("keypress",this._keyPressHandler),this._element.removeEventListener("keyup",this._keyUpHandler),this._element=null,document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),window.removeEventListener("blur",this._windowBlurHandler,!1))}toKeyIdentifier(t){t=Hs(t);const e=Gs[t.toString()];if(e)return e;let s=t.toString(16).toUpperCase();const i=s.length;for(let t=0;t<4-i;t++)s="0"+s;return"U+"+s}_handleKeyDown(t){const e=t.keyCode||t.charCode;if(void 0===e)return;const s=this.toKeyIdentifier(e);this._keymap[s]=!0,this.fire("keydown",Vs(t)),this.preventDefault&&t.preventDefault(),this.stopPropagation&&t.stopPropagation()}_handleKeyUp(t){const e=t.keyCode||t.charCode;if(void 0===e)return;const s=this.toKeyIdentifier(e);delete this._keymap[s],this.fire("keyup",Vs(t)),this.preventDefault&&t.preventDefault(),this.stopPropagation&&t.stopPropagation()}_handleKeyPress(t){this.fire("keypress",Vs(t)),this.preventDefault&&t.preventDefault(),this.stopPropagation&&t.stopPropagation()}_handleVisibilityChange(){"hidden"===document.visibilityState&&this._handleWindowBlur()}_handleWindowBlur(){this._keymap={},this._lastmap={}}update(){for(const t in this._lastmap)delete this._lastmap[t];for(const t in this._keymap)this._keymap.hasOwnProperty(t)&&(this._lastmap[t]=this._keymap[t])}isPressed(t){const e=Hs(t),s=this.toKeyIdentifier(e);return!!this._keymap[s]}wasPressed(t){const e=Hs(t),s=this.toKeyIdentifier(e);return!!this._keymap[s]&&!this._lastmap[s]}wasReleased(t){const e=Hs(t),s=this.toKeyIdentifier(e);return!this._keymap[s]&&!!this._lastmap[s]}}function js(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)}class qs{constructor(t,e){let s={x:0,y:0};if(e){if(e instanceof qs)throw Error("Expected MouseEvent");s=t._getTargetCoords(e)}else e={};if(s)this.x=s.x,this.y=s.y;else{if(!js())return;this.x=0,this.y=0}this.wheelDelta=0,"wheel"===e.type&&(e.deltaY>0?this.wheelDelta=1:e.deltaY<0&&(this.wheelDelta=-1)),js()?(this.dx=e.movementX||e.webkitMovementX||e.mozMovementX||0,this.dy=e.movementY||e.webkitMovementY||e.mozMovementY||0):(this.dx=this.x-t._lastX,this.dy=this.y-t._lastY),"mousedown"===e.type||"mouseup"===e.type?this.button=e.button:this.button=-1,this.buttons=t._buttons.slice(0),this.element=e.target,this.ctrlKey=e.ctrlKey||!1,this.altKey=e.altKey||!1,this.shiftKey=e.shiftKey||!1,this.metaKey=e.metaKey||!1,this.event=e}}class Xs extends h{constructor(t){super(),this._lastX=0,this._lastY=0,this._buttons=[!1,!1,!1],this._lastbuttons=[!1,!1,!1],this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._contextMenuHandler=t=>{t.preventDefault()},this._target=null,this._attached=!1,this.attach(t)}static isPointerLocked(){return js()}attach(t){if(this._target=t,this._attached)return;this._attached=!0;const e=!!w.passiveEvents&&{passive:!1};window.addEventListener("mouseup",this._upHandler,e),window.addEventListener("mousedown",this._downHandler,e),window.addEventListener("mousemove",this._moveHandler,e),window.addEventListener("wheel",this._wheelHandler,e)}detach(){if(!this._attached)return;this._attached=!1,this._target=null;const t=!!w.passiveEvents&&{passive:!1};window.removeEventListener("mouseup",this._upHandler,t),window.removeEventListener("mousedown",this._downHandler,t),window.removeEventListener("mousemove",this._moveHandler,t),window.removeEventListener("wheel",this._wheelHandler,t)}disableContextMenu(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)}enableContextMenu(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)}enablePointerLock(t,e){if(!document.body.requestPointerLock)return void(e&&e());const s=()=>{t(),document.removeEventListener("pointerlockchange",s)},i=()=>{e(),document.removeEventListener("pointerlockerror",i)};t&&document.addEventListener("pointerlockchange",s,!1),e&&document.addEventListener("pointerlockerror",i,!1),document.body.requestPointerLock()}disablePointerLock(t){if(!document.exitPointerLock)return;const e=()=>{t(),document.removeEventListener("pointerlockchange",e)};t&&document.addEventListener("pointerlockchange",e,!1),document.exitPointerLock()}update(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2]}isPressed(t){return this._buttons[t]}wasPressed(t){return this._buttons[t]&&!this._lastbuttons[t]}wasReleased(t){return!this._buttons[t]&&this._lastbuttons[t]}_handleUp(t){this._buttons[t.button]=!1;const e=new qs(this,t);e.event&&this.fire(Is,e)}_handleDown(t){this._buttons[t.button]=!0;const e=new qs(this,t);e.event&&this.fire(Rs,e)}_handleMove(t){const e=new qs(this,t);e.event&&(this.fire(Ls,e),this._lastX=e.x,this._lastY=e.y)}_handleWheel(t){const e=new qs(this,t);e.event&&this.fire(Os,e)}_getTargetCoords(t){const e=this._target.getBoundingClientRect(),s=Math.floor(e.left),i=Math.floor(e.top);return t.clientX<s||t.clientX>=s+this._target.clientWidth||t.clientY<i||t.clientY>=i+this._target.clientHeight?null:{x:t.clientX-s,y:t.clientY-i}}}class $s{constructor(t){const e=function(t){let e=0,s=0,i=t.target;for(;!(i instanceof HTMLElement);)i=i.parentNode;let n=i;do{e+=n.offsetLeft-n.scrollLeft,s+=n.offsetTop-n.scrollTop,n=n.offsetParent}while(n);return{x:t.pageX-e,y:t.pageY-s}}(t);this.id=t.identifier,this.x=e.x,this.y=e.y,this.target=t.target,this.touch=t}}class Ks{constructor(t,e){if(this.element=e.target,this.event=e,this.touches=[],this.changedTouches=[],e){for(let t=0,s=e.touches.length;t<s;t++)this.touches.push(new $s(e.touches[t]));for(let t=0,s=e.changedTouches.length;t<s;t++)this.changedTouches.push(new $s(e.changedTouches[t]))}}getTouchById(t,e){for(let s=0,i=e.length;s<i;s++)if(e[s].id===t)return e[s];return null}}class Ys extends h{constructor(t){super(),this._element=null,this._startHandler=this._handleTouchStart.bind(this),this._endHandler=this._handleTouchEnd.bind(this),this._moveHandler=this._handleTouchMove.bind(this),this._cancelHandler=this._handleTouchCancel.bind(this),this.attach(t)}attach(t){this._element&&this.detach(),this._element=t,this._element.addEventListener("touchstart",this._startHandler,!1),this._element.addEventListener("touchend",this._endHandler,!1),this._element.addEventListener("touchmove",this._moveHandler,!1),this._element.addEventListener("touchcancel",this._cancelHandler,!1)}detach(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1)),this._element=null}_handleTouchStart(t){this.fire("touchstart",new Ks(this,t))}_handleTouchEnd(t){this.fire("touchend",new Ks(this,t))}_handleTouchMove(t){t.preventDefault(),this.fire("touchmove",new Ks(this,t))}_handleTouchCancel(t){this.fire("touchcancel",new Ks(this,t))}}class Qs{get(t,e,s){return"function"==typeof e&&(s=e,e={}),this.request("GET",t,e,s)}post(t,e,s,i){return"function"==typeof s&&(i=s,s={}),s.postdata=e,this.request("POST",t,s,i)}put(t,e,s,i){return"function"==typeof s&&(i=s,s={}),s.postdata=e,this.request("PUT",t,s,i)}del(t,e,s){return"function"==typeof e&&(s=e,e={}),this.request("DELETE",t,e,s)}request(t,e,s,i){let n,r,a,o=!1;if("function"==typeof s&&(i=s,s={}),s.retry&&(s=Object.assign({retries:0,maxRetries:5},s)),s.callback=i,null==s.async&&(s.async=!0),null==s.headers&&(s.headers={}),null!=s.postdata)if(s.postdata instanceof Document)a=s.postdata;else if(s.postdata instanceof FormData)a=s.postdata;else if(s.postdata instanceof Object){let t=s.headers["Content-Type"];switch(void 0===t&&(s.headers["Content-Type"]=Qs.ContentType.FORM_URLENCODED,t=s.headers["Content-Type"]),t){case Qs.ContentType.FORM_URLENCODED:{a="";let t=!0;for(const e in s.postdata)if(s.postdata.hasOwnProperty(e)){t?t=!1:a+="&";a+=`${encodeURIComponent(e)}=${encodeURIComponent(s.postdata[e])}`}break}default:case Qs.ContentType.JSON:null==t&&(s.headers["Content-Type"]=Qs.ContentType.JSON),a=JSON.stringify(s.postdata)}}else a=s.postdata;if(!1===s.cache){const t=P();n=new A(e),n.query?n.query=n.query+"&ts="+t:n.query="ts="+t,e=n.toString()}s.query&&(n=new A(e),r=l(n.getQuery(),s.query),n.setQuery(r),e=n.toString());const h=new XMLHttpRequest;h.open(t,e,s.async),h.withCredentials=void 0!==s.withCredentials&&s.withCredentials,h.responseType=s.responseType||this._guessResponseType(e);for(const t in s.headers)s.headers.hasOwnProperty(t)&&h.setRequestHeader(t,s.headers[t]);h.onreadystatechange=()=>{this._onReadyStateChange(t,e,s,h)},h.onerror=()=>{this._onError(t,e,s,h),o=!0};try{h.send(a)}catch(t){o||s.error(h.status,h,t)}return h}_guessResponseType(t){const e=new A(t),s=u.getExtension(e.path).toLowerCase();return Qs.binaryExtensions.indexOf(s)>=0?Qs.ResponseType.ARRAY_BUFFER:".json"===s?Qs.ResponseType.JSON:".xml"===s?Qs.ResponseType.DOCUMENT:Qs.ResponseType.TEXT}_isBinaryContentType(t){return[Qs.ContentType.BASIS,Qs.ContentType.BIN,Qs.ContentType.DDS,Qs.ContentType.GLB,Qs.ContentType.MP3,Qs.ContentType.MP4,Qs.ContentType.OGG,Qs.ContentType.OPUS,Qs.ContentType.WAV].indexOf(t)>=0}_isBinaryResponseType(t){return t===Qs.ResponseType.ARRAY_BUFFER||t===Qs.ResponseType.BLOB||t===Qs.ResponseType.JSON}_onReadyStateChange(t,e,s,i){if(4===i.readyState)switch(i.status){case 0:i.responseURL&&i.responseURL.startsWith("file:///")?this._onSuccess(t,e,s,i):this._onError(t,e,s,i);break;case 200:case 201:case 206:case 304:this._onSuccess(t,e,s,i);break;default:this._onError(t,e,s,i)}}_onSuccess(t,e,s,i){let n,r;const a=i.getResponseHeader("Content-Type");if(a){r=a.split(";")[0].trim()}try{n=this._isBinaryContentType(r)||this._isBinaryResponseType(i.responseType)?i.response:r===Qs.ContentType.JSON||e.split("?")[0].endsWith(".json")?JSON.parse(i.responseText):i.responseType===Qs.ResponseType.DOCUMENT||r===Qs.ContentType.XML?i.responseXML:i.responseText,s.callback(null,n)}catch(t){s.callback(t)}}_onError(t,e,s,i){if(!s.retrying)if(s.retry&&s.retries<s.maxRetries){s.retries++,s.retrying=!0;const n=k.clamp(Math.pow(2,s.retries)*Qs.retryDelay,0,s.maxRetryDelay||5e3);console.log(`${t}: ${e} - Error ${i.status}. Retrying in ${n} ms`),setTimeout((()=>{s.retrying=!1,this.request(t,e,s,s.callback)}),n)}else s.callback(0===i.status?"Network error":i.status,null)}}Qs.ContentType={AAC:"audio/aac",BASIS:"image/basis",BIN:"application/octet-stream",DDS:"image/dds",FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",GLB:"model/gltf-binary",JPEG:"image/jpeg",JSON:"application/json",MP3:"audio/mpeg",MP4:"audio/mp4",OGG:"audio/ogg",OPUS:'audio/ogg; codecs="opus"',PNG:"image/png",TEXT:"text/plain",WAV:"audio/x-wav",XML:"application/xml"},Qs.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"},Qs.binaryExtensions=[".model",".wav",".ogg",".mp3",".mp4",".m4a",".aac",".dds",".basis",".glb",".opus"],Qs.retryDelay=100;const Js=new Qs,Zs="none",ti={0:"PCF3",1:"VSM8",2:"VSM16",3:"VSM32",4:"PCF5",5:"PCF1",6:"PCSS"},ei=256,si=1024,ii=2048,ni=4096,ri=8192;class ai{constructor(){this._refCount=0}incRefCount(){this._refCount++}decRefCount(){this._refCount--}get refCount(){return this._refCount}}class oi{static set(t){oi._graphicsDevice=t}static get(){return oi._graphicsDevice}}oi._graphicsDevice=null;let li=0;class hi{constructor(){this.initDefaults()}initDefaults(){this.recreate=!1,this.verticesUsage=0,this.indicesUsage=0,this.maxVertices=0,this.maxIndices=0,this.vertexCount=0,this.indexCount=0,this.vertexStreamsUpdated=!1,this.indexStreamUpdated=!1,this.vertexStreamDictionary={},this.indices=null}_changeVertexCount(t,e){this.vertexCount||(this.vertexCount=t)}}hi.DEFAULT_COMPONENTS_POSITION=3,hi.DEFAULT_COMPONENTS_NORMAL=3,hi.DEFAULT_COMPONENTS_UV=2,hi.DEFAULT_COMPONENTS_COLORS=4;class ci{constructor(t,e,s,i){this.data=t,this.componentCount=e,this.dataType=s,this.dataTypeNormalize=i}}class di extends ai{constructor(t){super(),this.id=li++,this.device=t||oi.get(),this.vertexBuffer=null,this.indexBuffer=[null],this.primitive=[{type:0,base:0,count:0}],this.skin=null,this._morph=null,this._geometryData=null,this._aabb=new $,this.boneAabb=null}set morph(t){t!==this._morph&&(this._morph&&this._morph.decRefCount(),this._morph=t,t&&t.incRefCount())}get morph(){return this._morph}set aabb(t){this._aabb=t}get aabb(){return this._aabb}destroy(){const t=this.morph;t&&(this.morph=null,t.refCount<1&&t.destroy()),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);for(let t=0;t<this.indexBuffer.length;t++)this._destroyIndexBuffer(t);this.indexBuffer.length=0,this._geometryData=null}_destroyIndexBuffer(t){this.indexBuffer[t]&&(this.indexBuffer[t].destroy(),this.indexBuffer[t]=null)}_initBoneAabbs(t){let e,s,i,n,r;this.boneAabb=[],this.boneUsed=[];const a=[],o=[],l=this.boneUsed,h=this.skin.boneNames.length;let c,d,u;for(let t=0;t<h;t++)a[t]=new R(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o[t]=new R(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);const p=new Ds(this.vertexBuffer),f=p.element[at],m=p.element[ht],g=p.element[ct],_=this.vertexBuffer.numVertices;for(let h=0;h<_;h++){for(let p=0;p<4;p++){if(m.array[m.index+p]>0){const m=g.array[g.index+p];if(l[m]=!0,e=f.array[f.index],s=f.array[f.index+1],i=f.array[f.index+2],n=o[m],r=a[m],r.x>e&&(r.x=e),r.y>s&&(r.y=s),r.z>i&&(r.z=i),n.x<e&&(n.x=e),n.y<s&&(n.y=s),n.z<i&&(n.z=i),t){let a=c=e,o=d=s,l=u=i;for(let e=0;e<t.length;e++){const s=t[e],i=s.deltaPositions[3*h],n=s.deltaPositions[3*h+1],r=s.deltaPositions[3*h+2];i<0?a+=i:c+=i,n<0?o+=n:d+=n,r<0?l+=r:u+=r}r.x>a&&(r.x=a),r.y>o&&(r.y=o),r.z>l&&(r.z=l),n.x<c&&(n.x=c),n.y<d&&(n.y=d),n.z<u&&(n.z=u)}}}p.next()}const v=this.vertexBuffer.getFormat().elements.find((t=>t.name===at));if(v&&v.normalize){const t=(()=>{switch(v.dataType){case 0:return t=>Math.max(t/127,-1);case zt:return t=>t/255;case 2:return t=>Math.max(t/32767,-1);case 3:return t=>t/65535;default:return t=>t}})();for(let e=0;e<h;e++)if(l[e]){const s=a[e],i=o[e];s.set(t(s.x),t(s.y),t(s.z)),i.set(t(i.x),t(i.y),t(i.z))}}for(let t=0;t<h;t++){const e=new $;e.setMinMax(a[t],o[t]),this.boneAabb.push(e)}}_initGeometryData(){this._geometryData||(this._geometryData=new hi,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),this.indexBuffer.length>0&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices))}clear(t,e,s=0,i=0){this._initGeometryData(),this._geometryData.initDefaults(),this._geometryData.recreate=!0,this._geometryData.maxVertices=s,this._geometryData.maxIndices=i,this._geometryData.verticesUsage=t?0:1,this._geometryData.indicesUsage=e?0:1}setVertexStream(t,e,s,i,n=6,r=!1){this._initGeometryData();const a=i||e.length/s;this._geometryData._changeVertexCount(a,t),this._geometryData.vertexStreamsUpdated=!0,this._geometryData.vertexStreamDictionary[t]=new ci(e,s,n,r)}getVertexStream(t,e){let s=0,i=!1;if(this._geometryData){const n=this._geometryData.vertexStreamDictionary[t];n&&(i=!0,s=this._geometryData.vertexCount,ArrayBuffer.isView(e)?e.set(n.data):(e.length=0,e.push(n.data)))}if(!i&&this.vertexBuffer){s=new Ds(this.vertexBuffer).readData(t,e)}return s}setPositions(t,e=hi.DEFAULT_COMPONENTS_POSITION,s){this.setVertexStream(at,t,e,s,6,!1)}setNormals(t,e=hi.DEFAULT_COMPONENTS_NORMAL,s){this.setVertexStream(ot,t,e,s,6,!1)}setUvs(t,e,s=hi.DEFAULT_COMPONENTS_UV,i){this.setVertexStream(ut+t,e,s,i,6,!1)}setColors(t,e=hi.DEFAULT_COMPONENTS_COLORS,s){this.setVertexStream(dt,t,e,s,6,!1)}setColors32(t,e){this.setVertexStream(dt,t,hi.DEFAULT_COMPONENTS_COLORS,e,zt,!0)}setIndices(t,e){this._initGeometryData(),this._geometryData.indexStreamUpdated=!0,this._geometryData.indices=t,this._geometryData.indexCount=e||t.length}getPositions(t){return this.getVertexStream(at,t)}getNormals(t){return this.getVertexStream(ot,t)}getUvs(t,e){return this.getVertexStream(ut+t,e)}getColors(t){return this.getVertexStream(dt,t)}getIndices(t){let e=0;if(this._geometryData&&this._geometryData.indices){const s=this._geometryData.indices;e=this._geometryData.indexCount,ArrayBuffer.isView(t)?t.set(s):(t.length=0,t.push(s))}else if(this.indexBuffer.length>0&&this.indexBuffer[0]){e=this.indexBuffer[0].readData(t)}return e}update(t=4,e=!0){if(this._geometryData){if(e){const t=this._geometryData.vertexStreamDictionary[at];t&&3===t.componentCount&&this._aabb.compute(t.data,this._geometryData.vertexCount)}let s=this._geometryData.recreate;this._geometryData.vertexCount>this._geometryData.maxVertices&&(s=!0,this._geometryData.maxVertices=this._geometryData.vertexCount),s&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null);let i=this._geometryData.recreate;this._geometryData.indexCount>this._geometryData.maxIndices&&(i=!0,this._geometryData.maxIndices=this._geometryData.indexCount),i&&this.indexBuffer.length>0&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=t,this.indexBuffer.length>0&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=!0):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=!1),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=!1,this._geometryData.indexStreamUpdated=!1,this._geometryData.recreate=!1,this.updateRenderStates()}}_buildVertexFormat(t){const e=[];for(const t in this._geometryData.vertexStreamDictionary){const s=this._geometryData.vertexStreamDictionary[t];e.push({semantic:t,components:s.componentCount,type:s.dataType,normalize:s.dataTypeNormalize})}return new he(this.device,e,t)}_updateVertexBuffer(){if(!this.vertexBuffer){const t=this._geometryData.maxVertices,e=this._buildVertexFormat(t);this.vertexBuffer=new oe(this.device,e,t,this._geometryData.verticesUsage)}const t=new Ds(this.vertexBuffer),e=this._geometryData.vertexCount;for(const s in this._geometryData.vertexStreamDictionary){const i=this._geometryData.vertexStreamDictionary[s];t.writeData(s,i.data,e),delete this._geometryData.vertexStreamDictionary[s]}t.end()}_updateIndexBuffer(){if(this.indexBuffer.length<=0||!this.indexBuffer[0]){const t=this._geometryData.maxVertices>65535?2:1;this.indexBuffer[0]=new _s(this.device,t,this._geometryData.maxIndices,this._geometryData.indicesUsage)}const t=this._geometryData.indices;if(t){this.indexBuffer[0].writeData(t,this._geometryData.indexCount),this._geometryData.indices=null}}prepareRenderState(t){1===t?this.generateWireframe():2===t&&(this.primitive[2]={type:0,base:0,count:this.vertexBuffer?this.vertexBuffer.numVertices:0,indexed:!1})}updateRenderStates(){this.primitive[2]&&this.prepareRenderState(2),this.primitive[1]&&this.prepareRenderState(1)}generateWireframe(){this._destroyIndexBuffer(1);const t=this.vertexBuffer.numVertices,e=[];let s;if(this.indexBuffer.length>0&&this.indexBuffer[0]){const i=[[0,1],[1,2],[2,0]],n=this.primitive[0].base,r=this.primitive[0].count,a=this.indexBuffer[0],o=new jt[a.format](a.storage),l=new Set;for(let s=n;s<n+r;s+=3)for(let n=0;n<3;n++){const r=o[s+i[n][0]],a=o[s+i[n][1]],h=r>a?a*t+r:r*t+a;l.has(h)||(l.add(h),e.push(r,a))}s=a.format}else{for(let s=0;s<t;s+=3)e.push(s,s+1,s+1,s+2,s+2,s);s=e.length>65535?2:1}const i=new _s(this.vertexBuffer.device,s,e.length);new jt[i.format](i.storage).set(e),i.unlock(),this.primitive[1]={type:1,base:0,count:e.length,indexed:!0},this.indexBuffer[1]=i}}const ui=4/64,pi=1-2*ui,fi=[];function mi(t,e,s,i){const n=i.length/3,r=t.length/3,a=new R,o=new R,l=new R,h=new I,c=new I,d=new I,u=new R,p=new R,f=new Float32Array(3*r),m=new Float32Array(3*r),g=[];for(let e=0;e<n;e++){const n=i[3*e],r=i[3*e+1],g=i[3*e+2];a.set(t[3*n],t[3*n+1],t[3*n+2]),o.set(t[3*r],t[3*r+1],t[3*r+2]),l.set(t[3*g],t[3*g+1],t[3*g+2]),h.set(s[2*n],s[2*n+1]),c.set(s[2*r],s[2*r+1]),d.set(s[2*g],s[2*g+1]);const _=o.x-a.x,v=l.x-a.x,b=o.y-a.y,y=l.y-a.y,x=o.z-a.z,w=l.z-a.z,S=c.x-h.x,C=d.x-h.x,T=c.y-h.y,E=d.y-h.y,P=S*E-C*T;if(0===P)u.set(0,1,0),p.set(1,0,0);else{const t=1/P;u.set((E*_-T*v)*t,(E*b-T*y)*t,(E*x-T*w)*t),p.set((S*v-C*_)*t,(S*y-C*b)*t,(S*w-C*x)*t)}f[3*n+0]+=u.x,f[3*n+1]+=u.y,f[3*n+2]+=u.z,f[3*r+0]+=u.x,f[3*r+1]+=u.y,f[3*r+2]+=u.z,f[3*g+0]+=u.x,f[3*g+1]+=u.y,f[3*g+2]+=u.z,m[3*n+0]+=p.x,m[3*n+1]+=p.y,m[3*n+2]+=p.z,m[3*r+0]+=p.x,m[3*r+1]+=p.y,m[3*r+2]+=p.z,m[3*g+0]+=p.x,m[3*g+1]+=p.y,m[3*g+2]+=p.z}const _=new R,v=new R,b=new R,y=new R;for(let t=0;t<r;t++){b.set(e[3*t],e[3*t+1],e[3*t+2]),_.set(f[3*t],f[3*t+1],f[3*t+2]),v.set(m[3*t],m[3*t+1],m[3*t+2]);const s=b.dot(_);y.copy(b).mulScalar(s),y.sub2(_,y).normalize(),g[4*t]=y.x,g[4*t+1]=y.y,g[4*t+2]=y.z,y.cross(b,_),g[4*t+3]=y.dot(v)<0?-1:1}return g}function gi(t,e,s){const i=new di(t);return i.setPositions(e),s&&(s.normals&&i.setNormals(s.normals),s.tangents&&i.setVertexStream(lt,s.tangents,4),s.colors&&i.setColors32(s.colors),s.uvs&&i.setUvs(0,s.uvs),s.uvs1&&i.setUvs(1,s.uvs1),s.blendIndices&&i.setVertexStream(ct,s.blendIndices,4,s.blendIndices.length/4,zt),s.blendWeights&&i.setVertexStream(ht,s.blendWeights,4),s.indices&&i.setIndices(s.indices)),i.update(),i}function _i(t,e,s,i,n,r){const a=new R,o=new R,l=new R,h=new R,c=new R,d=new R,u=[],p=[],f=[],m=[],g=[];let _;if(s>0)for(let r=0;r<=i;r++)for(let _=0;_<=n;_++){const v=_/n*2*Math.PI-Math.PI,b=Math.sin(v),y=Math.cos(v);c.set(b*t,-s/2,y*t),h.set(b*e,s/2,y*e),a.lerp(c,h,r/i),o.sub2(h,c).normalize(),d.set(y,0,-b),l.cross(d,o).normalize(),u.push(a.x,a.y,a.z),p.push(l.x,l.y,l.z);let x=_/n,w=r/i;f.push(x,1-w);const S=w;if(w=x,x=S,x=x*pi+ui,w=w*pi+ui,x/=3,m.push(x,1-w),r<i&&_<n){const t=r*(n+1)+_,e=r*(n+1)+(_+1),s=(r+1)*(n+1)+_,i=(r+1)*(n+1)+(_+1);g.push(t,e,s),g.push(e,i,s)}}if(r){const t=Math.floor(n/2),r=n,a=s/2;for(let s=0;s<=t;s++){const i=s*Math.PI*.5/t,n=Math.sin(i),o=Math.cos(i);for(let i=0;i<=r;i++){const l=2*i*Math.PI/r-Math.PI/2,h=Math.sin(l),c=Math.cos(l)*n,d=o,g=h*n;let _=1-i/r,v=1-s/t;u.push(c*e,d*e+a,g*e),p.push(c,d,g),f.push(_,1-v),_=_*pi+ui,v=v*pi+ui,_/=3,v/=3,_+=1/3,m.push(_,1-v)}}_=(i+1)*(n+1);for(let e=0;e<t;++e)for(let t=0;t<r;++t){const s=e*(r+1)+t,i=s+r+1;g.push(_+s+1,_+i,_+s),g.push(_+s+1,_+i+1,_+i)}for(let s=0;s<=t;s++){const i=.5*Math.PI+s*Math.PI*.5/t,n=Math.sin(i),o=Math.cos(i);for(let i=0;i<=r;i++){const l=2*i*Math.PI/r-Math.PI/2,h=Math.sin(l),c=Math.cos(l)*n,d=o,g=h*n;let _=1-i/r,v=1-s/t;u.push(c*e,d*e-a,g*e),p.push(c,d,g),f.push(_,1-v),_=_*pi+ui,v=v*pi+ui,_/=3,v/=3,_+=2/3,m.push(_,1-v)}}_=(i+1)*(n+1)+(r+1)*(t+1);for(let e=0;e<t;++e)for(let t=0;t<r;++t){const s=e*(r+1)+t,i=s+r+1;g.push(_+s+1,_+i,_+s),g.push(_+s+1,_+i+1,_+i)}}else{if(_=(i+1)*(n+1),t>0)for(let e=0;e<n;e++){const i=e/n*2*Math.PI,r=Math.sin(i),a=-s/2,o=Math.cos(i);let l=1-(r+1)/2,h=(o+1)/2;u.push(r*t,a,o*t),p.push(0,-1,0),f.push(l,1-h),l=l*pi+ui,h=h*pi+ui,l/=3,h/=3,l+=1/3,m.push(l,1-h),e>1&&g.push(_,_+e,_+e-1)}if(_+=n,e>0)for(let t=0;t<n;t++){const i=t/n*2*Math.PI,r=Math.sin(i),a=s/2,o=Math.cos(i);let l=1-(r+1)/2,h=(o+1)/2;u.push(r*e,a,o*e),p.push(0,1,0),f.push(l,1-h),l=l*pi+ui,h=h*pi+ui,l/=3,h/=3,l+=2/3,m.push(l,1-h),t>1&&g.push(_,_+t-1,_+t)}}return{positions:u,normals:p,uvs:f,uvs1:m,indices:g}}function vi(t,e={}){var s,i,n,r,a;const o=null!=(s=e.halfExtents)?s:new R(.5,.5,.5),l=null!=(i=e.widthSegments)?i:1,h=null!=(n=e.lengthSegments)?n:1,c=null!=(r=e.heightSegments)?r:1,d=null!=(a=e.calculateTangents)&&a,u=[new R(-o.x,-o.y,o.z),new R(o.x,-o.y,o.z),new R(o.x,o.y,o.z),new R(-o.x,o.y,o.z),new R(o.x,-o.y,-o.z),new R(-o.x,-o.y,-o.z),new R(-o.x,o.y,-o.z),new R(o.x,o.y,-o.z)],p=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],f=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],m=1,g=2,_=3,v=4,b=5,y=[],x=[],w=[],S=[],C=[];let T=0;const E=(t,e,s)=>{const i=new R,n=new R,r=new R,a=new R;for(let o=0;o<=e;o++)for(let l=0;l<=s;l++){i.lerp(u[p[t][0]],u[p[t][1]],o/e),n.lerp(u[p[t][0]],u[p[t][2]],l/s),r.sub2(n,u[p[t][0]]),a.add2(i,r);let h=o/e,c=l/s;y.push(a.x,a.y,a.z),x.push(f[t][0],f[t][1],f[t][2]),w.push(h,1-c),h=h*pi+ui,c=c*pi+ui,h/=3,c/=3,h+=t%3/3,c+=Math.floor(t/3)/3,S.push(h,1-c),o<e&&l<s&&(C.push(T+s+1,T+1,T),C.push(T+s+1,T+s+2,T+1)),T++}};E(0,l,c),E(m,l,c),E(g,l,h),E(_,l,h),E(v,h,c),E(b,h,c);const P={normals:x,uvs:w,uvs1:S,indices:C};return d&&(P.tangents=mi(y,x,w,C)),gi(t,y,P)}function bi(t,e){let s=null;for(let i=0;i<fi.length;i++)fi[i].type===e&&fi[i].device===t&&(s=fi[i].primData);if(!s){let i,n;switch(e){case"box":i=vi(t),n={x:2,y:2,z:2,uv:2/3};break;case"capsule":i=function(t,e={}){var s,i,n,r,a;const o=null!=(s=e.radius)?s:.3,l=null!=(i=e.height)?i:1,h=null!=(n=e.heightSegments)?n:1,c=null!=(r=e.sides)?r:20,d=null!=(a=e.calculateTangents)&&a,u=_i(o,o,l-2*o,h,c,!0);return d&&(u.tangents=mi(u.positions,u.normals,u.uvs,u.indices)),gi(t,u.positions,u)}(t,{radius:.5,height:2}),n={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case"cone":i=function(t,e={}){var s,i,n,r,a,o;const l=null!=(s=e.baseRadius)?s:.5,h=null!=(i=e.peakRadius)?i:0,c=null!=(n=e.height)?n:1,d=null!=(r=e.heightSegments)?r:5,u=null!=(a=e.capSegments)?a:18,p=null!=(o=e.calculateTangents)&&o,f=_i(l,h,c,d,u,!1);return p&&(f.tangents=mi(f.positions,f.normals,f.uvs,f.indices)),gi(t,f.positions,f)}(t,{baseRadius:.5,peakRadius:0,height:1}),n={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case"cylinder":i=function(t,e={}){var s,i,n,r,a;const o=null!=(s=e.radius)?s:.5,l=null!=(i=e.height)?i:1,h=null!=(n=e.heightSegments)?n:5,c=null!=(r=e.capSegments)?r:20,d=null!=(a=e.calculateTangents)&&a,u=_i(o,o,l,h,c,!1);return d&&(u.tangents=mi(u.positions,u.normals,u.uvs,u.indices)),gi(t,u.positions,u)}(t,{radius:.5,height:1}),n={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case"plane":i=function(t,e={}){var s,i,n,r;const a=null!=(s=e.halfExtents)?s:new I(.5,.5),o=null!=(i=e.widthSegments)?i:5,l=null!=(n=e.lengthSegments)?n:5,h=null!=(r=e.calculateTangents)&&r,c=[],d=[],u=[],p=[];let f=0;for(let t=0;t<=o;t++)for(let e=0;e<=l;e++){const s=-a.x+2*a.x*t/o,i=0,n=-(-a.y+2*a.y*e/l),r=t/o,h=e/l;c.push(s,i,n),d.push(0,1,0),u.push(r,1-h),t<o&&e<l&&(p.push(f+l+1,f+1,f),p.push(f+l+1,f+l+2,f+1)),f++}const m={normals:d,uvs:u,uvs1:u,indices:p};return h&&(m.tangents=mi(c,d,u,p)),gi(t,c,m)}(t,{halfExtents:new I(.5,.5),widthSegments:1,lengthSegments:1}),n={x:0,y:1,z:0,uv:1};break;case"sphere":i=function(t,e={}){var s,i,n,r;const a=null!=(s=e.radius)?s:.5,o=null!=(i=e.latitudeBands)?i:16,l=null!=(n=e.longitudeBands)?n:16,h=null!=(r=e.calculateTangents)&&r,c=[],d=[],u=[],p=[];for(let t=0;t<=o;t++){const e=t*Math.PI/o,s=Math.sin(e),i=Math.cos(e);for(let e=0;e<=l;e++){const n=2*e*Math.PI/l-Math.PI/2,r=Math.sin(n),h=Math.cos(n)*s,p=i,f=r*s,m=1-e/l,g=1-t/o;c.push(h*a,p*a,f*a),d.push(h,p,f),u.push(m,1-g)}}for(let t=0;t<o;++t)for(let e=0;e<l;++e){const s=t*(l+1)+e,i=s+l+1;p.push(s+1,i,s),p.push(s+1,i+1,i)}const f={normals:d,uvs:u,uvs1:u,indices:p};return h&&(f.tangents=mi(c,d,u,p)),gi(t,c,f)}(t,{radius:.5}),n={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;case"torus":i=function(t,e={}){var s,i,n,r,a;const o=null!=(s=e.tubeRadius)?s:.2,l=null!=(i=e.ringRadius)?i:.3,h=null!=(n=e.segments)?n:30,c=null!=(r=e.sides)?r:20,d=null!=(a=e.calculateTangents)&&a,u=[],p=[],f=[],m=[];for(let t=0;t<=c;t++)for(let e=0;e<=h;e++){const s=Math.cos(2*Math.PI*e/h)*(l+o*Math.cos(2*Math.PI*t/c)),i=Math.sin(2*Math.PI*t/c)*o,n=Math.sin(2*Math.PI*e/h)*(l+o*Math.cos(2*Math.PI*t/c)),r=Math.cos(2*Math.PI*e/h)*Math.cos(2*Math.PI*t/c),a=Math.sin(2*Math.PI*t/c),d=Math.sin(2*Math.PI*e/h)*Math.cos(2*Math.PI*t/c),g=t/c,_=1-e/h;if(u.push(s,i,n),p.push(r,a,d),f.push(g,1-_),t<c&&e<h){const s=t*(h+1)+e,i=(t+1)*(h+1)+e,n=t*(h+1)+(e+1),r=(t+1)*(h+1)+(e+1);m.push(s,i,n),m.push(i,r,n)}}const g={normals:p,uvs:f,uvs1:f,indices:m};return d&&(g.tangents=mi(u,p,f,m)),gi(t,u,g)}(t,{tubeRadius:.2,ringRadius:.3}),n={x:.5*Math.PI*.5-.1*Math.PI*.1,y:.4,z:.4,uv:1};break;default:throw new Error("Invalid primitive type: "+e)}i.incRefCount(),s={mesh:i,area:n},fi.push({type:e,device:t,primData:s})}return s}class yi{constructor(){this.clearValue=new D(0,0,0,1),this.clear=!1,this.store=!1,this.resolve=!0,this.mipmaps=!1}}class xi{constructor(){this.clearDepthValue=1,this.clearStencilValue=0,this.clearDepth=!1,this.clearStencil=!1,this.storeDepth=!1,this.storeStencil=!1}}class wi{get colorOps(){return this.colorArrayOps[0]}constructor(t,e){this.name=void 0,this.renderTarget=void 0,this.samples=0,this.colorArrayOps=[],this.depthStencilOps=void 0,this.requiresCubemaps=!0,this.fullSizeClearRect=!0,this.execute=void 0,this.before=void 0,this.after=void 0,this.device=t,this.execute=e}init(t){var e;this.renderTarget=t||null,this.samples=Math.max(this.renderTarget?this.renderTarget.samples:this.device.samples,1),this.depthStencilOps=new xi;const s=t?null==(e=t._colorBuffers)?void 0:e.length:1;for(let t=0;t<s;t++){var i,n;const e=new yi;this.colorArrayOps[t]=e,1===this.samples&&(e.store=!0,e.resolve=!1),null!=(i=this.renderTarget)&&null!=(n=i._colorBuffers)&&n[t].mipmaps&&(e.mipmaps=!0)}}setClearColor(t){const e=this.colorArrayOps.length;for(let s=0;s<e;s++){const e=this.colorArrayOps[s];e.clearValue.copy(t),e.clear=!0}}setClearDepth(t){this.depthStencilOps.clearDepthValue=t,this.depthStencilOps.clearDepth=!0}setClearStencil(t){this.depthStencilOps.clearStencilValue=t,this.depthStencilOps.clearStencil=!0}render(){var t,e,s;const i=this.device,n=void 0!==this.renderTarget;null==(t=this.before)||t.call(this),n&&i.startPass(this),null==(e=this.execute)||e.call(this),n&&i.endPass(this),null==(s=this.after)||s.call(this),i.renderPassIndex++}}class Si{constructor(t,e,s){this.uniformFormats=[],this.bindGroupFormats=[],this.vertexFormat=void 0,this.uniformFormats[1]=t,this.bindGroupFormats[1]=e,this.vertexFormat=s}hasUniform(t){for(let e=0;e<this.uniformFormats.length;e++){const s=this.uniformFormats[e];if(null!=s&&s.get(t))return!0}return!1}hasTexture(t){for(let e=0;e<this.bindGroupFormats.length;e++){const s=this.bindGroupFormats[e];if(null!=s&&s.getTexture(t))return!0}return!1}getVertexElement(t){var e;return null==(e=this.vertexFormat)?void 0:e.elements.find((e=>e.name===t))}generateKey(){var t;return JSON.stringify(this.uniformFormats)+JSON.stringify(this.bindGroupFormats)+(null==(t=this.vertexFormat)?void 0:t.renderingHashString)}}var Ci="\nvec3 decodeLinear(vec4 raw) {\n\t\treturn raw.rgb;\n}\n\nfloat decodeGamma(float raw) {\n\t\treturn pow(raw, 2.2);\n}\n\nvec3 decodeGamma(vec3 raw) {\n\t\treturn pow(raw, vec3(2.2));\n}\n\nvec3 decodeGamma(vec4 raw) {\n\t\treturn pow(raw.xyz, vec3(2.2));\n}\n\nvec3 decodeRGBM(vec4 raw) {\n\t\tvec3 color = (8.0 * raw.a) * raw.rgb;\n\t\treturn color * color;\n}\n\nvec3 decodeRGBP(vec4 raw) {\n\t\tvec3 color = raw.rgb * (-raw.a * 7.0 + 8.0);\n\t\treturn color * color;\n}\n\nvec3 decodeRGBE(vec4 raw) {\n\t\tif (raw.a == 0.0) {\n\t\t\t\treturn vec3(0.0, 0.0, 0.0);\n\t\t} else {\n\t\t\t\treturn raw.xyz * pow(2.0, raw.w * 255.0 - 128.0);\n\t\t}\n}\n\nvec4 passThrough(vec4 raw) {\n\t\treturn raw;\n}\n",Ti="\nvec4 encodeLinear(vec3 source) {\n\t\treturn vec4(source, 1.0);\n}\n\nvec4 encodeGamma(vec3 source) {\n\t\treturn vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);\n}\n\nvec4 encodeRGBM(vec3 source) { // modified RGBM\n\t\tvec4 result;\n\t\tresult.rgb = pow(source.rgb, vec3(0.5));\n\t\tresult.rgb *= 1.0 / 8.0;\n\n\t\tresult.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );\n\t\tresult.a = ceil(result.a * 255.0) / 255.0;\n\n\t\tresult.rgb /= result.a;\n\t\treturn result;\n}\n\nvec4 encodeRGBP(vec3 source) {\n\t\t// convert incoming linear to gamma(ish)\n\t\tvec3 gamma = pow(source, vec3(0.5));\n\n\t\t// calculate the maximum component clamped to 1..8\n\t\tfloat maxVal = min(8.0, max(1.0, max(gamma.x, max(gamma.y, gamma.z))));\n\n\t\t// calculate storage factor\n\t\tfloat v = 1.0 - ((maxVal - 1.0) / 7.0);\n\n\t\t// round the value for storage in 8bit channel\n\t\tv = ceil(v * 255.0) / 255.0;\n\n\t\treturn vec4(gamma / (-v * 7.0 + 8.0), v);    \n}\n\nvec4 encodeRGBE(vec3 source) {\n\t\tfloat maxVal = max(source.x, max(source.y, source.z));\n\t\tif (maxVal < 1e-32) {\n\t\t\t\treturn vec4(0, 0, 0, 0);\n\t\t} else {\n\t\t\t\tfloat e = ceil(log2(maxVal));\n\t\t\t\treturn vec4(source / pow(2.0, e), (e + 128.0) / 255.0);\n\t\t}\n}\n";const Ei={alphaTestPS:"\nuniform float alpha_ref;\n\nvoid alphaTest(float a) {\n\t\tif (a < alpha_ref) discard;\n}\n",ambientConstantPS:"\nvoid addAmbient(vec3 worldNormal) {\n\t\tdDiffuseLight += light_globalAmbient;\n}\n",ambientEnvPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\nuniform sampler2D texture_envAtlas;\n#endif\n\nvoid addAmbient(vec3 worldNormal) {\n\t\tvec3 dir = normalize(cubeMapRotate(worldNormal) * vec3(-1.0, 1.0, 1.0));\n\t\tvec2 uv = mapUv(toSphericalUv(dir), vec4(128.0, 256.0 + 128.0, 64.0, 32.0) / atlasSize);\n\n\t\tvec4 raw = texture2D(texture_envAtlas, uv);\n\t\tvec3 linear = $DECODE(raw);\n\t\tdDiffuseLight += processEnvironment(linear);\n}\n",ambientSHPS:"\nuniform vec3 ambientSH[9];\n\nvoid addAmbient(vec3 worldNormal) {\n\t\tvec3 n = cubeMapRotate(worldNormal);\n\n\t\tvec3 color =\n\t\t\t\tambientSH[0] +\n\t\t\t\tambientSH[1] * n.x +\n\t\t\t\tambientSH[2] * n.y +\n\t\t\t\tambientSH[3] * n.z +\n\t\t\t\tambientSH[4] * n.x * n.z +\n\t\t\t\tambientSH[5] * n.z * n.y +\n\t\t\t\tambientSH[6] * n.y * n.x +\n\t\t\t\tambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n\t\t\t\tambientSH[8] * (n.x * n.x - n.y * n.y);\n\n\t\tdDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n}\n",aoPS:"\n\nvoid getAO() {\n\t\tdAo = 1.0;\n\n\t\t#ifdef MAPTEXTURE\n\t\tfloat aoBase = texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t\tdAo *= addAoDetail(aoBase);\n\t\t#endif\n\n\t\t#ifdef MAPVERTEX\n\t\tdAo *= saturate(vVertexColor.$VC);\n\t\t#endif\n}\n",aoDetailMapPS:"\nfloat addAoDetail(float ao) {\n#ifdef MAPTEXTURE\n\t\tfloat aoDetail = texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t\treturn detailMode_$DETAILMODE(vec3(ao), vec3(aoDetail)).r;\n#else\n\t\treturn ao;\n#endif\n}\n",aoDiffuseOccPS:"\nvoid occludeDiffuse(float ao) {\n\t\tdDiffuseLight *= ao;\n}\n",aoSpecOccPS:"\nuniform float material_occludeSpecularIntensity;\n\nvoid occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {\n\t\t// approximated specular occlusion from AO\n\t\tfloat specPow = exp2(gloss * 11.0);\n\t\t// http://research.tri-ace.com/Data/cedec2011_RealtimePBR_Implementation_e.pptx\n\t\tfloat specOcc = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01*specPow) - 1.0 + ao);\n\t\tspecOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n\n\t\tdSpecularLight *= specOcc;\n\t\tdReflection *= specOcc;\n\t\t\n#ifdef LIT_SHEEN\n\t\tsSpecularLight *= specOcc;\n\t\tsReflection *= specOcc;\n#endif\n}\n",aoSpecOccConstPS:"\nvoid occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {\n\t\t// approximated specular occlusion from AO\n\t\tfloat specPow = exp2(gloss * 11.0);\n\t\t// http://research.tri-ace.com/Data/cedec2011_RealtimePBR_Implementation_e.pptx\n\t\tfloat specOcc = saturate(pow(dot(worldNormal, viewDir) + ao, 0.01*specPow) - 1.0 + ao);\n\n\t\tdSpecularLight *= specOcc;\n\t\tdReflection *= specOcc;\n\t\t\n#ifdef LIT_SHEEN\n\t\tsSpecularLight *= specOcc;\n\t\tsReflection *= specOcc;\n#endif\n}\n",aoSpecOccConstSimplePS:"\nvoid occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {\n\t\tdSpecularLight *= ao;\n\t\tdReflection *= ao;\n\n#ifdef LIT_SHEEN\n\t\tsSpecularLight *= ao;\n\t\tsReflection *= ao;\n#endif\n}\n",aoSpecOccSimplePS:"\nuniform float material_occludeSpecularIntensity;\n\nvoid occludeSpecular(float gloss, float ao, vec3 worldNormal, vec3 viewDir) {\n\t\tfloat specOcc = mix(1.0, ao, material_occludeSpecularIntensity);\n\t\tdSpecularLight *= specOcc;\n\t\tdReflection *= specOcc;\n\n#ifdef LIT_SHEEN\n\t\tsSpecularLight *= specOcc;\n\t\tsReflection *= specOcc;\n#endif\n}\n",basePS:"\nuniform vec3 view_position;\n\nuniform vec3 light_globalAmbient;\n\nfloat square(float x) {\n\t\treturn x*x;\n}\n\nfloat saturate(float x) {\n\t\treturn clamp(x, 0.0, 1.0);\n}\n\nvec3 saturate(vec3 x) {\n\t\treturn clamp(x, vec3(0.0), vec3(1.0));\n}\n",baseVS:"\nattribute vec3 vertex_position;\nattribute vec3 vertex_normal;\nattribute vec4 vertex_tangent;\nattribute vec2 vertex_texCoord0;\nattribute vec2 vertex_texCoord1;\nattribute vec4 vertex_color;\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\n\nvec3 dPositionW;\nmat4 dModelMatrix;\nmat3 dNormalMatrix;\n",baseNineSlicedPS:"\n#define NINESLICED\n\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\n\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n\nvec2 nineSlicedUv;\n",baseNineSlicedVS:"\n#define NINESLICED\n\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\n\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n",baseNineSlicedTiledPS:"\n#define NINESLICED\n#define NINESLICETILED\n\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\n\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n\nvec2 nineSlicedUv;\n",biasConstPS:"\n#define SHADOWBIAS\n#define SHADOW_SAMPLE_Z_BIAS\n\nfloat getShadowBias(float resolution, float maxBias) {\n\t\treturn maxBias;\n}\n",blurVSMPS:"\nvarying vec2 vUv0;\n\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n\n#ifdef GAUSS\nuniform float weight[SAMPLES];\n#endif\n\n#ifdef PACKED\nfloat decodeFloatRG(vec2 rg) {\n\t\treturn rg.y*(1.0/255.0) + rg.x;\n}\n\nvec2 encodeFloatRG( float v ) {\n\t\tvec2 enc = vec2(1.0, 255.0) * v;\n\t\tenc = fract(enc);\n\t\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\t\treturn enc;\n}\n#endif\n\nvoid main(void) {\n\t\tvec3 moments = vec3(0.0);\n\t\tvec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);\n\t\tfor (int i=0; i<SAMPLES; i++) {\n\t\t\t\tvec4 c = texture2D(source, uv + pixelOffset * float(i));\n\n\t\t\t\t#ifdef PACKED\n\t\t\t\tc.xy = vec2(decodeFloatRG(c.xy), decodeFloatRG(c.zw));\n\t\t\t\t#endif\n\n\t\t\t\t#ifdef GAUSS\n\t\t\t\tmoments += c.xyz * weight[i];\n\t\t\t\t#else\n\t\t\t\tmoments += c.xyz;\n\t\t\t\t#endif\n\t\t}\n\n\t\t#ifndef GAUSS\n\t\tmoments /= float(SAMPLES);\n\t\t#endif\n\n\t\t#ifdef PACKED\n\t\tgl_FragColor = vec4(encodeFloatRG(moments.x), encodeFloatRG(moments.y));\n\t\t#else\n\t\tgl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n\t\t#endif\n}\n",clearCoatPS:"\n#ifdef MAPFLOAT\nuniform float material_clearCoat;\n#endif\n\nvoid getClearCoat() {\n\t\tccSpecularity = 1.0;\n\n\t\t#ifdef MAPFLOAT\n\t\tccSpecularity *= material_clearCoat;\n\t\t#endif\n\n\t\t#ifdef MAPTEXTURE\n\t\tccSpecularity *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t\t#endif\n\n\t\t#ifdef MAPVERTEX\n\t\tccSpecularity *= saturate(vVertexColor.$VC);\n\t\t#endif\n}\n",clearCoatGlossPS:"\n#ifdef MAPFLOAT\nuniform float material_clearCoatGloss;\n#endif\n\nvoid getClearCoatGlossiness() {\n\t\tccGlossiness = 1.0;\n\n\t\t#ifdef MAPFLOAT\n\t\tccGlossiness *= material_clearCoatGloss;\n\t\t#endif\n\n\t\t#ifdef MAPTEXTURE\n\t\tccGlossiness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t\t#endif\n\n\t\t#ifdef MAPVERTEX\n\t\tccGlossiness *= saturate(vVertexColor.$VC);\n\t\t#endif\n\n\t\t#ifdef MAPINVERT\n\t\tccGlossiness = 1.0 - ccGlossiness;\n\t\t#endif\n\n\t\tccGlossiness += 0.0000001;\n}\n",clearCoatNormalPS:"\n#ifdef MAPTEXTURE\nuniform float material_clearCoatBumpiness;\n#endif\n\nvoid getClearCoatNormal() {\n#ifdef MAPTEXTURE\n\t\tvec3 normalMap = unpackNormal(texture2DBias($SAMPLER, $UV, textureBias));\n\t\tnormalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness);\n\t\tccNormalW = normalize(dTBN * normalMap);\n#else\n\t\tccNormalW = dVertexNormalW;\n#endif\n}\n",clusteredLightCookiesPS:"\nvec3 _getCookieClustered(TEXTURE_ACCEPT(tex), vec2 uv, float intensity, bool isRgb, vec4 cookieChannel) {\n\t\tvec4 pixel = mix(vec4(1.0), texture2DLodEXT(tex, uv, 0.0), intensity);\n\t\treturn isRgb == true ? pixel.rgb : vec3(dot(pixel, cookieChannel));\n}\n\n// getCookie2D for clustered lighting including channel selector\nvec3 getCookie2DClustered(TEXTURE_ACCEPT(tex), mat4 transform, vec3 worldPosition, float intensity, bool isRgb, vec4 cookieChannel) {\n\t\tvec4 projPos = transform * vec4(worldPosition, 1.0);\n\t\treturn _getCookieClustered(TEXTURE_PASS(tex), projPos.xy / projPos.w, intensity, isRgb, cookieChannel);\n}\n\n// getCookie for clustered omni light with the cookie texture being stored in the cookie atlas\nvec3 getCookieCubeClustered(TEXTURE_ACCEPT(tex), vec3 dir, float intensity, bool isRgb, vec4 cookieChannel, float shadowTextureResolution, float shadowEdgePixels, vec3 omniAtlasViewport) {\n\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, dir);\n\t\treturn _getCookieClustered(TEXTURE_PASS(tex), uv, intensity, isRgb, cookieChannel);\n}\n",clusteredLightShadowsPS:"\n// Clustered Omni Sampling using atlas\n\n\nvoid _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\t\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\t\tprojPos.xyz /= projPos.w;\n\t\tdShadowCoord = projPos.xyz;\n\t\t// depth bias is already applied on render\n}\n\nvoid getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams, vec3 normal) {\n\t\tvec3 wPos = vPositionW + normal * shadowParams.y;\n\t\t_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\n\nvec3 normalOffsetPointShadow(vec4 shadowParams, vec3 lightPos, inout vec3 lightDir, vec3 lightDirNorm, vec3 normal) {\n\t\tfloat distScale = length(lightDir);\n\t\tvec3 wPos = vPositionW + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale; //0.02\n\t\tvec3 dir = wPos - lightPos;\n\t\treturn dir;\n}\n\n#ifdef GL2\n\n\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\n\t\tfloat getShadowOmniClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\n\t\t\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\t\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\n\t\t\t\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\t\t\t\treturn textureShadow(shadowMap, vec3(uv, shadowZ));\n\t\t}\n\n\t\t#endif\n\n\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF3)\n\n\t\tfloat getShadowOmniClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\n\t\t\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\t\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\n\t\t\t\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\t\t\t\tvec3 shadowCoord = vec3(uv, shadowZ);\n\t\t\t\treturn getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n\t\t}\n\n\t\t#endif\n\n\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\n\t\tfloat getShadowOmniClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\n\t\t\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\t\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\n\t\t\t\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\t\t\t\tvec3 shadowCoord = vec3(uv, shadowZ);\n\t\t\t\treturn getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n\t\t}\n\n\t\t#endif\n\n#else\n\n\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\n\t\tfloat getShadowOmniClusteredPCF1(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\n\t\t\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\t\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\n\t\t\t\t// no filter shadow sampling\n\t\t\t\tfloat depth = unpackFloat(textureShadow(shadowMap, uv));\n\t\t\t\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\t\t\t\treturn depth > shadowZ ? 1.0 : 0.0;\n\t\t}\n\n\t\t#endif\n\n\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF3)\n\n\t\tfloat getShadowOmniClusteredPCF3(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\n\t\t\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\t\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\n\t\t\t\t// pcf3\n\t\t\t\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\t\t\t\tvec3 shadowCoord = vec3(uv, shadowZ);\n\t\t\t\treturn getShadowPCF3x3(shadowMap, shadowCoord, shadowParams);\n\t\t}\n\n\t\t#endif\n\n\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\n\t\t// we don't have PCF5 implementation for webgl1, use PCF3\n\t\tfloat getShadowOmniClusteredPCF5(sampler2D shadowMap, vec4 shadowParams, vec3 omniAtlasViewport, float shadowEdgePixels, vec3 lightDir) {\n\n\t\t\t\tfloat shadowTextureResolution = shadowParams.x;\n\t\t\t\tvec2 uv = getCubemapAtlasCoordinates(omniAtlasViewport, shadowEdgePixels, shadowTextureResolution, lightDir);\n\n\t\t\t\t// pcf3\n\t\t\t\tfloat shadowZ = length(lightDir) * shadowParams.w + shadowParams.z;\n\t\t\t\tvec3 shadowCoord = vec3(uv, shadowZ);\n\t\t\t\treturn getShadowPCF3x3(shadowMap, shadowCoord, shadowParams);\n\t\t}\n\n\t\t#endif\n\n#endif\n\n\n// Clustered Spot Sampling using atlas\n\n#ifdef GL2\n\n\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\n\t\tfloat getShadowSpotClusteredPCF1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\t\t\t\treturn textureShadow(shadowMap, shadowCoord);\n\t\t}\n\n\t\t#endif\n\n\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF3)\n\n\t\tfloat getShadowSpotClusteredPCF3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\t\t\t\treturn getShadowSpotPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n\t\t}\n\n\t\t#endif\n\n\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\n\t\tfloat getShadowSpotClusteredPCF5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\t\t\t\treturn getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams);\n\t\t}\n\t\t#endif\n\n#else\n\n\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\n\t\tfloat getShadowSpotClusteredPCF1(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {\n\n\t\t\t\tfloat depth = unpackFloat(textureShadow(shadowMap, shadowCoord.xy));\n\n\t\t\t\treturn depth > shadowCoord.z ? 1.0 : 0.0;\n\n\t\t}\n\n\t\t#endif\n\n\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF3)\n\n\t\tfloat getShadowSpotClusteredPCF3(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {\n\t\t\t\treturn getShadowSpotPCF3x3(shadowMap, shadowCoord, shadowParams);\n\t\t}\n\n\t\t#endif\n\n\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF5)\n\n\t\t// we don't have PCF5 implementation for webgl1, use PCF3\n\t\tfloat getShadowSpotClusteredPCF5(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {\n\t\t\t\treturn getShadowSpotPCF3x3(shadowMap, shadowCoord, shadowParams);\n\t\t}\n\n\t\t#endif\n\n#endif\n",clusteredLightUtilsPS:"\n// Converts unnormalized direction vector to a cubemap face index [0..5] and uv coordinates within the face in [0..1] range.\n// Additionally offset to a tile in atlas within 3x3 subdivision is provided\nvec2 getCubemapFaceCoordinates(const vec3 dir, out float faceIndex, out vec2 tileOffset)\n{\n\t\tvec3 vAbs = abs(dir);\n\t\tfloat ma;\n\t\tvec2 uv;\n\t\tif (vAbs.z >= vAbs.x && vAbs.z >= vAbs.y) {   // front / back\n\n\t\t\t\tfaceIndex = dir.z < 0.0 ? 5.0 : 4.0;\n\t\t\t\tma = 0.5 / vAbs.z;\n\t\t\t\tuv = vec2(dir.z < 0.0 ? -dir.x : dir.x, -dir.y);\n\n\t\t\t\ttileOffset.x = 2.0;\n\t\t\t\ttileOffset.y = dir.z < 0.0 ? 1.0 : 0.0;\n\n\t\t} else if(vAbs.y >= vAbs.x) {  // top index 2, bottom index 3\n\n\t\t\t\tfaceIndex = dir.y < 0.0 ? 3.0 : 2.0;\n\t\t\t\tma = 0.5 / vAbs.y;\n\t\t\t\tuv = vec2(dir.x, dir.y < 0.0 ? -dir.z : dir.z);\n\n\t\t\t\ttileOffset.x = 1.0;\n\t\t\t\ttileOffset.y = dir.y < 0.0 ? 1.0 : 0.0;\n\n\t\t} else {    // left / right\n\n\t\t\t\tfaceIndex = dir.x < 0.0 ? 1.0 : 0.0;\n\t\t\t\tma = 0.5 / vAbs.x;\n\t\t\t\tuv = vec2(dir.x < 0.0 ? dir.z : -dir.z, -dir.y);\n\n\t\t\t\ttileOffset.x = 0.0;\n\t\t\t\ttileOffset.y = dir.x < 0.0 ? 1.0 : 0.0;\n\n\t\t}\n\t\treturn uv * ma + 0.5;\n}\n\n// converts unnormalized direction vector to a texture coordinate for a cubemap face stored within texture atlas described by the viewport\nvec2 getCubemapAtlasCoordinates(const vec3 omniAtlasViewport, float shadowEdgePixels, float shadowTextureResolution, const vec3 dir) {\n\n\t\tfloat faceIndex;\n\t\tvec2 tileOffset;\n\t\tvec2 uv = getCubemapFaceCoordinates(dir, faceIndex, tileOffset);\n\n\t\t// move uv coordinates inwards inside to compensate for larger fov when rendering shadow into atlas\n\t\tfloat atlasFaceSize = omniAtlasViewport.z;\n\t\tfloat tileSize = shadowTextureResolution * atlasFaceSize;\n\t\tfloat offset = shadowEdgePixels / tileSize;\n\t\tuv = uv * vec2(1.0 - offset * 2.0) + vec2(offset * 1.0);\n\n\t\t// scale uv coordinates to cube face area within the viewport\n\t\tuv *= atlasFaceSize;\n\n\t\t// offset into face of the atlas (3x3 grid)\n\t\tuv += tileOffset * atlasFaceSize;\n\n\t\t// offset into the atlas viewport\n\t\tuv += omniAtlasViewport.xy;\n\n\t\treturn uv;\n}\n",clusteredLightPS:"\nuniform highp sampler2D clusterWorldTexture;\nuniform highp sampler2D lightsTexture8;\nuniform highp sampler2D lightsTextureFloat;\n\n// complex ifdef expression are not supported, handle it here\n// defined(CLUSTER_COOKIES) || defined(CLUSTER_SHADOWS)\n#if defined(CLUSTER_COOKIES)\n\t\t#define CLUSTER_COOKIES_OR_SHADOWS\n#endif\n#if defined(CLUSTER_SHADOWS)\n\t\t#define CLUSTER_COOKIES_OR_SHADOWS\n#endif\n\n#ifdef CLUSTER_SHADOWS\n\t\t#ifdef GL2\n\t\t\t\t// TODO: when VSM shadow is supported, it needs to use sampler2D in webgl2\n\t\t\t\tuniform sampler2DShadow shadowAtlasTexture;\n\t\t#else\n\t\t\t\tuniform sampler2D shadowAtlasTexture;\n\t\t#endif\n#endif\n\n#ifdef CLUSTER_COOKIES\n\t\tuniform sampler2D cookieAtlasTexture;\n#endif\n\n#ifdef GL2\n\t\tuniform int clusterMaxCells;\n#else\n\t\tuniform float clusterMaxCells;\n\t\tuniform vec4 lightsTextureInvSize;\n#endif\n\n// 1.0 if clustered lighting can be skipped (0 lights in the clusters)\nuniform float clusterSkip;\n\nuniform vec3 clusterCellsCountByBoundsSize;\nuniform vec3 clusterTextureSize;\nuniform vec3 clusterBoundsMin;\nuniform vec3 clusterBoundsDelta;\nuniform vec3 clusterCellsDot;\nuniform vec3 clusterCellsMax;\nuniform vec2 clusterCompressionLimit0;\nuniform vec2 shadowAtlasParams;\n\n// structure storing light properties of a clustered light\n// it's sorted to have all vectors aligned to 4 floats to limit padding\nstruct ClusterLightData {\n\n\t\t// area light sizes / orientation\n\t\tvec3 halfWidth;\n\n\t\t// type of the light (spot or omni)\n\t\tfloat lightType;\n\n\t\t// area light sizes / orientation\n\t\tvec3 halfHeight;\n\n\t\t#ifdef GL2\n\t\t\t\t// light index\n\t\t\t\tint lightIndex;\n\t\t#else\n\t\t\t\t// v coordinate to look up the light textures - this is the same as lightIndex but in 0..1 range\n\t\t\t\tfloat lightV;\n\t\t#endif\n\n\t\t// world space position\n\t\tvec3 position;\n\n\t\t// area light shape\n\t\tfloat shape;\n\n\t\t// world space direction (spot light only)\n\t\tvec3 direction;\n\n\t\t// light follow mode\n\t\tfloat falloffMode;\n\n\t\t// color\n\t\tvec3 color;\n\n\t\t// 0.0 if the light doesn't cast shadows\n\t\tfloat shadowIntensity;\n\n\t\t// atlas viewport for omni light shadow and cookie (.xy is offset to the viewport slot, .z is size of the face in the atlas)\n\t\tvec3 omniAtlasViewport;\n\n\t\t// range of the light\n\t\tfloat range;\n\n\t\t// channel mask - one of the channels has 1, the others are 0\n\t\tvec4 cookieChannelMask;\n\n\t\t// shadow bias values\n\t\tfloat shadowBias;\n\t\tfloat shadowNormalBias;\n\n\t\t// spot light inner and outer angle cosine\n\t\tfloat innerConeAngleCos;\n\t\tfloat outerConeAngleCos;\n\n\t\t// 1.0 if the light has a cookie texture\n\t\tfloat cookie;\n\n\t\t// 1.0 if cookie texture is rgb, otherwise it is using a single channel selectable by cookieChannelMask\n\t\tfloat cookieRgb;\n\n\t\t// intensity of the cookie\n\t\tfloat cookieIntensity;\n\n\t\t// light mask\n\t\tfloat mask;\n};\n\n// Note: on some devices (tested on Pixel 3A XL), this matrix when stored inside the light struct has lower precision compared to\n// when stored outside, so we store it outside to avoid spot shadow flickering. This might need to be done to other / all members\n// of the structure if further similar issues are observed.\n\n// shadow (spot light only) / cookie projection matrix\nmat4 lightProjectionMatrix;\n\n// macros for light properties\n#define isClusteredLightCastShadow(light) ( light.shadowIntensity > 0.0 )\n#define isClusteredLightCookie(light) (light.cookie > 0.5 )\n#define isClusteredLightCookieRgb(light) (light.cookieRgb > 0.5 )\n#define isClusteredLightSpot(light) ( light.lightType > 0.5 )\n#define isClusteredLightFalloffLinear(light) ( light.falloffMode < 0.5 )\n\n// macros to test light shape\n// Note: Following functions need to be called serially in listed order as they do not test both '>' and '<'\n#define isClusteredLightArea(light) ( light.shape > 0.1 )\n#define isClusteredLightRect(light) ( light.shape < 0.3 )\n#define isClusteredLightDisk(light) ( light.shape < 0.6 )\n\n// macro to test light mask (mesh accepts dynamic vs lightmapped lights)\n#ifdef CLUSTER_MESH_DYNAMIC_LIGHTS\n\t\t// accept lights marked as dynamic or both dynamic and lightmapped\n\t\t#define acceptLightMask(light) ( light.mask < 0.75)\n#else\n\t\t// accept lights marked as lightmapped or both dynamic and lightmapped\n\t\t#define acceptLightMask(light) ( light.mask > 0.25)\n#endif\n\nvec4 decodeClusterLowRange4Vec4(vec4 d0, vec4 d1, vec4 d2, vec4 d3) {\n\t\treturn vec4(\n\t\t\t\tbytes2floatRange4(d0, -2.0, 2.0),\n\t\t\t\tbytes2floatRange4(d1, -2.0, 2.0),\n\t\t\t\tbytes2floatRange4(d2, -2.0, 2.0),\n\t\t\t\tbytes2floatRange4(d3, -2.0, 2.0)\n\t\t);\n}\n\n#ifdef GL2\n\n\t\tvec4 sampleLightsTexture8(const ClusterLightData clusterLightData, int index) {\n\t\t\t\treturn texelFetch(lightsTexture8, ivec2(index, clusterLightData.lightIndex), 0);\n\t\t}\n\n\t\tvec4 sampleLightTextureF(const ClusterLightData clusterLightData, int index) {\n\t\t\t\treturn texelFetch(lightsTextureFloat, ivec2(index, clusterLightData.lightIndex), 0);\n\t\t}\n\n#else\n\n\t\tvec4 sampleLightsTexture8(const ClusterLightData clusterLightData, float index) {\n\t\t\t\treturn texture2DLodEXT(lightsTexture8, vec2(index * lightsTextureInvSize.z, clusterLightData.lightV), 0.0);\n\t\t}\n\n\t\tvec4 sampleLightTextureF(const ClusterLightData clusterLightData, float index) {\n\t\t\t\treturn texture2DLodEXT(lightsTextureFloat, vec2(index * lightsTextureInvSize.x, clusterLightData.lightV), 0.0);\n\t\t}\n\n#endif\n\nvoid decodeClusterLightCore(inout ClusterLightData clusterLightData, float lightIndex) {\n\n\t\t// light index\n\t\t#ifdef GL2\n\t\t\t\tclusterLightData.lightIndex = int(lightIndex);\n\t\t#else\n\t\t\t\tclusterLightData.lightV = (lightIndex + 0.5) * lightsTextureInvSize.w;\n\t\t#endif\n\n\t\t// shared data from 8bit texture\n\t\tvec4 lightInfo = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_FLAGS);\n\t\tclusterLightData.lightType = lightInfo.x;\n\t\tclusterLightData.shape = lightInfo.y;\n\t\tclusterLightData.falloffMode = lightInfo.z;\n\t\tclusterLightData.shadowIntensity = lightInfo.w;\n\n\t\t// color\n\t\tvec4 colorA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COLOR_A);\n\t\tvec4 colorB = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COLOR_B);\n\t\tclusterLightData.color = vec3(bytes2float2(colorA.xy), bytes2float2(colorA.zw), bytes2float2(colorB.xy)) * clusterCompressionLimit0.y;\n\n\t\t// cookie\n\t\tclusterLightData.cookie = colorB.z;\n\n\t\t// light mask\n\t\tclusterLightData.mask = colorB.w;\n\n\t\t#ifdef CLUSTER_TEXTURE_FLOAT\n\n\t\t\t\tvec4 lightPosRange = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_POSITION_RANGE);\n\t\t\t\tclusterLightData.position = lightPosRange.xyz;\n\t\t\t\tclusterLightData.range = lightPosRange.w;\n\n\t\t\t\t// spot light direction\n\t\t\t\tvec4 lightDir_Unused = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_SPOT_DIRECTION);\n\t\t\t\tclusterLightData.direction = lightDir_Unused.xyz;\n\n\t\t#else   // 8bit\n\n\t\t\t\tvec4 encPosX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_X);\n\t\t\t\tvec4 encPosY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_Y);\n\t\t\t\tvec4 encPosZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_POSITION_Z);\n\t\t\t\tclusterLightData.position = vec3(bytes2float4(encPosX), bytes2float4(encPosY), bytes2float4(encPosZ)) * clusterBoundsDelta + clusterBoundsMin;\n\n\t\t\t\tvec4 encRange = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_RANGE);\n\t\t\t\tclusterLightData.range = bytes2float4(encRange) * clusterCompressionLimit0.x;\n\n\t\t\t\t// spot light direction\n\t\t\t\tvec4 encDirX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_X);\n\t\t\t\tvec4 encDirY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_Y);\n\t\t\t\tvec4 encDirZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_DIRECTION_Z);\n\t\t\t\tclusterLightData.direction = vec3(bytes2float4(encDirX), bytes2float4(encDirY), bytes2float4(encDirZ)) * 2.0 - 1.0;\n\n\t\t#endif\n}\n\nvoid decodeClusterLightSpot(inout ClusterLightData clusterLightData) {\n\n\t\t// spot light cos angles\n\t\tvec4 coneAngle = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SPOT_ANGLES);\n\t\tclusterLightData.innerConeAngleCos = bytes2float2(coneAngle.xy) * 2.0 - 1.0;\n\t\tclusterLightData.outerConeAngleCos = bytes2float2(coneAngle.zw) * 2.0 - 1.0;\n}\n\nvoid decodeClusterLightOmniAtlasViewport(inout ClusterLightData clusterLightData) {\n\t\t#ifdef CLUSTER_TEXTURE_FLOAT\n\t\t\t\tclusterLightData.omniAtlasViewport = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_0).xyz;\n\t\t#else\n\t\t\t\tvec4 viewportA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_ATLAS_VIEWPORT_A);\n\t\t\t\tvec4 viewportB = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_ATLAS_VIEWPORT_B);\n\t\t\t\tclusterLightData.omniAtlasViewport = vec3(bytes2float2(viewportA.xy), bytes2float2(viewportA.zw), bytes2float2(viewportB.xy));\n\t\t#endif\n}\n\nvoid decodeClusterLightAreaData(inout ClusterLightData clusterLightData) {\n\t\t#ifdef CLUSTER_TEXTURE_FLOAT\n\t\t\t\tclusterLightData.halfWidth = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_AREA_DATA_WIDTH).xyz;\n\t\t\t\tclusterLightData.halfHeight = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_AREA_DATA_HEIGHT).xyz;\n\t\t#else\n\t\t\t\tvec4 areaWidthX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_X);\n\t\t\t\tvec4 areaWidthY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_Y);\n\t\t\t\tvec4 areaWidthZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_WIDTH_Z);\n\t\t\t\tclusterLightData.halfWidth = vec3(mantissaExponent2Float(areaWidthX), mantissaExponent2Float(areaWidthY), mantissaExponent2Float(areaWidthZ));\n\n\t\t\t\tvec4 areaHeightX = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_X);\n\t\t\t\tvec4 areaHeightY = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_Y);\n\t\t\t\tvec4 areaHeightZ = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_AREA_DATA_HEIGHT_Z);\n\t\t\t\tclusterLightData.halfHeight = vec3(mantissaExponent2Float(areaHeightX), mantissaExponent2Float(areaHeightY), mantissaExponent2Float(areaHeightZ));\n\t\t#endif\n}\n\nvoid decodeClusterLightProjectionMatrixData(inout ClusterLightData clusterLightData) {\n\t\t\n\t\t// shadow matrix\n\t\t#ifdef CLUSTER_TEXTURE_FLOAT\n\t\t\t\tvec4 m0 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_0);\n\t\t\t\tvec4 m1 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_1);\n\t\t\t\tvec4 m2 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_2);\n\t\t\t\tvec4 m3 = sampleLightTextureF(clusterLightData, CLUSTER_TEXTURE_F_PROJ_MAT_3);\n\t\t#else\n\t\t\t\tvec4 m00 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_00);\n\t\t\t\tvec4 m01 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_01);\n\t\t\t\tvec4 m02 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_02);\n\t\t\t\tvec4 m03 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_03);\n\t\t\t\tvec4 m0 = decodeClusterLowRange4Vec4(m00, m01, m02, m03);\n\n\t\t\t\tvec4 m10 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_10);\n\t\t\t\tvec4 m11 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_11);\n\t\t\t\tvec4 m12 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_12);\n\t\t\t\tvec4 m13 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_13);\n\t\t\t\tvec4 m1 = decodeClusterLowRange4Vec4(m10, m11, m12, m13);\n\n\t\t\t\tvec4 m20 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_20);\n\t\t\t\tvec4 m21 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_21);\n\t\t\t\tvec4 m22 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_22);\n\t\t\t\tvec4 m23 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_23);\n\t\t\t\tvec4 m2 = decodeClusterLowRange4Vec4(m20, m21, m22, m23);\n\n\t\t\t\tvec4 m30 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_30);\n\t\t\t\tvec4 m31 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_31);\n\t\t\t\tvec4 m32 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_32);\n\t\t\t\tvec4 m33 = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_PROJ_MAT_33);\n\t\t\t\tvec4 m3 = vec4(mantissaExponent2Float(m30), mantissaExponent2Float(m31), mantissaExponent2Float(m32), mantissaExponent2Float(m33));\n\t\t#endif\n\t\t\n\t\tlightProjectionMatrix = mat4(m0, m1, m2, m3);\n}\n\nvoid decodeClusterLightShadowData(inout ClusterLightData clusterLightData) {\n\t\t\n\t\t// shadow biases\n\t\tvec4 biases = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_SHADOW_BIAS);\n\t\tclusterLightData.shadowBias = bytes2floatRange2(biases.xy, -1.0, 20.0),\n\t\tclusterLightData.shadowNormalBias = bytes2float2(biases.zw);\n}\n\nvoid decodeClusterLightCookieData(inout ClusterLightData clusterLightData) {\n\n\t\tvec4 cookieA = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COOKIE_A);\n\t\tclusterLightData.cookieIntensity = cookieA.x;\n\t\tclusterLightData.cookieRgb = cookieA.y;\n\n\t\tclusterLightData.cookieChannelMask = sampleLightsTexture8(clusterLightData, CLUSTER_TEXTURE_8_COOKIE_B);\n}\n\nvoid evaluateLight(\n\t\tClusterLightData light, \n\t\tvec3 worldNormal, \n\t\tvec3 viewDir, \n\t\tvec3 reflectionDir,\n#if defined(LIT_CLEARCOAT)\n\t\tvec3 clearcoatReflectionDir,\n#endif\n\t\tfloat gloss, \n\t\tvec3 specularity, \n\t\tvec3 geometricNormal, \n\t\tmat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n\t\tvec3 iridescenceFresnel,\n#endif\n\t\tClearcoatArgs clearcoat, \n\t\tSheenArgs sheen, \n\t\tIridescenceArgs iridescence\n) {\n\n\t\tvec3 cookieAttenuation = vec3(1.0);\n\t\tfloat diffuseAttenuation = 1.0;\n\t\tfloat falloffAttenuation = 1.0;\n\n\t\t// evaluate omni part of the light\n\t\tgetLightDirPoint(light.position);\n\n\t\t#ifdef CLUSTER_AREALIGHTS\n\n\t\t// distance attenuation\n\t\tif (isClusteredLightArea(light)) { // area light\n\n\t\t\t\t// area lights\n\t\t\t\tdecodeClusterLightAreaData(light);\n\n\t\t\t\t// handle light shape\n\t\t\t\tif (isClusteredLightRect(light)) {\n\t\t\t\t\t\tcalcRectLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\t\t\t\tcalcDiskLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t\t\t} else { // sphere\n\t\t\t\t\t\tcalcSphereLightValues(light.position, light.halfWidth, light.halfHeight);\n\t\t\t\t}\n\n\t\t\t\tfalloffAttenuation = getFalloffWindow(light.range, dLightDirW);\n\n\t\t} else\n\n\t\t#endif\n\n\t\t{   // punctual light\n\n\t\t\t\tif (isClusteredLightFalloffLinear(light))\n\t\t\t\t\t\tfalloffAttenuation = getFalloffLinear(light.range, dLightDirW);\n\t\t\t\telse\n\t\t\t\t\t\tfalloffAttenuation = getFalloffInvSquared(light.range, dLightDirW);\n\t\t}\n\n\t\tif (falloffAttenuation > 0.00001) {\n\n\t\t\t\t#ifdef CLUSTER_AREALIGHTS\n\n\t\t\t\tif (isClusteredLightArea(light)) { // area light\n\n\t\t\t\t\t\t// handle light shape\n\t\t\t\t\t\tif (isClusteredLightRect(light)) {\n\t\t\t\t\t\t\t\tdiffuseAttenuation = getRectLightDiffuse(worldNormal, viewDir, dLightDirW, dLightDirNormW) * 16.0;\n\t\t\t\t\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\t\t\t\t\t\tdiffuseAttenuation = getDiskLightDiffuse(worldNormal, viewDir, dLightDirW, dLightDirNormW) * 16.0;\n\t\t\t\t\t\t} else { // sphere\n\t\t\t\t\t\t\t\tdiffuseAttenuation = getSphereLightDiffuse(worldNormal, viewDir, dLightDirW, dLightDirNormW) * 16.0;\n\t\t\t\t\t\t}\n\n\t\t\t\t} else\n\n\t\t\t\t#endif\n\n\t\t\t\t{\n\t\t\t\t\t\tfalloffAttenuation *= getLightDiffuse(worldNormal, viewDir, dLightDirW, dLightDirNormW); \n\t\t\t\t}\n\n\t\t\t\t// spot light falloff\n\t\t\t\tif (isClusteredLightSpot(light)) {\n\t\t\t\t\t\tdecodeClusterLightSpot(light);\n\t\t\t\t\t\tfalloffAttenuation *= getSpotEffect(light.direction, light.innerConeAngleCos, light.outerConeAngleCos, dLightDirNormW);\n\t\t\t\t}\n\n\t\t\t\t#if defined(CLUSTER_COOKIES_OR_SHADOWS)\n\n\t\t\t\tif (falloffAttenuation > 0.00001) {\n\n\t\t\t\t\t\t// shadow / cookie\n\t\t\t\t\t\tif (isClusteredLightCastShadow(light) || isClusteredLightCookie(light)) {\n\n\t\t\t\t\t\t\t\t// shared shadow / cookie data depends on light type\n\t\t\t\t\t\t\t\tif (isClusteredLightSpot(light)) {\n\t\t\t\t\t\t\t\t\t\tdecodeClusterLightProjectionMatrixData(light);\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\tdecodeClusterLightOmniAtlasViewport(light);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tfloat shadowTextureResolution = shadowAtlasParams.x;\n\t\t\t\t\t\t\t\tfloat shadowEdgePixels = shadowAtlasParams.y;\n\n\t\t\t\t\t\t\t\t#ifdef CLUSTER_COOKIES\n\n\t\t\t\t\t\t\t\t// cookie\n\t\t\t\t\t\t\t\tif (isClusteredLightCookie(light)) {\n\t\t\t\t\t\t\t\t\t\tdecodeClusterLightCookieData(light);\n\n\t\t\t\t\t\t\t\t\t\tif (isClusteredLightSpot(light)) {\n\t\t\t\t\t\t\t\t\t\t\t\tcookieAttenuation = getCookie2DClustered(TEXTURE_PASS(cookieAtlasTexture), lightProjectionMatrix, vPositionW, light.cookieIntensity, isClusteredLightCookieRgb(light), light.cookieChannelMask);\n\t\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\t\t\tcookieAttenuation = getCookieCubeClustered(TEXTURE_PASS(cookieAtlasTexture), dLightDirW, light.cookieIntensity, isClusteredLightCookieRgb(light), light.cookieChannelMask, shadowTextureResolution, shadowEdgePixels, light.omniAtlasViewport);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t#endif\n\n\t\t\t\t\t\t\t\t#ifdef CLUSTER_SHADOWS\n\n\t\t\t\t\t\t\t\t// shadow\n\t\t\t\t\t\t\t\tif (isClusteredLightCastShadow(light)) {\n\t\t\t\t\t\t\t\t\t\tdecodeClusterLightShadowData(light);\n\n\t\t\t\t\t\t\t\t\t\tvec4 shadowParams = vec4(shadowTextureResolution, light.shadowNormalBias, light.shadowBias, 1.0 / light.range);\n\n\t\t\t\t\t\t\t\t\t\tif (isClusteredLightSpot(light)) {\n\n\t\t\t\t\t\t\t\t\t\t\t\t// spot shadow\n\t\t\t\t\t\t\t\t\t\t\t\tgetShadowCoordPerspZbufferNormalOffset(lightProjectionMatrix, shadowParams, geometricNormal);\n\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), dShadowCoord, shadowParams);\n\t\t\t\t\t\t\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), dShadowCoord, shadowParams);\n\t\t\t\t\t\t\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), dShadowCoord, shadowParams);\n\t\t\t\t\t\t\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCSS)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfloat shadow = getShadowSpotClusteredPCSS(SHADOWMAP_PASS(shadowAtlasTexture), dShadowCoord, shadowParams);\n\t\t\t\t\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t\t\t\t\tfalloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);\n\n\t\t\t\t\t\t\t\t\t\t} else {\n\n\t\t\t\t\t\t\t\t\t\t\t\t// omni shadow\n\t\t\t\t\t\t\t\t\t\t\t\tvec3 dir = normalOffsetPointShadow(shadowParams, dLightPosW, dLightDirW, dLightDirNormW, geometricNormal);  // normalBias adjusted for distance\n\n\t\t\t\t\t\t\t\t\t\t\t\t#if defined(CLUSTER_SHADOW_TYPE_PCF1)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfloat shadow = getShadowOmniClusteredPCF1(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF3)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfloat shadow = getShadowOmniClusteredPCF3(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t\t\t\t\t\t\t#elif defined(CLUSTER_SHADOW_TYPE_PCF5)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tfloat shadow = getShadowOmniClusteredPCF5(SHADOWMAP_PASS(shadowAtlasTexture), shadowParams, light.omniAtlasViewport, shadowEdgePixels, dir);\n\t\t\t\t\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t\t\t\t\tfalloffAttenuation *= mix(1.0, shadow, light.shadowIntensity);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t#endif\n\n\t\t\t\t// diffuse / specular / clearcoat\n\t\t\t\t#ifdef CLUSTER_AREALIGHTS\n\n\t\t\t\tif (isClusteredLightArea(light)) { // area light\n\n\t\t\t\t\t\t// area light diffuse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvec3 areaDiffuse = (diffuseAttenuation * falloffAttenuation) * light.color * cookieAttenuation;\n\n\t\t\t\t\t\t\t\t#if defined(LIT_SPECULAR)\n\t\t\t\t\t\t\t\t\t\t#if defined(LIT_CONSERVE_ENERGY)\n\t\t\t\t\t\t\t\t\t\t\t\tareaDiffuse = mix(areaDiffuse, vec3(0), dLTCSpecFres);\n\t\t\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t#endif\n\n\t\t\t\t\t\t\t\t// area light diffuse - it does not mix diffuse lighting into specular attenuation\n\t\t\t\t\t\t\t\tdDiffuseLight += areaDiffuse;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// specular and clear coat are material settings and get included by a define based on the material\n\t\t\t\t\t\t#ifdef LIT_SPECULAR\n\n\t\t\t\t\t\t\t\t// area light specular\n\t\t\t\t\t\t\t\tfloat areaLightSpecular;\n\n\t\t\t\t\t\t\t\tif (isClusteredLightRect(light)) {\n\t\t\t\t\t\t\t\t\t\tareaLightSpecular = getRectLightSpecular(worldNormal, viewDir);\n\t\t\t\t\t\t\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\t\t\t\t\t\t\t\tareaLightSpecular = getDiskLightSpecular(worldNormal, viewDir);\n\t\t\t\t\t\t\t\t} else { // sphere\n\t\t\t\t\t\t\t\t\t\tareaLightSpecular = getSphereLightSpecular(worldNormal, viewDir);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tdSpecularLight += dLTCSpecFres * areaLightSpecular * falloffAttenuation * light.color * cookieAttenuation;\n\n\t\t\t\t\t\t\t\t#ifdef LIT_CLEARCOAT\n\n\t\t\t\t\t\t\t\t\t\t// area light specular clear coat\n\t\t\t\t\t\t\t\t\t\tfloat areaLightSpecularCC;\n\n\t\t\t\t\t\t\t\t\t\tif (isClusteredLightRect(light)) {\n\t\t\t\t\t\t\t\t\t\t\t\tareaLightSpecularCC = getRectLightSpecular(clearcoat.worldNormal, viewDir);\n\t\t\t\t\t\t\t\t\t\t} else if (isClusteredLightDisk(light)) {\n\t\t\t\t\t\t\t\t\t\t\t\tareaLightSpecularCC = getDiskLightSpecular(clearcoat.worldNormal, viewDir);\n\t\t\t\t\t\t\t\t\t\t} else { // sphere\n\t\t\t\t\t\t\t\t\t\t\t\tareaLightSpecularCC = getSphereLightSpecular(clearcoat.worldNormal, viewDir);\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\tccSpecularLight += ccLTCSpecFres * areaLightSpecularCC * falloffAttenuation * light.color  * cookieAttenuation;\n\n\t\t\t\t\t\t\t\t#endif\n\n\t\t\t\t\t\t#endif\n\n\t\t\t\t} else\n\n\t\t\t\t#endif\n\n\t\t\t\t{    // punctual light\n\n\t\t\t\t\t\t// punctual light diffuse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvec3 punctualDiffuse = falloffAttenuation * light.color * cookieAttenuation;\n\n\t\t\t\t\t\t\t\t#if defined(CLUSTER_AREALIGHTS)\n\t\t\t\t\t\t\t\t#if defined(LIT_SPECULAR)\n\t\t\t\t\t\t\t\t#if defined(LIT_CONSERVE_ENERGY)\n\t\t\t\t\t\t\t\t\t\tpunctualDiffuse = mix(punctualDiffuse, vec3(0), specularity);\n\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t#endif\n\n\t\t\t\t\t\t\t\tdDiffuseLight += punctualDiffuse;\n\t\t\t\t\t\t}\n\t \n\t\t\t\t\t\t// specular and clear coat are material settings and get included by a define based on the material\n\t\t\t\t\t\t#ifdef LIT_SPECULAR\n\n\t\t\t\t\t\t\t\tvec3 halfDir = normalize(-dLightDirNormW + viewDir);\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t// specular\n\t\t\t\t\t\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\t\t\t\t\t\t\tdSpecularLight += \n\t\t\t\t\t\t\t\t\t\t\t\tgetLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dLightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * \n\t\t\t\t\t\t\t\t\t\t\t\tgetFresnel(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdot(viewDir, halfDir), \n\t\t\t\t\t\t\t\t\t\t\t\t\t\tgloss, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\tspecularity\n\t\t\t\t\t\t\t\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tiridescence\n\t\t\t\t\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t#else\n\t\t\t\t\t\t\t\t\t\tdSpecularLight += getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dLightDirNormW, gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * specularity;\n\t\t\t\t\t\t\t\t#endif\n\n\t\t\t\t\t\t\t\t#ifdef LIT_CLEARCOAT\n\t\t\t\t\t\t\t\t\t\t#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\t\t\t\t\t\t\t\t\tccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat.worldNormal, viewDir, dLightDirNormW, clearcoat.gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation * getFresnelCC(dot(viewDir, halfDir));\n\t\t\t\t\t\t\t\t\t\t#else\n\t\t\t\t\t\t\t\t\t\t\t\tccSpecularLight += getLightSpecular(halfDir, clearcoatReflectionDir, clearcoat.worldNormal, viewDir, dLightDirNormW, clearcoat.gloss, tbn) * falloffAttenuation * light.color * cookieAttenuation; \n\t\t\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t#endif\n\n\t\t\t\t\t\t\t\t#ifdef LIT_SHEEN\n\t\t\t\t\t\t\t\t\t\tsSpecularLight += getLightSpecularSheen(halfDir, worldNormal, viewDir, dLightDirNormW, sheen.gloss) * falloffAttenuation * light.color * cookieAttenuation;\n\t\t\t\t\t\t\t\t#endif\n\n\t\t\t\t\t\t#endif\n\t\t\t\t}\n\t\t}\n\n\t\t// Write to global attenuation values (for lightmapper)\n\t\tdAtten = falloffAttenuation;\n\t\tdAttenD = diffuseAttenuation;\n\t\tdAtten3 = cookieAttenuation;\n}\n\nvoid evaluateClusterLight(\n\t\tfloat lightIndex, \n\t\tvec3 worldNormal, \n\t\tvec3 viewDir, \n\t\tvec3 reflectionDir, \n#if defined(LIT_CLEARCOAT)\n\t\tvec3 clearcoatReflectionDir,\n#endif\n\t\tfloat gloss, \n\t\tvec3 specularity, \n\t\tvec3 geometricNormal, \n\t\tmat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n\t\tvec3 iridescenceFresnel,\n#endif\n\t\tClearcoatArgs clearcoat, \n\t\tSheenArgs sheen, \n\t\tIridescenceArgs iridescence\n) {\n\n\t\t// decode core light data from textures\n\t\tClusterLightData clusterLightData;\n\t\tdecodeClusterLightCore(clusterLightData, lightIndex);\n\n\t\t// evaluate light if it uses accepted light mask\n\t\tif (acceptLightMask(clusterLightData))\n\t\t\t\tevaluateLight(\n\t\t\t\t\t\tclusterLightData, \n\t\t\t\t\t\tworldNormal, \n\t\t\t\t\t\tviewDir, \n\t\t\t\t\t\treflectionDir, \n#if defined(LIT_CLEARCOAT)\n\t\t\t\t\t\tclearcoatReflectionDir, \n#endif\n\t\t\t\t\t\tgloss, \n\t\t\t\t\t\tspecularity, \n\t\t\t\t\t\tgeometricNormal, \n\t\t\t\t\t\ttbn, \n#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\tiridescenceFresnel,\n#endif\n\t\t\t\t\t\tclearcoat, \n\t\t\t\t\t\tsheen, \n\t\t\t\t\t\tiridescence\n\t\t\t\t);\n}\n\nvoid addClusteredLights(\n\t\tvec3 worldNormal, \n\t\tvec3 viewDir, \n\t\tvec3 reflectionDir, \n#if defined(LIT_CLEARCOAT)\n\t\tvec3 clearcoatReflectionDir,\n#endif\n\t\tfloat gloss, \n\t\tvec3 specularity, \n\t\tvec3 geometricNormal, \n\t\tmat3 tbn, \n#if defined(LIT_IRIDESCENCE)\n\t\tvec3 iridescenceFresnel,\n#endif\n\t\tClearcoatArgs clearcoat, \n\t\tSheenArgs sheen, \n\t\tIridescenceArgs iridescence\n) {\n\n\t\t// skip lights if no lights at all\n\t\tif (clusterSkip > 0.5)\n\t\t\t\treturn;\n\n\t\t// world space position to 3d integer cell cordinates in the cluster structure\n\t\tvec3 cellCoords = floor((vPositionW - clusterBoundsMin) * clusterCellsCountByBoundsSize);\n\n\t\t// no lighting when cell coordinate is out of range\n\t\tif (!(any(lessThan(cellCoords, vec3(0.0))) || any(greaterThanEqual(cellCoords, clusterCellsMax)))) {\n\n\t\t\t\t// cell index (mapping from 3d cell coordinates to linear memory)\n\t\t\t\tfloat cellIndex = dot(clusterCellsDot, cellCoords);\n\n\t\t\t\t// convert cell index to uv coordinates\n\t\t\t\tfloat clusterV = floor(cellIndex * clusterTextureSize.y);\n\t\t\t\tfloat clusterU = cellIndex - (clusterV * clusterTextureSize.x);\n\n\t\t\t\t#ifdef GL2\n\n\t\t\t\t\t\t// loop over maximum number of light cells\n\t\t\t\t\t\tfor (int lightCellIndex = 0; lightCellIndex < clusterMaxCells; lightCellIndex++) {\n\n\t\t\t\t\t\t\t\t// using a single channel texture with data in alpha channel\n\t\t\t\t\t\t\t\tfloat lightIndex = texelFetch(clusterWorldTexture, ivec2(int(clusterU) + lightCellIndex, clusterV), 0).x;\n\n\t\t\t\t\t\t\t\tif (lightIndex <= 0.0)\n\t\t\t\t\t\t\t\t\t\t\t\treturn;\n\n\t\t\t\t\t\t\t\tevaluateClusterLight(\n\t\t\t\t\t\t\t\t\t\tlightIndex * 255.0, \n\t\t\t\t\t\t\t\t\t\tworldNormal, \n\t\t\t\t\t\t\t\t\t\tviewDir, \n\t\t\t\t\t\t\t\t\t\treflectionDir,\n#if defined(LIT_CLEARCOAT)\n\t\t\t\t\t\t\t\t\t\tclearcoatReflectionDir,\n#endif\n\t\t\t\t\t\t\t\t\t\tgloss, \n\t\t\t\t\t\t\t\t\t\tspecularity, \n\t\t\t\t\t\t\t\t\t\tgeometricNormal, \n\t\t\t\t\t\t\t\t\t\ttbn, \n#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t\t\t\tiridescenceFresnel,\n#endif\n\t\t\t\t\t\t\t\t\t\tclearcoat, \n\t\t\t\t\t\t\t\t\t\tsheen, \n\t\t\t\t\t\t\t\t\t\tiridescence\n\t\t\t\t\t\t\t\t); \n\t\t\t\t\t\t}\n\n\t\t\t\t#else\n\n\t\t\t\t\t\tclusterV = (clusterV + 0.5) * clusterTextureSize.z;\n\n\t\t\t\t\t\t// loop over maximum possible number of supported light cells\n\t\t\t\t\t\tconst float maxLightCells = 256.0;\n\t\t\t\t\t\tfor (float lightCellIndex = 0.5; lightCellIndex < maxLightCells; lightCellIndex++) {\n\n\t\t\t\t\t\t\t\tfloat lightIndex = texture2DLodEXT(clusterWorldTexture, vec2(clusterTextureSize.y * (clusterU + lightCellIndex), clusterV), 0.0).x;\n\n\t\t\t\t\t\t\t\tif (lightIndex <= 0.0)\n\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\tevaluateClusterLight(\n\t\t\t\t\t\t\t\t\t\tlightIndex * 255.0, \n\t\t\t\t\t\t\t\t\t\tworldNormal, \n\t\t\t\t\t\t\t\t\t\tviewDir, \n\t\t\t\t\t\t\t\t\t\treflectionDir,\n#if defined(LIT_CLEARCOAT)\n\t\t\t\t\t\t\t\t\t\tclearcoatReflectionDir,\n#endif\n\t\t\t\t\t\t\t\t\t\tgloss, \n\t\t\t\t\t\t\t\t\t\tspecularity, \n\t\t\t\t\t\t\t\t\t\tgeometricNormal, \n\t\t\t\t\t\t\t\t\t\ttbn, \n#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t\t\t\tiridescenceFresnel,\n#endif\n\t\t\t\t\t\t\t\t\t\tclearcoat, \n\t\t\t\t\t\t\t\t\t\tsheen, \n\t\t\t\t\t\t\t\t\t\tiridescence\n\t\t\t\t\t\t\t\t); \n\t\t\t\t\t\t\t\t// end of the cell array\n\t\t\t\t\t\t\t\tif (lightCellIndex >= clusterMaxCells) {\n\t\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t#endif\n\t\t}\n}\n",combinePS:"\nvec3 combineColor(vec3 albedo, vec3 sheenSpecularity, float clearcoatSpecularity) {\n\t\tvec3 ret = vec3(0);\n#ifdef LIT_OLD_AMBIENT\n\t\tret += (dDiffuseLight - light_globalAmbient) * albedo + material_ambient * light_globalAmbient;\n#else\n\t\tret += albedo * dDiffuseLight;\n#endif\n#ifdef LIT_SPECULAR\n\t\tret += dSpecularLight;\n#endif\n#ifdef LIT_REFLECTIONS\n\t\tret += dReflection.rgb * dReflection.a;\n#endif\n\n#ifdef LIT_SHEEN\n\t\tfloat sheenScaling = 1.0 - max(max(sheenSpecularity.r, sheenSpecularity.g), sheenSpecularity.b) * 0.157;\n\t\tret = ret * sheenScaling + (sSpecularLight + sReflection.rgb) * sheenSpecularity;\n#endif\n#ifdef LIT_CLEARCOAT\n\t\tfloat clearCoatScaling = 1.0 - ccFresnel * clearcoatSpecularity;\n\t\tret = ret * clearCoatScaling + (ccSpecularLight + ccReflection.rgb) * clearcoatSpecularity;\n#endif\n\n\t\treturn ret;\n}\n",cookiePS:"\n// light cookie functionality for non-clustered lights\nvec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n\t\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\t\tprojPos.xy /= projPos.w;\n\t\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\n\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n\t\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\t\tprojPos.xy /= projPos.w;\n\t\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\t\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\n\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\t\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\t\tprojPos.xy /= projPos.w;\n\t\tprojPos.xy += cookieOffset;\n\t\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\t\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\n\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\t\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\t\tprojPos.xy /= projPos.w;\n\t\tprojPos.xy += cookieOffset;\n\t\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\t\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\t\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\n\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n\t\treturn mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n",cubeMapProjectBoxPS:"\nuniform vec3 envBoxMin;\nuniform vec3 envBoxMax;\n\nvec3 cubeMapProject(vec3 nrdir) {\n\t\tnrdir = cubeMapRotate(nrdir);\n\n\t\tvec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n\t\tvec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n\n\t\tvec3 rbminmax;\n\t\trbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;\n\t\trbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;\n\t\trbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;\n\n\t\tfloat fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n\n\t\tvec3 posonbox = vPositionW + nrdir * fa;\n\t\tvec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n\t\treturn normalize(posonbox - envBoxPos);\n}\n",cubeMapProjectNonePS:"\nvec3 cubeMapProject(vec3 dir) {\n\t\treturn cubeMapRotate(dir);\n}\n",cubeMapRotatePS:"\n#ifdef CUBEMAP_ROTATION\nuniform mat3 cubeMapRotationMatrix;\n#endif\n\nvec3 cubeMapRotate(vec3 refDir) {\n#ifdef CUBEMAP_ROTATION\n\t\treturn refDir * cubeMapRotationMatrix;\n#else\n\t\treturn refDir;\n#endif\n}\n",debugOutputPS:"\n#ifdef DEBUG_ALBEDO_PASS\ngl_FragColor = vec4(gammaCorrectOutput(litShaderArgs.albedo), 1.0);\n#endif\n\n#ifdef DEBUG_UV0_PASS\ngl_FragColor = vec4(litShaderArgs.albedo , 1.0);\n#endif\n\n#ifdef DEBUG_WORLD_NORMAL_PASS\ngl_FragColor = vec4(litShaderArgs.worldNormal * 0.5 + 0.5, 1.0);\n#endif\n\n#ifdef DEBUG_OPACITY_PASS\ngl_FragColor = vec4(vec3(litShaderArgs.opacity) , 1.0);\n#endif\n\n#ifdef DEBUG_SPECULARITY_PASS\ngl_FragColor = vec4(litShaderArgs.specularity, 1.0);\n#endif\n\n#ifdef DEBUG_GLOSS_PASS\ngl_FragColor = vec4(vec3(litShaderArgs.gloss) , 1.0);\n#endif\n\n#ifdef DEBUG_METALNESS_PASS\ngl_FragColor = vec4(vec3(litShaderArgs.metalness) , 1.0);\n#endif\n\n#ifdef DEBUG_AO_PASS\ngl_FragColor = vec4(vec3(litShaderArgs.ao) , 1.0);\n#endif\n\n#ifdef DEBUG_EMISSION_PASS\ngl_FragColor = vec4(gammaCorrectOutput(litShaderArgs.emission), 1.0);\n#endif\n",debugProcessFrontendPS:"\n#ifdef DEBUG_LIGHTING_PASS\nlitShaderArgs.albedo = vec3(0.5);\n#endif\n\n#ifdef DEBUG_UV0_PASS\n#ifdef VARYING_VUV0\nlitShaderArgs.albedo = vec3(vUv0, 0);\n#else\nlitShaderArgs.albedo = vec3(0);\n#endif\n#endif\n",detailModesPS:"\nvec3 detailMode_mul(vec3 c1, vec3 c2) {\n\t\treturn c1 * c2;\n}\n\nvec3 detailMode_add(vec3 c1, vec3 c2) {\n\t\treturn c1 + c2;\n}\n\n// https://en.wikipedia.org/wiki/Blend_modes#Screen\nvec3 detailMode_screen(vec3 c1, vec3 c2) {\n\t\treturn 1.0 - (1.0 - c1)*(1.0 - c2);\n}\n\n// https://en.wikipedia.org/wiki/Blend_modes#Overlay\nvec3 detailMode_overlay(vec3 c1, vec3 c2) {\n\t\treturn mix(1.0 - 2.0*(1.0 - c1)*(1.0 - c2), 2.0*c1*c2, step(c1, vec3(0.5)));\n}\n\nvec3 detailMode_min(vec3 c1, vec3 c2) {\n\t\treturn min(c1, c2);\n}\n\nvec3 detailMode_max(vec3 c1, vec3 c2) {\n\t\treturn max(c1, c2);\n}\n",diffusePS:"\n#ifdef MAPCOLOR\nuniform vec3 material_diffuse;\n#endif\n\nvoid getAlbedo() {\n\t\tdAlbedo = vec3(1.0);\n\n#ifdef MAPCOLOR\n\t\tdAlbedo *= material_diffuse.rgb;\n#endif\n\n#ifdef MAPTEXTURE\n\t\tvec3 albedoBase = $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n\t\tdAlbedo *= addAlbedoDetail(albedoBase);\n#endif\n\n#ifdef MAPVERTEX\n\t\tdAlbedo *= gammaCorrectInput(saturate(vVertexColor.$VC));\n#endif\n}\n",diffuseDetailMapPS:"\nvec3 addAlbedoDetail(vec3 albedo) {\n#ifdef MAPTEXTURE\n\t\tvec3 albedoDetail = $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n\t\treturn detailMode_$DETAILMODE(albedo, albedoDetail);\n#else\n\t\treturn albedo;\n#endif\n}\n",decodePS:Ci,emissivePS:"\n#ifdef MAPCOLOR\nuniform vec3 material_emissive;\n#endif\n\n#ifdef MAPFLOAT\nuniform float material_emissiveIntensity;\n#endif\n\nvoid getEmission() {\n\t\tdEmission = vec3(1.0);\n\n\t\t#ifdef MAPFLOAT\n\t\tdEmission *= material_emissiveIntensity;\n\t\t#endif\n\n\t\t#ifdef MAPCOLOR\n\t\tdEmission *= material_emissive;\n\t\t#endif\n\n\t\t#ifdef MAPTEXTURE\n\t\tdEmission *= $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n\t\t#endif\n\n\t\t#ifdef MAPVERTEX\n\t\tdEmission *= gammaCorrectInput(saturate(vVertexColor.$VC));\n\t\t#endif\n}\n",encodePS:Ti,endPS:"\n\t\tgl_FragColor.rgb = combineColor(litShaderArgs.albedo, litShaderArgs.sheen.specularity, litShaderArgs.clearcoat.specularity);\n\n\t\tgl_FragColor.rgb += litShaderArgs.emission;\n\t\tgl_FragColor.rgb = addFog(gl_FragColor.rgb);\n\n\t\t#ifndef HDR\n\t\tgl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n\t\tgl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n\t\t#endif\n",endVS:"\n",envAtlasPS:"\n// the envAtlas is fixed at 512 pixels. every equirect is generated with 1 pixel boundary.\nconst float atlasSize = 512.0;\nconst float seamSize = 1.0 / atlasSize;\n\n// map a normalized equirect UV to the given rectangle (taking 1 pixel seam into account).\nvec2 mapUv(vec2 uv, vec4 rect) {\n\t\treturn vec2(mix(rect.x + seamSize, rect.x + rect.z - seamSize, uv.x),\n\t\t\t\t\t\t\t\tmix(rect.y + seamSize, rect.y + rect.w - seamSize, uv.y));\n}\n\n// map a normalized equirect UV and roughness level to the correct atlas rect.\nvec2 mapRoughnessUv(vec2 uv, float level) {\n\t\tfloat t = 1.0 / exp2(level);\n\t\treturn mapUv(uv, vec4(0, 1.0 - t, t, t * 0.5));\n}\n\n// map shiny level UV\nvec2 mapShinyUv(vec2 uv, float level) {\n\t\tfloat t = 1.0 / exp2(level);\n\t\treturn mapUv(uv, vec4(1.0 - t, 1.0 - t, t, t * 0.5));\n}\n",envConstPS:"\nvec3 processEnvironment(vec3 color) {\n\t\treturn color;\n}\n",envMultiplyPS:"\nuniform float skyboxIntensity;\n\nvec3 processEnvironment(vec3 color) {\n\t\treturn color * skyboxIntensity;\n}\n",extensionPS:"\n",extensionVS:"\n",falloffInvSquaredPS:"\nfloat getFalloffWindow(float lightRadius, vec3 lightDir) {\n\t\tfloat sqrDist = dot(lightDir, lightDir);\n\t\tfloat invRadius = 1.0 / lightRadius;\n\t\treturn square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n}\n\nfloat getFalloffInvSquared(float lightRadius, vec3 lightDir) {\n\t\tfloat sqrDist = dot(lightDir, lightDir);\n\t\tfloat falloff = 1.0 / (sqrDist + 1.0);\n\t\tfloat invRadius = 1.0 / lightRadius;\n\n\t\tfalloff *= 16.0;\n\t\tfalloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n\n\t\treturn falloff;\n}\n",falloffLinearPS:"\nfloat getFalloffLinear(float lightRadius, vec3 lightDir) {\n\t\tfloat d = length(lightDir);\n\t\treturn max(((lightRadius - d) / lightRadius), 0.0);\n}\n",fixCubemapSeamsNonePS:"\nvec3 fixSeams(vec3 vec, float mipmapIndex) {\n\t\treturn vec;\n}\n\nvec3 fixSeams(vec3 vec) {\n\t\treturn vec;\n}\n\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n\t\treturn vec;\n}\n\nvec3 calcSeam(vec3 vec) {\n\t\treturn vec3(0);\n}\n\nvec3 applySeam(vec3 vec, vec3 seam, float scale) {\n\t\treturn vec;\n}\n",fixCubemapSeamsStretchPS:"\nvec3 fixSeams(vec3 vec, float mipmapIndex) {\n\t\tvec3 avec = abs(vec);\n\t\tfloat scale = 1.0 - exp2(mipmapIndex) / 128.0;\n\t\tfloat M = max(max(avec.x, avec.y), avec.z);\n\t\tif (avec.x != M) vec.x *= scale;\n\t\tif (avec.y != M) vec.y *= scale;\n\t\tif (avec.z != M) vec.z *= scale;\n\t\treturn vec;\n}\n\nvec3 fixSeams(vec3 vec) {\n\t\tvec3 avec = abs(vec);\n\t\tfloat scale = 1.0 - 1.0 / 128.0;\n\t\tfloat M = max(max(avec.x, avec.y), avec.z);\n\t\tif (avec.x != M) vec.x *= scale;\n\t\tif (avec.y != M) vec.y *= scale;\n\t\tif (avec.z != M) vec.z *= scale;\n\t\treturn vec;\n}\n\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n\t\tvec3 avec = abs(vec);\n\t\tfloat scale = invRecMipSize;\n\t\tfloat M = max(max(avec.x, avec.y), avec.z);\n\t\tif (avec.x != M) vec.x *= scale;\n\t\tif (avec.y != M) vec.y *= scale;\n\t\tif (avec.z != M) vec.z *= scale;\n\t\treturn vec;\n}\n\nvec3 calcSeam(vec3 vec) {\n\t\tvec3 avec = abs(vec);\n\t\tfloat M = max(avec.x, max(avec.y, avec.z));\n\t\treturn vec3(avec.x != M ? 1.0 : 0.0,\n\t\t\t\t\t\t\t\tavec.y != M ? 1.0 : 0.0,\n\t\t\t\t\t\t\t\tavec.z != M ? 1.0 : 0.0);\n}\n\nvec3 applySeam(vec3 vec, vec3 seam, float scale) {\n\t\treturn vec * (seam * -scale + vec3(1.0));\n}\n",floatUnpackingPS:"\n// float unpacking functionality, complimentary to float-packing.js\nfloat bytes2float2(vec2 data) {\n\t\treturn dot(data, vec2(1.0, 1.0 / 255.0));\n}\n\nfloat bytes2float3(vec3 data) {\n\t\treturn dot(data, vec3(1.0, 1.0 / 255.0, 1.0 / 65025.0));\n}\n\nfloat bytes2float4(vec4 data) {\n\t\treturn dot(data, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat bytes2floatRange2(vec2 data, float min, float max) {\n\t\treturn mix(min, max, bytes2float2(data));\n}\n\nfloat bytes2floatRange3(vec3 data, float min, float max) {\n\t\treturn mix(min, max, bytes2float3(data));\n}\n\nfloat bytes2floatRange4(vec4 data, float min, float max) {\n\t\treturn mix(min, max, bytes2float4(data));\n}\n\nfloat mantissaExponent2Float(vec4 pack)\n{\n\t\tfloat value = bytes2floatRange3(pack.xyz, -1.0, 1.0);\n\t\tfloat exponent = floor(pack.w * 255.0 - 127.0);\n\t\treturn value * exp2(exponent);\n}\n",fogExpPS:"\nuniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\n\nvec3 addFog(vec3 color) {\n\t\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\t\tfloat fogFactor = exp(-depth * fog_density);\n\t\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\t\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogExp2PS:"\nuniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\n\nvec3 addFog(vec3 color) {\n\t\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\t\tfloat fogFactor = exp(-depth * depth * fog_density * fog_density);\n\t\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\t\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogLinearPS:"\nuniform vec3 fog_color;\nuniform float fog_start;\nuniform float fog_end;\nfloat dBlendModeFogFactor = 1.0;\n\nvec3 addFog(vec3 color) {\n\t\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\t\tfloat fogFactor = (fog_end - depth) / (fog_end - fog_start);\n\t\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\t\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogNonePS:"\nfloat dBlendModeFogFactor = 1.0;\n\nvec3 addFog(vec3 color) {\n\t\treturn color;\n}\n",fresnelSchlickPS:"\n// Schlick's approximation\nvec3 getFresnel(\n\t\t\t\tfloat cosTheta, \n\t\t\t\tfloat gloss, \n\t\t\t\tvec3 specularity\n#if defined(LIT_IRIDESCENCE)\n\t\t\t\t, vec3 iridescenceFresnel, \n\t\t\t\tIridescenceArgs iridescence\n#endif\n\t\t) {\n\t\tfloat fresnel = pow(1.0 - max(cosTheta, 0.0), 5.0);\n\t\tfloat glossSq = gloss * gloss;\n\t\tvec3 ret = specularity + (max(vec3(glossSq), specularity) - specularity) * fresnel;\n#if defined(LIT_IRIDESCENCE)\n\t\treturn mix(ret, iridescenceFresnel, iridescence.intensity);\n#else\n\t\treturn ret;\n#endif    \n}\n\nfloat getFresnelCC(float cosTheta) {\n\t\tfloat fresnel = pow(1.0 - max(cosTheta, 0.0), 5.0);\n\t\treturn 0.04 + (1.0 - 0.04) * fresnel;\n}\n",fullscreenQuadPS:"\nvarying vec2 vUv0;\n\nuniform sampler2D source;\n\nvoid main(void) {\n\t\tgl_FragColor = texture2D(source, vUv0);\n}\n",fullscreenQuadVS:"\nattribute vec2 vertex_position;\n\nvarying vec2 vUv0;\n\nvoid main(void)\n{\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tvUv0 = vertex_position.xy*0.5+0.5;\n}\n",gamma1_0PS:"\nfloat gammaCorrectInput(float color) {\n\t\treturn color;\n}\n\nvec3 gammaCorrectInput(vec3 color) {\n\t\treturn color;\n}\n\nvec4 gammaCorrectInput(vec4 color) {\n\t\treturn color;\n}\n\nvec3 gammaCorrectOutput(vec3 color) {\n\t\treturn color;\n}\n",gamma2_2PS:"\nfloat gammaCorrectInput(float color) {\n\t\treturn decodeGamma(color);\n}\n\nvec3 gammaCorrectInput(vec3 color) {\n\t\treturn decodeGamma(color);\n}\n\nvec4 gammaCorrectInput(vec4 color) {\n\t\treturn vec4(decodeGamma(color.xyz), color.w);\n}\n\nvec3 gammaCorrectOutput(vec3 color) {\n#ifdef HDR\n\t\treturn color;\n#else\n\t\treturn pow(color + 0.0000001, vec3(1.0 / 2.2));\n#endif\n}\n",gles2PS:is,gles3PS:ns,gles3VS:rs,glossPS:"\n#ifdef MAPFLOAT\nuniform float material_gloss;\n#endif\n\nvoid getGlossiness() {\n\t\tdGlossiness = 1.0;\n\n\t\t#ifdef MAPFLOAT\n\t\tdGlossiness *= material_gloss;\n\t\t#endif\n\n\t\t#ifdef MAPTEXTURE\n\t\tdGlossiness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t\t#endif\n\n\t\t#ifdef MAPVERTEX\n\t\tdGlossiness *= saturate(vVertexColor.$VC);\n\t\t#endif\n\n\t\t#ifdef MAPINVERT\n\t\tdGlossiness = 1.0 - dGlossiness;\n\t\t#endif\n\n\t\tdGlossiness += 0.0000001;\n}\n",iridescenceDiffractionPS:"\nuniform float material_iridescenceRefractionIndex;\n\n#ifndef PI\n#define PI 3.14159265\n#endif\n\nfloat iridescence_iorToFresnel(float transmittedIor, float incidentIor) {\n\t\treturn pow((transmittedIor - incidentIor) / (transmittedIor + incidentIor), 2.0);\n}\n\nvec3 iridescence_iorToFresnel(vec3 transmittedIor, float incidentIor) {\n\t\treturn pow((transmittedIor - vec3(incidentIor)) / (transmittedIor + vec3(incidentIor)), vec3(2.0));\n}\n\nvec3 iridescence_fresnelToIor(vec3 f0) {\n\t\tvec3 sqrtF0 = sqrt(f0);\n\t\treturn (vec3(1.0) + sqrtF0) / (vec3(1.0) - sqrtF0);\n}\n\nvec3 iridescence_sensitivity(float opd, vec3 shift) {\n\t\tfloat phase = 2.0 * PI * opd * 1.0e-9;\n\t\tconst vec3 val = vec3(5.4856e-13, 4.4201e-13, 5.2481e-13);\n\t\tconst vec3 pos = vec3(1.6810e+06, 1.7953e+06, 2.2084e+06);\n\t\tconst vec3 var = vec3(4.3278e+09, 9.3046e+09, 6.6121e+09);\n\n\t\tvec3 xyz = val * sqrt(2.0 * PI * var) * cos(pos * phase + shift) * exp(-pow(phase, 2.0) * var);\n\t\txyz.x += 9.7470e-14 * sqrt(2.0 * PI * 4.5282e+09) * cos(2.2399e+06 * phase + shift[0]) * exp(-4.5282e+09 * pow(phase, 2.0));\n\t\txyz /= vec3(1.0685e-07);\n\n\t\tconst mat3 XYZ_TO_REC709 = mat3(\n\t\t\t\t3.2404542, -0.9692660,  0.0556434,\n\t\t\t -1.5371385,  1.8760108, -0.2040259,\n\t\t\t -0.4985314,  0.0415560,  1.0572252\n\t\t);\n\n\t\treturn XYZ_TO_REC709 * xyz;\n}\n\nfloat iridescence_fresnel(float cosTheta, float f0) {\n\t\tfloat x = clamp(1.0 - cosTheta, 0.0, 1.0);\n\t\tfloat x2 = x * x;\n\t\tfloat x5 = x * x2 * x2;\n\t\treturn f0 + (1.0 - f0) * x5;\n} \n\nvec3 iridescence_fresnel(float cosTheta, vec3 f0) {\n\t\tfloat x = clamp(1.0 - cosTheta, 0.0, 1.0);\n\t\tfloat x2 = x * x;\n\t\tfloat x5 = x * x2 * x2; \n\t\treturn f0 + (vec3(1.0) - f0) * x5;\n}\n\nvec3 calcIridescence(float outsideIor, float cosTheta, vec3 base_f0, float iridescenceThickness) {\n\n\t\tfloat iridescenceIor = mix(outsideIor, material_iridescenceRefractionIndex, smoothstep(0.0, 0.03, iridescenceThickness));\n\t\tfloat sinTheta2Sq = pow(outsideIor / iridescenceIor, 2.0) * (1.0 - pow(cosTheta, 2.0));\n\t\tfloat cosTheta2Sq = 1.0 - sinTheta2Sq;\n\n\t\tif (cosTheta2Sq < 0.0) {\n\t\t\t\treturn vec3(1.0);\n\t\t}\n\n\t\tfloat cosTheta2 = sqrt(cosTheta2Sq);\n\n\t\tfloat r0 = iridescence_iorToFresnel(iridescenceIor, outsideIor);\n\t\tfloat r12 = iridescence_fresnel(cosTheta, r0);\n\t\tfloat r21 = r12;\n\t\tfloat t121 = 1.0 - r12;\n\n\t\tfloat phi12 = iridescenceIor < outsideIor ? PI : 0.0;\n\t\tfloat phi21 = PI - phi12;\n\n\t\tvec3 baseIor = iridescence_fresnelToIor(base_f0 + vec3(0.0001));\n\t\tvec3 r1 = iridescence_iorToFresnel(baseIor, iridescenceIor);\n\t\tvec3 r23 = iridescence_fresnel(cosTheta2, r1);\n\n\t\tvec3 phi23 = vec3(0.0);\n\t\tif (baseIor[0] < iridescenceIor) phi23[0] = PI;\n\t\tif (baseIor[1] < iridescenceIor) phi23[1] = PI;\n\t\tif (baseIor[2] < iridescenceIor) phi23[2] = PI;\n\t\tfloat opd = 2.0 * iridescenceIor * iridescenceThickness * cosTheta2;\n\t\tvec3 phi = vec3(phi21) + phi23; \n\n\t\tvec3 r123Sq = clamp(r12 * r23, 1e-5, 0.9999);\n\t\tvec3 r123 = sqrt(r123Sq);\n\t\tvec3 rs = pow(t121, 2.0) * r23 / (1.0 - r123Sq);\n\n\t\tvec3 c0 = r12 + rs;\n\t\tvec3 i = c0;\n\n\t\tvec3 cm = rs - t121;\n\t\tfor (int m = 1; m <= 2; m++) {\n\t\t\t\tcm *= r123;\n\t\t\t\tvec3 sm = 2.0 * iridescence_sensitivity(float(m) * opd, float(m) * phi);\n\t\t\t\ti += cm * sm;\n\t\t}\n\t\treturn max(i, vec3(0.0));\n}\n\nvec3 getIridescence(float cosTheta, vec3 specularity, inout IridescenceArgs iridescence) {\n\t\treturn calcIridescence(1.0, cosTheta, specularity, iridescence.thickness);\n}\n",iridescencePS:"\n#ifdef MAPFLOAT\nuniform float material_iridescence;\n#endif\n\nvoid getIridescence() {\n\t\tfloat iridescence = 1.0;\n\n\t\t#ifdef MAPFLOAT\n\t\tiridescence *= material_iridescence;\n\t\t#endif\n\n\t\t#ifdef MAPTEXTURE\n\t\tiridescence *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t\t#endif\n\n\t\tdIridescence = iridescence; \n}\n",iridescenceThicknessPS:"\nuniform float material_iridescenceThicknessMax;\n\n#ifdef MAPTEXTURE\nuniform float material_iridescenceThicknessMin;\n#endif\n\nvoid getIridescenceThickness() {\n\n\t\t#ifdef MAPTEXTURE\n\t\tfloat blend = texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t\tfloat iridescenceThickness = mix(material_iridescenceThicknessMin, material_iridescenceThicknessMax, blend);\n\t\t#else\n\t\tfloat iridescenceThickness = material_iridescenceThicknessMax;\n\t\t#endif\n\n\t\tdIridescenceThickness = iridescenceThickness; \n}\n",instancingVS:"\nattribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\n",lightDiffuseLambertPS:"\nfloat getLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n\t\treturn max(dot(worldNormal, -lightDirNorm), 0.0);\n}\n",lightDirPointPS:"\nvoid getLightDirPoint(vec3 lightPosW) {\n\t\tdLightDirW = vPositionW - lightPosW;\n\t\tdLightDirNormW = normalize(dLightDirW);\n\t\tdLightPosW = lightPosW;\n}\n",lightmapAddPS:"\nvoid addLightMap(\n\t\tvec3 lightmap, \n\t\tvec3 dir, \n\t\tvec3 worldNormal, \n\t\tvec3 viewDir, \n\t\tvec3 reflectionDir, \n\t\tfloat gloss, \n\t\tvec3 specularity, \n\t\tvec3 vertexNormal, \n\t\tmat3 tbn\n#if defined(LIT_IRIDESCENCE)\n\t\tvec3 iridescenceFresnel, \n\t\tIridescenceArgs iridescence\n#endif\n) {\n\t\tdDiffuseLight += lightmap;\n}\n",lightmapDirAddPS:"\nvoid addLightMap(\n\t\tvec3 lightmap, \n\t\tvec3 dir, \n\t\tvec3 worldNormal, \n\t\tvec3 viewDir, \n\t\tvec3 reflectionDir, \n\t\tfloat gloss, \n\t\tvec3 specularity, \n\t\tvec3 vertexNormal, \n\t\tmat3 tbn\n#if defined(LIT_IRIDESCENCE)\n\t\tvec3 iridescenceFresnel, \n\t\tIridescenceArgs iridescence\n#endif\n) {\n\t\tif (dot(dir, dir) < 0.0001) {\n\t\t\t\tdDiffuseLight += lightmap;\n\t\t} else {\n\t\t\t\tfloat vlight = saturate(dot(dir, -vertexNormal));\n\t\t\t\tfloat flight = saturate(dot(dir, -worldNormal));\n\t\t\t\tfloat nlight = (flight / max(vlight, 0.01)) * 0.5;\n\n\t\t\t\tdDiffuseLight += lightmap * nlight * 2.0;\n\n\t\t\t\tvec3 halfDir = normalize(-dir + viewDir);\n\t\t\t\tvec3 specularLight = lightmap * getLightSpecular(halfDir, reflectionDir, worldNormal, viewDir, dir, gloss, tbn);\n\n#ifdef LIT_SPECULAR_FRESNEL\n\t\t\t\tspecularLight *= \n\t\t\t\t\t\tgetFresnel(dot(viewDir, halfDir), \n\t\t\t\t\t\tgloss, \n\t\t\t\t\t\tspecularity\n\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\t\tiridescence\n\t\t\t\t#endif\n\t\t\t\t\t\t);\n#endif\n\n\t\t\t\tdSpecularLight += specularLight;\n\t\t}\n}\n",lightmapDirPS:"\nuniform sampler2D texture_lightMap;\nuniform sampler2D texture_dirLightMap;\n\nvoid getLightMap() {\n\t\tdLightmap = $DECODE(texture2DBias(texture_lightMap, $UV, textureBias)).$CH;\n\n\t\tvec3 dir = texture2DBias(texture_dirLightMap, $UV, textureBias).xyz * 2.0 - 1.0;\n\t\tfloat dirDot = dot(dir, dir);\n\t\tdLightmapDir = (dirDot > 0.001) ? dir / sqrt(dirDot) : vec3(0.0);\n}\n",lightmapSinglePS:"\nvoid getLightMap() {\n\t\tdLightmap = vec3(1.0);\n\n\t\t#ifdef MAPTEXTURE\n\t\tdLightmap *= $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n\t\t#endif\n\n\t\t#ifdef MAPVERTEX\n\t\tdLightmap *= saturate(vVertexColor.$VC);\n\t\t#endif\n}\n",lightSpecularAnisoGGXPS:"\n// Anisotropic GGX\nfloat calcLightSpecular(float gloss, vec3 worldNormal, vec3 viewDir, vec3 h, vec3 lightDirNorm, mat3 tbn) {\n\t\tfloat PI = 3.141592653589793;\n\t\tfloat roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);\n\t\tfloat anisotropy = material_anisotropy * roughness;\n \n\t\tfloat at = max((roughness + anisotropy), roughness / 4.0);\n\t\tfloat ab = max((roughness - anisotropy), roughness / 4.0);\n\n\t\tfloat NoH = dot(worldNormal, h);\n\t\tfloat ToH = dot(tbn[0], h);\n\t\tfloat BoH = dot(tbn[1], h);\n\n\t\tfloat a2 = at * ab;\n\t\tvec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);\n\t\tfloat v2 = dot(v, v);\n\t\tfloat w2 = a2 / v2;\n\t\tfloat D = a2 * w2 * w2 * (1.0 / PI);\n\n\t\tfloat ToV = dot(tbn[0], viewDir);\n\t\tfloat BoV = dot(tbn[1], viewDir);\n\t\tfloat ToL = dot(tbn[0], -lightDirNorm);\n\t\tfloat BoL = dot(tbn[1], -lightDirNorm);\n\t\tfloat NoV = dot(worldNormal, viewDir);\n\t\tfloat NoL = dot(worldNormal, -lightDirNorm);\n\n\t\tfloat lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));\n\t\tfloat lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));\n\t\tfloat G = 0.5 / (lambdaV + lambdaL);\n\n\t\treturn D * G;\n}\n\nfloat getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {\n\t\treturn calcLightSpecular(gloss, worldNormal, viewDir, h, lightDirNorm, tbn);\n}\n",lightSpecularBlinnPS:"\n// Energy-conserving (hopefully) Blinn-Phong\nfloat calcLightSpecular(float gloss, vec3 worldNormal, vec3 h) {\n\t\tfloat nh = max( dot( h, worldNormal ), 0.0 );\n\n\t\tfloat specPow = exp2(gloss * 11.0); // glossiness is linear, power is not; 0 - 2048\n\n\t\t// Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n\t\tspecPow = max(specPow, 0.0001);\n\n\t\treturn pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\n\nfloat getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {\n\t\treturn calcLightSpecular(gloss, worldNormal, h);\n}\n",lightSpecularPhongPS:"\nfloat calcLightSpecular(float gloss, vec3 reflDir, vec3 lightDirNorm) {\n\t\tfloat specPow = gloss;\n\n\t\t// Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n\t\treturn pow(max(dot(reflDir, -lightDirNorm), 0.0), specPow + 0.0001);\n}\n\nfloat getLightSpecular(vec3 h, vec3 reflDir, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float gloss, mat3 tbn) {\n\t\treturn calcLightSpecular(gloss, reflDir, lightDirNorm);\n}\n",lightSheenPS:"\n\nfloat sheenD(vec3 normal, vec3 h, float roughness) {\n\t\tfloat invR = 1.0 / (roughness * roughness);\n\t\tfloat cos2h = max(dot(normal, h), 0.0);\n\t\tcos2h *= cos2h;\n\t\tfloat sin2h = max(1.0 - cos2h, 0.0078125);\n\t\treturn (2.0 + invR) * pow(sin2h, invR * 0.5) / (2.0 * PI);\n}\n\nfloat sheenV(vec3 normal, vec3 viewDir, vec3 light) {\n\t\tfloat NoV = max(dot(normal, viewDir), 0.000001);\n\t\tfloat NoL = max(dot(normal, light), 0.000001);\n\t\treturn 1.0 / (4.0 * (NoL + NoV - NoL * NoV));\n}\n\nfloat getLightSpecularSheen(vec3 h, vec3 worldNormal, vec3 viewDir, vec3 lightDirNorm, float sheenGloss) {\n\t\tfloat D = sheenD(worldNormal, h, sheenGloss);\n\t\tfloat V = sheenV(worldNormal, viewDir, -lightDirNorm);\n\t\treturn D * V;\n}\n",linearizeDepthPS:"\n\n#ifndef LINEARIZE_DEPTH\n#define LINEARIZE_DEPTH\n\nfloat linearizeDepth(float z, vec4 cameraParams) {\n\t\tif (cameraParams.w == 0.0)\n\t\t\t\treturn (cameraParams.z * cameraParams.y) / (cameraParams.y + z * (cameraParams.z - cameraParams.y));\n\t\telse\n\t\t\t\treturn cameraParams.z + z * (cameraParams.y - cameraParams.z);\n}\n\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params; // x: 1 / camera_far,      y: camera_far,     z: camera_near,        w: is_ortho\n#endif\n\n#ifdef GL2\nfloat linearizeDepth(float z) {\n\t\treturn linearizeDepth(z, camera_params);\n}\n#else\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\t\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\t\treturn dot(rgbaDepth, bitShift);\n}\n#endif\n#endif\n#endif\n",litShaderArgsPS:"\n\nstruct IridescenceArgs\n{\n\t\t// Iridescence effect intensity, range [0..1]\n\t\tfloat intensity;\n\n\t\t// Thickness of the iridescent microfilm layer, value is in nanometers, range [0..1000]\n\t\tfloat thickness;\n};\n\nstruct ClearcoatArgs\n{\n\t\t// The normal used for the clearcoat layer\n\t\tvec3 worldNormal;\n\n\t\t// Intensity of the clearcoat layer, range [0..1]\n\t\tfloat specularity;\n\n\t\t// Glossiness of clearcoat layer, range [0..1]\n\t\tfloat gloss;\n};\n\nstruct SheenArgs\n{\n\t\t// The color of the f0 specularity factor for the sheen layer\n\t\tvec3 specularity;\n\n\t\t// Glossiness of the sheen layer, range [0..1]\n\t\tfloat gloss;\n};\n\nstruct LitShaderArguments {\n\t\t// Normal direction in world space\n\t\tvec3 worldNormal;\n\n\t\t// Transparency\n\t\tfloat opacity;\n\n\t\t// Surface albedo absorbance\n\t\tvec3 albedo;\n\n\t\t// Transmission factor (refraction), range [0..1]\n\t\tfloat transmission;\n\n\t\t// The f0 specularity factor\n\t\tvec3 specularity;\n\n\t\t// Uniform thickness of medium, used by transmission, range [0..inf]\n\t\tfloat thickness;\n\n\t\t// Emission color\n\t\tvec3 emission;\n\n\t\t// Ambient occlusion amount, range [0..1]\n\t\tfloat ao;\n\n\t\t// Light map color\n\t\tvec3 lightmap;\n\n\t\t// Specularity intensity factor, range [0..1]\n\t\tfloat specularityFactor;\n\n\t\t// Light map direction\n\t\tvec3 lightmapDir;\n\n\t\t// The microfacet glossiness factor, range [0..1]\n\t\tfloat gloss;\n\n\t\t// Iridescence extension arguments\n\t\tIridescenceArgs iridescence;\n\n\t\t// Clearcoat extension arguments\n\t\tClearcoatArgs clearcoat;\n\n\t\t// Surface metalness factor, range [0..1]\n\t\tfloat metalness;\n\n\t\t// Sheen extension arguments\n\t\tSheenArgs sheen;\n};\n",ltcPS:'\n// Real-Time Polygonal-Light Shading with Linearly Transformed Cosines\n// by Eric Heitz, Jonathan Dupuy, Stephen Hill and David Neubelt\n// code: https://github.com/selfshadow/ltc_code/\n\nmat3 transposeMat3( const in mat3 m ) {\n\t\tmat3 tmp;\n\t\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\t\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\t\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\t\treturn tmp;\n}\n\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\t\tconst float LUT_SIZE = 64.0;\n\t\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\t\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\t\tfloat dotNV = saturate( dot( N, V ) );\n\t\t// texture parameterized by sqrt( GGX alpha ) and sqrt( 1 - cos( theta ) )\n\t\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\t\tuv = uv * LUT_SCALE + LUT_BIAS;\n\t\treturn uv;\n}\n\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\t\t// Real-Time Area Lighting: a Journey from Research to Production (p.102)\n\t\t// An approximation of the form factor of a horizon-clipped rectangle.\n\t\tfloat l = length( f );\n\t\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\n\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\t\tfloat x = dot( v1, v2 );\n\t\tfloat y = abs( x );\n\t\t// rational polynomial approximation to theta / sin( theta ) / 2PI\n\t\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\t\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\t\tfloat v = a / b;\n\t\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\t\treturn cross( v1, v2 ) * theta_sintheta;\n}\n\nstruct Coords {\n\t\tvec3 coord0;\n\t\tvec3 coord1;\n\t\tvec3 coord2;\n\t\tvec3 coord3;\n};\n\nfloat LTC_EvaluateRect( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in Coords rectCoords) {\n\t\t// bail if point is on back side of plane of light\n\t\t// assumes ccw winding order of light vertices\n\t\tvec3 v1 = rectCoords.coord1 - rectCoords.coord0;\n\t\tvec3 v2 = rectCoords.coord3 - rectCoords.coord0;\n\t\t\n\t\tvec3 lightNormal = cross( v1, v2 );\n\t\t// if( dot( lightNormal, P - rectCoords.coord0 ) < 0.0 ) return 0.0;\n\t\tfloat factor = sign(-dot( lightNormal, P - rectCoords.coord0 ));\n\n\t\t// construct orthonormal basis around N\n\t\tvec3 T1, T2;\n\t\tT1 = normalize( V - N * dot( V, N ) );\n\t\tT2 =  factor * cross( N, T1 ); // negated from paper; possibly due to a different handedness of world coordinate system\n\t\t// compute transform\n\t\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\t\t// transform rect\n\t\tvec3 coords[ 4 ];\n\t\tcoords[ 0 ] = mat * ( rectCoords.coord0 - P );\n\t\tcoords[ 1 ] = mat * ( rectCoords.coord1 - P );\n\t\tcoords[ 2 ] = mat * ( rectCoords.coord2 - P );\n\t\tcoords[ 3 ] = mat * ( rectCoords.coord3 - P );\n\t\t// project rect onto sphere\n\t\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\t\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\t\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\t\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\t\t// calculate vector form factor\n\t\tvec3 vectorFormFactor = vec3( 0.0 );\n\t\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\t\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\t\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\t\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\t\t// adjust for horizon clipping\n\t\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\n\t\treturn result;\n}\n\nCoords dLTCCoords;\nCoords getLTCLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\t\tCoords coords;\n\t\tcoords.coord0 = lightPos + halfWidth - halfHeight;\n\t\tcoords.coord1 = lightPos - halfWidth - halfHeight;\n\t\tcoords.coord2 = lightPos - halfWidth + halfHeight;\n\t\tcoords.coord3 = lightPos + halfWidth + halfHeight;\n\t\treturn coords;\n}\n\nfloat dSphereRadius;\nCoords getSphereLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\t\t// used for simple sphere light falloff\n\t\t// also, the code only handles a spherical light, it cannot be non-uniformly scaled in world space, and so we enforce it here\n\t\tdSphereRadius = max(length(halfWidth), length(halfHeight));\n\n\t\t// Billboard the 2d light quad to reflection vector, as it\'s used for specular. This allows us to use disk math for the sphere.\n\t\tvec3 f = reflect(normalize(lightPos - view_position), vNormalW);\n\t\tvec3 w = normalize(cross(f, halfHeight));\n\t\tvec3 h = normalize(cross(f, w));\n\n\t\treturn getLTCLightCoords(lightPos, w * dSphereRadius, h * dSphereRadius);\n}\n\n// used for LTC LUT texture lookup\nvec2 dLTCUV;\n#ifdef LIT_CLEARCOAT\nvec2 ccLTCUV;\n#endif\nvec2 getLTCLightUV(float gloss, vec3 worldNormal, vec3 viewDir)\n{\n\t\tfloat roughness = max((1.0 - gloss) * (1.0 - gloss), 0.001);\n\t\treturn LTC_Uv( worldNormal, viewDir, roughness );\n}\n\n//used for energy conservation and to modulate specular\nvec3 dLTCSpecFres;\n#ifdef LIT_CLEARCOAT\nvec3 ccLTCSpecFres;\n#endif\nvec3 getLTCLightSpecFres(vec2 uv, vec3 specularity)\n{\n\t\tvec4 t2 = texture2DLodEXT(areaLightsLutTex2, uv, 0.0);\n\n\t\t#ifdef AREA_R8_G8_B8_A8_LUTS\n\t\tt2 *= vec4(0.693103,1,1,1);\n\t\tt2 += vec4(0.306897,0,0,0);\n\t\t#endif\n\n\t\treturn specularity * t2.x + ( vec3( 1.0 ) - specularity) * t2.y;\n}\n\nvoid calcLTCLightValues(float gloss, vec3 worldNormal, vec3 viewDir, vec3 specularity, float clearcoatGloss, vec3 clearcoatWorldNormal, float clearcoatSpecularity)\n{\n\t\tdLTCUV = getLTCLightUV(gloss, worldNormal, viewDir);\n\t\tdLTCSpecFres = getLTCLightSpecFres(dLTCUV, specularity); \n\n#ifdef LIT_CLEARCOAT\n\t\tccLTCUV = getLTCLightUV(clearcoatGloss, clearcoatWorldNormal, viewDir);\n\t\tccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, vec3(clearcoatSpecularity));\n#endif\n}\n\nvoid calcRectLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\t\tdLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);\n}\nvoid calcDiskLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\t\tcalcRectLightValues(lightPos, halfWidth, halfHeight);\n}\nvoid calcSphereLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\t\tdLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);\n}\n\n// An extended version of the implementation from\n// "How to solve a cubic equation, revisited"\n// http://momentsingraphics.de/?p=105\nvec3 SolveCubic(vec4 Coefficient)\n{\n\t\tfloat pi = 3.14159;\n\t\t// Normalize the polynomial\n\t\tCoefficient.xyz /= Coefficient.w;\n\t\t// Divide middle coefficients by three\n\t\tCoefficient.yz /= 3.0;\n\n\t\tfloat A = Coefficient.w;\n\t\tfloat B = Coefficient.z;\n\t\tfloat C = Coefficient.y;\n\t\tfloat D = Coefficient.x;\n\n\t\t// Compute the Hessian and the discriminant\n\t\tvec3 Delta = vec3(\n\t\t\t\t-Coefficient.z * Coefficient.z + Coefficient.y,\n\t\t\t\t-Coefficient.y * Coefficient.z + Coefficient.x,\n\t\t\t\tdot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)\n\t\t);\n\n\t\tfloat Discriminant = dot(vec2(4.0 * Delta.x, -Delta.y), Delta.zy);\n\n\t\tvec3 RootsA, RootsD;\n\n\t\tvec2 xlc, xsc;\n\n\t\t// Algorithm A\n\t\t{\n\t\t\t\tfloat A_a = 1.0;\n\t\t\t\tfloat C_a = Delta.x;\n\t\t\t\tfloat D_a = -2.0 * B * Delta.x + Delta.y;\n\n\t\t\t\t// Take the cubic root of a normalized complex number\n\t\t\t\tfloat Theta = atan(sqrt(Discriminant), -D_a) / 3.0;\n\n\t\t\t\tfloat x_1a = 2.0 * sqrt(-C_a) * cos(Theta);\n\t\t\t\tfloat x_3a = 2.0 * sqrt(-C_a) * cos(Theta + (2.0 / 3.0) * pi);\n\n\t\t\t\tfloat xl;\n\t\t\t\tif ((x_1a + x_3a) > 2.0 * B)\n\t\t\t\t\t\txl = x_1a;\n\t\t\t\telse\n\t\t\t\t\t\txl = x_3a;\n\n\t\t\t\txlc = vec2(xl - B, A);\n\t\t}\n\n\t\t// Algorithm D\n\t\t{\n\t\t\t\tfloat A_d = D;\n\t\t\t\tfloat C_d = Delta.z;\n\t\t\t\tfloat D_d = -D * Delta.y + 2.0 * C * Delta.z;\n\n\t\t\t\t// Take the cubic root of a normalized complex number\n\t\t\t\tfloat Theta = atan(D * sqrt(Discriminant), -D_d) / 3.0;\n\n\t\t\t\tfloat x_1d = 2.0 * sqrt(-C_d) * cos(Theta);\n\t\t\t\tfloat x_3d = 2.0 * sqrt(-C_d) * cos(Theta + (2.0 / 3.0) * pi);\n\n\t\t\t\tfloat xs;\n\t\t\t\tif (x_1d + x_3d < 2.0 * C)\n\t\t\t\t\t\txs = x_1d;\n\t\t\t\telse\n\t\t\t\t\t\txs = x_3d;\n\n\t\t\t\txsc = vec2(-D, xs + C);\n\t\t}\n\n\t\tfloat E =  xlc.y * xsc.y;\n\t\tfloat F = -xlc.x * xsc.y - xlc.y * xsc.x;\n\t\tfloat G =  xlc.x * xsc.x;\n\n\t\tvec2 xmc = vec2(C * F - B * G, -B * F + C * E);\n\n\t\tvec3 Root = vec3(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);\n\n\t\tif (Root.x < Root.y && Root.x < Root.z)\n\t\t\t\tRoot.xyz = Root.yxz;\n\t\telse if (Root.z < Root.x && Root.z < Root.y)\n\t\t\t\tRoot.xyz = Root.xzy;\n\n\t\treturn Root;\n}\n\nfloat LTC_EvaluateDisk(vec3 N, vec3 V, vec3 P, mat3 Minv, Coords points)\n{\n\t\t// construct orthonormal basis around N\n\t\tvec3 T1, T2;\n\t\tT1 = normalize(V - N * dot(V, N));\n\t\tT2 = cross(N, T1);\n\n\t\t// rotate area light in (T1, T2, N) basis\n\t\t//mat3 R = transpose(mat3(T1, T2, N));\n\t\tmat3 R = transposeMat3( mat3( T1, T2, N ) );\n\t\t// polygon (allocate 5 vertices for clipping)\n\t\tvec3 L_[ 3 ];\n\t\tL_[ 0 ] = R * ( points.coord0 - P );\n\t\tL_[ 1 ] = R * ( points.coord1 - P );\n\t\tL_[ 2 ] = R * ( points.coord2 - P );\n\n\t\tvec3 Lo_i = vec3(0);\n\n\t\t// init ellipse\n\t\tvec3 C  = 0.5 * (L_[0] + L_[2]);\n\t\tvec3 V1 = 0.5 * (L_[1] - L_[2]);\n\t\tvec3 V2 = 0.5 * (L_[1] - L_[0]);\n\n\t\tC  = Minv * C;\n\t\tV1 = Minv * V1;\n\t\tV2 = Minv * V2;\n\n\t\t//if(dot(cross(V1, V2), C) > 0.0)\n\t\t//    return 0.0;\n\n\t\t// compute eigenvectors of ellipse\n\t\tfloat a, b;\n\t\tfloat d11 = dot(V1, V1);\n\t\tfloat d22 = dot(V2, V2);\n\t\tfloat d12 = dot(V1, V2);\n\t\tif (abs(d12) / sqrt(d11 * d22) > 0.0001)\n\t\t{\n\t\t\t\tfloat tr = d11 + d22;\n\t\t\t\tfloat det = -d12 * d12 + d11 * d22;\n\n\t\t\t\t// use sqrt matrix to solve for eigenvalues\n\t\t\t\tdet = sqrt(det);\n\t\t\t\tfloat u = 0.5 * sqrt(tr - 2.0 * det);\n\t\t\t\tfloat v = 0.5 * sqrt(tr + 2.0 * det);\n\t\t\t\tfloat e_max = (u + v) * (u + v);\n\t\t\t\tfloat e_min = (u - v) * (u - v);\n\n\t\t\t\tvec3 V1_, V2_;\n\n\t\t\t\tif (d11 > d22)\n\t\t\t\t{\n\t\t\t\t\t\tV1_ = d12 * V1 + (e_max - d11) * V2;\n\t\t\t\t\t\tV2_ = d12 * V1 + (e_min - d11) * V2;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t\tV1_ = d12*V2 + (e_max - d22)*V1;\n\t\t\t\t\t\tV2_ = d12*V2 + (e_min - d22)*V1;\n\t\t\t\t}\n\n\t\t\t\ta = 1.0 / e_max;\n\t\t\t\tb = 1.0 / e_min;\n\t\t\t\tV1 = normalize(V1_);\n\t\t\t\tV2 = normalize(V2_);\n\t\t}\n\t\telse\n\t\t{\n\t\t\t\ta = 1.0 / dot(V1, V1);\n\t\t\t\tb = 1.0 / dot(V2, V2);\n\t\t\t\tV1 *= sqrt(a);\n\t\t\t\tV2 *= sqrt(b);\n\t\t}\n\n\t\tvec3 V3 = cross(V1, V2);\n\t\tif (dot(C, V3) < 0.0)\n\t\t\t\tV3 *= -1.0;\n\n\t\tfloat L  = dot(V3, C);\n\t\tfloat x0 = dot(V1, C) / L;\n\t\tfloat y0 = dot(V2, C) / L;\n\n\t\tfloat E1 = inversesqrt(a);\n\t\tfloat E2 = inversesqrt(b);\n\n\t\ta *= L * L;\n\t\tb *= L * L;\n\n\t\tfloat c0 = a * b;\n\t\tfloat c1 = a * b * (1.0 + x0 * x0 + y0 * y0) - a - b;\n\t\tfloat c2 = 1.0 - a * (1.0 + x0 * x0) - b * (1.0 + y0 * y0);\n\t\tfloat c3 = 1.0;\n\n\t\tvec3 roots = SolveCubic(vec4(c0, c1, c2, c3));\n\t\tfloat e1 = roots.x;\n\t\tfloat e2 = roots.y;\n\t\tfloat e3 = roots.z;\n\n\t\tvec3 avgDir = vec3(a * x0 / (a - e2), b * y0 / (b - e2), 1.0);\n\n\t\tmat3 rotate = mat3(V1, V2, V3);\n\n\t\tavgDir = rotate * avgDir;\n\t\tavgDir = normalize(avgDir);\n\n\t\tfloat L1 = sqrt(-e2 / e3);\n\t\tfloat L2 = sqrt(-e2 / e1);\n\n\t\tfloat formFactor = L1 * L2 * inversesqrt((1.0 + L1 * L1) * (1.0 + L2 * L2));\n\t\t\n\t\tconst float LUT_SIZE = 64.0;\n\t\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\t\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\n\t\t// use tabulated horizon-clipped sphere\n\t\tvec2 uv = vec2(avgDir.z * 0.5 + 0.5, formFactor);\n\t\tuv = uv*LUT_SCALE + LUT_BIAS;\n\n\t\tfloat scale = texture2DLodEXT(areaLightsLutTex2, uv, 0.0).w;\n\n\t\treturn formFactor*scale;\n}\n\nfloat getRectLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n\t\treturn LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\n\nfloat getDiskLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n\t\treturn LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\n\nfloat getSphereLightDiffuse(vec3 worldNormal, vec3 viewDir, vec3 lightDir, vec3 lightDirNorm) {\n\t\t// NB: this could be improved further with distance based wrap lighting\n\t\tfloat falloff = dSphereRadius / (dot(lightDir, lightDir) + dSphereRadius);\n\t\treturn getLightDiffuse(worldNormal, viewDir, lightDir, lightDirNorm) * falloff;\n}\n\nmat3 getLTCLightInvMat(vec2 uv)\n{\n\t\tvec4 t1 = texture2DLodEXT(areaLightsLutTex1, uv, 0.0);\n\n\t\t#ifdef AREA_R8_G8_B8_A8_LUTS\n\t\tt1 *= vec4(1.001, 0.3239, 0.60437568, 1.0);\n\t\tt1 += vec4(0.0, -0.2976, -0.01381, 0.0);\n\t\t#endif\n\n\t\treturn mat3(\n\t\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\t\tvec3(    0, 1,    0 ),\n\t\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n}\n\nfloat calcRectLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {\n\t\tmat3 mInv = getLTCLightInvMat(uv);\n\t\treturn LTC_EvaluateRect( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );\n}\n\nfloat getRectLightSpecular(vec3 worldNormal, vec3 viewDir) {\n\t\treturn calcRectLightSpecular(worldNormal, viewDir, dLTCUV);\n}\n\nfloat calcDiskLightSpecular(vec3 worldNormal, vec3 viewDir, vec2 uv) {\n\t\tmat3 mInv = getLTCLightInvMat(uv);\n\t\treturn LTC_EvaluateDisk( worldNormal, viewDir, vPositionW, mInv, dLTCCoords );\n}\n\nfloat getDiskLightSpecular(vec3 worldNormal, vec3 viewDir) {\n\t\treturn calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);\n}\n\nfloat getSphereLightSpecular(vec3 worldNormal, vec3 viewDir) {\n\t\treturn calcDiskLightSpecular(worldNormal, viewDir, dLTCUV);\n}\n',metalnessPS:"\n#ifdef MAPFLOAT\nuniform float material_metalness;\n#endif\n\nvoid getMetalness() {\n\t\tfloat metalness = 1.0;\n\n\t\t#ifdef MAPFLOAT\n\t\tmetalness *= material_metalness;\n\t\t#endif\n\n\t\t#ifdef MAPTEXTURE\n\t\tmetalness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t\t#endif\n\n\t\t#ifdef MAPVERTEX\n\t\tmetalness *= saturate(vVertexColor.$VC);\n\t\t#endif\n\n\t\tdMetalness = metalness;\n}\n",metalnessModulatePS:"\n\nuniform float material_f0;\n\nvoid getMetalnessModulate(inout LitShaderArguments litShaderArgs) {\n\t\tvec3 dielectricF0 = material_f0 * litShaderArgs.specularity;\n\t\tlitShaderArgs.specularity = mix(dielectricF0, litShaderArgs.albedo, litShaderArgs.metalness);\n\t\tlitShaderArgs.albedo *= 1.0 - litShaderArgs.metalness;\n}\n",msdfPS:"\nuniform sampler2D texture_msdfMap;\n\n#ifdef GL_OES_standard_derivatives\n#define USE_FWIDTH\n#endif\n\n#ifdef GL2\n#define USE_FWIDTH\n#endif\n\nfloat median(float r, float g, float b) {\n\t\treturn max(min(r, g), min(max(r, g), b));\n}\n\nfloat map (float min, float max, float v) {\n\t\treturn (v - min) / (max - min);\n}\n\nuniform float font_sdfIntensity; // intensity is used to boost the value read from the SDF, 0 is no boost, 1.0 is max boost\nuniform float font_pxrange;      // the number of pixels between inside and outside the font in SDF\nuniform float font_textureWidth; // the width of the texture atlas\n\n#ifdef UNIFORM_TEXT_PARAMETERS\nuniform vec4 outline_color;\nuniform float outline_thickness;\nuniform vec4 shadow_color;\nuniform vec2 shadow_offset;\n#else\nvarying vec4 outline_color;\nvarying float outline_thickness;\nvarying vec4 shadow_color;\nvarying vec2 shadow_offset;\n#endif\n\nvec4 applyMsdf(vec4 color) {\n\t\t// sample the field\n\t\tvec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;\n\t\tvec2 uvShdw = vUv0 - shadow_offset;\n\t\tvec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;\n\t\t// get the signed distance value\n\t\tfloat sigDist = median(tsample.r, tsample.g, tsample.b);\n\t\tfloat sigDistShdw = median(ssample.r, ssample.g, ssample.b);\n\n\t\t// smoothing limit - smaller value makes for sharper but more aliased text, especially on angles\n\t\t// too large value (0.5) creates a dark glow around the letters\n\t\tfloat smoothingMax = 0.2;\n\n\t\t#ifdef USE_FWIDTH\n\t\t// smoothing depends on size of texture on screen\n\t\tvec2 w = fwidth(vUv0);\n\t\tfloat smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, smoothingMax);\n\t\t#else\n\t\tfloat font_size = 16.0; // TODO fix this\n\t\t// smoothing gets smaller as the font size gets bigger\n\t\t// don't have fwidth we can approximate from font size, this doesn't account for scaling\n\t\t// so a big font scaled down will be wrong...\n\t\tfloat smoothing = clamp(font_pxrange / font_size, 0.0, smoothingMax);\n\t\t#endif\n\n\t\tfloat mapMin = 0.05;\n\t\tfloat mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n\n\t\t// remap to a smaller range (used on smaller font sizes)\n\t\tfloat sigDistInner = map(mapMin, mapMax, sigDist);\n\t\tfloat sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);\n\t\tsigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);\n\n\t\tfloat center = 0.5;\n\t\t// calculate smoothing and use to generate opacity\n\t\tfloat inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);\n\t\tfloat outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);\n\t\tfloat shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);\n\n\t\tvec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);\n\t\ttcolor = mix(tcolor, color, inside);\n\n\t\tvec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;\n\t\ttcolor = mix(scolor, tcolor, outline);\n\t\t\n\t\treturn tcolor;\n}\n",msdfVS:"\nattribute vec3 vertex_outlineParameters;\nattribute vec3 vertex_shadowParameters;\n\nvarying vec4 outline_color;\nvarying float outline_thickness;\nvarying vec4 shadow_color;\nvarying vec2 shadow_offset;\n\nvoid unpackMsdfParams() {\n\t\tvec3 little = mod(vertex_outlineParameters, 256.);\n\t\tvec3 big = (vertex_outlineParameters - little) / 256.;\n\n\t\toutline_color.rb = little.xy / 255.;\n\t\toutline_color.ga = big.xy / 255.;\n\n\t\t// _outlineThicknessScale === 0.2\n\t\toutline_thickness = little.z / 255. * 0.2;\n\n\t\tlittle = mod(vertex_shadowParameters, 256.);\n\t\tbig = (vertex_shadowParameters - little) / 256.;\n\n\t\tshadow_color.rb = little.xy / 255.;\n\t\tshadow_color.ga = big.xy / 255.;\n\n\t\t// vec2(little.z, big.z) / 127. - 1. remaps shadow offset from [0, 254] to [-1, 1]\n\t\t// _shadowOffsetScale === 0.005\n\t\tshadow_offset = (vec2(little.z, big.z) / 127. - 1.) * 0.005;\n}\n",normalVS:"\n#ifdef MORPHING_TEXTURE_BASED_NORMAL\nuniform highp sampler2D morphNormalTex;\n#endif\n\nvec3 getNormal() {\n\t\t#ifdef SKIN\n\t\tdNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n\t\t#elif defined(INSTANCING)\n\t\tdNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n\t\t#else\n\t\tdNormalMatrix = matrix_normal;\n\t\t#endif\n\n\t\tvec3 tempNormal = vertex_normal;\n\n\t\t#ifdef MORPHING\n\t\t#ifdef MORPHING_NRM03\n\t\ttempNormal += morph_weights_a[0] * morph_nrm0;\n\t\ttempNormal += morph_weights_a[1] * morph_nrm1;\n\t\ttempNormal += morph_weights_a[2] * morph_nrm2;\n\t\ttempNormal += morph_weights_a[3] * morph_nrm3;\n\t\t#endif\n\t\t#ifdef MORPHING_NRM47\n\t\ttempNormal += morph_weights_b[0] * morph_nrm4;\n\t\ttempNormal += morph_weights_b[1] * morph_nrm5;\n\t\ttempNormal += morph_weights_b[2] * morph_nrm6;\n\t\ttempNormal += morph_weights_b[3] * morph_nrm7;\n\t\t#endif\n\t\t#endif\n\n\t\t#ifdef MORPHING_TEXTURE_BASED_NORMAL\n\n\t\t\t\t#ifdef WEBGPU\n\t\t\t\t\t\tivec2 morphUV = getTextureMorphCoords();\n\t\t\t\t\t\tvec3 morphNormal = texelFetch(morphNormalTex, ivec2(morphUV), 0).xyz;\n\t\t\t\t#else\n\t\t\t\t\t\tvec2 morphUV = getTextureMorphCoords();\n\t\t\t\t\t\tvec3 morphNormal = texture2D(morphNormalTex, morphUV).xyz;\n\t\t\t\t#endif\n\n\t\t// apply morph offset from texture\n\t\ttempNormal += morphNormal;\n\t\t#endif\n\n\t\treturn normalize(dNormalMatrix * tempNormal);\n}\n",normalDetailMapPS:"\n#ifdef MAPTEXTURE\nuniform float material_normalDetailMapBumpiness;\n\nvec3 blendNormals(vec3 n1, vec3 n2) {\n\t\t// https://blog.selfshadow.com/publications/blending-in-detail/#detail-oriented\n\t\tn1 += vec3(0, 0, 1);\n\t\tn2 *= vec3(-1, -1, 1);\n\t\treturn n1 * dot(n1, n2) / n1.z - n2;\n}\n#endif\n\nvec3 addNormalDetail(vec3 normalMap) {\n#ifdef MAPTEXTURE\n\t\tvec3 normalDetailMap = unpackNormal(texture2DBias($SAMPLER, $UV, textureBias));\n\t\tnormalDetailMap = mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness);\n\t\treturn blendNormals(normalMap, normalDetailMap);\n#else\n\t\treturn normalMap;\n#endif\n}\n",normalInstancedVS:"\nvec3 getNormal() {\n\t\tdNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n\t\treturn normalize(dNormalMatrix * vertex_normal);\n}\n",normalMapPS:"\n#ifdef MAPTEXTURE\nuniform float material_bumpiness;\n#endif\n\nvoid getNormal() {\n#ifdef MAPTEXTURE\n\t\tvec3 normalMap = unpackNormal(texture2DBias($SAMPLER, $UV, textureBias));\n\t\tnormalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness);\n\t\tdNormalW = normalize(dTBN * addNormalDetail(normalMap));\n#else\n\t\tdNormalW = dVertexNormalW;\n#endif\n}\n",normalSkinnedVS:"\nvec3 getNormal() {\n\t\tdNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n\t\treturn normalize(dNormalMatrix * vertex_normal);\n}\n",normalXYPS:"\nvec3 unpackNormal(vec4 nmap) {\n\t\tvec3 normal;\n\t\tnormal.xy = nmap.wy * 2.0 - 1.0;\n\t\tnormal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));\n\t\treturn normal;\n}\n",normalXYZPS:"\nvec3 unpackNormal(vec4 nmap) {\n\t\treturn nmap.xyz * 2.0 - 1.0;\n}\n",opacityPS:"\n#ifdef MAPFLOAT\nuniform float material_opacity;\n#endif\n\nvoid getOpacity() {\n\t\tdAlpha = 1.0;\n\n\t\t#ifdef MAPFLOAT\n\t\tdAlpha *= material_opacity;\n\t\t#endif\n\n\t\t#ifdef MAPTEXTURE\n\t\tdAlpha *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t\t#endif\n\n\t\t#ifdef MAPVERTEX\n\t\tdAlpha *= clamp(vVertexColor.$VC, 0.0, 1.0);\n\t\t#endif\n}\n",outputPS:"\n",outputAlphaPS:"\ngl_FragColor.a = litShaderArgs.opacity;\n",outputAlphaOpaquePS:"\n\t\tgl_FragColor.a = 1.0;\n",outputAlphaPremulPS:"\ngl_FragColor.rgb *= litShaderArgs.opacity;\ngl_FragColor.a = litShaderArgs.opacity;\n",outputTex2DPS:"\nvarying vec2 vUv0;\n\nuniform sampler2D source;\n\nvoid main(void) {\n\t\tgl_FragColor = texture2D(source, vUv0);\n}\n",packDepthPS:"\n// Packing a float in GLSL with multiplication and mod\n// http://blog.gradientstudios.com/2012/08/23/shadow-map-improvement\nvec4 packFloat(float depth) {\n\t\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\t\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\n\t\t// combination of mod and multiplication and division works better\n\t\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\t\tres -= res.xxyz * bit_mask;\n\t\treturn res;\n}\n",sheenPS:"\n\n#ifdef MAPCOLOR\nuniform vec3 material_sheen;\n#endif\n\nvoid getSheen() {\n\t\tvec3 sheenColor = vec3(1, 1, 1);\n\n\t\t#ifdef MAPCOLOR\n\t\tsheenColor *= material_sheen;\n\t\t#endif\n\n\t\t#ifdef MAPTEXTURE\n\t\tsheenColor *= $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n\t\t#endif\n\n\t\t#ifdef MAPVERTEX\n\t\tsheenColor *= saturate(vVertexColor.$VC);\n\t\t#endif\n\n\t\tsSpecularity = sheenColor;\n}\n",sheenGlossPS:"\n#ifdef MAPFLOAT\nuniform float material_sheenGloss;\n#endif\n\nvoid getSheenGlossiness() {\n\t\tfloat sheenGlossiness = 1.0;\n\n\t\t#ifdef MAPFLOAT\n\t\tsheenGlossiness *= material_sheenGloss;\n\t\t#endif\n\n\t\t#ifdef MAPTEXTURE\n\t\tsheenGlossiness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t\t#endif\n\n\t\t#ifdef MAPVERTEX\n\t\tsheenGlossiness *= saturate(vVertexColor.$VC);\n\t\t#endif\n\n\t\t#ifdef MAPINVERT\n\t\tsheenGlossiness = 1.0 - sheenGlossiness;\n\t\t#endif\n\n\t\tsheenGlossiness += 0.0000001;\n\t\tsGlossiness = sheenGlossiness;\n}\n",parallaxPS:"\nuniform float material_heightMapFactor;\n\nvoid getParallax() {\n\t\tfloat parallaxScale = material_heightMapFactor;\n\n\t\tfloat height = texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t\theight = height * parallaxScale - parallaxScale*0.5;\n\t\tvec3 viewDirT = dViewDirW * dTBN;\n\n\t\tviewDirT.z += 0.42;\n\t\tdUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n",particlePS:"\nvarying vec4 texCoordsAlphaLife;\n\nuniform sampler2D colorMap;\nuniform sampler2D colorParam;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\n\nuniform float softening;\nuniform float colorMult;\n\nfloat saturate(float x) {\n\t\treturn clamp(x, 0.0, 1.0);\n}\n\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\t\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\t\tfloat depth = dot(rgbaDepth, bitShift);\n\t\treturn depth;\n}\n#endif\n\nvoid main(void) {\n\t\tvec4 tex  = gammaCorrectInput(texture2D(colorMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y)));\n\t\tvec4 ramp = gammaCorrectInput(texture2D(colorParam, vec2(texCoordsAlphaLife.w, 0.0)));\n\t\tramp.rgb *= colorMult;\n\n\t\tramp.a += texCoordsAlphaLife.z;\n\n\t\tvec3 rgb = tex.rgb * ramp.rgb;\n\t\tfloat a  = tex.a * ramp.a;\n",particleVS:"\nvec3 unpack3NFloats(float src) {\n\t\tfloat r = fract(src);\n\t\tfloat g = fract(src * 256.0);\n\t\tfloat b = fract(src * 65536.0);\n\t\treturn vec3(r, g, b);\n}\n\nfloat saturate(float x) {\n\t\treturn clamp(x, 0.0, 1.0);\n}\n\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc) {\n\t\treturn mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\n\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n\t\tvec4 a = texture2D(tex,tc);\n\t\tvec4 b = texture2D(tex,tc + graphSampleSize);\n\t\tfloat c = fract(tc.x*graphNumSamples);\n\n\t\tvec3 unpackedA = unpack3NFloats(a.w);\n\t\tvec3 unpackedB = unpack3NFloats(b.w);\n\t\tw = mix(unpackedA, unpackedB, c);\n\n\t\treturn mix(a, b, c);\n}\n\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n\t\tfloat c = cos(pRotation);\n\t\tfloat s = sin(pRotation);\n\n\t\tmat2 m = mat2(c, -s, s, c);\n\t\trotMatrix = m;\n\n\t\treturn m * quadXY;\n}\n\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY) {\n\t\t#ifdef SCREEN_SPACE\n\t\t\t\tvec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;\n\t\t#else\n\t\t\t\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\t\t#endif\n\n\t\treturn pos;\n}\n\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY) {\n\t\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\t\treturn pos;\n}\n\nvec2 safeNormalize(vec2 v) {\n\t\tfloat l = length(v);\n\t\treturn (l > 1e-06) ? v / l : v;\n}\n\nvoid main(void) {\n\t\tvec3 meshLocalPos = particle_vertexData.xyz;\n\t\tfloat id = floor(particle_vertexData.w);\n\n\t\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\t\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\n\t\tfloat uv = id / numParticlesPot;\n\t\treadInput(uv);\n\n#ifdef LOCAL_SPACE\n\t\tinVel = mat3(matrix_model) * inVel;\n#endif\n\t\tvec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy); // should be removed by compiler if align/stretch is not used\n\n\t\tfloat particleLifetime = lifetime;\n\n\t\tif (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);\n\t\tvec2 quadXY = meshLocalPos.xy;\n\t\tfloat nlife = clamp(inLife / particleLifetime, 0.0, 1.0);\n\n\t\tvec3 paramDiv;\n\t\tvec4 params = tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n\t\tfloat scale = params.y;\n\t\tfloat scaleDiv = paramDiv.x;\n\t\tfloat alphaDiv = paramDiv.z;\n\n\t\tscale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n\n#ifndef USE_MESH\n\t\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#else\n\t\ttexCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#endif\n\n\t\tvec3 particlePos = inPos;\n\t\tvec3 particlePosMoved = vec3(0.0);\n\n\t\tmat2 rotMatrix;\n",particleAnimFrameClampVS:"\n\t\tfloat animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);\n",particleAnimFrameLoopVS:"\n\t\tfloat animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));\n",particleAnimTexVS:"\n\t\tfloat animationIndex;\n\n\t\tif (animTexIndexParams.y == 1.0) {\n\t\t\t\tanimationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);\n\t\t} else {\n\t\t\t\tanimationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);\n\t\t}\n\n\t\tfloat atlasX = (animationIndex + animFrame) * animTexTilesParams.x;\n\t\tfloat atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;\n\t\tatlasX = fract(atlasX);\n\n\t\ttexCoordsAlphaLife.xy *= animTexTilesParams.xy;\n\t\ttexCoordsAlphaLife.xy += vec2(atlasX, atlasY);\n",particleInputFloatPS:"\nvoid readInput(float uv) {\n\t\tvec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));\n\t\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));\n\n\t\tinPos = tex.xyz;\n\t\tinVel = tex2.xyz;\n\t\tinAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;\n\t\tinShow = tex.w >= 0.0;\n\t\tinLife = tex2.w;\n}\n",particleInputRgba8PS:"\n//RG=X, BA=Y\n//RG=Z, BA=A\n//RGB=V, A=visMode\n//RGBA=life\n\n#define PI2 6.283185307179586\n\nuniform vec3 inBoundsSize;\nuniform vec3 inBoundsCenter;\n\nuniform float maxVel;\n\nfloat decodeFloatRG(vec2 rg) {\n\t\treturn rg.y*(1.0/255.0) + rg.x;\n}\n\nfloat decodeFloatRGBA( vec4 rgba ) {\n\treturn dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );\n}\n\nvoid readInput(float uv) {\n\t\tvec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));\n\t\tvec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));\n\t\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));\n\t\tvec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));\n\n\t\tinPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));\n\t\tinPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;\n\n\t\tinVel = tex2.xyz;\n\t\tinVel = (inVel - vec3(0.5)) * maxVel;\n\n\t\tinAngle = decodeFloatRG(tex1.ba) * PI2;\n\t\tinShow = tex2.a > 0.5;\n\n\t\tinLife = decodeFloatRGBA(tex3);\n\t\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\t\tfloat maxPosLife = lifetime+1.0;\n\t\tinLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;\n}\n",particleOutputFloatPS:"\nvoid writeOutput() {\n\t\tif (gl_FragCoord.y<1.0) {\n\t\t\t\tgl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);\n\t\t} else {\n\t\t\t\tgl_FragColor = vec4(outVel, outLife);\n\t\t}\n}\n",particleOutputRgba8PS:"\nuniform vec3 outBoundsMul;\nuniform vec3 outBoundsAdd;\n\nvec2 encodeFloatRG( float v ) {\n\t\tvec2 enc = vec2(1.0, 255.0) * v;\n\t\tenc = fract(enc);\n\t\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\t\treturn enc;\n}\n\nvec4 encodeFloatRGBA( float v ) {\n\t\tvec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;\n\t\tenc = fract(enc);\n\t\tenc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n\t\treturn enc;\n}\n\nvoid writeOutput() {\n\t\toutPos = outPos * outBoundsMul + outBoundsAdd;\n\t\toutAngle = fract(outAngle / PI2);\n\n\t\toutVel = (outVel / maxVel) + vec3(0.5); // TODO: mul\n\n\t\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\t\tfloat maxPosLife = lifetime+1.0;\n\t\toutLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);\n\n\t\tif (gl_FragCoord.y < 1.0) {\n\t\t\t\tgl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));\n\t\t} else if (gl_FragCoord.y < 2.0) {\n\t\t\t\tgl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));\n\t\t} else if (gl_FragCoord.y < 3.0) {\n\t\t\t\tgl_FragColor = vec4(outVel, visMode*0.5+0.5);\n\t\t} else {\n\t\t\t\tgl_FragColor = encodeFloatRGBA(outLife);\n\t\t}\n}\n",particleUpdaterAABBPS:"\nuniform mat3 spawnBounds;\nuniform vec3 spawnPosInnerRatio;\n\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\t\tvec3 pos = inBounds - vec3(0.5);\n\n\t\tvec3 posAbs = abs(pos);\n\t\tvec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));\n\n\t\tvec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;\n\n\t\tpos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);\n\t\tpos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);\n\t\tpos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);\n\n#ifndef LOCAL_SPACE\n\t\treturn emitterPos + spawnBounds * pos;\n#else\n\t\treturn spawnBounds * pos;\n#endif\n}\n\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\t\tlocalVelocity -= vec3(0, 0, initialVelocity);\n}\n",particleUpdaterEndPS:"\n\t\twriteOutput();\n}\n",particleUpdaterInitPS:"\nvarying vec2 vUv0;\n\nuniform highp sampler2D particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform highp sampler2D internalTex3;\n\nuniform mat3 emitterMatrix, emitterMatrixInv;\nuniform vec3 emitterScale;\n\nuniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;\nuniform float delta, rate, rateDiv, lifetime, numParticles, rotSpeedDivMult, radialSpeedDivMult, seed;\nuniform float startAngle, startAngle2;\nuniform float initialVelocity;\n\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\nfloat visMode;\n\nvec3 outPos;\nvec3 outVel;\nfloat outAngle;\nbool outShow;\nfloat outLife;\n",particleUpdaterNoRespawnPS:"\n\t\tif (outLife >= lifetime) {\n\t\t\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\t\t\tvisMode = -1.0;\n\t\t}\n",particleUpdaterOnStopPS:"\n\t\tvisMode = outLife < 0.0? -1.0: visMode;\n",particleUpdaterRespawnPS:"\n\t\tif (outLife >= lifetime) {\n\t\t\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\t\t\tvisMode = 1.0;\n\t\t}\n\t\tvisMode = outLife < 0.0? 1.0: visMode;\n",particleUpdaterSpherePS:"\nuniform float spawnBoundsSphere;\nuniform float spawnBoundsSphereInnerRatio;\n\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\t\tfloat rnd4 = fract(rndFactor * 1000.0);\n\t\tvec3 norm = normalize(inBounds.xyz - vec3(0.5));\n\t\tfloat r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;\n#ifndef LOCAL_SPACE\n\t\treturn emitterPos + norm * r * spawnBoundsSphere;\n#else\n\t\treturn norm * r * spawnBoundsSphere;\n#endif\n}\n\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\t\tlocalVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n",particleUpdaterStartPS:"\nfloat saturate(float x) {\n\t\treturn clamp(x, 0.0, 1.0);\n}\n\nvec3 unpack3NFloats(float src) {\n\t\tfloat r = fract(src);\n\t\tfloat g = fract(src * 256.0);\n\t\tfloat b = fract(src * 65536.0);\n\t\treturn vec3(r, g, b);\n}\n\nvec3 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n\t\tvec4 a = texture2D(tex, tc);\n\t\tvec4 b = texture2D(tex, tc + graphSampleSize);\n\t\tfloat c = fract(tc.x * graphNumSamples);\n\n\t\tvec3 unpackedA = unpack3NFloats(a.w);\n\t\tvec3 unpackedB = unpack3NFloats(b.w);\n\t\tw = mix(unpackedA, unpackedB, c);\n\n\t\treturn mix(a.xyz, b.xyz, c);\n}\n\n#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)\nvec4 hash41(float p) {\n\t\tvec4 p4 = fract(vec4(p) * HASHSCALE4);\n\t\tp4 += dot(p4, p4.wzxy+19.19);\n\t\treturn fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));\n}\n\nvoid main(void) {\n\t\tif (gl_FragCoord.x > numParticles) discard;\n\n\t\treadInput(vUv0.x);\n\t\tvisMode = inShow? 1.0 : -1.0;\n\n\t\tvec4 rndFactor = hash41(gl_FragCoord.x + seed);\n\n\t\tfloat particleRate = rate + rateDiv * rndFactor.x;\n\n\t\toutLife = inLife + delta;\n\t\tfloat nlife = clamp(outLife / lifetime, 0.0, 1.0);\n\n\t\tvec3 localVelocityDiv;\n\t\tvec3 velocityDiv;\n\t\tvec3 paramDiv;\n\t\tvec3 localVelocity = tex1Dlod_lerp(internalTex0, vec2(nlife, 0), localVelocityDiv);\n\t\tvec3 velocity =      tex1Dlod_lerp(internalTex1, vec2(nlife, 0), velocityDiv);\n\t\tvec3 params =        tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n\t\tfloat rotSpeed = params.x;\n\t\tfloat rotSpeedDiv = paramDiv.y;\n\n\t\tvec3 radialParams = tex1Dlod_lerp(internalTex3, vec2(nlife, 0), paramDiv);\n\t\tfloat radialSpeed = radialParams.x;\n\t\tfloat radialSpeedDiv = radialParams.y;\n\n\t\tbool respawn = inLife <= 0.0 || outLife >= lifetime;\n\t\tinPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;\n\t\tinAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;\n\n#ifndef LOCAL_SPACE\n\t\tvec3 radialVel = inPos - emitterPos;\n#else\n\t\tvec3 radialVel = inPos;\n#endif\n\t\tradialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);\n\t\tradialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;\n\n\t\tlocalVelocity +=    (localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n\t\tvelocity +=         (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;\n\t\trotSpeed +=         (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n\n\t\taddInitialVelocity(localVelocity, rndFactor.xyz);\n\n#ifndef LOCAL_SPACE\n\t\toutVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;\n#else\n\t\toutVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;\n#endif\n\n\t\toutPos = inPos + outVel * delta;\n\t\toutAngle = inAngle + rotSpeed * delta;\n",particle_billboardVS:"\n\t\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\t\tvec3 localPos = billboard(particlePos, quadXY);\n",particle_blendAddPS:"\n\t\tdBlendModeFogFactor = 0.0;\n\t\trgb *= saturate(gammaCorrectInput(max(a, 0.0)));\n\t\tif ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n",particle_blendMultiplyPS:"\n\t\trgb = mix(vec3(1.0), rgb, vec3(a));\n\t\tif (rgb.r + rgb.g + rgb.b > 2.99) discard;\n",particle_blendNormalPS:"\n\t\tif (a < 0.01) discard;\n",particle_cpuVS:"\nattribute vec4 particle_vertexData;   // XYZ = world pos, W = life\nattribute vec4 particle_vertexData2;  // X = angle, Y = scale, Z = alpha, W = velocity.x\nattribute vec4 particle_vertexData3;  // XYZ = particle local pos, W = velocity.y\nattribute float particle_vertexData4; // particle id\n\n// type depends on useMesh property. Start with X = velocity.z, Y = particle ID and for mesh particles proceeds with Z = mesh UV.x, W = mesh UV.y\n#ifndef USE_MESH\nattribute vec2 particle_vertexData5;\n#else\nattribute vec4 particle_vertexData5;\n#endif\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\nuniform float seed;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale;\nuniform vec3 faceTangent;\nuniform vec3 faceBinorm;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform vec3 emitterPos;\n\nvarying vec4 texCoordsAlphaLife;\n\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n\t\tfloat c = cos(pRotation);\n\t\tfloat s = sin(pRotation);\n\t\t//vec4 rotationMatrix = vec4(c, -s, s, c);\n\n\t\tmat2 m = mat2(c, -s, s, c);\n\t\trotMatrix = m;\n\n\t\treturn m * quadXY;\n}\n\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY)\n{\n\t\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\t\treturn pos;\n}\n\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY)\n{\n\t\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\t\treturn pos;\n}\n\nvoid main(void)\n{\n\t\tvec3 particlePos = particle_vertexData.xyz;\n\t\tvec3 inPos = particlePos;\n\t\tvec3 vertPos = particle_vertexData3.xyz;\n\t\tvec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);\n\n\t\tfloat id = floor(particle_vertexData4);\n\t\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\t\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\n#ifdef LOCAL_SPACE\n\t\tinVel = mat3(matrix_model) * inVel;\n#endif\n\t\tvec2 velocityV = normalize((mat3(matrix_view) * inVel).xy); // should be removed by compiler if align/stretch is not used\n\n\t\tvec2 quadXY = vertPos.xy;\n\n#ifdef USE_MESH\n\t\ttexCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);\n#else\n\t\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n#endif\n\t\tmat2 rotMatrix;\n\n\t\tfloat inAngle = particle_vertexData2.x;\n\t\tvec3 particlePosMoved = vec3(0.0);\n\t\tvec3 meshLocalPos = particle_vertexData3.xyz;\n",particle_cpu_endVS:"\n\t\tlocalPos *= particle_vertexData2.y * emitterScale;\n\t\tlocalPos += particlePos;\n\n\t\tgl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n",particle_customFaceVS:"\n\t\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\t\tvec3 localPos = customFace(particlePos, quadXY);\n",particle_endPS:"\n\t\trgb = addFog(rgb);\n\t\trgb = toneMap(rgb);\n\t\trgb = gammaCorrectOutput(rgb);\n\t\tgl_FragColor = vec4(rgb, a);\n}\n",particle_endVS:"\n\t\tlocalPos *= scale * emitterScale;\n\t\tlocalPos += particlePos;\n\n\t\t#ifdef SCREEN_SPACE\n\t\tgl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);\n\t\t#else\n\t\tgl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n\t\t#endif\n",particle_halflambertPS:"\n\t\tvec3 negNormal = normal*0.5+0.5;\n\t\tvec3 posNormal = -normal*0.5+0.5;\n\t\tnegNormal *= negNormal;\n\t\tposNormal *= posNormal;\n",particle_initVS:"\nattribute vec4 particle_vertexData; // XYZ = particle position, W = particle ID + random factor\n#ifdef USE_MESH\nattribute vec2 particle_uv;         // mesh UV\n#endif\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n\nuniform float numParticles, numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale, emitterPos, faceTangent, faceBinorm;\nuniform float rate, rateDiv, lifetime, deltaRandomnessStatic, scaleDivMult, alphaDivMult, seed, delta;\nuniform sampler2D particleTexOUT, particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\n\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\n\nvarying vec4 texCoordsAlphaLife;\n\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\n",particle_lambertPS:"\n\t\tvec3 negNormal = max(normal, vec3(0.0));\n\t\tvec3 posNormal = max(-normal, vec3(0.0));\n",particle_lightingPS:"\n\t\tvec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n\t\t\t\t\t\t\t\t\t\t\t\tnegNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n\t\t\t\t\t\t\t\t\t\t\t\tnegNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n\n\t\trgb *= light;\n",particle_localShiftVS:"\n\t\tparticlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;\n",particle_meshVS:"\n\t\tvec3 localPos = meshLocalPos;\n\t\tlocalPos.xy = rotate(localPos.xy, inAngle, rotMatrix);\n\t\tlocalPos.yz = rotate(localPos.yz, inAngle, rotMatrix);\n\n\t\tbillboard(particlePos, quadXY);\n",particle_normalVS:"\n\t\tNormal = normalize(localPos + matrix_viewInverse[2].xyz);\n",particle_normalMapPS:"\n\t\tvec3 normalMap = normalize(texture2D(normalMap, vec2(texCoordsAlphaLife.x, 1.0 - texCoordsAlphaLife.y)).xyz * 2.0 - 1.0);\n\t\tvec3 normal = ParticleMat * normalMap;\n",particle_pointAlongVS:"\n\t\tinAngle = atan(velocityV.x, velocityV.y); // not the fastest way, but easier to plug in; TODO: create rot matrix right from vectors\n\n",particle_softPS:"\n\t\tfloat depth = getLinearScreenDepth();\n\t\tfloat particleDepth = vDepth;\n\t\tfloat depthDiff = saturate(abs(particleDepth - depth) * softening);\n\t\ta *= depthDiff;\n",particle_softVS:"\n\t\tvDepth = getLinearDepth(localPos);\n",particle_stretchVS:"\n\t\tvec3 moveDir = inVel * stretch;\n\t\tvec3 posPrev = particlePos - moveDir;\n\t\tposPrev += particlePosMoved;\n\n\t\tvec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n\n\t\tfloat interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n\n\t\tparticlePos = mix(particlePos, posPrev, interpolation);\n",particle_TBNVS:"\n\t\tmat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0, rotMatrix[1][0], rotMatrix[1][1], 0.0, 0.0, 0.0, 1.0);\n\t\tParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;\n",particle_wrapVS:"\n\t\tvec3 origParticlePos = particlePos;\n\t\tparticlePos -= matrix_model[3].xyz;\n\t\tparticlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n\t\tparticlePos += matrix_model[3].xyz;\n\t\tparticlePosMoved = particlePos - origParticlePos;\n",reflDirPS:"\nvoid getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {\n\t\tdReflDirW = normalize(-reflect(viewDir, worldNormal));\n}\n",reflDirAnisoPS:"\nvoid getReflDir(vec3 worldNormal, vec3 viewDir, float gloss, mat3 tbn) {\n\t\tfloat roughness = sqrt(1.0 - min(gloss, 1.0));\n\t\tfloat anisotropy = material_anisotropy * roughness;\n\t\tvec3 anisotropicDirection = anisotropy >= 0.0 ? tbn[1] : tbn[0];\n\t\tvec3 anisotropicTangent = cross(anisotropicDirection, viewDir);\n\t\tvec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);\n\t\tvec3 bentNormal = normalize(mix(normalize(worldNormal), normalize(anisotropicNormal), anisotropy));\n\t\tdReflDirW = reflect(-viewDir, bentNormal);\n}\n",reflectionCCPS:"\n#ifdef LIT_CLEARCOAT\nvoid addReflectionCC(vec3 reflDir, float gloss) {\n\t\tccReflection += calcReflection(reflDir, gloss);\n}\n#endif\n",reflectionCubePS:"\nuniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\n\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\t\tvec3 lookupVec = fixSeams(cubeMapProject(reflDir));\n\t\tlookupVec.x *= -1.0;\n\t\treturn $DECODE(textureCube(texture_cubeMap, lookupVec));\n}\n\nvoid addReflection(vec3 reflDir, float gloss) {   \n\t\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionEnvHQPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\nuniform sampler2D texture_envAtlas;\n#endif\nuniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\n\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\t\tvec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);\n\t\tvec2 uv = toSphericalUv(dir);\n\n\t\t// calculate roughness level\n\t\tfloat level = saturate(1.0 - gloss) * 5.0;\n\t\tfloat ilevel = floor(level);\n\t\tfloat flevel = level - ilevel;\n\n\t\tvec3 sharp = $DECODE_CUBEMAP(textureCube(texture_cubeMap, fixSeams(dir)));\n\t\tvec3 roughA = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel)));\n\t\tvec3 roughB = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));\n\n\t\treturn processEnvironment(mix(sharp, mix(roughA, roughB, flevel), min(level, 1.0)));\n}\n\nvoid addReflection(vec3 reflDir, float gloss) {   \n\t\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionEnvPS:"\n#ifndef ENV_ATLAS\n#define ENV_ATLAS\nuniform sampler2D texture_envAtlas;\n#endif\nuniform float material_reflectivity;\n\n// calculate mip level for shiny reflection given equirect coords uv.\nfloat shinyMipLevel(vec2 uv) {\n\t\tvec2 dx = dFdx(uv);\n\t\tvec2 dy = dFdy(uv);\n\n\t\t// calculate second dF at 180 degrees\n\t\tvec2 uv2 = vec2(fract(uv.x + 0.5), uv.y);\n\t\tvec2 dx2 = dFdx(uv2);\n\t\tvec2 dy2 = dFdy(uv2);\n\n\t\t// calculate min of both sets of dF to handle discontinuity at the azim edge\n\t\tfloat maxd = min(max(dot(dx, dx), dot(dy, dy)), max(dot(dx2, dx2), dot(dy2, dy2)));\n\n\t\treturn clamp(0.5 * log2(maxd) - 1.0 + textureBias, 0.0, 5.0);\n}\n\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\t\tvec3 dir = cubeMapProject(reflDir) * vec3(-1.0, 1.0, 1.0);\n\t\tvec2 uv = toSphericalUv(dir);\n\n\t\t// calculate roughness level\n\t\tfloat level = saturate(1.0 - gloss) * 5.0;\n\t\tfloat ilevel = floor(level);\n\n\t\t// accessing the shiny (top level) reflection - perform manual mipmap lookup\n\t\tfloat level2 = shinyMipLevel(uv * atlasSize);\n\t\tfloat ilevel2 = floor(level2);\n\n\t\tvec2 uv0, uv1;\n\t\tfloat weight;\n\t\tif (ilevel == 0.0) {\n\t\t\t\tuv0 = mapShinyUv(uv, ilevel2);\n\t\t\t\tuv1 = mapShinyUv(uv, ilevel2 + 1.0);\n\t\t\t\tweight = level2 - ilevel2;\n\t\t} else {\n\t\t\t\t// accessing rough reflection - just sample the same part twice\n\t\t\t\tuv0 = uv1 = mapRoughnessUv(uv, ilevel);\n\t\t\t\tweight = 0.0;\n\t\t}\n\n\t\tvec3 linearA = $DECODE(texture2D(texture_envAtlas, uv0));\n\t\tvec3 linearB = $DECODE(texture2D(texture_envAtlas, uv1));\n\t\tvec3 linear0 = mix(linearA, linearB, weight);\n\t\tvec3 linear1 = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, ilevel + 1.0)));\n\n\t\treturn processEnvironment(mix(linear0, linear1, level - ilevel));\n}\n\nvoid addReflection(vec3 reflDir, float gloss) {   \n\t\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionSpherePS:"\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\n\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\t\tvec3 reflDirV = (mat3(matrix_view) * reflDir).xyz;\n\n\t\tfloat m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n\t\tvec2 sphereMapUv = reflDirV.xy / m + 0.5;\n\n\t\treturn $DECODE(texture2D(texture_sphereMap, sphereMapUv));\n}\n\nvoid addReflection(vec3 reflDir, float gloss) {   \n\t\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionSphereLowPS:"\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\n\nvec3 calcReflection(vec3 reflDir, float gloss) {\n\t\tvec3 reflDirV = vNormalV;\n\n\t\tvec2 sphereMapUv = reflDirV.xy * 0.5 + 0.5;\n\t\treturn $DECODE(texture2D(texture_sphereMap, sphereMapUv));\n}\n\nvoid addReflection(vec3 reflDir, float gloss) {   \n\t\tdReflection += vec4(calcReflection(reflDir, gloss), material_reflectivity);\n}\n",reflectionSheenPS:"\n\nvoid addReflectionSheen(vec3 worldNormal, vec3 viewDir, float gloss) {\n\t\tfloat NoV = dot(worldNormal, viewDir);\n\t\tfloat alphaG = gloss * gloss;\n\n\t\t// Avoid using a LUT and approximate the values analytically\n\t\tfloat a = gloss < 0.25 ? -339.2 * alphaG + 161.4 * gloss - 25.9 : -8.48 * alphaG + 14.3 * gloss - 9.95;\n\t\tfloat b = gloss < 0.25 ? 44.0 * alphaG - 23.7 * gloss + 3.26 : 1.97 * alphaG - 3.27 * gloss + 0.72;\n\t\tfloat DG = exp( a * NoV + b ) + ( gloss < 0.25 ? 0.0 : 0.1 * ( gloss - 0.25 ) );\n\t\tsReflection += calcReflection(worldNormal, 0.0) * saturate(DG);\n}\n",refractionCubePS:"\nuniform float material_refractionIndex;\n\nvec3 refract2(vec3 viewVec, vec3 normal, float IOR) {\n\t\tfloat vn = dot(viewVec, normal);\n\t\tfloat k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n\t\tvec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * normal;\n\t\treturn refrVec;\n}\n\nvoid addRefraction(\n\t\tvec3 worldNormal, \n\t\tvec3 viewDir, \n\t\tfloat thickness, \n\t\tfloat gloss, \n\t\tvec3 specularity, \n\t\tvec3 albedo, \n\t\tfloat transmission\n#if defined(LIT_IRIDESCENCE)\n\t\t, vec3 iridescenceFresnel,\n\t\tIridescenceArgs iridescence\n#endif \n) {\n\t\t// use same reflection code with refraction vector\n\t\tvec4 tmpRefl = dReflection;\n\t\tvec3 reflectionDir = refract2(-viewDir, worldNormal, material_refractionIndex);\n\t\tdReflection = vec4(0);\n\t\taddReflection(reflectionDir, gloss);\n\t\tdDiffuseLight = mix(dDiffuseLight, dReflection.rgb * albedo, transmission);\n\t\tdReflection = tmpRefl;\n}\n",refractionDynamicPS:"\nuniform float material_refractionIndex;\nuniform float material_invAttenuationDistance;\nuniform vec3 material_attenuation;\n\nvoid addRefraction(\n\t\tvec3 worldNormal, \n\t\tvec3 viewDir, \n\t\tfloat thickness, \n\t\tfloat gloss, \n\t\tvec3 specularity, \n\t\tvec3 albedo, \n\t\tfloat transmission\n#if defined(LIT_IRIDESCENCE)\n\t\t, vec3 iridescenceFresnel,\n\t\tIridescenceArgs iridescence\n#endif\n) {\n\n\t\t// Extract scale from the model transform\n\t\tvec3 modelScale;\n\t\tmodelScale.x = length(vec3(matrix_model[0].xyz));\n\t\tmodelScale.y = length(vec3(matrix_model[1].xyz));\n\t\tmodelScale.z = length(vec3(matrix_model[2].xyz));\n\n\t\t// Calculate the refraction vector, scaled by the thickness and scale of the object\n\t\tvec3 refractionVector = normalize(refract(-viewDir, worldNormal, material_refractionIndex)) * thickness * modelScale;\n\n\t\t// The refraction point is the entry point + vector to exit point\n\t\tvec4 pointOfRefraction = vec4(vPositionW + refractionVector, 1.0);\n\n\t\t// Project to texture space so we can sample it\n\t\tvec4 projectionPoint = matrix_viewProjection * pointOfRefraction;\n\n\t\t// use built-in getGrabScreenPos function to convert screen position to grab texture uv coords\n\t\tvec2 uv = getGrabScreenPos(projectionPoint);\n\n\t\t#ifdef SUPPORTS_TEXLOD\n\t\t\t\t// Use IOR and roughness to select mip\n\t\t\t\tfloat iorToRoughness = (1.0 - gloss) * clamp((1.0 / material_refractionIndex) * 2.0 - 2.0, 0.0, 1.0);\n\t\t\t\tfloat refractionLod = log2(uScreenSize.x) * iorToRoughness;\n\t\t\t\tvec3 refraction = texture2DLodEXT(uSceneColorMap, uv, refractionLod).rgb;\n\t\t#else\n\t\t\t\tvec3 refraction = texture2D(uSceneColorMap, uv).rgb;\n\t\t#endif\n\n\t\t// Transmittance is our final refraction color\n\t\tvec3 transmittance;\n\t\tif (material_invAttenuationDistance != 0.0)\n\t\t{\n\t\t\t\tvec3 attenuation = -log(material_attenuation) * material_invAttenuationDistance;\n\t\t\t\ttransmittance = exp(-attenuation * length(refractionVector));\n\t\t}\n\t\telse\n\t\t{\n\t\t\t\ttransmittance = refraction;\n\t\t}\n\n\t\t// Apply fresnel effect on refraction\n\t\tvec3 fresnel = vec3(1.0) - \n\t\t\t\tgetFresnel(\n\t\t\t\t\t\tdot(viewDir, worldNormal), \n\t\t\t\t\t\tgloss, \n\t\t\t\t\t\tspecularity\n\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\t\tiridescence\n\t\t\t\t#endif\n\t\t\t\t);\n\t\tdDiffuseLight = mix(dDiffuseLight, refraction * transmittance * fresnel, transmission);\n}\n",reprojectPS:`\n// This shader requires the following #DEFINEs:\n//\n// PROCESS_FUNC - must be one of reproject, prefilter\n// DECODE_FUNC - must be one of decodeRGBM, decodeRGBE, decodeGamma or decodeLinear\n// ENCODE_FUNC - must be one of encodeRGBM, encodeRGBE, encideGamma or encodeLinear\n// SOURCE_FUNC - must be one of sampleCubemap, sampleEquirect, sampleOctahedral\n// TARGET_FUNC - must be one of getDirectionCubemap, getDirectionEquirect, getDirectionOctahedral\n//\n// When filtering:\n// NUM_SAMPLES - number of samples\n// NUM_SAMPLES_SQRT - sqrt of number of samples\n\nvarying vec2 vUv0;\n\n// source\n#ifdef CUBEMAP_SOURCE\n\t\tuniform samplerCube sourceCube;\n#else\n\t\tuniform sampler2D sourceTex;\n#endif\n\n#ifdef USE_SAMPLES_TEX\n\t\t// samples\n\t\tuniform sampler2D samplesTex;\n\t\tuniform vec2 samplesTexInverseSize;\n#endif\n\n// params:\n// x - target cubemap face 0..6\n// y - specular power (when prefiltering)\n// z - source cubemap seam scale (0 to disable)\n// w - target cubemap size for seam calc (0 to disable)\nuniform vec4 params;\n\n// params2:\n// x - target image total pixels\n// y - source cubemap size\nuniform vec2 params2;\n\nfloat targetFace() { return params.x; }\nfloat specularPower() { return params.y; }\nfloat sourceCubeSeamScale() { return params.z; }\nfloat targetCubeSeamScale() { return params.w; }\n\nfloat targetTotalPixels() { return params2.x; }\nfloat sourceTotalPixels() { return params2.y; }\n\nfloat PI = 3.141592653589793;\n\nfloat saturate(float x) {\n\t\treturn clamp(x, 0.0, 1.0);\n}\n\n${Ci}\n${Ti}\n\n//-- supported projections\n\nvec3 modifySeams(vec3 dir, float scale) {\n\t\tvec3 adir = abs(dir);\n\t\tfloat M = max(max(adir.x, adir.y), adir.z);\n\t\treturn dir / M * vec3(\n\t\t\t\tadir.x == M ? 1.0 : scale,\n\t\t\t\tadir.y == M ? 1.0 : scale,\n\t\t\t\tadir.z == M ? 1.0 : scale\n\t\t);\n}\n\nvec2 toSpherical(vec3 dir) {\n\t\treturn vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\n\nvec3 fromSpherical(vec2 uv) {\n\t\treturn vec3(cos(uv.y) * sin(uv.x),\n\t\t\t\t\t\t\t\tsin(uv.y),\n\t\t\t\t\t\t\t\tcos(uv.y) * cos(uv.x));\n}\n\nvec3 getDirectionEquirect() {\n\t\treturn fromSpherical((vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0) * vec2(PI, PI * 0.5));\n}\n\n// octahedral code, based on http://jcgt.org/published/0003/02/01\n// "Survey of Efficient Representations for Independent Unit Vectors" by Cigolle, Donow, Evangelakos, Mara, McGuire, Meyer\n\nfloat signNotZero(float k){\n\t\treturn(k >= 0.0) ? 1.0 : -1.0;\n}\n\nvec2 signNotZero(vec2 v) {\n\t\treturn vec2(signNotZero(v.x), signNotZero(v.y));\n}\n\n// Returns a unit vector. Argument o is an octahedral vector packed via octEncode, on the [-1, +1] square\nvec3 octDecode(vec2 o) {\n\t\tvec3 v = vec3(o.x, 1.0 - abs(o.x) - abs(o.y), o.y);\n\t\tif (v.y < 0.0) {\n\t\t\t\tv.xz = (1.0 - abs(v.zx)) * signNotZero(v.xz);\n\t\t}\n\t\treturn normalize(v);\n}\n\nvec3 getDirectionOctahedral() {\n\t\treturn octDecode(vec2(vUv0.x, 1.0 - vUv0.y) * 2.0 - 1.0);\n}\n\n// Assumes that v is a unit vector. The result is an octahedral vector on the [-1, +1] square\nvec2 octEncode(in vec3 v) {\n\t\tfloat l1norm = abs(v.x) + abs(v.y) + abs(v.z);\n\t\tvec2 result = v.xz * (1.0 / l1norm);\n\t\tif (v.y < 0.0) {\n\t\t\t\tresult = (1.0 - abs(result.yx)) * signNotZero(result.xy);\n\t\t}\n\t\treturn result;\n}\n\n/////////////////////////////////////////////////////////////////////\n\n#ifdef CUBEMAP_SOURCE\n\t\tvec4 sampleCubemap(vec3 dir) {\n\t\t\t\treturn textureCube(sourceCube, modifySeams(dir, 1.0 - sourceCubeSeamScale()));\n\t\t}\n\n\t\tvec4 sampleCubemap(vec2 sph) {\n\t\treturn sampleCubemap(fromSpherical(sph));\n}\n\n\t\tvec4 sampleCubemap(vec3 dir, float mipLevel) {\n\t\t\t\treturn textureCubeLodEXT(sourceCube, modifySeams(dir, 1.0 - exp2(mipLevel) * sourceCubeSeamScale()), mipLevel);\n\t\t}\n\n\t\tvec4 sampleCubemap(vec2 sph, float mipLevel) {\n\t\t\t\treturn sampleCubemap(fromSpherical(sph), mipLevel);\n\t\t}\n#else\n\n\t\tvec4 sampleEquirect(vec2 sph) {\n\t\t\t\tvec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n\t\t\t\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n\t\t}\n\n\t\tvec4 sampleEquirect(vec3 dir) {\n\t\t\t\treturn sampleEquirect(toSpherical(dir));\n\t\t}\n\n\t\tvec4 sampleEquirect(vec2 sph, float mipLevel) {\n\t\t\t\tvec2 uv = sph / vec2(PI * 2.0, PI) + 0.5;\n\t\t\t\treturn texture2DLodEXT(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n\t\t}\n\n\t\tvec4 sampleEquirect(vec3 dir, float mipLevel) {\n\t\t\t\treturn sampleEquirect(toSpherical(dir), mipLevel);\n\t\t}\n\n\t\tvec4 sampleOctahedral(vec3 dir) {\n\t\t\t\tvec2 uv = octEncode(dir) * 0.5 + 0.5;\n\t\t\t\treturn texture2D(sourceTex, vec2(uv.x, 1.0 - uv.y));\n\t\t}\n\n\t\tvec4 sampleOctahedral(vec2 sph) {\n\t\t\t\treturn sampleOctahedral(fromSpherical(sph));\n\t\t}\n\n\t\tvec4 sampleOctahedral(vec3 dir, float mipLevel) {\n\t\t\t\tvec2 uv = octEncode(dir) * 0.5 + 0.5;\n\t\t\t\treturn texture2DLodEXT(sourceTex, vec2(uv.x, 1.0 - uv.y), mipLevel);\n\t\t}\n\n\t\tvec4 sampleOctahedral(vec2 sph, float mipLevel) {\n\t\t\t\treturn sampleOctahedral(fromSpherical(sph), mipLevel);\n\t\t}\n\n#endif\n\nvec3 getDirectionCubemap() {\n\t\tvec2 st = vUv0 * 2.0 - 1.0;\n\t\tfloat face = targetFace();\n\n\t\tvec3 vec;\n\t\tif (face == 0.0) {\n\t\t\t\tvec = vec3(1, -st.y, -st.x);\n\t\t} else if (face == 1.0) {\n\t\t\t\tvec = vec3(-1, -st.y, st.x);\n\t\t} else if (face == 2.0) {\n\t\t\t\tvec = vec3(st.x, 1, st.y);\n\t\t} else if (face == 3.0) {\n\t\t\t\tvec = vec3(st.x, -1, -st.y);\n\t\t} else if (face == 4.0) {\n\t\t\t\tvec = vec3(st.x, -st.y, 1);\n\t\t} else {\n\t\t\t\tvec = vec3(-st.x, -st.y, -1);\n\t\t}\n\n\t\treturn normalize(modifySeams(vec, 1.0 / (1.0 - targetCubeSeamScale())));\n}\n\nmat3 matrixFromVector(vec3 n) { // frisvad\n\t\tfloat a = 1.0 / (1.0 + n.z);\n\t\tfloat b = -n.x * n.y * a;\n\t\tvec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n\t\tvec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n\t\treturn mat3(b1, b2, n);\n}\n\nmat3 matrixFromVectorSlow(vec3 n) {\n\t\tvec3 up = (1.0 - abs(n.y) <= 0.0000001) ? vec3(0.0, 0.0, n.y > 0.0 ? 1.0 : -1.0) : vec3(0.0, 1.0, 0.0);\n\t\tvec3 x = normalize(cross(up, n));\n\t\tvec3 y = cross(n, x);\n\t\treturn mat3(x, y, n);\n}\n\nvec4 reproject() {\n\t\tif (NUM_SAMPLES <= 1) {\n\t\t\t\t// single sample\n\t\t\t\treturn ENCODE_FUNC(DECODE_FUNC(SOURCE_FUNC(TARGET_FUNC())));\n\t\t} else {\n\t\t\t\t// multi sample\n\t\t\t\tvec3 t = TARGET_FUNC();\n\t\t\t\tvec3 tu = dFdx(t);\n\t\t\t\tvec3 tv = dFdy(t);\n\n\t\t\t\tvec3 result = vec3(0.0);\n\t\t\t\tfor (float u = 0.0; u < NUM_SAMPLES_SQRT; ++u) {\n\t\t\t\t\t\tfor (float v = 0.0; v < NUM_SAMPLES_SQRT; ++v) {\n\t\t\t\t\t\t\t\tresult += DECODE_FUNC(SOURCE_FUNC(normalize(t +\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttu * (u / NUM_SAMPLES_SQRT - 0.5) +\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttv * (v / NUM_SAMPLES_SQRT - 0.5))));\n\t\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn ENCODE_FUNC(result / (NUM_SAMPLES_SQRT * NUM_SAMPLES_SQRT));\n\t\t}\n}\n\nvec4 unpackFloat = vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0);\n\n#ifdef USE_SAMPLES_TEX\n\t\tvoid unpackSample(int i, out vec3 L, out float mipLevel) {\n\t\t\t\tfloat u = (float(i * 4) + 0.5) * samplesTexInverseSize.x;\n\t\t\t\tfloat v = (floor(u) + 0.5) * samplesTexInverseSize.y;\n\n\t\t\t\tvec4 raw;\n\t\t\t\traw.x = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\t\t\t\traw.y = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\t\t\t\traw.z = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat); u += samplesTexInverseSize.x;\n\t\t\t\traw.w = dot(texture2D(samplesTex, vec2(u, v)), unpackFloat);\n\n\t\t\t\tL.xyz = raw.xyz * 2.0 - 1.0;\n\t\t\t\tmipLevel = raw.w * 8.0;\n\t\t}\n\n\t\t// convolve an environment given pre-generated samples\n\t\tvec4 prefilterSamples() {\n\t\t\t\t// construct vector space given target direction\n\t\t\t\tmat3 vecSpace = matrixFromVectorSlow(TARGET_FUNC());\n\n\t\t\t\tvec3 L;\n\t\t\t\tfloat mipLevel;\n\n\t\t\t\tvec3 result = vec3(0.0);\n\t\t\t\tfloat totalWeight = 0.0;\n\t\t\t\tfor (int i = 0; i < NUM_SAMPLES; ++i) {\n\t\t\t\t\t\tunpackSample(i, L, mipLevel);\n\t\t\t\t\t\tresult += DECODE_FUNC(SOURCE_FUNC(vecSpace * L, mipLevel)) * L.z;\n\t\t\t\t\t\ttotalWeight += L.z;\n\t\t\t\t}\n\n\t\t\t\treturn ENCODE_FUNC(result / totalWeight);\n\t\t}\n\n\t\t// unweighted version of prefilterSamples\n\t\tvec4 prefilterSamplesUnweighted() {\n\t\t\t\t// construct vector space given target direction\n\t\t\t\tmat3 vecSpace = matrixFromVectorSlow(TARGET_FUNC());\n\n\t\t\t\tvec3 L;\n\t\t\t\tfloat mipLevel;\n\n\t\t\t\tvec3 result = vec3(0.0);\n\t\t\t\tfloat totalWeight = 0.0;\n\t\t\t\tfor (int i = 0; i < NUM_SAMPLES; ++i) {\n\t\t\t\t\t\tunpackSample(i, L, mipLevel);\n\t\t\t\t\t\tresult += DECODE_FUNC(SOURCE_FUNC(vecSpace * L, mipLevel));\n\t\t\t\t}\n\n\t\t\t\treturn ENCODE_FUNC(result / float(NUM_SAMPLES));\n\t\t}\n#endif\n\nvoid main(void) {\n\t\tgl_FragColor = PROCESS_FUNC();\n}\n`,screenDepthPS:"\nuniform highp sampler2D uSceneDepthMap;\n\n#ifndef SCREENSIZE\n#define SCREENSIZE\nuniform vec4 uScreenSize;\n#endif\n\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n\n#ifndef LINEARIZE_DEPTH\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params; // x: 1 / camera_far,      y: camera_far,     z: camera_near,        w: is_ortho\n#endif\n\n#define LINEARIZE_DEPTH\n#ifdef GL2\nfloat linearizeDepth(float z) {\n\t\tif (camera_params.w == 0.0)\n\t\t\t\treturn (camera_params.z * camera_params.y) / (camera_params.y + z * (camera_params.z - camera_params.y));\n\t\telse\n\t\t\t\treturn camera_params.z + z * (camera_params.y - camera_params.z);\n}\n#else // GL2\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\t\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\t\treturn dot(rgbaDepth, bitShift);\n}\n#endif\n#endif\n#endif // LINEARIZE_DEPTH\n\n// Retrieves rendered linear camera depth by UV\nfloat getLinearScreenDepth(vec2 uv) {\n\t\t#ifdef GL2\n\t\t\t\treturn linearizeDepth(texture2D(uSceneDepthMap, uv).r);\n\t\t#else\n\t\t\t\treturn unpackFloat(texture2D(uSceneDepthMap, uv)) * camera_params.y;\n\t\t#endif\n}\n\n#ifndef VERTEXSHADER\n// Retrieves rendered linear camera depth under the current pixel\nfloat getLinearScreenDepth() {\n\t\tvec2 uv = gl_FragCoord.xy * uScreenSize.zw;\n\t\treturn getLinearScreenDepth(uv);\n}\n#endif\n\n// Generates linear camera depth for the given world position\nfloat getLinearDepth(vec3 pos) {\n\t\treturn -(matrix_view * vec4(pos, 1.0)).z;\n}\n",shadowCascadesPS:"\nconst float maxCascades = 4.0;\n\n// shadow matrix for selected cascade\nmat4 cascadeShadowMat;\n\n// function which selects a shadow projection matrix based on cascade distances \nvoid getShadowCascadeMatrix(mat4 shadowMatrixPalette[4], float shadowCascadeDistances[4], float shadowCascadeCount) {\n\n\t\t// depth in 0 .. far plane range\n\t\tfloat depth = 1.0 / gl_FragCoord.w;\n\n\t\t// find cascade index based on the depth (loop as there is no per component vec compare operator in webgl)\n\t\tfloat cascadeIndex = 0.0;\n\t\tfor (float i = 0.0; i < maxCascades; i++) {\n\t\t\t\tif (depth < shadowCascadeDistances[int(i)]) {\n\t\t\t\t\t\tcascadeIndex = i;\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t}\n\n\t\t// limit to actual number of used cascades\n\t\tcascadeIndex = min(cascadeIndex, shadowCascadeCount - 1.0);\n\n\t\t// pick shadow matrix\n\t\t#ifdef GL2\n\t\t\t\tcascadeShadowMat = shadowMatrixPalette[int(cascadeIndex)];\n\t\t#else\n\t\t\t\t// webgl 1 does not allow non-cost index array lookup\n\t\t\t\tif (cascadeIndex == 0.0) {\n\t\t\t\t\t\tcascadeShadowMat = shadowMatrixPalette[0];\n\t\t\t\t}\n\t\t\t\telse if (cascadeIndex == 1.0) {\n\t\t\t\t\t\tcascadeShadowMat = shadowMatrixPalette[1];\n\t\t\t\t}\n\t\t\t\telse if (cascadeIndex == 2.0) {\n\t\t\t\t\t\tcascadeShadowMat = shadowMatrixPalette[2];\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t\tcascadeShadowMat = shadowMatrixPalette[3];\n\t\t\t\t}\n\t\t#endif\n}\n\nvoid fadeShadow(float shadowCascadeDistances[4]) {                  \n\n\t\t// if the pixel is past the shadow distance, remove shadow\n\t\t// this enforces straight line instead of corner of shadow which moves when camera rotates  \n\t\tfloat depth = 1.0 / gl_FragCoord.w;\n\t\tif (depth > shadowCascadeDistances[int(maxCascades - 1.0)]) {\n\t\t\t\tdShadowCoord.z = -9999999.0;\n\t\t}\n}\n",shadowEVSMPS:"\nfloat VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\t\tvec3 moments = texture2D(tex, texCoords).xyz;\n\t\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\n\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\t\treturn VSM$(shadowMap, shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);\n}\n\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\t\treturn VSM$(shadowMap, shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowEVSMnPS:"\nfloat VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\t\tfloat pixelSize = 1.0 / resolution;\n\t\ttexCoords -= vec2(pixelSize);\n\t\tvec3 s00 = texture2D(tex, texCoords).xyz;\n\t\tvec3 s10 = texture2D(tex, texCoords + vec2(pixelSize, 0)).xyz;\n\t\tvec3 s01 = texture2D(tex, texCoords + vec2(0, pixelSize)).xyz;\n\t\tvec3 s11 = texture2D(tex, texCoords + vec2(pixelSize)).xyz;\n\t\tvec2 fr = fract(texCoords * resolution);\n\t\tvec3 h0 = mix(s00, s10, fr.x);\n\t\tvec3 h1 = mix(s01, s11, fr.x);\n\t\tvec3 moments = mix(h0, h1, fr.y);\n\t\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\n\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\t\treturn VSM$(shadowMap, shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, exponent);\n}\n\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\t\treturn VSM$(shadowMap, shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowPCSSPS:"\n\n/**\n * PCSS is a shadow sampling method that provides contact hardening soft shadows. \n * Based on: \n * - https://www.gamedev.net/tutorials/programming/graphics/effect-area-light-shadows-part-1-pcss-r4971/\n * - https://github.com/pboechat/PCSS \n */\n\n\n#define PCSS_SAMPLE_COUNT 16\nuniform float pcssDiskSamples[PCSS_SAMPLE_COUNT];\nuniform float pcssSphereSamples[PCSS_SAMPLE_COUNT];\n\nvec2 vogelDisk(int sampleIndex, float count, float phi, float r) {\n\t\tconst float GoldenAngle = 2.4;\n\t\tfloat theta = float(sampleIndex) * GoldenAngle + phi;\n\n\t\tfloat sine = sin(theta);\n\t\tfloat cosine = cos(theta);\n\t\treturn vec2(r * cosine, r * sine);\n}\n\nvec3 vogelSphere(int sampleIndex, float count, float phi, float r) {\n\t\tconst float GoldenAngle = 2.4;\n\t\tfloat theta = float(sampleIndex) * GoldenAngle + phi;\n\n\t\tfloat weight = float(sampleIndex) / count;\n\t\treturn vec3(cos(theta) * r, weight, sin(theta) * r);\n}\n\nfloat gradientNoise(vec2 screenPos) {\n\t\tvec3 magic = vec3(0.06711056, 0.00583715, 52.9829189);\n\t\treturn fract(magic.z * fract(dot(screenPos, magic.xy)));\n}\n\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\t\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\t\treturn dot(rgbaDepth, bitShift);\n}\n#endif\n\nfloat viewSpaceDepth(float depth, mat4 invProjection) {\n\t\tfloat z = depth * 2.0 - 1.0;\n\t\tvec4 clipSpace = vec4(0.0, 0.0, z, 1.0);\n\t\tvec4 viewSpace = invProjection * clipSpace;\n\t\treturn viewSpace.z;\n}\n\n\nfloat PCSSBlockerDistance(TEXTURE_ACCEPT(shadowMap), vec2 sampleCoords[PCSS_SAMPLE_COUNT], vec2 shadowCoords, vec2 searchSize, float z) {\n\n\t\tfloat blockers = 0.0;\n\t\tfloat averageBlocker = 0.0;\n\t\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\t\t\tvec2 offset = sampleCoords[i] * searchSize;\n\t\t\t\tvec2 sampleUV = shadowCoords + offset;\n\n\t\t#ifdef GL2\n\t\t\t\tfloat blocker = textureLod(shadowMap, sampleUV, 0.0).r;\n\t\t#else // GL1\n\t\t\t\tfloat blocker = unpackFloat(texture2D(shadowMap, sampleUV));\n\t\t#endif        \n\t\t\t\tfloat isBlocking = step(blocker, z);\n\t\t\t\tblockers += isBlocking;\n\t\t\t\taverageBlocker += blocker * isBlocking;\n\t\t}\n\n\t\tif (blockers > 0.0)\n\t\t\t\treturn averageBlocker /= blockers;\n\t\treturn -1.0;\n}\n\nfloat PCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoords, vec4 cameraParams, vec2 shadowSearchArea) {\n\t\tfloat receiverDepth = linearizeDepth(shadowCoords.z, cameraParams);\n#ifndef GL2\n\t\t// If using packed depth on GL1, we need to normalize to get the correct receiver depth\n\t\treceiverDepth *= 1.0 / (cameraParams.y - cameraParams.z);\n#endif\n\n\t\tvec2 samplePoints[PCSS_SAMPLE_COUNT];\n\t\tfloat noise = gradientNoise( gl_FragCoord.xy ) * 2.0 * PI;\n\t\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\t\t\tfloat pcssPresample = pcssDiskSamples[i];\n\t\t\t\tsamplePoints[i] = vogelDisk(i, float(PCSS_SAMPLE_COUNT), noise, pcssPresample);\n\t\t}\n\n\t\tfloat averageBlocker = PCSSBlockerDistance(TEXTURE_PASS(shadowMap), samplePoints, shadowCoords.xy, shadowSearchArea, receiverDepth);\n\t\tif (averageBlocker == -1.0) {\n\t\t\t\treturn 1.0;\n\t\t} else {\n\n\t\t\t\tvec2 filterRadius = ((receiverDepth - averageBlocker) / averageBlocker) * shadowSearchArea * cameraParams.x;\n\n\t\t\t\tfloat shadow = 0.0;\n\n\t\t\t\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i ++)\n\t\t\t\t{\n\t\t\t\t\t\tvec2 sampleUV = samplePoints[i] * filterRadius;\n\t\t\t\t\t\tsampleUV = shadowCoords.xy + sampleUV;\n\n\t\t\t\t#ifdef GL2\n\t\t\t\t\t\tfloat depth = textureLod(shadowMap, sampleUV, 0.0).r;\n\t\t\t\t#else // GL1\n\t\t\t\t\t\tfloat depth = unpackFloat(texture2D(shadowMap, sampleUV));\n\t\t\t\t#endif\n\t\t\t\t\t\tshadow += step(receiverDepth, depth);\n\t\t\t\t}\n\t\t\t\treturn shadow / float(PCSS_SAMPLE_COUNT);\n\t\t} \n}\n\nfloat PCSSCubeBlockerDistance(samplerCube shadowMap, vec3 lightDirNorm, vec3 samplePoints[PCSS_SAMPLE_COUNT], float z, float shadowSearchArea) {\n\t\tfloat blockers = 0.0;\n\t\tfloat averageBlocker = 0.0;\n\t\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\t\t\tvec3 sampleDir = lightDirNorm + samplePoints[i] * shadowSearchArea;\n\t\t\t\tsampleDir = normalize(sampleDir);\n\n\t\t#ifdef GL2\n\t\t\t\tfloat blocker = textureCubeLodEXT(shadowMap, sampleDir, 0.0).r;\n\t\t#else // GL1\n\t\t\t\tfloat blocker = unpackFloat(textureCube(shadowMap, sampleDir));\n\t\t#endif\n\t\t\t\tfloat isBlocking = step(blocker, z);\n\t\t\t\tblockers += isBlocking;\n\t\t\t\taverageBlocker += blocker * isBlocking;\n\t\t}\n\n\t\tif (blockers > 0.0)\n\t\t\t\treturn averageBlocker /= float(blockers);\n\t\treturn -1.0;\n}\n\nfloat PCSSCube(samplerCube shadowMap, vec4 shadowParams, vec3 shadowCoords, vec4 cameraParams, float shadowSearchArea, vec3 lightDir) {\n\t\t\n\t\tvec3 samplePoints[PCSS_SAMPLE_COUNT];\n\t\tfloat noise = gradientNoise( gl_FragCoord.xy ) * 2.0 * PI;\n\t\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++) {\n\t\t\t\tfloat r = pcssSphereSamples[i];\n\t\t\t\tsamplePoints[i] = vogelSphere(i, float(PCSS_SAMPLE_COUNT), noise, r);\n\t\t}\n\n\t\tfloat receiverDepth = length(lightDir) * shadowParams.w + shadowParams.z;\n\t\tvec3 lightDirNorm = normalize(lightDir);\n\t\t\n\t\tfloat averageBlocker = PCSSCubeBlockerDistance(shadowMap, lightDirNorm, samplePoints, receiverDepth, shadowSearchArea);\n\t\tif (averageBlocker == -1.0) {\n\t\t\t\treturn 1.0;\n\t\t} else {\n\n\t\t\t\tfloat filterRadius = ((receiverDepth - averageBlocker) / averageBlocker) * shadowSearchArea;\n\n\t\t\t\tfloat shadow = 0.0;\n\t\t\t\tfor (int i = 0; i < PCSS_SAMPLE_COUNT; i++)\n\t\t\t\t{\n\t\t\t\t\t\tvec3 offset = samplePoints[i] * filterRadius;\n\t\t\t\t\t\tvec3 sampleDir = lightDirNorm + offset;\n\t\t\t\t\t\tsampleDir = normalize(sampleDir);\n\n\t\t\t\t\t\t#ifdef GL2\n\t\t\t\t\t\t\t\tfloat depth = textureCubeLodEXT(shadowMap, sampleDir, 0.0).r;\n\t\t\t\t\t\t#else // GL1\n\t\t\t\t\t\t\t\tfloat depth = unpackFloat(textureCube(shadowMap, sampleDir));\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tshadow += step(receiverDepth, depth);\n\t\t\t\t}\n\t\t\t\treturn shadow / float(PCSS_SAMPLE_COUNT);\n\t\t}\n}\n\nfloat getShadowPointPCSS(samplerCube shadowMap, vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {\n\t\treturn PCSSCube(shadowMap, shadowParams, shadowCoord, cameraParams, shadowSearchArea.x, lightDir);\n}\n\nfloat getShadowSpotPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {\n\t\treturn PCSS(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, shadowSearchArea);\n}\n\nfloat getShadowPCSS(TEXTURE_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams, vec4 cameraParams, vec2 shadowSearchArea, vec3 lightDir) {\n\t\treturn PCSS(TEXTURE_PASS(shadowMap), shadowCoord, cameraParams, shadowSearchArea);\n}\n\n",shadowSampleCoordPS:"\n\nvec3 getShadowSampleCoord$LIGHT(mat4 shadowTransform, vec4 shadowParams, vec3 worldPosition, vec3 lightPos, inout vec3 lightDir, vec3 lightDirNorm, vec3 normal) {\n\n\t\tvec3 surfacePosition = worldPosition;\n\n#ifdef SHADOW_SAMPLE_POINT\n\t\t#ifdef SHADOW_SAMPLE_NORMAL_OFFSET\n\t\t\t\tfloat distScale = length(lightDir);\n\t\t\t\tsurfacePosition = worldPosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\t\t\t\tlightDir = surfacePosition - lightPos;\n\t\t\t\treturn lightDir;\n\t\t#endif\n#else\n\t\t#ifdef SHADOW_SAMPLE_SOURCE_ZBUFFER\n\t\t\t\t#ifdef SHADOW_SAMPLE_NORMAL_OFFSET\n\t\t\t\t\t\tsurfacePosition = worldPosition + normal * shadowParams.y;\n\t\t\t\t#endif\n\t\t#else\n\t\t\t\t#ifdef SHADOW_SAMPLE_NORMAL_OFFSET\n\t\t\t\t\t\t#ifdef SHADOW_SAMPLE_ORTHO\n\t\t\t\t\t\t\t\tfloat distScale = 1.0;\n\t\t\t\t\t\t#else\n\t\t\t\t\t\t\t\tfloat distScale = abs(dot(vPositionW - lightPos, lightDirNorm));\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\tsurfacePosition = worldPosition + normal * shadowParams.y * clamp(1.0 - dot(normal, -lightDirNorm), 0.0, 1.0) * distScale;\n\t\t\t\t#endif\n\t\t#endif\n\n\t\tvec4 positionInShadowSpace = shadowTransform * vec4(surfacePosition, 1.0);\n\t\t#ifdef SHADOW_SAMPLE_ORTHO\n\t\t\t\tpositionInShadowSpace.z = saturate(positionInShadowSpace.z) - 0.0001;\n\t\t#else\n\t\t\t\t#ifdef SHADOW_SAMPLE_SOURCE_ZBUFFER\n\t\t\t\t\t\tpositionInShadowSpace.xyz /= positionInShadowSpace.w;\n\t\t\t\t#else\n\t\t\t\t\t\tpositionInShadowSpace.xy /= positionInShadowSpace.w;\n\t\t\t\t\t\tpositionInShadowSpace.z = length(lightDir) * shadowParams.w;\n\t\t\t\t#endif\n\t\t#endif\n\n\t\t#ifdef SHADOW_SAMPLE_Z_BIAS\n\t\t\t\tpositionInShadowSpace.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t\t#endif\n\t\tsurfacePosition = positionInShadowSpace.xyz;\n#endif\n\n\t\treturn surfacePosition;\n}\n",shadowStandardPS:"\nvec3 lessThan2(vec3 a, vec3 b) {\n\t\treturn clamp((b - a)*1000.0, 0.0, 1.0); // softer version\n}\n\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\n\t\tfloat unpackFloat(vec4 rgbaDepth) {\n\t\t\t\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\t\t\t\treturn dot(rgbaDepth, bitShift);\n\t\t}\n#endif\n\n// ----- Direct/Spot Sampling -----\n\n#ifdef GL2\n\nfloat _getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {\n\t\tfloat z = shadowCoord.z;\n\t\tvec2 uv = shadowCoord.xy * shadowParams.x; // 1 unit - 1 texel\n\t\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\t\tvec2 base_uv = floor(uv + 0.5);\n\t\tfloat s = (uv.x + 0.5 - base_uv.x);\n\t\tfloat t = (uv.y + 0.5 - base_uv.y);\n\t\tbase_uv -= vec2(0.5);\n\t\tbase_uv *= shadowMapSizeInv;\n\n\t\tfloat sum = 0.0;\n\n\t\tfloat uw0 = (3.0 - 2.0 * s);\n\t\tfloat uw1 = (1.0 + 2.0 * s);\n\n\t\tfloat u0 = (2.0 - s) / uw0 - 1.0;\n\t\tfloat u1 = s / uw1 + 1.0;\n\n\t\tfloat vw0 = (3.0 - 2.0 * t);\n\t\tfloat vw1 = (1.0 + 2.0 * t);\n\n\t\tfloat v0 = (2.0 - t) / vw0 - 1.0;\n\t\tfloat v1 = t / vw1 + 1.0;\n\n\t\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\t\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\n\t\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\t\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\n\t\tsum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));\n\t\tsum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));\n\t\tsum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));\n\t\tsum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));\n\n\t\tsum *= 1.0f / 16.0;\n\t\treturn sum;\n}\n\nfloat getShadowPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\t\treturn _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\n\nfloat getShadowSpotPCF3x3(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\t\treturn _getShadowPCF3x3(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\n\nfloat getShadowPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\t\treturn textureShadow(shadowMap, shadowCoord);\n}\n\nfloat getShadowSpotPCF1x1(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\t\treturn textureShadow(shadowMap, shadowCoord);\n}\n\n#else // GL1\n\nfloat _xgetShadowPCF3x3(mat3 depthKernel, vec3 shadowCoord, sampler2D shadowMap, vec3 shadowParams) {\n\t\tmat3 shadowKernel;\n\t\tvec3 shadowZ = vec3(shadowCoord.z);\n\t\tshadowKernel[0] = vec3(greaterThan(depthKernel[0], shadowZ));\n\t\tshadowKernel[1] = vec3(greaterThan(depthKernel[1], shadowZ));\n\t\tshadowKernel[2] = vec3(greaterThan(depthKernel[2], shadowZ));\n\n\t\tvec2 fractionalCoord = fract( shadowCoord.xy * shadowParams.x );\n\n\t\tshadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n\t\tshadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\n\t\tvec4 shadowValues;\n\t\tshadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n\t\tshadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n\t\tshadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n\t\tshadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\n\t\treturn dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\n\nfloat _getShadowPCF3x3(sampler2D shadowMap, vec3 shadowCoord, vec3 shadowParams) {\n\t\tfloat xoffset = 1.0 / shadowParams.x; // 1/shadow map width\n\t\tfloat dx0 = -xoffset;\n\t\tfloat dx1 = xoffset;\n\n\t\tmat3 depthKernel;\n\t\tdepthKernel[0][0] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));\n\t\tdepthKernel[0][1] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));\n\t\tdepthKernel[0][2] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));\n\t\tdepthKernel[1][0] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));\n\t\tdepthKernel[1][1] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy));\n\t\tdepthKernel[1][2] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));\n\t\tdepthKernel[2][0] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));\n\t\tdepthKernel[2][1] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));\n\t\tdepthKernel[2][2] = unpackFloat(textureShadow(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));\n\n\t\treturn _xgetShadowPCF3x3(depthKernel, shadowCoord, shadowMap, shadowParams);\n}\n\nfloat getShadowPCF3x3(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {\n\t\treturn _getShadowPCF3x3(shadowMap, shadowCoord, shadowParams.xyz);\n}\n\nfloat getShadowSpotPCF3x3(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {\n\t\treturn _getShadowPCF3x3(shadowMap, shadowCoord, shadowParams.xyz);\n}\n\nfloat _getShadowPCF1x1(sampler2D shadowMap, vec3 shadowCoord) {\n\t\tfloat shadowSample = unpackFloat(textureShadow(shadowMap, shadowCoord.xy));\n\t\treturn shadowSample > shadowCoord.z ? 1.0 : 0.0;\n}\n\nfloat getShadowPCF1x1(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {\n\t\treturn _getShadowPCF1x1(shadowMap, shadowCoord);\n}\n\nfloat getShadowSpotPCF1x1(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams) {\n\t\treturn _getShadowPCF1x1(shadowMap, shadowCoord);\n}\n#endif\n\n\n// ----- Omni Sampling -----\n\n#ifndef WEBGPU\n\nfloat _getShadowPoint(samplerCube shadowMap, vec4 shadowParams, vec3 dir) {\n\n\t\tvec3 tc = normalize(dir);\n\t\tvec3 tcAbs = abs(tc);\n\n\t\tvec4 dirX = vec4(1,0,0, tc.x);\n\t\tvec4 dirY = vec4(0,1,0, tc.y);\n\t\tfloat majorAxisLength = tc.z;\n\t\tif ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {\n\t\t\t\tdirX = vec4(0,0,1, tc.z);\n\t\t\t\tdirY = vec4(0,1,0, tc.y);\n\t\t\t\tmajorAxisLength = tc.x;\n\t\t} else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {\n\t\t\t\tdirX = vec4(1,0,0, tc.x);\n\t\t\t\tdirY = vec4(0,0,1, tc.z);\n\t\t\t\tmajorAxisLength = tc.y;\n\t\t}\n\n\t\tfloat shadowParamsInFaceSpace = ((1.0/shadowParams.x) * 2.0) * abs(majorAxisLength);\n\n\t\tvec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace);\n\t\tvec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace);\n\t\tvec3 dx0 = -xoffset;\n\t\tvec3 dy0 = -yoffset;\n\t\tvec3 dx1 = xoffset;\n\t\tvec3 dy1 = yoffset;\n\n\t\tmat3 shadowKernel;\n\t\tmat3 depthKernel;\n\n\t\tdepthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));\n\t\tdepthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));\n\t\tdepthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));\n\t\tdepthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));\n\t\tdepthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));\n\t\tdepthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));\n\t\tdepthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));\n\t\tdepthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));\n\t\tdepthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));\n\n\t\tvec3 shadowZ = vec3(length(dir) * shadowParams.w + shadowParams.z);\n\n\t\tshadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));\n\t\tshadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));\n\t\tshadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));\n\n\t\tvec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;\n\n\t\tvec2 fractionalCoord = fract( uv * shadowParams.x );\n\n\t\tshadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n\t\tshadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\n\t\tvec4 shadowValues;\n\t\tshadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n\t\tshadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n\t\tshadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n\t\tshadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\n\t\treturn 1.0 - dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\n\nfloat getShadowPointPCF3x3(samplerCube shadowMap, vec3 shadowCoord, vec4 shadowParams, vec3 lightDir) {\n\t\treturn _getShadowPoint(shadowMap, shadowParams, lightDir);\n}\n\n#endif\n",shadowStandardGL2PS:"\nfloat _getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec3 shadowParams) {\n\t\t// http://the-witness.net/news/2013/09/shadow-mapping-summary-part-1/\n\n\t\tfloat z = shadowCoord.z;\n\t\tvec2 uv = shadowCoord.xy * shadowParams.x; // 1 unit - 1 texel\n\t\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\t\tvec2 base_uv = floor(uv + 0.5);\n\t\tfloat s = (uv.x + 0.5 - base_uv.x);\n\t\tfloat t = (uv.y + 0.5 - base_uv.y);\n\t\tbase_uv -= vec2(0.5);\n\t\tbase_uv *= shadowMapSizeInv;\n\n\n\t\tfloat uw0 = (4.0 - 3.0 * s);\n\t\tfloat uw1 = 7.0;\n\t\tfloat uw2 = (1.0 + 3.0 * s);\n\n\t\tfloat u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n\t\tfloat u1 = (3.0 + s) / uw1;\n\t\tfloat u2 = s / uw2 + 2.0;\n\n\t\tfloat vw0 = (4.0 - 3.0 * t);\n\t\tfloat vw1 = 7.0;\n\t\tfloat vw2 = (1.0 + 3.0 * t);\n\n\t\tfloat v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n\t\tfloat v1 = (3.0 + t) / vw1;\n\t\tfloat v2 = t / vw2 + 2.0;\n\n\t\tfloat sum = 0.0;\n\n\t\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\t\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\n\t\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\t\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\n\t\tu2 = u2 * shadowMapSizeInv + base_uv.x;\n\t\tv2 = v2 * shadowMapSizeInv + base_uv.y;\n\n\t\tsum += uw0 * vw0 * textureShadow(shadowMap, vec3(u0, v0, z));\n\t\tsum += uw1 * vw0 * textureShadow(shadowMap, vec3(u1, v0, z));\n\t\tsum += uw2 * vw0 * textureShadow(shadowMap, vec3(u2, v0, z));\n\n\t\tsum += uw0 * vw1 * textureShadow(shadowMap, vec3(u0, v1, z));\n\t\tsum += uw1 * vw1 * textureShadow(shadowMap, vec3(u1, v1, z));\n\t\tsum += uw2 * vw1 * textureShadow(shadowMap, vec3(u2, v1, z));\n\n\t\tsum += uw0 * vw2 * textureShadow(shadowMap, vec3(u0, v2, z));\n\t\tsum += uw1 * vw2 * textureShadow(shadowMap, vec3(u1, v2, z));\n\t\tsum += uw2 * vw2 * textureShadow(shadowMap, vec3(u2, v2, z));\n\n\t\tsum *= 1.0f / 144.0;\n\n\t\tsum = saturate(sum);\n\n\t\treturn sum;\n}\n\nfloat getShadowPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\t\treturn _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\n\nfloat getShadowSpotPCF5x5(SHADOWMAP_ACCEPT(shadowMap), vec3 shadowCoord, vec4 shadowParams) {\n\t\treturn _getShadowPCF5x5(SHADOWMAP_PASS(shadowMap), shadowCoord, shadowParams.xyz);\n}\n",shadowVSM8PS:"\nfloat calculateVSM8(vec3 moments, float Z, float vsmBias) {\n\t\tfloat VSMBias = vsmBias;//0.01 * 0.25;\n\t\tfloat depthScale = VSMBias * Z;\n\t\tfloat minVariance1 = depthScale * depthScale;\n\t\treturn chebyshevUpperBound(moments.xy, Z, minVariance1, 0.1);\n}\n\nfloat decodeFloatRG(vec2 rg) {\n\t\treturn rg.y*(1.0/255.0) + rg.x;\n}\n\nfloat VSM8(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\t\tvec4 c = texture2D(tex, texCoords);\n\t\tvec3 moments = vec3(decodeFloatRG(c.xy), decodeFloatRG(c.zw), 0.0);\n\t\treturn calculateVSM8(moments, Z, vsmBias);\n}\n\nfloat getShadowVSM8(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\t\treturn VSM8(shadowMap, shadowCoord.xy, shadowParams.x, shadowCoord.z, shadowParams.y, 0.0);\n}\n\nfloat getShadowSpotVSM8(sampler2D shadowMap, vec3 shadowCoord, vec4 shadowParams, float exponent, vec3 lightDir) {\n\t\treturn VSM8(shadowMap, shadowCoord.xy, shadowParams.x, length(lightDir) * shadowParams.w + shadowParams.z, shadowParams.y, 0.0);\n}\n",shadowVSM_commonPS:"\nfloat linstep(float a, float b, float v) {\n\t\treturn saturate((v - a) / (b - a));\n}\n\nfloat reduceLightBleeding(float pMax, float amount) {\n\t // Remove the [0, amount] tail and linearly rescale (amount, 1].\n\t return linstep(amount, 1.0, pMax);\n}\n\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n\t\t// Compute variance\n\t\tfloat variance = moments.y - (moments.x * moments.x);\n\t\tvariance = max(variance, minVariance);\n\n\t\t// Compute probabilistic upper bound\n\t\tfloat d = mean - moments.x;\n\t\tfloat pMax = variance / (variance + (d * d));\n\n\t\tpMax = reduceLightBleeding(pMax, lightBleedingReduction);\n\n\t\t// One-tailed Chebyshev\n\t\treturn (mean <= moments.x ? 1.0 : pMax);\n}\n\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n\t\tZ = 2.0 * Z - 1.0;\n\t\tfloat warpedDepth = exp(exponent * Z);\n\n\t\tmoments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n\n\t\tfloat VSMBias = vsmBias;//0.01 * 0.25;\n\t\tfloat depthScale = VSMBias * exponent * warpedDepth;\n\t\tfloat minVariance1 = depthScale * depthScale;\n\t\treturn chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\n",skinBatchConstVS:"\nattribute float vertex_boneIndices;\n\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\n\nmat4 getBoneMatrix(const in float i) {\n\t\t// read 4x3 matrix\n\t\tvec4 v1 = matrix_pose[int(3.0 * i)];\n\t\tvec4 v2 = matrix_pose[int(3.0 * i + 1.0)];\n\t\tvec4 v3 = matrix_pose[int(3.0 * i + 2.0)];\n\n\t\t// transpose to 4x4 matrix\n\t\treturn mat4(\n\t\t\t\tv1.x, v2.x, v3.x, 0,\n\t\t\t\tv1.y, v2.y, v3.y, 0,\n\t\t\t\tv1.z, v2.z, v3.z, 0,\n\t\t\t\tv1.w, v2.w, v3.w, 1\n\t\t);\n}\n",skinBatchTexVS:"\nattribute float vertex_boneIndices;\n\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\n\nmat4 getBoneMatrix(const in float i) {\n\t\tfloat j = i * 3.0;\n\t\tfloat dx = texture_poseMapSize.z;\n\t\tfloat dy = texture_poseMapSize.w;\n\n\t\tfloat y = floor(j * dx);\n\t\tfloat x = j - (y * texture_poseMapSize.x);\n\t\ty = dy * (y + 0.5);\n\n\t\t// read elements of 4x3 matrix\n\t\tvec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\t\tvec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\t\tvec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n\n\t\t// transpose to 4x4 matrix\n\t\treturn mat4(\n\t\t\t\tv1.x, v2.x, v3.x, 0,\n\t\t\t\tv1.y, v2.y, v3.y, 0,\n\t\t\t\tv1.z, v2.z, v3.z, 0,\n\t\t\t\tv1.w, v2.w, v3.w, 1\n\t\t);\n}\n",skinConstVS:"\nattribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\n\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\n\nvoid getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {\n\t\t// read 4x3 matrix\n\t\tv1 = matrix_pose[int(3.0 * i)];\n\t\tv2 = matrix_pose[int(3.0 * i + 1.0)];\n\t\tv3 = matrix_pose[int(3.0 * i + 2.0)];\n}\n\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\t\t// get 4 bone matrices\n\t\tvec4 a1, a2, a3;\n\t\tgetBoneMatrix(indices.x, a1, a2, a3);\n\n\t\tvec4 b1, b2, b3;\n\t\tgetBoneMatrix(indices.y, b1, b2, b3);\n\n\t\tvec4 c1, c2, c3;\n\t\tgetBoneMatrix(indices.z, c1, c2, c3);\n\n\t\tvec4 d1, d2, d3;\n\t\tgetBoneMatrix(indices.w, d1, d2, d3);\n\n\t\t// multiply them by weights and add up to get final 4x3 matrix\n\t\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\t\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\t\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\n\t\t// add up weights\n\t\tfloat one = dot(weights, vec4(1.0));\n\n\t\t// transpose to 4x4 matrix\n\t\treturn mat4(\n\t\t\t\tv1.x, v2.x, v3.x, 0,\n\t\t\t\tv1.y, v2.y, v3.y, 0,\n\t\t\t\tv1.z, v2.z, v3.z, 0,\n\t\t\t\tv1.w, v2.w, v3.w, one\n\t\t);\n}\n",skinTexVS:"\n\nattribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\n\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\n\nvoid getBoneMatrix(const in float index, out vec4 v1, out vec4 v2, out vec4 v3) {\n\n\t\tfloat i = float(index);\n\t\tfloat j = i * 3.0;\n\t\tfloat dx = texture_poseMapSize.z;\n\t\tfloat dy = texture_poseMapSize.w;\n\t\t\n\t\tfloat y = floor(j * dx);\n\t\tfloat x = j - (y * texture_poseMapSize.x);\n\t\ty = dy * (y + 0.5);\n\n\t\t// read elements of 4x3 matrix\n\t\tv1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\t\tv2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\t\tv3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n}\n\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\t\t// get 4 bone matrices\n\t\tvec4 a1, a2, a3;\n\t\tgetBoneMatrix(indices.x, a1, a2, a3);\n\n\t\tvec4 b1, b2, b3;\n\t\tgetBoneMatrix(indices.y, b1, b2, b3);\n\n\t\tvec4 c1, c2, c3;\n\t\tgetBoneMatrix(indices.z, c1, c2, c3);\n\n\t\tvec4 d1, d2, d3;\n\t\tgetBoneMatrix(indices.w, d1, d2, d3);\n\n\t\t// multiply them by weights and add up to get final 4x3 matrix\n\t\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\t\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\t\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\n\t\t// add up weights\n\t\tfloat one = dot(weights, vec4(1.0));\n\n\t\t// transpose to 4x4 matrix\n\t\treturn mat4(\n\t\t\t\tv1.x, v2.x, v3.x, 0,\n\t\t\t\tv1.y, v2.y, v3.y, 0,\n\t\t\t\tv1.z, v2.z, v3.z, 0,\n\t\t\t\tv1.w, v2.w, v3.w, one\n\t\t);\n}\n",skyboxEnvPS:"\nvarying vec3 vViewDir;\n\nuniform sampler2D texture_envAtlas;\nuniform float mipLevel;\n\nvoid main(void) {\n\t\tvec3 dir = vViewDir * vec3(-1.0, 1.0, 1.0);\n\t\tvec2 uv = toSphericalUv(normalize(dir));\n\n\t\tvec3 linear = $DECODE(texture2D(texture_envAtlas, mapRoughnessUv(uv, mipLevel)));\n\n\t\tgl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);\n}\n",skyboxHDRPS:"\nvarying vec3 vViewDir;\n\nuniform samplerCube texture_cubeMap;\n\nvoid main(void) {\n\t\tvec3 dir=vViewDir;\n\t\tdir.x *= -1.0;\n\n\t\tvec3 linear = $DECODE(textureCube(texture_cubeMap, fixSeamsStatic(dir, $FIXCONST)));\n\n\t\tgl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);\n}\n",skyboxVS:"\nattribute vec3 aPosition;\n\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n\nuniform mat4 matrix_projectionSkybox;\nuniform mat3 cubeMapRotationMatrix;\n\nvarying vec3 vViewDir;\n\nvoid main(void) {\n\t\tmat4 view = matrix_view;\n\t\tview[3][0] = view[3][1] = view[3][2] = 0.0;\n\t\tgl_Position = matrix_projectionSkybox * view * vec4(aPosition, 1.0);\n\n\t\t// Force skybox to far Z, regardless of the clip planes on the camera\n\t\t// Subtract a tiny fudge factor to ensure floating point errors don't\n\t\t// still push pixels beyond far Z. See:\n\t\t// http://www.opengl.org/discussion_boards/showthread.php/171867-skybox-problem\n\n\t\tgl_Position.z = gl_Position.w - 0.00001;\n\t\tvViewDir = aPosition * cubeMapRotationMatrix;\n}\n",specularPS:"\n\n#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\n\nvoid getSpecularity() {\n\t\tvec3 specularColor = vec3(1,1,1);\n\n\t\t#ifdef MAPCOLOR\n\t\tspecularColor *= material_specular;\n\t\t#endif\n\n\t\t#ifdef MAPTEXTURE\n\t\tspecularColor *= $DECODE(texture2DBias($SAMPLER, $UV, textureBias)).$CH;\n\t\t#endif\n\n\t\t#ifdef MAPVERTEX\n\t\tspecularColor *= saturate(vVertexColor.$VC);\n\t\t#endif\n\n\t\tdSpecularity = specularColor;\n}\n",sphericalPS:"\n// equirectangular helper functions\nconst float PI = 3.141592653589793;\n\nvec2 toSpherical(vec3 dir) {\n\t\treturn vec2(dir.xz == vec2(0.0) ? 0.0 : atan(dir.x, dir.z), asin(dir.y));\n}\n\nvec2 toSphericalUv(vec3 dir) {\n\t\tvec2 uv = toSpherical(dir) / vec2(PI * 2.0, PI) + 0.5;\n\t\treturn vec2(uv.x, 1.0 - uv.y);\n}\n",specularityFactorPS:"\n\n#ifdef MAPFLOAT\nuniform float material_specularityFactor;\n#endif\n\nvoid getSpecularityFactor() {\n\t\tfloat specularityFactor = 1.0;\n\n\t\t#ifdef MAPFLOAT\n\t\tspecularityFactor *= material_specularityFactor;\n\t\t#endif\n\n\t\t#ifdef MAPTEXTURE\n\t\tspecularityFactor *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t\t#endif\n\n\t\t#ifdef MAPVERTEX\n\t\tspecularityFactor *= saturate(vVertexColor.$VC);\n\t\t#endif\n\n\t\tdSpecularityFactor = specularityFactor;\n}\n",spotPS:"\nfloat getSpotEffect(vec3 lightSpotDir, float lightInnerConeAngle, float lightOuterConeAngle, vec3 lightDirNorm) {\n\t\tfloat cosAngle = dot(lightDirNorm, lightSpotDir);\n\t\treturn smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n",startPS:"\nvoid main(void) {\n\t\tdReflection = vec4(0);\n\n\t\t#ifdef LIT_CLEARCOAT\n\t\tccSpecularLight = vec3(0);\n\t\tccReflection = vec3(0);\n\t\t#endif\n",startVS:"\nvoid main(void) {\n\t\tgl_Position = getPosition();\n",startNineSlicedPS:"\n\t\tnineSlicedUv = vUv0;\n\t\tnineSlicedUv.y = 1.0 - nineSlicedUv.y;\n\n",startNineSlicedTiledPS:"\n\t\tvec2 tileMask = step(vMask, vec2(0.99999));\n\t\tvec2 tileSize = 0.5 * (innerOffset.xy + innerOffset.zw);\n\t\tvec2 tileScale = vec2(1.0) / (vec2(1.0) - tileSize);\n\t\tvec2 clampedUv = mix(innerOffset.xy * 0.5, vec2(1.0) - innerOffset.zw * 0.5, fract((vTiledUv - tileSize) * tileScale));\n\t\tclampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n\t\tnineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);\n\t\tnineSlicedUv.y = 1.0 - nineSlicedUv.y;\n\t\t\n",storeEVSMPS:"\nfloat exponent = VSM_EXPONENT;\n\ndepth = 2.0 * depth - 1.0;\ndepth =  exp(exponent * depth);\ngl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n",tangentBinormalVS:"\nvec3 getTangent() {\n\t\treturn normalize(dNormalMatrix * vertex_tangent.xyz);\n}\n\nvec3 getBinormal() {\n\t\treturn cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\n",TBNPS:"\nvoid getTBN(vec3 tangent, vec3 binormal, vec3 normal) {\n\t\tdTBN = mat3(normalize(tangent), normalize(binormal), normalize(normal));\n}\n",TBNderivativePS:"\nuniform float tbnBasis;\n\n// http://www.thetenthplanet.de/archives/1180\nvoid getTBN(vec3 tangent, vec3 binormal, vec3 normal) {\n\t\tvec2 uv = $UV;\n\n\t\t// get edge vectors of the pixel triangle\n\t\tvec3 dp1 = dFdx( vPositionW );\n\t\tvec3 dp2 = dFdy( vPositionW );\n\t\tvec2 duv1 = dFdx( uv );\n\t\tvec2 duv2 = dFdy( uv );\n\n\t\t// solve the linear system\n\t\tvec3 dp2perp = cross( dp2, normal );\n\t\tvec3 dp1perp = cross( normal, dp1 );\n\t\tvec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n\t\tvec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\n\t\t// construct a scale-invariant frame\n\t\tfloat denom = max( dot(T,T), dot(B,B) );\n\t\tfloat invmax = (denom == 0.0) ? 0.0 : tbnBasis / sqrt( denom );\n\t\tdTBN = mat3(T * invmax, -B * invmax, normal );\n}\n",TBNfastPS:"\nvoid getTBN(vec3 tangent, vec3 binormal, vec3 normal) {\n\t\tdTBN = mat3(tangent, binormal, normal);\n}\n",TBNObjectSpacePS:"\nvoid getTBN(vec3 tangent, vec3 binormal, vec3 normal) {\n\n\t\tvec3 B = cross(normal, vObjectSpaceUpW);\n\t\tvec3 T = cross(normal, B);\n\n\t\tif (dot(B,B)==0.0) // deal with case when vObjectSpaceUpW normal are parallel\n\t\t{\n\t\t\t\tfloat major=max(max(normal.x, normal.y), normal.z);\n\n\t\t\t\tif (normal.x == major)\n\t\t\t\t{\n\t\t\t\t\t\tB=cross(normal, vec3(0,1,0));\n\t\t\t\t\t\tT=cross(normal, B);\n\t\t\t\t}\n\t\t\t\telse if (normal.y == major)\n\t\t\t\t{\n\t\t\t\t\t\tB=cross(normal, vec3(0,0,1));\n\t\t\t\t\t\tT=cross(normal, B);\n\t\t\t\t}\n\t\t\t\telse if (normal.z == major)\n\t\t\t\t{\n\t\t\t\t\t\tB=cross(normal, vec3(1,0,0));\n\t\t\t\t\t\tT=cross(normal, B);\n\t\t\t\t}\n\t\t}\n\n\t\tdTBN = mat3(normalize(T), normalize(B), normalize(normal));\n}\n",textureSamplePS:"\nvec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n\t\treturn gammaCorrectInput(texture2D(tex, uv));\n}\n\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n\t\treturn gammaCorrectInput(texture2D(tex, uv, bias));\n}\n\nvec3 texture2DRGBM(sampler2D tex, vec2 uv) {\n\t\treturn decodeRGBM(texture2D(tex, uv));\n}\n\nvec3 texture2DRGBM(sampler2D tex, vec2 uv, float bias) {\n\t\treturn decodeRGBM(texture2D(tex, uv, bias));\n}\n\nvec3 texture2DRGBE(sampler2D tex, vec2 uv) {\n\t\treturn decodeRGBM(texture2D(tex, uv));\n}\n\nvec3 texture2DRGBE(sampler2D tex, vec2 uv, float bias) {\n\t\treturn decodeRGBM(texture2D(tex, uv, bias));\n}\n",thicknessPS:"\n#ifdef MAPFLOAT\nuniform float material_thickness;\n#endif\n\nvoid getThickness() {\n\t\tdThickness = 1.0;\n\n\t\t#ifdef MAPFLOAT\n\t\tdThickness *= material_thickness;\n\t\t#endif\n\n\t\t#ifdef MAPTEXTURE\n\t\tdThickness *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t\t#endif\n\n\t\t#ifdef MAPVERTEX\n\t\tdThickness *= saturate(vVertexColor.$VC);\n\t\t#endif\n}\n",tonemappingAcesPS:"\nuniform float exposure;\n\nvec3 toneMap(vec3 color) {\n\t\tfloat tA = 2.51;\n\t\tfloat tB = 0.03;\n\t\tfloat tC = 2.43;\n\t\tfloat tD = 0.59;\n\t\tfloat tE = 0.14;\n\t\tvec3 x = color * exposure;\n\t\treturn (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n",tonemappingAces2PS:"\nuniform float exposure;\n\n// ACES approximation by Stephen Hill\n\n// sRGB => XYZ => D65_2_D60 => AP1 => RRT_SAT\nconst mat3 ACESInputMat = mat3(\n\t\t0.59719, 0.35458, 0.04823,\n\t\t0.07600, 0.90834, 0.01566,\n\t\t0.02840, 0.13383, 0.83777\n);\n\n// ODT_SAT => XYZ => D60_2_D65 => sRGB\nconst mat3 ACESOutputMat = mat3(\n\t\t 1.60475, -0.53108, -0.07367,\n\t\t-0.10208,  1.10813, -0.00605,\n\t\t-0.00327, -0.07276,  1.07602\n);\n\nvec3 RRTAndODTFit(vec3 v) {\n\t\tvec3 a = v * (v + 0.0245786) - 0.000090537;\n\t\tvec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n\t\treturn a / b;\n}\n\nvec3 toneMap(vec3 color) {\n\t\tcolor *= exposure / 0.6;\n\t\tcolor = color * ACESInputMat;\n\n\t\t// Apply RRT and ODT\n\t\tcolor = RRTAndODTFit(color);\n\t\tcolor = color * ACESOutputMat;\n\n\t\t// Clamp to [0, 1]\n\t\tcolor = clamp(color, 0.0, 1.0);\n\n\t\treturn color;\n}\n",tonemappingFilmicPS:"\nconst float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\n\nuniform float exposure;\n\nvec3 uncharted2Tonemap(vec3 x) {\n\t return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\n\nvec3 toneMap(vec3 color) {\n\t\tcolor = uncharted2Tonemap(color * exposure);\n\t\tvec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n\t\tcolor = color * whiteScale;\n\n\t\treturn color;\n}\n",tonemappingHejlPS:"\nuniform float exposure;\n\nvec3 toneMap(vec3 color) {\n\t\tcolor *= exposure;\n\t\tconst float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n\t\tconst float Scl = 1.25;\n\n\t\tvec3 h = max( vec3(0.0), color - vec3(0.004) );\n\t\treturn (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n",tonemappingLinearPS:"\nuniform float exposure;\n\nvec3 toneMap(vec3 color) {\n\t\treturn color * exposure;\n}\n",tonemappingNonePS:"\nvec3 toneMap(vec3 color) {\n\t\treturn color;\n}\n",transformVS:"\n#ifdef PIXELSNAP\nuniform vec4 uScreenSize;\n#endif\n\n#ifdef SCREENSPACE\nuniform float projectionFlipY;\n#endif\n\n#ifdef MORPHING\nuniform vec4 morph_weights_a;\nuniform vec4 morph_weights_b;\n#endif\n\n#ifdef MORPHING_TEXTURE_BASED\n\t\tuniform vec4 morph_tex_params;\n\n\t\t#ifdef WEBGPU\n\t\t\t\tivec2 getTextureMorphCoords() {\n\n\t\t\t\t\t\t// turn morph_vertex_id into int grid coordinates\n\t\t\t\t\t\tivec2 textureSize = ivec2(morph_tex_params.xy);\n\t\t\t\t\t\tint morphGridV = int(morph_vertex_id / textureSize.x);\n\t\t\t\t\t\tint morphGridU = int(morph_vertex_id - (morphGridV * textureSize.x));\n\t\t\t\t\t\tmorphGridV = textureSize.y - morphGridV - 1;\n\t\t\t\t\t\treturn ivec2(morphGridU, morphGridV);\n\t\t\t\t}\n\t\t#else\n\t\t\t\tvec2 getTextureMorphCoords() {\n\t\t\t\t\t\tvec2 textureSize = morph_tex_params.xy;\n\t\t\t\t\t\tvec2 invTextureSize = morph_tex_params.zw;\n\n\t\t\t\t\t\t// turn morph_vertex_id into int grid coordinates\n\t\t\t\t\t\tfloat morphGridV = floor(morph_vertex_id * invTextureSize.x);\n\t\t\t\t\t\tfloat morphGridU = morph_vertex_id - (morphGridV * textureSize.x);\n\n\t\t\t\t\t\t// convert grid coordinates to uv coordinates with half pixel offset\n\t\t\t\t\t\treturn vec2(morphGridU, morphGridV) * invTextureSize + (0.5 * invTextureSize);\n\t\t\t\t}\n\t\t#endif\n\n#endif\n\n#ifdef MORPHING_TEXTURE_BASED_POSITION\nuniform highp sampler2D morphPositionTex;\n#endif\n\nmat4 getModelMatrix() {\n\t\t#ifdef DYNAMICBATCH\n\t\treturn getBoneMatrix(vertex_boneIndices);\n\t\t#elif defined(SKIN)\n\t\treturn matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n\t\t#elif defined(INSTANCING)\n\t\treturn mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n\t\t#else\n\t\treturn matrix_model;\n\t\t#endif\n}\n\nvec4 getPosition() {\n\t\tdModelMatrix = getModelMatrix();\n\t\tvec3 localPos = vertex_position;\n\n\t\t#ifdef NINESLICED\n\t\t// outer and inner vertices are at the same position, scale both\n\t\tlocalPos.xz *= outerScale;\n\n\t\t// offset inner vertices inside\n\t\t// (original vertices must be in [-1;1] range)\n\t\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\t\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\t\tlocalPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\n\t\tvTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0; // uv = local pos - inner corner\n\n\t\tlocalPos.xz *= -0.5; // move from -1;1 to -0.5;0.5\n\t\tlocalPos = localPos.xzy;\n\t\t#endif\n\n\t\t#ifdef MORPHING\n\t\t#ifdef MORPHING_POS03\n\t\tlocalPos.xyz += morph_weights_a[0] * morph_pos0;\n\t\tlocalPos.xyz += morph_weights_a[1] * morph_pos1;\n\t\tlocalPos.xyz += morph_weights_a[2] * morph_pos2;\n\t\tlocalPos.xyz += morph_weights_a[3] * morph_pos3;\n\t\t#endif // MORPHING_POS03\n\t\t#ifdef MORPHING_POS47\n\t\tlocalPos.xyz += morph_weights_b[0] * morph_pos4;\n\t\tlocalPos.xyz += morph_weights_b[1] * morph_pos5;\n\t\tlocalPos.xyz += morph_weights_b[2] * morph_pos6;\n\t\tlocalPos.xyz += morph_weights_b[3] * morph_pos7;\n\t\t#endif // MORPHING_POS47\n\t\t#endif // MORPHING\n\n\t\t#ifdef MORPHING_TEXTURE_BASED_POSITION\n\n\t\t\t\t#ifdef WEBGPU\n\t\t\t\t\t\tivec2 morphUV = getTextureMorphCoords();\n\t\t\t\t\t\tvec3 morphPos = texelFetch(morphPositionTex, ivec2(morphUV), 0).xyz;\n\t\t\t\t#else\n\t\t\t\t\t\tvec2 morphUV = getTextureMorphCoords();\n\t\t\t\t\t\tvec3 morphPos = texture2D(morphPositionTex, morphUV).xyz;\n\t\t\t\t#endif\n\n\t\t\t\tlocalPos += morphPos;\n\n\t\t#endif\n\n\t\tvec4 posW = dModelMatrix * vec4(localPos, 1.0);\n\t\t#ifdef SCREENSPACE\n\t\tposW.zw = vec2(0.0, 1.0);\n\t\t#endif\n\t\tdPositionW = posW.xyz;\n\n\t\tvec4 screenPos;\n\t\t#ifdef UV1LAYOUT\n\t\tscreenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n\t\t#else\n\t\t#ifdef SCREENSPACE\n\t\tscreenPos = posW;\n\t\tscreenPos.y *= projectionFlipY;\n\t\t#else\n\t\tscreenPos = matrix_viewProjection * posW;\n\t\t#endif\n\n\t\t#ifdef PIXELSNAP\n\t\t// snap vertex to a pixel boundary\n\t\tscreenPos.xy = (screenPos.xy * 0.5) + 0.5;\n\t\tscreenPos.xy *= uScreenSize.xy;\n\t\tscreenPos.xy = floor(screenPos.xy);\n\t\tscreenPos.xy *= uScreenSize.zw;\n\t\tscreenPos.xy = (screenPos.xy * 2.0) - 1.0;\n\t\t#endif\n\t\t#endif\n\n\t\treturn screenPos;\n}\n\nvec3 getWorldPosition() {\n\t\treturn dPositionW;\n}\n",transformDeclVS:"\nattribute vec3 vertex_position;\n\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\n\nvec3 dPositionW;\nmat4 dModelMatrix;\n",transmissionPS:"\n\n#ifdef MAPFLOAT\nuniform float material_refraction;\n#endif\n\nvoid getRefraction() {\n\t\tfloat refraction = 1.0;\n\n\t\t#ifdef MAPFLOAT\n\t\trefraction = material_refraction;\n\t\t#endif\n\n\t\t#ifdef MAPTEXTURE\n\t\trefraction *= texture2DBias($SAMPLER, $UV, textureBias).$CH;\n\t\t#endif\n\n\t\t#ifdef MAPVERTEX\n\t\trefraction *= saturate(vVertexColor.$VC);\n\t\t#endif\n\n\t\tdTransmission = refraction;\n}\n",uv0VS:"\n#ifdef NINESLICED\nvec2 getUv0() {\n\t\tvec2 uv = vertex_position.xz;\n\n\t\t// offset inner vertices inside\n\t\t// (original vertices must be in [-1;1] range)\n\t\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\t\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\t\tuv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\n\t\tuv = uv * -0.5 + 0.5;\n\t\tuv = uv * atlasRect.zw + atlasRect.xy;\n\n\t\tvMask = vertex_texCoord0.xy;\n\n\t\treturn uv;\n}\n#else\nvec2 getUv0() {\n\t\treturn vertex_texCoord0;\n}\n#endif\n",uv1VS:"\nvec2 getUv1() {\n\t\treturn vertex_texCoord1;\n}\n",viewDirPS:"\nvoid getViewDir() {\n\t\tdViewDirW = normalize(view_position - vPositionW);\n}\n",viewNormalVS:"\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n\nvec3 getViewNormal() {\n\t\treturn mat3(matrix_view) * vNormalW;\n}\n",webgpuPS:as,webgpuVS:os},Pi=new je;function Mi(t){return Pi.get(t)}function Ai(t,e,s,i,n,r=!1){const a=Mi(t);let o=a.getCachedShader(i);return o||(o=new Ie(t,cs.createDefinition(t,{name:i,vertexCode:e,fragmentCode:s,attributes:n,useTransformFeedback:r})),a.setCachedShader(i,o)),o}function ki(t,e){var s;const i=t.definition,n=`${null!=(s=i.name)?s:"shader"}-id-${t.id}`,r={generateKey:function(t){return n},createShaderDefinition:function(t,e){return i}},a="shader",o=Mi(t.device);o.register(a,r);const l=o.getProgram(a,{},e);return o.unregister(a),l}Ei.createShader=function(t,e,s,i=!1){return new Ie(t,cs.createDefinition(t,{name:`${e}_${s}`,vertexCode:Ei[e],fragmentCode:Ei[s],useTransformFeedback:i}))},Ei.createShaderFromCode=Ai;const Di={type:rt,base:0,count:4,indexed:!1},Ri=new O,Li=new O;class Ii{constructor(t){this.uniformBuffer=void 0,this.bindGroup=void 0;const e=t.device;if(this.shader=t,e.supportsUniformBuffers){const s=new Si;this.shader=ki(t,s);const i=this.shader.meshUniformBufferFormat;i&&(this.uniformBuffer=new ze(e,i));const n=this.shader.meshBindGroupFormat;this.bindGroup=new Fe(e,n,this.uniformBuffer)}}destroy(){var t,e;null==(t=this.uniformBuffer)||t.destroy(),this.uniformBuffer=null,null==(e=this.bindGroup)||e.destroy(),this.bindGroup=null}render(t,e){const s=this.shader.device;var i;t&&(Ri.set(s.vx,s.vy,s.vw,s.vh),Li.set(s.sx,s.sy,s.sw,s.sh),e=null!=(i=e)?i:t,s.setViewport(t.x,t.y,t.z,t.w),s.setScissor(e.x,e.y,e.z,e.w));s.setVertexBuffer(s.quadVertexBuffer,0);const n=this.shader;if(s.setShader(n),s.supportsUniformBuffers){const t=this.bindGroup;t.defaultUniformBuffer&&t.defaultUniformBuffer.update(),t.update(),s.setBindGroup(0,t)}s.draw(Di),t&&(s.setViewport(Ri.x,Ri.y,Ri.z,Ri.w),s.setScissor(Li.x,Li.y,Li.z,Li.w))}}const Oi=new O;function Fi(t,e,s,i,n){t.setCullMode(tt),t.setDepthState(te.NODEPTH),t.setStencilState(null,null);const r=new Ii(s);i||((i=Oi).x=0,i.y=0,i.z=e?e.width:t.width,i.w=e?e.height:t.height);const a=new wi(t,(()=>{r.render(i,n)}));if(a.init(e),a.colorOps.clear=!1,a.depthStencilOps.clearDepth=!1,t.isWebGPU&&null===e){var o;(null!=(o=null==e?void 0:e.samples)?o:t.samples)>1&&(a.colorOps.store=!0)}a.render(),r.destroy()}const Bi=new je;class zi{constructor(t,e,s={}){this.index=void 0,this.name=void 0,this.shaderDefine=void 0,this.name=t,this.index=e,Object.assign(this,s),this.initShaderDefines()}initShaderDefines(){let t;this.isShadow?t="SHADOW":this.isForward?t="FORWARD":2===this.index?t="DEPTH":3===this.index&&(t="PICK");const e=t?`#define ${t}_PASS\n`:"",s=`#define ${this.name.toUpperCase()}_PASS\n`;this.shaderDefines=e+s}}class Ni{constructor(){this.passesNamed=new Map,this.passesIndexed=[],this.nextIndex=0;const t=(t,e,s)=>{this.allocate(t,s)};t("forward",0,{isForward:!0}),t("forward_hdr",0,{isForward:!0}),t("depth"),t("pick"),t("shadow")}static get(t){return Bi.get(t,(()=>new Ni))}allocate(t,e){let s=this.passesNamed.get(t);return void 0===s&&(s=new zi(t,this.nextIndex,e),this.passesNamed.set(s.name,s),this.passesIndexed[s.index]=s,this.nextIndex++),s}getByIndex(t){return this.passesIndexed[t]}getByName(t){return this.passesNamed.get(t)}}function Ui(t,e){return e||(e=Ei),1===t||2===t?e.gamma2_2PS?e.gamma2_2PS:Ei.gamma2_2PS:3===t?"#define HDR\n"+(e.gamma2_2PS?e.gamma2_2PS:Ei.gamma2_2PS):e.gamma1_0PS?e.gamma1_0PS:Ei.gamma1_0PS}function Vi(t,e){return e||(e=Ei),1===t?e.tonemappingFilmicPS?e.tonemappingFilmicPS:Ei.tonemappingFilmicPS:0===t?e.tonemappingLinearPS?e.tonemappingLinearPS:Ei.tonemappingLinearPS:2===t?e.tonemappingHejlPS?e.tonemappingHejlPS:Ei.tonemappingHejlPS:3===t?e.tonemappingAcesPS?e.tonemappingAcesPS:Ei.tonemappingAcesPS:4===t?e.tonemappingAces2PS?e.tonemappingAces2PS:Ei.tonemappingAces2PS:e.tonemapingNonePS?e.tonemapingNonePS:Ei.tonemappingNonePS}function Hi(t,e){return e||(e=Ei),"linear"===t?e.fogLinearPS?e.fogLinearPS:Ei.fogLinearPS:"exp"===t?e.fogExpPS?e.fogExpPS:Ei.fogExpPS:"exp2"===t?e.fogExp2PS?e.fogExp2PS:Ei.fogExp2PS:e.fogNonePS?e.fogNonePS:Ei.fogNonePS}function Gi(t,e){return e||(e=Ei),t.supportsBoneTextures?e.skinTexVS:"#define BONE_LIMIT "+t.getBoneLimit()+"\n"+e.skinConstVS}const Wi={generateKey:function(t){let e="basic";return t.fog&&(e+="_fog"),t.alphaTest&&(e+="_atst"),t.vertexColors&&(e+="_vcol"),t.diffuseMap&&(e+="_diff"),t.skin&&(e+="_skin"),t.screenSpace&&(e+="_ss"),t.useInstancing&&(e+="_inst"),t.useMorphPosition&&(e+="_morphp"),t.useMorphNormal&&(e+="_morphn"),t.useMorphTextureBased&&(e+="_morpht"),e+="_"+t.pass,e},createShaderDefinition:function(t,e){const s={vertex_position:at};e.skin&&(s.vertex_boneWeights=ht,s.vertex_boneIndices=ct),e.vertexColors&&(s.vertex_color=dt),e.diffuseMap&&(s.vertex_texCoord0=pt);const i=Ni.get(t).getByIndex(e.pass).shaderDefines;let n=i;n+=Ei.transformDeclVS,e.skin?(n+=Gi(t),n+=Ei.transformSkinnedVS):n+=Ei.transformVS,e.vertexColors&&(n+="attribute vec4 vertex_color;\n",n+="varying vec4 vColor;\n"),e.diffuseMap&&(n+="attribute vec2 vertex_texCoord0;\n",n+="varying vec2 vUv0;\n"),2===e.pass&&(n+="varying float vDepth;\n",n+="#ifndef VIEWMATRIX\n",n+="#define VIEWMATRIX\n",n+="uniform mat4 matrix_view;\n",n+="#endif\n",n+="#ifndef CAMERAPLANES\n",n+="#define CAMERAPLANES\n",n+="uniform vec4 camera_params;\n\n",n+="#endif\n"),n+="void main(void)\n{\n",n+="   gl_Position = getPosition();\n",2===e.pass&&(n+="    vDepth = -(matrix_view * vec4(getWorldPosition(),1.0)).z * camera_params.x;\n"),e.vertexColors&&(n+="    vColor = vertex_color;\n"),e.diffuseMap&&(n+="    vUv0 = vertex_texCoord0;\n"),n+="}\n";let r=i;return e.vertexColors?r+="varying vec4 vColor;\n":r+="uniform vec4 uColor;\n",e.diffuseMap&&(r+="varying vec2 vUv0;\n",r+="uniform sampler2D texture_diffuseMap;\n"),e.fog&&(r+=Hi(e.fog)),e.alphaTest&&(r+=Ei.alphaTestPS),2===e.pass&&(r+="varying float vDepth;\n",r+=Ei.packDepthPS),r+="void main(void)\n{\n",e.vertexColors?r+="    gl_FragColor = vColor;\n":r+="    gl_FragColor = uColor;\n",e.diffuseMap&&(r+="    gl_FragColor *= texture2D(texture_diffuseMap, vUv0);\n"),e.alphaTest&&(r+="   alphaTest(gl_FragColor.a);\n"),3!==e.pass&&(2===e.pass?r+="    gl_FragColor = packFloat(vDepth);\n":e.fog&&(r+="   glFragColor.rgb = addFog(gl_FragColor.rgb);\n")),r+="}\n",cs.createDefinition(t,{name:"BasicShader",attributes:s,vertexCode:n,fragmentCode:r})}},ji=new je;function qi(t){return ji.get(t)}const Xi=[];Xi[0]={src:1,dst:1,op:2},Xi[3]={src:1,dst:0,op:0},Xi[2]={src:6,dst:8,op:0},Xi[4]={src:1,dst:8,op:0},Xi[1]={src:1,dst:1,op:0},Xi[6]={src:6,dst:1,op:0},Xi[7]={src:4,dst:2,op:0},Xi[8]={src:5,dst:1,op:0},Xi[5]={src:4,dst:0,op:0},Xi[9]={src:1,dst:1,op:3},Xi[10]={src:1,dst:1,op:4};let $i=0;class Ki{constructor(){this._shader=null,this.meshInstances=[],this.name="Untitled",this.id=$i++,this.variants={},this.parameters={},this.alphaTest=0,this.alphaToCoverage=!1,this._blendState=new Zt,this._depthState=new te,this.cull=1,this.stencilFront=null,this.stencilBack=null,this.depthBias=0,this.slopeDepthBias=0,this._shaderVersion=0,this._scene=null,this._dirtyBlend=!1,this.dirty=!0}set redWrite(t){this._blendState.redWrite=t}get redWrite(){return this._blendState.redWrite}set greenWrite(t){this._blendState.greenWrite=t}get greenWrite(){return this._blendState.greenWrite}set blueWrite(t){this._blendState.blueWrite=t}get blueWrite(){return this._blendState.blueWrite}set alphaWrite(t){this._blendState.alphaWrite=t}get alphaWrite(){return this._blendState.alphaWrite}set shader(t){this._shader=t}get shader(){return this._shader}get transparent(){return this._blendState.blend}_markBlendDirty(){this._scene?this._scene.layers._dirtyBlend=!0:this._dirtyBlend=!0}set blendState(t){this._blendState.blend!==t.blend&&this._markBlendDirty(),this._blendState.copy(t)}get blendState(){return this._blendState}set blendType(t){const e=Xi[t];this._blendState.setColorBlend(e.op,e.src,e.dst),this._blendState.setAlphaBlend(e.op,e.src,e.dst);const s=3!==t;this._blendState.blend!==s&&(this._blendState.blend=s,this._markBlendDirty()),this._updateMeshInstanceKeys()}get blendType(){if(!this.transparent)return 3;const{colorOp:t,colorSrcFactor:e,colorDstFactor:s,alphaOp:i,alphaSrcFactor:n,alphaDstFactor:r}=this._blendState;for(let a=0;a<Xi.length;a++){const o=Xi[a];if(o.src===e&&o.dst===s&&o.op===t&&o.src===n&&o.dst===r&&o.op===i)return a}return 2}set depthState(t){this._depthState.copy(t)}get depthState(){return this._depthState}set depthTest(t){this._depthState.test=t}get depthTest(){return this._depthState.test}set depthFunc(t){this._depthState.func=t}get depthFunc(){return this._depthState.func}set depthWrite(t){this._depthState.write=t}get depthWrite(){return this._depthState.write}copy(t){var e;return this.name=t.name,this._shader=t._shader,this.alphaTest=t.alphaTest,this.alphaToCoverage=t.alphaToCoverage,this._blendState.copy(t._blendState),this._depthState.copy(t._depthState),this.cull=t.cull,this.depthBias=t.depthBias,this.slopeDepthBias=t.slopeDepthBias,this.stencilFront=null==(e=t.stencilFront)?void 0:e.clone(),t.stencilBack&&(this.stencilBack=t.stencilFront===t.stencilBack?this.stencilFront:t.stencilBack.clone()),this}clone(){return(new this.constructor).copy(this)}_updateMeshInstanceKeys(){const t=this.meshInstances;for(let e=0;e<t.length;e++)t[e].updateKey()}updateUniforms(t,e){}getShaderVariant(t,e,s,i,n,r,a,o,l){const h=new Si(a,o,l);return ki(this._shader,h)}update(){this.dirty=!0,this._shader&&(this._shader.failed=!1)}clearParameters(){this.parameters={}}getParameters(){return this.parameters}clearVariants(){this.variants={};const t=this.meshInstances,e=t.length;for(let s=0;s<e;s++)t[s].clearShaders()}getParameter(t){return this.parameters[t]}setParameter(t,e){if(void 0===e&&"object"==typeof t){const s=t;if(s.length){for(let t=0;t<s.length;t++)this.setParameter(s[t]);return}t=s.name,e=s.value}const s=this.parameters[t];s?s.data=e:this.parameters[t]={scopeId:null,data:e}}deleteParameter(t){this.parameters[t]&&delete this.parameters[t]}setParameters(t,e){const s=this.parameters;void 0===e&&(e=s);for(const i in e){const e=s[i];e&&(e.scopeId||(e.scopeId=t.scope.resolve(i)),e.scopeId.setValue(e.data))}}destroy(){this.variants={},this._shader=null;for(let t=0;t<this.meshInstances.length;t++){const e=this.meshInstances[t];if(e.clearShaders(),e._material=null,e.mesh){const t=qi(e.mesh.device);this!==t&&(e.material=t)}}this.meshInstances.length=0}addMeshInstanceRef(t){this.meshInstances.push(t)}removeMeshInstanceRef(t){const e=this.meshInstances,s=e.indexOf(t);-1!==s&&e.splice(s,1)}}class Yi extends Ki{constructor(){super(),this.color=new D(1,1,1,1),this.colorUniform=new Float32Array(4),this.colorMap=null,this.vertexColors=!1}copy(t){return super.copy(t),this.color.copy(t.color),this.colorMap=t.colorMap,this.vertexColors=t.vertexColors,this}updateUniforms(t,e){this.clearParameters(),this.colorUniform[0]=this.color.r,this.colorUniform[1]=this.color.g,this.colorUniform[2]=this.color.b,this.colorUniform[3]=this.color.a,this.setParameter("uColor",this.colorUniform),this.colorMap&&this.setParameter("texture_diffuseMap",this.colorMap)}getShaderVariant(t,e,s,i,n,r,a,o,l){if(this.updateShader)return this.updateShader(t,e,s,i,n,r),this.shader;const h={skin:s&&0!=(2&s),screenSpace:s&&0!=(s&ei),useInstancing:s&&0!=(32&s),useMorphPosition:s&&0!=(s&si),useMorphNormal:s&&0!=(s&ii),useMorphTextureBased:s&&0!=(s&ni),alphaTest:this.alphaTest>0,vertexColors:this.vertexColors,diffuseMap:!!this.colorMap,pass:n},c=new Si(a,o,l),d=Mi(t);return d.register("basic",Wi),d.getProgram("basic",h,c)}}class Qi{constructor(t,e,s,i,n=[0]){this._ui=!1,this._sprite=!1,this._obj={model:[],element:[],sprite:[],render:[]},this.id=void 0,this.name=void 0,this.dynamic=void 0,this.maxAabbSize=void 0,this.layers=void 0,this.id=t,this.name=e,this.dynamic=s,this.maxAabbSize=i,this.layers=n}}Qi.MODEL="model",Qi.ELEMENT="element",Qi.SPRITE="sprite",Qi.RENDER="render";const Ji=new V;class Zi{constructor(t){this.bones=void 0,this._dirty=!0,this._rootBone=null,this._skinUpdateIndex=-1,this._updateBeforeCull=!0,t&&this.initSkin(t)}set rootBone(t){this._rootBone=t}get rootBone(){return this._rootBone}init(t,e){if(t.supportsBoneTextures){const s=3*e;let i=Math.ceil(Math.sqrt(s));i=k.roundUp(i,3);const n=Math.ceil(s/i);this.boneTexture=new Ue(t,{width:i,height:n,format:st,mipmaps:!1,minFilter:0,magFilter:0,name:"skin"}),this.matrixPalette=this.boneTexture.lock()}else this.matrixPalette=new Float32Array(12*e)}destroy(){this.boneTexture&&(this.boneTexture.destroy(),this.boneTexture=null)}resolve(t,e){this.rootBone=t;const s=this.skin,i=[];for(let n=0;n<s.boneNames.length;n++){const r=s.boneNames[n];let a=t.findByName(r);a||(a=e),i.push(a)}this.bones=i}initSkin(t){this.skin=t,this.bones=[];const e=t.inverseBindPose.length;this.init(t.device,e),this.matrices=[];for(let t=0;t<e;t++)this.matrices[t]=new V}uploadBones(t){t.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())}_updateMatrices(t,e){if(this._skinUpdateIndex!==e){this._skinUpdateIndex=e,Ji.copy(t.getWorldTransform()).invert();for(let t=this.bones.length-1;t>=0;t--)this.matrices[t].mulAffine2(Ji,this.bones[t].getWorldTransform()),this.matrices[t].mulAffine2(this.matrices[t],this.skin.inverseBindPose[t])}}updateMatrices(t,e){this._updateBeforeCull&&this._updateMatrices(t,e)}updateMatrixPalette(t,e){this._updateMatrices(t,e);const s=this.matrixPalette,i=this.bones.length;for(let t=0;t<i;t++){const e=this.matrices[t].data,i=12*t;s[i]=e[0],s[i+1]=e[4],s[i+2]=e[8],s[i+3]=e[12],s[i+4]=e[1],s[i+5]=e[5],s[i+6]=e[9],s[i+7]=e[13],s[i+8]=e[2],s[i+9]=e[6],s[i+10]=e[10],s[i+11]=e[14]}this.uploadBones(this.skin.device)}}const tn=new V,en=new R,sn=new H,nn=new H,rn=new R,an=new R,on=new V,ln=new H,hn=new R,cn=new V,dn=new H,un=new H,pn=new V,fn=new R,mn=new R;class gn extends h{constructor(t="Untitled"){super(),this.name=void 0,this.tags=new E(this),this._labels={},this.localPosition=new R,this.localRotation=new H,this.localScale=new R(1,1,1),this.localEulerAngles=new R,this.position=new R,this.rotation=new H,this.eulerAngles=new R,this._scale=null,this.localTransform=new V,this._dirtyLocal=!1,this._aabbVer=0,this._frozen=!1,this.worldTransform=new V,this._dirtyWorld=!1,this._worldScaleSign=0,this._normalMatrix=new L,this._dirtyNormal=!0,this._right=null,this._up=null,this._forward=null,this._parent=null,this._children=[],this._graphDepth=0,this._enabled=!0,this._enabledInHierarchy=!1,this.scaleCompensation=!1,this.name=t}get right(){return this._right||(this._right=new R),this.getWorldTransform().getX(this._right).normalize()}get up(){return this._up||(this._up=new R),this.getWorldTransform().getY(this._up).normalize()}get forward(){return this._forward||(this._forward=new R),this.getWorldTransform().getZ(this._forward).normalize().mulScalar(-1)}get normalMatrix(){const t=this._normalMatrix;return this._dirtyNormal&&(this.getWorldTransform().invertTo3x3(t),t.transpose(),this._dirtyNormal=!1),t}set enabled(t){var e;this._enabled!==t&&(this._enabled=t,(t&&null!=(e=this._parent)&&e.enabled||!t)&&this._notifyHierarchyStateChanged(this,t))}get enabled(){return this._enabled&&this._enabledInHierarchy}get parent(){return this._parent}get path(){let t=this._parent;if(!t)return"";let e=this.name;for(;t&&t._parent;)e=`${t.name}/${e}`,t=t._parent;return e}get root(){let t=this;for(;t._parent;)t=t._parent;return t}get children(){return this._children}get graphDepth(){return this._graphDepth}_notifyHierarchyStateChanged(t,e){t._onHierarchyStateChanged(e);const s=t._children;for(let t=0,i=s.length;t<i;t++)s[t]._enabled&&this._notifyHierarchyStateChanged(s[t],e)}_onHierarchyStateChanged(t){this._enabledInHierarchy=t,t&&!this._frozen&&this._unfreezeParentToRoot()}_cloneInternal(t){t.name=this.name;const e=this.tags._list;t.tags.clear();for(let s=0;s<e.length;s++)t.tags.add(e[s]);t._labels=Object.assign({},this._labels),t.localPosition.copy(this.localPosition),t.localRotation.copy(this.localRotation),t.localScale.copy(this.localScale),t.localEulerAngles.copy(this.localEulerAngles),t.position.copy(this.position),t.rotation.copy(this.rotation),t.eulerAngles.copy(this.eulerAngles),t.localTransform.copy(this.localTransform),t._dirtyLocal=this._dirtyLocal,t.worldTransform.copy(this.worldTransform),t._dirtyWorld=this._dirtyWorld,t._dirtyNormal=this._dirtyNormal,t._aabbVer=this._aabbVer+1,t._enabled=this._enabled,t.scaleCompensation=this.scaleCompensation,t._enabledInHierarchy=!1}clone(){const t=new this.constructor;return this._cloneInternal(t),t}copy(t){return t._cloneInternal(this),this}find(t,e){let s,i=[];const n=this._children.length;if(t instanceof Function){const e=t;s=e(this),s&&i.push(this);for(let t=0;t<n;t++){const s=this._children[t].find(e);s.length&&(i=i.concat(s))}}else{let s;this[t]&&(s=this[t]instanceof Function?this[t]():this[t],s===e&&i.push(this));for(let s=0;s<n;++s){const n=this._children[s].find(t,e);n.length&&(i=i.concat(n))}}return i}findOne(t,e){const s=this._children.length;let i=null;if(t instanceof Function){const e=t;if(i=e(this),i)return this;for(let t=0;t<s;t++)if(i=this._children[t].findOne(e),i)return i}else{let n;if(this[t]&&(n=this[t]instanceof Function?this[t]():this[t],n===e))return this;for(let n=0;n<s;n++)if(i=this._children[n].findOne(t,e),null!==i)return i}return null}findByTag(){const t=arguments,e=[],s=(i,n)=>{n&&i.tags.has(...t)&&e.push(i);for(let t=0;t<i._children.length;t++)s(i._children[t],!0)};return s(this,!1),e}findByName(t){if(this.name===t)return this;for(let e=0;e<this._children.length;e++){const s=this._children[e].findByName(t);if(null!==s)return s}return null}findByPath(t){const e=Array.isArray(t)?t:t.split("/");let s=this;for(let t=0,i=e.length;t<i;++t)if(s=s.children.find((s=>s.name===e[t])),!s)return null;return s}forEach(t,e){t.call(e,this);const s=this._children;for(let i=0;i<s.length;i++)s[i].forEach(t,e)}isDescendantOf(t){let e=this._parent;for(;e;){if(e===t)return!0;e=e._parent}return!1}isAncestorOf(t){return t.isDescendantOf(this)}getEulerAngles(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles}getLocalEulerAngles(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles}getLocalPosition(){return this.localPosition}getLocalRotation(){return this.localRotation}getLocalScale(){return this.localScale}getLocalTransform(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this.localTransform}getPosition(){return this.getWorldTransform().getTranslation(this.position),this.position}getRotation(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation}getScale(){return this._scale||(this._scale=new R),this.getWorldTransform().getScale(this._scale)}getWorldTransform(){return this._dirtyLocal||this._dirtyWorld?(this._parent&&this._parent.getWorldTransform(),this._sync(),this.worldTransform):this.worldTransform}get worldScaleSign(){return 0===this._worldScaleSign&&(this._worldScaleSign=this.getWorldTransform().scaleSign),this._worldScaleSign}reparent(t,e){const s=this._parent;s&&s.removeChild(this),t&&(e>=0?t.insertChild(this,e):t.addChild(this))}setLocalEulerAngles(t,e,s){this.localRotation.setFromEulerAngles(t,e,s),this._dirtyLocal||this._dirtifyLocal()}setLocalPosition(t,e,s){t instanceof R?this.localPosition.copy(t):this.localPosition.set(t,e,s),this._dirtyLocal||this._dirtifyLocal()}setLocalRotation(t,e,s,i){t instanceof H?this.localRotation.copy(t):this.localRotation.set(t,e,s,i),this._dirtyLocal||this._dirtifyLocal()}setLocalScale(t,e,s){t instanceof R?this.localScale.copy(t):this.localScale.set(t,e,s),this._dirtyLocal||this._dirtifyLocal()}_dirtifyLocal(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())}_unfreezeParentToRoot(){let t=this._parent;for(;t;)t._frozen=!1,t=t._parent}_dirtifyWorld(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal()}_dirtifyWorldInternal(){if(!this._dirtyWorld){this._frozen=!1,this._dirtyWorld=!0;for(let t=0;t<this._children.length;t++)this._children[t]._dirtyWorld||this._children[t]._dirtifyWorldInternal()}this._dirtyNormal=!0,this._worldScaleSign=0,this._aabbVer++}setPosition(t,e,s){t instanceof R?hn.copy(t):hn.set(t,e,s),null===this._parent?this.localPosition.copy(hn):(cn.copy(this._parent.getWorldTransform()).invert(),cn.transformPoint(hn,this.localPosition)),this._dirtyLocal||this._dirtifyLocal()}setRotation(t,e,s,i){if(t instanceof H?dn.copy(t):dn.set(t,e,s,i),null===this._parent)this.localRotation.copy(dn);else{const t=this._parent.getRotation();un.copy(t).invert(),this.localRotation.copy(un).mul(dn)}this._dirtyLocal||this._dirtifyLocal()}setEulerAngles(t,e,s){if(this.localRotation.setFromEulerAngles(t,e,s),null!==this._parent){const t=this._parent.getRotation();un.copy(t).invert(),this.localRotation.mul2(un,this.localRotation)}this._dirtyLocal||this._dirtifyLocal()}addChild(t){this._prepareInsertChild(t),this._children.push(t),this._onInsertChild(t)}addChildAndSaveTransform(t){const e=t.getPosition(),s=t.getRotation();this._prepareInsertChild(t),t.setPosition(on.copy(this.worldTransform).invert().transformPoint(e)),t.setRotation(ln.copy(this.getRotation()).invert().mul(s)),this._children.push(t),this._onInsertChild(t)}insertChild(t,e){this._prepareInsertChild(t),this._children.splice(e,0,t),this._onInsertChild(t)}_prepareInsertChild(t){t._parent&&t._parent.removeChild(t)}_fireOnHierarchy(t,e,s){this.fire(t,s);for(let t=0;t<this._children.length;t++)this._children[t]._fireOnHierarchy(e,e,s)}_onInsertChild(t){t._parent=this;const e=t._enabled&&this.enabled;t._enabledInHierarchy!==e&&(t._enabledInHierarchy=e,t._notifyHierarchyStateChanged(t,e)),t._updateGraphDepth(),t._dirtifyWorld(),this._frozen&&t._unfreezeParentToRoot(),t._fireOnHierarchy("insert","inserthierarchy",this),this.fire&&this.fire("childinsert",t)}_updateGraphDepth(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(let t=0,e=this._children.length;t<e;t++)this._children[t]._updateGraphDepth()}removeChild(t){const e=this._children.indexOf(t);-1!==e&&(this._children.splice(e,1),t._parent=null,t._fireOnHierarchy("remove","removehierarchy",this),this.fire("childremove",t))}_sync(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){let t;const e=this._parent;let s=this.localScale,i=e;if(i){for(;i&&i.scaleCompensation;)i=i._parent;i&&(i=i._parent,i&&(t=i.worldTransform.getScale(),rn.mul2(t,this.localScale),s=rn))}nn.setFromMat4(e.worldTransform),sn.mul2(nn,this.localRotation);let n=e.worldTransform;e.scaleCompensation&&(an.mul2(t,e.getLocalScale()),tn.setTRS(e.worldTransform.getTranslation(en),nn,an),n=tn),n.transformPoint(this.localPosition,en),this.worldTransform.setTRS(en,sn,s)}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}}syncHierarchy(){if(!this._enabled)return;if(this._frozen)return;this._frozen=!0,(this._dirtyLocal||this._dirtyWorld)&&this._sync();const t=this._children;for(let e=0,s=t.length;e<s;e++)t[e].syncHierarchy()}lookAt(t,e,s,i=0,n=1,r=0){if(t instanceof R)fn.copy(t),e instanceof R?mn.copy(e):mn.copy(R.UP);else{if(void 0===s)return;fn.set(t,e,s),mn.set(i,n,r)}pn.setLookAt(this.getPosition(),fn,mn),dn.setFromMat4(pn),this.setRotation(dn)}translate(t,e,s){t instanceof R?hn.copy(t):hn.set(t,e,s),hn.add(this.getPosition()),this.setPosition(hn)}translateLocal(t,e,s){t instanceof R?hn.copy(t):hn.set(t,e,s),this.localRotation.transformVector(hn,hn),this.localPosition.add(hn),this._dirtyLocal||this._dirtifyLocal()}rotate(t,e,s){if(dn.setFromEulerAngles(t,e,s),null===this._parent)this.localRotation.mul2(dn,this.localRotation);else{const t=this.getRotation(),e=this._parent.getRotation();un.copy(e).invert(),dn.mul2(un,dn),this.localRotation.mul2(dn,t)}this._dirtyLocal||this._dirtifyLocal()}rotateLocal(t,e,s){dn.setFromEulerAngles(t,e,s),this.localRotation.mul(dn),this._dirtyLocal||this._dirtifyLocal()}}class _n{static incRef(t){this.cache.incRef(t)}static decRef(t){this.cache.decRef(t)}static destroy(){this.cache.destroy()}}_n.cache=new class{constructor(){this.cache=new Map}destroy(){this.cache.forEach(((t,e)=>{e.destroy()})),this.cache.clear()}incRef(t){const e=(this.cache.get(t)||0)+1;this.cache.set(t,e)}decRef(t){if(t){let e=this.cache.get(t);e&&(e--,0===e?(this.cache.delete(t),t.destroy()):this.cache.set(t,e))}}};const vn=new $,bn=new $,yn=new Q,xn=new Set;class wn{constructor(t){this.vertexBuffer=null,this.count=t}}class Sn{constructor(t,e,s=null){if(this.visible=!0,this.castShadow=!1,this._material=void 0,this._shader=[],this._bindGroups=[],t instanceof gn){const i=t;t=e,e=s,s=i}this._key=[0,0],this.isStatic=!1,this._staticLightList=null,this._staticSource=null,this.node=s,this._mesh=t,t.incRefCount(),this.material=e,this._shaderDefs=65536,this._shaderDefs|=t.vertexBuffer.format.hasUv0?4:0,this._shaderDefs|=t.vertexBuffer.format.hasUv1?8:0,this._shaderDefs|=t.vertexBuffer.format.hasColor?16:0,this._shaderDefs|=t.vertexBuffer.format.hasTangents?512:0,this._lightHash=0,this.layer=15,this._renderStyle=0,this._receiveShadow=!0,this._screenSpace=!1,this._noDepthDrawGl1=!1,this.cull=!0,this.pick=!0,this._updateAabb=!0,this._updateAabbFunc=null,this._calculateSortDistance=null,this.updateKey(),this._skinInstance=null,this._morphInstance=null,this.instancingData=null,this._customAabb=null,this.aabb=new $,this._aabbVer=-1,this.drawOrder=0,this.visibleThisFrame=!1,this.isVisibleFunc=null,this.parameters={},this.stencilFront=null,this.stencilBack=null,this.flipFacesFactor=1}set renderStyle(t){this._renderStyle=t,this.mesh.prepareRenderState(t)}get renderStyle(){return this._renderStyle}set mesh(t){t!==this._mesh&&(this._mesh&&this._mesh.decRefCount(),this._mesh=t,t&&t.incRefCount())}get mesh(){return this._mesh}set aabb(t){this._aabb=t}get aabb(){if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);let t=this._customAabb,e=!!t;if(!t)if(t=vn,this.skinInstance){if(!this.mesh.boneAabb){const t=this._morphInstance?this._morphInstance.morph._targets:null;this.mesh._initBoneAabbs(t)}const s=this.mesh.boneUsed;let i=!0;for(let e=0;e<this.mesh.boneAabb.length;e++)s[e]&&(bn.setFromTransformedAabb(this.mesh.boneAabb[e],this.skinInstance.matrices[e]),i?(i=!1,t.center.copy(bn.center),t.halfExtents.copy(bn.halfExtents)):t.add(bn));e=!0}else if(this.node._aabbVer!==this._aabbVer){if(this.mesh?(t.center.copy(this.mesh.aabb.center),t.halfExtents.copy(this.mesh.aabb.halfExtents)):(t.center.set(0,0,0),t.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph){const e=this.mesh.morph.aabb;t._expand(e.getMin(),e.getMax())}e=!0,this._aabbVer=this.node._aabbVer}return e&&this._aabb.setFromTransformedAabb(t,this.node.getWorldTransform()),this._aabb}clearShaders(){const t=this._shader;for(let e=0;e<t.length;e++)t[e]=null;this.destroyBindGroups()}destroyBindGroups(){const t=this._bindGroups;for(let e=0;e<t.length;e++){const s=t[e];if(s){const t=s.defaultUniformBuffer;t&&t.destroy(),s.destroy()}}t.length=0}getBindGroup(t,e){let s=this._bindGroups[e];if(!s){const i=this._shader[e],n=i.meshUniformBufferFormat,r=new ze(t,n),a=i.meshBindGroupFormat;s=new Fe(t,a,r),this._bindGroups[e]=s}return s}set material(t){this.clearShaders();const e=this._material;if(e&&e.removeMeshInstanceRef(this),this._material=t,t){t.addMeshInstanceRef(this),this.updateKey();const s=e&&e.transparent;if(t.transparent!==s){const s=this._material._scene||(null==e?void 0:e._scene);s?s.layers._dirtyBlend=!0:t._dirtyBlend=!0}}}get material(){return this._material}set layer(t){this._layer=t,this.updateKey()}get layer(){return this._layer}set calculateSortDistance(t){this._calculateSortDistance=t}get calculateSortDistance(){return this._calculateSortDistance}set receiveShadow(t){this._receiveShadow=t,this._shaderDefs=t?-2&this._shaderDefs:1|this._shaderDefs,this._shader[0]=null,this._shader[1]=null}get receiveShadow(){return this._receiveShadow}set skinInstance(t){this._skinInstance=t;let e=this._shaderDefs;e=t?2|e:-3&e,e!==this._shaderDefs&&(this._shaderDefs=e,this.clearShaders()),this._setupSkinUpdate()}get skinInstance(){return this._skinInstance}set morphInstance(t){var e;null==(e=this._morphInstance)||e.destroy(),this._morphInstance=t;let s=this._shaderDefs;s=t&&t.morph.useTextureMorph?s|ni:-4097&s,s=t&&t.morph.morphPositions?s|si:-1025&s,s=t&&t.morph.morphNormals?s|ii:-2049&s,s!==this._shaderDefs&&(this._shaderDefs=s,this.clearShaders())}get morphInstance(){return this._morphInstance}set screenSpace(t){this._screenSpace=t,this._shaderDefs=t?this._shaderDefs|ei:-257&this._shaderDefs,this._shader[0]=null}get screenSpace(){return this._screenSpace}set key(t){this._key[0]=t}get key(){return this._key[0]}set mask(t){const e=65535&this._shaderDefs;this._shaderDefs=e|t<<16,this._shader[0]=null,this._shader[1]=null}get mask(){return this._shaderDefs>>16}set instancingCount(t){this.instancingData&&(this.instancingData.count=t)}get instancingCount(){return this.instancingData?this.instancingData.count:0}destroy(){var t,e;const s=this.mesh;s&&(this.mesh=null,s.refCount<1&&s.destroy()),this.setRealtimeLightmap(Sn.lightmapParamNames[0],null),this.setRealtimeLightmap(Sn.lightmapParamNames[1],null),null==(t=this._skinInstance)||t.destroy(),this._skinInstance=null,null==(e=this.morphInstance)||e.destroy(),this.morphInstance=null,this.clearShaders(),this.material=null}static _prepareRenderStyleForArray(t,e){if(t){for(let s=0;s<t.length;s++){t[s]._renderStyle=e;const i=t[s].mesh;xn.has(i)||(xn.add(i),i.prepareRenderState(e))}xn.clear()}}_isVisible(t){return!!this.visible&&(this.isVisibleFunc?this.isVisibleFunc(t):(yn.center=this.aabb.center,yn.radius=this._aabb.halfExtents.length(),t.frustum.containsSphere(yn)))}updateKey(){const t=this.material;var e,s,i,n;this._key[0]=(e=this.layer,s=t.alphaToCoverage||t.alphaTest?2:t.blendType,i=!1,n=t.id,(15&e)<<27|(3===s?1:0)<<26|(i?1:0)<<25|(33554431&n)<<0)}setInstancing(t){t?(this.instancingData=new wn(t.numVertices),this.instancingData.vertexBuffer=t,t.format.instancing=!0,this.cull=!1):(this.instancingData=null,this.cull=!0)}updatePassShader(t,e,s,i,n,r){this._shader[e]=this.material.getShaderVariant(this.mesh.device,t,this._shaderDefs,s,e,i,n,r,this._mesh.vertexBuffer.format)}ensureMaterial(t){this.material||(this.material=qi(t))}clearParameters(){this.parameters={}}getParameters(){return this.parameters}getParameter(t){return this.parameters[t]}setParameter(t,e,s=-262141){if(void 0===e&&"object"==typeof t){const s=t;if(s.length){for(let t=0;t<s.length;t++)this.setParameter(s[t]);return}t=s.name,e=s.value}const i=this.parameters[t];i?(i.data=e,i.passFlags=s):this.parameters[t]={scopeId:null,data:e,passFlags:s}}setRealtimeLightmap(t,e){const s=this.getParameter(t);s!==e&&(s&&_n.decRef(s.data),e?(_n.incRef(e),this.setParameter(t,e)):this.deleteParameter(t))}deleteParameter(t){this.parameters[t]&&delete this.parameters[t]}setParameters(t,e){const s=this.parameters;for(const i in s){const n=s[i];n.passFlags&e&&(n.scopeId||(n.scopeId=t.scope.resolve(i)),n.scopeId.setValue(n.data))}}setLightmapped(t){t?this.mask=-6&(2|this.mask):(this.setRealtimeLightmap(Sn.lightmapParamNames[0],null),this.setRealtimeLightmap(Sn.lightmapParamNames[1],null),this._shaderDefs&=-8385,this.mask=-7&(1|this.mask))}setCustomAabb(t){t?this._customAabb?this._customAabb.copy(t):this._customAabb=t.clone():(this._customAabb=null,this._aabbVer=-1),this._setupSkinUpdate()}_setupSkinUpdate(){this._skinInstance&&(this._skinInstance._updateBeforeCull=!this._customAabb)}}Sn.lightmapParamNames=["texture_lightMap","texture_dirLightMap"];const Cn=new R,Tn=new R,En=new R,Pn=new V,Mn=[new R,new R,new R,new R,new R,new R,new R,new R];class An{constructor(){this.shaderPassInfo=void 0,this._aspectRatio=16/9,this._aspectRatioMode=0,this._calculateProjection=null,this._calculateTransform=null,this._clearColor=new D(.75,.75,.75,1),this._clearColorBuffer=!0,this._clearDepth=1,this._clearDepthBuffer=!0,this._clearStencil=0,this._clearStencilBuffer=!0,this._cullingMask=4294967295,this._cullFaces=!0,this._farClip=1e3,this._flipFaces=!1,this._fov=45,this._frustumCulling=!0,this._horizontalFov=!1,this._layers=[0,1,2,4,3],this._layersSet=new Set(this._layers),this._nearClip=.1,this._node=null,this._orthoHeight=10,this._projection=0,this._rect=new O(0,0,1,1),this._renderTarget=null,this._scissorRect=new O(0,0,1,1),this._scissorRectClear=!1,this._aperture=16,this._shutter=.001,this._sensitivity=1e3,this._projMat=new V,this._projMatDirty=!0,this._projMatSkybox=new V,this._viewMat=new V,this._viewMatDirty=!0,this._viewProjMat=new V,this._viewProjMatDirty=!0,this.frustum=new J,this._xr=null,this._xrProperties={horizontalFov:this._horizontalFov,fov:this._fov,aspectRatio:this._aspectRatio,farClip:this._farClip,nearClip:this._nearClip}}get fullSizeClearRect(){const t=this._scissorRectClear?this.scissorRect:this._rect;return 0===t.x&&0===t.y&&1===t.z&&1===t.w}set aspectRatio(t){this._aspectRatio!==t&&(this._aspectRatio=t,this._projMatDirty=!0)}get aspectRatio(){var t;return null!=(t=this.xr)&&t.active?this._xrProperties.aspectRatio:this._aspectRatio}set aspectRatioMode(t){this._aspectRatioMode!==t&&(this._aspectRatioMode=t,this._projMatDirty=!0)}get aspectRatioMode(){return this._aspectRatioMode}set calculateProjection(t){this._calculateProjection=t,this._projMatDirty=!0}get calculateProjection(){return this._calculateProjection}set calculateTransform(t){this._calculateTransform=t}get calculateTransform(){return this._calculateTransform}set clearColor(t){this._clearColor.copy(t)}get clearColor(){return this._clearColor}set clearColorBuffer(t){this._clearColorBuffer=t}get clearColorBuffer(){return this._clearColorBuffer}set clearDepth(t){this._clearDepth=t}get clearDepth(){return this._clearDepth}set clearDepthBuffer(t){this._clearDepthBuffer=t}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencil(t){this._clearStencil=t}get clearStencil(){return this._clearStencil}set clearStencilBuffer(t){this._clearStencilBuffer=t}get clearStencilBuffer(){return this._clearStencilBuffer}set cullingMask(t){this._cullingMask=t}get cullingMask(){return this._cullingMask}set cullFaces(t){this._cullFaces=t}get cullFaces(){return this._cullFaces}set farClip(t){this._farClip!==t&&(this._farClip=t,this._projMatDirty=!0)}get farClip(){var t;return null!=(t=this.xr)&&t.active?this._xrProperties.farClip:this._farClip}set flipFaces(t){this._flipFaces=t}get flipFaces(){return this._flipFaces}set fov(t){this._fov!==t&&(this._fov=t,this._projMatDirty=!0)}get fov(){var t;return null!=(t=this.xr)&&t.active?this._xrProperties.fov:this._fov}set frustumCulling(t){this._frustumCulling=t}get frustumCulling(){return this._frustumCulling}set horizontalFov(t){this._horizontalFov!==t&&(this._horizontalFov=t,this._projMatDirty=!0)}get horizontalFov(){var t;return null!=(t=this.xr)&&t.active?this._xrProperties.horizontalFov:this._horizontalFov}set layers(t){this._layers=t.slice(0),this._layersSet=new Set(this._layers)}get layers(){return this._layers}get layersSet(){return this._layersSet}set nearClip(t){this._nearClip!==t&&(this._nearClip=t,this._projMatDirty=!0)}get nearClip(){var t;return null!=(t=this.xr)&&t.active?this._xrProperties.nearClip:this._nearClip}set node(t){this._node=t}get node(){return this._node}set orthoHeight(t){this._orthoHeight!==t&&(this._orthoHeight=t,this._projMatDirty=!0)}get orthoHeight(){return this._orthoHeight}set projection(t){this._projection!==t&&(this._projection=t,this._projMatDirty=!0)}get projection(){return this._projection}get projectionMatrix(){return this._evaluateProjectionMatrix(),this._projMat}set rect(t){this._rect.copy(t)}get rect(){return this._rect}set renderTarget(t){this._renderTarget=t}get renderTarget(){return this._renderTarget}set scissorRect(t){this._scissorRect.copy(t)}get scissorRect(){return this._scissorRect}get viewMatrix(){if(this._viewMatDirty){const t=this._node.getWorldTransform();this._viewMat.copy(t).invert(),this._viewMatDirty=!1}return this._viewMat}set aperture(t){this._aperture=t}get aperture(){return this._aperture}set sensitivity(t){this._sensitivity=t}get sensitivity(){return this._sensitivity}set shutter(t){this._shutter=t}get shutter(){return this._shutter}set xr(t){this._xr!==t&&(this._xr=t,this._projMatDirty=!0)}get xr(){return this._xr}clone(){return(new An).copy(this)}copy(t){return this._aspectRatio=t._aspectRatio,this._farClip=t._farClip,this._fov=t._fov,this._horizontalFov=t._horizontalFov,this._nearClip=t._nearClip,this._xrProperties.aspectRatio=t._xrProperties.aspectRatio,this._xrProperties.farClip=t._xrProperties.farClip,this._xrProperties.fov=t._xrProperties.fov,this._xrProperties.horizontalFov=t._xrProperties.horizontalFov,this._xrProperties.nearClip=t._xrProperties.nearClip,this.aspectRatioMode=t.aspectRatioMode,this.calculateProjection=t.calculateProjection,this.calculateTransform=t.calculateTransform,this.clearColor=t.clearColor,this.clearColorBuffer=t.clearColorBuffer,this.clearDepth=t.clearDepth,this.clearDepthBuffer=t.clearDepthBuffer,this.clearStencil=t.clearStencil,this.clearStencilBuffer=t.clearStencilBuffer,this.cullFaces=t.cullFaces,this.cullingMask=t.cullingMask,this.flipFaces=t.flipFaces,this.frustumCulling=t.frustumCulling,this.layers=t.layers,this.orthoHeight=t.orthoHeight,this.projection=t.projection,this.rect=t.rect,this.renderTarget=t.renderTarget,this.scissorRect=t.scissorRect,this.aperture=t.aperture,this.shutter=t.shutter,this.sensitivity=t.sensitivity,this.shaderPassInfo=t.shaderPassInfo,this._projMatDirty=!0,this}_updateViewProjMat(){(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty)&&(this._viewProjMat.mul2(this.projectionMatrix,this.viewMatrix),this._viewProjMatDirty=!1)}worldToScreen(t,e,s,i=new R){this._updateViewProjMat(),this._viewProjMat.transformPoint(t,i);const n=this._viewProjMat.data,r=t.x*n[3]+t.y*n[7]+t.z*n[11]+1*n[15];return i.x=.5*(i.x/r+1)*e,i.y=.5*(1-i.y/r)*s,i}screenToWorld(t,e,s,i,n,r=new R){const a=this.farClip-this.nearClip;if(Cn.set(t/i,(n-e)/n,s/a),Cn.mulScalar(2),Cn.sub(R.ONE),0===this._projection){V._getPerspectiveHalfSize(Tn,this.fov,this.aspectRatio,this.nearClip,this.horizontalFov),Tn.x*=Cn.x,Tn.y*=Cn.y;const t=this._node.getWorldTransform();Tn.z=-this.nearClip,t.transformPoint(Tn,En);const e=this._node.getPosition();r.sub2(En,e),r.normalize(),r.mulScalar(s),r.add(e)}else this._updateViewProjMat(),Pn.copy(this._viewProjMat).invert(),Pn.transformPoint(Cn,r);return r}_evaluateProjectionMatrix(){if(this._projMatDirty){if(0===this._projection)this._projMat.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip,this.horizontalFov),this._projMatSkybox.copy(this._projMat);else{const t=this._orthoHeight,e=t*this.aspectRatio;this._projMat.setOrtho(-e,e,-t,t,this.nearClip,this.farClip),this._projMatSkybox.setPerspective(this.fov,this.aspectRatio,this.nearClip,this.farClip)}this._projMatDirty=!1}}getProjectionMatrixSkybox(){return this._evaluateProjectionMatrix(),this._projMatSkybox}getExposure(){const t=Math.log2(this._aperture*this._aperture/this._shutter*100/this._sensitivity);return 1/(1.2*Math.pow(2,t))}getScreenSize(t){if(0===this._projection){const e=this._node.getPosition().distance(t.center);if(e<t.radius)return 1;const s=Math.asin(t.radius/e),i=Math.tan(s),n=Math.tan(this.fov/2*k.DEG_TO_RAD);return Math.min(i/n,1)}return k.clamp(t.radius/this._orthoHeight,0,1)}getFrustumCorners(t=this.nearClip,e=this.farClip){const s=this.fov*Math.PI/180;let i=0===this._projection?Math.tan(s/2)*t:this._orthoHeight,n=i*this.aspectRatio;const r=Mn;return r[0].x=n,r[0].y=-i,r[0].z=-t,r[1].x=n,r[1].y=i,r[1].z=-t,r[2].x=-n,r[2].y=i,r[2].z=-t,r[3].x=-n,r[3].y=-i,r[3].z=-t,0===this._projection&&(i=Math.tan(s/2)*e,n=i*this.aspectRatio),r[4].x=n,r[4].y=-i,r[4].z=-e,r[5].x=n,r[5].y=i,r[5].z=-e,r[6].x=-n,r[6].y=i,r[6].z=-e,r[7].x=-n,r[7].y=-i,r[7].z=-e,r}setXrProperties(t){Object.assign(this._xrProperties,t),this._projMatDirty=!0}}const kn=1/255,Dn=new Float32Array(1),Rn=new Int32Array(Dn.buffer);class Ln{static float2Half(t){Dn[0]=t;const e=Rn[0];let s=e>>16&32768,i=e>>12&2047;const n=e>>23&255;return n<103?s:n>142?(s|=31744,s|=(255===n?0:1)&&8388607&e,s):n<113?(i|=2048,s|=(i>>114-n)+(i>>113-n&1),s):(s|=n-112<<10|i>>1,s+=1&i,s)}static float2Bytes(t,e,s,i){const n=255*t%1;if(e[s+0]=Math.round(255*(t%1-kn*n)),i>1){const r=65025*t%1;if(e[s+1]=Math.round(255*(n-kn*r)),i>2){const n=16581375*t%1;e[s+2]=Math.round(255*(r-kn*n)),i>3&&(e[s+3]=Math.round(255*n))}}}static float2BytesRange(t,e,s,i,n,r){t=k.clamp((t-i)/(n-i),0,1),Ln.float2Bytes(t,e,s,r)}static float2MantissaExponent(t,e,s,i){const n=Math.floor(Math.log2(Math.abs(t)))+1;t/=Math.pow(2,n),Ln.float2BytesRange(t,e,s,-1,1,i-1),e[s+i-1]=Math.round(n+127)}}const In=new V,On=new V,Fn=new V;class Bn{static create(t,e,s){const i=new An;switch(i.node=new gn(t),i.aspectRatio=1,i.aspectRatioMode=1,i._scissorRectClear=!0,e){case 1:i.node.setRotation(Bn.pointLightRotations[s]),i.fov=90,i.projection=0;break;case 2:i.projection=0;break;case 0:i.projection=1}return i}static evalSpotCookieMatrix(t){let e=Bn._spotCookieCamera;e||(e=Bn.create("SpotCookieCamera",2),Bn._spotCookieCamera=e),e.fov=2*t._outerConeAngle;const s=e._node;s.setPosition(t._node.getPosition()),s.setRotation(t._node.getRotation()),s.rotateLocal(-90,0,0),In.setTRS(s.getPosition(),s.getRotation(),R.ONE).invert(),On.mul2(e.projectionMatrix,In);const i=t.cookieMatrix,n=t.atlasViewport;return Fn.setViewport(n.x,n.y,n.z,n.w),i.mul2(Fn,On),i}}Bn.pointLightRotations=[(new H).setFromEulerAngles(0,90,180),(new H).setFromEulerAngles(0,-90,180),(new H).setFromEulerAngles(90,0,0),(new H).setFromEulerAngles(-90,0,0),(new H).setFromEulerAngles(0,180,180),(new H).setFromEulerAngles(0,0,180)],Bn._spotCookieCamera=null;const zn=new R,Nn=new Float32Array(6),Un=new R(-.5,0,0),Vn=new R(0,0,.5),Hn={FLAGS:0,COLOR_A:1,COLOR_B:2,SPOT_ANGLES:3,SHADOW_BIAS:4,COOKIE_A:5,COOKIE_B:6,COUNT_ALWAYS:7,POSITION_X:7,POSITION_Y:8,POSITION_Z:9,RANGE:10,SPOT_DIRECTION_X:11,SPOT_DIRECTION_Y:12,SPOT_DIRECTION_Z:13,PROJ_MAT_00:14,ATLAS_VIEWPORT_A:14,PROJ_MAT_01:15,ATLAS_VIEWPORT_B:15,PROJ_MAT_02:16,PROJ_MAT_03:17,PROJ_MAT_10:18,PROJ_MAT_11:19,PROJ_MAT_12:20,PROJ_MAT_13:21,PROJ_MAT_20:22,PROJ_MAT_21:23,PROJ_MAT_22:24,PROJ_MAT_23:25,PROJ_MAT_30:26,PROJ_MAT_31:27,PROJ_MAT_32:28,PROJ_MAT_33:29,AREA_DATA_WIDTH_X:30,AREA_DATA_WIDTH_Y:31,AREA_DATA_WIDTH_Z:32,AREA_DATA_HEIGHT_X:33,AREA_DATA_HEIGHT_Y:34,AREA_DATA_HEIGHT_Z:35,COUNT:36},Gn={POSITION_RANGE:0,SPOT_DIRECTION:1,PROJ_MAT_0:2,ATLAS_VIEWPORT:2,PROJ_MAT_1:3,PROJ_MAT_2:4,PROJ_MAT_3:5,AREA_DATA_WIDTH:6,AREA_DATA_HEIGHT:7,COUNT:8};class Wn{static initShaderDefines(){const t=Wn.lightTextureFormat===Wn.FORMAT_FLOAT?"FLOAT":"8BIT";Wn.shaderDefines=`\n\t\t\t\t\t\t\n#define CLUSTER_TEXTURE_${t}\n\t\t\t\t\t\t${Wn.buildShaderDefines(Hn,"CLUSTER_TEXTURE_8_")}\n\t\t\t\t\t\t${Wn.buildShaderDefines(Gn,"CLUSTER_TEXTURE_F_")}\n\t\t\t\t`}static buildShaderDefines(t,e){let s="";const i=Wn.useTexelFetch?"":".5";return Object.keys(t).forEach((n=>{s+=`\n#define ${e}${n} ${t[n]}${i}`})),s}static init(t){Wn.lightTextureFormat=t.extTextureFloat&&t.maxTextures>8?Wn.FORMAT_FLOAT:Wn.FORMAT_8BIT,Wn.useTexelFetch=t.supportsTextureFetch,Wn.initShaderDefines()}static createTexture(t,e,s,i,n){return new Ue(t,{name:n,width:e,height:s,mipmaps:!1,format:i,addressU:1,addressV:1,type:kt,magFilter:0,minFilter:0,anisotropy:1})}constructor(t){this.device=t,this.cookiesEnabled=!1,this.shadowsEnabled=!1,this.areaLightsEnabled=!1,this.maxLights=255;let e=Hn.COUNT_ALWAYS,s=0;Wn.lightTextureFormat===Wn.FORMAT_FLOAT?s=Gn.COUNT:e=Hn.COUNT,this.lights8=new Uint8ClampedArray(4*e*this.maxLights),this.lightsTexture8=Wn.createTexture(this.device,e,this.maxLights,7,"LightsTexture8"),this._lightsTexture8Id=this.device.scope.resolve("lightsTexture8"),s?(this.lightsFloat=new Float32Array(4*s*this.maxLights),this.lightsTextureFloat=Wn.createTexture(this.device,s,this.maxLights,st,"LightsTextureFloat"),this._lightsTextureFloatId=this.device.scope.resolve("lightsTextureFloat")):(this.lightsFloat=null,this.lightsTextureFloat=null,this._lightsTextureFloatId=void 0),this._lightsTextureInvSizeId=this.device.scope.resolve("lightsTextureInvSize"),this._lightsTextureInvSizeData=new Float32Array(4),this._lightsTextureInvSizeData[0]=s?1/this.lightsTextureFloat.width:0,this._lightsTextureInvSizeData[1]=s?1/this.lightsTextureFloat.height:0,this._lightsTextureInvSizeData[2]=1/this.lightsTexture8.width,this._lightsTextureInvSizeData[3]=1/this.lightsTexture8.height,this.invMaxColorValue=0,this.invMaxAttenuation=0,this.boundsMin=new R,this.boundsDelta=new R}destroy(){this.lightsTexture8&&(this.lightsTexture8.destroy(),this.lightsTexture8=null),this.lightsTextureFloat&&(this.lightsTextureFloat.destroy(),this.lightsTextureFloat=null)}setCompressionRanges(t,e){this.invMaxColorValue=1/e,this.invMaxAttenuation=1/t}setBounds(t,e){this.boundsMin.copy(t),this.boundsDelta.copy(e)}uploadTextures(){this.lightsTextureFloat&&(this.lightsTextureFloat.lock().set(this.lightsFloat),this.lightsTextureFloat.unlock()),this.lightsTexture8.lock().set(this.lights8),this.lightsTexture8.unlock()}updateUniforms(){this._lightsTexture8Id.setValue(this.lightsTexture8),Wn.lightTextureFormat===Wn.FORMAT_FLOAT&&this._lightsTextureFloatId.setValue(this.lightsTextureFloat),this._lightsTextureInvSizeId.setValue(this._lightsTextureInvSizeData)}getSpotDirection(t,e){e._node.getWorldTransform().getY(t).mulScalar(-1),t.normalize()}getLightAreaSizes(t){const e=t._node.getWorldTransform();return e.transformVector(Un,zn),Nn[0]=zn.x,Nn[1]=zn.y,Nn[2]=zn.z,e.transformVector(Vn,zn),Nn[3]=zn.x,Nn[4]=zn.y,Nn[5]=zn.z,Nn}addLightDataFlags(t,e,s,i,n,r){t[e+0]=i?255:0,t[e+1]=64*s._shape,t[e+2]=255*s._falloffMode,t[e+3]=n?255*r:0}addLightDataColor(t,e,s,i,n){const r=this.invMaxColorValue,a=i?s._linearFinalColor:s._finalColor;Ln.float2Bytes(a[0]*r,t,e+0,2),Ln.float2Bytes(a[1]*r,t,e+2,2),Ln.float2Bytes(a[2]*r,t,e+4,2),t[e+6]=n?255:0;const o=!!(1&s.mask),l=!!(2&s.mask);t[e+7]=o&&l?127:l?255:0}addLightDataSpotAngles(t,e,s){Ln.float2Bytes(.499999*s._innerConeAngleCos+.5,t,e+0,2),Ln.float2Bytes(.499999*s._outerConeAngleCos+.5,t,e+2,2)}addLightDataShadowBias(t,e,s){const i=s.getRenderData(null,0),n=s._getUniformBiasValues(i);Ln.float2BytesRange(n.bias,t,e,-1,20,2),Ln.float2Bytes(n.normalBias,t,e+2,2)}addLightDataPositionRange(t,e,s,i){const n=zn.sub2(i,this.boundsMin).div(this.boundsDelta);Ln.float2Bytes(n.x,t,e+0,4),Ln.float2Bytes(n.y,t,e+4,4),Ln.float2Bytes(n.z,t,e+8,4),Ln.float2Bytes(s.attenuationEnd*this.invMaxAttenuation,t,e+12,4)}addLightDataSpotDirection(t,e,s){this.getSpotDirection(zn,s),Ln.float2Bytes(.499999*zn.x+.5,t,e+0,4),Ln.float2Bytes(.499999*zn.y+.5,t,e+4,4),Ln.float2Bytes(.499999*zn.z+.5,t,e+8,4)}addLightDataLightProjMatrix(t,e,s){const i=s.data;for(let s=0;s<12;s++)Ln.float2BytesRange(i[s],t,e+4*s,-2,2,4);for(let s=12;s<16;s++)Ln.float2MantissaExponent(i[s],t,e+4*s,4)}addLightDataCookies(t,e,s){const i="rgb"===s._cookieChannel;if(t[e+0]=Math.floor(255*s.cookieIntensity),t[e+1]=i?255:0,!i){const i=s._cookieChannel;t[e+4]="rrr"===i?255:0,t[e+5]="ggg"===i?255:0,t[e+6]="bbb"===i?255:0,t[e+7]="aaa"===i?255:0}}addLightAtlasViewport(t,e,s){Ln.float2Bytes(s.x,t,e+0,2),Ln.float2Bytes(s.y,t,e+2,2),Ln.float2Bytes(s.z/3,t,e+4,2)}addLightAreaSizes(t,e,s){const i=this.getLightAreaSizes(s);for(let s=0;s<6;s++)Ln.float2MantissaExponent(i[s],t,e+4*s,4)}addLightData(t,e,s){const i=2===t._type,n=t.atlasViewportAllocated,r=this.cookiesEnabled&&!!t._cookie&&n,a=this.areaLightsEnabled&&0!==t.shape,o=this.shadowsEnabled&&t.castShadows&&n,l=t._node.getPosition();let h=null,c=null;if(i)if(o){h=t.getRenderData(null,0).shadowMatrix}else r&&(h=Bn.evalSpotCookieMatrix(t));else(o||r)&&(c=t.atlasViewport);const d=this.lights8,u=e*this.lightsTexture8.width*4;if(this.addLightDataFlags(d,u+4*Hn.FLAGS,t,i,o,t.shadowIntensity),this.addLightDataColor(d,u+4*Hn.COLOR_A,t,s,r),i&&this.addLightDataSpotAngles(d,u+4*Hn.SPOT_ANGLES,t),t.castShadows&&this.addLightDataShadowBias(d,u+4*Hn.SHADOW_BIAS,t),r&&this.addLightDataCookies(d,u+4*Hn.COOKIE_A,t),Wn.lightTextureFormat===Wn.FORMAT_FLOAT){const s=this.lightsFloat,n=e*this.lightsTextureFloat.width*4;if(s[n+4*Gn.POSITION_RANGE+0]=l.x,s[n+4*Gn.POSITION_RANGE+1]=l.y,s[n+4*Gn.POSITION_RANGE+2]=l.z,s[n+4*Gn.POSITION_RANGE+3]=t.attenuationEnd,i&&(this.getSpotDirection(zn,t),s[n+4*Gn.SPOT_DIRECTION+0]=zn.x,s[n+4*Gn.SPOT_DIRECTION+1]=zn.y,s[n+4*Gn.SPOT_DIRECTION+2]=zn.z),h){const t=h.data;for(let e=0;e<16;e++)s[n+4*Gn.PROJ_MAT_0+e]=t[e]}if(c&&(s[n+4*Gn.ATLAS_VIEWPORT+0]=c.x,s[n+4*Gn.ATLAS_VIEWPORT+1]=c.y,s[n+4*Gn.ATLAS_VIEWPORT+2]=c.z/3),a){const e=this.getLightAreaSizes(t);s[n+4*Gn.AREA_DATA_WIDTH+0]=e[0],s[n+4*Gn.AREA_DATA_WIDTH+1]=e[1],s[n+4*Gn.AREA_DATA_WIDTH+2]=e[2],s[n+4*Gn.AREA_DATA_HEIGHT+0]=e[3],s[n+4*Gn.AREA_DATA_HEIGHT+1]=e[4],s[n+4*Gn.AREA_DATA_HEIGHT+2]=e[5]}}else this.addLightDataPositionRange(d,u+4*Hn.POSITION_X,t,l),i&&this.addLightDataSpotDirection(d,u+4*Hn.SPOT_DIRECTION_X,t),h&&this.addLightDataLightProjMatrix(d,u+4*Hn.PROJ_MAT_00,h),c&&this.addLightAtlasViewport(d,u+4*Hn.ATLAS_VIEWPORT_A,c),a&&this.addLightAreaSizes(d,u+4*Hn.AREA_DATA_WIDTH_X,t)}}Wn.FORMAT_FLOAT=0,Wn.FORMAT_8BIT=1,Wn.lightTextureFormat=Wn.FORMAT_8BIT,Wn.useTexelFetch=!1,Wn.shaderDefines="";const jn=new R,qn=new R,Xn=new R,$n=new $,Kn=1e-6;class Yn{constructor(){this.light=null,this.min=new R,this.max=new R}}class Qn{constructor(t){this.clusterTexture=void 0,this.device=t,this.name="Untitled",this.reportCount=0,this.boundsMin=new R,this.boundsMax=new R,this.boundsDelta=new R,this._cells=new R(1,1,1),this._cellsLimit=new R,this.cells=this._cells,this.maxCellLightCount=4,this._maxAttenuation=0,this._maxColorValue=0,this._usedLights=[],this._usedLights.push(new Yn),this.lightsBuffer=new Wn(t),this.registerUniforms(t)}set maxCellLightCount(t){t!==this._maxCellLightCount&&(this._maxCellLightCount=t,this._cellsDirty=!0)}get maxCellLightCount(){return this._maxCellLightCount}set cells(t){jn.copy(t).floor(),this._cells.equals(jn)||(this._cells.copy(jn),this._cellsLimit.copy(jn).sub(R.ONE),this._cellsDirty=!0)}get cells(){return this._cells}destroy(){this.lightsBuffer.destroy(),this.releaseClusterTexture()}releaseClusterTexture(){this.clusterTexture&&(this.clusterTexture.destroy(),this.clusterTexture=null)}registerUniforms(t){this._clusterSkipId=t.scope.resolve("clusterSkip"),this._clusterMaxCellsId=t.scope.resolve("clusterMaxCells"),this._clusterWorldTextureId=t.scope.resolve("clusterWorldTexture"),this._clusterTextureSizeId=t.scope.resolve("clusterTextureSize"),this._clusterTextureSizeData=new Float32Array(3),this._clusterBoundsMinId=t.scope.resolve("clusterBoundsMin"),this._clusterBoundsMinData=new Float32Array(3),this._clusterBoundsDeltaId=t.scope.resolve("clusterBoundsDelta"),this._clusterBoundsDeltaData=new Float32Array(3),this._clusterCellsCountByBoundsSizeId=t.scope.resolve("clusterCellsCountByBoundsSize"),this._clusterCellsCountByBoundsSizeData=new Float32Array(3),this._clusterCellsDotId=t.scope.resolve("clusterCellsDot"),this._clusterCellsDotData=new Float32Array(3),this._clusterCellsMaxId=t.scope.resolve("clusterCellsMax"),this._clusterCellsMaxData=new Float32Array(3),this._clusterCompressionLimit0Id=t.scope.resolve("clusterCompressionLimit0"),this._clusterCompressionLimit0Data=new Float32Array(2)}updateParams(t){t&&(this.cells=t.cells,this.maxCellLightCount=t.maxLightsPerCell,this.lightsBuffer.cookiesEnabled=t.cookiesEnabled,this.lightsBuffer.shadowsEnabled=t.shadowsEnabled,this.lightsBuffer.areaLightsEnabled=t.areaLightsEnabled)}updateCells(){if(this._cellsDirty){this._cellsDirty=!1;const t=this._cells.x,e=this._cells.y,s=this._cells.z,i=t*e*s,n=this.maxCellLightCount*i;let r=Math.ceil(Math.sqrt(n));r=k.roundUp(r,this.maxCellLightCount);const a=Math.ceil(n/r);this._clusterCellsMaxData[0]=t,this._clusterCellsMaxData[1]=e,this._clusterCellsMaxData[2]=s,this._clusterCellsDotData[0]=this.maxCellLightCount,this._clusterCellsDotData[1]=t*s*this.maxCellLightCount,this._clusterCellsDotData[2]=t*this.maxCellLightCount,this.clusters=new Uint8ClampedArray(n),this.counts=new Int32Array(i),this._clusterTextureSizeData[0]=r,this._clusterTextureSizeData[1]=1/r,this._clusterTextureSizeData[2]=1/a,this.releaseClusterTexture(),this.clusterTexture=Wn.createTexture(this.device,r,a,1,"ClusterTexture")}}uploadTextures(){this.clusterTexture.lock().set(this.clusters),this.clusterTexture.unlock(),this.lightsBuffer.uploadTextures()}updateUniforms(){this._clusterSkipId.setValue(this._usedLights.length>1?0:1),this.lightsBuffer.updateUniforms(),this._clusterWorldTextureId.setValue(this.clusterTexture),this._clusterMaxCellsId.setValue(this.maxCellLightCount);const t=this.boundsDelta;this._clusterCellsCountByBoundsSizeData[0]=this._cells.x/t.x,this._clusterCellsCountByBoundsSizeData[1]=this._cells.y/t.y,this._clusterCellsCountByBoundsSizeData[2]=this._cells.z/t.z,this._clusterCellsCountByBoundsSizeId.setValue(this._clusterCellsCountByBoundsSizeData),this._clusterBoundsMinData[0]=this.boundsMin.x,this._clusterBoundsMinData[1]=this.boundsMin.y,this._clusterBoundsMinData[2]=this.boundsMin.z,this._clusterBoundsDeltaData[0]=t.x,this._clusterBoundsDeltaData[1]=t.y,this._clusterBoundsDeltaData[2]=t.z,this._clusterCompressionLimit0Data[0]=this._maxAttenuation,this._clusterCompressionLimit0Data[1]=this._maxColorValue,this._clusterTextureSizeId.setValue(this._clusterTextureSizeData),this._clusterBoundsMinId.setValue(this._clusterBoundsMinData),this._clusterBoundsDeltaId.setValue(this._clusterBoundsDeltaData),this._clusterCellsDotId.setValue(this._clusterCellsDotData),this._clusterCellsMaxId.setValue(this._clusterCellsMaxData),this._clusterCompressionLimit0Id.setValue(this._clusterCompressionLimit0Data)}evalLightCellMinMax(t,e,s){e.copy(t.min),e.sub(this.boundsMin),e.div(this.boundsDelta),e.mul2(e,this.cells),e.floor(),s.copy(t.max),s.sub(this.boundsMin),s.div(this.boundsDelta),s.mul2(s,this.cells),s.ceil(),e.max(R.ZERO),s.min(this._cellsLimit)}collectLights(t){const e=this.lightsBuffer.maxLights,s=this._usedLights;let i=1;t.forEach((t=>{const n=!!(3&t.mask),r=2===t.type&&0===t._outerConeAngle;if(t.enabled&&0!==t.type&&t.visibleThisFrame&&t.intensity>0&&n&&!r&&i<e){let e;i<s.length?e=s[i]:(e=new Yn,s.push(e)),e.light=t,t.getBoundingBox($n),e.min.copy($n.getMin()),e.max.copy($n.getMax()),i++}})),s.length=i}evaluateBounds(){const t=this._usedLights,e=this.boundsMin,s=this.boundsMax;if(t.length>1){e.copy(t[1].min),s.copy(t[1].max);for(let i=2;i<t.length;i++)e.min(t[i].min),s.max(t[i].max)}else e.set(0,0,0),s.set(1,1,1);this.boundsDelta.sub2(s,e),this.lightsBuffer.setBounds(e,this.boundsDelta)}evaluateCompressionLimits(t){let e=0,s=0;const i=this._usedLights;for(let n=1;n<i.length;n++){const r=i[n].light;e=Math.max(r.attenuationEnd,e);const a=t?r._linearFinalColor:r._finalColor;s=Math.max(a[0],s),s=Math.max(a[1],s),s=Math.max(a[2],s)}this._maxAttenuation=e+Kn,this._maxColorValue=s+Kn,this.lightsBuffer.setCompressionRanges(this._maxAttenuation,this._maxColorValue)}updateClusters(t){this.counts.fill(0),this.clusters.fill(0);const e=this._cells.x,s=this._cells.z,i=this.counts,n=this._maxCellLightCount,r=this.clusters,a=this.maxCellLightCount,o=this._usedLights;for(let l=1;l<o.length;l++){const h=o[l],c=h.light;this.lightsBuffer.addLightData(c,l,t),this.evalLightCellMinMax(h,qn,Xn);const d=qn.x,u=Xn.x,p=qn.y,f=Xn.y,m=qn.z,g=Xn.z;for(let t=d;t<=u;t++)for(let o=m;o<=g;o++)for(let h=p;h<=f;h++){const c=t+e*(o+h*s),d=i[c];d<n&&(r[a*c+d]=l,i[c]=d+1)}}}update(t,e,s){this.updateParams(s),this.updateCells(),this.collectLights(t),this.evaluateBounds(),this.evaluateCompressionLimits(e),this.updateClusters(e),this.uploadTextures()}activate(){this.updateUniforms()}}const Jn=new O;class Zn{constructor(t,e){this.device=t,this.lightTextureAtlas=e,this.blitShader2d=null,this.blitShaderCube=null,this.blitTextureId=null,this.invViewProjId=null}destroy(){}getShader(t,e){return this[t]||(this[t]=Ai(this.device,"\n\t\tattribute vec2 vertex_position;\n\t\tvarying vec2 uv0;\n\t\tvoid main(void) {\n\t\t\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\t\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n\t\t}",e,`cookie_renderer_${t}`)),this.blitTextureId||(this.blitTextureId=this.device.scope.resolve("blitTexture")),this.invViewProjId||(this.invViewProjId=this.device.scope.resolve("invViewProj")),this[t]}get shader2d(){return this.getShader("blitShader2d","\n\t\tvarying vec2 uv0;\n\t\tuniform sampler2D blitTexture;\n\t\tvoid main(void) {\n\t\t\t\tgl_FragColor = texture2D(blitTexture, uv0);\n\t\t}")}get shaderCube(){return this.getShader("blitShaderCube","\n\t\tvarying vec2 uv0;\n\t\tuniform samplerCube blitTexture;\n\t\tuniform mat4 invViewProj;\n\t\tvoid main(void) {\n\t\t\t\tvec4 projPos = vec4(uv0 * 2.0 - 1.0, 0.5, 1.0);\n\t\t\t\tvec4 worldPos = invViewProj * projPos;\n\t\t\t\tgl_FragColor = textureCube(blitTexture, worldPos.xyz);\n\t\t}")}static createTexture(t,e){return new Ue(t,{name:"CookieAtlas",width:e,height:e,format:7,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})}initInvViewProjMatrices(){if(!Zn._invViewProjMatrices){Zn._invViewProjMatrices=[];for(let t=0;t<6;t++){const e=Bn.create(null,1,t),s=e.projectionMatrix,i=e.node.getLocalTransform().clone().invert();Zn._invViewProjMatrices[t]=(new V).mul2(s,i).invert()}}}render(t,e){if(t.enabled&&t.cookie&&t.visibleThisFrame){const s=t.numShadowFaces,i=s>1?this.shaderCube:this.shader2d,n=this.device;s>1&&this.initInvViewProjMatrices(),this.blitTextureId.setValue(t.cookie),n.setBlendState(Zt.NOBLEND);for(let r=0;r<s;r++){if(Jn.copy(t.atlasViewport),s>1){const t=Jn.z/3,e=this.lightTextureAtlas.cubeSlotsOffsets[r];Jn.x+=t*e.x,Jn.y+=t*e.y,Jn.z=t,Jn.w=t,this.invViewProjId.setValue(Zn._invViewProjMatrices[r].data)}Jn.mulScalar(e.colorBuffer.width),Fi(n,e,i,Jn)}}}}Zn._invViewProjMatrices=null;class tr{constructor(t,e){this.texture=t,this.cached=!1,this.renderTargets=e}destroy(){this.texture&&(this.texture.destroy(),this.texture=null);const t=this.renderTargets;for(let e=0;e<t.length;e++)t[e].destroy();this.renderTargets.length=0}static getShadowFormat(t,e){return 3===e?st:2===e?et:4===e?it:5!==e&&0!==e||!t.supportsDepthShadow?6===e&&(t.webgl2||t.isWebGPU)?15:7:it}static getShadowFiltering(t,e){return 5!==e&&0!==e&&6!==e||t.supportsDepthShadow?3===e?t.extTextureFloatLinear?1:0:2===e?t.extTextureHalfFloatLinear?1:0:1:0}static create(t,e){let s=null;return s=1===e._type?this.createCubemap(t,e._shadowResolution,e._shadowType):this.create2dMap(t,e._shadowResolution,e._shadowType),s}static createAtlas(t,e,s){const i=this.create2dMap(t,e,s),n=i.renderTargets,r=n[0];for(let t=0;t<5;t++)n.push(r);return i}static create2dMap(t,e,s){const i=this.getShadowFormat(t,s),n=this.getShadowFiltering(t,s),r=new Ue(t,{format:i,width:e,height:e,mipmaps:!1,minFilter:n,magFilter:n,addressU:1,addressV:1,name:"ShadowMap2D"});let a=null;return 4===s||(5===s||0===s)&&t.supportsDepthShadow?(r.compareOnRead=!0,r.compareFunc=1,a=new pe({depthBuffer:r})):a=new pe({colorBuffer:r,depth:!0}),t.isWebGPU&&(a.flipY=!0),new tr(r,[a])}static createCubemap(t,e,s){const i=6===s&&(t.webgl2||t.isWebGPU)?15:7,n=new Ue(t,{format:i,width:e,height:e,cubemap:!0,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,name:"ShadowMapCube"}),r=[];for(let t=0;t<6;t++){const e=new pe({colorBuffer:n,face:t,depth:!0});r.push(e)}return new tr(n,r)}}const er=[],sr=[],ir=new O,nr=new O;class rr{constructor(t){this.size=Math.floor(1024*t.w),this.used=!1,this.lightId=-1,this.rect=t}}class ar{constructor(t){this.device=t,this.version=1,this.shadowAtlasResolution=2048,this.shadowAtlas=null,this.shadowEdgePixels=3,this.cookieAtlasResolution=2048,this.cookieAtlas=null,this.cookieRenderTarget=null,this.slots=[],this.atlasSplit=[],this.cubeSlotsOffsets=[new I(0,0),new I(0,1),new I(1,0),new I(1,1),new I(2,0),new I(2,1)],this.scissorVec=new O,this.allocateShadowAtlas(1),this.allocateCookieAtlas(1),this.allocateUniforms()}destroy(){this.destroyShadowAtlas(),this.destroyCookieAtlas()}destroyShadowAtlas(){this.shadowAtlas&&(this.shadowAtlas.destroy(),this.shadowAtlas=null)}destroyCookieAtlas(){this.cookieAtlas&&(this.cookieAtlas.destroy(),this.cookieAtlas=null),this.cookieRenderTarget&&(this.cookieRenderTarget.destroy(),this.cookieRenderTarget=null)}allocateShadowAtlas(t){if(!this.shadowAtlas||this.shadowAtlas.texture.width!==t){this.version++,this.destroyShadowAtlas(),this.shadowAtlas=tr.createAtlas(this.device,t,0),this.shadowAtlas.cached=!0;const e=4/this.shadowAtlasResolution;this.scissorVec.set(e,e,-2*e,-2*e)}}allocateCookieAtlas(t){this.cookieAtlas&&this.cookieAtlas.width===t||(this.version++,this.destroyCookieAtlas(),this.cookieAtlas=Zn.createTexture(this.device,t),this.cookieRenderTarget=new pe({colorBuffer:this.cookieAtlas,depth:!1,flipY:!0}))}allocateUniforms(){this._shadowAtlasTextureId=this.device.scope.resolve("shadowAtlasTexture"),this._shadowAtlasParamsId=this.device.scope.resolve("shadowAtlasParams"),this._shadowAtlasParams=new Float32Array(2),this._cookieAtlasTextureId=this.device.scope.resolve("cookieAtlasTexture")}updateUniforms(){const t=this.shadowAtlas.renderTargets[0],e=(this.device.isWebGPU||this.device.webgl2)&&!0?t.depthBuffer:t.colorBuffer;this._shadowAtlasTextureId.setValue(e),this._shadowAtlasParams[0]=this.shadowAtlasResolution,this._shadowAtlasParams[1]=this.shadowEdgePixels,this._shadowAtlasParamsId.setValue(this._shadowAtlasParams),this._cookieAtlasTextureId.setValue(this.cookieAtlas)}subdivide(t,e){let s=e.atlasSplit;if(!s){const e=Math.ceil(Math.sqrt(t));s=sr,s[0]=e,s.length=1}if(i=s,n=this.atlasSplit,i.length!==n.length||!i.every(((t,e)=>t===n[e]))){this.version++,this.slots.length=0,this.atlasSplit.length=0,this.atlasSplit.push(...s);const t=this.atlasSplit[0];if(t>1){const e=1/t;for(let s=0;s<t;s++)for(let i=0;i<t;i++){const n=new O(s*e,i*e,e,e),r=this.atlasSplit[1+s*t+i];if(r>1)for(let t=0;t<r;t++)for(let s=0;s<r;s++){const i=e/r,a=new O(n.x+t*i,n.y+s*i,i,i);this.slots.push(new rr(a))}else this.slots.push(new rr(n))}}else this.slots.push(new rr(new O(0,0,1,1)));this.slots.sort(((t,e)=>e.size-t.size))}var i,n}collectLights(t,e,s){const i=s.cookiesEnabled,n=s.shadowsEnabled;let r=!1,a=!1;const o=er;o.length=0;const l=t=>{for(let e=0;e<t.length;e++){const s=t[e];if(s.visibleThisFrame){const t=n&&s.castShadows,e=i&&!!s.cookie;r||(r=t),a||(a=e),(t||e)&&o.push(s)}}};return(i||n)&&(l(t),l(e)),o.sort(((t,e)=>e.maxScreenSize-t.maxScreenSize)),r&&this.allocateShadowAtlas(this.shadowAtlasResolution),a&&this.allocateCookieAtlas(this.cookieAtlasResolution),(r||a)&&this.subdivide(o.length,s),o}setupSlot(t,e){t.atlasViewport.copy(e);const s=t.numShadowFaces;for(let i=0;i<s;i++)if(t.castShadows||t._cookie){if(ir.copy(e),nr.copy(e),2===t._type&&ir.add(this.scissorVec),1===t._type){const t=ir.z/3,e=this.cubeSlotsOffsets[i];ir.x+=t*e.x,ir.y+=t*e.y,ir.z=t,ir.w=t,nr.copy(ir)}if(t.castShadows){const e=t.getRenderData(null,i);e.shadowViewport.copy(ir),e.shadowScissor.copy(nr)}}}assignSlot(t,e,s){t.atlasViewportAllocated=!0;const i=this.slots[e];i.lightId=t.id,i.used=!0,s&&(t.atlasSlotUpdated=!0,t.atlasVersion=this.version,t.atlasSlotIndex=e)}update(t,e,s){this.shadowAtlasResolution=s.shadowAtlasResolution,this.cookieAtlasResolution=s.cookieAtlasResolution;const i=this.collectLights(t,e,s);if(i.length>0){const t=this.slots;for(let e=0;e<t.length;e++)t[e].used=!1;const e=Math.min(i.length,t.length);for(let s=0;s<e;s++){const e=i[s];e.castShadows&&(e._shadowMap=this.shadowAtlas);const n=t[e.atlasSlotIndex];if(e.atlasVersion===this.version&&e.id===(null==n?void 0:n.lightId)){const i=t[e.atlasSlotIndex];i.size!==t[s].size||i.used||this.assignSlot(e,e.atlasSlotIndex,!1)}}let s=0;for(let n=0;n<e;n++){for(;s<t.length&&t[s].used;)s++;const e=i[n];e.atlasViewportAllocated||this.assignSlot(e,s,!0);const r=t[e.atlasSlotIndex];this.setupSlot(e,r.rect)}}this.updateUniforms()}}class or{constructor(){this.cache=new Map}destroy(){this.clear(),this.cache=null}clear(){this.cache.forEach((t=>{t.forEach((t=>{t.destroy()}))})),this.cache.clear()}getKey(t){return`${1===t._type}-${t._shadowType}-${t._shadowResolution}`}get(t,e){const s=this.getKey(e),i=this.cache.get(s);if(i&&i.length)return i.pop();const n=tr.create(t,e);return n.cached=!0,n}add(t,e){const s=this.getKey(t),i=this.cache.get(s);i?i.push(e):this.cache.set(s,[e])}}class lr{constructor(t,e){this.shadowLights=[],this.renderer=void 0,this.shadowRenderer=void 0,this.device=void 0,this.renderer=t,this.shadowRenderer=e,this.device=t.device}cull(t,e){const s=this.renderer.scene.clusteredLightingEnabled;t.visibleThisFrame=!0,s||t._shadowMap||(t._shadowMap=tr.create(this.device,t));const i=t._type,n=2===i?1:6;for(let r=0;r<n;r++){const n=t.getRenderData(null,r),a=n.shadowCamera;a.nearClip=t.attenuationEnd/1e3,a.farClip=t.attenuationEnd;const o=a._node,l=t._node;if(o.setPosition(l.getPosition()),2===i)a.fov=2*t._outerConeAngle,o.setRotation(l.getRotation()),o.rotateLocal(-90,0,0);else if(1===i)if(s){const e=2/(this.shadowRenderer.lightTextureAtlas.shadowAtlasResolution*t.atlasViewport.z/3)*this.shadowRenderer.lightTextureAtlas.shadowEdgePixels;a.fov=Math.atan(1+e)*k.RAD_TO_DEG*2}else a.fov=90;this.renderer.updateCameraFrustum(a),this.shadowRenderer.cullShadowCasters(e,n.visibleCasters,a)}}prepareLights(t,e){let s;for(let i=0;i<e.length;i++){const n=e[i];if(this.shadowRenderer.needsShadowRendering(n)&&n.atlasViewportAllocated){t.push(n);for(let t=0;t<n.numShadowFaces;t++)s=this.shadowRenderer.prepareFace(n,null,t)}}return s}prepareClusteredRenderPass(t,e,s){const i=this.shadowLights,n=this.prepareLights(i,e),r=this.prepareLights(i,s),a=null!=n?n:r,o=i.length;o&&(this.shadowRenderer.setupRenderPass(t,a,!1),t.execute=()=>{for(let t=0;t<o;t++){const e=i[t];for(let t=0;t<e.numShadowFaces;t++)this.shadowRenderer.renderFace(e,null,t,!0)}i.length=0})}setupNonClusteredFaceRenderPass(t,e,s,i){const n=this.shadowRenderer.prepareFace(e,null,s),r=new wi(this.device,(()=>{this.shadowRenderer.renderFace(e,null,s,!1)}));this.shadowRenderer.setupRenderPass(r,n,!0),i&&(r.after=()=>{this.shadowRenderer.renderVsm(e,n)}),t.addRenderPass(r)}buildNonClusteredRenderPasses(t,e,s){for(let s=0;s<e.length;s++){const i=e[s];this.shadowRenderer.needsShadowRendering(i)&&this.setupNonClusteredFaceRenderPass(t,i,0,!0)}for(let e=0;e<s.length;e++){const i=s[e];if(this.shadowRenderer.needsShadowRendering(i)){const e=i.numShadowFaces;for(let s=0;s<e;s++)this.setupNonClusteredFaceRenderPass(t,i,s,!1)}}}}const hr=new $,cr=new R,dr=new V,ur=[new R,new R,new R,new R,new R,new R,new R,new R],pr={min:0,max:0};function fr(t,e,s){ur[0].x=ur[1].x=ur[2].x=ur[3].x=e.x,ur[1].y=ur[3].y=ur[7].y=ur[5].y=e.y,ur[2].z=ur[3].z=ur[6].z=ur[7].z=e.z,ur[4].x=ur[5].x=ur[6].x=ur[7].x=s.x,ur[0].y=ur[2].y=ur[4].y=ur[6].y=s.y,ur[0].z=ur[1].z=ur[4].z=ur[5].z=s.z;let i=9999999999,n=-9999999999;for(let e=0;e<8;++e){t.transformPoint(ur[e],ur[e]);const s=ur[e].z;s<i&&(i=s),s>n&&(n=s)}return pr.min=i,pr.max=n,pr}class mr{constructor(t,e){this.renderer=void 0,this.shadowRenderer=void 0,this.device=void 0,this.renderer=t,this.shadowRenderer=e,this.device=t.device}cull(t,e,s){t.visibleThisFrame=!0,t._shadowMap||(t._shadowMap=tr.create(this.device,t));const i=s._nearClip;this.generateSplitDistances(t,i,Math.min(s._farClip,t.shadowDistance));const n=t.shadowUpdateOverrides;for(let r=0;r<t.numCascades&&0!==(null==n?void 0:n[r]);r++){const n=t.getRenderData(s,r),a=n.shadowCamera;a.renderTarget=t._shadowMap.renderTargets[0],n.shadowViewport.copy(t.cascades[r]),n.shadowScissor.copy(t.cascades[r]);const o=a._node,l=t._node;o.setPosition(l.getPosition()),o.setRotation(l.getRotation()),o.rotateLocal(-90,0,0);const h=0===r?i:t._shadowCascadeDistances[r-1],c=t._shadowCascadeDistances[r],d=s.getFrustumCorners(h,c);cr.set(0,0,0);const u=s.node.getWorldTransform();for(let t=0;t<8;t++)u.transformPoint(d[t],d[t]),cr.add(d[t]);cr.mulScalar(1/8);let p=0;for(let t=0;t<8;t++){const e=d[t].sub(cr).length();e>p&&(p=e)}const f=o.right,m=o.up,g=o.forward,_=.25*t._shadowResolution/p,v=Math.ceil(cr.dot(m)*_)/_,b=Math.ceil(cr.dot(f)*_)/_,y=m.mulScalar(v),x=f.mulScalar(b),w=cr.dot(g),S=g.mulScalar(w);cr.add2(y,x).add(S),o.setPosition(cr),o.translateLocal(0,0,1e6),a.nearClip=.01,a.farClip=2e6,a.orthoHeight=p,this.renderer.updateCameraFrustum(a),this.shadowRenderer.cullShadowCasters(e,n.visibleCasters,a);let C=!0;const T=n.visibleCasters;for(let t=0;t<T.length;t++){const e=T[t];C?(C=!1,hr.copy(e.aabb)):hr.add(e.aabb)}dr.copy(o.getWorldTransform()).invert();const E=fr(dr,hr.getMin(),hr.getMax());n.depthRangeCompensation=(E.max-E.min)/t.shadowDistance,o.translateLocal(0,0,E.max+.1),a.farClip=E.max-E.min+.2}}generateSplitDistances(t,e,s){t._shadowCascadeDistances.fill(s);for(let i=1;i<t.numCascades;i++){const n=i/t.numCascades,r=e+(s-e)*n,a=e*(s/e)**n,o=k.lerp(r,a,t.cascadeDistribution);t._shadowCascadeDistances[i-1]=o}}addLightRenderPasses(t,e,s){const i=e.numShadowFaces,n=e.shadowUpdateOverrides;let r,a=!0;for(let t=0;t<i;t++)0===(null==n?void 0:n[t])&&(a=!1),r=this.shadowRenderer.prepareFace(e,s,t);const o=new wi(this.device,(()=>{for(let t=0;t<i;t++)0!==(null==n?void 0:n[t])&&this.shadowRenderer.renderFace(e,s,t,!a),1===(null==n?void 0:n[t])&&(n[t]=0)}));o.after=()=>{this.shadowRenderer.renderVsm(e,s)},this.shadowRenderer.setupRenderPass(o,r,a),t.addRenderPass(o)}buildFrameGraph(t,e,s){const i=e.directionalLights;for(let e=0;e<i.length;e++){const n=i[e];this.shadowRenderer.needsShadowRendering(n)&&this.addLightRenderPasses(t,n,s.camera)}}}const gr=new Q;class _r{static lightCompare(t,e){return t.key-e.key}static prepare(t,e,s,i){const n=s,r=n.length,a=[],o=new R,l=new R,h=new $,c=new V,d=[],u=[],p=[],f=[];for(let e=0;e<r;e++){const s=n[e];if(s.isStatic){const e=s.aabb;f.length=0;for(let t=1;t<=2;t++)for(let n=0;n<i.length;n++){const r=i[n];if(r._type===t&&(r.enabled&&r.mask&s.mask&&r.isStatic)){if(u[n]||(u[n]=new $,r._node.getWorldTransform(),r.getBoundingSphere(gr),u[n].center.copy(gr.center),u[n].halfExtents.set(gr.radius,gr.radius,gr.radius)),!u[n].intersects(e))continue;f.push(n)}}if(0===f.length){a.push(s);continue}const n=s.mesh,r=n.vertexBuffer,m=n.indexBuffer[s.renderStyle],g=2===m.bytesPerIndex?new Uint16Array(m.lock()):new Uint32Array(m.lock()),_=n.primitive[s.renderStyle].count/3,v=n.primitive[s.renderStyle].base,b=r.format.elements,y=r.format.size/4,x=new Float32Array(r.storage);let w;for(let t=0;t<b.length;t++)b[t].name===at&&(w=b[t].offset/4);d.length=_;for(let t=0;t<_;t++)d[t]=0;let S=!1;p.length=6*_;for(let t=0;t<_;t++){let e=Number.MAX_VALUE,s=Number.MAX_VALUE,i=Number.MAX_VALUE,n=-Number.MAX_VALUE,r=-Number.MAX_VALUE,a=-Number.MAX_VALUE;for(let o=0;o<3;o++){let l=g[3*t+o+v];l=l*y+w;const h=x[l],c=x[l+1],d=x[l+2];h<e&&(e=h),c<s&&(s=c),d<i&&(i=d),h>n&&(n=h),c>r&&(r=c),d>a&&(a=d)}const o=6*t;p[o]=e,p[o+1]=s,p[o+2]=i,p[o+3]=n,p[o+4]=r,p[o+5]=a}for(let t=0;t<f.length;t++){const e=f[t];c.copy(s.node.worldTransform).invert(),h.setFromTransformedAabb(u[e],c);const i=h.getMin(),n=h.getMax(),r=1<<t;for(let t=0;t<_;t++){const e=6*t;p[e]<=n.x&&p[e+3]>=i.x&&p[e+1]<=n.y&&p[e+4]>=i.y&&p[e+2]<=n.z&&p[e+5]>=i.z&&(d[t]|=r,S=!0)}}if(S){const e={};for(let t=0;t<_;t++){const s=3*t+v,i=d[t];e[i]||(e[i]=[]);const n=e[i];n.push(g[s]),n.push(g[s+1]),n.push(g[s+2])}for(const n in e){const h=e[n],c=new _s(t,m.format,h.length,m.usage);(2===c.bytesPerIndex?new Uint16Array(c.lock()):new Uint32Array(c.lock())).set(h),c.unlock();let d=Number.MAX_VALUE,u=Number.MAX_VALUE,p=Number.MAX_VALUE,g=-Number.MAX_VALUE,_=-Number.MAX_VALUE,v=-Number.MAX_VALUE;for(let t=0;t<h.length;t++){const e=h[t],s=x[e*y+w],i=x[e*y+w+1],n=x[e*y+w+2];s<d&&(d=s),i<u&&(u=i),n<p&&(p=n),s>g&&(g=s),i>_&&(_=i),n>v&&(v=n)}o.set(d,u,p),l.set(g,_,v);const b=new $;b.setMinMax(o,l);const S=new di(t);S.vertexBuffer=r,S.indexBuffer[0]=c,S.primitive[0].type=4,S.primitive[0].base=0,S.primitive[0].count=h.length,S.primitive[0].indexed=!0,S.aabb=b;const C=new Sn(S,s.material,s.node);C.isStatic=s.isStatic,C.visible=s.visible,C.layer=s.layer,C.castShadow=s.castShadow,C._receiveShadow=s._receiveShadow,C.cull=s.cull,C.pick=s.pick,C.mask=s.mask,C.parameters=s.parameters,C._shaderDefs=s._shaderDefs,C._staticSource=s,s._staticLightList?C._staticLightList=s._staticLightList:C._staticLightList=[];for(let t=0;t<f.length;t++){if(n&1<<t){const e=i[f[t]];C._staticLightList.indexOf(e)<0&&C._staticLightList.push(e)}}C._staticLightList.sort(_r.lightCompare),a.push(C)}}else a.push(s)}else a.push(s)}s.length=a.length;for(let t=0;t<a.length;t++)s[t]=a[t]}static revert(t){const e=t,s=e.length,i=[];let n;for(let t=0;t<s;t++){const s=e[t];s._staticSource?s._staticSource!==n&&(i.push(s._staticSource),n=s._staticSource):i.push(s)}t.length=i.length;for(let e=0;e<i.length;e++)t[e]=i[e]}}function vr(t,e){return Math.exp(-t*t/(2*e*e))}const br=new V,yr=new V,xr=new Float32Array(2),wr=new O(1,1,0,0),Sr={r:1,g:2,b:3,a:4},Cr=new V;function Tr(t){const e=t.material,s=t.skinInstance?10:0;let i=0;if(e.opacityMap){const t=e.opacityMapChannel;t&&(i=Sr[t])}return s+i}class Er{constructor(t,e){this.shadowPassCache=[],this.device=t.device,this.renderer=t,this.lightTextureAtlas=e;const s=this.device.scope;this.polygonOffsetId=s.resolve("polygonOffset"),this.polygonOffset=new Float32Array(2),this.sourceId=s.resolve("source"),this.pixelOffsetId=s.resolve("pixelOffset"),this.weightId=s.resolve("weight[0]"),this.blurVsmShaderCode=[Ei.blurVSMPS,"#define GAUSS\n"+Ei.blurVSMPS];const i="#define PACKED\n";this.blurPackedVsmShaderCode=[i+this.blurVsmShaderCode[0],i+this.blurVsmShaderCode[1]],this.blurVsmShader=[{},{}],this.blurPackedVsmShader=[{},{}],this.blurVsmWeights={},this.shadowMapLightRadiusId=s.resolve("light_radius"),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this.blendStateWrite=new Zt,this.blendStateNoWrite=new Zt,this.blendStateNoWrite.setColorWrite(!1,!1,!1,!1)}static createShadowCamera(t,e,s,i){const n=Bn.create("ShadowCamera",s,i);return n.clearColor=e>=1&&e<=3?new D(0,0,0,0):new D(1,1,1,1),n.clearDepthBuffer=!0,n.clearStencilBuffer=!1,n}static setShadowCameraSettings(t,e,s,i,n){let r=4===s||(5===s||0===s)&&e.supportsDepthShadow;1!==i||n||(r=!1),t.clearColorBuffer=!r}cullShadowCasters(t,e,s){let i=0;const n=t.length;for(let r=0;r<n;r++){const n=t[r];n.castShadow&&(n.cull&&!n._isVisible(s)||(n.visibleThisFrame=!0,e[i]=n,i++))}e.length=i,e.sort(this.renderer.sortCompareDepth)}setupRenderState(t,e){const s=this.renderer.scene.clusteredLightingEnabled;t.webgl2||t.isWebGPU?1!==e._type||s?(t.setDepthBias(!0),t.setDepthBiasValues(-1e3*e.shadowBias,-1e3*e.shadowBias)):t.setDepthBias(!1):t.extStandardDerivatives&&(1===e._type?(this.polygonOffset[0]=0,this.polygonOffset[1]=0,this.polygonOffsetId.setValue(this.polygonOffset)):(this.polygonOffset[0]=-1e3*e.shadowBias,this.polygonOffset[1]=-1e3*e.shadowBias,this.polygonOffsetId.setValue(this.polygonOffset)));const i=t.webgl2||t.isWebGPU,n=s?e._isPcf&&i:e._isPcf&&i&&1!==e._type;t.setBlendState(n?this.blendStateNoWrite:this.blendStateWrite),t.setDepthState(te.DEFAULT),t.setStencilState(null,null)}restoreRenderState(t){t.webgl2||t.isWebGPU?t.setDepthBias(!1):t.extStandardDerivatives&&(this.polygonOffset[0]=0,this.polygonOffset[1]=0,this.polygonOffsetId.setValue(this.polygonOffset))}dispatchUniforms(t,e,s,i){const n=e._node;0!==t._type&&(this.renderer.dispatchViewPos(n.getPosition()),this.shadowMapLightRadiusId.setValue(t.attenuationEnd)),br.setTRS(n.getPosition(),n.getRotation(),R.ONE).invert(),yr.mul2(e.projectionMatrix,br);const r=s.shadowViewport;e.rect=r,e.scissorRect=s.shadowScissor,Cr.setViewport(r.x,r.y,r.z,r.w),s.shadowMatrix.mul2(Cr,yr),0===t._type&&t._shadowMatrixPalette.set(s.shadowMatrix.data,16*i)}getShadowPass(t){var e;const s=t._type,i=t._shadowType;let n=null==(e=this.shadowPassCache[s])?void 0:e[i];if(!n){const t=`ShadowPass_${s}_${i}`;n=Ni.get(this.device).allocate(t,{isShadow:!0,lightType:s,shadowType:i}),this.shadowPassCache[s]||(this.shadowPassCache[s]=[]),this.shadowPassCache[s][i]=n}return n.index}submitCasters(t,e){const s=this.device,i=this.renderer,n=i.scene,r=this.getShadowPass(e),a=t.length;for(let e=0;e<a;e++){const a=t[e],o=a.mesh;a.ensureMaterial(s);const l=a.material;i.setBaseConstants(s,l),i.setSkinning(s,a),l.dirty&&(l.updateUniforms(s,n),l.dirty=!1),l.chunks&&(i.setupCullMode(!0,1,a),l.setParameters(s),a.setParameters(s,16));let h=a._shader[r];h||(a.updatePassShader(n,r,null,null,this.viewUniformFormat,this.viewBindGroupFormat),h=a._shader[r],a._key[1]=Tr(a)),!h.failed&&s.setShader(h),i.setVertexBuffers(s,o),i.setMorphing(s,a.morphInstance),this.renderer.setupMeshUniformBuffers(a,r);const c=a.renderStyle;s.setIndexBuffer(o.indexBuffer[c]),i.drawInstance(s,a,o,c),i._shadowDrawCalls++}}needsShadowRendering(t){const e=t.enabled&&t.castShadows&&0!==t.shadowUpdateMode&&t.visibleThisFrame;return 1===t.shadowUpdateMode&&(t.shadowUpdateMode=0),e&&(this.renderer._shadowMapUpdates+=t.numShadowFaces),e}getLightRenderData(t,e,s){return t.getRenderData(0===t._type?e:null,s)}setupRenderPass(t,e,s){const i=e.renderTarget;t.init(i),t.depthStencilOps.clearDepthValue=1,t.depthStencilOps.clearDepth=s,i.depthBuffer?t.depthStencilOps.storeDepth=!0:(t.colorOps.clearValue.copy(e.clearColor),t.colorOps.clear=s,t.depthStencilOps.storeDepth=!1),t.requiresCubemaps=!1}prepareFace(t,e,s){const i=t._type,n=t._shadowType,r=this.renderer.scene.clusteredLightingEnabled,a=this.getLightRenderData(t,e,s).shadowCamera;Er.setShadowCameraSettings(a,this.device,n,i,r);const o=0===i?0:s;return a.renderTarget=t._shadowMap.renderTargets[o],a}renderFace(t,e,s,i,n=!0){const r=this.device,a=this.getLightRenderData(t,e,s),o=a.shadowCamera;this.dispatchUniforms(t,o,a,s);const l=o.renderTarget,h=this.renderer;h.setCameraUniforms(o,l),r.supportsUniformBuffers&&h.setupViewUniformBuffers(a.viewBindGroups,this.viewUniformFormat,this.viewBindGroupFormat,1),n?(h.setupViewport(o,l),i&&h.clear(o)):h.clearView(o,l,!0,!1),this.setupRenderState(r,t),this.submitCasters(a.visibleCasters,t),this.restoreRenderState(r)}render(t,e,s=!0){if(this.needsShadowRendering(t)){const i=t.numShadowFaces;for(let n=0;n<i;n++)this.prepareFace(t,e,n),this.renderFace(t,e,n,!0,s);this.renderVsm(t,e)}}renderVsm(t,e){if(t._isVsm&&t._vsmBlurSize>1){this.renderer.scene.clusteredLightingEnabled&&0!==t._type||this.applyVsmBlur(t,e)}}getVsmBlurShader(t,e,s){let i=(t?this.blurPackedVsmShader:this.blurVsmShader)[e][s];if(!i){this.blurVsmWeights[s]=function(t){const e=(t-1)/6,s=.5*(t-1),i=new Array(t);let n=0;for(let r=0;r<t;++r)i[r]=vr(r-s,e),n+=i[r];for(let e=0;e<t;++e)i[e]/=n;return i}(s);const n=Ei.fullscreenQuadVS;let r="#define SAMPLES "+s+"\n";r+=t?this.blurPackedVsmShaderCode[e]:this.blurVsmShaderCode[e];const a="blurVsm"+e+s+t;i=Ai(this.device,n,r,a),t?this.blurPackedVsmShader[e][s]=i:this.blurVsmShader[e][s]=i}return i}applyVsmBlur(t,e){const s=this.device;s.setBlendState(Zt.NOBLEND);const i=t.getRenderData(0===t._type?e:null,0).shadowCamera.renderTarget,n=this.renderer.shadowMapCache.get(s,t),r=n.renderTargets[0],a=1===t._shadowType,o=t.vsmBlurMode,l=t._vsmBlurSize,h=this.getVsmBlurShader(a,o,l);wr.z=t._shadowResolution-2,wr.w=wr.z,this.sourceId.setValue(i.colorBuffer),xr[0]=1/t._shadowResolution,xr[1]=0,this.pixelOffsetId.setValue(xr),1===o&&this.weightId.setValue(this.blurVsmWeights[l]),Fi(s,r,h,null,wr),this.sourceId.setValue(r.colorBuffer),xr[1]=xr[0],xr[0]=0,this.pixelOffsetId.setValue(xr),Fi(s,i,h,null,wr),this.renderer.shadowMapCache.add(t,n)}initViewBindGroupFormat(){this.device.supportsUniformBuffers&&!this.viewUniformFormat&&(this.viewUniformFormat=new ge(this.device,[new me("matrix_viewProjection",Nt)]),this.viewBindGroupFormat=new xe(this.device,[new be(Vt,3)],[]))}frameUpdate(){this.initViewBindGroupFormat()}}let Pr=0;const Mr=[0,0,0,0],Ar=new V,kr=new V,Dr=new V,Rr=new L,Lr=new Q,Ir=(new V).setScale(1,-1,1),Or=(new V).set([1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1]),Fr=new V,Br=new V,zr=new V,Nr=new V,Ur=new Set;class Vr{constructor(t){this.clustersDebugRendered=!1,this.device=t,this.scene=null,this.lightTextureAtlas=new ar(t),this.shadowMapCache=new or,this.shadowRenderer=new Er(this,this.lightTextureAtlas),this._shadowRendererLocal=new lr(this,this.shadowRenderer),this._shadowRendererDirectional=new mr(this,this.shadowRenderer),this._cookieRenderer=new Zn(t,this.lightTextureAtlas),this.viewUniformFormat=null,this.viewBindGroupFormat=null,this._skinTime=0,this._morphTime=0,this._cullTime=0,this._shadowMapTime=0,this._lightClustersTime=0,this._layerCompositionUpdateTime=0,this._shadowDrawCalls=0,this._skinDrawCalls=0,this._instancedDrawCalls=0,this._shadowMapUpdates=0,this._numDrawCallsCulled=0,this._camerasRendered=0,this._lightClusters=0;const e=t.scope;this.boneTextureId=e.resolve("texture_poseMap"),this.boneTextureSizeId=e.resolve("texture_poseMapSize"),this.poseMatrixId=e.resolve("matrix_pose[0]"),this.modelMatrixId=e.resolve("matrix_model"),this.normalMatrixId=e.resolve("matrix_normal"),this.viewInvId=e.resolve("matrix_viewInverse"),this.viewPos=new Float32Array(3),this.viewPosId=e.resolve("view_position"),this.projId=e.resolve("matrix_projection"),this.projSkyboxId=e.resolve("matrix_projectionSkybox"),this.viewId=e.resolve("matrix_view"),this.viewId3=e.resolve("matrix_view3"),this.viewProjId=e.resolve("matrix_viewProjection"),this.flipYId=e.resolve("projectionFlipY"),this.tbnBasis=e.resolve("tbnBasis"),this.nearClipId=e.resolve("camera_near"),this.farClipId=e.resolve("camera_far"),this.cameraParams=new Float32Array(4),this.cameraParamsId=e.resolve("camera_params"),this.alphaTestId=e.resolve("alpha_ref"),this.opacityMapId=e.resolve("texture_opacityMap"),this.exposureId=e.resolve("exposure"),this.twoSidedLightingNegScaleFactorId=e.resolve("twoSidedLightingNegScaleFactor"),this.twoSidedLightingNegScaleFactorId.setValue(0),this.morphWeightsA=e.resolve("morph_weights_a"),this.morphWeightsB=e.resolve("morph_weights_b"),this.morphPositionTex=e.resolve("morphPositionTex"),this.morphNormalTex=e.resolve("morphNormalTex"),this.morphTexParams=e.resolve("morph_tex_params")}destroy(){this.shadowRenderer=null,this._shadowRendererLocal=null,this._shadowRendererDirectional=null,this.shadowMapCache.destroy(),this.shadowMapCache=null,this._cookieRenderer.destroy(),this._cookieRenderer=null,this.lightTextureAtlas.destroy(),this.lightTextureAtlas=null}sortCompare(t,e){if(t.layer===e.layer){if(t.drawOrder&&e.drawOrder)return t.drawOrder-e.drawOrder;if(t.zdist&&e.zdist)return e.zdist-t.zdist;if(t.zdist2&&e.zdist2)return t.zdist2-e.zdist2}return e._key[0]-t._key[0]}sortCompareMesh(t,e){if(t.layer===e.layer){if(t.drawOrder&&e.drawOrder)return t.drawOrder-e.drawOrder;if(t.zdist&&e.zdist)return e.zdist-t.zdist}const s=t._key[0],i=e._key[0];return s===i&&t.mesh&&e.mesh?e.mesh.id-t.mesh.id:i-s}sortCompareDepth(t,e){const s=t._key[1],i=e._key[1];return s===i&&t.mesh&&e.mesh?e.mesh.id-t.mesh.id:i-s}setupViewport(t,e){const s=this.device,i=e?e.width:s.width,n=e?e.height:s.height,r=t.rect;let a=Math.floor(r.x*i),o=Math.floor(r.y*n),l=Math.floor(r.z*i),h=Math.floor(r.w*n);if(s.setViewport(a,o,l,h),t._scissorRectClear){const e=t.scissorRect;a=Math.floor(e.x*i),o=Math.floor(e.y*n),l=Math.floor(e.z*i),h=Math.floor(e.w*n)}s.setScissor(a,o,l,h)}setCameraUniforms(t,e){const s=null==e?void 0:e.flipY;let i=1;if(t.xr&&t.xr.session){let e;const s=t._node.parent;s&&(e=s.getWorldTransform());const n=t.xr.views;i=n.length;for(let r=0;r<i;r++){const i=n[r];s?(i.viewInvOffMat.mul2(e,i.viewInvMat),i.viewOffMat.copy(i.viewInvOffMat).invert()):(i.viewInvOffMat.copy(i.viewInvMat),i.viewOffMat.copy(i.viewMat)),i.viewMat3.setFromMat4(i.viewOffMat),i.projViewOffMat.mul2(i.projMat,i.viewOffMat),i.position[0]=i.viewInvOffMat.data[12],i.position[1]=i.viewInvOffMat.data[13],i.position[2]=i.viewInvOffMat.data[14],t.frustum.setFromMat4(i.projViewOffMat)}}else{let e=t.projectionMatrix;t.calculateProjection&&t.calculateProjection(e,0);let i=t.getProjectionMatrixSkybox();if(s&&(e=Fr.mul2(Ir,e),i=Br.mul2(Ir,i)),this.device.isWebGPU&&(e=zr.mul2(Or,e),i=Nr.mul2(Or,i)),this.projId.setValue(e.data),this.projSkyboxId.setValue(i.data),t.calculateTransform)t.calculateTransform(kr,0);else{const e=t._node.getPosition(),s=t._node.getRotation();kr.setTRS(e,s,R.ONE)}this.viewInvId.setValue(kr.data),Dr.copy(kr).invert(),this.viewId.setValue(Dr.data),Rr.setFromMat4(Dr),this.viewId3.setValue(Rr.data),Ar.mul2(e,Dr),this.viewProjId.setValue(Ar.data),this.flipYId.setValue(s?-1:1),this.dispatchViewPos(t._node.getPosition()),t.frustum.setFromMat4(Ar)}this.tbnBasis.setValue(s?-1:1);const n=t._nearClip,r=t._farClip;return this.nearClipId.setValue(n),this.farClipId.setValue(r),this.cameraParams[0]=1/r,this.cameraParams[1]=r,this.cameraParams[2]=n,this.cameraParams[3]=1===t.projection?1:0,this.cameraParamsId.setValue(this.cameraParams),this.exposureId.setValue(this.scene.physicalUnits?t.getExposure():this.scene.exposure),i}clear(t,e,s,i){const n=((null!=e?e:t._clearColorBuffer)?1:0)|((null!=s?s:t._clearDepthBuffer)?2:0)|((null!=i?i:t._clearStencilBuffer)?4:0);if(n){this.device.clear({color:[t._clearColor.r,t._clearColor.g,t._clearColor.b,t._clearColor.a],depth:t._clearDepth,stencil:t._clearStencil,flags:n})}}setCamera(t,e,s,i=null){this.setCameraUniforms(t,e),this.clearView(t,e,s,!1)}clearView(t,e,s,i){const n=this.device;if(n.setRenderTarget(e),n.updateBegin(),i&&(n.setColorWrite(!0,!0,!0,!0),n.setDepthWrite(!0)),this.setupViewport(t,e),s){const e=t._clearOptions;n.clear(e||{color:[t._clearColor.r,t._clearColor.g,t._clearColor.b,t._clearColor.a],depth:t._clearDepth,flags:(t._clearColorBuffer?1:0)|(t._clearDepthBuffer?2:0)|(t._clearStencilBuffer?4:0),stencil:t._clearStencil})}}setupCullMode(t,e,s){const i=s.material;let n=tt;if(t){let t=1;2!==i.cull&&1!==i.cull||(t=e*s.flipFacesFactor*s.node.worldScaleSign),n=t<0?2===i.cull?1:2:i.cull}this.device.setCullMode(n),n===tt&&i.cull===tt&&this.twoSidedLightingNegScaleFactorId.setValue(s.node.worldScaleSign)}updateCameraFrustum(t){if(t.xr&&t.xr.views.length){const e=t.xr.views[0];return Ar.mul2(e.projMat,e.viewOffMat),void t.frustum.setFromMat4(Ar)}const e=t.projectionMatrix;if(t.calculateProjection&&t.calculateProjection(e,0),t.calculateTransform)t.calculateTransform(kr,0);else{const e=t._node.getPosition(),s=t._node.getRotation();kr.setTRS(e,s,R.ONE),this.viewInvId.setValue(kr.data)}Dr.copy(kr).invert(),Ar.mul2(e,Dr),t.frustum.setFromMat4(Ar)}setBaseConstants(t,e){t.setCullMode(e.cull),e.opacityMap&&this.opacityMapId.setValue(e.opacityMap),(e.opacityMap||e.alphaTest>0)&&this.alphaTestId.setValue(e.alphaTest)}updateCpuSkinMatrices(t){Pr++;const e=t.length;if(0!==e)for(let s=0;s<e;s++){const e=t[s].skinInstance;e&&(e.updateMatrices(t[s].node,Pr),e._dirty=!0)}}updateGpuSkinMatrices(t){const e=t.length;for(let s=0;s<e;s++){const e=t[s];if(e.visibleThisFrame){const t=e.skinInstance;t&&t._dirty&&(t.updateMatrixPalette(e.node,Pr),t._dirty=!1)}}}updateMorphing(t){const e=t.length;for(let s=0;s<e;s++){const e=t[s],i=e.morphInstance;i&&i._dirty&&e.visibleThisFrame&&i.update()}}gpuUpdate(t){this.updateGpuSkinMatrices(t),this.updateMorphing(t)}setVertexBuffers(t,e){t.setVertexBuffer(e.vertexBuffer)}setMorphing(t,e){if(e)if(e.morph.useTextureMorph)t.setVertexBuffer(e.morph.vertexBufferIds),this.morphPositionTex.setValue(e.texturePositions),this.morphNormalTex.setValue(e.textureNormals),this.morphTexParams.setValue(e._textureParams);else{for(let s=0;s<e._activeVertexBuffers.length;s++){const i=e._activeVertexBuffers[s];if(i){const e="ATTR"+(s+8);i.format.elements[0].name=e,i.format.elements[0].scopeId=t.scope.resolve(e),i.format.update(),t.setVertexBuffer(i)}}this.morphWeightsA.setValue(e._shaderMorphWeightsA),this.morphWeightsB.setValue(e._shaderMorphWeightsB)}}setSkinning(t,e){if(e.skinInstance)if(this._skinDrawCalls++,t.supportsBoneTextures){const t=e.skinInstance.boneTexture;this.boneTextureId.setValue(t),Mr[0]=t.width,Mr[1]=t.height,Mr[2]=1/t.width,Mr[3]=1/t.height,this.boneTextureSizeId.setValue(Mr)}else this.poseMatrixId.setValue(e.skinInstance.matrixPalette)}dispatchViewPos(t){const e=this.viewPos;e[0]=t.x,e[1]=t.y,e[2]=t.z,this.viewPosId.setValue(e)}initViewBindGroupFormat(){this.device.supportsUniformBuffers&&!this.viewUniformFormat&&(this.viewUniformFormat=new ge(this.device,[new me("matrix_viewProjection",Nt)]),this.viewBindGroupFormat=new xe(this.device,[new be(Vt,3)],[new ye("lightsTextureFloat",2,Ot,1),new ye("lightsTexture8",2,Ot,1)]))}setupViewUniformBuffers(t,e,s,i){const n=this.device;for(;t.length<i;){const i=new ze(n,e),r=new Fe(n,s,i);t.push(r)}const r=t[0];r.defaultUniformBuffer.update(),r.update(),n.setBindGroup(1,r)}setupMeshUniformBuffers(t,e){const s=this.device;if(s.supportsUniformBuffers){this.modelMatrixId.setValue(t.node.worldTransform.data),this.normalMatrixId.setValue(t.node.normalMatrix.data);const i=t.getBindGroup(s,e);i.defaultUniformBuffer.update(),i.update(),s.setBindGroup(0,i)}}drawInstance(t,e,s,i,n){const r=e.instancingData;if(r)r.count>0&&(this._instancedDrawCalls++,t.setVertexBuffer(r.vertexBuffer),t.draw(s.primitive[i],r.count));else{const r=e.node.worldTransform;this.modelMatrixId.setValue(r.data),n&&this.normalMatrixId.setValue(e.node.normalMatrix.data),t.draw(s.primitive[i])}}drawInstance2(t,e,s,i){const n=e.instancingData;n?n.count>0&&(this._instancedDrawCalls++,t.draw(s.primitive[i],n.count,!0)):t.draw(s.primitive[i],void 0,!0)}cull(t,e,s){let i=0;const n=e.length,r=t.cullingMask||4294967295;if(!t.frustumCulling){for(let t=0;t<n;t++){const n=e[t];(n.visible||n.command)&&(n.mask&&0==(n.mask&r)||(s[i]=n,i++,n.visibleThisFrame=!0))}return i}for(let a=0;a<n;a++){const n=e[a];if(n.command)s[i]=n,i++,n.visibleThisFrame=!0;else{if(!n.visible)continue;let e=!0;if(n.mask&&0==(n.mask&r))continue;n.cull&&(e=n._isVisible(t)),e&&(s[i]=n,i++,n.visibleThisFrame=!0)}}return i}cullLights(t,e){const s=this.scene.clusteredLightingEnabled,i=this.scene.physicalUnits;for(let n=0;n<e.length;n++){const r=e[n];if(r.enabled)if(0!==r._type)if(r.getBoundingSphere(Lr),t.frustum.containsSphere(Lr)){r.visibleThisFrame=!0,r.usePhysicalUnits=i;const e=t.getScreenSize(Lr);r.maxScreenSize=Math.max(r.maxScreenSize,e)}else s||r.castShadows&&!r.shadowMap&&(r.visibleThisFrame=!0);else r.usePhysicalUnits=this.scene.physicalUnits}}cullShadowmaps(t){const e=this.scene.clusteredLightingEnabled;for(let s=0;s<t._lights.length;s++){const i=t._lights[s];if(0!==i._type&&(e&&i.atlasSlotUpdated&&0===i.shadowUpdateMode&&(i.shadowUpdateMode=1),i.visibleThisFrame&&i.castShadows&&0!==i.shadowUpdateMode)){const e=t._lightCompositionData[s].shadowCastersList;this._shadowRendererLocal.cull(i,e)}}const s=t._renderActions;for(let e=0;e<s.length;e++){const i=s[e],n=i.directionalLightsIndices.length;for(let e=0;e<n;e++){const s=i.directionalLightsIndices[e],n=t._lights[s],r=t._lightCompositionData[s].shadowCastersList;this._shadowRendererDirectional.cull(n,r,i.camera.camera)}}}cullComposition(t){const e=t._renderActions;for(let s=0;s<e.length;s++){const i=e[s],n=i.layerIndex,r=t.layerList[n];if(!r.enabled||!t.subLayerEnabled[n])continue;const a=t.subLayerList[n],o=i.cameraIndex,l=r.cameras[o];if(l){l.frameUpdate(i.renderTarget),i.firstCameraUse&&(this.updateCameraFrustum(l.camera),this._camerasRendered++),this.cullLights(l.camera,r._lights);const t=r.instances,e=a?t.visibleTransparent[o]:t.visibleOpaque[o];if(!e.done){r.onPreCull&&r.onPreCull(o);const t=a?r.transparentMeshInstances:r.opaqueMeshInstances;e.length=this.cull(l.camera,t,e.list),e.done=!0,r.onPostCull&&r.onPostCull(o)}}}this.scene.clusteredLightingEnabled&&this.updateLightTextureAtlas(t),this.cullShadowmaps(t)}updateShaders(t,e){const s=t.length;for(let i=0;i<s;i++){const s=t[i].material;if(s&&!Ur.has(s)&&(Ur.add(s),s.getShaderVariant!==Ki.prototype.getShaderVariant)){if(e&&(!s.useLighting||s.emitter&&!s.emitter.lighting))continue;s.clearVariants()}}Ur.clear()}renderCookies(t){const e=this.lightTextureAtlas.cookieRenderTarget;for(let s=0;s<t.length;s++){const i=t[s];i.atlasViewportAllocated&&(i.atlasSlotUpdated&&this._cookieRenderer.render(i,e))}}beginFrame(t,e){const s=t._meshInstances,i=this.scene;if(i.updateShaders||e){const t=!i.updateShaders&&e;this.updateShaders(s,t),i.updateShaders=!1,i._shaderVersion++}this.updateCpuSkinMatrices(s);const n=s.length;for(let t=0;t<n;t++)s[t].visibleThisFrame=!1;const r=t._lights,a=r.length;for(let t=0;t<a;t++)r[t].beginFrame()}updateLightTextureAtlas(t){this.lightTextureAtlas.update(t._splitLights[2],t._splitLights[1],this.scene.lighting)}updateClusters(t){const e=t.getEmptyWorldClusters(this.device),s=t._renderActions;for(let i=0;i<s.length;i++){const n=s[i],r=n.lightClusters;if(r&&r!==e&&!Ur.has(r)){Ur.add(r);const e=t.layerList[n.layerIndex];r.update(e.clusteredLightsSet,this.scene.gammaCorrection,this.scene.lighting)}}Ur.clear()}updateLayerComposition(t,e){const s=t.layerList.length;for(let e=0;e<s;e++)t.layerList[e]._postRenderCounter=0;const i=this.scene,n=i._shaderVersion;for(let e=0;e<s;e++){const s=t.layerList[e];s._shaderVersion=n,s._preRenderCalledForCameras=0,s._postRenderCalledForCameras=0;const r=t.subLayerList[e];s._postRenderCounter|=r?2:1,s._postRenderCounterMax=s._postRenderCounter;for(let t=0;t<s.cameras.length;t++)s.instances.prepare(t);s._needsStaticPrepare&&s._staticLightHash&&!this.scene.clusteredLightingEnabled&&(s._staticPrepareDone&&(_r.revert(s.opaqueMeshInstances),_r.revert(s.transparentMeshInstances)),_r.prepare(this.device,i,s.opaqueMeshInstances,s._lights),_r.prepare(this.device,i,s.transparentMeshInstances,s._lights),t._dirty=!0,i.updateShaders=!0,s._needsStaticPrepare=!1,s._staticPrepareDone=!0)}return t._update(this.device,e)}frameUpdate(){this.clustersDebugRendered=!1,this.initViewBindGroupFormat()}}const Hr=2.399963229728653,Gr=function(t,e,s){const i=e*Hr,n=Math.sqrt(e)/Math.sqrt(s);t.x=n*Math.cos(i),t.y=n*Math.sin(i)},Wr=function(t,e,s,i=0,n=1){i=1-2*i,n=1-2*n;const r=k.lerp(i,n,e/s),a=Math.sqrt(1-r*r),o=Hr*e;t.x=Math.cos(o)*a,t.y=r,t.z=Math.sin(o)*a},jr=function(t){let e=(t<<16|t>>>16)>>>0;return e=((1431655765&e)<<1|(2863311530&e)>>>1)>>>0,e=((858993459&e)<<2|(3435973836&e)>>>2)>>>0,e=((252645135&e)<<4|(4042322160&e)>>>4)>>>0,e=((16711935&e)<<8|(4278255360&e)>>>8)>>>0,2.3283064365386963e-10*e},qr={linear:"decodeLinear",srgb:"decodeGamma",rgbm:"decodeRGBM",rgbe:"decodeRGBE",rgbp:"decodeRGBP"},Xr={linear:"encodeLinear",srgb:"encodeGamma",rgbm:"encodeRGBM",rgbe:"encodeRGBE",rgbp:"encodeRGBP"};class $r{static decodeFunc(t){return qr[t]||"decodeGamma"}static encodeFunc(t){return Xr[t]||"encodeGamma"}}const Kr=t=>{switch(t){case Ft:return"Cubemap";case"octahedral":return"Octahedral";default:return"Equirect"}},Yr=(t,e,s)=>{if(t<=0)e[s+0]=0,e[s+1]=0,e[s+2]=0,e[s+3]=0;else if(t>=1)e[s+0]=255,e[s+1]=0,e[s+2]=0,e[s+3]=0;else{let i=1*t%1,n=255*t%1,r=65025*t%1;const a=16581375*t%1;i-=n/255,n-=r/255,r-=a/255,e[s+0]=Math.min(255,Math.floor(256*i)),e[s+1]=Math.min(255,Math.floor(256*n)),e[s+2]=Math.min(255,Math.floor(256*r)),e[s+3]=Math.min(255,Math.floor(256*a))}},Qr=(t,e,s,i)=>{const n=2*s*Math.PI,r=Math.pow(1-e,1/(i+1)),a=Math.sqrt(1-r*r);t.set(Math.cos(n)*a,Math.sin(n)*a,r).normalize()},Jr=(t,e,s)=>{const i=2*s*Math.PI,n=Math.sqrt(1-e),r=Math.sqrt(e);t.set(Math.cos(i)*r,Math.sin(i)*r,n).normalize()},Zr=(t,e,s,i)=>{const n=2*s*Math.PI,r=Math.sqrt((1-e)/(1+(i*i-1)*e)),a=Math.sqrt(1-r*r);t.set(Math.cos(n)*a,Math.sin(n)*a,r).normalize()},ta=(t,e)=>{const s=t*e,i=e/(1-t*t+s*s);return i*i*(1/Math.PI)},ea={16:{2:26,8:20,32:17,128:16,512:16},32:{2:53,8:40,32:34,128:32,512:32},128:{2:214,8:163,32:139,128:130,512:128},1024:{2:1722,8:1310,32:1114,128:1041,512:1025}},sa=(t,e,s)=>{const i=s/t,n=1-Math.log2(e)/11,r=n*n,a=new R,o=new R,l=new R(0,0,1),h=[],c=((t,e)=>{const s=ea[t];return s&&s[e]||t})(t,e);for(let t=0;t<c;++t){Zr(a,t/c,jr(t),r);const e=a.z;if(o.set(a.x,a.y,a.z).mulScalar(2*e).sub(l),o.z>0){const t=ta(Math.min(1,e),r)/4+.001,s=.5*Math.log2(i/t);h.push(o.x,o.y,o.z,s)}}for(;h.length<4*t;)h.push(0,0,0,0);return h},ia=(t,e,s)=>{const i=(t=>{const e=t.length,s=Math.min(e,512),i=Math.ceil(e/s),n=new Uint8Array(s*i*4);let r=0;for(let s=0;s<e;s+=4)Yr(.5*t[s+0]+.5,n,r+0),Yr(.5*t[s+1]+.5,n,r+4),Yr(.5*t[s+2]+.5,n,r+8),Yr(t[s+3]/8,n,r+12),r+=16;return{width:s,height:i,data:n}})(s);return new Ue(t,{name:e,width:i.width,height:i.height,mipmaps:!1,minFilter:0,magFilter:0,levels:[i.data]})};class na{constructor(t=!0){this.map=new Map,this.destroyContent=t}destroy(){this.destroyContent&&this.map.forEach(((t,e)=>{t.destroy()}))}get(t,e){if(!this.map.has(t)){const s=e();return this.map.set(t,s),s}return this.map.get(t)}}const ra=new na(!1),aa=new je,oa=(t,e,s)=>aa.get(t,(()=>new na)).get(e,(()=>ia(t,e,ra.get(e,s)))),la=(t,e,s)=>oa(t,`lambert-samples-${e}-${s}`,(()=>((t,e)=>{const s=e/t,i=new R,n=[];for(let e=0;e<t;++e){Jr(i,e/t,jr(e));const r=i.z/Math.PI,a=.5*Math.log2(s/r);n.push(i.x,i.y,i.z,a)}return n})(e,s))),ha=(t,e,s)=>oa(t,`phong-samples-${e}-${s}`,(()=>((t,e)=>{const s=new R,i=[];for(let n=0;n<t;++n)Qr(s,n/t,jr(n),e),i.push(s.x,s.y,s.z,0);return i})(e,s)));function ca(t,e,s={}){var i;t instanceof de&&(t=arguments[1],e=arguments[2],s={},void 0!==arguments[3]&&(s.specularPower=arguments[3]),void 0!==arguments[4]&&(s.numSamples=arguments[4]));const n=s.hasOwnProperty("specularPower")?s.specularPower:1,r=s.hasOwnProperty("face")?s.face:null,a=s.hasOwnProperty("distribution")?s.distribution:1===n?"none":"phong",o={none:"reproject",lambert:"prefilterSamplesUnweighted",phong:"prefilterSamplesUnweighted",ggx:"prefilterSamples"}[a]||"reproject",l=o.startsWith("prefilterSamples"),h=$r.decodeFunc(t.encoding),c=$r.encodeFunc(e.encoding),d=`sample${Kr(t.projection)}`,u=`getDirection${Kr(e.projection)}`,p=s.hasOwnProperty("numSamples")?s.numSamples:1024,f=`${o}_${h}_${c}_${d}_${u}_${p}`,m=t.device;let g=Mi(m).getCachedShader(f);if(!g){g=Ai(m,"\nattribute vec2 vertex_position;\n\nuniform vec4 uvMod;\n\nvarying vec2 vUv0;\n\nvoid main(void) {\n\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\tvUv0 = getImageEffectUV((vertex_position.xy * 0.5 + 0.5) * uvMod.xy + uvMod.zw);\n}\n",`${`#define PROCESS_FUNC ${o}\n`+(l?"#define USE_SAMPLES_TEX\n":"")+(t.cubemap?"#define CUBEMAP_SOURCE\n":"")+`#define DECODE_FUNC ${h}\n`+`#define ENCODE_FUNC ${c}\n`+`#define SOURCE_FUNC ${d}\n`+`#define TARGET_FUNC ${u}\n`+`#define NUM_SAMPLES ${p}\n`+`#define NUM_SAMPLES_SQRT ${Math.round(Math.sqrt(p)).toFixed(1)}\n`}\n${Ei.reprojectPS}`,f)}m.setBlendState(Zt.NOBLEND);m.scope.resolve(t.cubemap?"sourceCube":"sourceTex").setValue(t);const _=m.scope.resolve("params"),v=m.scope.resolve("params2"),b=m.scope.resolve("uvMod");if(null!=(i=s)&&i.seamPixels){const t=s.seamPixels,i=(s.rect?s.rect.z:e.width)-2*t,n=(s.rect?s.rect.w:e.height)-2*t;b.setValue([(i+2*t)/i,(n+2*t)/n,-t/i,-t/n])}else b.setValue([1,1,0,0]);const y=[0,n,t.fixCubemapSeams?1/t.width:0,e.fixCubemapSeams?1/e.width:0],x=[e.width*e.height*(e.cubemap?6:1),t.width*t.height*(t.cubemap?6:1)];if(l){const e=t.width*t.height*(t.cubemap?6:1),s="ggx"===a?((t,e,s,i)=>oa(t,`ggx-samples-${e}-${s}-${i}`,(()=>sa(e,s,i))))(m,p,n,e):"lambert"===a?la(m,p,e):ha(m,p,n);m.scope.resolve("samplesTex").setValue(s),m.scope.resolve("samplesTexInverseSize").setValue([1/s.width,1/s.height])}for(let t=0;t<(e.cubemap?6:1);t++)if(null===r||t===r){var w;const i=new pe({colorBuffer:e,face:t,depth:!1});y[0]=t,_.setValue(y),v.setValue(x),Fi(m,i,g,null==(w=s)?void 0:w.rect),i.destroy()}}const da=(t,e=0)=>1+Math.floor(Math.log2(Math.max(t,e)));class ua{static generateSkyboxCubemap(t,e){const s=((t,e,s,i)=>new Ue(t,{name:`lighting-${e}`,cubemap:!0,width:e,height:e,format:s,type:7===s?Lt:kt,addressU:1,addressV:1,fixCubemapSeams:!0,mipmaps:!!i}))(t.device,e||(t.cubemap?t.width:t.width/4),7,!1);return ca(t,s,{numSamples:1024}),s}static generateLightingSource(t,e){const s=t.device,i=(t=>(t=>t.extTextureHalfFloat&&t.textureHalfFloatRenderable)(t)?et:(t=>t.extTextureFloat&&t.textureFloatRenderable)(t)?st:7)(s),n=(null==e?void 0:e.target)||new Ue(s,{name:"lighting-source",cubemap:!0,width:(null==e?void 0:e.size)||128,height:(null==e?void 0:e.size)||128,format:i,type:7===i?Lt:kt,addressU:1,addressV:1,fixCubemapSeams:!1,mipmaps:!0});return ca(t,n,{numSamples:t.mipmaps?1:1024}),n}static generateAtlas(t,e){const s=t.device,i=(null==e?void 0:e.target)||new Ue(s,{name:"envAtlas",width:(null==e?void 0:e.size)||512,height:(null==e?void 0:e.size)||512,format:7,type:Lt,projection:Bt,addressU:1,addressV:1,mipmaps:!1}),n=i.width/512,r=new O(0,0,512*n,256*n),a=da(256)-da(4);for(let e=0;e<a;++e)ca(t,i,{numSamples:1,rect:r,seamPixels:n}),r.x+=r.w,r.y+=r.w,r.z=Math.max(1,Math.floor(.5*r.z)),r.w=Math.max(1,Math.floor(.5*r.w));r.set(0,256*n,256*n,128*n);for(let s=1;s<7;++s)ca(t,i,{numSamples:(null==e?void 0:e.numReflectionSamples)||1024,distribution:(null==e?void 0:e.distribution)||"ggx",specularPower:Math.max(1,2048>>2*s),rect:r,seamPixels:n}),r.y+=r.w,r.z=Math.max(1,Math.floor(.5*r.z)),r.w=Math.max(1,Math.floor(.5*r.w));return r.set(128*n,384*n,64*n,32*n),ca(t,i,{numSamples:(null==e?void 0:e.numAmbientSamples)||2048,distribution:"lambert",rect:r,seamPixels:n}),i}static generatePrefilteredAtlas(t,e){const s=t[0].device,i=t[0].format,n=t[0].type,r=(null==e?void 0:e.target)||new Ue(s,{name:"envPrefilteredAtlas",width:(null==e?void 0:e.size)||512,height:(null==e?void 0:e.size)||512,format:i,type:n,projection:Bt,addressU:1,addressV:1,mipmaps:!1}),a=r.width/512,o=new O(0,0,512*a,256*a),l=da(512);for(let e=0;e<l;++e)ca(t[0],r,{numSamples:1,rect:o,seamPixels:a}),o.x+=o.w,o.y+=o.w,o.z=Math.max(1,Math.floor(.5*o.z)),o.w=Math.max(1,Math.floor(.5*o.w));o.set(0,256*a,256*a,128*a);for(let e=1;e<t.length;++e)ca(t[e],r,{numSamples:1,rect:o,seamPixels:a}),o.y+=o.w,o.z=Math.max(1,Math.floor(.5*o.z)),o.w=Math.max(1,Math.floor(.5*o.w));return o.set(128*a,384*a,64*a,32*a),null!=e&&e.legacyAmbient?ca(t[5],r,{numSamples:1,rect:o,seamPixels:a}):ca(t[0],r,{numSamples:(null==e?void 0:e.numSamples)||2048,distribution:"lambert",rect:o,seamPixels:a}),r}}class pa{constructor(){this.code=""}append(...t){t.forEach((t=>{t.endsWith("\n")?this.code+=t:this.code+=t+"\n"}))}prepend(...t){t.forEach((t=>{t.endsWith("\n")?this.code=t+this.code:this.code=t+"\n"+this.code}))}}const fa={vertex_normal:ot,vertex_tangent:lt,vertex_texCoord0:pt,vertex_texCoord1:ft,vertex_color:dt,vertex_boneWeights:ht,vertex_boneIndices:ct},ma={vVertexColor:"vec4",vPositionW:"vec3",vNormalV:"vec3",vNormalW:"vec3",vTangentW:"vec3",vBinormalW:"vec3",vObjectSpaceUpW:"vec3",vUv0:"vec2",vUv1:"vec2"};class ga{constructor(t,e){if(this.device=t,this.options=e,this.attributes={vertex_position:at},e.chunks){this.chunks={};const t=e.chunks;for(const e in Ei)if(t.hasOwnProperty(e)){const s=t[e];for(const t in fa)fa.hasOwnProperty(t)&&s.indexOf(t)>=0&&(this.attributes[t]=fa[t]);this.chunks[e]=s}else this.chunks[e]=Ei[e]}else this.chunks=Ei;this.shaderPassInfo=Ni.get(this.device).getByIndex(e.pass),this.shadowPass=this.shaderPassInfo.isShadow,this.lighting=e.lights.length>0||e.dirLightMapEnabled||e.clusteredLightingEnabled,this.reflections=!!e.reflectionSource,this.needsNormal=this.lighting||this.reflections||e.useSpecular||e.ambientSH||e.heightMapEnabled||e.enableGGXSpecular||e.clusteredLightingEnabled&&!this.shadowPass||e.clearCoatNormalMapEnabled,this.needsNormal=this.needsNormal&&!this.shadowPass,this.needsSceneColor=e.useDynamicRefraction,this.needsScreenSize=e.useDynamicRefraction,this.needsTransforms=e.useDynamicRefraction,this.varyings="",this.varyingDefines="",this.vshader=null,this.frontendDecl=null,this.frontendCode=null,this.frontendFunc=null,this.lightingUv=null,this.defines=[],this.fshader=null}_vsAddBaseCode(t,e,s){return t+=e.baseVS,1!==s.nineSlicedMode&&2!==s.nineSlicedMode||(t+=e.baseNineSlicedVS),t}_vsAddTransformCode(t,e,s,i){return t+=this.chunks.transformVS}_setMapTransform(t,e,s,i){const n=s+100*i;if(!t[3][n]){const r=`texture_${e}MapTransform`;t[0]+=`uniform vec3 ${r}0;\n`,t[0]+=`uniform vec3 ${r}1;\n`,t[1]+=`varying vec2 vUV${i}_${s};\n`,t[2]+=`   vUV${i}_${s} = vec2(dot(vec3(uv${i}, 1), ${r}0), dot(vec3(uv${i}, 1), ${r}1));\n`,t[3][n]=!0}return t}_fsGetBaseCode(){const t=this.options,e=this.chunks;let s=this.chunks.basePS;return 1===t.nineSlicedMode?s+=e.baseNineSlicedPS:2===t.nineSlicedMode&&(s+=e.baseNineSlicedTiledPS),s}_fsGetStartCode(t,e,s,i){let n=s.startPS;return 1===i.nineSlicedMode?n+=s.startNineSlicedPS:2===i.nineSlicedMode&&(n+=s.startNineSlicedTiledPS),n}_getLightSourceShapeString(t){switch(t){case 1:return"Rect";case 2:return"Disk";case 3:return"Sphere";default:return""}}generateVertexShader(t,e,s){const i=this.device,n=this.options,r=this.chunks;let a="",o="";a=this._vsAddBaseCode(a,r,n),o+="   vPositionW    = getWorldPosition();\n",2===this.options.pass&&(a+="varying float vDepth;\n",a+="#ifndef VIEWMATRIX\n",a+="#define VIEWMATRIX\n",a+="uniform mat4 matrix_view;\n",a+="#endif\n",a+="#ifndef CAMERAPLANES\n",a+="#define CAMERAPLANES\n",a+="uniform vec4 camera_params;\n\n",a+="#endif\n",o+="    vDepth = -(matrix_view * vec4(vPositionW,1.0)).z * camera_params.x;\n"),this.options.useInstancing&&(this.attributes.instance_line1=Et,this.attributes.instance_line2=Pt,this.attributes.instance_line3=Mt,this.attributes.instance_line4=At,a+=r.instancingVS),this.needsNormal&&(this.attributes.vertex_normal=ot,o+="   vNormalW = getNormal();\n","sphereMap"===n.reflectionSource&&i.fragmentUniformsCount<=16&&(a+=r.viewNormalVS,o+="   vNormalV    = getViewNormal();\n"),n.hasTangents&&(n.heightMapEnabled||n.normalMapEnabled||n.enableGGXSpecular)?(this.attributes.vertex_tangent=lt,a+=r.tangentBinormalVS,o+="   vTangentW   = getTangent();\n",o+="   vBinormalW  = getBinormal();\n"):!n.enableGGXSpecular&&i.extStandardDerivatives||(o+="   vObjectSpaceUpW = normalize(dNormalMatrix * vec3(0, 1, 0));\n"));for(let s=0;s<2;s++)t[s]&&(this.attributes["vertex_texCoord"+s]="TEXCOORD"+s,a+=r["uv"+s+"VS"],o+="   vec2 uv"+s+" = getUv"+s+"();\n"),e[s]&&(o+="   vUv"+s+" = uv"+s+";\n");const l=[a,this.varyings,o,[]];if(s.forEach((t=>{this._setMapTransform(l,t.name,t.id,t.uv)})),a=l[0],this.varyings=l[1],o=l[2],n.vertexColors&&(this.attributes.vertex_color=dt,o+="   vVertexColor = vertex_color;\n"),n.useMsdf&&n.msdfTextAttribute&&(this.attributes.vertex_outlineParameters=wt,this.attributes.vertex_shadowParameters=St,o+="    unpackMsdfParams();\n",a+=r.msdfVS),n.useMorphPosition||n.useMorphNormal)if(n.useMorphTextureBased){a+="#define MORPHING_TEXTURE_BASED\n",n.useMorphPosition&&(a+="#define MORPHING_TEXTURE_BASED_POSITION\n"),n.useMorphNormal&&(a+="#define MORPHING_TEXTURE_BASED_NORMAL\n"),this.attributes.morph_vertex_id=At;const t=i.isWebGPU?"uint":"float";a+=`attribute ${t} morph_vertex_id;\n`}else a+="#define MORPHING\n",n.useMorphPosition?(this.attributes.morph_pos0=wt,this.attributes.morph_pos1=St,this.attributes.morph_pos2=Ct,this.attributes.morph_pos3=Tt,a+="#define MORPHING_POS03\n",a+="attribute vec3 morph_pos0;\n",a+="attribute vec3 morph_pos1;\n",a+="attribute vec3 morph_pos2;\n",a+="attribute vec3 morph_pos3;\n"):n.useMorphNormal&&(this.attributes.morph_nrm0=wt,this.attributes.morph_nrm1=St,this.attributes.morph_nrm2=Ct,this.attributes.morph_nrm3=Tt,a+="#define MORPHING_NRM03\n",a+="attribute vec3 morph_nrm0;\n",a+="attribute vec3 morph_nrm1;\n",a+="attribute vec3 morph_nrm2;\n",a+="attribute vec3 morph_nrm3;\n"),n.useMorphNormal?(this.attributes.morph_nrm4=Et,this.attributes.morph_nrm5=Pt,this.attributes.morph_nrm6=Mt,this.attributes.morph_nrm7=At,a+="#define MORPHING_NRM47\n",a+="attribute vec3 morph_nrm4;\n",a+="attribute vec3 morph_nrm5;\n",a+="attribute vec3 morph_nrm6;\n",a+="attribute vec3 morph_nrm7;\n"):(this.attributes.morph_pos4=Et,this.attributes.morph_pos5=Pt,this.attributes.morph_pos6=Mt,this.attributes.morph_pos7=At,a+="#define MORPHING_POS47\n",a+="attribute vec3 morph_pos4;\n",a+="attribute vec3 morph_pos5;\n",a+="attribute vec3 morph_pos6;\n",a+="attribute vec3 morph_pos7;\n");n.skin?(this.attributes.vertex_boneWeights=ht,this.attributes.vertex_boneIndices=ct,a+=Gi(i,r),a+="#define SKIN\n"):n.useInstancing&&(a+="#define INSTANCING\n"),n.screenSpace&&(a+="#define SCREENSPACE\n"),n.pixelSnap&&(a+="#define PIXELSNAP\n"),a=this._vsAddTransformCode(a,i,r,n),this.needsNormal&&(a+=r.normalVS),a+="\n",a+=r.startVS,a+=o,a+=r.endVS,a+="}",Object.keys(ma).forEach((t=>{a.indexOf(t)>=0&&(this.varyings+=`varying ${ma[t]} ${t};\n`,this.varyingDefines+=`#define VARYING_${t.toUpperCase()}\n`)}));const h=this.shaderPassInfo.shaderDefines;this.vshader=h+this.varyings+a}_fsGetBeginCode(){let t=this.shaderPassInfo.shaderDefines;for(let e=0;e<this.defines.length;e++)t+=`#define ${this.defines[e]}\n`;return t}_fsGetPickPassCode(){let t=this._fsGetBeginCode();return t+="uniform vec4 uColor;\n",t+=this.varyings,t+=this.varyingDefines,t+=this.frontendDecl,t+=this.frontendCode,t+="void main(void)\n{\n",t+=this.frontendFunc,t+="    gl_FragColor = uColor;\n",t+="}\n",t}_fsGetDepthPassCode(){const t=this.chunks;let e=this._fsGetBeginCode();return e+="varying float vDepth;\n",e+=this.varyings,e+=this.varyingDefines,e+=t.packDepthPS,e+=this.frontendDecl,e+=this.frontendCode,e+="void main(void)\n{\n",e+=this.frontendFunc,e+="    gl_FragColor = packFloat(vDepth);\n",e+="}\n",e}_fsGetShadowPassCode(){const t=this.device,e=this.options,s=this.chunks,i=this.varyings,n=this.shaderPassInfo.lightType;let r=this.shaderPassInfo.shadowType;0!==n&&e.clusteredLightingEnabled&&(1!==r&&2!==r&&3!==r&&6!==r||(r=0));let a=this._fsGetBeginCode();!t.extStandardDerivatives||t.webgl2||t.isWebGPU||(a+="uniform vec2 polygonOffset;\n"),3===r?t.textureFloatHighPrecision?a+="#define VSM_EXPONENT 15.0\n\n":a+="#define VSM_EXPONENT 5.54\n\n":2===r&&(a+="#define VSM_EXPONENT 5.54\n\n"),0!==n&&(a+="uniform vec3 view_position;\n",a+="uniform float light_radius;\n"),a+=i,a+=this.varyingDefines,a+=this.frontendDecl,a+=this.frontendCode;const o=5===r||0===r||4===r||6===r,l=1===n&&6!==r&&!e.clusteredLightingEnabled,h=o&&!t.supportsDepthShadow||l;h?a+=s.packDepthPS:1===r&&(a+="vec2 encodeFloatRG( float v ) {\n",a+="    vec2 enc = vec2(1.0, 255.0) * v;\n",a+="    enc = fract(enc);\n",a+="    enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n",a+="    return enc;\n",a+="}\n\n"),6===r&&(a+=Ei.linearizeDepthPS),a+="void main(void)\n{\n",a+=this.frontendFunc;const c=1===r||2===r||3===r,d=6===r,u=0===n||!c&&2===n;let p=!1;if(u?d?(a+="    float depth = linearizeDepth(gl_FragCoord.z, camera_params);\n",p=!0):a+="    float depth = gl_FragCoord.z;\n":(a+="    float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);\n",p=!0),!t.webgl2&&t.extStandardDerivatives&&!t.isWebGPU&&(a+="    float minValue = 2.3374370500153186e-10; //(1.0 / 255.0) / (256.0 * 256.0 * 256.0);\n",a+="    depth += polygonOffset.x * max(abs(dFdx(depth)), abs(dFdy(depth))) + minValue * polygonOffset.y;\n",p=!0),u&&d&&h&&(a+="    depth *= 1.0 / (camera_params.y - camera_params.z);\n",p=!0),h)a+="    gl_FragColor = packFloat(depth);\n";else if(c)a+=1===r?"    gl_FragColor = vec4(encodeFloatRG(depth), encodeFloatRG(depth*depth));\n":s.storeEVSMPS;else{6===r?a+="    gl_FragColor.r = depth;\n":(p&&(a+="    gl_FragDepth = depth;\n"),a+="    gl_FragColor = vec4(1.0);\n")}return a+="}\n",a}_fsGetLitPassCode(){const t=this.device,e=this.options,s=this.chunks,i=new pa,n=new pa,r=new pa,a=new pa;!1===e.opacityFadesSpecular&&i.append("uniform float material_alphaFade;"),e.useSpecular&&(this.defines.push("LIT_SPECULAR"),this.reflections&&this.defines.push("LIT_REFLECTIONS"),e.useClearCoat&&this.defines.push("LIT_CLEARCOAT"),e.fresnelModel>0&&this.defines.push("LIT_SPECULAR_FRESNEL"),e.conserveEnergy&&this.defines.push("LIT_CONSERVE_ENERGY"),e.useSheen&&this.defines.push("LIT_SHEEN"),e.useIridescence&&this.defines.push("LIT_IRIDESCENCE"));const o=[];let l=0,h=!1,c=!1,d=!1,u=e.lights.some((function(t){return t._shape&&0!==t._shape}));e.clusteredLightingEnabled&&e.clusteredLightingAreaLightsEnabled&&(u=!0);let p="highp";7===t.areaLightLutFormat&&(i.append("#define AREA_R8_G8_B8_A8_LUTS"),p="lowp"),(u||e.clusteredLightingEnabled)&&(i.append("#define AREA_LIGHTS"),i.append(`uniform ${p} sampler2D areaLightsLutTex1;`),i.append(`uniform ${p} sampler2D areaLightsLutTex2;`));for(let s=0;s<e.lights.length;s++){const n=e.lights[s],r=n._type;if(e.clusteredLightingEnabled&&0!==r)continue;const a=u&&n._shape?n._shape:0;i.append("uniform vec3 light"+s+"_color;"),6===n._shadowType&&n.castShadows&&!e.noShadow&&(i.append(`uniform float light${s}_shadowSearchArea;`),i.append(`uniform vec4 light${s}_cameraParams;`)),0===r?i.append("uniform vec3 light"+s+"_direction;"):(i.append("uniform vec3 light"+s+"_position;"),i.append("uniform float light"+s+"_radius;"),2===r&&(i.append("uniform vec3 light"+s+"_direction;"),i.append("uniform float light"+s+"_innerConeAngle;"),i.append("uniform float light"+s+"_outerConeAngle;"))),0!==a&&(0===r&&i.append("uniform vec3 light"+s+"_position;"),i.append("uniform vec3 light"+s+"_halfWidth;"),i.append("uniform vec3 light"+s+"_halfHeight;")),n.castShadows&&!e.noShadow&&(i.append("uniform mat4 light"+s+"_shadowMatrix;"),i.append("uniform float light"+s+"_shadowIntensity;"),0===r&&(i.append("uniform mat4 light"+s+"_shadowMatrixPalette[4];"),i.append("uniform float light"+s+"_shadowCascadeDistances[4];"),i.append("uniform float light"+s+"_shadowCascadeCount;")),i.append("uniform vec4 light"+s+"_shadowParams;"),0===r&&(h=!0),1===r?i.append("uniform samplerCube light"+s+"_shadowMap;"):n._isPcf&&t.supportsDepthShadow?i.append("uniform sampler2DShadow light"+s+"_shadowMap;"):i.append("uniform sampler2D light"+s+"_shadowMap;"),l++,o[n._shadowType]=!0,n._isVsm&&(c=!0),6===n._shadowType&&(d=!0)),n._cookie&&(n._cookie._cubemap?1===r&&(i.append("uniform samplerCube light"+s+"_cookie;"),i.append("uniform float light"+s+"_cookieIntensity;"),n.castShadows&&!e.noShadow||i.append("uniform mat4 light"+s+"_shadowMatrix;")):2===r&&(i.append("uniform sampler2D light"+s+"_cookie;"),i.append("uniform float light"+s+"_cookieIntensity;"),n.castShadows&&!e.noShadow||i.append("uniform mat4 light"+s+"_shadowMatrix;"),n._cookieTransform&&(i.append("uniform vec4 light"+s+"_cookieMatrix;"),i.append("uniform vec2 light"+s+"_cookieOffset;"))))}const f=this.needsNormal&&(e.normalMapEnabled||e.clearCoatNormalMapEnabled||e.enableGGXSpecular&&!e.heightMapEnabled);f&&(e.hasTangents?n.append(e.fastTbn?s.TBNfastPS:s.TBNPS):t.extStandardDerivatives&&(e.normalMapEnabled||e.clearCoatNormalMapEnabled)?n.append(s.TBNderivativePS.replace(/\$UV/g,this.lightingUv)):n.append(s.TBNObjectSpacePS)),n.append(s.sphericalPS),n.append(s.decodePS),n.append(Ui(e.gamma,s)),n.append(Vi(e.toneMap,s)),n.append(Hi(e.fog,s)),n.append(this.frontendCode),e.useCubeMapRotation&&i.append("#define CUBEMAP_ROTATION"),this.needsNormal&&(n.append(s.cubeMapRotatePS),n.append(e.cubeMapProjection>0?s.cubeMapProjectBoxPS:s.cubeMapProjectNonePS),n.append(e.skyboxIntensity?s.envMultiplyPS:s.envConstPS)),(this.lighting&&e.useSpecular||this.reflections)&&(e.useMetalness&&n.append(s.metalnessModulatePS),2===e.fresnelModel&&n.append(s.fresnelSchlickPS),e.useIridescence&&n.append(s.iridescenceDiffractionPS));const m=e.aoMapEnabled||e.useAoVertexColors;if(m)switch(n.append(s.aoDiffuseOccPS),e.occludeSpecular){case 1:n.append(e.occludeSpecularFloat?s.aoSpecOccSimplePS:s.aoSpecOccConstSimplePS);break;case 2:n.append(e.occludeSpecularFloat?s.aoSpecOccPS:s.aoSpecOccConstPS)}if("envAtlasHQ"===e.reflectionSource)n.append(e.fixSeams?s.fixCubemapSeamsStretchPS:s.fixCubemapSeamsNonePS),n.append(s.envAtlasPS),n.append(s.reflectionEnvHQPS.replace(/\$DECODE_CUBEMAP/g,$r.decodeFunc(e.reflectionCubemapEncoding)).replace(/\$DECODE/g,$r.decodeFunc(e.reflectionEncoding)));else if("envAtlas"===e.reflectionSource)n.append(s.envAtlasPS),n.append(s.reflectionEnvPS.replace(/\$DECODE/g,$r.decodeFunc(e.reflectionEncoding)));else if("cubeMap"===e.reflectionSource)n.append(e.fixSeams?s.fixCubemapSeamsStretchPS:s.fixCubemapSeamsNonePS),n.append(s.reflectionCubePS.replace(/\$DECODE/g,$r.decodeFunc(e.reflectionEncoding)));else if("sphereMap"===e.reflectionSource){const i=t.fragmentUniformsCount>16?s.reflectionSpherePS:s.reflectionSphereLowPS;n.append(i.replace(/\$DECODE/g,$r.decodeFunc(e.reflectionEncoding)))}this.reflections&&(e.useClearCoat&&n.append(s.reflectionCCPS),e.useSheen&&n.append(s.reflectionSheenPS)),e.useRefraction&&(e.useDynamicRefraction?n.append(s.refractionDynamicPS):this.reflections&&n.append(s.refractionCubePS)),e.useSheen&&n.append(s.lightSheenPS),e.clusteredLightingEnabled&&(n.append(s.clusteredLightUtilsPS),e.clusteredLightingCookiesEnabled&&n.append(s.clusteredLightCookiesPS),e.clusteredLightingShadowsEnabled&&!e.noShadow&&(o[0]=!0,o[4]=!0,o[6]=!0)),(l>0||e.clusteredLightingEnabled)&&(h&&n.append(s.shadowCascadesPS),(o[5]||o[0])&&n.append(s.shadowStandardPS),o[4]&&(t.webgl2||t.isWebGPU)&&n.append(s.shadowStandardGL2PS),c&&(n.append(s.shadowVSM_commonPS),o[1]&&n.append(s.shadowVSM8PS),o[2]&&n.append(t.extTextureHalfFloatLinear?s.shadowEVSMPS.replace(/\$/g,"16"):s.shadowEVSMnPS.replace(/\$/g,"16")),o[3]&&n.append(t.extTextureFloatLinear?s.shadowEVSMPS.replace(/\$/g,"32"):s.shadowEVSMnPS.replace(/\$/g,"32"))),d&&(n.append(s.linearizeDepthPS),n.append(s.shadowPCSSPS)),t.webgl2||t.extStandardDerivatives||t.isWebGPU||n.append(s.biasConstPS)),e.enableGGXSpecular&&n.append("uniform float material_anisotropy;"),this.lighting&&(n.append(s.lightDiffuseLambertPS),(u||e.clusteredLightingAreaLightsEnabled)&&n.append(s.ltcPS));let g=!1;e.useSpecular&&(this.lighting&&n.append(0===e.shadingModel?s.lightSpecularPhongPS:e.enableGGXSpecular?s.lightSpecularAnisoGGXPS:s.lightSpecularBlinnPS),e.fresnelModel||this.reflections||e.diffuseMapEnabled||(i.append("uniform vec3 material_ambient;"),i.append("#define LIT_OLD_AMBIENT"),g=!0)),n.append(s.combinePS),(e.lightMapEnabled||e.useLightMapVertexColors)&&n.append(e.useSpecular&&e.dirLightMapEnabled?s.lightmapDirAddPS:s.lightmapAddPS);const _=!e.lightMapEnabled&&!e.useLightMapVertexColors||e.lightMapWithoutAmbient;_&&("ambientSH"===e.ambientSource?n.append(s.ambientSHPS):"envAtlas"===e.ambientSource?("envAtlas"!==e.reflectionSource&&"envAtlasHQ"!==e.reflectionSource&&n.append(s.envAtlasPS),n.append(s.ambientEnvPS.replace(/\$DECODE/g,$r.decodeFunc(e.ambientEncoding)))):n.append(s.ambientConstantPS)),e.useAmbientTint&&!g&&i.append("uniform vec3 material_ambient;"),e.useMsdf&&(e.msdfTextAttribute||i.append("#define UNIFORM_TEXT_PARAMETERS"),n.append(s.msdfPS)),this.needsNormal&&(n.append(s.viewDirPS),e.useSpecular&&n.append(e.enableGGXSpecular?s.reflDirAnisoPS:s.reflDirPS));let v,b=!1,y=!1,x=!1,w=!1,S=!1;if(e.clusteredLightingEnabled&&this.lighting&&(w=!0,b=!0,y=!0,S=!0,n.append(s.floatUnpackingPS),e.lightMaskDynamic&&i.append("#define CLUSTER_MESH_DYNAMIC_LIGHTS"),e.clusteredLightingCookiesEnabled&&i.append("#define CLUSTER_COOKIES"),e.clusteredLightingShadowsEnabled&&!e.noShadow&&(i.append("#define CLUSTER_SHADOWS"),i.append("#define CLUSTER_SHADOW_TYPE_"+ti[e.clusteredLightingShadowType])),e.clusteredLightingAreaLightsEnabled&&i.append("#define CLUSTER_AREALIGHTS"),i.append(Wn.shaderDefines),e.clusteredLightingShadowsEnabled&&!e.noShadow&&n.append(s.clusteredLightShadowsPS),n.append(s.clusteredLightPS)),e.twoSidedLighting&&i.append("uniform float twoSidedLightingNegScaleFactor;"),a.append(this._fsGetStartCode(a,t,s,e)),this.needsNormal&&(e.twoSidedLighting?a.append("    dVertexNormalW = normalize(gl_FrontFacing ? vNormalW * twoSidedLightingNegScaleFactor : -vNormalW * twoSidedLightingNegScaleFactor);"):a.append("    dVertexNormalW = normalize(vNormalW);"),(e.heightMapEnabled||e.normalMapEnabled)&&e.hasTangents&&(e.twoSidedLighting?(a.append("    dTangentW = gl_FrontFacing ? vTangentW * twoSidedLightingNegScaleFactor : -vTangentW * twoSidedLightingNegScaleFactor;"),a.append("    dBinormalW = gl_FrontFacing ? vBinormalW * twoSidedLightingNegScaleFactor : -vBinormalW * twoSidedLightingNegScaleFactor;")):(a.append("    dTangentW = vTangentW;"),a.append("    dBinormalW = vBinormalW;"))),a.append("    getViewDir();"),f&&a.append("    getTBN(dTangentW, dBinormalW, dVertexNormalW);")),a.append(this.frontendFunc),this.needsNormal&&(e.useSpecular&&r.append("    getReflDir(litShaderArgs.worldNormal, dViewDirW, litShaderArgs.gloss, dTBN);"),e.useClearCoat&&r.append("    ccReflDirW = normalize(-reflect(dViewDirW, litShaderArgs.clearcoat.worldNormal));")),(this.lighting&&e.useSpecular||this.reflections)&&(e.useMetalness&&r.append("    getMetalnessModulate(litShaderArgs);"),e.useIridescence&&r.append("    vec3 iridescenceFresnel = getIridescence(saturate(dot(dViewDirW, litShaderArgs.worldNormal)), litShaderArgs.specularity, litShaderArgs.iridescence);")),_&&(r.append("    addAmbient(litShaderArgs.worldNormal);"),e.conserveEnergy&&e.useSpecular&&r.append("   dDiffuseLight = dDiffuseLight * (1.0 - litShaderArgs.specularity);"),e.separateAmbient&&r.append("\n\t\t\t\t\t\t\t\t\t\tvec3 dAmbientLight = dDiffuseLight;\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight = vec3(0);\n\t\t\t\t\t\t\t\t")),e.useAmbientTint&&!g&&r.append("    dDiffuseLight *= material_ambient;"),m&&!e.occludeDirect&&r.append("    occludeDiffuse(litShaderArgs.ao);"),(e.lightMapEnabled||e.useLightMapVertexColors)&&r.append("    addLightMap(\n\t\t\t\t\t\t\t\tlitShaderArgs.lightmap, \n\t\t\t\t\t\t\t\tlitShaderArgs.lightmapDir, \n\t\t\t\t\t\t\t\tlitShaderArgs.worldNormal, \n\t\t\t\t\t\t\t\tdViewDirW, \n\t\t\t\t\t\t\t\tdReflDirW, \n\t\t\t\t\t\t\t\tlitShaderArgs.gloss, \n\t\t\t\t\t\t\t\tlitShaderArgs.specularity, \n\t\t\t\t\t\t\t\tdVertexNormalW,\n\t\t\t\t\t\t\t\tdTBN\n\t\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\t\t\t\tlitShaderArgs.iridescence\n\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t);"),this.lighting||this.reflections){this.reflections&&(e.useClearCoat&&(r.append("    addReflectionCC(ccReflDirW, litShaderArgs.clearcoat.gloss);"),e.fresnelModel>0?(r.append("    ccFresnel = getFresnelCC(dot(dViewDirW, litShaderArgs.clearcoat.worldNormal));"),r.append("    ccReflection.rgb *= ccFresnel;")):r.append("    ccFresnel = 0.0;")),e.useSpecularityFactor&&r.append("    ccReflection.rgb *= litShaderArgs.specularityFactor;"),e.useSheen&&r.append("    addReflectionSheen(litShaderArgs.worldNormal, dViewDirW, litShaderArgs.sheen.gloss);"),r.append("    addReflection(dReflDirW, litShaderArgs.gloss);"),e.fresnelModel>0?r.append("    dReflection.rgb *= \n\t\t\t\t\t\t\t\t\t\t\t\tgetFresnel(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tdot(dViewDirW, litShaderArgs.worldNormal), \n\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitShaderArgs.gloss, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitShaderArgs.specularity\n\t\t\t\t\t\t\t\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t, iridescenceFresnel,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitShaderArgs.iridescence\n\t\t\t\t\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t);"):r.append("    dReflection.rgb *= litShaderArgs.specularity;"),e.useSpecularityFactor&&r.append("    dReflection.rgb *= litShaderArgs.specularityFactor;")),u&&(r.append("    dSpecularLight *= litShaderArgs.specularity;"),e.useSpecular&&r.append("    calcLTCLightValues(litShaderArgs.gloss, litShaderArgs.worldNormal, dViewDirW, litShaderArgs.specularity, litShaderArgs.clearcoat.gloss, litShaderArgs.clearcoat.worldNormal, litShaderArgs.clearcoat.specularity);"));for(let i=0;i<e.lights.length;i++){const a=e.lights[i],o=a._type;if(e.clusteredLightingEnabled&&0!==o)continue;v=!1;const l=u&&a._shape?a.shape:0,h=u&&a._shape?this._getLightSourceShapeString(l):"";if(0!==l&&r.append("    calc"+h+"LightValues(light"+i+"_position, light"+i+"_halfWidth, light"+i+"_halfHeight);"),0===o?(r.append("    dLightDirNormW = light"+i+"_direction;"),r.append("    dAtten = 1.0;")):(a._cookie&&(2!==o||a._cookie._cubemap?1===o&&a._cookie._cubemap&&(S=!0,v=!0):(S=!0,v=!0)),r.append("    getLightDirPoint(light"+i+"_position);"),b=!0,v&&(2===o?r.append("    dAtten3 = getCookie2D"+(a._cookieFalloff?"":"Clip")+(a._cookieTransform?"Xform":"")+"(light"+i+"_cookie, light"+i+"_shadowMatrix, light"+i+"_cookieIntensity"+(a._cookieTransform?", light"+i+"_cookieMatrix, light"+i+"_cookieOffset":"")+")."+a._cookieChannel+";"):r.append("    dAtten3 = getCookieCube(light"+i+"_cookie, light"+i+"_shadowMatrix, light"+i+"_cookieIntensity)."+a._cookieChannel+";")),0===l?0===a._falloffMode?(r.append("    dAtten = getFalloffLinear(light"+i+"_radius, dLightDirW);"),y=!0):(r.append("    dAtten = getFalloffInvSquared(light"+i+"_radius, dLightDirW);"),x=!0):(r.append("    dAtten = getFalloffWindow(light"+i+"_radius, dLightDirW);"),x=!0),r.append("    if (dAtten > 0.00001) {"),2===o&&(v&&!a._cookieFalloff||(r.append("    dAtten *= getSpotEffect(light"+i+"_direction, light"+i+"_innerConeAngle, light"+i+"_outerConeAngle, dLightDirNormW);"),w=!0))),0!==l?0===o?r.append("    dAttenD = getLightDiffuse(litShaderArgs.worldNormal, dViewDirW, dLightDirW, dLightDirNormW);"):r.append("    dAttenD = get"+h+"LightDiffuse(litShaderArgs.worldNormal, dViewDirW, dLightDirW, dLightDirNormW) * 16.0;"):r.append("    dAtten *= getLightDiffuse(litShaderArgs.worldNormal, dViewDirW, dLightDirW, dLightDirNormW);"),a.castShadows&&!e.noShadow){const e=6===a._shadowType,h=1===a._shadowType||2===a._shadowType||3===a._shadowType,c=5===a._shadowType||0===a._shadowType||4===a._shadowType;let d,u=null;switch(a._shadowType){case 1:u="VSM8",d="0.0";break;case 2:u="VSM16",d="5.54";break;case 3:u="VSM32",d=t.textureFloatHighPrecision?"15.0":"5.54";break;case 5:u="PCF1x1";break;case 4:u="PCF5x5";break;case 6:u="PCSS";break;default:u="PCF3x3"}if(null!==u){a._normalOffsetBias&&!a._isVsm&&n.append("#define SHADOW_SAMPLE_NORMAL_OFFSET"),0===o&&n.append("#define SHADOW_SAMPLE_ORTHO"),((c||e)&&t.webgl2||t.extStandardDerivatives||t.isWebGPU)&&n.append("#define SHADOW_SAMPLE_SOURCE_ZBUFFER"),1===o&&n.append("#define SHADOW_SAMPLE_POINT");const p=s.shadowSampleCoordPS;n.append(p.replace("$LIGHT",i)),n.append("#undef SHADOW_SAMPLE_NORMAL_OFFSET"),n.append("#undef SHADOW_SAMPLE_ORTHO"),n.append("#undef SHADOW_SAMPLE_SOURCE_ZBUFFER"),n.append("#undef SHADOW_SAMPLE_POINT");let f=`light${i}_shadowMatrix`;0===o&&a.numCascades>1&&(r.append(`    getShadowCascadeMatrix(light${i}_shadowMatrixPalette, light${i}_shadowCascadeDistances, light${i}_shadowCascadeCount);`),f="cascadeShadowMat"),r.append(`    dShadowCoord = getShadowSampleCoord${i}(${f}, light${i}_shadowParams, vPositionW, dLightPosW, dLightDirW, dLightDirNormW, dVertexNormalW);`),0===o&&r.append(`    fadeShadow(light${i}_shadowCascadeDistances);`);var C=`SHADOWMAP_PASS(light${i}_shadowMap), dShadowCoord, light${i}_shadowParams`;if(h)C=`${C}, ${d}, dLightDirW`;else if(e){let t=`vec2(light${i}_shadowSearchArea)`;0!==l&&(t=`vec2(length(light${i}_halfWidth), length(light${i}_halfHeight)) * light${i}_shadowSearchArea`),C=`${C}, light${i}_cameraParams, ${t}, dLightDirW`}1===o?(u=`Point${u}`,e||(C=`${C}, dLightDirW`)):2===o&&(u=`Spot${u}`),r.append(`    float shadow${i} = getShadow${u}(${C});`),r.append(`    dAtten *= mix(1.0, shadow${i}, light${i}_shadowIntensity);`)}}if(0!==l?e.conserveEnergy&&e.useSpecular?r.append("    dDiffuseLight += ((dAttenD * dAtten) * light"+i+"_color"+(v?" * dAtten3":"")+") * (1.0 - dLTCSpecFres);"):r.append("    dDiffuseLight += (dAttenD * dAtten) * light"+i+"_color"+(v?" * dAtten3":"")+";"):u&&e.conserveEnergy&&e.useSpecular?r.append("    dDiffuseLight += (dAtten * light"+i+"_color"+(v?" * dAtten3":"")+") * (1.0 - litShaderArgs.specularity);"):r.append("    dDiffuseLight += dAtten * light"+i+"_color"+(v?" * dAtten3":"")+";"),e.useSpecular&&r.append("    dHalfDirW = normalize(-dLightDirNormW + dViewDirW);"),a.affectSpecularity)if(0!==l)e.useClearCoat&&r.append(`    ccSpecularLight += ccLTCSpecFres * get${h}LightSpecular(litShaderArgs.clearcoat.worldNormal, dViewDirW) * dAtten * light${i}_color`+(v?" * dAtten3":"")+";"),e.useSpecular&&r.append(`    dSpecularLight += dLTCSpecFres * get${h}LightSpecular(litShaderArgs.worldNormal, dViewDirW) * dAtten * light${i}_color`+(v?" * dAtten3":"")+";");else{var T=!1;0===o&&e.fresnelModel>0&&(T=!0),e.useClearCoat&&r.append(`    ccSpecularLight += getLightSpecular(dHalfDirW, ccReflDirW, litShaderArgs.clearcoat.worldNormal, dViewDirW, dLightDirNormW, litShaderArgs.clearcoat.gloss, dTBN) * dAtten * light${i}_color`+(v?" * dAtten3":"")+(T?" * getFresnelCC(dot(dViewDirW, dHalfDirW));":";")),e.useSheen&&r.append(`    sSpecularLight += getLightSpecularSheen(dHalfDirW, litShaderArgs.worldNormal, dViewDirW, dLightDirNormW, litShaderArgs.sheen.gloss) * dAtten * light${i}_color`+(v?" * dAtten3;":";")),e.useSpecular&&r.append(`    dSpecularLight += getLightSpecular(dHalfDirW, dReflDirW, litShaderArgs.worldNormal, dViewDirW, dLightDirNormW, litShaderArgs.gloss, dTBN) * dAtten * light${i}_color`+(v?" * dAtten3":"")+(T?" \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t* getFresnel(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdot(dViewDirW, dHalfDirW), \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitShaderArgs.gloss, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitShaderArgs.specularity\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t, iridescenceFresnel, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitShaderArgs.iridescence\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t);":"* litShaderArgs.specularity;"))}0!==o&&r.append("    }")}e.clusteredLightingEnabled&&this.lighting&&(y=!0,x=!0,b=!0,r.append("    addClusteredLights(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitShaderArgs.worldNormal, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdViewDirW, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdReflDirW,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t#if defined(LIT_CLEARCOAT)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tccReflDirW,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitShaderArgs.gloss, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitShaderArgs.specularity, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdVertexNormalW, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tdTBN, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tiridescenceFresnel,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitShaderArgs.clearcoat, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitShaderArgs.sheen, \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tlitShaderArgs.iridescence\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t);")),u&&(e.useClearCoat&&r.append("    litShaderArgs.clearcoat.specularity = 1.0;"),e.useSpecular&&r.append("    litShaderArgs.specularity = vec3(1);")),e.useRefraction&&r.append("    addRefraction(\n\t\t\t\t\t\t\t\t\t\t\t\tlitShaderArgs.worldNormal, \n\t\t\t\t\t\t\t\t\t\t\t\tdViewDirW, \n\t\t\t\t\t\t\t\t\t\t\t\tlitShaderArgs.thickness, \n\t\t\t\t\t\t\t\t\t\t\t\tlitShaderArgs.gloss, \n\t\t\t\t\t\t\t\t\t\t\t\tlitShaderArgs.specularity, \n\t\t\t\t\t\t\t\t\t\t\t\tlitShaderArgs.albedo, \n\t\t\t\t\t\t\t\t\t\t\t\tlitShaderArgs.transmission\n\t\t\t\t\t\t\t\t\t\t#if defined(LIT_IRIDESCENCE)\n\t\t\t\t\t\t\t\t\t\t\t\t, iridescenceFresnel, \n\t\t\t\t\t\t\t\t\t\t\t\tlitShaderArgs.iridescence\n\t\t\t\t\t\t\t\t\t\t#endif\n\t\t\t\t\t\t\t\t\t\t);")}m&&(e.occludeDirect&&r.append("    occludeDiffuse(litShaderArgs.ao);"),1!==e.occludeSpecular&&2!==e.occludeSpecular||r.append("    occludeSpecular(litShaderArgs.gloss, litShaderArgs.ao, litShaderArgs.worldNormal, dViewDirW);")),e.useSpecularityFactor&&r.append("    dSpecularLight *= litShaderArgs.specularityFactor;"),!1===e.opacityFadesSpecular&&(2!==e.blendType&&4!==e.blendType||(r.append("float specLum = dot((dSpecularLight + dReflection.rgb * dReflection.a), vec3( 0.2126, 0.7152, 0.0722 ));"),r.append("#ifdef LIT_CLEARCOAT\n specLum += dot(ccSpecularLight * litShaderArgs.clearcoat.specularity + ccReflection.rgb * litShaderArgs.clearcoat.specularity, vec3( 0.2126, 0.7152, 0.0722 ));\n#endif"),r.append("litShaderArgs.opacity = clamp(litShaderArgs.opacity + gammaCorrectInput(specLum), 0.0, 1.0);")),r.append("litShaderArgs.opacity *= material_alphaFade;")),r.append(s.endPS),2===e.blendType||6===e.blendType||e.alphaToCoverage?r.append(s.outputAlphaPS):4===e.blendType?r.append(s.outputAlphaPremulPS):r.append(s.outputAlphaOpaquePS),e.useMsdf&&r.append("    gl_FragColor = applyMsdf(gl_FragColor);"),r.append(s.outputPS),r.append(s.debugOutputPS),b&&n.prepend(s.lightDirPointPS),y&&n.prepend(s.falloffLinearPS),x&&n.prepend(s.falloffInvSquaredPS),w&&n.prepend(s.spotPS),S&&!e.clusteredLightingEnabled&&n.prepend(s.cookiePS);let E="";const P=`void evaluateBackend(LitShaderArguments litShaderArgs) {\n${r.code}\n}`;n.append(P),a.append(s.debugProcessFrontendPS),a.append("    evaluateBackend(litShaderArgs);"),a.append("}\n");const M=i.code+n.code+a.code;M.includes("dTBN")&&(E+="mat3 dTBN;\n"),M.includes("dVertexNormalW")&&(E+="vec3 dVertexNormalW;\n"),M.includes("dTangentW")&&(E+="vec3 dTangentW;\n"),M.includes("dBinormalW")&&(E+="vec3 dBinormalW;\n"),M.includes("dViewDirW")&&(E+="vec3 dViewDirW;\n"),M.includes("dReflDirW")&&(E+="vec3 dReflDirW;\n"),M.includes("dHalfDirW")&&(E+="vec3 dHalfDirW;\n"),M.includes("ccReflDirW")&&(E+="vec3 ccReflDirW;\n"),M.includes("dLightDirNormW")&&(E+="vec3 dLightDirNormW;\n"),M.includes("dLightDirW")&&(E+="vec3 dLightDirW;\n"),M.includes("dLightPosW")&&(E+="vec3 dLightPosW;\n"),M.includes("dShadowCoord")&&(E+="vec3 dShadowCoord;\n"),M.includes("dReflection")&&(E+="vec4 dReflection;\n"),M.includes("dDiffuseLight")&&(E+="vec3 dDiffuseLight;\n"),M.includes("dSpecularLight")&&(E+="vec3 dSpecularLight;\n"),M.includes("dAtten")&&(E+="float dAtten;\n"),M.includes("dAttenD")&&(E+="float dAttenD;\n"),M.includes("dAtten3")&&(E+="vec3 dAtten3;\n"),M.includes("dMsdf")&&(E+="vec4 dMsdf;\n"),M.includes("ccFresnel")&&(E+="float ccFresnel;\n"),M.includes("ccReflection")&&(E+="vec3 ccReflection;\n"),M.includes("ccSpecularLight")&&(E+="vec3 ccSpecularLight;\n"),M.includes("ccSpecularityNoFres")&&(E+="float ccSpecularityNoFres;\n"),M.includes("sSpecularLight")&&(E+="vec3 sSpecularLight;\n"),M.includes("sReflection")&&(E+="vec3 sReflection;\n");return this._fsGetBeginCode()+this.varyings+this.varyingDefines+this._fsGetBaseCode()+(e.detailModes?s.detailModesPS:"")+E+this.frontendDecl+M}generateFragmentShader(t,e,s,i){const n=this.options;this.frontendDecl=t,this.frontendCode=e,this.frontendFunc=s,this.lightingUv=i,3===n.pass?this.fshader=this._fsGetPickPassCode():2===n.pass?this.fshader=this._fsGetDepthPassCode():this.shadowPass?this.fshader=this._fsGetShadowPassCode():n.customFragmentShader?this.fshader=this._fsGetBeginCode()+n.customFragmentShader:this.fshader=this._fsGetLitPassCode()}getDefinition(){const t=cs.createDefinition(this.device,{name:"LitShader",attributes:this.attributes,vertexCode:this.vshader,fragmentCode:this.fshader});return this.options.isForwardPass&&(t.tag=1),t}}class _a{constructor(){this.hasTangents=!1,this.chunks={},this._pass=0,this._isForwardPass=!1,this.alphaTest=!1,this.forceFragmentPrecision=null,this.blendType=3,this.separateAmbient=!1,this.screenSpace=!1,this.skin=!1,this.useInstancing=!1,this.useMorphPosition=!1,this.useMorphNormal=!1,this.useMorphTextureBased=!1,this.nineSlicedMode=0,this.clusteredLightingEnabled=!0,this.clusteredLightingCookiesEnabled=!1,this.clusteredLightingShadowsEnabled=!1,this.clusteredLightingShadowType=0,this.clusteredLightingAreaLightsEnabled=!1,this.vertexColors=!1,this.lightMapEnabled=!1,this.useLightMapVertexColors=!1,this.dirLightMapEnabled=!1,this.heightMapEnabled=!1,this.normalMapEnabled=!1,this.clearCoatNormalMapEnabled=!1,this.aoMapEnabled=!1,this.useAoVertexColors=!1,this.diffuseMapEnabled=!1,this.useAmbientTint=!1,this.customFragmentShader=null,this.pixelSnap=!1,this.useClearCoatNormalMap=!1,this.useDiffuseMap=!1,this.useAoMap=!1,this.detailModes=0,this.shadingModel=0,this.ambientSH=!1,this.fastTbn=!1,this.twoSidedLighting=!1,this.occludeSpecular=0,this.occludeSpecularFloat=!1,this.useMsdf=!1,this.msdfTextAttribute=0,this.alphaToCoverage=!1,this.opacityFadesSpecular=!1,this.cubeMapProjection=0,this.occludeDirect=!1,this.conserveEnergy=!1,this.useSpecular=!1,this.useSpecularityFactor=!1,this.useSpecularColor=!1,this.enableGGXSpecular=!1,this.fresnelModel=0,this.useRefraction=!1,this.useClearCoat=!1,this.useSheen=!1,this.useIridescence=!1,this.useMetalness=!1,this.useDynamicRefraction=!1,this.fog=Zs,this.gamma=0,this.toneMap=-1,this.fixSeams=!1,this.reflectionSource=null,this.reflectionEncoding=null,this.reflectionCubemapEncoding=null,this.ambientSource="constant",this.ambientEncoding=null,this.skyboxIntensity=1,this.useCubeMapRotation=!1,this.lightMapWithoutAmbient=!1,this.lights=[],this.noShadow=!1,this.lightMaskDynamic=0}set pass(t){}get pass(){return this._pass}set isForwardPass(t){}get isForwardPass(){return this._isForwardPass}}class va{constructor(){this._pass=0,this._isForwardPass=!1,this.chunks=[],this.forceUv1=!1,this.ambientTint=!1,this.diffuseTint=!1,this.specularTint=!1,this.metalnessTint=!1,this.glossTint=!1,this.emissiveTint=!1,this.opacityTint=!1,this.emissiveEncoding="linear",this.lightMapEncoding="linear",this.packedNormal=!1,this.glossInvert=!1,this.sheenGlossInvert=!1,this.clearCoatGlossInvert=!1,this.litOptions=new _a}set pass(t){this._pass=t,this.litOptions._pass=t}get pass(){return this._pass}set isForwardPass(t){this._isForwardPass=t,this.litOptions._isForwardPass=t}get isForwardPass(){return this._isForwardPass}}const ba=[],ya={optionsContext:new va,optionsContextMin:new va,generateKey:function(t){const e=function(t){const e=[];for(const s in t)t.hasOwnProperty(s)&&"chunks"!==s&&"lights"!==s&&e.push(s);return e.sort()};let s;t===this.optionsContextMin?(this.propsMin||(this.propsMin=e(t)),s=this.propsMin):t===this.optionsContext?(this.props||(this.props=e(t)),s=this.props):s=e(t);let i="standard";for(let e=0;e<s.length;e++)t[s[e]]&&(i+=s[e]+t[s[e]]);if(t.chunks){const e=[];for(const s in t.chunks)t.chunks.hasOwnProperty(s)&&e.push(s+t.chunks[s]);e.sort(),i+=e}if(t.litOptions)for(const e in t.litOptions)if("lights"===e){const e=t.litOptions.clusteredLightingEnabled;for(let s=0;s<t.litOptions.lights.length;s++){const n=t.litOptions.lights[s];e&&0!==n._type||(i+=n.key)}}else i+=e+t.litOptions[e];return le(i)},_getUvSourceExpression:function(t,e,s){const i=s[t],n=s[e],r=s.isForwardPass;let a;return r&&1===s.litOptions.nineSlicedMode||r&&2===s.litOptions.nineSlicedMode?a="nineSlicedUv":(a=0===i?"vUv"+n:"vUV"+n+"_"+i,s.heightMap&&"heightMapTransform"!==t&&(a+=" + dUvOffset")),a},_addMapDef:function(t,e){return e?`#define ${t}\n`:`#undef ${t}\n`},_addMapDefs:function(t,e,s,i,n){return this._addMapDef("MAPFLOAT",t)+this._addMapDef("MAPCOLOR",e)+this._addMapDef("MAPVERTEX",s)+this._addMapDef("MAPTEXTURE",i)+this._addMapDef("MAPINVERT",n)},_addMap:function(t,e,s,i,n,r=null){const a=t+"Map",o=a+"Uv",l=a+"Identifier",h=a+"Transform",c=a+"Channel",d=t+"VertexColorChannel",u=t+"VertexColor",p=t+"Mode",f=t+"Invert",m=s[t+"Tint"],g=s[u],_=s[a],v=s[l],b=s[p];let y=i[e];if(_){const t=this._getUvSourceExpression(h,o,s);if(y=y.replace(/\$UV/g,t).replace(/\$CH/g,s[c]),n&&-1!==y.search(/\$SAMPLER/g)){let t="texture_"+a;const e=n[v];e?t=e:n[v]=t,y=y.replace(/\$SAMPLER/g,t)}if(r&&(y="aaa"===s[c]?y.replace(/\$DECODE/g,"passThrough"):y.replace(/\$DECODE/g,$r.decodeFunc(s.litOptions.gamma||"srgb"!==r?r:"linear")),y.indexOf("$texture2DSAMPLE"))){const t={linear:"texture2D",srgb:"texture2DSRGB",rgbm:"texture2DRGBM",rgbe:"texture2DRGBE"};y=y.replace(/\$texture2DSAMPLE/g,t[r]||"texture2D")}}g&&(y=y.replace(/\$VC/g,s[d])),b&&(y=y.replace(/\$DETAILMODE/g,b));const x=!!(1&m),w=!!(2&m),S=!!s[f];return y=this._addMapDefs(x,w,g,_,S)+y,y.replace(/\$/g,"")},_correctChannel:function(t,e,s){if(s[t]>0){if(s[t]<e.length)return e.substring(0,s[t]);if(s[t]>e.length){let i=e;const n=i.charAt(i.length-1),r=s[t]-i.length;for(let t=0;t<r;t++)i+=n;return i}return e}},createShaderDefinition:function(t,e){const s=Ni.get(t).getByIndex(e.pass).isForward;e.isForwardPass=s;const i=new ga(t,e.litOptions),n=[],r=[],a=[],o={};for(const t in ba){const s=t+"Map";if(e[t+"VertexColor"]){const s=t+"VertexColorChannel";e[s]=this._correctChannel(t,e[s],ba)}if(e[s]){const i=s+"Channel",o=s+"Transform",l=s+"Uv";e[l]=Math.min(e[l],1),e[i]=this._correctChannel(t,e[i],ba);const h=e[l];n[h]=!0,r[h]=r[h]||e[s]&&!e[o],e[o]&&a.push({name:t,id:e[o],uv:e[l]})}}e.forceUv1&&(n[1]=!0,r[1]=void 0===r[1]||r[1]),i.generateVertexShader(n,r,a),0===e.litOptions.shadingModel?(e.litOptions.fresnelModel=0,e.litOptions.ambientSH=!1):e.litOptions.fresnelModel=0===e.litOptions.fresnelModel?2:e.litOptions.fresnelModel;const l=new pa,h=new pa,c=new pa,d=new pa;let u="";if(2===e.litOptions.nineSlicedMode?l.append("const float textureBias = -1000.0;"):l.append("uniform float textureBias;"),s){if(e.heightMap&&(l.append("vec2 dUvOffset;"),h.append(this._addMap("height","parallaxPS",e,i.chunks,o)),c.append("getParallax();")),3!==e.litOptions.blendType||e.litOptions.alphaTest||e.litOptions.alphaToCoverage?(l.append("float dAlpha;"),h.append(this._addMap("opacity","opacityPS",e,i.chunks,o)),c.append("getOpacity();"),d.append("_litShaderArgs.opacity = dAlpha;"),e.litOptions.alphaTest&&(h.append(i.chunks.alphaTestPS),c.append("alphaTest(dAlpha);"))):l.append("float dAlpha = 1.0;"),i.needsNormal){if((e.normalMap||e.clearCoatNormalMap)&&(h.append(e.packedNormal?i.chunks.normalXYPS:i.chunks.normalXYZPS),!e.litOptions.hasTangents)){const t=e.normalMap?"normalMap":"clearCoatNormalMap";u=this._getUvSourceExpression(`${t}Transform`,`${t}Uv`,e)}l.append("vec3 dNormalW;"),h.append(this._addMap("normalDetail","normalDetailMapPS",e,i.chunks,o)),h.append(this._addMap("normal","normalMapPS",e,i.chunks,o)),c.append("getNormal();"),d.append("_litShaderArgs.worldNormal = dNormalW;")}if(i.needsSceneColor&&l.append("uniform sampler2D uSceneColorMap;"),i.needsScreenSize&&l.append("uniform vec4 uScreenSize;"),i.needsTransforms&&(l.append("uniform mat4 matrix_viewProjection;"),l.append("uniform mat4 matrix_model;")),l.append("vec3 dAlbedo;"),e.diffuseDetail&&h.append(this._addMap("diffuseDetail","diffuseDetailMapPS",e,i.chunks,o,e.diffuseDetailEncoding)),h.append(this._addMap("diffuse","diffusePS",e,i.chunks,o,e.diffuseEncoding)),c.append("getAlbedo();"),d.append("_litShaderArgs.albedo = dAlbedo;"),e.litOptions.useRefraction&&(l.append("float dTransmission;"),h.append(this._addMap("refraction","transmissionPS",e,i.chunks,o)),c.append("getRefraction();"),d.append("_litShaderArgs.transmission = dTransmission;"),l.append("float dThickness;"),h.append(this._addMap("thickness","thicknessPS",e,i.chunks,o)),c.append("getThickness();"),d.append("_litShaderArgs.thickness = dThickness;")),e.litOptions.useIridescence&&(l.append("float dIridescence;"),h.append(this._addMap("iridescence","iridescencePS",e,i.chunks,o)),c.append("getIridescence();"),d.append("_litShaderArgs.iridescence.intensity = dIridescence;"),l.append("float dIridescenceThickness;"),h.append(this._addMap("iridescenceThickness","iridescenceThicknessPS",e,i.chunks,o)),c.append("getIridescenceThickness();"),d.append("_litShaderArgs.iridescence.thickness = dIridescenceThickness;")),i.lighting&&e.litOptions.useSpecular||i.reflections?(l.append("vec3 dSpecularity;"),l.append("float dGlossiness;"),e.litOptions.useSheen&&(l.append("vec3 sSpecularity;"),h.append(this._addMap("sheen","sheenPS",e,i.chunks,o,e.sheenEncoding)),c.append("getSheen();"),d.append("_litShaderArgs.sheen.specularity = sSpecularity;"),l.append("float sGlossiness;"),h.append(this._addMap("sheenGloss","sheenGlossPS",e,i.chunks,o)),c.append("getSheenGlossiness();"),d.append("_litShaderArgs.sheen.gloss = sGlossiness;")),e.litOptions.useMetalness&&(l.append("float dMetalness;"),h.append(this._addMap("metalness","metalnessPS",e,i.chunks,o)),c.append("getMetalness();"),d.append("_litShaderArgs.metalness = dMetalness;")),e.litOptions.useSpecularityFactor&&(l.append("float dSpecularityFactor;"),h.append(this._addMap("specularityFactor","specularityFactorPS",e,i.chunks,o)),c.append("getSpecularityFactor();"),d.append("_litShaderArgs.specularityFactor = dSpecularityFactor;")),e.litOptions.useSpecularColor?h.append(this._addMap("specular","specularPS",e,i.chunks,o,e.specularEncoding)):h.append("void getSpecularity() { dSpecularity = vec3(1); }"),h.append(this._addMap("gloss","glossPS",e,i.chunks,o)),c.append("getGlossiness();"),c.append("getSpecularity();"),d.append("_litShaderArgs.specularity = dSpecularity;"),d.append("_litShaderArgs.gloss = dGlossiness;")):(l.append("vec3 dSpecularity = vec3(0.0);"),l.append("float dGlossiness = 0.0;")),e.aoDetail&&h.append(this._addMap("aoDetail","aoDetailMapPS",e,i.chunks,o)),(e.aoMap||e.aoVertexColor)&&(l.append("float dAo;"),h.append(this._addMap("ao","aoPS",e,i.chunks,o)),c.append("getAO();"),d.append("_litShaderArgs.ao = dAo;")),l.append("vec3 dEmission;"),h.append(this._addMap("emissive","emissivePS",e,i.chunks,o,e.emissiveEncoding)),c.append("getEmission();"),d.append("_litShaderArgs.emission = dEmission;"),e.litOptions.useClearCoat&&(l.append("float ccSpecularity;"),l.append("float ccGlossiness;"),l.append("vec3 ccNormalW;"),h.append(this._addMap("clearCoat","clearCoatPS",e,i.chunks,o)),h.append(this._addMap("clearCoatGloss","clearCoatGlossPS",e,i.chunks,o)),h.append(this._addMap("clearCoatNormal","clearCoatNormalPS",e,i.chunks,o)),c.append("getClearCoat();"),c.append("getClearCoatGlossiness();"),c.append("getClearCoatNormal();"),d.append("_litShaderArgs.clearcoat.specularity = ccSpecularity;"),d.append("_litShaderArgs.clearcoat.gloss = ccGlossiness;"),d.append("_litShaderArgs.clearcoat.worldNormal = ccNormalW;")),e.lightMap||e.lightVertexColor){const t=e.dirLightMap&&e.litOptions.useSpecular,s=t?"lightmapDirPS":"lightmapSinglePS";l.append("vec3 dLightmap;"),t&&l.append("vec3 dLightmapDir;"),h.append(this._addMap("light",s,e,i.chunks,o,e.lightMapEncoding)),c.append("getLightMap();"),d.append("_litShaderArgs.lightmap = dLightmap;"),t&&d.append("_litShaderArgs.lightmapDir = dLightmapDir;")}-1===h.code.indexOf("texture2DSRGB")&&-1===h.code.indexOf("texture2DRGBM")&&-1===h.code.indexOf("texture2DRGBE")||h.prepend(i.chunks.textureSamplePS)}else e.litOptions.alphaTest&&(l.append("float dAlpha;"),h.append(this._addMap("opacity","opacityPS",e,i.chunks,o)),h.append(i.chunks.alphaTestPS),c.append("getOpacity();"),c.append("alphaTest(dAlpha);"),d.append("_litShaderArgs.opacity = dAlpha;"));l.append(i.chunks.litShaderArgsPS),h.append(`LitShaderArguments evaluateFrontend() { LitShaderArguments _litShaderArgs; \n${c.code}\n${d.code}\n return _litShaderArgs;\n }\n`),c.code="LitShaderArguments litShaderArgs = evaluateFrontend();";for(const t in o)l.append(`uniform sampler2D ${o[t]};`);return c.code=`\n${c.code.split("\n").map((t=>`    ${t}`)).join("\n")}\n\n`,i.generateFragmentShader(l.code,h.code,c.code,u),i.getDefinition()}},xa=(t,e)=>{if(t.length!==e.length)return!1;for(let s=0;s<t.length;++s)if(t[s]!==e[s])return!1;return!0},wa=t=>1!==t.r||1!==t.g||1!==t.b;class Sa{constructor(){this._mapXForms=null}updateMinRef(t,e,s,i,n,r,a){this._updateSharedOptions(t,e,s,i,r),this._updateMinOptions(t,s),this._updateUVOptions(t,s,i,!0),t.litOptions.chunks=t.chunks}updateRef(t,e,s,i,n,r,a){this._updateSharedOptions(t,e,s,i,r),this._updateEnvOptions(t,s,e),this._updateMaterialOptions(t,s),1===r&&(t.litOptions.gamma&&(t.litOptions.gamma=3),t.litOptions.toneMap=0),t.litOptions.hasTangents=i&&0!=(512&i),this._updateLightOptions(t,e,s,i,a,n),this._updateUVOptions(t,s,i,!1),t.litOptions.chunks=t.chunks}_updateSharedOptions(t,e,s,i,n){t.forceUv1=s.forceUv1,t.chunks=s.chunks||"",t.pass=n,t.litOptions.alphaTest=s.alphaTest>0,t.litOptions.forceFragmentPrecision=s.forceFragmentPrecision||"",t.litOptions.blendType=s.blendType,t.litOptions.separateAmbient=!1,t.litOptions.screenSpace=i&&0!=(i&ei),t.litOptions.skin=i&&0!=(2&i),t.litOptions.useInstancing=i&&0!=(32&i),t.litOptions.useMorphPosition=i&&0!=(i&si),t.litOptions.useMorphNormal=i&&0!=(i&ii),t.litOptions.useMorphTextureBased=i&&0!=(i&ni),t.litOptions.nineSlicedMode=s.nineSlicedMode||0,e.clusteredLightingEnabled&&s.useLighting?(t.litOptions.clusteredLightingEnabled=!0,t.litOptions.clusteredLightingCookiesEnabled=e.lighting.cookiesEnabled,t.litOptions.clusteredLightingShadowsEnabled=e.lighting.shadowsEnabled,t.litOptions.clusteredLightingShadowType=e.lighting.shadowType,t.litOptions.clusteredLightingAreaLightsEnabled=e.lighting.areaLightsEnabled):(t.litOptions.clusteredLightingEnabled=!1,t.litOptions.clusteredLightingCookiesEnabled=!1,t.litOptions.clusteredLightingShadowsEnabled=!1,t.litOptions.clusteredLightingAreaLightsEnabled=!1)}_updateUVOptions(t,e,s,i){let n=!1,r=!1,a=!1;s&&(n=0!=(4&s),r=0!=(8&s),a=0!=(16&s)),t.litOptions.vertexColors=!1,this._mapXForms=[];const o={};for(const s in ba)this._updateTexOptions(t,e,s,n,r,a,i,o);this._mapXForms=null,t.litOptions.lightMapEnabled=t.lightMap,t.litOptions.useLightMapVertexColors=t.lightVertexColor,t.litOptions.dirLightMapEnabled=t.dirLightMap,t.litOptions.heightMapEnabled=t.heightMap,t.litOptions.normalMapEnabled=t.normalMap,t.litOptions.clearCoatNormalMapEnabled=t.clearCoatNormalMap,t.litOptions.aoMapEnabled=t.aoMap,t.litOptions.useAoVertexColors=t.aoVertexColor,t.litOptions.diffuseMapEnabled=t.diffuseMap}_updateTexOptions(t,e,s,i,n,r,a,o){const l=s+"Map",h=s+"VertexColor",c=s+"VertexColorChannel",d=l+"Channel",u=l+"Transform",p=l+"Uv",f=l+"Identifier";"light"!==s&&(t[l]=!1,t[f]=void 0,t[d]="",t[u]=0,t[p]=0),t[h]=!1,t[c]="";const m="opacity"===s;if((!m||3!==e.blendType||0!==e.alphaTest||e.alphaToCoverage)&&(!a||m)&&("height"!==s&&e[h]&&r&&(t[h]=e[h],t[c]=e[c],t.litOptions.vertexColors=!0),e[l])){let r=!0;if(0!==e[p]||i||(r=!1),1!==e[p]||n||(r=!1),r){const i=e[l].id;let n=o[i];void 0===n&&(o[i]=s,n=s),t[l]=!!e[l],t[f]=n,t[u]=this._getMapTransformID(e.getUniform(u),e[p]),t[d]=e[d],t[p]=e[p]}}}_updateMinOptions(t,e){t.opacityTint=1!==e.opacity&&3!==e.blendType,t.litOptions.lights=[]}_updateMaterialOptions(t,e){var s,i,n,r;const a=(e.diffuseTint||!e.diffuseMap&&!e.diffuseVertexColor)&&wa(e.diffuse),o=!!(e.useMetalness||e.specularMap||e.sphereMap||e.cubeMap||(l=e.specular,0!==l.r||0!==l.g||0!==l.b)||e.specularityFactor>0&&e.useMetalness||e.enableGGXSpecular||e.clearCoat>0);var l;const h=!e.useMetalness||e.useMetalnessSpecularColor,c=o&&(e.specularTint||!e.specularMap&&!e.specularVertexColor)&&wa(e.specular),d=o&&e.useMetalnessSpecularColor&&(e.specularityFactorTint||e.specularityFactor<1&&!e.specularityFactorMap),u=!e.emissiveMap||wa(e.emissive)&&e.emissiveTint,p=1!==e.emissiveIntensity,f=!!e.normalMap&&(10===e.normalMap.format||e.normalMap.type===It);t.opacityTint=1!==e.opacity&&3!==e.blendType?1:0,t.ambientTint=e.ambientTint,t.diffuseTint=a?2:0,t.specularTint=c?2:0,t.specularityFactorTint=d?1:0,t.metalnessTint=e.useMetalness&&e.metalness<1?1:0,t.glossTint=1,t.emissiveTint=(u?2:0)+(p?1:0),t.diffuseEncoding=null==(s=e.diffuseMap)?void 0:s.encoding,t.diffuseDetailEncoding=null==(i=e.diffuseDetailMap)?void 0:i.encoding,t.emissiveEncoding=null==(n=e.emissiveMap)?void 0:n.encoding,t.lightMapEncoding=null==(r=e.lightMap)?void 0:r.encoding,t.packedNormal=f,t.refractionTint=1!==e.refraction?1:0,t.refractionIndexTint=e.refractionIndex!==1/1.5?1:0,t.thicknessTint=e.useDynamicRefraction&&1!==e.thickness?1:0,t.specularEncoding=e.specularEncoding||"linear",t.sheenEncoding=e.sheenEncoding||"linear",t.aoMapUv=e.aoUvSet,t.aoDetail=!!e.aoMap,t.diffuseDetail=!!e.diffuseMap,t.normalDetail=!!e.normalMap,t.diffuseDetailMode=e.diffuseDetailMode,t.aoDetailMode=e.aoDetailMode,t.clearCoatTint=1!==e.clearCoat?1:0,t.clearCoatGloss=!!e.clearCoatGloss,t.clearCoatGlossTint=1!==e.clearCoatGloss?1:0,t.iridescenceTint=1!==e.iridescence?1:0,t.sheenTint=e.useSheen&&wa(e.sheen)?2:0,t.sheenGlossTint=1,t.glossInvert=e.glossInvert,t.sheenGlossInvert=e.sheenGlossInvert,t.clearCoatGlossInvert=e.clearCoatGlossInvert,t.litOptions.useAmbientTint=t.ambientTint,t.litOptions.customFragmentShader=e.customFragmentShader,t.litOptions.pixelSnap=e.pixelSnap,t.litOptions.useClearCoatNormalMap=!!e.clearCoatNormalMap,t.litOptions.useDiffuseMap=!!e.diffuseMap,t.litOptions.useAoMap=!!e.aoMap,t.litOptions.detailModes=!!t.diffuseDetail||!!t.aoDetail,t.litOptions.shadingModel=e.shadingModel,t.litOptions.ambientSH=!!e.ambientSH,t.litOptions.fastTbn=e.fastTbn,t.litOptions.twoSidedLighting=e.twoSidedLighting,t.litOptions.occludeSpecular=e.occludeSpecular,t.litOptions.occludeSpecularFloat=1!==e.occludeSpecularIntensity,t.litOptions.useMsdf=!!e.msdfMap,t.litOptions.msdfTextAttribute=!!e.msdfTextAttribute,t.litOptions.alphaToCoverage=e.alphaToCoverage,t.litOptions.opacityFadesSpecular=e.opacityFadesSpecular,t.litOptions.cubeMapProjection=e.cubeMapProjection,t.litOptions.occludeDirect=e.occludeDirect,t.litOptions.conserveEnergy=e.conserveEnergy&&0!==e.shadingModel,t.litOptions.useSpecular=o,t.litOptions.useSpecularityFactor=(d||!!e.specularityFactorMap)&&e.useMetalnessSpecularColor,t.litOptions.useSpecularColor=h,t.litOptions.enableGGXSpecular=e.enableGGXSpecular,t.litOptions.fresnelModel=e.fresnelModel,t.litOptions.useRefraction=(e.refraction||!!e.refractionMap)&&(e.useDynamicRefraction||!!t.litOptions.reflectionSource),t.litOptions.useClearCoat=!!e.clearCoat,t.litOptions.useSheen=e.useSheen,t.litOptions.useIridescence=e.useIridescence&&0!==e.iridescence,t.litOptions.useMetalness=e.useMetalness,t.litOptions.useDynamicRefraction=e.useDynamicRefraction}_updateEnvOptions(t,e,s){t.litOptions.fog=e.useFog?s.fog:"none",t.litOptions.gamma=e.useGammaTonemap?s.gammaCorrection:0,t.litOptions.toneMap=e.useGammaTonemap?s.toneMapping:-1,t.litOptions.fixSeams=!!e.cubeMap&&e.cubeMap.fixCubemapSeams;const i=0===e.shadingModel;let n=!1;if(e.envAtlas&&e.cubeMap&&!i?(t.litOptions.reflectionSource="envAtlasHQ",t.litOptions.reflectionEncoding=e.envAtlas.encoding,t.litOptions.reflectionCubemapEncoding=e.cubeMap.encoding):e.envAtlas&&!i?(t.litOptions.reflectionSource="envAtlas",t.litOptions.reflectionEncoding=e.envAtlas.encoding):e.cubeMap?(t.litOptions.reflectionSource="cubeMap",t.litOptions.reflectionEncoding=e.cubeMap.encoding):e.sphereMap?(t.litOptions.reflectionSource="sphereMap",t.litOptions.reflectionEncoding=e.sphereMap.encoding):e.useSkybox&&s.envAtlas&&s.skybox&&!i?(t.litOptions.reflectionSource="envAtlasHQ",t.litOptions.reflectionEncoding=s.envAtlas.encoding,t.litOptions.reflectionCubemapEncoding=s.skybox.encoding,n=!0):e.useSkybox&&s.envAtlas&&!i?(t.litOptions.reflectionSource="envAtlas",t.litOptions.reflectionEncoding=s.envAtlas.encoding,n=!0):e.useSkybox&&s.skybox?(t.litOptions.reflectionSource="cubeMap",t.litOptions.reflectionEncoding=s.skybox.encoding,n=!0):(t.litOptions.reflectionSource=null,t.litOptions.reflectionEncoding=null),e.ambientSH&&!i)t.litOptions.ambientSource="ambientSH",t.litOptions.ambientEncoding=null;else{const n=e.envAtlas||(e.useSkybox&&s.envAtlas?s.envAtlas:null);n&&!i?(t.litOptions.ambientSource="envAtlas",t.litOptions.ambientEncoding=n.encoding):(t.litOptions.ambientSource="constant",t.litOptions.ambientEncoding=null)}t.litOptions.skyboxIntensity=n&&(1!==s.skyboxIntensity||s.physicalUnits),t.litOptions.useCubeMapRotation=n&&s._skyboxRotationShaderInclude}_updateLightOptions(t,e,s,i,n,r){if(t.lightMap=!1,t.lightMapChannel="",t.lightMapUv=0,t.lightMapTransform=0,t.litOptions.lightMapWithoutAmbient=!1,t.dirLightMap=!1,i&&(t.litOptions.noShadow=0!=(1&i),0!=(64&i)&&(t.lightMapEncoding=7===e.lightmapPixelFormat?"rgbm":"linear",t.lightMap=!0,t.lightMapChannel="rgb",t.lightMapUv=1,t.lightMapTransform=0,t.litOptions.lightMapWithoutAmbient=!s.lightMap,0!=(128&i)&&(t.dirLightMap=!0),0!=(i&ri)&&(t.litOptions.lightMapWithoutAmbient=!1))),s.useLighting){const e=[],s=i?i>>16:1;t.litOptions.lightMaskDynamic=!!(1&s),n&&(this._collectLights(0,n[0],e,s),this._collectLights(1,n[1],e,s,r),this._collectLights(2,n[2],e,s,r)),t.litOptions.lights=e}else t.litOptions.lights=[];0===t.litOptions.lights.length&&(t.litOptions.noShadow=!0)}_collectLights(t,e,s,i,n){for(let n=0;n<e.length;n++){const r=e[n];if(r.enabled&&r.mask&i){if(0!==t&&r.isStatic)continue;s.push(r)}}if(n)for(let e=0;e<n.length;e++){const i=n[e];i._type===t&&s.push(i)}}_getMapTransformID(t,e){if(!t)return 0;let s=this._mapXForms[e];s||(s=[],this._mapXForms[e]=s);for(let e=0;e<s.length;e++)if(xa(s[e][0].value,t[0].value)&&xa(s[e][1].value,t[1].value))return e+1;return s.push(t)}}function Ca(t,e=!0,s=!0){const i={};return i[`${t}Map`]="texture",i[`${t}MapTiling`]="vec2",i[`${t}MapOffset`]="vec2",i[`${t}MapRotation`]="number",i[`${t}MapUv`]="number",e&&(i[`${t}MapChannel`]="string",s&&(i[`${t}VertexColor`]="boolean",i[`${t}VertexColorChannel`]="string")),i}const Ta=$t({name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",ambientTint:"boolean"},Ca("ao"),Ca("aoDetail",!0,!1),{aoDetailMode:"string",diffuse:"rgb",diffuseTint:"boolean"},Ca("diffuse"),Ca("diffuseDetail",!0,!1),{diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean"},Ca("specular"),{occludeSpecular:"enum:occludeSpecular",specularityFactor:"number",specularityFactorTint:"boolean"},Ca("specularityFactor"),{useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",anisotropy:"number",metalnessTint:"boolean"},Ca("metalness"),{useMetalnessSpecularColor:"boolean",conserveEnergy:"boolean",shininess:"number",gloss:"number",glossInvert:"boolean"},Ca("gloss"),{clearCoat:"number"},Ca("clearCoat"),{clearCoatGloss:"number",clearCoatGlossInvert:"boolean"},Ca("clearCoatGloss"),{clearCoatBumpiness:"number"},Ca("clearCoatNormal",!1),{useSheen:"boolean",sheen:"rgb",sheenTint:"boolean"},Ca("sheen"),{sheenGloss:"number",sheenGlossTint:"boolean",sheenGlossInvert:"boolean"},Ca("sheenGloss"),{fresnelModel:"number",emissive:"rgb",emissiveTint:"boolean"},Ca("emissive"),{emissiveIntensity:"number"},Ca("normal",!1),{bumpiness:"number"},Ca("normalDetail",!1),{normalDetailMapBumpiness:"number"},Ca("height",!0,!1),{heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",alphaFade:"number",opacity:"number"},Ca("opacity"),{opacityFadesSpecular:"boolean",reflectivity:"number",refraction:"number",refractionTint:"boolean"},Ca("refraction"),{refractionIndex:"number",thickness:"number",thicknessTint:"boolean"},Ca("thickness"),{attenuation:"rgb",attenuationDistance:"number",useDynamicRefraction:"boolean",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",useIridescence:"boolean",iridescence:"number",iridescenceTint:"boolean"},Ca("iridescence"),{iridescenceThicknessTint:"boolean",iridescenceThicknessMin:"number",iridescenceThicknessMax:"number",iridescenceRefractionIndex:"number"},Ca("iridescenceThickness"),Ca("light"),{depthTest:"boolean",depthFunc:"enum:depthFunc",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",shadingModel:"enum:shadingModel",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useGammaTonemap:"boolean",envAtlas:"texture",twoSidedLighting:"boolean"}),Ea=[];for(const t in Ta){"texture"===Ta[t]&&Ea.push(t)}const Pa=[];for(const t in Ta){"cubemap"===Ta[t]&&Pa.push(t)}const Ma={},Aa={};let ka=new Set;class Da extends Ki{constructor(){super(),this._dirtyShader=!0,this._assetReferences={},this._activeParams=new Set,this._activeLightingParams=new Set,this.shaderOptBuilder=new Sa,this.reset()}reset(){Object.keys(Ma).forEach((t=>{this[`_${t}`]=Ma[t].value()})),this._chunks={},this._uniformCache={}}set shader(t){}get shader(){return null}set chunks(t){this._dirtyShader=!0,this._chunks=t}get chunks(){return this._dirtyShader=!0,this._chunks}copy(t){super.copy(t),Object.keys(Ma).forEach((e=>{this[e]=t[e]}));for(const e in t._chunks)t._chunks.hasOwnProperty(e)&&(this._chunks[e]=t._chunks[e]);return this}_setParameter(t,e){ka.add(t),this.setParameter(t,e)}_setParameters(t){t.forEach((t=>{this._setParameter(t.name,t.value)}))}_processParameters(t){const e=this[t];e.forEach((t=>{ka.has(t)||delete this.parameters[t]})),this[t]=ka,ka=e,ka.clear()}_updateMap(t){const e=t+"Map",s=this[e];if(s){this._setParameter("texture_"+e,s);const t=e+"Transform",i=this.getUniform(t);i&&this._setParameters(i)}}_allocUniform(t,e){let s=this._uniformCache[t];return s||(s=e(),this._uniformCache[t]=s),s}getUniform(t,e,s){return Aa[t](this,e,s)}updateUniforms(t,e){const s=s=>this.getUniform(s,t,e);if(this._setParameter("material_ambient",s("ambient")),this.diffuseMap&&!this.diffuseTint||this._setParameter("material_diffuse",s("diffuse")),this.useMetalness)if((!this.metalnessMap||this.metalness<1)&&this._setParameter("material_metalness",this.metalness),this.specularMap&&!this.specularTint||this._setParameter("material_specular",s("specular")),this.specularityFactorMap&&!this.specularityFactorTint||this._setParameter("material_specularityFactor",this.specularityFactor),this.sheenMap&&!this.sheenTint||this._setParameter("material_sheen",s("sheen")),this.sheenGlossMap&&!this.sheenGlossTint||this._setParameter("material_sheenGloss",this.sheenGloss),0===this.refractionIndex)this._setParameter("material_f0",1);else if(this.refractionIndex!==1/1.5){const t=1/this.refractionIndex,e=(t-1)/(t+1);this._setParameter("material_f0",e*e)}else this._setParameter("material_f0",.04);else this.specularMap&&!this.specularTint||this._setParameter("material_specular",s("specular"));this.enableGGXSpecular&&this._setParameter("material_anisotropy",this.anisotropy),this.clearCoat>0&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGloss",this.clearCoatGloss),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness)),this._setParameter("material_gloss",s("gloss")),this.emissiveMap&&!this.emissiveTint||this._setParameter("material_emissive",s("emissive")),1!==this.emissiveIntensity&&this._setParameter("material_emissiveIntensity",this.emissiveIntensity),this.refraction>0&&(this._setParameter("material_refraction",this.refraction),this._setParameter("material_refractionIndex",this.refractionIndex)),this.useDynamicRefraction&&(this._setParameter("material_thickness",this.thickness),this._setParameter("material_attenuation",s("attenuation")),this._setParameter("material_invAttenuationDistance",0===this.attenuationDistance?0:1/this.attenuationDistance)),this.useIridescence&&(this._setParameter("material_iridescence",this.iridescence),this._setParameter("material_iridescenceRefractionIndex",this.iridescenceRefractionIndex),this._setParameter("material_iridescenceThicknessMin",this.iridescenceThicknessMin),this._setParameter("material_iridescenceThicknessMax",this.iridescenceThicknessMax)),this._setParameter("material_opacity",this.opacity),!1===this.opacityFadesSpecular&&this._setParameter("material_alphaFade",this.alphaFade),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),1===this.cubeMapProjection&&this._setParameter(s("cubeMapProjectionBox"));for(const t in ba)this._updateMap(t);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&this._setParameter("material_heightMapFactor",s("heightMapFactor"));const i=0===this.shadingModel;this.envAtlas&&this.cubeMap&&!i?(this._setParameter("texture_envAtlas",this.envAtlas),this._setParameter("texture_cubeMap",this.cubeMap)):this.envAtlas&&!i?this._setParameter("texture_envAtlas",this.envAtlas):this.cubeMap?this._setParameter("texture_cubeMap",this.cubeMap):this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this._setParameter("material_reflectivity",this.reflectivity),this._processParameters("_activeParams"),this._dirtyShader&&this.clearVariants()}updateEnvUniforms(t,e){const s=0===this.shadingModel;!(this.envAtlas&&!s||this.cubeMap||this.sphereMap)&&this.useSkybox&&(e.envAtlas&&e.skybox&&!s?(this._setParameter("texture_envAtlas",e.envAtlas),this._setParameter("texture_cubeMap",e.skybox)):e.envAtlas&&!s?this._setParameter("texture_envAtlas",e.envAtlas):e.skybox&&this._setParameter("texture_cubeMap",e.skybox)),this._processParameters("_activeLightingParams")}getShaderVariant(t,e,s,i,n,r,a,o,l){this.updateEnvUniforms(t,e);const h=Ni.get(t).getByIndex(n),c=2===n||3===n||h.isShadowPass;let d=c?ya.optionsContextMin:ya.optionsContext;c?this.shaderOptBuilder.updateMinRef(d,e,this,s,i,n,r):this.shaderOptBuilder.updateRef(d,e,this,s,i,n,r),this.onUpdateShader&&(d=this.onUpdateShader(d));const u=new Si(a,o,l),p=Mi(t);p.register("standard",ya);const f=p.getProgram("standard",d,u);return this._dirtyShader=!1,f}destroy(){for(const t in this._assetReferences)this._assetReferences[t]._unbind();this._assetReferences=null,super.destroy()}}Da.TEXTURE_PARAMETERS=Ea,Da.CUBEMAP_PARAMETERS=Pa;const Ra=(t,e)=>{Aa[t]=e},La=(t,e,s,i)=>{Object.defineProperty(Da.prototype,t,{get:i||function(){return this[`_${t}`]},set:s}),Ma[t]={value:e}},Ia=t=>{const e=`_${t.name}`,s=t.dirtyShaderFunc||(()=>!0);La(t.name,(()=>t.defaultValue),(function(t){const i=this[e];i!==t&&(this._dirtyShader=this._dirtyShader||s(i,t),this[e]=t)}),t.getterFunc)},Oa=t=>{const e=`_${t.name}`,s=t.dirtyShaderFunc||(()=>!0);La(t.name,(()=>t.defaultValue.clone()),(function(t){const i=this[e];i.equals(t)||(this._dirtyShader=this._dirtyShader||s(i,t),this[e]=i.copy(t))}),t.getterFunc)},Fa=t=>t.defaultValue&&t.defaultValue.clone?Oa(t):Ia(t);function Ba(t,e="rgb",s=!0,i=0){ba[t]=e.length||-1,Fa({name:`${t}Map`,defaultValue:null,dirtyShaderFunc:(t,e)=>!!t!=!!e||t&&(t.type!==e.type||t.fixCubemapSeams!==e.fixCubemapSeams||t.format!==e.format)}),Fa({name:`${t}MapTiling`,defaultValue:new I(1,1)}),Fa({name:`${t}MapOffset`,defaultValue:new I(0,0)}),Fa({name:`${t}MapRotation`,defaultValue:0}),Fa({name:`${t}MapUv`,defaultValue:i}),e&&(Fa({name:`${t}MapChannel`,defaultValue:e}),s&&(Fa({name:`${t}VertexColor`,defaultValue:!1}),Fa({name:`${t}VertexColorChannel`,defaultValue:e})));const n=`${t}MapTiling`,r=`${t}MapOffset`,a=`${t}MapRotation`,o=`${t}MapTransform`;Ra(o,((t,e,s)=>{const i=t[n],l=t[r],h=t[a];if(1===i.x&&1===i.y&&0===l.x&&0===l.y&&0===h)return null;const c=t._allocUniform(o,(()=>[{name:`texture_${o}0`,value:new Float32Array(3)},{name:`texture_${o}1`,value:new Float32Array(3)}])),d=Math.cos(h*k.DEG_TO_RAD),u=Math.sin(h*k.DEG_TO_RAD),p=c[0].value;p[0]=d*i.x,p[1]=-u*i.y,p[2]=l.x;const f=c[1].value;return f[0]=u*i.x,f[1]=d*i.y,f[2]=1-i.y-l.y,c}))}function za(t,e){Fa({name:t,defaultValue:e,getterFunc:function(){return this._dirtyShader=!0,this[`_${t}`]}}),Ra(t,((e,s,i)=>{const n=e._allocUniform(t,(()=>new Float32Array(3))),r=e[t];return e.useGammaTonemap&&i.gammaCorrection?(n[0]=Math.pow(r.r,2.2),n[1]=Math.pow(r.g,2.2),n[2]=Math.pow(r.b,2.2)):(n[0]=r.r,n[1]=r.g,n[2]=r.b),n}))}function Na(t,e,s){Fa({name:t,defaultValue:e,dirtyShaderFunc:(t,e)=>(0===t||1===t)!=(0===e||1===e)}),Ra(t,s)}function Ua(t,e){Fa({name:t,defaultValue:null,dirtyShaderFunc:(t,e)=>!!t==!!e}),Ra(t,e)}function Va(t,e){Fa({name:t,defaultValue:e})}let Ha,Ga,Wa,ja;!function(){za("ambient",new D(.7,.7,.7)),za("diffuse",new D(1,1,1)),za("specular",new D(0,0,0)),za("emissive",new D(0,0,0)),za("sheen",new D(1,1,1)),za("attenuation",new D(1,1,1)),Na("emissiveIntensity",1),Na("specularityFactor",1),Na("sheenGloss",0),Na("gloss",.25,((t,e,s)=>0===t.shadingModel?Math.pow(2,11*t.gloss):t.gloss)),Na("heightMapFactor",1,((t,e,s)=>.025*t.heightMapFactor)),Na("opacity",1),Na("alphaFade",1),Na("alphaTest",0),Na("bumpiness",1),Na("normalDetailMapBumpiness",1),Na("reflectivity",1),Na("occludeSpecularIntensity",1),Na("refraction",0),Na("refractionIndex",1/1.5),Na("thickness",0),Na("attenuationDistance",0),Na("metalness",1),Na("anisotropy",0),Na("clearCoat",0),Na("clearCoatGloss",1),Na("clearCoatBumpiness",1),Na("aoUvSet",0,null),Na("iridescence",0),Na("iridescenceRefractionIndex",1/1.5),Na("iridescenceThicknessMin",0),Na("iridescenceThicknessMax",0),Ua("ambientSH"),Ua("cubeMapProjectionBox",((t,e,s)=>{const i=t._allocUniform("cubeMapProjectionBox",(()=>[{name:"envBoxMin",value:new Float32Array(3)},{name:"envBoxMax",value:new Float32Array(3)}])),n=t.cubeMapProjectionBox.getMin(),r=i[0].value;r[0]=n.x,r[1]=n.y,r[2]=n.z;const a=t.cubeMapProjectionBox.getMax(),o=i[1].value;return o[0]=a.x,o[1]=a.y,o[2]=a.z,i})),Va("ambientTint",!1),Va("diffuseTint",!1),Va("specularTint",!1),Va("specularityFactorTint",!1),Va("emissiveTint",!1),Va("fastTbn",!1),Va("useMetalness",!1),Va("useMetalnessSpecularColor",!1),Va("useSheen",!1),Va("enableGGXSpecular",!1),Va("occludeDirect",!1),Va("normalizeNormalMap",!0),Va("conserveEnergy",!0),Va("opacityFadesSpecular",!0),Va("occludeSpecular",1),Va("shadingModel",1),Va("fresnelModel",2),Va("useDynamicRefraction",!1),Va("cubeMapProjection",0),Va("customFragmentShader",null),Va("forceFragmentPrecision",null),Va("useFog",!0),Va("useLighting",!0),Va("useGammaTonemap",!0),Va("useSkybox",!0),Va("forceUv1",!1),Va("pixelSnap",!1),Va("twoSidedLighting",!1),Va("nineSlicedMode",void 0),Va("msdfTextAttribute",!1),Va("useIridescence",!1),Va("glossInvert",!1),Va("sheenGlossInvert",!1),Va("clearCoatGlossInvert",!1),Ba("diffuse"),Ba("specular"),Ba("emissive"),Ba("thickness","g"),Ba("specularityFactor","g"),Ba("normal",""),Ba("metalness","g"),Ba("gloss","g"),Ba("opacity","a"),Ba("refraction","g"),Ba("height","g",!1),Ba("ao","g"),Ba("light","rgb",!0,1),Ba("msdf",""),Ba("diffuseDetail","rgb",!1),Ba("normalDetail",""),Ba("aoDetail","g",!1),Ba("clearCoat","g"),Ba("clearCoatGloss","g"),Ba("clearCoatNormal",""),Ba("sheen","rgb"),Ba("sheenGloss","g"),Ba("iridescence","g"),Ba("iridescenceThickness","g"),Va("diffuseDetailMode","mul"),Va("aoDetailMode","mul"),Ua("cubeMap"),Ua("sphereMap"),Ua("envAtlas");const t=[null,null,null,null,null,null];La("prefilteredCubemaps",(()=>t.slice()),(function(t){const e=this._prefilteredCubemaps;t=t||[];let s=!1,i=!0;for(let n=0;n<6;++n){const r=t[n]||null;e[n]!==r&&(e[n]=r,s=!0),i=i&&!!e[n]}s&&(i?this.envAtlas=ua.generatePrefilteredAtlas(e,{target:this.envAtlas}):this.envAtlas&&(this.envAtlas.destroy(),this.envAtlas=null),this._dirtyShader=!0)}),(function(){return this._prefilteredCubemaps}))}();const qa=[null,function(t,e){return t.drawOrder-e.drawOrder},function(t,e){return Ha=t._key[0],Ga=e._key[0],Ha===Ga&&t.mesh&&e.mesh?e.mesh.id-t.mesh.id:Ga-Ha},function(t,e){return e.zdist-t.zdist},function(t,e){return t.zdist-e.zdist}];function Xa(t,e){return e.key-t.key}let $a=0;class Ka{constructor(){this.list=[],this.length=0,this.done=!1}}class Ya{constructor(){this.opaqueMeshInstances=[],this.transparentMeshInstances=[],this.shadowCasters=[],this.visibleOpaque=[],this.visibleTransparent=[]}prepare(t){this.visibleOpaque[t]||(this.visibleOpaque[t]=new Ka),this.visibleTransparent[t]||(this.visibleTransparent[t]=new Ka),this.visibleOpaque[t].done=!1,this.visibleTransparent[t].done=!1}delete(t){t<this.visibleOpaque.length&&this.visibleOpaque.splice(t,1),t<this.visibleTransparent.length&&this.visibleTransparent.splice(t,1)}}class Qa{constructor(t={}){var e,s,i,n,r;void 0!==t.id?(this.id=t.id,$a=Math.max(this.id+1,$a)):this.id=$a++,this.name=t.name,this._enabled=null==(e=t.enabled)||e,this._refCounter=this._enabled?1:0,this.opaqueSortMode=null!=(s=t.opaqueSortMode)?s:2,this.transparentSortMode=null!=(i=t.transparentSortMode)?i:3,t.renderTarget&&(this.renderTarget=t.renderTarget),this.shaderPass=null!=(n=t.shaderPass)?n:0,this.passThrough=null!=(r=t.passThrough)&&r,this._clearColorBuffer=!!t.clearColorBuffer,this._clearDepthBuffer=!!t.clearDepthBuffer,this._clearStencilBuffer=!!t.clearStencilBuffer,this.onPreCull=t.onPreCull,this.onPreRender=t.onPreRender,this.onPreRenderOpaque=t.onPreRenderOpaque,this.onPreRenderTransparent=t.onPreRenderTransparent,this.onPostCull=t.onPostCull,this.onPostRender=t.onPostRender,this.onPostRenderOpaque=t.onPostRenderOpaque,this.onPostRenderTransparent=t.onPostRenderTransparent,this.onDrawCall=t.onDrawCall,this.onEnable=t.onEnable,this.onDisable=t.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.layerReference=t.layerReference,this.instances=t.layerReference?t.layerReference.instances:new Ya,this.cullingMask=t.cullingMask?t.cullingMask:4294967295,this.opaqueMeshInstances=this.instances.opaqueMeshInstances,this.transparentMeshInstances=this.instances.transparentMeshInstances,this.shadowCasters=this.instances.shadowCasters,this.customSortCallback=null,this.customCalculateSortValues=null,this._lights=[],this._lightsSet=new Set,this._clusteredLightsSet=new Set,this._splitLights=[[],[],[]],this.cameras=[],this._dirty=!1,this._dirtyLights=!1,this._dirtyCameras=!1,this._lightHash=0,this._staticLightHash=0,this._needsStaticPrepare=!0,this._staticPrepareDone=!1,this._shaderVersion=-1,this._lightCube=null}get hasClusteredLights(){return this._clusteredLightsSet.size>0}set enabled(t){t!==this._enabled&&(this._enabled=t,t?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()))}get enabled(){return this._enabled}set clearColorBuffer(t){this._clearColorBuffer=t,this._dirtyCameras=!0}get clearColorBuffer(){return this._clearColorBuffer}set clearDepthBuffer(t){this._clearDepthBuffer=t,this._dirtyCameras=!0}get clearDepthBuffer(){return this._clearDepthBuffer}set clearStencilBuffer(t){this._clearStencilBuffer=t,this._dirtyCameras=!0}get clearStencilBuffer(){return this._clearStencilBuffer}get clusteredLightsSet(){return this._clusteredLightsSet}incrementCounter(){0===this._refCounter&&(this._enabled=!0,this.onEnable&&this.onEnable()),this._refCounter++}decrementCounter(){if(1===this._refCounter)this._enabled=!1,this.onDisable&&this.onDisable();else if(0===this._refCounter)return;this._refCounter--}addMeshInstances(t,e){const s=this._shaderVersion,i=this.shadowCasters;for(let n=0;n<t.length;n++){const r=t[n],a=r.material,o=3===a.blendType?this.opaqueMeshInstances:this.transparentMeshInstances;this.opaqueMeshInstances.indexOf(r)<0&&this.transparentMeshInstances.indexOf(r)<0&&o.push(r),!e&&r.castShadow&&i.indexOf(r)<0&&i.push(r),!this.passThrough&&s>=0&&a._shaderVersion!==s&&(a.getShaderVariant!==Ki.prototype.getShaderVariant&&a.clearVariants(),a._shaderVersion=s)}this.passThrough||(this._dirty=!0)}removeMeshInstanceFromArray(t,e){let s=-1,i=0;const n=e.length;for(let r=0;r<n;r++){const n=e[r];if(n===t){s=r,i=1;break}if(n._staticSource===t)s<0&&(s=r),i++;else if(s>=0)break}s>=0&&e.splice(s,i)}removeMeshInstances(t,e){const s=this.opaqueMeshInstances,i=this.transparentMeshInstances,n=this.shadowCasters;for(let r=0;r<t.length;r++){const a=t[r];if(this.removeMeshInstanceFromArray(a,s),this.removeMeshInstanceFromArray(a,i),!e){const t=n.indexOf(a);t>=0&&n.splice(t,1)}}this._dirty=!0}clearMeshInstances(t){(0!==this.opaqueMeshInstances.length||0!==this.transparentMeshInstances.length||!t&&0!==this.shadowCasters.length)&&(this.opaqueMeshInstances.length=0,this.transparentMeshInstances.length=0,t||(this.shadowCasters.length=0),this.passThrough||(this._dirty=!0))}addLight(t){const e=t.light;this._lightsSet.has(e)||(this._lightsSet.add(e),this._lights.push(e),this._dirtyLights=!0,this._generateLightHash()),0!==e.type&&this._clusteredLightsSet.add(e)}removeLight(t){const e=t.light;this._lightsSet.has(e)&&(this._lightsSet.delete(e),this._lights.splice(this._lights.indexOf(e),1),this._dirtyLights=!0,this._generateLightHash()),0!==e.type&&this._clusteredLightsSet.delete(e)}clearLights(){this._lightsSet.clear(),this._clusteredLightsSet.clear(),this._lights.length=0,this._dirtyLights=!0}addShadowCasters(t){const e=this.shadowCasters;for(let s=0;s<t.length;s++){const i=t[s];i.castShadow&&(e.indexOf(i)<0&&e.push(i))}this._dirtyLights=!0}removeShadowCasters(t){const e=this.shadowCasters;for(let s=0;s<t.length;s++){const i=e.indexOf(t[s]);i>=0&&e.splice(i,1)}this._dirtyLights=!0}_generateLightHash(){if(this._lights.length>0){this._lights.sort(Xa);let t="",e="";for(let s=0;s<this._lights.length;s++)this._lights[s].isStatic?e+=this._lights[s].key:t+=this._lights[s].key;0===t.length?this._lightHash=0:this._lightHash=le(t),0===e.length?this._staticLightHash=0:this._staticLightHash=le(e)}else this._lightHash=0,this._staticLightHash=0}addCamera(t){this.cameras.indexOf(t)>=0||(this.cameras.push(t),this._dirtyCameras=!0)}removeCamera(t){const e=this.cameras.indexOf(t);e>=0&&(this.cameras.splice(e,1),this._dirtyCameras=!0,this.instances.delete(e))}clearCameras(){this.cameras.length=0,this._dirtyCameras=!0}_calculateSortDistances(t,e,s,i){for(let n=0;n<e;n++){const e=t[n];if(e.command)continue;if(e.layer<=2)continue;if(e.calculateSortDistance){e.zdist=e.calculateSortDistance(e,s,i);continue}const r=e.aabb.center,a=r.x-s.x,o=r.y-s.y,l=r.z-s.z;e.zdist=a*i.x+o*i.y+l*i.z}}_sortVisible(t,e,s){const i=this.instances,n=t?this.transparentSortMode:this.opaqueSortMode;if(0===n)return;const r=t?i.visibleTransparent[s]:i.visibleOpaque[s];5===n?(Wa=e.getPosition(),ja=e.forward,this.customCalculateSortValues&&this.customCalculateSortValues(r.list,r.length,Wa,ja),r.list.length!==r.length&&(r.list.length=r.length),this.customSortCallback&&r.list.sort(this.customSortCallback)):(3!==n&&4!==n||(Wa=e.getPosition(),ja=e.forward,this._calculateSortDistances(r.list,r.length,Wa,ja)),r.list.length!==r.length&&(r.list.length=r.length),r.list.sort(qa[n]))}}const Ja=["uSceneDepthMap","uDepthMap"],Za=["uSceneColorMap","texture_grabPass"];class to{constructor(t,e){this.scene=e,this.device=t,this.layer=null,this.device.webgl2||this.device.isWebGPU?this.initMainPath():this.initFallbackPath()}static requiresRenderPass(t,e){return!t.webgl2&&!t.isWebGPU&&e.renderSceneDepthMap}setupUniform(t,e,s){(e?Ja:Za).forEach((e=>t.scope.resolve(e).setValue(s)))}allocateTexture(t,e,s,i,n,r){return new Ue(t,{name:s,format:i,width:e?e.colorBuffer.width:t.width,height:e?e.colorBuffer.height:t.height,mipmaps:r,minFilter:n?0:r?5:1,magFilter:n?0:1,addressU:1,addressV:1})}getSourceColorFormat(t){var e;return null!=(e=null==t?void 0:t.format)?e:this.device.framebufferFormat}shouldReallocate(t,e,s){if(s){if((null==t?void 0:t.colorBuffer.format)!==this.getSourceColorFormat(e))return!0}const i=(null==e?void 0:e.width)||this.device.width,n=(null==e?void 0:e.height)||this.device.height;return!t||i!==t.width||n!==t.height}allocateRenderTarget(t,e,s,i,n,r,a){const o=a?Ja:Za,l=this.allocateTexture(s,e,o[0],i,n,r);return t?(t.destroyFrameBuffers(),n?t._depthBuffer=l:(t._colorBuffer=l,t._colorBuffers=[l])):t=new pe({name:"renderTargetSceneGrab",colorBuffer:n?null:l,depthBuffer:n?l:null,depth:!n,stencil:s.supportsStencil,autoResolve:!1}),t}releaseRenderTarget(t){t&&(t.destroyTextureBuffers(),t.destroy())}initMainPath(){const t=this.device,e=this;this.layer=new Qa({enabled:!1,name:"Depth",id:1,onDisable:function(){e.releaseRenderTarget(this.depthRenderTarget),this.depthRenderTarget=null,e.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=null},onPreRenderOpaque:function(s){const i=this.cameras[s];if(i.renderSceneColorMap){var n;if(e.shouldReallocate(this.colorRenderTarget,null==(n=i.renderTarget)?void 0:n.colorBuffer,!0)){var r;e.releaseRenderTarget(this.colorRenderTarget);const s=e.getSourceColorFormat(null==(r=i.renderTarget)?void 0:r.colorBuffer);this.colorRenderTarget=e.allocateRenderTarget(this.colorRenderTarget,i.renderTarget,t,s,!1,!0,!1)}const s=this.colorRenderTarget.colorBuffer;t.isWebGPU?(t.copyRenderTarget(i.renderTarget,this.colorRenderTarget,!0,!1),t.mipmapRenderer.generate(this.colorRenderTarget.colorBuffer.impl)):(t.copyRenderTarget(t.renderTarget,this.colorRenderTarget,!0,!1),t.activeTexture(t.maxCombinedTextures-1),t.bindTexture(s),t.gl.generateMipmap(s.impl._glTarget)),e.setupUniform(t,!1,s)}var a;i.renderSceneDepthMap&&(e.shouldReallocate(this.depthRenderTarget,null==(a=i.renderTarget)?void 0:a.depthBuffer)&&(e.releaseRenderTarget(this.depthRenderTarget),this.depthRenderTarget=e.allocateRenderTarget(this.depthRenderTarget,i.renderTarget,t,17,!0,!1,!0)),t.copyRenderTarget(t.renderTarget,this.depthRenderTarget,!1,!0),e.setupUniform(t,!0,this.depthRenderTarget.depthBuffer))},onPostRenderOpaque:function(t){}})}initFallbackPath(){const t=this,e=this.device,s=this.scene;this.layer=new Qa({enabled:!1,name:"Depth",id:1,shaderPass:2,onEnable:function(){this.depthRenderTarget=new pe({name:"depthRenderTarget-webgl1",depth:!0,stencil:e.supportsStencil,autoResolve:!1,graphicsDevice:e}),this.renderTarget=this.depthRenderTarget},onDisable:function(){this.depthRenderTarget.destroyTextureBuffers(),this.renderTarget=null,t.releaseRenderTarget(this.colorRenderTarget),this.colorRenderTarget=null},onPostCull:function(i){const n=this.cameras[i];if(n.renderSceneDepthMap){var r,a,o;if(null==(r=this.depthRenderTarget)||!r.colorBuffer||t.shouldReallocate(this.depthRenderTarget,null==(a=n.renderTarget)?void 0:a.depthBuffer))null==(o=this.depthRenderTarget)||o.destroyTextureBuffers(),this.depthRenderTarget=t.allocateRenderTarget(this.depthRenderTarget,n.renderTarget,e,7,!1,!1,!0),this.renderTarget=this.depthRenderTarget;const l=this.instances.visibleOpaque[i],h=l.list,c=s.layers,d=c.subLayerEnabled,u=c.subLayerList,p=c.getLayerById(0).renderTarget;let f=0;const m=c.layerList;for(let t=0;t<m.length;t++){const e=m[t];if(e===this)break;if(e.renderTarget!==p||!e.enabled||!d[t])continue;const s=e.cameras.indexOf(n);if(s<0)continue;let i=u[t]?e.instances.visibleTransparent[s]:e.instances.visibleOpaque[s];const r=i.length;i=i.list;for(let t=0;t<r;t++){const e=i[t];e.material&&e.material.depthWrite&&!e._noDepthDrawGl1&&(h[f]=e,f++)}}l.length=f}},onPreRenderOpaque:function(s){const i=this.cameras[s];if(i.renderSceneColorMap){var n;if(t.shouldReallocate(this.colorRenderTarget,null==(n=i.renderTarget)?void 0:n.colorBuffer)){var r;t.releaseRenderTarget(this.colorRenderTarget);const s=t.getSourceColorFormat(null==(r=i.renderTarget)?void 0:r.colorBuffer);this.colorRenderTarget=t.allocateRenderTarget(this.colorRenderTarget,i.renderTarget,e,s,!1,!1,!1)}const s=this.colorRenderTarget._colorBuffer;s.impl._glTexture||s.impl.initialize(e,s),e.bindTexture(s);const a=e.gl;a.copyTexImage2D(a.TEXTURE_2D,0,s.impl._glFormat,0,0,s.width,s.height,0),s._needsUpload=!1,s._needsMipmapsUpload=!1,t.setupUniform(e,!1,s)}i.renderSceneDepthMap&&t.setupUniform(e,!0,this.depthRenderTarget.colorBuffer)},onDrawCall:function(){e.setBlendState(Zt.NOBLEND)},onPostRenderOpaque:function(t){if(this.cameras[t].renderSceneDepthMap){this.instances.visibleOpaque[t].length=0}}})}patch(t){t.onEnable=this.layer.onEnable,t.onDisable=this.layer.onDisable,t.onPreRenderOpaque=this.layer.onPreRenderOpaque,t.onPostRenderOpaque=this.layer.onPostRenderOpaque,t.shaderPass=this.layer.shaderPass,t.onPostCull=this.layer.onPostCull,t.onDrawCall=this.layer.onDrawCall}}const eo=new D(254/255,254/255,254/255,254/255),so={drawCalls:[],isNewMaterial:[],lightMaskChanged:[],clear:function(){this.drawCalls.length=0,this.isNewMaterial.length=0,this.lightMaskChanged.length=0}};class io extends Vr{constructor(t){super(t);const e=this.device;this._forwardDrawCalls=0,this._materialSwitches=0,this._depthMapTime=0,this._forwardTime=0,this._sortTime=0;const s=e.scope;this.fogColorId=s.resolve("fog_color"),this.fogStartId=s.resolve("fog_start"),this.fogEndId=s.resolve("fog_end"),this.fogDensityId=s.resolve("fog_density"),this.ambientId=s.resolve("light_globalAmbient"),this.skyboxIntensityId=s.resolve("skyboxIntensity"),this.cubeMapRotationMatrixId=s.resolve("cubeMapRotationMatrix"),this.pcssDiskSamplesId=s.resolve("pcssDiskSamples[0]"),this.pcssSphereSamplesId=s.resolve("pcssSphereSamples[0]"),this.lightColorId=[],this.lightDir=[],this.lightDirId=[],this.lightShadowMapId=[],this.lightShadowMatrixId=[],this.lightShadowParamsId=[],this.lightShadowIntensity=[],this.lightRadiusId=[],this.lightPos=[],this.lightPosId=[],this.lightWidth=[],this.lightWidthId=[],this.lightHeight=[],this.lightHeightId=[],this.lightInAngleId=[],this.lightOutAngleId=[],this.lightCookieId=[],this.lightCookieIntId=[],this.lightCookieMatrixId=[],this.lightCookieOffsetId=[],this.lightShadowSearchAreaId=[],this.lightCameraParamsId=[],this.shadowMatrixPaletteId=[],this.shadowCascadeDistancesId=[],this.shadowCascadeCountId=[],this.screenSizeId=s.resolve("uScreenSize"),this._screenSize=new Float32Array(4),this.fogColor=new Float32Array(3),this.ambientColor=new Float32Array(3),this.pcssDiskSamples=function(t){const e=[];for(let s=0;s<t;++s){const i=Math.sqrt(s+.5)/Math.sqrt(t);e.push(i)}return e}(16),this.pcssSphereSamples=function(t){const e=[];for(let s=0;s<t;s++){const i=s/t,n=Math.sqrt(1-i*i);e.push(n)}return e}(16)}destroy(){super.destroy()}dispatchGlobalLights(t){if(this.ambientColor[0]=t.ambientLight.r,this.ambientColor[1]=t.ambientLight.g,this.ambientColor[2]=t.ambientLight.b,t.gammaCorrection)for(let t=0;t<3;t++)this.ambientColor[t]=Math.pow(this.ambientColor[t],2.2);if(t.physicalUnits)for(let e=0;e<3;e++)this.ambientColor[e]*=t.ambientLuminance;this.ambientId.setValue(this.ambientColor),this.skyboxIntensityId.setValue(t.physicalUnits?t.skyboxLuminance:t.skyboxIntensity),this.cubeMapRotationMatrixId.setValue(t._skyboxRotationMat3.data)}_resolveLight(t,e){const s="light"+e;this.lightColorId[e]=t.resolve(s+"_color"),this.lightDir[e]=new Float32Array(3),this.lightDirId[e]=t.resolve(s+"_direction"),this.lightShadowMapId[e]=t.resolve(s+"_shadowMap"),this.lightShadowMatrixId[e]=t.resolve(s+"_shadowMatrix"),this.lightShadowParamsId[e]=t.resolve(s+"_shadowParams"),this.lightShadowIntensity[e]=t.resolve(s+"_shadowIntensity"),this.lightShadowSearchAreaId[e]=t.resolve(s+"_shadowSearchArea"),this.lightRadiusId[e]=t.resolve(s+"_radius"),this.lightPos[e]=new Float32Array(3),this.lightPosId[e]=t.resolve(s+"_position"),this.lightWidth[e]=new Float32Array(3),this.lightWidthId[e]=t.resolve(s+"_halfWidth"),this.lightHeight[e]=new Float32Array(3),this.lightHeightId[e]=t.resolve(s+"_halfHeight"),this.lightInAngleId[e]=t.resolve(s+"_innerConeAngle"),this.lightOutAngleId[e]=t.resolve(s+"_outerConeAngle"),this.lightCookieId[e]=t.resolve(s+"_cookie"),this.lightCookieIntId[e]=t.resolve(s+"_cookieIntensity"),this.lightCookieMatrixId[e]=t.resolve(s+"_cookieMatrix"),this.lightCookieOffsetId[e]=t.resolve(s+"_cookieOffset"),this.lightCameraParamsId[e]=t.resolve(s+"_cameraParams"),this.shadowMatrixPaletteId[e]=t.resolve(s+"_shadowMatrixPalette[0]"),this.shadowCascadeDistancesId[e]=t.resolve(s+"_shadowCascadeDistances[0]"),this.shadowCascadeCountId[e]=t.resolve(s+"_shadowCascadeCount")}setLTCDirectionalLight(t,e,s,i,n){this.lightPos[e][0]=i.x-s.x*n,this.lightPos[e][1]=i.y-s.y*n,this.lightPos[e][2]=i.z-s.z*n,this.lightPosId[e].setValue(this.lightPos[e]);const r=t.transformVector(new R(-.5,0,0));this.lightWidth[e][0]=r.x*n,this.lightWidth[e][1]=r.y*n,this.lightWidth[e][2]=r.z*n,this.lightWidthId[e].setValue(this.lightWidth[e]);const a=t.transformVector(new R(0,0,.5));this.lightHeight[e][0]=a.x*n,this.lightHeight[e][1]=a.y*n,this.lightHeight[e][2]=a.z*n,this.lightHeightId[e].setValue(this.lightHeight[e])}dispatchDirectLights(t,e,s,i){let n=0;const r=this.device.scope;for(let a=0;a<t.length;a++){if(!(t[a].mask&s))continue;const o=t[a],l=o._node.getWorldTransform();if(this.lightColorId[n]||this._resolveLight(r,n),this.lightColorId[n].setValue(e.gammaCorrection?o._linearFinalColor:o._finalColor),l.getY(o._direction).mulScalar(-1),o._direction.normalize(),this.lightDir[n][0]=o._direction.x,this.lightDir[n][1]=o._direction.y,this.lightDir[n][2]=o._direction.z,this.lightDirId[n].setValue(this.lightDir[n]),0!==o.shape&&this.setLTCDirectionalLight(l,n,o._direction,i._node.getPosition(),i.farClip),o.castShadows){const t=o.getRenderData(i,0),e=o._getUniformBiasValues(t);this.lightShadowMapId[n].setValue(t.shadowBuffer),this.lightShadowMatrixId[n].setValue(t.shadowMatrix.data),this.shadowMatrixPaletteId[n].setValue(o._shadowMatrixPalette),this.shadowCascadeDistancesId[n].setValue(o._shadowCascadeDistances),this.shadowCascadeCountId[n].setValue(o.numCascades),this.lightShadowIntensity[n].setValue(o.shadowIntensity);const s=1/(t.shadowCamera.renderTarget.width/o.penumbraSize);this.lightShadowSearchAreaId[n].setValue(s);const r=o._shadowCameraParams;r.length=4,r[0]=t.depthRangeCompensation,r[1]=t.shadowCamera._farClip,r[2]=t.shadowCamera._nearClip,r[3]=1,this.lightCameraParamsId[n].setValue(r);const a=o._shadowRenderParams;a.length=4,a[0]=o._shadowResolution,a[1]=e.normalBias,a[2]=e.bias,a[3]=0,this.lightShadowParamsId[n].setValue(a)}n++}return n}setLTCPositionalLight(t,e){const s=t.transformVector(new R(-.5,0,0));this.lightWidth[e][0]=s.x,this.lightWidth[e][1]=s.y,this.lightWidth[e][2]=s.z,this.lightWidthId[e].setValue(this.lightWidth[e]);const i=t.transformVector(new R(0,0,.5));this.lightHeight[e][0]=i.x,this.lightHeight[e][1]=i.y,this.lightHeight[e][2]=i.z,this.lightHeightId[e].setValue(this.lightHeight[e])}dispatchOmniLight(t,e,s,i){const n=s._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(e,i),this.lightRadiusId[i].setValue(s.attenuationEnd),this.lightColorId[i].setValue(t.gammaCorrection?s._linearFinalColor:s._finalColor),n.getTranslation(s._position),this.lightPos[i][0]=s._position.x,this.lightPos[i][1]=s._position.y,this.lightPos[i][2]=s._position.z,this.lightPosId[i].setValue(this.lightPos[i]),0!==s.shape&&this.setLTCPositionalLight(n,i),s.castShadows){const t=s.getRenderData(null,0);this.lightShadowMapId[i].setValue(t.shadowBuffer);const e=s._getUniformBiasValues(t),n=s._shadowRenderParams;n.length=4,n[0]=s._shadowResolution,n[1]=e.normalBias,n[2]=e.bias,n[3]=1/s.attenuationEnd,this.lightShadowParamsId[i].setValue(n),this.lightShadowIntensity[i].setValue(s.shadowIntensity);const r=1/(t.shadowCamera.renderTarget.width/s.penumbraSize);this.lightShadowSearchAreaId[i].setValue(r);const a=s._shadowCameraParams;a.length=4,a[0]=1,a[1]=t.shadowCamera._farClip,a[2]=t.shadowCamera._nearClip,a[3]=0,this.lightCameraParamsId[i].setValue(a)}s._cookie&&(this.lightCookieId[i].setValue(s._cookie),this.lightShadowMatrixId[i].setValue(n.data),this.lightCookieIntId[i].setValue(s.cookieIntensity))}dispatchSpotLight(t,e,s,i){const n=s._node.getWorldTransform();if(this.lightColorId[i]||this._resolveLight(e,i),this.lightInAngleId[i].setValue(s._innerConeAngleCos),this.lightOutAngleId[i].setValue(s._outerConeAngleCos),this.lightRadiusId[i].setValue(s.attenuationEnd),this.lightColorId[i].setValue(t.gammaCorrection?s._linearFinalColor:s._finalColor),n.getTranslation(s._position),this.lightPos[i][0]=s._position.x,this.lightPos[i][1]=s._position.y,this.lightPos[i][2]=s._position.z,this.lightPosId[i].setValue(this.lightPos[i]),0!==s.shape&&this.setLTCPositionalLight(n,i),n.getY(s._direction).mulScalar(-1),s._direction.normalize(),this.lightDir[i][0]=s._direction.x,this.lightDir[i][1]=s._direction.y,this.lightDir[i][2]=s._direction.z,this.lightDirId[i].setValue(this.lightDir[i]),s.castShadows){const t=s.getRenderData(null,0);this.lightShadowMapId[i].setValue(t.shadowBuffer),this.lightShadowMatrixId[i].setValue(t.shadowMatrix.data);const e=s._getUniformBiasValues(t),n=s._shadowRenderParams;n.length=4,n[0]=s._shadowResolution,n[1]=e.normalBias,n[2]=e.bias,n[3]=1/s.attenuationEnd,this.lightShadowParamsId[i].setValue(n),this.lightShadowIntensity[i].setValue(s.shadowIntensity);const r=1/(t.shadowCamera.renderTarget.width/s.penumbraSize),a=t.shadowCamera._fov*Math.PI/180,o=1/Math.tan(a/2);this.lightShadowSearchAreaId[i].setValue(r*o);const l=s._shadowCameraParams;l.length=4,l[0]=1,l[1]=t.shadowCamera._farClip,l[2]=t.shadowCamera._nearClip,l[3]=0,this.lightCameraParamsId[i].setValue(l)}if(s._cookie){if(!s.castShadows){const t=Bn.evalSpotCookieMatrix(s);this.lightShadowMatrixId[i].setValue(t.data)}this.lightCookieId[i].setValue(s._cookie),this.lightCookieIntId[i].setValue(s.cookieIntensity),s._cookieTransform&&(s._cookieTransformUniform[0]=s._cookieTransform.x,s._cookieTransformUniform[1]=s._cookieTransform.y,s._cookieTransformUniform[2]=s._cookieTransform.z,s._cookieTransformUniform[3]=s._cookieTransform.w,this.lightCookieMatrixId[i].setValue(s._cookieTransformUniform),s._cookieOffsetUniform[0]=s._cookieOffset.x,s._cookieOffsetUniform[1]=s._cookieOffset.y,this.lightCookieOffsetId[i].setValue(s._cookieOffsetUniform))}}dispatchLocalLights(t,e,s,i,n){let r=i;const a=this.device.scope,o=t[1],l=o.length;for(let t=0;t<l;t++){const i=o[t];i.mask&s&&(i.isStatic||(this.dispatchOmniLight(e,a,i,r),r++))}let h=0;if(n){let t=n[h];for(;t&&1===t._type;)this.dispatchOmniLight(e,a,t,r),r++,h++,t=n[h]}const c=t[2],d=c.length;for(let t=0;t<d;t++){const i=c[t];i.mask&s&&(i.isStatic||(this.dispatchSpotLight(e,a,i,r),r++))}if(n){let t=n[h];for(;t&&2===t._type;)this.dispatchSpotLight(e,a,t,r),r++,h++,t=n[h]}}renderForwardPrepareMaterials(t,e,s,i,n,r,a){const o=(t,e,s)=>{so.drawCalls.push(t),so.isNewMaterial.push(e),so.lightMaskChanged.push(s)};so.clear();const l=this.device,h=this.scene,c=r?r._lightHash:0;let d,u,p,f=null;for(let t=0;t<s;t++){const s=e[t];if(!n||!s.mask||n&s.mask)if(s.command)o(s,!1,!1);else{s.ensureMaterial(l);const t=s.material,e=s._shaderDefs,n=s.mask;if(t&&t===f&&e!==d&&(f=null),(s.isStatic||u)&&(f=null),t!==f&&(this._materialSwitches++,t._scene=h,t.dirty&&(t.updateUniforms(l,h),t.dirty=!1),t._dirtyBlend&&(h.layers._dirtyBlend=!0)),!s._shader[a]||s._shaderDefs!==e||s._lightHash!==c){if(s.isStatic)s.updatePassShader(h,a,s._staticLightList,i,this.viewUniformFormat,this.viewBindGroupFormat);else{const n=a+"_"+e+"_"+c;s._shader[a]=t.variants[n],s._shader[a]||(s.updatePassShader(h,a,null,i,this.viewUniformFormat,this.viewBindGroupFormat),t.variants[n]=s._shader[a])}s._lightHash=c}o(s,t!==f,!f||n!==p),f=t,d=e,p=n,u=s.isStatic}}return null==l.endShaderBatch||l.endShaderBatch(),so}renderForwardInternal(t,e,s,i,n,r){const a=this.device,o=this.scene,l=1<<i,h=r?-1:1,c=this.scene.clusteredLightingEnabled;let d=!1;const u=e.drawCalls.length;for(let r=0;r<u;r++){const m=e.drawCalls[r];if(m.command)m.command();else{var p,f;const g=e.isNewMaterial[r],_=e.lightMaskChanged[r],v=m.material,b=m.mask;if(g){const e=m._shader[i];if(!e.failed&&a.setShader(e),d=e.failed,d)break;if(v.setParameters(a),_){const e=this.dispatchDirectLights(s[0],o,b,t);c||this.dispatchLocalLights(s,o,b,e,m._staticLightList)}this.alphaTestId.setValue(v.alphaTest),a.setBlendState(v.blendState),a.setDepthState(v.depthState),a.setAlphaToCoverage(v.alphaToCoverage),v.depthBias||v.slopeDepthBias?(a.setDepthBias(!0),a.setDepthBiasValues(v.depthBias,v.slopeDepthBias)):a.setDepthBias(!1)}this.setupCullMode(t._cullFaces,h,m);const y=null!=(p=m.stencilFront)?p:v.stencilFront,x=null!=(f=m.stencilBack)?f:v.stencilBack;a.setStencilState(y,x);const w=m.mesh;m.setParameters(a,l),this.setVertexBuffers(a,w),this.setMorphing(a,m.morphInstance),this.setSkinning(a,m),this.setupMeshUniformBuffers(m,i);const S=m.renderStyle;if(a.setIndexBuffer(w.indexBuffer[S]),null==n||n(m,r),t.xr&&t.xr.session&&t.xr.views.length){const e=t.xr.views;for(let t=0;t<e.length;t++){const s=e[t];a.setViewport(s.viewport.x,s.viewport.y,s.viewport.z,s.viewport.w),this.projId.setValue(s.projMat.data),this.projSkyboxId.setValue(s.projMat.data),this.viewId.setValue(s.viewOffMat.data),this.viewInvId.setValue(s.viewInvOffMat.data),this.viewId3.setValue(s.viewMat3.data),this.viewProjId.setValue(s.projViewOffMat.data),this.viewPosId.setValue(s.position),0===t?this.drawInstance(a,m,w,S,!0):this.drawInstance2(a,m,w,S),this._forwardDrawCalls++}}else this.drawInstance(a,m,w,S,!0),this._forwardDrawCalls++;r<u-1&&!e.isNewMaterial[r+1]&&v.setParameters(a,m.parameters)}}}renderForward(t,e,s,i,n,r,a,o,l){const h=this.renderForwardPrepareMaterials(t,e,s,i,r,o,n);this.renderForwardInternal(t,h,i,n,a,l),so.clear()}setSceneConstants(){const t=this.scene;if(this.dispatchGlobalLights(t),t.fog!==Zs){if(this.fogColor[0]=t.fogColor.r,this.fogColor[1]=t.fogColor.g,this.fogColor[2]=t.fogColor.b,t.gammaCorrection)for(let t=0;t<3;t++)this.fogColor[t]=Math.pow(this.fogColor[t],2.2);this.fogColorId.setValue(this.fogColor),"linear"===t.fog?(this.fogStartId.setValue(t.fogStart),this.fogEndId.setValue(t.fogEnd)):this.fogDensityId.setValue(t.fogDensity)}const e=this.device;this._screenSize[0]=e.width,this._screenSize[1]=e.height,this._screenSize[2]=1/e.width,this._screenSize[3]=1/e.height,this.screenSizeId.setValue(this._screenSize),this.pcssDiskSamplesId.setValue(this.pcssDiskSamples),this.pcssSphereSamplesId.setValue(this.pcssSphereSamples)}updateLightStats(t,e){}buildFrameGraph(t,e){const s=this.scene.clusteredLightingEnabled;if(t.reset(),this.update(e),s){{const s=new wi(this.device,(()=>{this.scene.lighting.cookiesEnabled&&(this.renderCookies(e._splitLights[2]),this.renderCookies(e._splitLights[1]))}));s.requiresCubemaps=!1,t.addRenderPass(s)}{const s=new wi(this.device);if(s.requiresCubemaps=!1,t.addRenderPass(s),this.scene.lighting.shadowsEnabled){const t=e._splitLights;this._shadowRendererLocal.prepareClusteredRenderPass(s,t[2],t[1])}s.after=()=>{this.updateClusters(e)}}}else{const s=e._splitLights;this._shadowRendererLocal.buildNonClusteredRenderPasses(t,s[2],s[1])}let i=0,n=!0,r=null;const a=e._renderActions;for(let s=i;s<a.length;s++){const o=a[s],l=e.layerList[o.layerIndex],h=l.cameras[o.cameraIndex];if(!o.isLayerEnabled(e))continue;const c=1===l.id&&(h.renderSceneColorMap||h.renderSceneDepthMap);o.hasDirectionalShadowLights&&h&&this._shadowRendererDirectional.buildFrameGraph(t,o,h),n&&(n=!1,i=s,r=o.renderTarget);let d=s+1;for(;a[d]&&!a[d].isLayerEnabled(e);)d++;const u=a[d],p=!!u&&1===e.layerList[u.layerIndex].id&&(h.renderSceneColorMap||h.renderSceneDepthMap);if(!u||u.renderTarget!==r||u.hasDirectionalShadowLights||p||c){if(this.addMainRenderPass(t,e,r,i,s,c),o.triggerPostprocess&&null!=h&&h.onPostprocessing){const s=new wi(this.device,(()=>{this.renderPassPostprocessing(o,e)}));s.requiresCubemaps=!1,t.addRenderPass(s)}n=!0}}}addMainRenderPass(t,e,s,i,n,r){const a={start:i,end:n},o=new wi(this.device,(()=>{this.renderPassRenderActions(e,a)})),l=e._renderActions,h=l[i],c=l[n],d=e.layerList[h.layerIndex].cameras[h.cameraIndex];d&&(h.firstCameraUse&&d.onPreRender&&(o.before=()=>{d.onPreRender()}),c.lastCameraUse&&d.onPostRender&&(o.after=()=>{d.onPostRender()}));const u=r&&to.requiresRenderPass(this.device,d);(!r||u)&&(o.init(s),o.fullSizeClearRect=d.camera.fullSizeClearRect,u?(o.setClearColor(eo),o.setClearDepth(1)):o.fullSizeClearRect&&(h.clearColor&&o.setClearColor(d.camera.clearColor),h.clearDepth&&o.setClearDepth(d.camera.clearDepth),h.clearStencil&&o.setClearStencil(d.camera.clearStencil))),t.addRenderPass(o)}update(t){this.frameUpdate(),this.shadowRenderer.frameUpdate();const e=this.scene.clusteredLightingEnabled;this.scene._updateSky(this.device);const s=this.updateLayerComposition(t,e),i=0!=(2&s);this.updateLightStats(t,s),this.beginFrame(t,i),this.setSceneConstants(),this.cullComposition(t),this.gpuUpdate(t._meshInstances)}renderPassPostprocessing(t,e){e.layerList[t.layerIndex].cameras[t.cameraIndex].onPostprocessing()}renderPassRenderActions(t,e){const s=t._renderActions;for(let i=e.start;i<=e.end;i++)this.renderRenderAction(t,s[i],i===e.start)}renderRenderAction(t,e,s){const i=this.scene.clusteredLightingEnabled,n=this.device,r=e.layerIndex,a=t.layerList[r],o=t.subLayerList[r],l=e.cameraIndex,h=a.cameras[l];if(e.isLayerEnabled(t)){if(!o&&a.onPreRenderOpaque?a.onPreRenderOpaque(l):o&&a.onPreRenderTransparent&&a.onPreRenderTransparent(l),a._preRenderCalledForCameras&1<<l||(a.onPreRender&&a.onPreRender(l),a._preRenderCalledForCameras|=1<<l),h){var c,d,u;this.setupViewport(h.camera,e.renderTarget),s&&h.camera.fullSizeClearRect||this.clear(h.camera,e.clearColor,e.clearDepth,e.clearStencil),a._sortVisible(o,h.camera.node,l);const t=a.instances,r=o?t.visibleTransparent[l]:t.visibleOpaque[l];this.scene.immediate.onPreRenderLayer(a,r,o),i&&e.lightClusters&&(e.lightClusters.activate(this.lightTextureAtlas),this.clustersDebugRendered||this.scene.lighting.debugLayer!==a.id||(this.clustersDebugRendered=!0)),this.scene._activeCamera=h.camera;const p=this.setCameraUniforms(h.camera,e.renderTarget);n.supportsUniformBuffers&&this.setupViewUniformBuffers(e.viewBindGroups,this.viewUniformFormat,this.viewBindGroupFormat,p);const f=!!(h.camera._flipFaces^(null==e||null==(c=e.renderTarget)?void 0:c.flipY)),m=null!=(d=null==(u=h.camera.shaderPassInfo)?void 0:u.index)?d:a.shaderPass,g=this._forwardDrawCalls;this.renderForward(h.camera,r.list,r.length,a._splitLights,m,a.cullingMask,a.onDrawCall,a,f),a._forwardDrawCalls+=this._forwardDrawCalls-g,n.setBlendState(Zt.NOBLEND),n.setStencilState(null,null),n.setAlphaToCoverage(!1),n.setDepthBias(!1)}!o&&a.onPostRenderOpaque?a.onPostRenderOpaque(l):o&&a.onPostRenderTransparent&&a.onPostRenderTransparent(l),!a.onPostRender||a._postRenderCalledForCameras&1<<l||(a._postRenderCounter&=~(o?2:1),0===a._postRenderCounter&&(a.onPostRender(l),a._postRenderCalledForCameras|=1<<l,a._postRenderCounter=a._postRenderCounterMax))}}}const no=function(t,e){if(t.size!==e.size)return!1;for(const s of t)if(!e.has(s))return!1;return!0},ro=(t,e)=>t.priority-e.priority,ao=t=>t.sort(ro);class oo{constructor(){this.layerIndex=0,this.cameraIndex=0,this.camera=null,this.renderTarget=null,this.lightClusters=null,this.clearColor=!1,this.clearDepth=!1,this.clearStencil=!1,this.triggerPostprocess=!1,this.firstCameraUse=!1,this.lastCameraUse=!1,this.directionalLightsSet=new Set,this.directionalLights=[],this.directionalLightsIndices=[],this.viewBindGroups=[]}destroy(){this.viewBindGroups.forEach((t=>{t.defaultUniformBuffer.destroy(),t.destroy()})),this.viewBindGroups.length=0}get hasDirectionalShadowLights(){return this.directionalLights.length>0}reset(){this.lightClusters=null,this.directionalLightsSet.clear(),this.directionalLights.length=0,this.directionalLightsIndices.length=0}isLayerEnabled(t){return t.layerList[this.layerIndex].enabled&&t.subLayerEnabled[this.layerIndex]}collectDirectionalLights(t,e,s){this.directionalLightsSet.clear(),this.directionalLights.length=0,this.directionalLightsIndices.length=0;for(let i=0;i<e.length;i++){const n=e[i];if(n.castShadows)for(let e=0;e<t.length;e++)if(t[e]._splitLights[0].indexOf(n)>=0&&!this.directionalLightsSet.has(n)){this.directionalLightsSet.add(n),this.directionalLights.push(n);const t=s.indexOf(n);this.directionalLightsIndices.push(t)}}}}class lo{constructor(){this.shadowCastersSet=new Set,this.shadowCastersList=[]}clearShadowCasters(){this.shadowCastersSet.clear(),this.shadowCastersList.length=0}addShadowCasters(t){for(let e=0;e<t.length;e++){const s=t[e];this.shadowCastersSet.has(s)||(this.shadowCastersSet.add(s),this.shadowCastersList.push(s))}}}const ho=new Set,co=[];class uo extends h{constructor(t="Untitled"){super(),this.name=t,this.layerList=[],this.subLayerList=[],this.subLayerEnabled=[],this._opaqueOrder={},this._transparentOrder={},this._dirty=!1,this._dirtyBlend=!1,this._dirtyLights=!1,this._dirtyCameras=!1,this._meshInstances=[],this._meshInstancesSet=new Set,this._lights=[],this._lightsMap=new Map,this._lightCompositionData=[],this._splitLights=[[],[],[]],this.cameras=[],this._renderActions=[],this._worldClusters=[],this._emptyWorldClusters=null}destroy(){this._emptyWorldClusters&&(this._emptyWorldClusters.destroy(),this._emptyWorldClusters=null),this._worldClusters.forEach((t=>{t.destroy()})),this._worldClusters=null,this._renderActions.forEach((t=>t.destroy())),this._renderActions=null}getEmptyWorldClusters(t){return this._emptyWorldClusters||(this._emptyWorldClusters=new Qn(t),this._emptyWorldClusters.name="ClusterEmpty",this._emptyWorldClusters.update([],!1,null)),this._emptyWorldClusters}_splitLightsArray(t){const e=t._lights;t._splitLights[0].length=0,t._splitLights[1].length=0,t._splitLights[2].length=0;for(let s=0;s<e.length;s++){const i=e[s];i.enabled&&t._splitLights[i._type].push(i)}}_update(t,e=!1){const s=this.layerList.length;let i=0;if(!this._dirty||!this._dirtyLights||!this._dirtyCameras)for(let t=0;t<s;t++){const e=this.layerList[t];e._dirty&&(this._dirty=!0),e._dirtyLights&&(this._dirtyLights=!0),e._dirtyCameras&&(this._dirtyCameras=!0)}function n(t,e,s){let i=!1;const n=s.length;for(let r=0;r<n;r++){const n=s[r];if(!e.has(n)){e.add(n),t.push(n);const s=n.material;s&&s._dirtyBlend&&(i=!0,s._dirtyBlend=!1)}}return i}if(this._dirty){i|=1,this._meshInstances.length=0,this._meshInstancesSet.clear();for(let t=0;t<s;t++){const e=this.layerList[t];e.passThrough||(this._dirtyBlend=n(this._meshInstances,this._meshInstancesSet,e.opaqueMeshInstances)||this._dirtyBlend,this._dirtyBlend=n(this._meshInstances,this._meshInstancesSet,e.transparentMeshInstances)||this._dirtyBlend),e._dirty=!1}this._dirty=!1}function r(t,e,s){for(let n=0;n<e.length;){var i;(null==(i=e[n].material)?void 0:i.transparent)===s?(t.push(e[n]),e[n]=e[e.length-1],e.length--):n++}}if(this._dirtyBlend){i|=8;for(let t=0;t<s;t++){const e=this.layerList[t];e.passThrough||(r(e.opaqueMeshInstances,e.transparentMeshInstances,!1),r(e.transparentMeshInstances,e.opaqueMeshInstances,!0))}this._dirtyBlend=!1}if(this._dirtyLights&&(i|=2,this._dirtyLights=!1,this.updateLights()),i&&this.updateShadowCasters(),this._dirtyCameras||2&i){this._dirtyCameras=!1,i|=4,this.cameras.length=0;for(let t=0;t<s;t++){const e=this.layerList[t];e._dirtyCameras=!1;for(let t=0;t<e.cameras.length;t++){const s=e.cameras[t];this.cameras.indexOf(s)<0&&this.cameras.push(s)}}this.cameras.length>1&&ao(this.cameras);const t=[];let e=0;for(let i=0;i<this.cameras.length;i++){const n=this.cameras[i];t.length=0;let r=!0;const a=e;let o=null,l=!1;for(let i=0;i<s;i++){const s=this.layerList[i],a=this.subLayerEnabled[i];if(s&&a&&s.cameras.length>0&&n.layers.indexOf(s.id)>=0){t.push(s),l||s.id!==n.disablePostEffectsLayer||(l=!0,o&&(o.triggerPostprocess=!0));const a=s.cameras.indexOf(n);a>=0&&(o=this.addRenderAction(this._renderActions,e,s,i,a,r,l),e++,r=!1)}}a<e&&(this._renderActions[a].collectDirectionalLights(t,this._splitLights[0],this._lights),o.lastCameraUse=!0),!l&&o&&(o.triggerPostprocess=!0),n.renderTarget&&n.postEffectsEnabled&&this.propagateRenderTarget(a-1,n)}for(let t=e;t<this._renderActions.length;t++)this._renderActions[t].destroy();this._renderActions.length=e}return 7&i&&e&&this.allocateLightClusters(t),2&i&&this._logRenderActions(),i}updateShadowCasters(){const t=this._lights.length;for(let e=0;e<t;e++)this._lightCompositionData[e].clearShadowCasters();const e=this.layerList.length;for(let t=0;t<e;t++){const e=this.layerList[t];if(!ho.has(e)){ho.add(e);const t=e._lights;for(let s=0;s<t.length;s++)if(t[s].castShadows){const i=this._lightsMap.get(t[s]);this._lightCompositionData[i].addShadowCasters(e.shadowCasters)}}}ho.clear()}updateLights(){this._lights.length=0,this._lightsMap.clear();const t=this.layerList.length;for(let e=0;e<t;e++){const t=this.layerList[e];if(!ho.has(t)){ho.add(t);const e=t._lights;for(let t=0;t<e.length;t++){const s=e[t];let i=this._lightsMap.get(s);if(void 0===i){i=this._lights.length,this._lightsMap.set(s,i),this._lights.push(s);let t=this._lightCompositionData[i];t||(t=new lo,this._lightCompositionData[i]=t)}}}this._splitLightsArray(t),t._dirtyLights=!1}ho.clear(),this._splitLightsArray(this);const e=this._lights.length;this._lightCompositionData.length=e}findCompatibleCluster(t,e,s){for(let i=0;i<e;i++){const e=this._renderActions[i],n=this.layerList[e.layerIndex];if(e.lightClusters!==s){if(t===n)return e.lightClusters;if(e.lightClusters&&no(t._clusteredLightsSet,n._clusteredLightsSet))return e.lightClusters}}return null}allocateLightClusters(t){co.push(...this._worldClusters);const e=this.getEmptyWorldClusters(t);this._worldClusters.length=0;const s=this._renderActions.length;for(let i=0;i<s;i++){const s=this._renderActions[i],n=this.layerList[s.layerIndex];if(s.lightClusters=null,n.hasClusteredLights){if((this.subLayerList[s.layerIndex]?n.transparentMeshInstances:n.opaqueMeshInstances).length){let r=this.findCompatibleCluster(n,i,e);r||(co.length&&(r=co.pop()),r||(r=new Qn(t)),r.name="Cluster-"+this._worldClusters.length,this._worldClusters.push(r)),s.lightClusters=r}}s.lightClusters||(s.lightClusters=e)}co.forEach((t=>{t.destroy()})),co.length=0}addRenderAction(t,e,s,i,n,r,a){let o=t[e];o||(o=t[e]=new oo);let l=s.renderTarget;const h=s.cameras[n];h&&h.renderTarget&&1!==s.id&&(l=h.renderTarget);let c=!1;for(let s=e-1;s>=0;s--)if(t[s].camera===h&&t[s].renderTarget===l){c=!0;break}const d=r||!c;let u=!!d&&h.clearColorBuffer,p=!!d&&h.clearDepthBuffer,f=!!d&&h.clearStencilBuffer;return u||(u=s.clearColorBuffer),p||(p=s.clearDepthBuffer),f||(f=s.clearStencilBuffer),a&&h.postEffectsEnabled&&(l=null),o.reset(),o.triggerPostprocess=!1,o.layerIndex=i,o.cameraIndex=n,o.camera=h,o.renderTarget=l,o.clearColor=u,o.clearDepth=p,o.clearStencil=f,o.firstCameraUse=r,o.lastCameraUse=!1,o}propagateRenderTarget(t,e){for(let s=t;s>=0;s--){const t=this._renderActions[s],i=this.layerList[t.layerIndex];if(t.renderTarget&&1!==i.id)break;if(1===i.id)continue;const n=null==t?void 0:t.camera.camera;if(n&&(!e.camera.rect.equals(n.rect)||!e.camera.scissorRect.equals(n.scissorRect)))break;t.renderTarget=e.renderTarget}}_logRenderActions(){}_isLayerAdded(t){return this.layerList.indexOf(t)>=0}_isSublayerAdded(t,e){for(let s=0;s<this.layerList.length;s++)if(this.layerList[s]===t&&this.subLayerList[s]===e)return!0;return!1}push(t){this._isLayerAdded(t)||(this.layerList.push(t),this.layerList.push(t),this._opaqueOrder[t.id]=this.subLayerList.push(!1)-1,this._transparentOrder[t.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t))}insert(t,e){if(this._isLayerAdded(t))return;this.layerList.splice(e,0,t,t),this.subLayerList.splice(e,0,!1,!0);const s=this.layerList.length;this._updateOpaqueOrder(e,s-1),this._updateTransparentOrder(e,s-1),this.subLayerEnabled.splice(e,0,!0,!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t)}remove(t){let e=this.layerList.indexOf(t);for(delete this._opaqueOrder[e],delete this._transparentOrder[e];e>=0;)this.layerList.splice(e,1),this.subLayerList.splice(e,1),this.subLayerEnabled.splice(e,1),e=this.layerList.indexOf(t),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("remove",t);const s=this.layerList.length;this._updateOpaqueOrder(0,s-1),this._updateTransparentOrder(0,s-1)}pushOpaque(t){this._isSublayerAdded(t,!1)||(this.layerList.push(t),this._opaqueOrder[t.id]=this.subLayerList.push(!1)-1,this.subLayerEnabled.push(!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t))}insertOpaque(t,e){if(this._isSublayerAdded(t,!1))return;this.layerList.splice(e,0,t),this.subLayerList.splice(e,0,!1);const s=this.subLayerList.length;this._updateOpaqueOrder(e,s-1),this.subLayerEnabled.splice(e,0,!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t)}removeOpaque(t){for(let e=0,s=this.layerList.length;e<s;e++)if(this.layerList[e]===t&&!this.subLayerList[e])return this.layerList.splice(e,1),this.subLayerList.splice(e,1),s--,this._updateOpaqueOrder(e,s-1),this.subLayerEnabled.splice(e,1),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,void(this.layerList.indexOf(t)<0&&this.fire("remove",t))}pushTransparent(t){this._isSublayerAdded(t,!0)||(this.layerList.push(t),this._transparentOrder[t.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t))}insertTransparent(t,e){if(this._isSublayerAdded(t,!0))return;this.layerList.splice(e,0,t),this.subLayerList.splice(e,0,!0);const s=this.subLayerList.length;this._updateTransparentOrder(e,s-1),this.subLayerEnabled.splice(e,0,!0),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,this.fire("add",t)}removeTransparent(t){for(let e=0,s=this.layerList.length;e<s;e++)if(this.layerList[e]===t&&this.subLayerList[e])return this.layerList.splice(e,1),this.subLayerList.splice(e,1),s--,this._updateTransparentOrder(e,s-1),this.subLayerEnabled.splice(e,1),this._dirty=!0,this._dirtyLights=!0,this._dirtyCameras=!0,void(this.layerList.indexOf(t)<0&&this.fire("remove",t))}_getSublayerIndex(t,e){let s=this.layerList.indexOf(t);if(s<0)return-1;if(this.subLayerList[s]!==e){if(s=this.layerList.indexOf(t,s+1),s<0)return-1;if(this.subLayerList[s]!==e)return-1}return s}getOpaqueIndex(t){return this._getSublayerIndex(t,!1)}getTransparentIndex(t){return this._getSublayerIndex(t,!0)}getLayerById(t){for(let e=0;e<this.layerList.length;e++)if(this.layerList[e].id===t)return this.layerList[e];return null}getLayerByName(t){for(let e=0;e<this.layerList.length;e++)if(this.layerList[e].name===t)return this.layerList[e];return null}_updateOpaqueOrder(t,e){for(let s=t;s<=e;s++)!1===this.subLayerList[s]&&(this._opaqueOrder[this.layerList[s].id]=s)}_updateTransparentOrder(t,e){for(let s=t;s<=e;s++)!0===this.subLayerList[s]&&(this._transparentOrder[this.layerList[s].id]=s)}_sortLayersDescending(t,e,s){let i=-1,n=-1;for(let e=0,n=t.length;e<n;e++){const n=t[e];s.hasOwnProperty(n)&&(i=Math.max(i,s[n]))}for(let t=0,i=e.length;t<i;t++){const i=e[t];s.hasOwnProperty(i)&&(n=Math.max(n,s[i]))}return-1===i&&-1!==n?1:-1===n&&-1!==i?-1:n-i}sortTransparentLayers(t,e){return this._sortLayersDescending(t,e,this._transparentOrder)}sortOpaqueLayers(t,e){return this._sortLayersDescending(t,e,this._opaqueOrder)}}const po=new R,fo={bias:0,normalBias:0},mo={r:0,g:1,b:2,a:3},go={directional:0,omni:1,point:1,spot:2},_o=[[new O(0,0,1,1)],[new O(0,0,.5,.5),new O(0,.5,.5,.5)],[new O(0,0,.5,.5),new O(0,.5,.5,.5),new O(.5,0,.5,.5)],[new O(0,0,.5,.5),new O(0,.5,.5,.5),new O(.5,0,.5,.5),new O(.5,.5,.5,.5)]];let vo=0;class bo{constructor(t,e,s,i){this.light=i,this.camera=e,this.shadowCamera=Er.createShadowCamera(t,i._shadowType,i._type,s),this.shadowMatrix=new V,this.shadowViewport=new O(0,0,1,1),this.shadowScissor=new O(0,0,1,1),this.depthRangeCompensation=0,this.face=s,this.visibleCasters=[],this.viewBindGroups=[]}destroy(){this.viewBindGroups.forEach((t=>{t.defaultUniformBuffer.destroy(),t.destroy()})),this.viewBindGroups.length=0}get shadowBuffer(){const t=this.shadowCamera.renderTarget;if(t){const e=this.light;return 1===e._type?t.colorBuffer:e._isPcf&&e.device.supportsDepthShadow?t.depthBuffer:t.colorBuffer}return null}}class yo{constructor(t){this.device=t,this.id=vo++,this._type=0,this._color=new D(.8,.8,.8),this._intensity=1,this._affectSpecularity=!0,this._luminance=0,this._castShadows=!1,this._enabled=!1,this.mask=1,this.isStatic=!1,this.key=0,this.bakeDir=!0,this.bakeNumSamples=1,this.bakeArea=0,this.attenuationStart=10,this.attenuationEnd=10,this._falloffMode=0,this._shadowType=0,this._vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=!0,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieTransformSet=!1,this._cookieOffsetSet=!1,this._innerConeAngle=40,this._outerConeAngle=45,this.cascades=null,this._shadowMatrixPalette=null,this._shadowCascadeDistances=null,this.numCascades=1,this.cascadeDistribution=.5,this._shape=0,this._finalColor=new Float32Array([.8,.8,.8]);const e=Math.pow(this._finalColor[0],2.2);this._linearFinalColor=new Float32Array([e,e,e]),this._position=new R(0,0,0),this._direction=new R(0,0,0),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180),this._updateOuterAngle(this._outerConeAngle),this._usePhysicalUnits=void 0,this._shadowMap=null,this._shadowRenderParams=[],this._shadowCameraParams=[],this.shadowDistance=40,this._shadowResolution=1024,this.shadowBias=-5e-4,this.shadowIntensity=1,this._normalOffsetBias=0,this.shadowUpdateMode=2,this.shadowUpdateOverrides=null,this._penumbraSize=1,this._isVsm=!1,this._isPcf=!0,this._cookieMatrix=null,this._atlasViewport=null,this.atlasViewportAllocated=!1,this.atlasVersion=0,this.atlasSlotIndex=0,this.atlasSlotUpdated=!1,this._scene=null,this._node=null,this._renderData=[],this.visibleThisFrame=!1,this.maxScreenSize=0}destroy(){this._destroyShadowMap(),this.releaseRenderData(),this._renderData=null}releaseRenderData(){if(this._renderData){for(let t=0;t<this._renderData.length;t++)this._renderData[t].destroy();this._renderData.length=0}}set numCascades(t){this.cascades&&this.numCascades===t||(this.cascades=_o[t-1],this._shadowMatrixPalette=new Float32Array(64),this._shadowCascadeDistances=new Float32Array(4),this._destroyShadowMap(),this.updateKey())}get numCascades(){return this.cascades.length}set shadowMap(t){this._shadowMap!==t&&(this._destroyShadowMap(),this._shadowMap=t)}get shadowMap(){return this._shadowMap}get numShadowFaces(){const t=this._type;return 0===t?this.numCascades:1===t?6:1}set type(t){if(this._type===t)return;this._type=t,this._destroyShadowMap(),this.updateKey();const e=this._shadowType;this._shadowType=null,this.shadowUpdateOverrides=null,this.shadowType=e}get type(){return this._type}set shape(t){if(this._shape===t)return;this._shape=t,this._destroyShadowMap(),this.updateKey();const e=this._shadowType;this._shadowType=null,this.shadowType=e}get shape(){return this._shape}set usePhysicalUnits(t){this._usePhysicalUnits!==t&&(this._usePhysicalUnits=t,this._updateFinalColor())}get usePhysicalUnits(){return this._usePhysicalUnits}set shadowType(t){if(this._shadowType===t)return;const e=this.device;1===this._type&&0!==t&&6!==t&&(t=0);const s=e.supportsDepthShadow;4!==t||s||(t=0),3!==t||e.textureFloatRenderable||(t=2),2!==t||e.textureHalfFloatRenderable||(t=1),this._isVsm=t>=1&&t<=3,this._isPcf=5===t||0===t||4===t,this._shadowType=t,this._destroyShadowMap(),this.updateKey()}get shadowType(){return this._shadowType}set enabled(t){this._enabled!==t&&(this._enabled=t,this.layersDirty())}get enabled(){return this._enabled}set castShadows(t){this._castShadows!==t&&(this._castShadows=t,this._destroyShadowMap(),this.layersDirty(),this.updateKey())}get castShadows(){return this._castShadows&&4!==this.mask&&0!==this.mask}set shadowResolution(t){this._shadowResolution!==t&&(t=1===this._type?Math.min(t,this.device.maxCubeMapSize):Math.min(t,this.device.maxTextureSize),this._shadowResolution=t,this._destroyShadowMap())}get shadowResolution(){return this._shadowResolution}set vsmBlurSize(t){this._vsmBlurSize!==t&&(t%2==0&&t++,this._vsmBlurSize=t)}get vsmBlurSize(){return this._vsmBlurSize}set normalOffsetBias(t){this._normalOffsetBias!==t&&((!this._normalOffsetBias&&t||this._normalOffsetBias&&!t)&&this.updateKey(),this._normalOffsetBias=t)}get normalOffsetBias(){return this._normalOffsetBias}set falloffMode(t){this._falloffMode!==t&&(this._falloffMode=t,this.updateKey())}get falloffMode(){return this._falloffMode}set innerConeAngle(t){this._innerConeAngle!==t&&(this._innerConeAngle=t,this._innerConeAngleCos=Math.cos(t*Math.PI/180),this._usePhysicalUnits&&this._updateFinalColor())}get innerConeAngle(){return this._innerConeAngle}set outerConeAngle(t){this._outerConeAngle!==t&&(this._outerConeAngle=t,this._updateOuterAngle(t),this._usePhysicalUnits&&this._updateFinalColor())}get outerConeAngle(){return this._outerConeAngle}set penumbraSize(t){this._penumbraSize=t}get penumbraSize(){return this._penumbraSize}_updateOuterAngle(t){const e=t*Math.PI/180;this._outerConeAngleCos=Math.cos(e),this._outerConeAngleSin=Math.sin(e)}set intensity(t){this._intensity!==t&&(this._intensity=t,this._updateFinalColor())}get intensity(){return this._intensity}set affectSpecularity(t){0===this._type&&(this._affectSpecularity=t,this.updateKey())}get affectSpecularity(){return this._affectSpecularity}set luminance(t){this._luminance!==t&&(this._luminance=t,this._updateFinalColor())}get luminance(){return this._luminance}get cookieMatrix(){return this._cookieMatrix||(this._cookieMatrix=new V),this._cookieMatrix}get atlasViewport(){return this._atlasViewport||(this._atlasViewport=new O(0,0,1,1)),this._atlasViewport}set cookie(t){this._cookie!==t&&(this._cookie=t,this.updateKey())}get cookie(){return this._cookie}set cookieFalloff(t){this._cookieFalloff!==t&&(this._cookieFalloff=t,this.updateKey())}get cookieFalloff(){return this._cookieFalloff}set cookieChannel(t){if(this._cookieChannel!==t){if(t.length<3){const e=t.charAt(t.length-1),s=3-t.length;for(let i=0;i<s;i++)t+=e}this._cookieChannel=t,this.updateKey()}}get cookieChannel(){return this._cookieChannel}set cookieTransform(t){this._cookieTransform!==t&&(this._cookieTransform=t,this._cookieTransformSet=!!t,t&&!this._cookieOffset&&(this.cookieOffset=new I,this._cookieOffsetSet=!1),this.updateKey())}get cookieTransform(){return this._cookieTransform}set cookieOffset(t){if(this._cookieOffset===t)return;!(!this._cookieTransformSet&&!t)&&!t&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=t,this._cookieOffsetSet=!!t,t&&!this._cookieTransform&&(this.cookieTransform=new O(1,1,0,0),this._cookieTransformSet=!1),this.updateKey()}get cookieOffset(){return this._cookieOffset}beginFrame(){this.visibleThisFrame=0===this._type&&this._enabled,this.maxScreenSize=0,this.atlasViewportAllocated=!1,this.atlasSlotUpdated=!1}_destroyShadowMap(){if(this.releaseRenderData(),this._shadowMap&&(this._shadowMap.cached||this._shadowMap.destroy(),this._shadowMap=null),0===this.shadowUpdateMode&&(this.shadowUpdateMode=1),this.shadowUpdateOverrides)for(let t=0;t<this.shadowUpdateOverrides.length;t++)0===this.shadowUpdateOverrides[t]&&(this.shadowUpdateOverrides[t]=1)}getRenderData(t,e){for(let s=0;s<this._renderData.length;s++){const i=this._renderData[s];if(i.camera===t&&i.face===e)return i}const s=new bo(this.device,t,e,this);return this._renderData.push(s),s}clone(){const t=new yo(this.device);return t.type=this._type,t.setColor(this._color),t.intensity=this._intensity,t.affectSpecularity=this._affectSpecularity,t.luminance=this._luminance,t.castShadows=this.castShadows,t._enabled=this._enabled,t.attenuationStart=this.attenuationStart,t.attenuationEnd=this.attenuationEnd,t.falloffMode=this._falloffMode,t.shadowType=this._shadowType,t.vsmBlurSize=this._vsmBlurSize,t.vsmBlurMode=this.vsmBlurMode,t.vsmBias=this.vsmBias,t.penumbraSize=this.penumbraSize,t.shadowUpdateMode=this.shadowUpdateMode,t.mask=this.mask,this.shadowUpdateOverrides&&(t.shadowUpdateOverrides=this.shadowUpdateOverrides.slice()),t.innerConeAngle=this._innerConeAngle,t.outerConeAngle=this._outerConeAngle,t.numCascades=this.numCascades,t.cascadeDistribution=this.cascadeDistribution,t.shape=this._shape,t.shadowBias=this.shadowBias,t.normalOffsetBias=this._normalOffsetBias,t.shadowResolution=this._shadowResolution,t.shadowDistance=this.shadowDistance,t.shadowIntensity=this.shadowIntensity,t}static getLightUnitConversion(t,e=Math.PI/4,s=0){switch(t){case 2:{const t=Math.cos(e),i=Math.cos(s);return 2*Math.PI*(1-i+(i-t)/2)}case 1:return 4*Math.PI;case 0:return 1}}_getUniformBiasValues(t){const e=t.shadowCamera._farClip;switch(this._type){case 1:fo.bias=this.shadowBias,fo.normalBias=this._normalOffsetBias;break;case 2:this._isVsm?fo.bias=-2e-4:(fo.bias=20*this.shadowBias,!this.device.webgl2&&this.device.extStandardDerivatives&&(fo.bias*=-100)),fo.normalBias=this._isVsm?this.vsmBias/(this.attenuationEnd/7):this._normalOffsetBias;break;case 0:this._isVsm?fo.bias=-2e-4:(fo.bias=this.shadowBias/e*100,!this.device.webgl2&&this.device.extStandardDerivatives&&(fo.bias*=-100)),fo.normalBias=this._isVsm?this.vsmBias/(e/7):this._normalOffsetBias}return fo}getColor(){return this._color}getBoundingSphere(t){if(2===this._type){const e=this.attenuationEnd,s=this._outerConeAngle,i=this._outerConeAngleCos,n=this._node;po.copy(n.up),s>45?(t.radius=e*this._outerConeAngleSin,po.mulScalar(-e*i)):(t.radius=e/(2*i),po.mulScalar(-t.radius)),t.center.add2(n.getPosition(),po)}else 1===this._type&&(t.center=this._node.getPosition(),t.radius=this.attenuationEnd)}getBoundingBox(t){if(2===this._type){const e=this.attenuationEnd,s=this._outerConeAngle,i=this._node,n=Math.abs(Math.sin(s*k.DEG_TO_RAD)*e);t.center.set(0,.5*-e,0),t.halfExtents.set(n,.5*e,n),t.setFromTransformedAabb(t,i.getWorldTransform(),!0)}else 1===this._type&&(t.center.copy(this._node.getPosition()),t.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))}_updateFinalColor(){const t=this._color,e=t.r,s=t.g,i=t.b;let n=this._intensity;this._usePhysicalUnits&&(n=this._luminance/yo.getLightUnitConversion(this._type,this._outerConeAngle*k.DEG_TO_RAD,this._innerConeAngle*k.DEG_TO_RAD));const r=this._finalColor,a=this._linearFinalColor;r[0]=e*n,r[1]=s*n,r[2]=i*n,n>=1?(a[0]=Math.pow(e,2.2)*n,a[1]=Math.pow(s,2.2)*n,a[2]=Math.pow(i,2.2)*n):(a[0]=Math.pow(r[0],2.2),a[1]=Math.pow(r[1],2.2),a[2]=Math.pow(r[2],2.2))}setColor(){1===arguments.length?this._color.set(arguments[0].r,arguments[0].g,arguments[0].b):3===arguments.length&&this._color.set(arguments[0],arguments[1],arguments[2]),this._updateFinalColor()}layersDirty(){var t;null!=(t=this._scene)&&t.layers&&(this._scene.layers._dirtyLights=!0)}updateKey(){let t=this._type<<29|(this._castShadows?1:0)<<28|this._shadowType<<25|this._falloffMode<<23|(0!==this._normalOffsetBias?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|mo[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12|this._shape<<10|this.numCascades-1<<8|(this.affectSpecularity?1:0)<<7;3===this._cookieChannel.length&&(t|=mo[this._cookieChannel.charAt(1)]<<16,t|=mo[this._cookieChannel.charAt(2)]<<14),t!==this.key&&null!==this._scene&&this.layersDirty(),this.key=t}}class xo{constructor(t,e,s){this._areaLightsEnabled=!1,this._cells=new R(10,3,10),this._maxLightsPerCell=255,this._shadowsEnabled=!0,this._shadowType=0,this._shadowAtlasResolution=2048,this._cookiesEnabled=!1,this._cookieAtlasResolution=2048,this.debugLayer=void 0,this.atlasSplit=null,this._supportsAreaLights=t,this._maxTextureSize=e,this._dirtyLightsFnc=s}applySettings(t){this.shadowsEnabled=t.lightingShadowsEnabled,this.cookiesEnabled=t.lightingCookiesEnabled,this.areaLightsEnabled=t.lightingAreaLightsEnabled,this.shadowAtlasResolution=t.lightingShadowAtlasResolution,this.cookieAtlasResolution=t.lightingCookieAtlasResolution,this.maxLightsPerCell=t.lightingMaxLightsPerCell,this.shadowType=t.lightingShadowType,this.cell=new R(t.lightingCells)}set cells(t){this._cells.copy(t)}get cells(){return this._cells}set maxLightsPerCell(t){this._maxLightsPerCell=k.clamp(t,1,255)}get maxLightsPerCell(){return this._maxLightsPerCell}set cookieAtlasResolution(t){this._cookieAtlasResolution=k.clamp(t,32,this._maxTextureSize)}get cookieAtlasResolution(){return this._cookieAtlasResolution}set shadowAtlasResolution(t){this._shadowAtlasResolution=k.clamp(t,32,this._maxTextureSize)}get shadowAtlasResolution(){return this._shadowAtlasResolution}set shadowType(t){this._shadowType!==t&&(this._shadowType=t,this._dirtyLightsFnc())}get shadowType(){return this._shadowType}set cookiesEnabled(t){this._cookiesEnabled!==t&&(this._cookiesEnabled=t,this._dirtyLightsFnc())}get cookiesEnabled(){return this._cookiesEnabled}set areaLightsEnabled(t){this._supportsAreaLights&&this._areaLightsEnabled!==t&&(this._areaLightsEnabled=t,this._dirtyLightsFnc())}get areaLightsEnabled(){return this._areaLightsEnabled}set shadowsEnabled(t){this._shadowsEnabled!==t&&(this._shadowsEnabled=t,this._dirtyLightsFnc())}get shadowsEnabled(){return this._shadowsEnabled}}const wo=new Zt(!0,0,1,1);class So{constructor(t){this.morph=t,t.incRefCount(),this.device=t.device,this._weights=[],this._weightMap=new Map;for(let e=0;e<t._targets.length;e++){const s=t._targets[e];s.name&&this._weightMap.set(s.name,e),this.setWeight(e,s.defaultWeight)}if(this._activeTargets=[],t.useTextureMorph){this.shaderCache={},this.maxSubmitCount=this.device.maxTextures,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount);const e=(e,s)=>(this[s]=t._createTexture(e,t._renderTextureFormat),new pe({colorBuffer:this[s],depth:!1}));t.morphPositions&&(this.rtPositions=e("MorphRTPos","texturePositions")),t.morphNormals&&(this.rtNormals=e("MorphRTNrm","textureNormals")),this._textureParams=new Float32Array([t.morphTextureWidth,t.morphTextureHeight,1/t.morphTextureWidth,1/t.morphTextureHeight]);for(let t=0;t<this.maxSubmitCount;t++)this["morphBlendTex"+t]=this.device.scope.resolve("morphBlendTex"+t);this.morphFactor=this.device.scope.resolve("morphFactor[0]"),this.zeroTextures=!1}else this.maxSubmitCount=8,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount),this._shaderMorphWeightsA=new Float32Array(this._shaderMorphWeights.buffer,0,4),this._shaderMorphWeightsB=new Float32Array(this._shaderMorphWeights.buffer,16,4),this._activeVertexBuffers=new Array(this.maxSubmitCount)}destroy(){this.shader=null;const t=this.morph;t&&(this.morph=null,t.decRefCount(),t.refCount<1&&t.destroy()),this.rtPositions&&(this.rtPositions.destroy(),this.rtPositions=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.rtNormals&&(this.rtNormals.destroy(),this.rtNormals=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)}clone(){return new So(this.morph)}_getWeightIndex(t){if("string"==typeof t){return this._weightMap.get(t)}return t}getWeight(t){const e=this._getWeightIndex(t);return this._weights[e]}setWeight(t,e){const s=this._getWeightIndex(t);this._weights[s]=e,this._dirty=!0}_getFragmentShader(t){let e="";t>0&&(e+="varying vec2 uv0;\nuniform highp float morphFactor["+t+"];\n");for(let s=0;s<t;s++)e+="uniform highp sampler2D morphBlendTex"+s+";\n";e+="void main (void) {\n    highp vec4 color = vec4(0, 0, 0, 1);\n";for(let s=0;s<t;s++)e+="    color.xyz += morphFactor["+s+"] * texture2D(morphBlendTex"+s+", uv0).xyz;\n";return e+="    gl_FragColor = color;\n}\n",e}_getShader(t){let e=this.shaderCache[t];if(!e){const s=this._getFragmentShader(t);e=Ai(this.device,"\n\t\tattribute vec2 vertex_position;\n\t\tvarying vec2 uv0;\n\t\tvoid main(void) {\n\t\t\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\t\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n\t\t}\n\t\t",s,"textureMorph"+t),this.shaderCache[t]=e}return e}_updateTextureRenderTarget(t,e){const s=this.device,i=(e,i)=>{this.morphFactor.setValue(this._shaderMorphWeights),s.setBlendState(i?wo:Zt.NOBLEND);const n=this._getShader(e);Fi(s,t,n)};let n=0,r=!1;const a=this._activeTargets.length;for(let t=0;t<a;t++){const s=this._activeTargets[t],a=s.target[e];a&&(this["morphBlendTex"+n].setValue(a),this._shaderMorphWeights[n]=s.weight,n++,n>=this.maxSubmitCount&&(i(n,r),n=0,r=!0))}(n>0||0===a&&!this.zeroTextures)&&i(n,r)}_updateTextureMorph(){(this._activeTargets.length>0||!this.zeroTextures)&&(this.rtPositions&&this._updateTextureRenderTarget(this.rtPositions,"texturePositions"),this.rtNormals&&this._updateTextureRenderTarget(this.rtNormals,"textureNormals"),this.zeroTextures=0===this._activeTargets.length)}_updateVertexMorph(){const t=this.maxSubmitCount;for(let e=0;e<t;e++)this._shaderMorphWeights[e]=0,this._activeVertexBuffers[e]=null;let e=0,s=this.morph.morphPositions?4:0;for(let t=0;t<this._activeTargets.length;t++){const i=this._activeTargets[t].target;i._vertexBufferPositions&&(this._activeVertexBuffers[e]=i._vertexBufferPositions,this._shaderMorphWeights[e]=this._activeTargets[t].weight,e++),i._vertexBufferNormals&&(this._activeVertexBuffers[s]=i._vertexBufferNormals,this._shaderMorphWeights[s]=this._activeTargets[t].weight,s++)}}update(){this._dirty=!1;const t=this.morph._targets;let e=0;for(let s=0;s<t.length;s++){const i=Math.abs(this.getWeight(s));if(i>1e-5){this._activeTargets.length<=e&&(this._activeTargets[e]={});const n=this._activeTargets[e++];n.absWeight=i,n.weight=this.getWeight(s),n.target=t[s]}}this._activeTargets.length=e;const s=this.morph.maxActiveTargets;this._activeTargets.length>s&&(this._activeTargets.sort((function(t,e){return t.absWeight<e.absWeight?1:e.absWeight<t.absWeight?-1:0})),this._activeTargets.length=s),this.morph.useTextureMorph?this._updateTextureMorph():this._updateVertexMorph()}}class Co{constructor(){this.graph=null,this.meshInstances=[],this.skinInstances=[],this.morphInstances=[],this.cameras=[],this.lights=[],this._shadersVersion=0,this._immutable=!1}getGraph(){return this.graph}setGraph(t){this.graph=t}getCameras(){return this.cameras}setCameras(t){this.cameras=t}getLights(){return this.lights}setLights(t){this.lights=t}getMaterials(){const t=[];for(let e=0;e<this.meshInstances.length;e++){const s=this.meshInstances[e];-1===t.indexOf(s.material)&&t.push(s.material)}return t}clone(){const t=[],e=[],s=function s(i){const n=i.clone();t.push(i),e.push(n);for(let t=0;t<i._children.length;t++)n.addChild(s(i._children[t]));return n}(this.graph),i=[],n=[],r=[];for(let t=0;t<this.skinInstances.length;t++){const e=this.skinInstances[t].skin,i=new Zi(e),r=[];for(let t=0;t<e.boneNames.length;t++){const i=e.boneNames[t],n=s.findByName(i);r.push(n)}i.bones=r,n.push(i)}for(let t=0;t<this.morphInstances.length;t++){const e=this.morphInstances[t].morph,s=new So(e);r.push(s)}for(let s=0;s<this.meshInstances.length;s++){const a=this.meshInstances[s],o=t.indexOf(a.node),l=new Sn(a.mesh,a.material,e[o]);if(a.skinInstance){const t=this.skinInstances.indexOf(a.skinInstance);l.skinInstance=n[t]}if(a.morphInstance){const t=this.morphInstances.indexOf(a.morphInstance);l.morphInstance=r[t]}i.push(l)}const a=new Co;return a.graph=s,a.meshInstances=i,a.skinInstances=n,a.morphInstances=r,a.getGraph().syncHierarchy(),a}destroy(){const t=this.meshInstances;for(let e=0;e<t.length;e++)t[e].destroy();this.meshInstances.length=0}generateWireframe(){Sn._prepareRenderStyleForArray(this.meshInstances,1)}}class To extends ai{constructor(t,e,{preferHighPrecision:s=!1}={}){super(),this._aabb=void 0,this.preferHighPrecision=void 0,this.device=e||oi.get(),this.preferHighPrecision=s,this._targets=t.slice();const i=this.device;if(i.supportsMorphTargetTexturesCore){const t=i.extTextureHalfFloat&&i.textureHalfFloatRenderable?et:void 0,e=i.extTextureFloat&&i.textureFloatRenderable?st:void 0;this._renderTextureFormat=this.preferHighPrecision?null!=e?e:t:null!=t?t:e;const s=i.extTextureHalfFloat&&i.textureHalfFloatUpdatable?et:void 0,n=i.extTextureFloat?13:void 0;this._textureFormat=this.preferHighPrecision?null!=n?n:s:null!=s?s:n,void 0!==this._renderTextureFormat&&void 0!==this._textureFormat&&(this._useTextureMorph=!0)}this._init(),this._updateMorphFlags()}get aabb(){if(!this._aabb){const t=new R,e=new R;for(let s=0;s<this._targets.length;s++){const i=this._targets[s].aabb;t.min(i.getMin()),e.max(i.getMax())}this._aabb=new $,this._aabb.setMinMax(t,e)}return this._aabb}get morphPositions(){return this._morphPositions}get morphNormals(){return this._morphNormals}get maxActiveTargets(){return this._useTextureMorph?this._targets.length:this._morphPositions&&this._morphNormals?4:8}get useTextureMorph(){return this._useTextureMorph}_init(){if(this._useTextureMorph&&(this._useTextureMorph=this._initTextureBased()),!this._useTextureMorph)for(let t=0;t<this._targets.length;t++)this._targets[t]._initVertexBuffers(this.device);for(let t=0;t<this._targets.length;t++)this._targets[t]._postInit()}_findSparseSet(t,e,s,i){let n=1;const r=t[0].length;for(let a=0;a<r;a+=3){let r=!1;for(let e=0;e<t.length;e++){const s=t[e];if(0!==s[a]||0!==s[a+1]||0!==s[a+2]){r=!0;break}}r?(e.push(n+i),s.push(a/3),n++):e.push(0+i)}return n}_initTextureBased(){const t=this.device.isWebGPU,e=t?0:.2,s=[],i=[];for(let t=0;t<this._targets.length;t++){const e=this._targets[t];e.options.deltaPositions&&(s.push(e.options.deltaPositions),i.push({target:e,name:"texturePositions"})),e.options.deltaNormals&&(s.push(e.options.deltaNormals),i.push({target:e,name:"textureNormals"}))}const n=[],r=[],a=this._findSparseSet(s,n,r,e),o=Math.min(this.device.maxTextureSize,4096);let l=Math.ceil(Math.sqrt(a));l=Math.min(l,o);const h=Math.ceil(a/l);if(h>o)return!1;this.morphTextureWidth=l,this.morphTextureHeight=h;let c=!1,d=3;const u=Ln.float2Half;this._textureFormat===et&&(c=!0,d=4);const p=[];for(let t=0;t<s.length;t++)p.push(this._createTexture("MorphTarget",this._textureFormat));for(let t=0;t<s.length;t++){const e=s[t],n=p[t],a=n.lock();if(c)for(let t=0;t<r.length;t++){const s=3*r[t],i=t*d+d;a[i]=u(e[s]),a[i+1]=u(e[s+1]),a[i+2]=u(e[s+2])}else for(let t=0;t<r.length;t++){const s=3*r[t],i=t*d+d;a[i]=e[s],a[i+1]=e[s+1],a[i+2]=e[s+2]}n.unlock();i[t].target._setTexture(i[t].name,n)}const f=[{semantic:At,components:1,type:t?5:6}];return this.vertexBufferIds=new oe(this.device,new he(this.device,f,n.length),n.length,0,t?new Uint32Array(n):new Float32Array(n)),!0}destroy(){var t;null==(t=this.vertexBufferIds)||t.destroy(),this.vertexBufferIds=null;for(let t=0;t<this._targets.length;t++)this._targets[t].destroy();this._targets.length=0}get targets(){return this._targets}_updateMorphFlags(){this._morphPositions=!1,this._morphNormals=!1;for(let t=0;t<this._targets.length;t++){const e=this._targets[t];e.morphPositions&&(this._morphPositions=!0),e.morphNormals&&(this._morphNormals=!0)}}_createTexture(t,e){return new Ue(this.device,{width:this.morphTextureWidth,height:this.morphTextureHeight,format:e,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1,name:t})}}class Eo{constructor(t){this.used=!1,2===arguments.length&&(t=arguments[1]),this.options=t,this._name=t.name,this._defaultWeight=t.defaultWeight||0,this._aabb=t.aabb,this.deltaPositions=t.deltaPositions}destroy(){var t,e,s,i;null==(t=this._vertexBufferPositions)||t.destroy(),this._vertexBufferPositions=null,null==(e=this._vertexBufferNormals)||e.destroy(),this._vertexBufferNormals=null,null==(s=this.texturePositions)||s.destroy(),this.texturePositions=null,null==(i=this.textureNormals)||i.destroy(),this.textureNormals=null}get name(){return this._name}get defaultWeight(){return this._defaultWeight}get aabb(){return this._aabb||(this._aabb=new $,this.deltaPositions&&this._aabb.compute(this.deltaPositions)),this._aabb}get morphPositions(){return!!this._vertexBufferPositions||!!this.texturePositions}get morphNormals(){return!!this._vertexBufferNormals||!!this.textureNormals}clone(){return new Eo(this.options)}_postInit(){this.options.preserveData||(this.options=null),this.used=!0}_initVertexBuffers(t){const e=this.options;this._vertexBufferPositions=this._createVertexBuffer(t,e.deltaPositions,e.deltaPositionsType),this._vertexBufferNormals=this._createVertexBuffer(t,e.deltaNormals,e.deltaNormalsType),this._vertexBufferPositions&&(this.deltaPositions=this._vertexBufferPositions.lock())}_createVertexBuffer(t,e,s=6){if(e){return new oe(t,new he(t,[{semantic:xt,components:3,type:s}]),e.length/3,0,e)}return null}_setTexture(t,e){this[t]=e}}const Po={generateKey:function(t){return"cubemap"===t.type?`skybox-${t.type}-${t.encoding}-${t.useIntensity}-${t.gamma}-${t.toneMapping}-${t.fixSeams}-${t.mip}`:`skybox-${t.type}-${t.encoding}-${t.useIntensity}-${t.gamma}-${t.toneMapping}`},createShaderDefinition:function(t,e){let s="";if("cubemap"===e.type){const t=[128,64,16,8,4,2];s+=e.mip?Ei.fixCubemapSeamsStretchPS:Ei.fixCubemapSeamsNonePS,s+=e.useIntensity?Ei.envMultiplyPS:Ei.envConstPS,s+=Ei.decodePS,s+=Ui(e.gamma),s+=Vi(e.toneMapping),s+=Ei.skyboxHDRPS.replace(/\$DECODE/g,$r.decodeFunc(e.encoding)).replace(/\$FIXCONST/g,1-1/t[e.mip]+"")}else s+=e.useIntensity?Ei.envMultiplyPS:Ei.envConstPS,s+=Ei.decodePS,s+=Ui(e.gamma),s+=Vi(e.toneMapping),s+=Ei.sphericalPS,s+=Ei.envAtlasPS,s+=Ei.skyboxEnvPS.replace(/\$DECODE/g,$r.decodeFunc(e.encoding));return cs.createDefinition(t,{name:"SkyboxShader",attributes:{aPosition:at},vertexCode:Ei.skyboxVS,fragmentCode:s})}};class Mo{constructor(t,e,s){this.meshInstance=void 0;const i=new Ki;i.getShaderVariant=function(i,n,r,a,o,l,h,c){const d={pass:o,encoding:s.encoding,useIntensity:1!==e.skyboxIntensity||e.physicalUnits,gamma:1===o?e.gammaCorrection?3:0:e.gammaCorrection,toneMapping:1===o?0:e.toneMapping};s.cubemap?(d.type="cubemap",d.mip=s.fixCubemapSeams?e.skyboxMip:0,d.fixSeams=s.fixCubemapSeams):d.type="envAtlas";const u=new Si(h,c),p=Mi(t);return p.register("skybox",Po),p.getProgram("skybox",d,u)},s.cubemap?i.setParameter("texture_cubeMap",s):(i.setParameter("texture_envAtlas",s),i.setParameter("mipLevel",e._skyboxMip)),i.cull=2,i.depthWrite=!1;const n=e.layers.getLayerById(2);if(n){const e=new gn("Skybox"),s=vi(t),r=new Sn(s,i,e);this.meshInstance=r,r.cull=!1,r._noDepthDrawGl1=!0,r.pick=!1,n.addMeshInstances([r]),this.skyLayer=n}}destroy(){this.meshInstance&&(this.skyLayer&&this.skyLayer.removeMeshInstances([this.meshInstance]),this.meshInstance.destroy(),this.meshInstance=null)}}const Ao=new gn;Ao.worldTransform=V.IDENTITY,Ao._dirtyWorld=Ao._dirtyNormal=!1;class ko{constructor(t,e,s){this.material=e,this.layer=s,this.positions=[],this.colors=[],this.mesh=new di(t),this.meshInstance=null}addLines(t,e){const s=this.positions,i=t.length;for(let e=0;e<i;e++){const i=t[e];s.push(i.x,i.y,i.z)}const n=this.colors;if(e.length)for(let t=0;t<i;t++){const s=e[t];n.push(s.r,s.g,s.b,s.a)}else for(let t=0;t<i;t++)n.push(e.r,e.g,e.b,e.a)}addLinesArrays(t,e){const s=this.positions;for(let e=0;e<t.length;e+=3)s.push(t[e],t[e+1],t[e+2]);const i=this.colors;if(e.length)for(let t=0;t<e.length;t+=4)i.push(e[t],e[t+1],e[t+2],e[t+3]);else{const s=t.length/3;for(let t=0;t<s;t++)i.push(e.r,e.g,e.b,e.a)}}onPreRender(t,e){this.positions.length>0&&this.material.transparent===e&&(this.mesh.setPositions(this.positions),this.mesh.setColors(this.colors),this.mesh.update(1,!1),this.meshInstance||(this.meshInstance=new Sn(this.mesh,this.material,Ao)),this.positions.length=0,this.colors.length=0,t.list.push(this.meshInstance),t.length++)}}class Do{constructor(t){this.device=t,this.map=new Map}getBatch(t,e){let s=this.map.get(t);return s||(s=new ko(this.device,t,e),this.map.set(t,s)),s}onPreRender(t,e){this.map.forEach((s=>{s.onPreRender(t,e)}))}}const Ro=[];class Lo{constructor(t){this.device=t,this.quadMesh=null,this.textureShader=null,this.depthTextureShader=null,this.cubeLocalPos=null,this.cubeWorldPos=null,this.batchesMap=new Map,this.allBatches=new Set,this.updatedLayers=new Set,this._materialDepth=null,this._materialNoDepth=null,this.layerMeshInstances=new Map}createMaterial(t){const e=new Yi;return e.vertexColors=!0,e.blendType=2,e.depthTest=t,e.update(),e}get materialDepth(){return this._materialDepth||(this._materialDepth=this.createMaterial(!0)),this._materialDepth}get materialNoDepth(){return this._materialNoDepth||(this._materialNoDepth=this.createMaterial(!1)),this._materialNoDepth}getBatch(t,e){let s=this.batchesMap.get(t);s||(s=new Do(this.device),this.batchesMap.set(t,s)),this.allBatches.add(s);const i=e?this.materialDepth:this.materialNoDepth;return s.getBatch(i,t)}getShader(t,e){if(!this[t]){const s="\n\t\t\t\t\t\t\t\tattribute vec2 vertex_position;\n\t\t\t\t\t\t\t\tuniform mat4 matrix_model;\n\t\t\t\t\t\t\t\tvarying vec2 uv0;\n\t\t\t\t\t\t\t\tvoid main(void) {\n\t\t\t\t\t\t\t\t\t\tgl_Position = matrix_model * vec4(vertex_position, 0, 1);\n\t\t\t\t\t\t\t\t\t\tuv0 = vertex_position.xy + 0.5;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t";this[t]=Ai(this.device,s,e,`DebugShader:${t}`)}return this[t]}getTextureShader(){return this.getShader("textureShader","\n\t\t\t\t\t\tvarying vec2 uv0;\n\t\t\t\t\t\tuniform sampler2D colorMap;\n\t\t\t\t\t\tvoid main (void) {\n\t\t\t\t\t\t\t\tgl_FragColor = vec4(texture2D(colorMap, uv0).xyz, 1);\n\t\t\t\t\t\t}\n\t\t\t\t")}getUnfilterableTextureShader(){return this.getShader("textureShaderUnfilterable","\n\t\t\t\t\t\tvarying vec2 uv0;\n\t\t\t\t\t\tuniform highp sampler2D colorMap;\n\t\t\t\t\t\tvoid main (void) {\n\t\t\t\t\t\t\t\tivec2 uv = ivec2(uv0 * textureSize(colorMap, 0));\n\t\t\t\t\t\t\t\tgl_FragColor = vec4(texelFetch(colorMap, uv, 0).xyz, 1);\n\t\t\t\t\t\t}\n\t\t\t\t")}getDepthTextureShader(){return this.getShader("depthTextureShader",`\n\t\t\t\t\t\t${Ei.screenDepthPS}\n\t\t\t\t\t\tvarying vec2 uv0;\n\t\t\t\t\t\tvoid main() {\n\t\t\t\t\t\t\t\tfloat depth = getLinearScreenDepth(uv0) * camera_params.x;\n\t\t\t\t\t\t\t\tgl_FragColor = vec4(vec3(depth), 1.0);\n\t\t\t\t\t\t}\n\t\t\t\t`)}getQuadMesh(){return this.quadMesh||(this.quadMesh=new di(this.device),this.quadMesh.setPositions([-.5,-.5,0,.5,-.5,0,-.5,.5,0,.5,.5,0]),this.quadMesh.update(rt)),this.quadMesh}drawMesh(t,e,s,i,n){if(!i){const n=this.getGraphNode(e);i=new Sn(s,t,n)}let r=this.layerMeshInstances.get(n);r||(r=[],this.layerMeshInstances.set(n,r)),r.push(i)}drawWireAlignedBox(t,e,s,i,n){Ro.push(t.x,t.y,t.z,t.x,e.y,t.z,t.x,e.y,t.z,e.x,e.y,t.z,e.x,e.y,t.z,e.x,t.y,t.z,e.x,t.y,t.z,t.x,t.y,t.z,t.x,t.y,e.z,t.x,e.y,e.z,t.x,e.y,e.z,e.x,e.y,e.z,e.x,e.y,e.z,e.x,t.y,e.z,e.x,t.y,e.z,t.x,t.y,e.z,t.x,t.y,t.z,t.x,t.y,e.z,t.x,e.y,t.z,t.x,e.y,e.z,e.x,e.y,t.z,e.x,e.y,e.z,e.x,t.y,t.z,e.x,t.y,e.z);this.getBatch(n,i).addLinesArrays(Ro,s),Ro.length=0}drawWireSphere(t,e,s,i,n,r){const a=2*Math.PI/i;let o=0;for(let s=0;s<i;s++){const s=Math.sin(o),i=Math.cos(o);o+=a;const n=Math.sin(o),r=Math.cos(o);Ro.push(t.x+e*s,t.y,t.z+e*i),Ro.push(t.x+e*n,t.y,t.z+e*r),Ro.push(t.x+e*s,t.y+e*i,t.z),Ro.push(t.x+e*n,t.y+e*r,t.z),Ro.push(t.x,t.y+e*s,t.z+e*i),Ro.push(t.x,t.y+e*n,t.z+e*r)}this.getBatch(r,n).addLinesArrays(Ro,s),Ro.length=0}getGraphNode(t){const e=new gn("ImmediateDebug");return e.worldTransform=t,e._dirtyWorld=e._dirtyNormal=!1,e}onPreRenderLayer(t,e,s){if(this.batchesMap.forEach(((i,n)=>{n===t&&i.onPreRender(e,s)})),!this.updatedLayers.has(t)){this.updatedLayers.add(t);const s=this.layerMeshInstances.get(t);if(s){for(let t=0;t<s.length;t++)e.list[e.length+t]=s[t];e.length+=s.length,s.length=0}}}onPostRender(){this.allBatches.clear(),this.updatedLayers.clear()}}class Io extends h{constructor(t){super(),this.ambientBake=!1,this.ambientBakeOcclusionBrightness=0,this.ambientBakeOcclusionContrast=0,this.ambientLight=new D(0,0,0),this.ambientLuminance=0,this.exposure=1,this.fogColor=new D(0,0,0),this.fogDensity=0,this.fogEnd=1e3,this.fogStart=1,this.lightmapSizeMultiplier=1,this.lightmapMaxResolution=2048,this.lightmapMode=1,this.lightmapFilterEnabled=!1,this.lightmapHDR=!1,this.root=null,this.sky=null,this.physicalUnits=!1,this.device=t||oi.get(),this._gravity=new R(0,-9.8,0),this._layers=null,this._fog=Zs,this._gammaCorrection=1,this._toneMapping=0,this._skyboxCubeMap=null,this._prefilteredCubemaps=[],this._envAtlas=null,this._internalEnvAtlas=null,this._skyboxIntensity=1,this._skyboxLuminance=0,this._skyboxMip=0,this._skyboxRotationShaderInclude=!1,this._skyboxRotation=new H,this._skyboxRotationMat3=new L,this._skyboxRotationMat4=new V,this._ambientBakeNumSamples=1,this._ambientBakeSpherePart=.4,this._lightmapFilterRange=10,this._lightmapFilterSmoothness=.2,this._clusteredLightingEnabled=!0,this._lightingParams=new xo(this.device.supportsAreaLights,this.device.maxTextureSize,(()=>{this._layers._dirtyLights=!0})),this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,lastStaticPrepareFullTime:0,lastStaticPrepareSearchTime:0,lastStaticPrepareWriteTime:0,lastStaticPrepareTriAabbTime:0,lastStaticPrepareCombineTime:0,updateShadersTime:0},this.updateShaders=!0,this._shaderVersion=0,this._statsUpdated=!1,this.immediate=new Lo(this.device)}get defaultDrawLayer(){return this.layers.getLayerById(3)}set ambientBakeNumSamples(t){this._ambientBakeNumSamples=k.clamp(Math.floor(t),1,255)}get ambientBakeNumSamples(){return this._ambientBakeNumSamples}set ambientBakeSpherePart(t){this._ambientBakeSpherePart=k.clamp(t,.001,1)}get ambientBakeSpherePart(){return this._ambientBakeSpherePart}set clusteredLightingEnabled(t){this._clusteredLightingEnabled||!t?this._clusteredLightingEnabled=t:console.error("Turning on disabled clustered lighting is not currently supported")}get clusteredLightingEnabled(){return this._clusteredLightingEnabled}set drawCalls(t){}get drawCalls(){let t=this.layers._meshInstances;return t.length||(this.layers._update(this.device,this.clusteredLightingEnabled),t=this.layers._meshInstances),t}set envAtlas(t){t!==this._envAtlas&&(this._envAtlas=t,t&&(t.addressU=1,t.addressV=1,t.minFilter=1,t.magFilter=1,t.mipmaps=!1),this._prefilteredCubemaps=[],this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._resetSky())}get envAtlas(){return this._envAtlas}set fog(t){t!==this._fog&&(this._fog=t,this.updateShaders=!0)}get fog(){return this._fog}set gammaCorrection(t){t!==this._gammaCorrection&&(this._gammaCorrection=t,this.updateShaders=!0)}get gammaCorrection(){return this._gammaCorrection}set layers(t){const e=this._layers;this._layers=t,this.fire("set:layers",e,t)}get layers(){return this._layers}get lighting(){return this._lightingParams}set lightmapFilterRange(t){this._lightmapFilterRange=Math.max(t,.001)}get lightmapFilterRange(){return this._lightmapFilterRange}set lightmapFilterSmoothness(t){this._lightmapFilterSmoothness=Math.max(t,.001)}get lightmapFilterSmoothness(){return this._lightmapFilterSmoothness}set prefilteredCubemaps(t){t=t||[];const e=this._prefilteredCubemaps,s=e.length!==t.length||e.some(((e,s)=>e!==t[s]));if(s){const e=6===t.length&&t.every((t=>!!t));e?(this._internalEnvAtlas=ua.generatePrefilteredAtlas(t,{target:this._internalEnvAtlas}),this._envAtlas=this._internalEnvAtlas):(this._internalEnvAtlas&&(this._internalEnvAtlas.destroy(),this._internalEnvAtlas=null),this._envAtlas=null),this._prefilteredCubemaps=t.slice(),this._resetSky()}}get prefilteredCubemaps(){return this._prefilteredCubemaps}set skybox(t){t!==this._skyboxCubeMap&&(this._skyboxCubeMap=t,this._resetSky())}get skybox(){return this._skyboxCubeMap}set skyboxIntensity(t){t!==this._skyboxIntensity&&(this._skyboxIntensity=t,this._resetSky())}get skyboxIntensity(){return this._skyboxIntensity}set skyboxLuminance(t){t!==this._skyboxLuminance&&(this._skyboxLuminance=t,this._resetSky())}get skyboxLuminance(){return this._skyboxLuminance}set skyboxMip(t){t!==this._skyboxMip&&(this._skyboxMip=t,this._resetSky())}get skyboxMip(){return this._skyboxMip}set skyboxRotation(t){if(!this._skyboxRotation.equals(t)){const e=t.equals(H.IDENTITY);this._skyboxRotation.copy(t),e?this._skyboxRotationMat3.setIdentity():(this._skyboxRotationMat4.setTRS(R.ZERO,t,R.ONE),this._skyboxRotationMat4.invertTo3x3(this._skyboxRotationMat3)),this._skyboxRotationShaderInclude||e||(this._skyboxRotationShaderInclude=!0,this._resetSky())}}get skyboxRotation(){return this._skyboxRotation}set toneMapping(t){t!==this._toneMapping&&(this._toneMapping=t,this.updateShaders=!0)}get toneMapping(){return this._toneMapping}destroy(){this._resetSky(),this.root=null,this.off()}drawLine(t,e,s=D.WHITE,i=!0,n=this.defaultDrawLayer){this.immediate.getBatch(n,i).addLines([t,e],[s,s])}drawLines(t,e,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLines(t,e)}drawLineArrays(t,e,s=!0,i=this.defaultDrawLayer){this.immediate.getBatch(i,s).addLinesArrays(t,e)}applySettings(t){var e,s,i;const n=t.physics,r=t.render;this._gravity.set(n.gravity[0],n.gravity[1],n.gravity[2]),this.ambientLight.set(r.global_ambient[0],r.global_ambient[1],r.global_ambient[2]),this.ambientLuminance=r.ambientLuminance,this._fog=r.fog,this.fogColor.set(r.fog_color[0],r.fog_color[1],r.fog_color[2]),this.fogStart=r.fog_start,this.fogEnd=r.fog_end,this.fogDensity=r.fog_density,this._gammaCorrection=r.gamma_correction,this._toneMapping=r.tonemapping,this.lightmapSizeMultiplier=r.lightmapSizeMultiplier,this.lightmapMaxResolution=r.lightmapMaxResolution,this.lightmapMode=r.lightmapMode,this.exposure=r.exposure,this._skyboxIntensity=null!=(e=r.skyboxIntensity)?e:1,this._skyboxLuminance=null!=(s=r.skyboxLuminance)?s:2e4,this._skyboxMip=null!=(i=r.skyboxMip)?i:0,r.skyboxRotation&&(this.skyboxRotation=(new H).setFromEulerAngles(r.skyboxRotation[0],r.skyboxRotation[1],r.skyboxRotation[2])),this.clusteredLightingEnabled=r.clusteredLightingEnabled,this.lighting.applySettings(r),["lightmapFilterEnabled","lightmapFilterRange","lightmapFilterSmoothness","ambientBake","ambientBakeNumSamples","ambientBakeSpherePart","ambientBakeOcclusionBrightness","ambientBakeOcclusionContrast"].forEach((t=>{r.hasOwnProperty(t)&&(this[t]=r[t])})),this._resetSky()}_getSkyboxTex(){const t=this._prefilteredCubemaps;if(this._skyboxMip){return t[[0,1,3,4,5,6][this._skyboxMip]]||this._envAtlas||t[0]||this._skyboxCubeMap}return this._skyboxCubeMap||t[0]||this._envAtlas}_updateSky(t){if(!this.sky){const e=this._getSkyboxTex();e&&(this.sky=new Mo(t,this,e),this.fire("set:skybox",e))}}_resetSky(){var t;null==(t=this.sky)||t.destroy(),this.sky=null,this.updateShaders=!0}setSkybox(t){t?(this.skybox=t[0]||null,t[1]&&!t[1].cubemap?this.envAtlas=t[1]:this.prefilteredCubemaps=t.slice(1)):(this.skybox=null,this.envAtlas=null)}get lightmapPixelFormat(){return this.lightmapHDR&&this.device.getHdrFormat(!1,!0,!1,!0)||7}}class Oo{constructor(t,e,s){this.device=t,this.inverseBindPose=e,this.boneNames=s}}class Fo{constructor(t,e){this.processedCache=new Map,this.definitionsCache=new Map,this._device=t,this._generators={},this._isClearingCache=!1,this._precached=!1,this._programsCollection=[],this._defaultStdMatOption=new va,this._defaultStdMatOptionMin=new va,e.shaderOptBuilder.updateRef(this._defaultStdMatOption,{},e,null,[],0,null),e.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,{},e,null,[],4,null),t.on("destroy:shader",(t=>{this.removeFromCache(t)}))}destroy(){this.clearCache()}register(t,e){this.isRegistered(t)||(this._generators[t]=e)}unregister(t){this.isRegistered(t)&&delete this._generators[t]}isRegistered(t){return void 0!==this._generators[t]}generateShaderDefinition(t,e,s,i){let n=this.definitionsCache.get(s);if(!n){var r,a,o;let l;null!=(r=i.litOptions)&&r.lights&&(l=i.litOptions.lights,i.litOptions.lights=l.map((function(t){const e=t.clone?t.clone():t;return e.key=t.key,e}))),this.storeNewProgram(e,i),null!=(a=i.litOptions)&&a.lights&&(i.litOptions.lights=l);const h=this._device;n=t.createShaderDefinition(h,i),n.name=null!=(o=n.name)?o:i.pass?`${e}-pass:${i.pass}`:e,this.definitionsCache.set(s,n)}return n}getCachedShader(t){return this.processedCache.get(t)}setCachedShader(t,e){this.processedCache.set(t,e)}getProgram(t,e,s){const i=this._generators[t];if(!i)return null;const n=i.generateKey(e),r=`${n}#${s.generateKey()}`;let a=this.getCachedShader(r);if(!a){const o=this.generateShaderDefinition(i,t,n,e);let l="";if(void 0!==e.pass){l=`-${Ni.get(this._device).getByIndex(e.pass).name}`}const h={name:`${o.name}${l}-proc`,attributes:o.attributes,vshader:o.vshader,fshader:o.fshader,processingOptions:s};a=new Ie(this._device,h),this.setCachedShader(r,a)}return a}storeNewProgram(t,e){let s={};if("standard"===t){const t=this._getDefaultStdMatOptions(e.pass);for(const i in e)(e.hasOwnProperty(i)&&t[i]!==e[i]||"pass"===i)&&(s[i]=e[i]);for(const t in e.litOptions)s[t]=e.litOptions[t]}else s=e;this._programsCollection.push(JSON.stringify({name:t,options:s}))}dumpPrograms(){let t="let device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;\n";t+="let shaders = [",this._programsCollection[0]&&(t+="\n\t"+this._programsCollection[0]);for(let e=1;e<this._programsCollection.length;++e)t+=",\n\t"+this._programsCollection[e];t+="\n];\n",t+="device.getProgramLibrary().precompile(shaders);\n",t+='if (pc.version != "'+n+'" || pc.revision != "'+r+'")\n',t+='\tconsole.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");';const e=document.createElement("a");e.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),e.setAttribute("download","precompile-shaders.js"),e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e)}clearCache(){this._isClearingCache=!0,this.processedCache.forEach((t=>{t.destroy()})),this.processedCache.clear(),this._isClearingCache=!1}removeFromCache(t){this._isClearingCache||this.processedCache.forEach(((e,s)=>{t===e&&this.processedCache.delete(s)}))}_getDefaultStdMatOptions(t){const e=Ni.get(this._device).getByIndex(t);return 2===t||3===t||e.isShadow?this._defaultStdMatOptionMin:this._defaultStdMatOption}precompile(t){if(t){const e=new Array(t.length);for(let s=0;s<t.length;s++){if("standard"===t[s].name){const e=t[s].options,i=this._getDefaultStdMatOptions(e.pass);for(const t in i)i.hasOwnProperty(t)&&void 0===e[t]&&(e[t]=i[t])}e[s]=this.getProgram(t[s].name,t[s].options)}}this._precached=!0}}const Bo={bakeDirLmEndPS:"\n\t\tvec4 dirLm = texture2D(texture_dirLightMap, vUv1);\n\n\t\tif (bakeDir > 0.5) {\n\t\t\t\tif (dAtten > 0.00001) {\n\t\t\t\t\t\tdirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);\n\t\t\t\t\t\tdAtten = saturate(dAtten);\n\t\t\t\t\t\tgl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);\n\t\t\t\t\t\tgl_FragColor.a = dirLm.w + dAtten;\n\t\t\t\t\t\tgl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);\n\t\t\t\t} else {\n\t\t\t\t\t\tgl_FragColor = dirLm;\n\t\t\t\t}\n\t\t} else {\n\t\t\t\tgl_FragColor.rgb = dirLm.xyz;\n\t\t\t\tgl_FragColor.a = max(dirLm.w, dAtten > 0.00001? (1.0/255.0) : 0.0);\n\t\t}\n",bakeLmEndPS:"\n#ifdef LIGHTMAP_RGBM\n\t\tgl_FragColor.rgb = dDiffuseLight;\n\t\tgl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));\n\t\tgl_FragColor.rgb /= 8.0;\n\t\tgl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );\n\t\tgl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;\n\t\tgl_FragColor.rgb /= gl_FragColor.a;\n#else\n\t\tgl_FragColor = vec4(dDiffuseLight, 1.0);\n#endif\n",dilatePS:"\n\nvarying vec2 vUv0;\n\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n\nvoid main(void) {\n\t\tvec4 c = texture2D(source, vUv0);\n\t\tc = c.a>0.0? c : texture2D(source, vUv0 - pixelOffset);\n\t\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, -pixelOffset.y));\n\t\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y));\n\t\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, 0));\n\t\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, 0));\n\t\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y));\n\t\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, pixelOffset.y));\n\t\tc = c.a>0.0? c : texture2D(source, vUv0 + pixelOffset);\n\t\tgl_FragColor = c;\n}\n",bilateralDeNoisePS:"\n// bilateral filter, based on https://www.shadertoy.com/view/4dfGDH# and\n// http://people.csail.mit.edu/sparis/bf_course/course_notes.pdf\n\n// A bilateral filter is a non-linear, edge-preserving, and noise-reducing smoothing filter for images.\n// It replaces the intensity of each pixel with a weighted average of intensity values from nearby pixels.\n// This weight can be based on a Gaussian distribution. Crucially, the weights depend not only on\n// Euclidean distance of pixels, but also on the radiometric differences (e.g., range differences, such\n// as color intensity, depth distance, etc.). This preserves sharp edges.\n\nfloat normpdf3(in vec3 v, in float sigma) {\n\t\treturn 0.39894 * exp(-0.5 * dot(v, v) / (sigma * sigma)) / sigma;\n}\n\nvec3 decodeRGBM(vec4 rgbm) {\n\t\tvec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n\t\treturn color * color;\n}\n\nfloat saturate(float x) {\n\t\treturn clamp(x, 0.0, 1.0);\n}\n\nvec4 encodeRGBM(vec3 color) { // modified RGBM\n\t\tvec4 encoded;\n\t\tencoded.rgb = pow(color.rgb, vec3(0.5));\n\t\tencoded.rgb *= 1.0 / 8.0;\n\n\t\tencoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );\n\t\tencoded.a = ceil(encoded.a * 255.0) / 255.0;\n\n\t\tencoded.rgb /= encoded.a;\n\t\treturn encoded;\n}\n\n// filter size\n#define MSIZE 15\n\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nuniform vec2 sigmas;\nuniform float bZnorm;\nuniform float kernel[MSIZE];\n\nvoid main(void) {\n\t\t\n\t\tvec4 pixelRgbm = texture2D(source, vUv0);\n\n\t\t// lightmap specific optimization - skip pixels that were not baked\n\t\t// this also allows dilate filter that work on the output of this to work correctly, as it depends on .a being zero\n\t\t// to dilate, which the following blur filter would otherwise modify\n\t\tif (pixelRgbm.a <= 0.0) {\n\t\t\t\tgl_FragColor = pixelRgbm;\n\t\t\t\treturn ;\n\t\t}\n\n\t\t// range sigma - controls blurriness based on a pixel distance\n\t\tfloat sigma = sigmas.x;\n\n\t\t// domain sigma - controls blurriness based on a pixel similarity (to preserve edges)\n\t\tfloat bSigma = sigmas.y;\n\n\t\tvec3 pixelHdr = decodeRGBM(pixelRgbm);\n\t\tvec3 accumulatedHdr = vec3(0.0);\n\t\tfloat accumulatedFactor = 0.0;\n\n\t\t// read out the texels\n\t\tconst int kSize = (MSIZE-1)/2;\n\t\tfor (int i = -kSize; i <= kSize; ++i) {\n\t\t\t\tfor (int j = -kSize; j <= kSize; ++j) {\n\t\t\t\t\t\t\n\t\t\t\t\t\t// sample the pixel with offset\n\t\t\t\t\t\tvec2 coord = vUv0 + vec2(float(i), float(j)) * pixelOffset;\n\t\t\t\t\t\tvec4 rgbm = texture2D(source, coord);\n\n\t\t\t\t\t\t// lightmap - only use baked pixels\n\t\t\t\t\t\tif (rgbm.a > 0.0) {\n\t\t\t\t\t\t\t\tvec3 hdr = decodeRGBM(rgbm);\n\n\t\t\t\t\t\t\t\t// bilateral factors\n\t\t\t\t\t\t\t\tfloat factor = kernel[kSize + j] * kernel[kSize + i];\n\t\t\t\t\t\t\t\tfactor *= normpdf3(hdr - pixelHdr, bSigma) * bZnorm;\n\n\t\t\t\t\t\t\t\t// accumulate\n\t\t\t\t\t\t\t\taccumulatedHdr += factor * hdr;\n\t\t\t\t\t\t\t\taccumulatedFactor += factor;\n\t\t\t\t\t\t}\n\t\t\t\t}\n\t\t}\n\n\t\tgl_FragColor = encodeRGBM(accumulatedHdr / accumulatedFactor);\n}\n"},zo="KEEP_ASPECT",No="AUTO";let Uo;function Vo(){return Uo}function Ho(t){Uo=t,oi.set(null==t?void 0:t.graphicsDevice)}class Go{static push(t,e){e&&Go._types.length>0?console.assert("Script Ordering Error. Contact support@playcanvas.com"):Go._types.push(t)}}Go._types=[];let Wo=!1,jo=!1;const qo={app:null,create:function(t,e){if(!Wo)return;const s=e(qo.app);s._pcScriptName=t,Go.push(s,Wo),this.fire("created",t,e)},attribute:function(t,e,s,i){},createLoadingScreen:function(t){if(jo)return;jo=!0;t(Vo())}};Object.defineProperty(qo,"legacy",{get:function(){return Wo},set:function(t){Wo=t}}),c.attach(qo);class Xo{constructor(){this.renderPasses=[],this.renderTargetMap=new Map}addRenderPass(t){this.renderPasses.push(t)}reset(){this.renderPasses.length=0}compile(){const t=this.renderTargetMap,e=this.renderPasses;for(let s=0;s<e.length;s++){const i=e[s],n=i.renderTarget;if(void 0!==n){const e=t.get(n);if(e){const t=i.colorArrayOps.length;for(let s=0;s<t;s++){i.colorArrayOps[s].clear||(e.colorArrayOps[s].store=!0)}i.depthStencilOps.clearDepth||(e.depthStencilOps.storeDepth=!0),i.depthStencilOps.clearStencil||(e.depthStencilOps.storeStencil=!0)}t.set(n,i)}}let s=null,i=null;for(let t=0;t<e.length;t++){const n=e[t],r=n.renderTarget,a=null==r?void 0:r.colorBuffer;if(null!=a&&a.cubemap){if(s===a){const t=i.colorArrayOps.length;for(let e=0;e<t;e++)i.colorArrayOps[e].mipmaps=!1}s=r.colorBuffer,i=n}else n.requiresCubemaps&&(s=null,i=null)}t.forEach(((t,e)=>{null===e&&(t.colorOps.store=!0,t.colorOps.resolve=!1,t.colorOps.mipmaps=!1)})),t.clear()}render(t){this.compile();const e=this.renderPasses;for(let t=0;t<e.length;t++)e[t].render()}}class $o{constructor(t,e){this.texture0=t,this.texture1=e}destroy(){var t,e;null==(t=this.texture0)||t.destroy(),null==(e=this.texture1)||e.destroy()}}const Ko=new je;class Yo{static createTexture(t,e,s,i=""){return new Ue(t,{name:`AreaLightLUT${i}`,width:s,height:s,format:e,addressU:1,addressV:1,type:kt,magFilter:1,minFilter:0,anisotropy:1,mipmaps:!1})}static applyTextures(t,e,s){Ko.remove(t),Ko.get(t,(()=>new $o(e,e===s?null:s))),t.scope.resolve("areaLightsLutTex1").setValue(e),t.scope.resolve("areaLightsLutTex2").setValue(s)}static createPlaceholder(t){const e=Yo.createTexture(t,t.areaLightLutFormat,2,"placeholder");e.lock().fill(0),e.unlock(),Yo.applyTextures(t,e,e)}static set(t,e,s){function i(t,e,s){const i=Yo.createTexture(t,s,64);return i.lock().set(e),i.unlock(),i}function n(t,e,s){const i=t.length,n=new Float32Array(i);for(let r=0;r<i;r++){const i=r%4;n[r]=(t[r]+e[i])*s[i]}return n}function r(t){const e=t.length,s=new Uint16Array(e),i=Ln.float2Half;for(let n=0;n<e;n++)s[n]=i(t[n]);return s}function a(t){const e=t.length,s=new Uint8ClampedArray(e);for(let i=0;i<e;i++)s[i]=255*t[i];return s}const o=e,l=s;let h,c;const d=t.areaLightLutFormat;if(d===st)h=o,c=l;else if(d===et)h=r(o),c=r(l);else{const t=[-.306897,0,0,0],e=[1.442787,1,1,1];h=a(n(o,[0,.2976,.01381,0],[.999,3.08737,1.6546,.603249])),c=a(n(l,t,e))}const u=i(t,h,d),p=i(t,c,d);Yo.applyTextures(t,u,p)}}const Qo="en-US",Jo={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"},Zo={};function tl(t,e){for(let s=0,i=t.length;s<i;s++)Zo[t[s]]=e}function el(t){const e=t.indexOf("-");return-1!==e?t.substring(0,e):t}function sl(t,e){if(e[t])return t;let s=Jo[t];if(s&&e[s])return s;const i=el(t);return s=Jo[i],e[s]?s:e[i]?i:Qo}tl(["ja","ko","th","vi","zh","id"],(function(t){return 0})),tl(["fa","hi"],(function(t){return t>=0&&t<=1?0:1})),tl(["fr","pt"],(function(t){return t>=0&&t<2?0:1})),tl(["da"],(function(t){return 1===t||!Number.isInteger(t)&&t>=0&&t<=1?0:1})),tl(["de","en","it","el","es","tr","fi","sv","nb","no","ur"],(function(t){return 1===t?0:1})),tl(["ru","uk"],(function(t){if(Number.isInteger(t)){const e=t%10,s=t%100;if(1===e&&11!==s)return 0;if(e>=2&&e<=4&&(s<12||s>14))return 1;if(0===e||e>=5&&e<=9||s>=11&&s<=14)return 2}return 3})),tl(["pl"],(function(t){if(Number.isInteger(t)){if(1===t)return 0;const e=t%10,s=t%100;if(e>=2&&e<=4&&(s<12||s>14))return 1;if(e>=0&&e<=1||e>=5&&e<=9||s>=12&&s<=14)return 2}return 3})),tl(["ar"],(function(t){if(0===t)return 0;if(1===t)return 1;if(2===t)return 2;if(Number.isInteger(t)){const e=t%100;if(e>=3&&e<=10)return 3;if(e>=11&&e<=99)return 4}return 5}));const il=Zo[el(Qo)];function nl(t){return Zo[t]||il}const rl=new RegExp("^\\s*(?:(?:[a-z]+[a-z0-9\\-\\+\\.]*:)?//|data:|blob:)","i");class al{constructor(t="",e="",s=null,i=null,n=null,r=null){this.url=t,this.filename=e,this.hash=s,this.size=i,this.opt=n,this.contents=r}equals(t){return this.url===t.url&&this.filename===t.filename&&this.hash===t.hash&&this.size===t.size&&this.opt===t.opt&&this.contents===t.contents}}let ol=-1;const ll={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},hl=["pvr","dxt","etc2","etc1","basis"];class cl extends h{constructor(t,e,s,i,n){super(),this._id=ol--,this.name=t||"",this.type=e,this.tags=new E(this),this._preload=!1,this._file=null,this._data=i||{},this.options=n||{},this._resources=[],this._i18n={},this.loaded=!1,this.loading=!1,this.registry=null,s&&(this.file=s)}set id(t){this._id=t}get id(){return this._id}set file(t){if(t&&t.variants&&-1!==["texture","textureatlas","bundle"].indexOf(this.type)){var e,s;const i=(null==(e=this.registry)||null==(s=e._loader)?void 0:s._app)||Vo(),n=null==i?void 0:i.graphicsDevice;if(n)for(let e=0,s=hl.length;e<s;e++){const s=hl[e];if(t.variants[s]&&n[ll[s]]){t=t.variants[s];break}if(i.enableBundles){const t=i.bundles.listBundlesForAsset(this);if(t&&t.find((t=>{var e;return null==t||null==(e=t.file)?void 0:e.variants[s]})))break}}}const i=this._file,n=t?new al(t.url,t.filename,t.hash,t.size,t.opt,t.contents):null;(!!n!=!!i||n&&!n.equals(i))&&(this._file=n,this.fire("change",this,"file",n,i),this.reload())}get file(){return this._file}set data(t){const e=this._data;this._data=t,t!==e&&(this.fire("change",this,"data",t,e),this.loaded&&this.registry._loader.patch(this,this.registry))}get data(){return this._data}set resource(t){const e=this._resources[0];this._resources[0]=t,this.fire("change",this,"resource",t,e)}get resource(){return this._resources[0]}set resources(t){const e=this._resources;this._resources=t,this.fire("change",this,"resources",t,e)}get resources(){return this._resources}set preload(t){t=!!t,this._preload!==t&&(this._preload=t,this._preload&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this))}get preload(){return this._preload}set loadFaces(t){t=!!t,this.hasOwnProperty("_loadFaces")&&t===this._loadFaces||(this._loadFaces=t,this.loaded&&this.registry._loader.patch(this,this.registry))}get loadFaces(){return this._loadFaces}getFileUrl(){const t=this.file;if(!t||!t.url)return null;let e=t.url;if(this.registry&&this.registry.prefix&&!rl.test(e)&&(e=this.registry.prefix+e),"script"!==this.type&&t.hash){const s=-1!==e.indexOf("?")?"&":"?";e+=s+"t="+t.hash}return e}getAbsoluteUrl(t){if(t.startsWith("blob:")||t.startsWith("data:"))return t;const e=u.getDirectory(this.file.url);return u.join(e,t)}getLocalizedAssetId(t){return t=sl(t,this._i18n),this._i18n[t]||null}addLocalizedAssetId(t,e){this._i18n[t]=e,this.fire("add:localized",t,e)}removeLocalizedAssetId(t){const e=this._i18n[t];e&&(delete this._i18n[t],this.fire("remove:localized",t,e))}ready(t,e){e=e||this,this.loaded?t.call(e,this):this.once("load",(function(s){t.call(e,s)}))}reload(){this.loaded&&(this.loaded=!1,this.registry.load(this))}unload(){if(!this.loaded&&0===this._resources.length)return;this.fire("unload",this),this.registry.fire("unload:"+this.id,this);const t=this._resources;this.resources=[],this.loaded=!1,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(let e=0;e<t.length;++e){const s=t[e];s&&s.destroy&&s.destroy()}}static fetchArrayBuffer(t,e,s,i=0){var n;null!=s&&null!=(n=s.file)&&n.contents?setTimeout((()=>{e(null,s.file.contents)})):Js.get(t,{cache:!0,responseType:"arraybuffer",retry:i>0,maxRetries:i},e)}}class dl{constructor(t=null){this._index={},this._key=void 0,this._key=t}addItem(t){const e=t.tags._list;for(const s of e)this.add(s,t)}removeItem(t){const e=t.tags._list;for(const s of e)this.remove(s,t)}add(t,e){this._index[t]&&-1!==this._index[t].list.indexOf(e)||(this._index[t]||(this._index[t]={list:[]},this._key&&(this._index[t].keys={})),this._index[t].list.push(e),this._key&&(this._index[t].keys[e[this._key]]=e))}remove(t,e){if(!this._index[t])return;if(this._key&&!this._index[t].keys[e[this._key]])return;const s=this._index[t].list.indexOf(e);-1!==s&&(this._index[t].list.splice(s,1),this._key&&delete this._index[t].keys[e[this._key]],0===this._index[t].list.length&&delete this._index[t])}find(t){const e={},s=[];let i,n,r,a,o;const l=(t,e)=>this._index[t].list.length-this._index[e].list.length;for(let h=0;h<t.length;h++){if(n=t[h],n instanceof Array){if(0===n.length)continue;if(1!==n.length){o=!1;for(let t=0;t<n.length;t++)if(!this._index[n[t]]){o=!0;break}if(o)continue;r=n.slice(0).sort(l),a=r.slice(1),1===a.length&&(a=a[0]);for(let t=0;t<this._index[r[0]].list.length;t++)i=this._index[r[0]].list[t],(this._key?!e[i[this._key]]:-1===s.indexOf(i))&&i.tags.has(a)&&(this._key&&(e[i[this._key]]=!0),s.push(i));continue}n=n[0]}if(n&&"string"==typeof n&&this._index[n])for(let t=0;t<this._index[n].list.length;t++)i=this._index[n].list[t],this._key?e[i[this._key]]||(e[i[this._key]]=!0,s.push(i)):-1===s.indexOf(i)&&s.push(i)}return s}}class ul extends h{constructor(t){super(),this._assets=new Set,this._idToAsset=new Map,this._urlToAsset=new Map,this._tags=new dl("_id"),this.prefix=null,this._loader=t}list(t={}){const e=Array.from(this._assets);return void 0!==t.preload?e.filter((e=>e.preload===t.preload)):e}add(t){var e,s;this._assets.has(t)||(this._assets.add(t),this._idToAsset.set(t.id,t),null!=(e=t.file)&&e.url&&this._urlToAsset.set(t.file.url,t),t.registry=this,this._tags.addItem(t),t.tags.on("add",this._onTagAdd,this),t.tags.on("remove",this._onTagRemove,this),this.fire("add",t),this.fire("add:"+t.id,t),null!=(s=t.file)&&s.url&&this.fire("add:url:"+t.file.url,t),t.preload&&this.load(t))}remove(t){var e,s;return!!this._assets.has(t)&&(this._assets.delete(t),this._idToAsset.delete(t.id),null!=(e=t.file)&&e.url&&this._urlToAsset.delete(t.file.url),this._tags.removeItem(t),t.tags.off("add",this._onTagAdd,this),t.tags.off("remove",this._onTagRemove,this),t.fire("remove",t),this.fire("remove",t),this.fire("remove:"+t.id,t),null!=(s=t.file)&&s.url&&this.fire("remove:url:"+t.file.url,t),!0)}get(t){return this._idToAsset.get(Number(t))}getByUrl(t){return this._urlToAsset.get(t)}load(t){if(t.loading||t.loaded)return;const e=t.file,s=s=>{s instanceof Array?t.resources=s:t.resource=s,this._loader.patch(t,this),this.fire("load",t),this.fire("load:"+t.id,t),e&&e.url&&this.fire("load:url:"+e.url,t),t.fire("load",t)},i=(e,i,n)=>{if(t.loaded=!0,t.loading=!1,e)this.fire("error",e,t),this.fire("error:"+t.id,e,t),t.fire("error",e,t);else{if(!qo.legacy&&"script"===t.type){const e=this._loader.getHandler("script");e._cache[t.id]&&e._cache[t.id].parentNode===document.head&&document.head.removeChild(e._cache[t.id]),e._cache[t.id]=n}s(i)}};if(e||"cubemap"===t.type)this.fire("load:start",t),this.fire("load:"+t.id+":start",t),t.loading=!0,this._loader.load(t.getFileUrl(),t.type,i,t);else{const e=this._loader.open(t.type,t.data);t.loaded=!0,s(e)}}loadFromUrl(t,e,s){this.loadFromUrlAndFilename(t,null,e,s)}loadFromUrlAndFilename(t,e,s,i){const n=u.getBasename(e||t),r={filename:e||n,url:t};let a=this.getByUrl(t);if(a){if(a.loaded)return void i(a.loadFromUrlError||null,a)}else a=new cl(n,s,r),this.add(a);const o=t=>{t.once("load",(t=>{"material"===s?this._loadTextures(t,((e,s)=>{i(e,t)})):i(null,t)})),t.once("error",(e=>{e&&(this.loadFromUrlError=e),i(e,t)})),this.load(t)};a.resource?i(null,a):"model"===s?this._loadModel(a,o):o(a)}_loadModel(t,e){const s=t.getFileUrl(),i=u.getExtension(s);if(".json"===i||".glb"===i){const n=u.getDirectory(s),r=u.getBasename(s),a=u.join(n,r.replace(i,".mapping.json"));this._loader.load(a,"json",((s,i)=>{s?(t.data={mapping:[]},e(t)):this._loadMaterials(t,i,((s,n)=>{t.data=i,e(t)}))}))}else e(t)}_loadMaterials(t,e,s){const i=[];let n=0;const r=(t,e)=>{this._loadTextures(e,((t,r)=>{i.push(e),i.length===n&&s(null,i)}))};for(let s=0;s<e.mapping.length;s++){const i=e.mapping[s].path;if(i){n++;const e=t.getAbsoluteUrl(i);this.loadFromUrl(e,"material",r)}}0===n&&s(null,i)}_loadTextures(t,e){const s=[];let i=0;const n=t.data;if("path"!==n.mappingFormat)return void e(null,s);const r=(t,n)=>{t&&console.error(t),s.push(n),s.length===i&&e(null,s)},a=Ea;for(let e=0;e<a.length;e++){const s=n[a[e]];if(s&&"string"==typeof s){i++;const e=t.getAbsoluteUrl(s);this.loadFromUrl(e,"texture",r)}}0===i&&e(null,s)}_onTagAdd(t,e){this._tags.add(t,e)}_onTagRemove(t,e){this._tags.remove(t,e)}findByTag(){return this._tags.find(arguments)}filter(t){return Array.from(this._assets).filter((e=>t(e)))}find(t,e){var s;return null!=(s=Array.from(this._assets).find((s=>s.name===t&&(!e||s.type===e))))?s:null}findAll(t,e){return Array.from(this._assets).filter((s=>s.name===t&&(!e||s.type===e)))}}class pl{constructor(t){this._assets=t,this._bundleAssets={},this._assetsInBundles={},this._urlsInBundles={},this._fileRequests={},this._assets.on("add",this._onAssetAdded,this),this._assets.on("remove",this._onAssetRemoved,this)}_onAssetAdded(t){if("bundle"===t.type){this._bundleAssets[t.id]=t,this._registerBundleEventListeners(t.id);for(let e=0,s=t.data.assets.length;e<s;e++)this._indexAssetInBundle(t.data.assets[e],t)}else this._assetsInBundles[t.id]&&this._indexAssetFileUrls(t)}_registerBundleEventListeners(t){this._assets.on("load:"+t,this._onBundleLoaded,this),this._assets.on("error:"+t,this._onBundleError,this)}_unregisterBundleEventListeners(t){this._assets.off("load:"+t,this._onBundleLoaded,this),this._assets.off("error:"+t,this._onBundleError,this)}_indexAssetInBundle(t,e){if(this._assetsInBundles[t]){const s=this._assetsInBundles[t];-1===s.indexOf(e)&&s.push(e)}else this._assetsInBundles[t]=[e];const s=this._assets.get(t);s&&this._indexAssetFileUrls(s)}_indexAssetFileUrls(t){const e=this._getAssetFileUrls(t);if(e)for(let s=0,i=e.length;s<i;s++){const i=e[s];this._urlsInBundles[i]=this._assetsInBundles[t.id]}}_getAssetFileUrls(t){let e=t.getFileUrl();if(!e)return null;e=this._normalizeUrl(e);const s=[e];if("font"===t.type){const i=t.data.info.maps.length;for(let t=1;t<i;t++)s.push(e.replace(".png",t+".png"))}return s}_normalizeUrl(t){return t&&t.split("?")[0]}_onAssetRemoved(t){if("bundle"===t.type){delete this._bundleAssets[t.id],this._unregisterBundleEventListeners(t.id);for(const e in this._assetsInBundles){const s=this._assetsInBundles[e],i=s.indexOf(t);if(-1!==i&&(s.splice(i,1),!s.length)){delete this._assetsInBundles[e];for(const t in this._urlsInBundles)this._urlsInBundles[t]===s&&delete this._urlsInBundles[t]}}this._onBundleError(`Bundle ${t.id} was removed`,t)}else if(this._assetsInBundles[t.id]){delete this._assetsInBundles[t.id];const e=this._getAssetFileUrls(t);for(let t=0,s=e.length;t<s;t++)delete this._urlsInBundles[e[t]]}}_onBundleLoaded(t){t.resource?requestAnimationFrame((()=>{if(this._fileRequests)for(const e in this._fileRequests){const s=this._urlsInBundles[e];if(!s||-1===s.indexOf(t))continue;const i=decodeURIComponent(e);let n=null;t.resource.hasBlobUrl(i)||(n=`Bundle ${t.id} does not contain URL ${e}`);const r=this._fileRequests[e];for(let e=0,s=r.length;e<s;e++)n?r[e](n):r[e](null,t.resource.getBlobUrl(i));delete this._fileRequests[e]}})):this._onBundleError(`Bundle ${t.id} failed to load`,t)}_onBundleError(t,e){for(const e in this._fileRequests){if(!this._findLoadedOrLoadingBundleForUrl(e)){const s=this._fileRequests[e];for(let e=0,i=s.length;e<i;e++)s[e](t);delete this._fileRequests[e]}}}_findLoadedOrLoadingBundleForUrl(t){const e=this._urlsInBundles[t];if(!e)return null;const s=e.length;for(let t=0;t<s;t++)if(e[t].loaded&&e[t].resource)return e[t];for(let t=0;t<s;t++)if(e[t].loading)return e[t];return null}listBundlesForAsset(t){return this._assetsInBundles[t.id]||null}list(){const t=[];for(const e in this._bundleAssets)t.push(this._bundleAssets[e]);return t}hasUrl(t){return!!this._urlsInBundles[t]}canLoadUrl(t){return!!this._findLoadedOrLoadingBundleForUrl(t)}loadUrl(t,e){const s=this._findLoadedOrLoadingBundleForUrl(t);if(s)if(s.loaded){const i=decodeURIComponent(t);if(!s.resource.hasBlobUrl(i))return void e(`Bundle ${s.id} does not contain URL ${t}`);e(null,s.resource.getBlobUrl(i))}else this._fileRequests.hasOwnProperty(t)?this._fileRequests[t].push(e):this._fileRequests[t]=[e];else e(`URL ${t} not found in any bundles`)}destroy(){this._assets.off("add",this._onAssetAdded,this),this._assets.off("remove",this._onAssetRemoved,this);for(const t in this._bundleAssets)this._unregisterBundleEventListeners(t);this._assets=null,this._bundleAssets=null,this._assetsInBundles=null,this._urlsInBundles=null,this._fileRequests=null}}class fl extends h{constructor(){super(),this.anim=void 0,this.animation=void 0,this.audiolistener=void 0,this.audiosource=void 0,this.button=void 0,this.camera=void 0,this.collision=void 0,this.element=void 0,this.joint=void 0,this.layoutchild=void 0,this.layoutgroup=void 0,this.light=void 0,this.model=void 0,this.particlesystem=void 0,this.render=void 0,this.rigidbody=void 0,this.screen=void 0,this.script=void 0,this.scrollbar=void 0,this.scrollview=void 0,this.sound=void 0,this.sprite=void 0,this.zone=void 0,this.list=[]}add(t){const e=t.id;if(this[e])throw new Error(`ComponentSystem name '${e}' already registered or not allowed`);this[e]=t,this.list.push(t)}remove(t){const e=t.id;if(!this[e])throw new Error(`No ComponentSystem named '${e}' registered`);delete this[e];const s=this.list.indexOf(this[e]);-1!==s&&this.list.splice(s,1)}destroy(){this.off();for(let t=0;t<this.list.length;t++)this.list[t].destroy()}}class ml{constructor(t){this._blobUrls={};for(let e=0,s=t.length;e<s;e++)t[e].url&&(this._blobUrls[t[e].name]=t[e].url)}hasBlobUrl(t){return!!this._blobUrls[t]}getBlobUrl(t){return this._blobUrls[t]}destroy(){for(const t in this._blobUrls)URL.revokeObjectURL(this._blobUrls[t]);this._blobUrls=null}}let gl;function _l(t){let e,s;if("undefined"!=typeof TextDecoder)try{e=new TextDecoder("utf-8"),s=new TextDecoder("windows-1252")}catch(t){console.warn("TextDecoder not supported - pc.Untar module will not work")}else console.warn("TextDecoder not supported - pc.Untar module will not work");function i(t){this._fields=t}function n(t){this._arrayBuffer=t||new ArrayBuffer(0),this._bufferView=new DataView(this._arrayBuffer),this._globalPaxHeader=null,this._paxHeader=null,this._bytesRead=0}i.parse=function(t,s,n){const r=new Uint8Array(t,s,n);let a=0;const o=[];for(;a<n;){let i;for(i=a;i<n&&32!==r[i];i++);if(i>=n)throw new Error("Invalid PAX header data format.");const l=parseInt(e.decode(new Uint8Array(t,s+a,i-a)),10),h=e.decode(new Uint8Array(t,s+i+1,l-(i-a)-2)).split("=");if(2!==h.length)throw new Error("Invalid PAX header data format.");0===h[1].length&&(h[1]=null),o.push({name:h[0],value:h[1]}),a+=l}return new i(o)},i.prototype.applyHeader=function(t){for(let e=0;e<this._fields.length;e++){let s=this._fields[e].name;const i=this._fields[e].value;"path"===s&&(s="name"),null===i?delete t[s]:t[s]=i}},t||(gl=n),n.prototype._hasNext=function(){return this._bytesRead+4<this._arrayBuffer.byteLength&&0!==this._bufferView.getUint32(this._bytesRead)},n.prototype._readNextFile=function(){const e=new DataView(this._arrayBuffer,this._bytesRead,512),n=s.decode(e);this._bytesRead+=512;let r=n.substring(0,100).replace(/\0/g,"");const a=n.substring(257,263),o=parseInt(n.substring(124,136),8),l=n.substring(156,157),h=this._bytesRead;let c=null,d=!1;switch(l){case"0":case"":if(d=!0,!t){const t=new Blob([this._arrayBuffer.slice(this._bytesRead,this._bytesRead+o)]);c=URL.createObjectURL(t)}break;case"g":this._globalPaxHeader=i.parse(this._arrayBuffer,this._bytesRead,o);break;case"x":this._paxHeader=i.parse(this._arrayBuffer,this._bytesRead,o)}this._bytesRead+=o;const u=o%512;if(0!==u&&(this._bytesRead+=512-u),!d)return null;if(-1!==a.indexOf("ustar")){const t=n.substring(345,500).replace(/\0/g,"");t.length>0&&(r=t.trim()+r.trim())}const p={name:r,start:h,size:o,url:c};return this._globalPaxHeader&&this._globalPaxHeader.applyHeader(p),this._paxHeader&&(this._paxHeader.applyHeader(p),this._paxHeader=null),p},n.prototype.untar=function(t){if(!e)return console.error("Cannot untar because TextDecoder interface is not available for this platform."),[];const s=[];for(;this._hasNext();){const e=this._readNextFile();e&&(t&&e.name&&(e.name=t+e.name),s.push(e))}return s},t&&(self.onmessage=function(t){const e=t.data.id;try{const s=new n(t.data.arrayBuffer).untar(t.data.prefix);postMessage({id:e,files:s,arrayBuffer:t.data.arrayBuffer},[t.data.arrayBuffer])}catch(t){postMessage({id:e,error:t.toString()})}})}let vl=null;class bl{constructor(t){this._requestId=0,this._pendingRequests={},this._filenamePrefix=t,this._worker=new Worker(function(){if(!vl){const t="("+_l.toString()+")(true)\n\n",e=new Blob([t],{type:"application/javascript"});vl=URL.createObjectURL(e)}return vl}()),this._worker.addEventListener("message",this._onMessage.bind(this))}_onMessage(t){const e=t.data.id;if(!this._pendingRequests[e])return;const s=this._pendingRequests[e];if(delete this._pendingRequests[e],t.data.error)s(t.data.error);else{const e=t.data.arrayBuffer;for(let s=0,i=t.data.files.length;s<i;s++){const i=t.data.files[s],n=new Blob([e.slice(i.start,i.start+i.size)]);i.url=URL.createObjectURL(n)}s(null,t.data.files)}}untar(t,e){const s=this._requestId++;this._pendingRequests[s]=e,this._worker.postMessage({id:s,prefix:this._filenamePrefix,arrayBuffer:t},[t])}hasPendingRequests(){return Object.keys(this._pendingRequests).length>0}destroy(){this._worker&&(this._worker.terminate(),this._worker=null,this._pendingRequests=null)}}_l();class yl{constructor(t){this.handlerType="bundle",this._assets=t.assets,this._worker=null,this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s=this;Js.get(t.load,{responseType:Qs.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(i,n){if(i)e("Error loading bundle resource "+t.original+": "+i);else try{s._untar(n,e)}catch(s){e("Error loading bundle resource "+t.original+": "+s)}}))}_untar(t,e){const s=this;if(w.workers)s._worker||(s._worker=new bl(s._assets.prefix)),s._worker.untar(t,(function(t,i){e(t,i),s._worker.hasPendingRequests()||(s._worker.destroy(),s._worker=null)}));else{const i=new gl(t).untar(s._assets.prefix);e(null,i)}}open(t,e){return new ml(e)}patch(t,e){}}class xl{constructor(t){this._handlers={},this._requests={},this._cache={},this._app=t}addHandler(t,e){this._handlers[t]=e,e._loader=this}removeHandler(t){delete this._handlers[t]}getHandler(t){return this._handlers[t]}static makeKey(t,e){return`${t}-${e}`}load(t,e,s,i){const n=this._handlers[e];if(!n){return void s(`No resource handler for asset type: '${e}' when loading [${t}]`)}if(!t)return void this._loadNull(n,s,i);const r=xl.makeKey(t,e);if(void 0!==this._cache[r])s(null,this._cache[r]);else if(this._requests[r])this._requests[r].push(s);else{this._requests[r]=[s];const e=this,a=function(t,s){t?e._onFailure(r,t):n.load(s,(function(t,a,o){if(e._requests[r])if(t)e._onFailure(r,t);else try{e._onSuccess(r,n.open(s.original,a,i),o)}catch(t){e._onFailure(r,t)}}),i)},o=t.split("?")[0];if(this._app.enableBundles&&this._app.bundles.hasUrl(o)){if(!this._app.bundles.canLoadUrl(o))return void a(`Bundle for ${t} not loaded yet`);this._app.bundles.loadUrl(o,(function(t,e){a(t,{load:e,original:o})}))}else a(null,{load:t,original:i&&i.file.filename||t})}}_loadNull(t,e,s){t.load(null,(function(i,n,r){if(i)e(i);else try{e(null,t.open(null,n,s),r)}catch(t){e(t)}}),s)}_onSuccess(t,e,s){null!==e?this._cache[t]=e:delete this._cache[t];for(let i=0;i<this._requests[t].length;i++)this._requests[t][i](null,e,s);delete this._requests[t]}_onFailure(t,e){if(console.error(e),this._requests[t]){for(let s=0;s<this._requests[t].length;s++)this._requests[t][s](e);delete this._requests[t]}}open(t,e){const s=this._handlers[t];return s?s.open(null,e):(console.warn("No resource handler found for: "+t),e)}patch(t,e){const s=this._handlers[t.type];s?s.patch&&s.patch(t,e):console.warn("No resource handler found for: "+t.type)}clearCache(t,e){const s=xl.makeKey(t,e);delete this._cache[s]}getFromCache(t,e){const s=xl.makeKey(t,e);if(this._cache[s])return this._cache[s]}enableRetry(t=5){t=Math.max(0,t)||0;for(const e in this._handlers)this._handlers[e].maxRetries=t}disableRetry(){for(const t in this._handlers)this._handlers[t].maxRetries=0}destroy(){this._handlers={},this._requests={},this._cache={}}}class wl{_validate(t){if(!t.header)throw new Error('pc.I18n#addData: Missing "header" field');if(!t.header.version)throw new Error('pc.I18n#addData: Missing "header.version" field');if(1!==t.header.version)throw new Error('pc.I18n#addData: Invalid "header.version" field');if(!t.data)throw new Error('pc.I18n#addData: Missing "data" field');if(!Array.isArray(t.data))throw new Error('pc.I18n#addData: "data" field must be an array');for(let e=0,s=t.data.length;e<s;e++){const s=t.data[e];if(!s.info)throw new Error(`pc.I18n#addData: missing "data[${e}].info" field`);if(!s.info.locale)throw new Error(`pc.I18n#addData: missing "data[${e}].info.locale" field`);if("string"!=typeof s.info.locale)throw new Error(`pc.I18n#addData: "data[${e}].info.locale" must be a string`);if(!s.messages)throw new Error(`pc.I18n#addData: missing "data[${e}].messages" field`)}}parse(t){return t.data}}class Sl extends h{constructor(t){super(),this.locale=Qo,this._translations={},this._availableLangs={},this._app=t,this._assets=[],this._parser=new wl}set assets(t){const e={};for(let s=0,i=t.length;s<i;s++){e[t[s]instanceof cl?t[s].id:t[s]]=!0}let s=this._assets.length;for(;s--;){const t=this._assets[s];if(!e[t]){this._app.assets.off("add:"+t,this._onAssetAdd,this);const e=this._app.assets.get(t);e&&this._onAssetRemove(e),this._assets.splice(s,1)}}for(const t in e){const e=parseInt(t,10);if(-1!==this._assets.indexOf(e))continue;this._assets.push(e);const s=this._app.assets.get(e);s?this._onAssetAdd(s):this._app.assets.once("add:"+e,this._onAssetAdd,this)}}get assets(){return this._assets}set locale(t){if(this._locale===t)return;let e=el(t);if("in"===e&&(e="id",t=function(t,e){const s=t.indexOf("-");return-1!==s?e+t.substring(s):e}(t,e),this._locale===t))return;const s=this._locale;this._locale=t,this._lang=e,this._pluralFn=nl(this._lang),this.fire("set:locale",t,s)}get locale(){return this._locale}static findAvailableLocale(t,e){return sl(t,e)}findAvailableLocale(t){if(this._translations[t])return t;const e=el(t);return this._findFallbackLocale(t,e)}getText(t,e){let s,i=t;e||(e=this._locale,s=this._lang);let n=this._translations[e];return n||(s||(s=el(e)),e=this._findFallbackLocale(e,s),n=this._translations[e]),n&&n.hasOwnProperty(t)&&(i=n[t],Array.isArray(i)&&(i=i[0]),null==i&&(i=t)),i}getPluralText(t,e,s){let i,n,r=t;s?(i=el(s),n=nl(i)):(s=this._locale,i=this._lang,n=this._pluralFn);let a=this._translations[s];if(a||(i=el(s=this._findFallbackLocale(s,i)),n=nl(i),a=this._translations[s]),a&&a[t]&&n){const s=n(e);r=a[t][s],null==r&&(r=t)}return r}addData(t){let e;try{e=this._parser.parse(t)}catch(t){return void console.error(t)}for(let t=0,s=e.length;t<s;t++){const s=e[t],i=s.info.locale,n=s.messages;if(!this._translations[i]){this._translations[i]={};const t=el(i);this._availableLangs[t]||(this._availableLangs[t]=i)}Object.assign(this._translations[i],n),this.fire("data:add",i,n)}}removeData(t){let e;try{e=this._parser.parse(t)}catch(t){return void console.error(t)}for(let t=0,s=e.length;t<s;t++){const s=e[t],i=s.info.locale,n=this._translations[i];if(!n)continue;const r=s.messages;for(const t in r)delete n[t];0===Object.keys(n).length&&(delete this._translations[i],delete this._availableLangs[el(i)]),this.fire("data:remove",i,r)}}destroy(){this._translations=null,this._availableLangs=null,this._assets=null,this._parser=null,this.off()}_findFallbackLocale(t,e){let s=Jo[t];return s&&this._translations[s]?s:(s=Jo[e],s&&this._translations[s]?s:(s=this._availableLangs[e],s&&this._translations[s]?s:Qo))}_onAssetAdd(t){t.on("load",this._onAssetLoad,this),t.on("change",this._onAssetChange,this),t.on("remove",this._onAssetRemove,this),t.on("unload",this._onAssetUnload,this),t.resource&&this._onAssetLoad(t)}_onAssetLoad(t){this.addData(t.resource)}_onAssetChange(t){t.resource&&this.addData(t.resource)}_onAssetRemove(t){t.off("load",this._onAssetLoad,this),t.off("change",this._onAssetChange,this),t.off("remove",this._onAssetRemove,this),t.off("unload",this._onAssetUnload,this),t.resource&&this.removeData(t.resource),this._app.assets.once("add:"+t.id,this._onAssetAdd,this)}_onAssetUnload(t){t.resource&&this.removeData(t.resource)}}class Cl extends h{constructor(t){super(),this.app=t,this._scripts={},this._list=[]}destroy(){this.app=null,this.off()}add(t){const e=t.__name;return this._scripts.hasOwnProperty(e)?(setTimeout((()=>{if(t.prototype.swap){const s=this._scripts[e],i=this._list.indexOf(s);this._list[i]=t,this._scripts[e]=t,this.fire("swap",e,t),this.fire("swap:"+e,t)}else console.warn(`script registry already has '${e}' script, define 'swap' method for new script type to enable code hot swapping`)})),!1):(this._scripts[e]=t,this._list.push(t),this.fire("add",e,t),this.fire("add:"+e,t),setTimeout((()=>{if(!this._scripts.hasOwnProperty(e))return;if(!this.app||!this.app.systems||!this.app.systems.script)return;const t=this.app.systems.script._components;let s;const i=[],n=[];for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){const n=t.items[t.loopIndex];if(n._scriptsIndex[e]&&n._scriptsIndex[e].awaiting){n._scriptsData&&n._scriptsData[e]&&(s=n._scriptsData[e].attributes);const t=n.create(e,{preloading:!0,ind:n._scriptsIndex[e].ind,attributes:s});t&&i.push(t)}}for(let t=0;t<i.length;t++)i[t].__initializeAttributes();for(let t=0;t<i.length;t++)i[t].enabled&&(i[t]._initialized=!0,n.push(i[t]),i[t].initialize&&i[t].initialize());for(let t=0;t<n.length;t++)n[t].enabled&&!n[t]._postInitialized&&(n[t]._postInitialized=!0,n[t].postInitialize&&n[t].postInitialize())})),!0)}remove(t){let e=t,s=t;if("string"!=typeof s?s=e.__name:e=this.get(s),this.get(s)!==e)return!1;delete this._scripts[s];const i=this._list.indexOf(e);return this._list.splice(i,1),this.fire("remove",s,e),this.fire("remove:"+s,e),!0}get(t){return this._scripts[t]||null}has(t){if("string"==typeof t)return this._scripts.hasOwnProperty(t);if(!t)return!1;const e=t.__name;return this._scripts[e]===t}list(){return this._list}}const Tl=[];class El extends gn{constructor(t,e=Vo()){super(t),this.anim=void 0,this.animation=void 0,this.audiolistener=void 0,this.button=void 0,this.camera=void 0,this.collision=void 0,this.element=void 0,this.layoutchild=void 0,this.layoutgroup=void 0,this.light=void 0,this.model=void 0,this.particlesystem=void 0,this.render=void 0,this.rigidbody=void 0,this.screen=void 0,this.script=void 0,this.scrollbar=void 0,this.scrollview=void 0,this.sound=void 0,this.sprite=void 0,this.c={},this._app=void 0,this._destroying=!1,this._guid=null,this._template=!1,this._app=e}addComponent(t,e){const s=this._app.systems[t];return s?this.c[t]?null:s.addComponent(this,e):null}removeComponent(t){const e=this._app.systems[t];e&&this.c[t]&&e.removeComponent(this)}findComponent(t){const e=this.findOne((function(e){return e.c&&e.c[t]}));return e&&e.c[t]}findComponents(t){return this.find((function(e){return e.c&&e.c[t]})).map((function(e){return e.c[t]}))}getGuid(){return this._guid||this.setGuid(d()),this._guid}setGuid(t){const e=this._app._entityIndex;this._guid&&delete e[this._guid],this._guid=t,e[this._guid]=this}_notifyHierarchyStateChanged(t,e){let s=!1;t===this&&0===Tl.length&&(s=!0),t._beingEnabled=!0,t._onHierarchyStateChanged(e),t._onHierarchyStatePostChanged&&Tl.push(t);const i=t._children;for(let t=0,s=i.length;t<s;t++)i[t]._enabled&&this._notifyHierarchyStateChanged(i[t],e);if(t._beingEnabled=!1,s){for(let t=0;t<Tl.length;t++)Tl[t]._onHierarchyStatePostChanged();Tl.length=0}}_onHierarchyStateChanged(t){super._onHierarchyStateChanged(t);const e=this.c;for(const s in e)if(e.hasOwnProperty(s)){const i=e[s];i.enabled&&(t?i.onEnable():i.onDisable())}}_onHierarchyStatePostChanged(){const t=this.c;for(const e in t)t.hasOwnProperty(e)&&t[e].onPostStateChange()}findByGuid(t){if(this._guid===t)return this;const e=this._app._entityIndex[t];return e&&(e===this||e.isDescendantOf(this))?e:null}destroy(){this._destroying=!0;for(const t in this.c)this.c[t].enabled=!1;for(const t in this.c)this.c[t].system.removeComponent(this);this._parent&&this._parent.removeChild(this);const t=this._children;for(;t.length;){const e=t.pop();e._parent=null,e instanceof El&&e.destroy()}this.fire("destroy",this),this.off(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=!1}clone(){const t={},e=this._cloneRecursively(t);return t[this.getGuid()]=e,Pl(this,this,e,t),e}_cloneRecursively(t){const e=new this.constructor(void 0,this._app);super._cloneInternal(e);for(const t in this.c){this.c[t].system.cloneComponent(this,e)}for(let s=0;s<this._children.length;s++){const i=this._children[s];if(i instanceof El){const s=i._cloneRecursively(t);e.addChild(s),t[i.getGuid()]=s}}return e}}function Pl(t,e,s,i){if(e instanceof El){const n=e.c;for(const e in n){const r=n[e],a=r.system.getPropertiesOfType("entity");for(let n=0,o=a.length;n<o;n++){const o=a[n].name,l=r[o];if(!!t.findByGuid(l)){const t=i[l].getGuid();t&&(s.c[e][o]=t)}}}n.script&&!s._app.useLegacyScriptAttributeCloning&&s.script.resolveDuplicatedEntityReferenceProperties(n.script,i),n.render&&s.render.resolveDuplicatedEntityReferenceProperties(n.render,i),n.anim&&s.anim.resolveDuplicatedEntityReferenceProperties(n.anim,i);const r=e.children.filter((function(t){return t instanceof El})),a=s.children.filter((function(t){return t instanceof El}));for(let e=0,s=r.length;e<s;e++)Pl(t,r[e],a[e],i)}}class Ml{constructor(t,e){this.name=t,this.url=e,this.data=null,this._loading=!1,this._onLoadedCallbacks=[]}get loaded(){return!!this.data}get loading(){return this._loading}}class Al{constructor(t){this._app=t,this._list=[],this._index={},this._urlIndex={}}destroy(){this._app=null}list(){return this._list}add(t,e){if(this._index.hasOwnProperty(t))return!1;const s=new Ml(t,e),i=this._list.push(s);return this._index[s.name]=i-1,this._urlIndex[s.url]=i-1,!0}find(t){return this._index.hasOwnProperty(t)?this._list[this._index[t]]:null}findByUrl(t){return this._urlIndex.hasOwnProperty(t)?this._list[this._urlIndex[t]]:null}remove(t){if(this._index.hasOwnProperty(t)){const e=this._index[t];let s=this._list[e];delete this._urlIndex[s.url],delete this._index[t],this._list.splice(e,1);for(let t=0;t<this._list.length;t++)s=this._list[t],this._index[s.name]=t,this._urlIndex[s.url]=t}}_loadSceneData(t,e,s){const i=this._app;let n=t;if("string"==typeof t&&(t=this.findByUrl(n)||this.find(n)||new Ml("Untitled",n)),n=t.url,n)if(t.loaded)s(null,t);else{if(i.assets&&i.assets.prefix&&!rl.test(n)&&(n=u.join(i.assets.prefix,n)),t._onLoadedCallbacks.push(s),!t._loading){i.loader.getHandler("hierarchy").load(n,((s,i)=>{t.data=i,t._loading=!1;for(let e=0;e<t._onLoadedCallbacks.length;e++)t._onLoadedCallbacks[e](s,t);e||(t.data=null),t._onLoadedCallbacks.length=0}))}t._loading=!0}else s("Cannot find scene to load")}loadSceneData(t,e){this._loadSceneData(t,!0,e)}unloadSceneData(t){"string"==typeof t&&(t=this.findByUrl(t)),t&&(t.data=null)}_loadSceneHierarchy(t,e,s){this._loadSceneData(t,!1,((t,i)=>{if(t)return void(s&&s(t));e&&e(i);const n=this._app;n._preloadScripts(i.data,(()=>{const t=n.loader.getHandler("hierarchy");n.systems.script.preloading=!0;const e=t.open(i.url,i.data);n.systems.script.preloading=!1,n.loader.clearCache(i.url,"hierarchy"),n.root.addChild(e),n.systems.fire("initialize",e),n.systems.fire("postInitialize",e),n.systems.fire("postPostInitialize",e),s&&s(null,e)}))}))}loadSceneHierarchy(t,e){this._loadSceneHierarchy(t,null,e)}loadSceneSettings(t,e){this._loadSceneData(t,!1,((t,s)=>{t?e&&e(t):(this._app.applySceneSettings(s.data.settings),e&&e(null))}))}changeScene(t,e){const s=this._app;this._loadSceneHierarchy(t,(t=>{const e=s.root.children;for(;e.length>0;){const t=e[0];t.reparent(null),null==t.destroy||t.destroy()}s.applySceneSettings(t.data.settings)}),e)}loadScene(t,e){const s=this._app,i=s.loader.getHandler("scene");s.assets&&s.assets.prefix&&!rl.test(t)&&(t=u.join(s.assets.prefix,t)),i.load(t,((n,r)=>{if(n)e&&e(n);else{const n=()=>{s.systems.script.preloading=!0;const n=i.open(t,r),a=this.findByUrl(t);a&&!a.loaded&&(a.data=r),s.systems.script.preloading=!1,s.loader.clearCache(t,"scene"),s.loader.patch({resource:n,type:"scene"},s.assets),s.root.addChild(n.root),s.systems.rigidbody&&"undefined"!=typeof Ammo&&s.systems.rigidbody.gravity.set(n._gravity.x,n._gravity.y,n._gravity.z),e&&e(null,n)};s._preloadScripts(r,n)}}))}}class kl{constructor(t){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,lightClustersTime:0,lightClusters:0,_timeToCountFrames:0,_fpsAccum:0},this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0},this.misc={renderTargetCreationTime:0},this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0},this.shaders=t._shaderStats,this.vram=t._vram,Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}}),Object.defineProperty(this.vram,"geom",{get:function(){return this.vb+this.ib}})}get scene(){return Vo().scene._stats}get lightmapper(){var t;return null==(t=Vo().lightmapper)?void 0:t.stats}get batcher(){const t=Vo()._batcher;return t?t._stats:null}}class Dl{constructor(t){this.length=t,this.count=0}inc(){this.count++}done(){return this.count===this.length}}class Rl extends h{constructor(t){super(),Rl._applications[t.id]=this,Ho(this),this._destroyRequested=!1,this._inFrameUpdate=!1,this._time=0,this.timeScale=1,this.maxDeltaTime=.1,this.frame=0,this.autoRender=!0,this.renderNextFrame=!1,this.useLegacyScriptAttributeCloning=qo.legacy,this._librariesLoaded=!1,this._fillMode=zo,this._resolutionMode="FIXED",this._allowResize=!0,this.context=this}init(t){const e=t.graphicsDevice;this.graphicsDevice=e,oi.set(e),this._initDefaultMaterial(),this._initProgramLibrary(),this.stats=new kl(e),this._soundManager=t.soundManager,this.loader=new xl(this),Wn.init(e),this._entityIndex={},this.scene=new Io(e),this._registerSceneImmediate(this.scene),this.root=new El,this.root._enabledInHierarchy=!0,this.assets=new ul(this.loader),t.assetPrefix&&(this.assets.prefix=t.assetPrefix),this.bundles=new pl(this.assets),this.enableBundles="undefined"!=typeof TextDecoder,this.scriptsOrder=t.scriptsOrder||[],this.scripts=new Cl(this),this.i18n=new Sl(this),this.scenes=new Al(this);const s=this;this.defaultLayerWorld=new Qa({name:"World",id:0}),this.sceneGrab=new to(this.graphicsDevice,this.scene),this.defaultLayerDepth=this.sceneGrab.layer,this.defaultLayerSkybox=new Qa({enabled:!0,name:"Skybox",id:2,opaqueSortMode:0}),this.defaultLayerUi=new Qa({enabled:!0,name:"UI",id:4,transparentSortMode:1,passThrough:!1}),this.defaultLayerImmediate=new Qa({enabled:!0,name:"Immediate",id:3,opaqueSortMode:0,passThrough:!0});const i=new uo("default");i.pushOpaque(this.defaultLayerWorld),i.pushOpaque(this.defaultLayerDepth),i.pushOpaque(this.defaultLayerSkybox),i.pushTransparent(this.defaultLayerWorld),i.pushOpaque(this.defaultLayerImmediate),i.pushTransparent(this.defaultLayerImmediate),i.pushTransparent(this.defaultLayerUi),this.scene.layers=i,this.scene.on("set:layers",(function(t,e){const i=e.layerList;let n;for(let t=0;t<i.length;t++)switch(n=i[t],n.id){case 1:s.sceneGrab.patch(n);break;case 4:n.passThrough=s.defaultLayerUi.passThrough;break;case 3:n.passThrough=s.defaultLayerImmediate.passThrough}})),Yo.createPlaceholder(e),this.renderer=new io(e),this.renderer.scene=this.scene,this.frameGraph=new Xo,this.lightmapper=null,t.lightmapper&&(this.lightmapper=new t.lightmapper(e,this.root,this.scene,this.renderer,this.assets),this.once("prerender",this._firstBake,this)),this._batcher=null,t.batchManager&&(this._batcher=new t.batchManager(e,this.root,this.scene),this.once("prerender",this._firstBatch,this)),this.keyboard=t.keyboard||null,this.mouse=t.mouse||null,this.touch=t.touch||null,this.gamepads=t.gamepads||null,this.elementInput=t.elementInput||null,this.elementInput&&(this.elementInput.app=this),this.xr=t.xr?new t.xr(this):null,this.elementInput&&this.elementInput.attachSelectEvents(),this._inTools=!1,this._skyboxAsset=null,this._scriptPrefix=t.scriptPrefix||"",this.enableBundles&&this.loader.addHandler("bundle",new yl(this)),t.resourceHandlers.forEach((t=>{const e=new t(this);this.loader.addHandler(e.handlerType,e)})),this.systems=new fl,t.componentSystems.forEach((t=>{this.systems.add(new t(this))})),this._visibilityChangeHandler=this.onVisibilityChange.bind(this),"undefined"!=typeof document&&(void 0!==document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1))),this.tick=Il(this)}static getApplication(t){return t?Rl._applications[t]:Vo()}_initDefaultMaterial(){const t=new Da;t.name="Default Material",t.shadingModel=1,function(t,e){ji.get(t,(()=>e))}(this.graphicsDevice,t)}_initProgramLibrary(){const t=new Fo(this.graphicsDevice,new Da);!function(t,e){Pi.get(t,(()=>e))}(this.graphicsDevice,t)}get soundManager(){return this._soundManager}get batcher(){return this._batcher}get fillMode(){return this._fillMode}get resolutionMode(){return this._resolutionMode}configure(t,e){Js.get(t,((t,s)=>{if(t)return void e(t);const i=s.application_properties,n=s.scenes,r=s.assets;this._parseApplicationProperties(i,(t=>{this._parseScenes(n),this._parseAssets(r),e(t||null)}))}))}preload(t){this.fire("preload:start");const e=this.assets.list({preload:!0}),s=new Dl(e.length);let i=!1;const n=()=>{this.graphicsDevice&&!i&&s.done()&&(i=!0,this.fire("preload:end"),t())},r=e.length;if(s.length){const t=t=>{s.inc(),this.fire("preload:progress",s.count/r),s.done()&&n()},i=(t,e)=>{s.inc(),this.fire("preload:progress",s.count/r),s.done()&&n()};for(let a=0;a<e.length;a++)e[a].loaded?(s.inc(),this.fire("preload:progress",s.count/r),s.done()&&n()):(e[a].once("load",t),e[a].once("error",i),this.assets.load(e[a]))}else n()}_preloadScripts(t,e){if(!qo.legacy)return void e();this.systems.script.preloading=!0;const s=this._getScriptReferences(t),i=s.length,n=new Dl(i),r=/^http(s)?:\/\//;if(i){const t=(t,s)=>{t&&console.error(t),n.inc(),n.done()&&(this.systems.script.preloading=!1,e())};for(let e=0;e<i;e++){let i=s[e];!r.test(i.toLowerCase())&&this._scriptPrefix&&(i=u.join(this._scriptPrefix,s[e])),this.loader.load(i,"script",t)}}else this.systems.script.preloading=!1,e()}_parseApplicationProperties(t,e){if("number"==typeof t.maxAssetRetries&&t.maxAssetRetries>0&&this.loader.enableRetry(t.maxAssetRetries),t.useDevicePixelRatio||(t.useDevicePixelRatio=t.use_device_pixel_ratio),t.resolutionMode||(t.resolutionMode=t.resolution_mode),t.fillMode||(t.fillMode=t.fill_mode),this._width=t.width,this._height=t.height,t.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(t.resolutionMode,this._width,this._height),this.setCanvasFillMode(t.fillMode,this._width,this._height),t.layers&&t.layerOrder){const e=new uo("application"),s={};for(const e in t.layers){const i=t.layers[e];i.id=parseInt(e,10),i.enabled=1!==i.id,s[e]=new Qa(i)}for(let i=0,n=t.layerOrder.length;i<n;i++){const n=t.layerOrder[i],r=s[n.layer];r&&(n.transparent?e.pushTransparent(r):e.pushOpaque(r),e.subLayerEnabled[i]=n.enabled)}this.scene.layers=e}if(t.batchGroups){const e=this.batcher;if(e)for(let s=0,i=t.batchGroups.length;s<i;s++){const i=t.batchGroups[s];e.addGroup(i.name,i.dynamic,i.maxAabbSize,i.id,i.layers)}}t.i18nAssets&&(this.i18n.assets=t.i18nAssets),this._loadLibraries(t.libraries,e)}_loadLibraries(t,e){const s=t.length;let i=s;const n=/^http(s)?:\/\//;if(s){const r=(t,s)=>{i--,t?e(t):0===i&&(this.onLibrariesLoaded(),e(null))};for(let e=0;e<s;++e){let s=t[e];!n.test(s.toLowerCase())&&this._scriptPrefix&&(s=u.join(this._scriptPrefix,s)),this.loader.load(s,"script",r)}}else this.onLibrariesLoaded(),e(null)}_parseScenes(t){if(t)for(let e=0;e<t.length;e++)this.scenes.add(t[e].name,t[e].url)}_parseAssets(t){const e=[],s={},i={};if(qo.legacy){if(this.enableBundles)for(const s in t)"bundle"===t[s].type&&(i[s]=!0,e.push(t[s]));for(const s in t)i[s]||e.push(t[s])}else{for(let i=0;i<this.scriptsOrder.length;i++){const n=this.scriptsOrder[i];t[n]&&(s[n]=!0,e.push(t[n]))}if(this.enableBundles)for(const s in t)"bundle"===t[s].type&&(i[s]=!0,e.push(t[s]));for(const n in t)s[n]||i[n]||e.push(t[n])}for(let t=0;t<e.length;t++){const s=e[t],i=new cl(s.name,s.type,s.file,s.data);if(i.id=parseInt(s.id,10),i.preload=!!s.preload&&s.preload,i.loaded="script"===s.type&&s.data&&s.data.loadingType>0,i.tags.add(s.tags),s.i18n)for(const t in s.i18n)i.addLocalizedAssetId(t,s.i18n[t]);this.assets.add(i)}}_getScriptReferences(t){let e=[];t.settings.priority_scripts&&(e=t.settings.priority_scripts);const s=[],i={};for(let t=0;t<e.length;t++)s.push(e[t]),i[e[t]]=!0;const n=t.entities;for(const t in n){if(!n[t].components.script)continue;const e=n[t].components.script.scripts;for(let t=0;t<e.length;t++)i[e[t].url]||(s.push(e[t].url),i[e[t].url]=!0)}return s}start(){this.frame=0,this.fire("start",{timestamp:P(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),this.systems.fire("initialize",this.root),this.fire("initialize"),this.systems.fire("postInitialize",this.root),this.systems.fire("postPostInitialize",this.root),this.fire("postinitialize"),this.tick()}inputUpdate(t){this.controller&&this.controller.update(t),this.mouse&&this.mouse.update(),this.keyboard&&this.keyboard.update(),this.gamepads&&this.gamepads.update()}update(t){this.frame++,this.graphicsDevice.updateClientRect(),qo.legacy&&this.systems.fire("fixedUpdate",1/60),this.systems.fire(this._inTools?"toolsUpdate":"update",t),this.systems.fire("animationUpdate",t),this.systems.fire("postUpdate",t),this.fire("update",t),this.inputUpdate(t)}frameStart(){this.graphicsDevice.frameStart()}render(){this.fire("prerender"),this.root.syncHierarchy(),this._batcher&&this._batcher.updateAll(),this.renderComposition(this.scene.layers),this.fire("postrender")}renderComposition(t){this.renderer.buildFrameGraph(this.frameGraph,t),this.frameGraph.render(this.graphicsDevice)}_fillFrameStatsBasic(t,e,s){const i=this.stats.frame;i.dt=e,i.ms=s,t>i._timeToCountFrames?(i.fps=i._fpsAccum,i._fpsAccum=0,i._timeToCountFrames=t+1e3):i._fpsAccum++,this.stats.drawCalls.total=this.graphicsDevice._drawCallsPerFrame,this.graphicsDevice._drawCallsPerFrame=0}_fillFrameStats(){let t=this.stats.frame;t.cameras=this.renderer._camerasRendered,t.materials=this.renderer._materialSwitches,t.shaders=this.graphicsDevice._shaderSwitchesPerFrame,t.shadowMapUpdates=this.renderer._shadowMapUpdates,t.shadowMapTime=this.renderer._shadowMapTime,t.depthMapTime=this.renderer._depthMapTime,t.forwardTime=this.renderer._forwardTime;const e=this.graphicsDevice._primsPerFrame;t.triangles=e[4]/3+Math.max(e[rt]-2,0)+Math.max(e[6]-2,0),t.cullTime=this.renderer._cullTime,t.sortTime=this.renderer._sortTime,t.skinTime=this.renderer._skinTime,t.morphTime=this.renderer._morphTime,t.lightClusters=this.renderer._lightClusters,t.lightClustersTime=this.renderer._lightClustersTime,t.otherPrimitives=0;for(let s=0;s<e.length;s++)s<4&&(t.otherPrimitives+=e[s]),e[s]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._layerCompositionUpdateTime=0,this.renderer._lightClustersTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,t=this.stats.drawCalls,t.forward=this.renderer._forwardDrawCalls,t.culled=this.renderer._numDrawCallsCulled,t.depth=0,t.shadow=this.renderer._shadowDrawCalls,t.skinned=this.renderer._skinDrawCalls,t.immediate=0,t.instanced=0,t.removedByInstancing=0,t.misc=t.total-(t.forward+t.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,t=this.stats.particles,t.updatesPerFrame=t._updatesPerFrame,t.frameTime=t._frameTime,t._updatesPerFrame=0,t._frameTime=0}setCanvasFillMode(t,e,s){this._fillMode=t,this.resizeCanvas(e,s)}setCanvasResolution(t,e,s){this._resolutionMode=t,t===No&&void 0===e&&(e=this.graphicsDevice.canvas.clientWidth,s=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(e,s)}isHidden(){return document[this._hiddenAttr]}onVisibilityChange(){this.isHidden()?this._soundManager&&this._soundManager.suspend():this._soundManager&&this._soundManager.resume()}resizeCanvas(t,e){if(!this._allowResize)return;if(this.xr&&this.xr.session)return;const s=window.innerWidth,i=window.innerHeight;if(this._fillMode===zo){const n=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;n>s/i?e=(t=s)/n:t=(e=i)*n}else"FILL_WINDOW"===this._fillMode&&(t=s,e=i);return this.graphicsDevice.canvas.style.width=t+"px",this.graphicsDevice.canvas.style.height=e+"px",this.updateCanvasSize(),{width:t,height:e}}updateCanvasSize(){var t;if(this._allowResize&&(null==(t=this.xr)||!t.active)&&this._resolutionMode===No){const t=this.graphicsDevice.canvas;this.graphicsDevice.resizeCanvas(t.clientWidth,t.clientHeight)}}onLibrariesLoaded(){this._librariesLoaded=!0,this.systems.rigidbody&&this.systems.rigidbody.onLibraryLoaded()}applySceneSettings(t){let e;if(this.systems.rigidbody&&"undefined"!=typeof Ammo){const e=t.physics.gravity;this.systems.rigidbody.gravity.set(e[0],e[1],e[2])}this.scene.applySettings(t),t.render.hasOwnProperty("skybox")&&(t.render.skybox?(e=this.assets.get(t.render.skybox),e?this.setSkybox(e):this.assets.once("add:"+t.render.skybox,this.setSkybox,this)):this.setSkybox(null))}setAreaLightLuts(t,e){t&&e&&Yo.set(this.graphicsDevice,t,e)}setSkybox(t){if(t!==this._skyboxAsset){const e=()=>{this.setSkybox(null)},s=()=>{this.scene.setSkybox(this._skyboxAsset?this._skyboxAsset.resources:null)};this._skyboxAsset&&(this.assets.off("load:"+this._skyboxAsset.id,s,this),this.assets.off("remove:"+this._skyboxAsset.id,e,this),this._skyboxAsset.off("change",s,this)),this._skyboxAsset=t,this._skyboxAsset&&(this.assets.on("load:"+this._skyboxAsset.id,s,this),this.assets.once("remove:"+this._skyboxAsset.id,e,this),this._skyboxAsset.on("change",s,this),0!==this.scene.skyboxMip||this._skyboxAsset.loadFaces||(this._skyboxAsset.loadFaces=!0),this.assets.load(this._skyboxAsset)),s()}}_firstBake(){var t;null==(t=this.lightmapper)||t.bake(null,this.scene.lightmapMode)}_firstBatch(){var t;null==(t=this.batcher)||t.generate()}_processTimestamp(t){return t}drawLine(t,e,s,i,n){this.scene.drawLine(t,e,s,i,n)}drawLines(t,e,s=!0,i=this.scene.defaultDrawLayer){this.scene.drawLines(t,e,s,i)}drawLineArrays(t,e,s=!0,i=this.scene.defaultDrawLayer){this.scene.drawLineArrays(t,e,s,i)}drawWireSphere(t,e,s=D.WHITE,i=20,n=!0,r=this.scene.defaultDrawLayer){this.scene.immediate.drawWireSphere(t,e,s,i,n,r)}drawWireAlignedBox(t,e,s=D.WHITE,i=!0,n=this.scene.defaultDrawLayer){this.scene.immediate.drawWireAlignedBox(t,e,s,i,n)}drawMeshInstance(t,e=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(null,null,null,t,e)}drawMesh(t,e,s,i=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(e,s,t,null,i)}drawQuad(t,e,s=this.scene.defaultDrawLayer){this.scene.immediate.drawMesh(e,t,this.scene.immediate.getQuadMesh(),null,s)}drawTexture(t,e,s,i,n,r,a=this.scene.defaultDrawLayer,o=!0){if(!1===o&&!this.graphicsDevice.isWebGPU)return;const l=new V;l.setTRS(new R(t,e,0),H.IDENTITY,new R(s,-i,0)),r||((r=new Ki).cull=tt,r.setParameter("colorMap",n),r.shader=o?this.scene.immediate.getTextureShader():this.scene.immediate.getUnfilterableTextureShader(),r.update()),this.drawQuad(l,r,a)}drawDepthTexture(t,e,s,i,n=this.scene.defaultDrawLayer){const r=new Ki;r.cull=tt,r.shader=this.scene.immediate.getDepthTextureShader(),r.update(),this.drawTexture(t,e,s,i,null,r,n)}destroy(){var t;if(this._inFrameUpdate)return void(this._destroyRequested=!0);const e=this.graphicsDevice.canvas.id;this.off("librariesloaded"),"undefined"!=typeof document&&(document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1)),this._visibilityChangeHandler=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.gamepads&&(this.gamepads.destroy(),this.gamepads=null),this.controller&&(this.controller=null),this.systems.destroy(),this.scene.layers&&this.scene.layers.destroy();const s=this.assets.list();for(let t=0;t<s.length;t++)s[t].unload(),s[t].off();this.assets.off(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null;for(const t in this.loader.getHandler("script")._cache){const e=this.loader.getHandler("script")._cache[t],s=e.parentNode;s&&s.removeChild(e)}this.loader.getHandler("script")._cache={},this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=null,this.context=null,this.scripts.destroy(),this.scripts=null,this.scenes.destroy(),this.scenes=null,null==(t=this.lightmapper)||t.destroy(),this.lightmapper=null,this._batcher&&(this._batcher.destroy(),this._batcher=null),this._entityIndex={},this.defaultLayerDepth.onPreRenderOpaque=null,this.defaultLayerDepth.onPostRenderOpaque=null,this.defaultLayerDepth.onDisable=null,this.defaultLayerDepth.onEnable=null,this.defaultLayerDepth=null,this.defaultLayerWorld=null,null==this||this.xr.end(),null==this||this.xr.destroy(),this.renderer.destroy(),this.renderer=null,this.graphicsDevice.destroy(),this.graphicsDevice=null,this.tick=null,this.off(),this._soundManager&&(this._soundManager.destroy(),this._soundManager=null),qo.app=null,Rl._applications[e]=null,Vo()===this&&Ho(null)}getEntityFromIndex(t){return this._entityIndex[t]}_registerSceneImmediate(t){this.on("postrender",t.immediate.onPostRender,t.immediate)}}Rl._applications={};const Ll={},Il=function(t){const e=t;let s;return function(t,i){var n;if(!e.graphicsDevice)return;Ho(e),s&&(window.cancelAnimationFrame(s),s=null);const r=e._processTimestamp(t)||P(),a=r-(e._time||r);let o=a/1e3;if(o=k.clamp(o,0,e.maxDeltaTime),o*=e.timeScale,e._time=r,s=null!=(n=e.xr)&&n.session?e.xr.session.requestAnimationFrame(e.tick):w.browser?window.requestAnimationFrame(e.tick):null,e.graphicsDevice.contextLost)return;e._fillFrameStatsBasic(r,o,a),e._inFrameUpdate=!0,e.fire("frameupdate",a);let l=!0;var h;i?(l=null==(h=e.xr)?void 0:h.update(i),e.graphicsDevice.defaultFramebuffer=i.session.renderState.baseLayer.framebuffer):e.graphicsDevice.defaultFramebuffer=null;l&&(e.update(o),e.fire("framerender"),(e.autoRender||e.renderNextFrame)&&(e.updateCanvasSize(),e.frameStart(),e.render(),e.renderNextFrame=!1),Ll.timestamp=P(),Ll.target=e,e.fire("frameend",Ll)),e._inFrameUpdate=!1,e._destroyRequested&&e.destroy()}};class Ol{constructor(){this.elementInput=void 0,this.keyboard=void 0,this.mouse=void 0,this.touch=void 0,this.gamepads=void 0,this.scriptPrefix=void 0,this.assetPrefix=void 0,this.scriptsOrder=void 0,this.soundManager=void 0,this.graphicsDevice=void 0,this.lightmapper=void 0,this.batchManager=void 0,this.xr=void 0,this.componentSystems=[],this.resourceHandlers=[]}}const Fl=new Q;class Bl{constructor(t,e){this.scene=t,this.light=e,this.store(),e.numCascades=1,0!==e.type&&(e._node.getWorldTransform(),e.getBoundingSphere(Fl),this.lightBounds=new $,this.lightBounds.center.copy(Fl.center),this.lightBounds.halfExtents.set(Fl.radius,Fl.radius,Fl.radius))}store(){this.mask=this.light.mask,this.shadowUpdateMode=this.light.shadowUpdateMode,this.enabled=this.light.enabled,this.intensity=this.light.intensity,this.rotation=this.light._node.getLocalRotation().clone(),this.numCascades=this.light.numCascades}restore(){const t=this.light;t.mask=this.mask,t.shadowUpdateMode=this.shadowUpdateMode,t.enabled=this.enabled,t.intensity=this.intensity,t._node.setLocalRotation(this.rotation),t.numCascades=this.numCascades}startBake(){this.light.enabled=!0,this.light._destroyShadowMap(),this.light.beginFrame()}endBake(t){const e=this.light;e.enabled=!1,e.shadowMap&&(e.shadowMap.cached&&t.add(e,e.shadowMap),e.shadowMap=null)}}const zl=new I;class Nl extends Bl{get numVirtualLights(){return 0===this.light.type?this.light.bakeNumSamples:1}prepareVirtualLight(t,e){const s=this.light;if(s._node.setLocalRotation(this.rotation),t>0){const i=s.bakeArea;Gr(zl,t,e),zl.mulScalar(.5*i),s._node.rotateLocal(zl.x,0,zl.y)}s._node.getWorldTransform();const i=this.scene.gammaCorrection?2.2:1,n=Math.pow(this.intensity,i);s.intensity=Math.pow(n/e,1/i)}}const Ul=new R;class Vl extends Bl{constructor(t){const e=new El("AmbientLight");e.addComponent("light",{type:"directional",affectDynamic:!0,affectLightmapped:!1,bake:!0,bakeNumSamples:t.ambientBakeNumSamples,castShadows:!0,normalOffsetBias:.05,shadowBias:.2,shadowDistance:1,shadowResolution:2048,shadowType:0,color:D.WHITE,intensity:1,bakeDir:!1}),super(t,e.light.light)}get numVirtualLights(){return this.light.bakeNumSamples}prepareVirtualLight(t,e){Wr(Ul,t,e,0,this.scene.ambientBakeSpherePart),this.light._node.lookAt(Ul.mulScalar(-1)),this.light._node.rotateLocal(90,0,0);const s=this.scene.gammaCorrection?2.2:1,i=2*Math.PI*this.scene.ambientBakeSpherePart,n=Math.pow(i,s);this.light.intensity=Math.pow(n/e,1/s)}}class Hl{constructor(t,e=null){this.node=t,this.component=t.render||t.model,e=e||this.component.meshInstances,this.store(),this.meshInstances=e,this.bounds=null,this.renderTargets=[]}store(){this.castShadows=this.component.castShadows}restore(){this.component.castShadows=this.castShadows}}class Gl{constructor(t){this.device=t,this.shaderDilate=Ai(t,Ei.fullscreenQuadVS,Bo.dilatePS,"lmDilate"),this.constantTexSource=t.scope.resolve("source"),this.constantPixelOffset=t.scope.resolve("pixelOffset"),this.pixelOffset=new Float32Array(2),this.shaderDenoise=null,this.sigmas=null,this.constantSigmas=null,this.kernel=null}setSourceTexture(t){this.constantTexSource.setValue(t)}prepare(t,e){this.pixelOffset[0]=1/t,this.pixelOffset[1]=1/e,this.constantPixelOffset.setValue(this.pixelOffset)}prepareDenoise(t,e){this.shaderDenoise||(this.shaderDenoise=Ai(this.device,Ei.fullscreenQuadVS,Bo.bilateralDeNoisePS,"lmBilateralDeNoise"),this.sigmas=new Float32Array(2),this.constantSigmas=this.device.scope.resolve("sigmas"),this.constantKernel=this.device.scope.resolve("kernel[0]"),this.bZnorm=this.device.scope.resolve("bZnorm")),this.sigmas[0]=t,this.sigmas[1]=e,this.constantSigmas.setValue(this.sigmas),this.evaluateDenoiseUniforms(t,e)}evaluateDenoiseUniforms(t,e){function s(t,e){return.39894*Math.exp(-.5*t*t/(e*e))/e}this.kernel=this.kernel||new Float32Array(15);const i=this.kernel,n=Math.floor(7);for(let e=0;e<=n;++e){const r=s(e,t);i[n+e]=r,i[n-e]=r}this.constantKernel.setValue(this.kernel);const r=1/s(0,e);this.bZnorm.setValue(r)}}const Wl=new R;class jl{constructor(t,e,s,i,n){this.device=t,this.root=e,this.scene=s,this.renderer=i,this.assets=n,this.shadowMapCache=i.shadowMapCache,this._tempSet=new Set,this._initCalled=!1,this.passMaterials=[],this.ambientAOMaterial=null,this.fog="",this.ambientLight=new D,this.renderTargets=new Map,this.stats={renderPasses:0,lightmapCount:0,totalRenderTime:0,forwardTime:0,fboTime:0,shadowMapTime:0,compileTime:0,shadersLinked:0}}destroy(){_n.decRef(this.blackTex),this.blackTex=null,_n.destroy(),this.device=null,this.root=null,this.scene=null,this.renderer=null,this.assets=null}initBake(t){if(!this._initCalled){this._initCalled=!0,this.lightmapFilters=new Gl(t),this.constantBakeDir=t.scope.resolve("bakeDir"),this.materials=[],this.blackTex=new Ue(this.device,{width:4,height:4,format:7,type:Dt,name:"lightmapBlack"}),_n.incRef(this.blackTex);const e=new An;e.clearColor.set(0,0,0,0),e.clearColorBuffer=!0,e.clearDepthBuffer=!1,e.clearStencilBuffer=!1,e.frustumCulling=!1,e.projection=1,e.aspectRatio=1,e.node=new gn,this.camera=e}if(this.scene.clusteredLightingEnabled){const e=new xo(t.supportsAreaLights,t.maxTextureSize,(()=>{}));this.lightingParams=e;const s=this.scene.lighting;e.shadowsEnabled=s.shadowsEnabled,e.shadowAtlasResolution=s.shadowAtlasResolution,e.cookiesEnabled=s.cookiesEnabled,e.cookieAtlasResolution=s.cookieAtlasResolution,e.areaLightsEnabled=s.areaLightsEnabled,e.cells=new R(3,3,3),e.maxLightsPerCell=4,this.worldClusters=new Qn(t),this.worldClusters.name="ClusterLightmapper"}}finishBake(t){function e(t){_n.decRef(t.colorBuffer),t.destroy()}this.materials=[],this.renderTargets.forEach((t=>{e(t)})),this.renderTargets.clear(),t.forEach((t=>{t.renderTargets.forEach((t=>{e(t)})),t.renderTargets.length=0})),this.ambientAOMaterial=null,this.worldClusters&&(this.worldClusters.destroy(),this.worldClusters=null)}createMaterialForPass(t,e,s,i){const n=new Da;if(n.name=`lmMaterial-pass:${s}-ambient:${i}`,n.chunks.APIVersion="1.62",n.chunks.transformVS="#define UV1LAYOUT\n"+Ei.transformVS,0===s){let t=Bo.bakeLmEndPS;i?t=`\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight = ((dDiffuseLight - 0.5) * max(${e.ambientBakeOcclusionContrast.toFixed(1)} + 1.0, 0.0)) + 0.5;\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight += vec3(${e.ambientBakeOcclusionBrightness.toFixed(1)});\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight = saturate(dDiffuseLight);\n\t\t\t\t\t\t\t\t\t\tdDiffuseLight *= dAmbientLight;\n\t\t\t\t\t\t\t\t`+t:(n.ambient=new D(0,0,0),n.ambientTint=!0),n.chunks.basePS=Ei.basePS+(7===e.lightmapPixelFormat?"\n#define LIGHTMAP_RGBM\n":""),n.chunks.endPS=t,n.lightMap=this.blackTex}else n.chunks.basePS=Ei.basePS+"\nuniform sampler2D texture_dirLightMap;\nuniform float bakeDir;\n",n.chunks.endPS=Bo.bakeDirLmEndPS;return n.chunks.outputAlphaPS="\n",n.chunks.outputAlphaOpaquePS="\n",n.chunks.outputAlphaPremulPS="\n",n.cull=tt,n.forceUv1=!0,n.update(),n}createMaterials(t,e,s){for(let i=0;i<s;i++)this.passMaterials[i]||(this.passMaterials[i]=this.createMaterialForPass(t,e,i,!1));this.ambientAOMaterial||(this.ambientAOMaterial=this.createMaterialForPass(t,e,0,!0),this.ambientAOMaterial.onUpdateShader=function(t){return t.litOptions.lightMapWithoutAmbient=!0,t.litOptions.separateAmbient=!0,t})}createTexture(t,e){return new Ue(this.device,{width:t,height:t,format:this.scene.lightmapPixelFormat,mipmaps:!1,type:7===this.scene.lightmapPixelFormat?Dt:kt,minFilter:0,magFilter:0,addressU:1,addressV:1,name:e})}collectModels(t,e,s){var i,n,r;if(!t.enabled)return;let a;if(null!=(i=t.model)&&i.model&&null!=(n=t.model)&&n.enabled&&(s&&s.push(new Hl(t)),t.model.lightmapped&&e&&(a=t.model.model.meshInstances)),null!=(r=t.render)&&r.enabled&&(s&&s.push(new Hl(t)),t.render.lightmapped&&e&&(a=t.render.meshInstances)),a){let s=!0;for(let t=0;t<a.length;t++)if(!a[t].mesh.vertexBuffer.format.hasUv1){s=!1;break}if(s){const s=[];for(let i=0;i<a.length;i++){const n=a[i].mesh;this._tempSet.has(n)?e.push(new Hl(t,[a[i]])):s.push(a[i]),this._tempSet.add(n)}this._tempSet.clear(),s.length>0&&e.push(new Hl(t,s))}}for(let i=0;i<t._children.length;i++)this.collectModels(t._children[i],e,s)}prepareShadowCasters(t){const e=[];for(let s=0;s<t.length;s++){const i=t[s].component;if(i.castShadows=i.castShadowsLightmap,i.castShadowsLightmap){const i=t[s].meshInstances;for(let t=0;t<i.length;t++)i[t].visibleThisFrame=!0,e.push(i[t])}}return e}updateTransforms(t){for(let e=0;e<t.length;e++){const s=t[e].meshInstances;for(let t=0;t<s.length;t++)s[t].node.getWorldTransform()}}calculateLightmapSize(t){let e;const s=this.scene.lightmapSizeMultiplier||16,i=Wl;let n,r;t.model?(r=t.model.lightmapSizeMultiplier,t.model.asset?(e=this.assets.get(t.model.asset).data,e.area&&(n=e.area)):t.model._area&&(e=t.model,e._area&&(n=e._area))):t.render&&(r=t.render.lightmapSizeMultiplier,"asset"!==t.render.type&&t.render._area&&(e=t.render,e._area&&(n=e._area)));const a={x:1,y:1,z:1,uv:1};n&&(a.x=n.x,a.y=n.y,a.z=n.z,a.uv=n.uv);const o=r||1;a.x*=o,a.y*=o,a.z*=o;const l=t.render||t.model,h=this.computeNodeBounds(l.meshInstances);i.copy(h.halfExtents);let c=a.x*i.y*i.z+a.y*i.x*i.z+a.z*i.x*i.y;c/=a.uv,c=Math.sqrt(c);return Math.min(k.nextPowerOfTwo(c*s),this.scene.lightmapMaxResolution||2048)}setLightmapping(t,e,s,i){for(let n=0;n<t.length;n++){const r=t[n],a=r.meshInstances;for(let t=0;t<a.length;t++){const n=a[t];if(n.setLightmapped(e),e){i&&(n._shaderDefs|=i),n.mask=2;for(let t=0;t<s;t++){const e=r.renderTargets[t].colorBuffer;e.minFilter=1,e.magFilter=1,n.setRealtimeLightmap(Sn.lightmapParamNames[t],e)}}}}}bake(t,e=1){const s=this.device;if(s.isWebGPU)return;const i=P();this.scene._updateSky(s),this.stats.renderPasses=0,this.stats.shadowMapTime=0,this.stats.forwardTime=0;const n=s._shaderStats.linked,r=s._renderTargetCreationTime,a=s._shaderStats.compileTime,o=[],l=[];if(t){for(let e=0;e<t.length;e++)this.collectModels(t[e],o,null);this.collectModels(this.root,null,l)}else this.collectModels(this.root,o,l);if(o.length>0){this.renderer.shadowRenderer.frameUpdate();const t=1===e?2:1;this.setLightmapping(o,!1,t),this.initBake(s),this.bakeInternal(t,o,l);let i=64;1===e&&(i|=128),this.scene.ambientBake&&(i|=ri),this.setLightmapping(o,!0,t,i),this.finishBake(o)}const h=P();this.stats.totalRenderTime=h-i,this.stats.shadersLinked=s._shaderStats.linked-n,this.stats.compileTime=s._shaderStats.compileTime-a,this.stats.fboTime=s._renderTargetCreationTime-r,this.stats.lightmapCount=o.length}allocateTextures(t,e){for(let s=0;s<t.length;s++){const i=t[s],n=this.calculateLightmapSize(i.node);for(let t=0;t<e;t++){const e=this.createTexture(n,"lightmapper_lightmap_"+s);_n.incRef(e),i.renderTargets[t]=new pe({colorBuffer:e,depth:!1})}if(!this.renderTargets.has(n)){const t=this.createTexture(n,"lightmapper_temp_lightmap_"+n);_n.incRef(t),this.renderTargets.set(n,new pe({colorBuffer:t,depth:!1}))}}}prepareLightsToBake(t,e,s){if(this.scene.ambientBake){const t=new Vl(this.scene);s.push(t)}const i=t._lights;for(let t=0;t<i.length;t++){const n=i[t],r=new Nl(this.scene,n);e.push(r),n.enabled&&0!=(4&n.mask)&&(n.isStatic=!1,n.mask=4294967295,n.shadowUpdateMode=0===n.type?2:1,s.push(r))}s.sort()}restoreLights(t){for(let e=0;e<t.length;e++)t[e].restore()}setupScene(){this.revertStatic=!1,this.scene._needsStaticPrepare&&(this.scene._needsStaticPrepare=!1,this.revertStatic=!0),this.fog=this.scene.fog,this.ambientLight.copy(this.scene.ambientLight),this.scene.fog=Zs,this.scene.ambientBake||this.scene.ambientLight.set(0,0,0),this.renderer.setSceneConstants()}restoreScene(){this.scene.fog=this.fog,this.scene.ambientLight.copy(this.ambientLight),this.revertStatic&&(this.scene._needsStaticPrepare=!0)}computeNodeBounds(t){const e=new $;if(t.length>0){e.copy(t[0].aabb);for(let s=1;s<t.length;s++)e.add(t[s].aabb)}return e}computeNodesBounds(t){for(let e=0;e<t.length;e++){const s=t[e].meshInstances;t[e].bounds=this.computeNodeBounds(s)}}computeBounds(t){const e=new $;for(let s=0;s<t.length;s++){e.copy(t[0].aabb);for(let s=1;s<t.length;s++)e.add(t[s].aabb)}return e}backupMaterials(t){for(let e=0;e<t.length;e++)this.materials[e]=t[e].material}restoreMaterials(t){for(let e=0;e<t.length;e++)t[e].material=this.materials[e]}lightCameraPrepare(t,e){const s=e.light;let i;if(2===s.type){i=s.getRenderData(null,0).shadowCamera,i._node.setPosition(s._node.getPosition()),i._node.setRotation(s._node.getRotation()),i._node.rotateLocal(-90,0,0),i.projection=0,i.nearClip=s.attenuationEnd/1e3,i.farClip=s.attenuationEnd,i.aspectRatio=1,i.fov=2*s._outerConeAngle,this.renderer.updateCameraFrustum(i)}return i}lightCameraPrepareAndCull(t,e,s,i){const n=t.light;let r=!0;if(0===n.type){Wl.copy(i.center),Wl.y+=i.halfExtents.y,this.camera.node.setPosition(Wl),this.camera.node.setEulerAngles(-90,0,0),this.camera.nearClip=0,this.camera.farClip=2*i.halfExtents.y;const t=Math.max(i.halfExtents.x,i.halfExtents.z);this.camera.orthoHeight=t}else t.lightBounds.intersects(e.bounds)||(r=!1);if(2===n.type){let t=!1;const i=e.meshInstances;for(let e=0;e<i.length;e++)if(i[e]._isVisible(s)){t=!0;break}t||(r=!1)}return r}setupLightArray(t,e){t[0].length=0,t[1].length=0,t[2].length=0,t[e.type][0]=e,e.visibleThisFrame=!0}renderShadowMap(t,e,s){const i=s.light,n=this.scene.clusteredLightingEnabled;if(!t&&i.castShadows){i.shadowMap||n||(i.shadowMap=this.shadowMapCache.get(this.device,i)),0===i.type?this.renderer._shadowRendererDirectional.cull(i,e,this.camera):this.renderer._shadowRendererLocal.cull(i,e);const t=!1;this.renderer.shadowRenderer.render(i,this.camera,t)}return!0}postprocessTextures(t,e,s){const i=this.lightmapFilters.shaderDilate,n=this.scene.lightmapFilterEnabled;n&&this.lightmapFilters.prepareDenoise(this.scene.lightmapFilterRange,this.scene.lightmapFilterSmoothness),t.setBlendState(Zt.NOBLEND),t.setDepthState(te.NODEPTH),t.setStencilState(null,null);for(let r=0;r<e.length;r++){const a=e[r];for(let e=0;e<s;e++){const s=a.renderTargets[e],r=s.colorBuffer,o=this.renderTargets.get(r.width),l=o.colorBuffer;this.lightmapFilters.prepare(r.width,r.height);for(let a=0;a<1;a++){this.lightmapFilters.setSourceTexture(r);Fi(t,o,n&&0===e&&0===a?this.lightmapFilters.shaderDenoise:i),this.lightmapFilters.setSourceTexture(l),Fi(t,s,i)}}}}bakeInternal(t,e,s){const i=this.scene,n=this.device,r=i.clusteredLightingEnabled;this.createMaterials(n,i,t),this.setupScene(),i.layers._update(),this.computeNodesBounds(e),this.allocateTextures(e,t);const a=[],o=[];this.prepareLightsToBake(i.layers,a,o),this.updateTransforms(s);const l=this.prepareShadowCasters(s);this.renderer.updateCpuSkinMatrices(l),this.renderer.gpuUpdate(l);const h=this.computeBounds(l);let c,d,u,p;for(c=0;c<e.length;c++){for(u=e[c].meshInstances,d=0;d<u.length;d++)p=u[d],p.setLightmapped(!1),p.mask=4,p.setRealtimeLightmap(Sn.lightmapParamNames[0],p.material.lightMap?p.material.lightMap:this.blackTex),p.setRealtimeLightmap(Sn.lightmapParamNames[1],this.blackTex)}for(d=0;d<o.length;d++)o[d].light.enabled=!1;const f=[[],[],[]];let m,g,_=!1;for(c=0;c<o.length;c++){const s=o[c],a=s instanceof Vl;let v=s.numVirtualLights;t>1&&v>1&&s.light.bakeDir&&(v=1);for(let o=0;o<v;o++){v>1&&s.prepareVirtualLight(o,v),s.startBake();let c=!1;const b=this.lightCameraPrepare(n,s);for(g=0;g<e.length;g++){const y=e[g];u=y.meshInstances;if(this.lightCameraPrepareAndCull(s,y,b,h)){if(this.setupLightArray(f,s.light),r&&this.renderer.lightTextureAtlas.update(f[2],f[1],this.lightingParams),c=this.renderShadowMap(c,l,s),r){const t=f[2].concat(f[1]);this.worldClusters.update(t,this.scene.gammaCorrection,this.lightingParams)}for(this.backupMaterials(u),m=0;m<t&&!(m>0&&o>0)&&!(a&&m>0);m++){const t=y.renderTargets[m],e=y.renderTargets[m].colorBuffer.width,l=this.renderTargets.get(e),h=l.colorBuffer;0===m?_=i.updateShaders:_&&(i.updateShaders=!0);let c=this.passMaterials[m];if(a){o+1===v&&0===m&&(c=this.ambientAOMaterial)}for(d=0;d<u.length;d++)u[d].material=c;for(this.renderer.updateShaders(u),this.renderer.setCamera(this.camera,l,!0),1===m&&this.constantBakeDir.setValue(s.light.bakeDir?1:0),r&&this.worldClusters.activate(),this.renderer._forwardTime=0,this.renderer._shadowMapTime=0,this.renderer.renderForward(this.camera,u,u.length,f,1),n.updateEnd(),y.renderTargets[m]=l,this.renderTargets.set(e,t),d=0;d<u.length;d++)p=u[d],p.setRealtimeLightmap(Sn.lightmapParamNames[m],h),p._shaderDefs|=64}this.restoreMaterials(u)}}s.endBake(this.shadowMapCache)}}for(this.postprocessTextures(n,e,t),g=0;g<s.length;g++)s[g].restore();this.restoreLights(a),this.restoreScene(),r||this.shadowMapCache.clear()}}let ql=class t extends h{constructor(t,e){super(),this.system=void 0,this.entity=void 0,this.system=t,this.entity=e,this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema),this.on("set",(function(t,e,s){this.fire("set_"+t,t,e,s)})),this.on("set_enabled",this.onSetEnabled,this)}static _buildAccessors(t,e){e.forEach((function(e){const s="object"==typeof e?e.name:e;Object.defineProperty(t,s,{get:function(){return this.data[s]},set:function(t){const e=this.data,i=e[s];e[s]=t,this.fire("set",s,i,t)},configurable:!0})})),t._accessorsBuilt=!0}buildAccessors(e){t._buildAccessors(this,e)}onSetEnabled(t,e,s){e!==s&&this.entity.enabled&&(s?this.onEnable():this.onDisable())}onEnable(){}onDisable(){}onPostStateChange(){}get data(){const t=this.system.store[this.entity.getGuid()];return t?t.data:null}};class Xl extends h{constructor(t){super(),this.app=t,this.store={},this.schema=[]}addComponent(t,e={}){const s=new this.ComponentType(this,t),i=new this.DataType;return this.store[t.getGuid()]={entity:t,data:i},t[this.id]=s,t.c[this.id]=s,this.initializeComponentData(s,e,[]),this.fire("add",t,s),s}removeComponent(t){const e=this.store[t.getGuid()],s=t.c[this.id];this.fire("beforeremove",t,s),delete this.store[t.getGuid()],t[this.id]=void 0,delete t.c[this.id],this.fire("remove",t,e.data)}cloneComponent(t,e){const s=this.store[t.getGuid()];return this.addComponent(e,s.data)}initializeComponentData(t,e={},s){for(let i=0,n=s.length;i<n;i++){const n=s[i];let r,a;"object"==typeof n?(r=n.name,a=n.type):(r=n,a=void 0);let o=e[r];void 0!==o?(void 0!==a&&(o=$l(o,a)),t[r]=o):t[r]=t.data[r]}t.enabled&&t.entity.enabled&&t.onEnable()}getPropertiesOfType(t){const e=[];return(this.schema||[]).forEach((function(s){s&&"object"==typeof s&&s.type===t&&e.push(s)})),e}destroy(){this.off()}}function $l(t,e){if(!t)return t;switch(e){case"rgb":return t instanceof D?t.clone():new D(t[0],t[1],t[2]);case"rgba":return t instanceof D?t.clone():new D(t[0],t[1],t[2],t[3]);case"vec2":return t instanceof I?t.clone():new I(t[0],t[1]);case"vec3":return t instanceof R?t.clone():new R(t[0],t[1],t[2]);case"vec4":return t instanceof O?t.clone():new O(t[0],t[1],t[2],t[3]);case"boolean":case"number":case"string":case"entity":return t;default:throw new Error("Could not convert unhandled type: "+e)}}class Kl{constructor(){this._left=1/0,this._right=-1/0,this._len=0,this._recip=0,this._p0=0,this._p1=0,this._t=0,this._hermite={valid:!1,p0:0,m0:0,p1:0,m1:0}}update(t,e){if(t<this._left||t>=this._right){const s=e.length;if(s)if(t<e[0])this._left=-1/0,this._right=e[0],this._len=0,this._recip=0,this._p0=this._p1=0;else if(t>=e[s-1])this._left=e[s-1],this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=s-1;else{const s=this._findKey(t,e);this._left=e[s],this._right=e[s+1],this._len=this._right-this._left;const i=1/this._len;this._recip=isFinite(i)?i:0,this._p0=s,this._p1=s+1}else this._left=-1/0,this._right=1/0,this._len=0,this._recip=0,this._p0=this._p1=0}this._t=0===this._recip?0:(t-this._left)*this._recip,this._hermite.valid=!1}_findKey(t,e){let s=0;for(;t>=e[s+1];)s++;return s}eval(t,e,s){const i=s._data,n=s._components,r=this._p0*n;if(0===e)for(let e=0;e<n;++e)t[e]=i[r+e];else{const s=this._t,a=this._p1*n;switch(e){case 1:for(let e=0;e<n;++e)t[e]=k.lerp(i[r+e],i[a+e],s);break;case 2:{const e=this._hermite;if(!e.valid){const t=s*s,i=s+s,n=1-s,r=n*n;e.valid=!0,e.p0=(1+i)*r,e.m0=s*r,e.p1=t*(3-i),e.m1=t*(s-1)}const r=(3*this._p0+1)*n,a=(3*this._p0+2)*n,o=(3*this._p1+1)*n,l=(3*this._p1+0)*n;for(let s=0;s<n;++s)t[s]=e.p0*i[r+s]+e.m0*i[a+s]*this._len+e.p1*i[o+s]+e.m1*i[l+s]*this._len;break}}}}}class Yl{constructor(t){this._name=t.name+"Snapshot",this._time=-1,this._cache=[],this._results=[];for(let e=0;e<t._inputs.length;++e)this._cache[e]=new Kl;const e=t._curves,s=t._outputs;for(let t=0;t<e.length;++t){const i=s[e[t]._output],n=[];for(let t=0;t<i._components;++t)n[t]=0;this._results[t]=n}}}class Ql{constructor(t,e,s,i,n,r){this._name=t.name,this._track=t,this._snapshot=new Yl(t),this._playing=i,this._time=e,this._speed=s,this._loop=n,this._blendWeight=1,this._blendOrder=0,this._eventHandler=r,this.alignCursorToCurrentTime()}set name(t){this._name=t}get name(){return this._name}set track(t){this._track=t,this._snapshot=new Yl(t)}get track(){return this._track}get snapshot(){return this._snapshot}set time(t){this._time=t,this.alignCursorToCurrentTime()}get time(){return this._time}set speed(t){const e=Math.sign(t)!==Math.sign(this._speed);this._speed=t,e&&this.alignCursorToCurrentTime()}get speed(){return this._speed}set loop(t){this._loop=t}get loop(){return this._loop}set blendWeight(t){this._blendWeight=t}get blendWeight(){return this._blendWeight}set blendOrder(t){this._blendOrder=t}get blendOrder(){return this._blendOrder}set eventCursor(t){this._eventCursor=t}get eventCursor(){return this._eventCursor}get eventCursorEnd(){return this.isReverse?0:this._track.events.length-1}get nextEvent(){return this._track.events[this._eventCursor]}get isReverse(){return this._speed<0}nextEventAheadOfTime(t){return!!this.nextEvent&&(this.isReverse?this.nextEvent.time<=t:this.nextEvent.time>=t)}nextEventBehindTime(t){return!!this.nextEvent&&(t===this.track.duration?this.isReverse?this.nextEvent.time>=t:this.nextEvent.time<=t:this.isReverse?this.nextEvent.time>t:this.nextEvent.time<t)}resetEventCursor(){this._eventCursor=this.isReverse?this._track.events.length-1:0}moveEventCursor(){this._eventCursor+=this.isReverse?-1:1,this._eventCursor>=this.track.events.length?this._eventCursor=0:this._eventCursor<0&&(this._eventCursor=this.track.events.length-1)}clipFrameTime(t){const e=Ql.eventFrame;e.start=0,e.end=t,e.residual=0,this.isReverse?t<0&&(e.start=this.track.duration,e.end=0,e.residual=t+this.track.duration):t>this.track.duration&&(e.start=0,e.end=this.track.duration,e.residual=t-this.track.duration)}alignCursorToCurrentTime(){for(this.resetEventCursor();this.nextEventBehindTime(this._time)&&this._eventCursor!==this.eventCursorEnd;)this.moveEventCursor()}fireNextEvent(){this._eventHandler.fire(this.nextEvent.name,$t({track:this.track},this.nextEvent)),this.moveEventCursor()}fireNextEventInFrame(t,e){return!(!this.nextEventAheadOfTime(t)||!this.nextEventBehindTime(e))&&(this.fireNextEvent(),!0)}activeEventsForFrame(t,e){const s=Ql.eventFrame;this.clipFrameTime(e);const i=this.eventCursor;for(;this.fireNextEventInFrame(t,s.end)&&i!==this.eventCursor;);this.loop&&Math.abs(s.residual)>0&&this.activeEventsForFrame(s.start,s.residual)}progressForTime(t){return t*this._speed/this._track.duration}_update(t){if(this._playing){let e=this._time;const s=this._track.duration,i=this._speed,n=this._loop;this._track.events.length>0&&s>0&&this.activeEventsForFrame(e,e+i*t),e+=i*t,i>=0?e>s&&(n?e=e%s||0:(e=this._track.duration,this.pause())):e<0&&(n?e=s+(e%s||0):(e=0,this.pause())),this._time=e}this._time!==this._snapshot._time&&this._track.eval(this._time,this._snapshot)}play(){this._playing=!0,this._time=0}stop(){this._playing=!1,this._time=0}pause(){this._playing=!1}resume(){this._playing=!0}reset(){this._time=0}}Ql.eventFrame={start:0,end:0,residual:0};const Jl="NONE",Zl="INTEGER",th="FLOAT",eh="BOOLEAN",sh="TRIGGER",ih="START",nh="END",rh="ANY",ah=[ih,nh,rh],oh="OVERWRITE";class lh{static dot(t,e){const s=t.length;let i=0;for(let n=0;n<s;++n)i+=t[n]*e[n];return i}static normalize(t){let e=lh.dot(t,t);if(e>0){e=1/Math.sqrt(e);const s=t.length;for(let i=0;i<s;++i)t[i]*=e}}static set(t,e,s){const i=t.length;if("quaternion"===s){let s=lh.dot(e,e);s>0&&(s=1/Math.sqrt(s));for(let n=0;n<i;++n)t[n]=e[n]*s}else for(let s=0;s<i;++s)t[s]=e[s]}static blendVec(t,e,s,i){const n=i?1:1-s,r=t.length;for(let i=0;i<r;++i)t[i]=t[i]*n+e[i]*s}static blendQuat(t,e,s,i){const n=t.length,r=i?1:1-s;lh.dot(t,e)<0&&(s=-s);for(let i=0;i<n;++i)t[i]=t[i]*r+e[i]*s;i||lh.normalize(t)}static blend(t,e,s,i,n){"quaternion"===i?lh.blendQuat(t,e,s,n):lh.blendVec(t,e,s,n)}static stableSort(t,e){const s=t.length;for(let i=0;i<s-1;++i)for(let n=i+1;n<s;++n)if(e(t[n],t[i])){const e=t[i];t[i]=t[n],t[n]=e}}}class hh{constructor(t,e){this._component=t,this.mask=new Int8Array(t.layers.length),this.weights=new Float32Array(t.layers.length),this.totalWeight=0,this.counter=0,this.layerCounter=0,this.valueType=e,this.dirty=!0,this.value=e===hh.TYPE_QUAT?[0,0,0,1]:[0,0,0],this.baseValue=null,this.setter=null}get _normalizeWeights(){return this._component.normalizeWeights}getWeight(t){return this.dirty&&this.updateWeights(),this._normalizeWeights&&0===this.totalWeight||!this.mask[t]?0:this._normalizeWeights?this.weights[t]/this.totalWeight:k.clamp(this.weights[t],0,1)}_layerBlendType(t){return this._component.layers[t].blendType}setMask(t,e){this.mask[t]=e,this._normalizeWeights&&(this._component.layers[t].blendType===oh&&(this.mask=this.mask.fill(0,0,t)),this.dirty=!0)}updateWeights(){this.totalWeight=0;for(let t=0;t<this.weights.length;t++)this.weights[t]=this._component.layers[t].weight,this.totalWeight+=this.mask[t]*this.weights[t];this.dirty=!1}updateValue(t,e){if(0===this.counter&&(lh.set(this.value,hh.IDENTITY_QUAT_ARR,this.valueType),this._normalizeWeights||lh.blend(this.value,this.baseValue,1,this.valueType)),this.mask[t]&&0!==this.getWeight(t)){if("ADDITIVE"!==this._layerBlendType(t)||this._normalizeWeights)lh.blend(this.value,e,this.getWeight(t),this.valueType);else if(this.valueType===hh.TYPE_QUAT){const s=hh.q1.set(this.value[0],this.value[1],this.value[2],this.value[3]),i=hh.q2.set(this.baseValue[0],this.baseValue[1],this.baseValue[2],this.baseValue[3]),n=hh.q3.set(e[0],e[1],e[2],e[3]),r=i.invert().mul(n);r.slerp(H.IDENTITY,r,this.getWeight(t)),s.mul(r),hh.quatArr[0]=s.x,hh.quatArr[1]=s.y,hh.quatArr[2]=s.z,hh.quatArr[3]=s.w,lh.set(this.value,hh.quatArr,this.valueType)}else hh.vecArr[0]=e[0]-this.baseValue[0],hh.vecArr[1]=e[1]-this.baseValue[1],hh.vecArr[2]=e[2]-this.baseValue[2],lh.blend(this.value,hh.vecArr,this.getWeight(t),this.valueType,!0);this.setter&&this.setter(this.value)}}unbind(){this.setter&&this.setter(this.baseValue)}}hh.TYPE_QUAT="quaternion",hh.TYPE_VEC3="vector3",hh.q1=new H,hh.q2=new H,hh.q3=new H,hh.quatArr=[0,0,0,1],hh.vecArr=[0,0,0],hh.IDENTITY_QUAT_ARR=[0,0,0,1];class ch{constructor(t){this._binder=t,this._clips=[],this._inputs=[],this._outputs=[],this._targets={}}get clips(){return this._clips}addClip(t){const e=this._targets,s=this._binder,i=t.track.curves,n=t.snapshot,r=[],a=[];for(let t=0;t<i.length;++t){const o=i[t].paths;for(let i=0;i<o.length;++i){const l=o[i],h=s.resolve(l);let c=e[h&&h.targetPath||null];if(!c&&h){c={target:h,value:[],curves:0,blendCounter:0};for(let t=0;t<c.target.components;++t)c.value.push(0);if(e[h.targetPath]=c,s.animComponent){if(!s.animComponent.targets[h.targetPath]){let t;t="localRotation"===h.targetPath.substring(h.targetPath.length-13)?hh.TYPE_QUAT:hh.TYPE_VEC3,s.animComponent.targets[h.targetPath]=new hh(s.animComponent,t)}s.animComponent.targets[h.targetPath].layerCounter++,s.animComponent.targets[h.targetPath].setMask(s.layerIndex,1)}}c&&(c.curves++,r.push(n._results[t]),a.push(c))}}this._clips.push(t),this._inputs.push(r),this._outputs.push(a)}removeClip(t){const e=this._targets,s=this._binder,i=this._clips,n=i[t].track.curves;for(let t=0;t<n.length;++t){const i=n[t].paths;for(let t=0;t<i.length;++t){const n=i[t],r=this._binder.resolve(n);r&&(r.curves--,0===r.curves&&(s.unresolve(n),delete e[r.targetPath],s.animComponent&&s.animComponent.targets[r.targetPath].layerCounter--))}}i.splice(t,1),this._inputs.splice(t,1),this._outputs.splice(t,1)}removeClips(){for(;this._clips.length>0;)this.removeClip(0)}updateClipTrack(t,e){this._clips.forEach((s=>{s.name.includes(t)&&(s.track=e)})),this.rebind()}findClip(t){const e=this._clips;for(let s=0;s<e.length;++s){const i=e[s];if(i.name===t)return i}return null}rebind(){this._binder.rebind(),this._targets={};const t=[...this.clips];this.removeClips(),t.forEach((t=>{this.addClip(t)}))}assignMask(t){return this._binder.assignMask(t)}update(t,e=!0){const s=this._clips,i=s.map((function(t,e){return e}));lh.stableSort(i,(function(t,e){return s[t].blendOrder<s[e].blendOrder}));for(let n=0;n<i.length;++n){const r=i[n],a=s[r],o=this._inputs[r],l=this._outputs[r],h=a.blendWeight;if(h>0&&a._update(t),!e)break;let c,d,u;if(h>=1)for(let t=0;t<o.length;++t)c=o[t],d=l[t],u=d.value,lh.set(u,c,d.target.type),d.blendCounter++;else if(h>0)for(let t=0;t<o.length;++t)c=o[t],d=l[t],u=d.value,0===d.blendCounter?lh.set(u,c,d.target.type):lh.blend(u,c,h,d.target.type),d.blendCounter++}const n=this._targets,r=this._binder;for(const t in n)if(n.hasOwnProperty(t)){const e=n[t];if(r.animComponent&&e.target.isTransform){const s=r.animComponent.targets[t];s.counter===s.layerCounter&&(s.counter=0),s.path||(s.path=t,s.baseValue=e.target.get(),s.setter=e.target.set),s.updateValue(r.layerIndex,e.value),s.counter++}else e.target.set(e.value);e.blendCounter=0}this._binder.update(t)}}class dh{constructor(t){this._events=[...t],this._events.sort(((t,e)=>t.time-e.time))}get events(){return this._events}}class uh{constructor(t,e,s,i,n,r=new dh([])){this._name=t,this._duration=e,this._inputs=s,this._outputs=i,this._curves=n,this._animEvents=r}get name(){return this._name}get duration(){return this._duration}get inputs(){return this._inputs}get outputs(){return this._outputs}get curves(){return this._curves}set events(t){this._animEvents=t}get events(){return this._animEvents.events}eval(t,e){e._time=t;const s=this._inputs,i=this._outputs,n=this._curves,r=e._cache,a=e._results;for(let e=0;e<s.length;++e)r[e].update(t,s[e]._data);for(let t=0;t<n.length;++t){const e=n[t],s=i[e._output],o=a[t];r[e._input].eval(o,e._interpolation,s)}}}uh.EMPTY=Object.freeze(new uh("empty",Number.MAX_VALUE,[],[],[]));class ph{static joinPath(t,e){e=e||".";return t.map((function(t){return t.replace(/\\/g,"\\\\").replace(new RegExp("\\"+e,"g"),"\\"+e)})).join(e)}static splitPath(t,e){e=e||".";const s=[];let i="",n=0;for(;n<t.length;){let r=t[n++];"\\"===r&&n<t.length?(r=t[n++],i+="\\"===r||r===e?r:"\\"+r):r===e?(s.push(i),i=""):i+=r}return i.length>0&&s.push(i),s}static encode(t,e,s){return`${Array.isArray(t)?t.join("/"):t}/${e}/${Array.isArray(s)?s.join("/"):s}`}resolve(t){return null}unresolve(t){}update(t){}}class fh{constructor(t,e,s,i){t.set?(this._set=t.set,this._get=t.get):this._set=t,this._type=e,this._components=s,this._targetPath=i,this._isTransform="localRotation"===this._targetPath.substring(this._targetPath.length-13)||"localPosition"===this._targetPath.substring(this._targetPath.length-13)||"localScale"===this._targetPath.substring(this._targetPath.length-10)}get set(){return this._set}get get(){return this._get}get type(){return this._type}get components(){return this._components}get targetPath(){return this._targetPath}get isTransform(){return this._isTransform}}class mh{constructor(t){if(this._isPathInMask=(t,e)=>{const s=this._mask[t];return!!s&&!!(s.children||e&&!1!==s.value)},this.graph=t,!t)return;this._mask=null;const e={};!function t(s){e[s.name]=s;for(let e=0;e<s.children.length;++e)t(s.children[e])}(t),this.nodes=e,this.targetCache={};const s=function(t){let e,s=t;for(;s&&!(s instanceof El);)s=s.parent;return s&&(s.render?e=s.render.meshInstances:s.model&&(e=s.model.meshInstances)),e};this.nodeCounts={},this.activeNodes=[],this.handlers={localPosition:function(t){const e=t.localPosition;return mh.createAnimTarget((function(t){e.set(...t)}),"vector",3,t,"localPosition")},localRotation:function(t){const e=t.localRotation;return mh.createAnimTarget((function(t){e.set(...t)}),"quaternion",4,t,"localRotation")},localScale:function(t){const e=t.localScale;return mh.createAnimTarget((function(t){e.set(...t)}),"vector",3,t,"localScale")},weight:function(t,e){e=0===e.indexOf("name.")?e.replace("name.",""):Number(e);const i=s(t);let n;if(i)for(let s=0;s<i.length;++s)if(i[s].node.name===t.name&&i[s].morphInstance){const t=i[s].morphInstance,r=s=>{t.setWeight(e,s[0])};n||(n=[]),n.push(r)}if(n){const s=t=>{for(let e=0;e<n.length;++e)n[e](t)};return mh.createAnimTarget(s,"number",1,t,`weight.${e}`)}return null},materialTexture:(t,e)=>{const i=s(t);if(i){let s;for(let e=0;e<i.length;++e)if(i[e].node.name===t.name){s=i[e];break}if(s){const i=t=>{const i=this.animComponent.system.app.assets.get(t[0]);i&&i.resource&&"texture"===i.type&&(s.material[e]=i.resource,s.material.update())};return mh.createAnimTarget(i,"vector",1,t,"materialTexture","material")}}return null}}}_isPathActive(t){if(!this._mask)return!0;const e=[t.entityPath[0],this.graph.name];for(let s=0;s<e.length;++s){let i=e[s];if(this._isPathInMask(i,1===t.entityPath.length))return!0;for(let e=1;e<t.entityPath.length;e++)if(i+="/"+t.entityPath[e],this._isPathInMask(i,e===t.entityPath.length-1))return!0}return!1}findNode(t){if(!this._isPathActive(t))return null;let e;return this.graph&&(e=this.graph.findByPath(t.entityPath),e||(e=this.graph.findByPath(t.entityPath.slice(1)))),e||(e=this.nodes[t.entityPath[t.entityPath.length-1]||""]),e}static createAnimTarget(t,e,s,i,n,r){const a=ph.encode(i.path,r||"entity",n);return new fh(t,e,s,a)}resolve(t){const e=ph.encode(t.entityPath,t.component,t.propertyPath);let s=this.targetCache[e];if(s)return s;const i=this.findNode(t);if(!i)return null;const n=this.handlers[t.propertyPath];return n?(s=n(i),s?(this.targetCache[e]=s,this.nodeCounts[i.path]?this.nodeCounts[i.path]++:(this.activeNodes.push(i),this.nodeCounts[i.path]=1),s):null):null}unresolve(t){if("graph"!==t.component)return;const e=this.nodes[t.entityPath[t.entityPath.length-1]||""];if(this.nodeCounts[e.path]--,0===this.nodeCounts[e.path]){const t=this.activeNodes,s=t.indexOf(e.node),i=t.length;s<i-1&&(t[s]=t[i-1]),t.pop()}}update(t){const e=this.activeNodes;for(let t=0;t<e.length;++t)e[t]._dirtifyLocal()}assignMask(t){return t!==this._mask&&(this._mask=t,!0)}}class gh{constructor(t,e,s,i,n=1){this._state=t,this._parent=e,this._name=s,Array.isArray(i)?(this._point=new I(i[0],i[1]),this._pointLength=this._point.length()):(this._point=i,this._pointLength=i),this._speed=n,this._weightedSpeed=1,this._weight=1,this._animTrack=null}get parent(){return this._parent}get name(){return this._name}get path(){return this._parent?this._parent.path+"."+this._name:this._name}get point(){return this._point}get pointLength(){return this._pointLength}set weight(t){this._weight=t}get weight(){return this._parent?this._parent.weight*this._weight:this._weight}get normalizedWeight(){const t=this._state.totalWeight;return 0===t?0:this.weight/t}get speed(){return this._weightedSpeed*this._speed}get absoluteSpeed(){return Math.abs(this._speed)}set weightedSpeed(t){this._weightedSpeed=t}get weightedSpeed(){return this._weightedSpeed}set animTrack(t){this._animTrack=t}get animTrack(){return this._animTrack}}class _h extends gh{constructor(t,e,s,i,n,r,a,o,l){super(t,e,s,i),this._parameters=n,this._parameterValues=new Array(n.length),this._children=[],this._findParameter=l,this._syncAnimations=!1!==a,this._pointCache={};for(let e=0;e<r.length;e++){const i=r[e];i.children?this._children.push(o(i.type,this,null,s,1,i.parameter?[i.parameter]:i.parameters,i.children,o,l)):this._children.push(new gh(t,this,i.name,i.point,i.speed))}}get weight(){return this.calculateWeights(),this._parent?this._parent.weight*this._weight:this._weight}get syncAnimations(){return this._syncAnimations}getChild(t){for(let e=0;e<this._children.length;e++)if(this._children[e].name===t)return this._children[e];return null}updateParameterValues(){let t=!0;for(let e=0;e<this._parameterValues.length;e++){const s=this._findParameter(this._parameters[e]).value;this._parameterValues[e]!==s&&(this._parameterValues[e]=s,t=!1)}return t}getNodeWeightedDuration(t){return this._children[t].animTrack.duration/this._children[t].speedMultiplier*this._children[t].weight}getNodeCount(){let t=0;for(let e=0;e<this._children.length;e++){this._children[e].constructor===_h?t+=this._children[e].getNodeCount():t++}return t}}class vh extends _h{constructor(t,e,s,i,n,r,a,o,l){r.sort(((t,e)=>t.point-e.point)),super(t,e,s,i,n,r,a,o,l)}calculateWeights(){if(this.updateParameterValues())return;let t=0;this._children[0].weight=0;for(let e=0;e<this._children.length;e++){const s=this._children[e];if(e!==this._children.length-1){const t=this._children[e+1];if(s.point===t.point)s.weight=.5,t.weight=.5;else if(k.between(this._parameterValues[0],s.point,t.point,!0)){const e=Math.abs(s.point-t.point),i=(e-Math.abs(s.point-this._parameterValues[0]))/e;s.weight=i,t.weight=1-i}else t.weight=0}this._syncAnimations&&(t+=s.animTrack.duration/s.absoluteSpeed*s.weight)}if(this._syncAnimations)for(let e=0;e<this._children.length;e++){const s=this._children[e];s.weightedSpeed=s.animTrack.duration/s.absoluteSpeed/t}}}class bh extends _h{pointDistanceCache(t,e){const s=`${t}${e}`;return this._pointCache[s]||(this._pointCache[s]=this._children[e].point.clone().sub(this._children[t].point)),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let t,e;bh._p.set(...this._parameterValues),t=0,e=0;for(let s=0;s<this._children.length;s++){const i=this._children[s],n=i.point;bh._pip.set(bh._p.x,bh._p.y).sub(n);let r=Number.MAX_VALUE;for(let t=0;t<this._children.length;t++){if(s===t)continue;const e=this.pointDistanceCache(s,t),i=k.clamp(1-bh._pip.dot(e)/e.lengthSq(),0,1);i<r&&(r=i)}i.weight=r,t+=r,this._syncAnimations&&(e+=i.animTrack.duration/i.absoluteSpeed*i.weight)}for(let s=0;s<this._children.length;s++){const i=this._children[s];i.weight=i._weight/t,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/e)}}}bh._p=new I,bh._pip=new I;class yh extends _h{pointCache(t,e){const s=`${t}${e}`;return this._pointCache[s]||(this._pointCache[s]=new I((this._children[e].pointLength-this._children[t].pointLength)/((this._children[e].pointLength+this._children[t].pointLength)/2),2*I.angleRad(this._children[t].point,this._children[e].point))),this._pointCache[s]}calculateWeights(){if(this.updateParameterValues())return;let t,e;yh._p.set(...this._parameterValues);const s=yh._p.length();t=0,e=0;for(let i=0;i<this._children.length;i++){const n=this._children[i],r=n.point,a=n.pointLength;let o=Number.MAX_VALUE;for(let t=0;t<this._children.length;t++){if(i===t)continue;const e=this.pointCache(i,t),n=this._children[t].pointLength;yh._pip.set((s-a)/((n+a)/2),2*I.angleRad(r,yh._p));const l=k.clamp(1-Math.abs(yh._pip.dot(e)/e.lengthSq()),0,1);l<o&&(o=l)}n.weight=o,t+=o,this._syncAnimations&&(e+=n.animTrack.duration/n.absoluteSpeed*n.weight)}for(let s=0;s<this._children.length;s++){const i=this._children[s];if(i.weight=i._weight/t,this._syncAnimations){const s=i.animTrack.duration/e*t;i.weightedSpeed=i.absoluteSpeed*s}}}}yh._p=new I,yh._pip=new I;class xh extends _h{calculateWeights(){if(this.updateParameterValues())return;let t=0,e=0;for(let s=0;s<this._children.length;s++)if(t+=Math.max(this._parameterValues[s],0),this._syncAnimations){const t=this._children[s];e+=t.animTrack.duration/t.absoluteSpeed*t.weight}for(let s=0;s<this._children.length;s++){const i=this._children[s],n=Math.max(this._parameterValues[s],0);t?(i.weight=n/t,this._syncAnimations&&(i.weightedSpeed=i.animTrack.duration/i.absoluteSpeed/e)):(i.weight=0,this._syncAnimations&&(i.weightedSpeed=0))}}}class wh{constructor(t,e,s=1,i=!0,n){this._animations={},this._animationList=[],this._controller=t,this._name=e,this._speed=s,this._loop=i,this._hasAnimations=!1,this._blendTree=n?this._createTree(n.type,this,null,e,1,n.parameter?[n.parameter]:n.parameters,n.children,n.syncAnimations,this._createTree,this._controller.findParameter):new gh(this,null,e,1,s)}_createTree(t,e,s,i,n,r,a,o,l,h){switch(t){case"1D":return new vh(e,s,i,n,r,a,o,l,h);case"2D_CARTESIAN":return new bh(e,s,i,n,r,a,o,l,h);case"2D_DIRECTIONAL":return new yh(e,s,i,n,r,a,o,l,h);case"DIRECT":return new xh(e,s,i,n,r,a,o,l,h)}}_getNodeFromPath(t){let e=this._blendTree;for(let s=1;s<t.length;s++)e=e.getChild(t[s]);return e}addAnimation(t,e){const s=t.join("."),i=this._animationList.findIndex((function(t){return t.path===s}));if(i>=0)this._animationList[i].animTrack=e;else{const s=this._getNodeFromPath(t);s.animTrack=e,this._animationList.push(s)}this._updateHasAnimations()}_updateHasAnimations(){this._hasAnimations=this._animationList.length>0&&this._animationList.every((t=>t.animTrack&&t.animTrack!==uh.EMPTY))}get name(){return this._name}set animations(t){this._animationList=t,this._updateHasAnimations()}get animations(){return this._animationList}get hasAnimations(){return this._hasAnimations}set speed(t){this._speed=t}get speed(){return this._speed}set loop(t){this._loop=t}get loop(){return this._loop}get nodeCount(){return this._blendTree&&this._blendTree.constructor!==gh?this._blendTree.getNodeCount():1}get playable(){return-1!==ah.indexOf(this.name)||this.animations.length===this.nodeCount}get looping(){if(this.animations.length>0){const t=this.name+"."+this.animations[0].animTrack.name,e=this._controller.animEvaluator.findClip(t);if(e)return e.loop}return!1}get totalWeight(){let t=0;for(let e=0;e<this.animations.length;e++)t+=this.animations[e].weight;return t}get timelineDuration(){let t=0;for(let e=0;e<this.animations.length;e++){const s=this.animations[e];s.animTrack.duration>t&&(t=s.animTrack.duration)}return t}}class Sh{constructor({from:t,to:e,time:s=0,priority:i=0,conditions:n=[],exitTime:r=null,transitionOffset:a=null,interruptionSource:o=Jl}){this._from=t,this._to=e,this._time=s,this._priority=i,this._conditions=n,this._exitTime=r,this._transitionOffset=a,this._interruptionSource=o}get from(){return this._from}set to(t){this._to=t}get to(){return this._to}get time(){return this._time}get priority(){return this._priority}get conditions(){return this._conditions}get exitTime(){return this._exitTime}get transitionOffset(){return this._transitionOffset}get interruptionSource(){return this._interruptionSource}get hasExitTime(){return!!this.exitTime}}class Ch{constructor(t,e,s,i,n,r,a){this.findParameter=t=>this._findParameter(t),this._animEvaluator=t,this._states={},this._stateNames=[],this._eventHandler=n,this._findParameter=r,this._consumeTrigger=a;for(let t=0;t<e.length;t++)this._states[e[t].name]=new wh(this,e[t].name,e[t].speed,e[t].loop,e[t].blendTree),this._stateNames.push(e[t].name);this._transitions=s.map((t=>new Sh($t({},t)))),this._findTransitionsFromStateCache={},this._findTransitionsBetweenStatesCache={},this._previousStateName=null,this._activeStateName=ih,this._activeStateDuration=0,this._activeStateDurationDirty=!0,this._playing=!1,this._activate=i,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._transitionInterruptionSource=Jl,this._transitionPreviousStates=[],this._timeInState=0,this._timeInStateBefore=0}get animEvaluator(){return this._animEvaluator}set activeState(t){this._activeStateName=t}get activeState(){return this._findState(this._activeStateName)}get activeStateName(){return this._activeStateName}get activeStateAnimations(){return this.activeState.animations}set previousState(t){this._previousStateName=t}get previousState(){return this._findState(this._previousStateName)}get previousStateName(){return this._previousStateName}get playable(){let t=!0;for(let e=0;e<this._stateNames.length;e++)this._states[this._stateNames[e]].playable||(t=!1);return t}set playing(t){this._playing=t}get playing(){return this._playing}get activeStateProgress(){return this._getActiveStateProgressForTime(this._timeInState)}get activeStateDuration(){if(this._activeStateDurationDirty){let t=0;for(let e=0;e<this.activeStateAnimations.length;e++){const s=this._animEvaluator.findClip(this.activeStateAnimations[e].name);s&&(t=Math.max(t,s.track.duration))}this._activeStateDuration=t,this._activeStateDurationDirty=!1}return this._activeStateDuration}set activeStateCurrentTime(t){this._timeInStateBefore=t,this._timeInState=t;for(let e=0;e<this.activeStateAnimations.length;e++){const s=this.animEvaluator.findClip(this.activeStateAnimations[e].name);s&&(s.time=t)}}get activeStateCurrentTime(){return this._timeInState}get transitioning(){return this._isTransitioning}get transitionProgress(){return this._currTransitionTime/this._totalTransitionTime}get states(){return this._stateNames}assignMask(t){return this._animEvaluator.assignMask(t)}_findState(t){return this._states[t]}_getActiveStateProgressForTime(t){if(this.activeStateName===ih||this.activeStateName===nh||this.activeStateName===rh)return 1;const e=this._animEvaluator.findClip(this.activeStateAnimations[0].name);return e?e.progressForTime(t):null}_findTransitionsFromState(t){let e=this._findTransitionsFromStateCache[t];return e||(e=this._transitions.filter((function(e){return e.from===t})),ao(e),this._findTransitionsFromStateCache[t]=e),e}_findTransitionsBetweenStates(t,e){let s=this._findTransitionsBetweenStatesCache[t+"->"+e];return s||(s=this._transitions.filter((function(s){return s.from===t&&s.to===e})),ao(s),this._findTransitionsBetweenStatesCache[t+"->"+e]=s),s}_transitionHasConditionsMet(t){const e=t.conditions;for(let t=0;t<e.length;t++){const s=e[t],i=this._findParameter(s.parameterName);switch(s.predicate){case"GREATER_THAN":if(!(i.value>s.value))return!1;break;case"LESS_THAN":if(!(i.value<s.value))return!1;break;case"GREATER_THAN_EQUAL_TO":if(!(i.value>=s.value))return!1;break;case"LESS_THAN_EQUAL_TO":if(!(i.value<=s.value))return!1;break;case"EQUAL_TO":if(i.value!==s.value)return!1;break;case"NOT_EQUAL_TO":if(i.value===s.value)return!1}}return!0}_findTransition(t,e){let s=[];if(t&&e)s=s.concat(this._findTransitionsBetweenStates(t,e));else if(this._isTransitioning)switch(this._transitionInterruptionSource){case"PREV_STATE":s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(rh));break;case"NEXT_STATE":s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(rh));break;case"PREV_STATE_NEXT_STATE":s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(rh));break;case"NEXT_STATE_PREV_STATE":s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(this._previousStateName)),s=s.concat(this._findTransitionsFromState(rh))}else s=s.concat(this._findTransitionsFromState(this._activeStateName)),s=s.concat(this._findTransitionsFromState(rh));if(s=s.filter((t=>{if(t.to===this.activeStateName)return!1;if(t.hasExitTime){let e=this._getActiveStateProgressForTime(this._timeInStateBefore),s=this._getActiveStateProgressForTime(this._timeInState);if(t.exitTime<1&&this.activeState.loop&&(e-=Math.floor(e),s-=Math.floor(s)),s===e){if(s!==t.exitTime)return null}else if(!(t.exitTime>e&&t.exitTime<=s))return null}return this._transitionHasConditionsMet(t)})),s.length>0){const t=s[0];if(t.to===nh){const e=this._findTransitionsFromState(ih)[0];t.to=e.to}return t}return null}updateStateFromTransition(t){let e,s,i;this.previousState=t.from?this.activeStateName:null,this.activeState=t.to,this._activeStateDurationDirty=!0;for(let e=0;e<t.conditions.length;e++){const s=t.conditions[e];this._findParameter(s.parameterName).type===sh&&this._consumeTrigger(s.parameterName)}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]),this._transitionPreviousStates.push({name:this._previousStateName,weight:1});const t=Math.min(0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1,1);for(let n=0;n<this._transitionPreviousStates.length;n++){this._isTransitioning?n!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[n].weight*=1-t:this._transitionPreviousStates[n].weight=t:this._transitionPreviousStates[n].weight=1,e=this._findState(this._transitionPreviousStates[n].name);for(let t=0;t<e.animations.length;t++)s=e.animations[t],i=this._animEvaluator.findClip(s.name+".previous."+n),i||(i=this._animEvaluator.findClip(s.name),i.name=s.name+".previous."+n),n!==this._transitionPreviousStates.length-1&&i.pause()}}this._isTransitioning=!0,this._totalTransitionTime=t.time,this._currTransitionTime=0,this._transitionInterruptionSource=t.interruptionSource;const n=this.activeState,r=t.transitionOffset&&t.transitionOffset>0&&t.transitionOffset<1;let a=0,o=0;if(r){const e=n.timelineDuration*t.transitionOffset;a=e,o=e}this._timeInState=a,this._timeInStateBefore=o;for(let e=0;e<n.animations.length;e++){if(i=this._animEvaluator.findClip(n.animations[e].name),i)i.reset();else{const t=Number.isFinite(n.animations[e].speed)?n.animations[e].speed:n.speed;i=new Ql(n.animations[e].animTrack,this._timeInState,t,!0,n.loop,this._eventHandler),i.name=n.animations[e].name,this._animEvaluator.addClip(i)}if(t.time>0?i.blendWeight=0:i.blendWeight=n.animations[e].normalizedWeight,i.play(),r)i.time=n.timelineDuration*t.transitionOffset;else{const t=n.speed>=0?0:this.activeStateDuration;i.time=t}}}_transitionToState(t){if(!this._findState(t))return;let e=this._findTransition(this._activeStateName,t);e||(this._animEvaluator.removeClips(),e=new Sh({from:null,to:t})),this.updateStateFromTransition(e)}assignAnimation(t,e,s,i){const n=t.split(".");let r=this._findState(n[0]);r||(r=new wh(this,n[0],s),this._states[n[0]]=r,this._stateNames.push(n[0])),r.addAnimation(n,e),this._animEvaluator.updateClipTrack(r.name,e),void 0!==s&&(r.speed=s),void 0!==i&&(r.loop=i),!this._playing&&this._activate&&this.playable&&this.play(),this._activeStateDurationDirty=!0}removeNodeAnimations(t){if(-1!==ah.indexOf(t))return!1;const e=this._findState(t);return!!e&&(e.animations=[],!0)}play(t){t&&this._transitionToState(t),this._playing=!0}pause(){this._playing=!1}reset(){this._previousStateName=null,this._activeStateName=ih,this._playing=!1,this._currTransitionTime=1,this._totalTransitionTime=1,this._isTransitioning=!1,this._timeInState=0,this._timeInStateBefore=0,this._animEvaluator.removeClips()}rebind(){this._animEvaluator.rebind()}update(t){if(!this._playing)return;let e,s,i;(this.activeState.loop||this._timeInState<this.activeStateDuration)&&(this._timeInStateBefore=this._timeInState,this._timeInState+=t*this.activeState.speed,!this.activeState.loop&&this._timeInState>this.activeStateDuration&&(this._timeInState=this.activeStateDuration,t=this.activeStateDuration-this._timeInStateBefore));const n=this._findTransition(this._activeStateName);if(n&&this.updateStateFromTransition(n),this._isTransitioning)if(this._currTransitionTime+=t,this._currTransitionTime<=this._totalTransitionTime){const t=0!==this._totalTransitionTime?this._currTransitionTime/this._totalTransitionTime:1;for(let n=0;n<this._transitionPreviousStates.length;n++){e=this._findState(this._transitionPreviousStates[n].name);const r=this._transitionPreviousStates[n].weight;for(let a=0;a<e.animations.length;a++)s=e.animations[a],i=this._animEvaluator.findClip(s.name+".previous."+n),i&&(i.blendWeight=(1-t)*s.normalizedWeight*r)}e=this.activeState;for(let i=0;i<e.animations.length;i++)s=e.animations[i],this._animEvaluator.findClip(s.name).blendWeight=t*s.normalizedWeight}else{this._isTransitioning=!1;const t=this.activeStateAnimations.length,n=this._animEvaluator.clips.length;for(let e=0;e<n-t;e++)this._animEvaluator.removeClip(0);this._transitionPreviousStates=[],e=this.activeState;for(let t=0;t<e.animations.length;t++)s=e.animations[t],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight)}else if(this.activeState._blendTree.constructor!==gh){e=this.activeState;for(let t=0;t<e.animations.length;t++)s=e.animations[t],i=this._animEvaluator.findClip(s.name),i&&(i.blendWeight=s.normalizedWeight,s.parent.syncAnimations&&(i.speed=s.speed))}this._animEvaluator.update(t,this.activeState.hasAnimations)}}const Th=new I,Eh=new R,Ph=new O,Mh=new D,Ah=new H;class kh extends mh{constructor(t,e,s,i,n){super(e),this.animComponent=t,this._mask=i,this.layerName=s,this.layerIndex=n}static _packFloat(t){return t[0]}static _packBoolean(t){return!!t[0]}static _packVec2(t){return Th.x=t[0],Th.y=t[1],Th}static _packVec3(t){return Eh.x=t[0],Eh.y=t[1],Eh.z=t[2],Eh}static _packVec4(t){return Ph.x=t[0],Ph.y=t[1],Ph.z=t[2],Ph.w=t[3],Ph}static _packColor(t){return Mh.r=t[0],Mh.g=t[1],Mh.b=t[2],Mh.a=t[3],Mh}static _packQuat(t){return Ah.x=t[0],Ah.y=t[1],Ah.z=t[2],Ah.w=t[3],Ah}resolve(t){const e=ph.encode(t.entityPath,t.component,t.propertyPath);let s,i,n,r=this.targetCache[e];if(r)return r;switch(t.component){case"entity":s=this._getEntityFromHierarchy(t.entityPath),n=ph.encode(s.path,"entity",t.propertyPath),i=s;break;case"graph":if(i=this.findNode(t),!i)return null;n=ph.encode(i.path,"graph",t.propertyPath);break;default:if(s=this._getEntityFromHierarchy(t.entityPath),i=s.findComponent(t.component),!i)return null;n=ph.encode(s.path,t.component,t.propertyPath)}return r=this._createAnimTargetForProperty(i,t.propertyPath,n),this.targetCache[e]=r,r}update(t){const e=this.activeNodes;if(e)for(let t=0;t<e.length;t++)e[t]._dirtifyLocal()}_getEntityFromHierarchy(t){if(!this.animComponent.entity.name===t[0])return null;const e=this.animComponent.entity;return 1===t.length?e:e._parent.findByPath(t)}_resolvePath(t,e,s){const i=e.length-(s?0:1);for(let s=0;s<i;s++)t=t[e[s]];return t}_setter(t,e,s){const i=this._resolvePath(t,e),n=e[e.length-1],r="set"+n.substring(0,1).toUpperCase()+n.substring(1);if(i[r]){let t=i["get"+n.substring(0,1).toUpperCase()+n.substring(1)].bind(i)();t=[t.x,t.y,t.z,t.w];const e=i[r].bind(i);return{set:t=>{e(s(t))},get:()=>t}}const a=i[n];if("object"==typeof a&&a.hasOwnProperty("copy"))return function(t){a.copy(s(t))};if(-1!==[I,R,O,D,H].indexOf(i.constructor)&&e.length>1){const r=e.length>2?this._resolvePath(t,e.slice(0,-1)):t,a=e[e.length-2];return function(t){i[n]=s(t),r[a]=i}}return function(t){i[n]=s(t)}}_createAnimTargetForProperty(t,e,s){if(this.handlers&&e[0].startsWith("weight."))return this.handlers.weight(t,e[0].replace("weight.",""));if(this.handlers&&"material"===e[0]&&2===e.length){const s=e[1];if(s.endsWith("Map"))return this.handlers.materialTexture(t,s)}const i=this._resolvePath(t,e,!0);if(void 0===i)return null;let n,r,a;if("number"==typeof i)n=this._setter(t,e,kh._packFloat),r="vector",a=1;else if("boolean"==typeof i)n=this._setter(t,e,kh._packBoolean),r="vector",a=1;else if("object"==typeof i)switch(i.constructor){case I:n=this._setter(t,e,kh._packVec2),r="vector",a=2;break;case R:n=this._setter(t,e,kh._packVec3),r="vector",a=3;break;case O:n=this._setter(t,e,kh._packVec4),r="vector",a=4;break;case D:n=this._setter(t,e,kh._packColor),r="vector",a=4;break;case H:n=this._setter(t,e,kh._packQuat),r="quaternion",a=4;break;default:return null}return-1!==e.indexOf("material")?new fh((function(e){n(e),t.material.update()}),r,a,s):new fh(n,r,a,s)}rebind(){this.targetCache={},this.animComponent.rootBone?this.graph=this.animComponent.rootBone:this.graph=this.animComponent.entity;const t={};!function e(s){t[s.name]=s;for(let t=0;t<s.children.length;++t)e(s.children[t])}(this.graph),this.nodes=t}}class Dh{constructor(t,e,s,i=1,n=oh,r=!0){this._name=t,this._controller=e,this._component=s,this._weight=i,this._blendType=n,this._normalizedWeight=r,this._mask=null,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0}get name(){return this._name}set playing(t){this._controller.playing=t}get playing(){return this._controller.playing}get playable(){return this._controller.playable}get activeState(){return this._controller.activeStateName}get previousState(){return this._controller.previousStateName}get activeStateProgress(){return this._controller.activeStateProgress}get activeStateDuration(){return this._controller.activeStateDuration}set activeStateCurrentTime(t){const e=this._controller,s=e.playing;e.playing=!0,e.activeStateCurrentTime=t,s||e.update(0),e.playing=s}get activeStateCurrentTime(){return this._controller.activeStateCurrentTime}get transitioning(){return this._controller.transitioning}get transitionProgress(){return this.transitioning?this._controller.transitionProgress:null}get states(){return this._controller.states}set weight(t){this._weight=t,this._component.dirtifyTargets()}get weight(){return this._weight}set blendType(t){t!==this._blendType&&(this._blendType=t,this._controller.normalizeWeights&&this._component.rebind())}get blendType(){return this._blendType}set mask(t){this._controller.assignMask(t)&&this._component.rebind(),this._mask=t}get mask(){return this._mask}play(t){this._controller.play(t)}pause(){this._controller.pause()}reset(){this._controller.reset()}rebind(){this._controller.rebind()}update(t){this._blendTime&&(this._blendTimeElapsed<this._blendTime?(this.weight=k.lerp(this._startingWeight,this._targetWeight,this._blendTimeElapsed/this._blendTime),this._blendTimeElapsed+=t):(this.weight=this._targetWeight,this._blendTime=0,this._blendTimeElapsed=0,this._startingWeight=0,this._targetWeight=0)),this._controller.update(t)}blendToWeight(t,e){this._startingWeight=this.weight,this._targetWeight=t,this._blendTime=Math.max(0,e),this._blendTimeElapsed=0}assignMask(t){this._controller.assignMask(t)&&this._component.rebind(),this._mask=t}assignAnimation(t,e,s,i){e instanceof uh&&(this._controller.assignAnimation(t,e,s,i),0===this._controller._transitions.length&&this._controller._transitions.push(new Sh({from:"START",to:t})),this._component.activate&&this._component.playable&&(this._component.playing=!0))}removeNodeAnimations(t){this._controller.removeNodeAnimations(t)&&(this._component.playing=!1)}getAnimationAsset(t){return this._component.animationAssets[`${this.name}:${t}`]}transition(t,e=0,s=null){this._controller.updateStateFromTransition(new Sh({from:this._controller.activeStateName,to:t,time:e,transitionOffset:s}))}}class Rh{constructor(t){if(this._layers=[],this._parameters={},Array.isArray(t.layers))this._layers=t.layers;else for(const e in t.layers){const s=t.layers[e],i={name:s.name,blendType:s.blendType,weight:s.weight,states:[],transitions:[]};for(let e=0;e<s.states.length;e++)i.states.push(t.states[s.states[e]]);for(let e=0;e<s.transitions.length;e++){const n=t.transitions[s.transitions[e]];if(n.conditions&&!Array.isArray(n.conditions)){const t=Object.keys(n.conditions),e=[];for(let s=0;s<t.length;s++){const i=n.conditions[t[s]];i.parameterName&&e.push(i)}n.conditions=e}Number.isInteger(n.from)&&(n.from=t.states[n.from].name),Number.isInteger(n.to)&&(n.to=t.states[n.to].name),i.transitions.push(n)}this._layers.push(i)}for(const e in t.parameters){const s=t.parameters[e];this._parameters[s.name]={type:s.type,value:s.value}}}get parameters(){return Object.assign({},this._parameters)}get layers(){return this._layers}}class Lh extends ql{constructor(t,e){super(t,e),this.findParameter=t=>this._parameters[t],this.consumeTrigger=t=>{this._consumedTriggers.add(t)},this._stateGraphAsset=null,this._animationAssets={},this._speed=1,this._activate=!0,this._playing=!1,this._rootBone=null,this._stateGraph=null,this._layers=[],this._layerIndices={},this._parameters={},this._targets={},this._consumedTriggers=new Set,this._normalizeWeights=!1}set stateGraphAsset(t){if(null===t)return void this.removeStateGraph();if(this._stateGraphAsset){this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)}let e,s;t instanceof cl?(e=t.id,s=this.system.app.assets.get(e),s||(this.system.app.assets.add(t),s=this.system.app.assets.get(e))):(e=t,s=this.system.app.assets.get(e)),s&&this._stateGraphAsset!==e&&(s.resource?(this._stateGraph=s.resource,this.loadStateGraph(this._stateGraph),s.on("change",this._onStateGraphAssetChangeEvent,this)):(s.once("load",(t=>{this._stateGraph=t.resource,this.loadStateGraph(this._stateGraph)})),s.on("change",this._onStateGraphAssetChangeEvent,this),this.system.app.assets.load(s)),this._stateGraphAsset=e)}get stateGraphAsset(){return this._stateGraphAsset}set normalizeWeights(t){this._normalizeWeights=t,this.unbind()}get normalizeWeights(){return this._normalizeWeights}set animationAssets(t){this._animationAssets=t,this.loadAnimationAssets()}get animationAssets(){return this._animationAssets}set speed(t){this._speed=t}get speed(){return this._speed}set activate(t){this._activate=t}get activate(){return this._activate}set playing(t){this._playing=t}get playing(){return this._playing}set rootBone(t){if("string"==typeof t){const e=this.entity.root.findByGuid(t);this._rootBone=e}else this._rootBone=t instanceof El?t:null;this.rebind()}get rootBone(){return this._rootBone}set stateGraph(t){this._stateGraph=t}get stateGraph(){return this._stateGraph}get layers(){return this._layers}set layerIndices(t){this._layerIndices=t}get layerIndices(){return this._layerIndices}set parameters(t){this._parameters=t}get parameters(){return this._parameters}set targets(t){this._targets=t}get targets(){return this._targets}get playable(){for(let t=0;t<this._layers.length;t++)if(!this._layers[t].playable)return!1;return!0}get baseLayer(){return this._layers.length>0?this._layers[0]:null}_onStateGraphAssetChangeEvent(t){const e=this.animationAssets,s=this.layers.map((t=>t.mask));this.removeStateGraph(),this._stateGraph=new Rh(t._data),this.loadStateGraph(this._stateGraph),this.animationAssets=e,this.loadAnimationAssets(),this.layers.forEach(((t,e)=>{t.mask=s[e]})),this.rebind()}dirtifyTargets(){const t=Object.values(this._targets);for(let e=0;e<t.length;e++)t[e].dirty=!0}_addLayer({name:t,states:e,transitions:s,weight:i,mask:n,blendType:r}){let a;a=this.rootBone?this.rootBone:this.entity;const o=this._layers.length,l=new kh(this,a,t,n,o),h=new ch(l),c=new Ch(h,e,s,this._activate,this,this.findParameter,this.consumeTrigger);return this._layers.push(new Dh(t,c,this,i,r)),this._layerIndices[t]=o,this._layers[o]}addLayer(t,e,s,i){const n=this.findAnimationLayer(t);if(n)return n;return this._addLayer({name:t,states:[{name:"START",speed:1}],transitions:[],weight:e,mask:s,blendType:i})}_assignParameters(t){this._parameters={};const e=Object.keys(t.parameters);for(let s=0;s<e.length;s++){const i=e[s];this._parameters[i]={type:t.parameters[i].type,value:t.parameters[i].value}}}loadStateGraph(t){this._stateGraph=t,this._assignParameters(t),this._layers=[];let e=!1;for(let s=0;s<t.layers.length;s++){const i=t.layers[s];this._addLayer.bind(this)($t({},i)),i.states.some((t=>t.blendTree))&&(e=!0)}e||this.setupAnimationAssets()}setupAnimationAssets(){for(let t=0;t<this._layers.length;t++){const e=this._layers[t],s=e.name;for(let t=0;t<e.states.length;t++){const i=e.states[t];if(-1===ah.indexOf(i)){const t=s+":"+i;this._animationAssets[t]||(this._animationAssets[t]={asset:null})}}}this.loadAnimationAssets()}loadAnimationAssets(){for(let t=0;t<this._layers.length;t++){const e=this._layers[t];for(let t=0;t<e.states.length;t++){const s=e.states[t];if(-1!==ah.indexOf(s))continue;const i=this._animationAssets[e.name+":"+s];if(!i||!i.asset){this.findAnimationLayer(e.name).assignAnimation(s,uh.EMPTY);continue}const n=i.asset,r=this.system.app.assets.get(n);r&&(r.resource?this.onAnimationAssetLoaded(e.name,s,r):(r.once("load",function(t,e){return function(s){this.onAnimationAssetLoaded(t,e,s)}.bind(this)}.bind(this)(e.name,s)),this.system.app.assets.load(r)))}}}onAnimationAssetLoaded(t,e,s){this.findAnimationLayer(t).assignAnimation(e,s.resource)}removeStateGraph(){this._stateGraph=null,this._stateGraphAsset=null,this._animationAssets={},this._layers=[],this._layerIndices={},this._parameters={},this._playing=!1,this.unbind(),this._targets={}}reset(){this._assignParameters(this._stateGraph);for(let t=0;t<this._layers.length;t++){const e=this._layers[t].playing;this._layers[t].reset(),this._layers[t].playing=e}}unbind(){this._normalizeWeights||Object.keys(this._targets).forEach((t=>{this._targets[t].unbind()}))}rebind(){this._targets={};for(let t=0;t<this._layers.length;t++)this._layers[t].rebind()}findAnimationLayer(t){const e=this._layerIndices[t];return this._layers[e]||null}addAnimationState(t,e,s=1,i=!0,n="Base"){this._stateGraph||this.loadStateGraph(new Rh({layers:[{name:n,states:[{name:"START",speed:1},{name:t,speed:s,loop:i,defaultState:!0}],transitions:[{from:"START",to:t}]}],parameters:{}}));const r=this.findAnimationLayer(n);var a;r?r.assignAnimation(t,e,s,i):null==(a=this.addLayer(n))||a.assignAnimation(t,e,s,i)}assignAnimation(t,e,s,i=1,n=!0){if(!this._stateGraph&&-1===t.indexOf("."))return this.loadStateGraph(new Rh({layers:[{name:"Base",states:[{name:"START",speed:1},{name:t,speed:i,loop:n,defaultState:!0}],transitions:[{from:"START",to:t}]}],parameters:{}})),void this.baseLayer.assignAnimation(t,e);const r=s?this.findAnimationLayer(s):this.baseLayer;r&&r.assignAnimation(t,e,i,n)}removeNodeAnimations(t,e){const s=e?this.findAnimationLayer(e):this.baseLayer;s&&s.removeNodeAnimations(t)}getParameterValue(t,e){const s=this._parameters[t];if(s&&s.type===e)return s.value}setParameterValue(t,e,s){const i=this._parameters[t];i&&i.type===e&&(i.value=s)}getFloat(t){return this.getParameterValue(t,th)}setFloat(t,e){this.setParameterValue(t,th,e)}getInteger(t){return this.getParameterValue(t,Zl)}setInteger(t,e){"number"==typeof e&&e%1==0&&this.setParameterValue(t,Zl,e)}getBoolean(t){return this.getParameterValue(t,eh)}setBoolean(t,e){this.setParameterValue(t,eh,!!e)}getTrigger(t){return this.getParameterValue(t,sh)}setTrigger(t,e=!1){this.setParameterValue(t,sh,!0),e&&this._consumedTriggers.add(t)}resetTrigger(t){this.setParameterValue(t,sh,!1)}onBeforeRemove(){if(Number.isFinite(this._stateGraphAsset)){this.system.app.assets.get(this._stateGraphAsset).off("change",this._onStateGraphAssetChangeEvent,this)}}update(t){for(let e=0;e<this.layers.length;e++)this.layers[e].update(t*this.speed);this._consumedTriggers.forEach((t=>{this.parameters[t].value=!1})),this._consumedTriggers.clear()}resolveDuplicatedEntityReferenceProperties(t,e){t.rootBone&&e[t.rootBone.getGuid()]?this.rootBone=e[t.rootBone.getGuid()]:this.rebind()}}class Ih{constructor(){this.enabled=!0}}const Oh=["enabled"];class Fh extends Xl{constructor(t){super(t),this.id="anim",this.ComponentType=Lh,this.DataType=Ih,this.schema=Oh,this.on("beforeremove",this.onBeforeRemove,this),this.app.systems.on("animationUpdate",this.onAnimationUpdate,this)}initializeComponentData(t,e,s){super.initializeComponentData(t,e,Oh);const i=["animationAssets","stateGraph","layers","masks"];Object.keys(e).forEach((s=>{i.includes(s)||(t[s]=e[s])})),e.stateGraph&&(t.stateGraph=e.stateGraph,t.loadStateGraph(t.stateGraph)),e.layers?e.layers.forEach(((e,s)=>{e._controller.states.forEach((i=>{e._controller._states[i]._animationList.forEach((i=>{if(i.animTrack&&i.animTrack!==uh.EMPTY)t.layers[s].assignAnimation(i.name,i.animTrack);else{const n=this.app.assets.get(e._component._animationAssets[e.name+":"+i.name].asset);n&&!n.loaded&&n.once("load",(()=>{t.layers[s].assignAnimation(i.name,n.resource)}))}}))}))})):e.animationAssets&&(t.animationAssets=Object.assign(t.animationAssets,e.animationAssets)),e.masks&&Object.keys(e.masks).forEach((s=>{if(t.layers[s]){const i=e.masks[s].mask,n={};Object.keys(i).forEach((t=>{n[decodeURI(t)]=i[t]})),t.layers[s].mask=n}}))}onAnimationUpdate(t){const e=this.store;for(const s in e)if(e.hasOwnProperty(s)){const i=e[s].entity.anim;i.data.enabled&&i.entity.enabled&&i.playing&&i.update(t)}}cloneComponent(t,e){let s;t.anim.rootBone&&t.anim.rootBone!==t||(s={},t.anim.layers.forEach(((t,i)=>{if(t.mask){const n={};Object.keys(t.mask).forEach((s=>{const i=s.split("/");i.shift();const r=[e.name,...i].join("/");n[r]=t.mask[s]})),s[i]={mask:n}}})));const i={stateGraphAsset:t.anim.stateGraphAsset,animationAssets:t.anim.animationAssets,speed:t.anim.speed,activate:t.anim.activate,playing:t.anim.playing,rootBone:t.anim.rootBone,stateGraph:t.anim.stateGraph,layers:t.anim.layers,layerIndices:t.anim.layerIndices,parameters:t.anim.parameters,normalizeWeights:t.anim.normalizeWeights,masks:s};return this.addComponent(e,i)}onBeforeRemove(t,e){e.onBeforeRemove()}destroy(){super.destroy(),this.app.systems.off("animationUpdate",this.onAnimationUpdate,this)}}ql._buildAccessors(Lh.prototype,Oh);class Bh extends h{constructor(t,e,s){if(super(),!(t&&t instanceof ql))throw new Error("The parentComponent argument is required and must be a Component");if(!e||"string"!=typeof e)throw new Error("The propertyName argument is required and must be a string");if(s&&"object"!=typeof s)throw new Error("If provided, the eventConfig argument must be an object");this._parentComponent=t,this._entityPropertyName=e,this._entity=null,this._app=t.system.app,this._configureEventListeners(s||{},{"entity#destroy":this._onEntityDestroy}),this._toggleLifecycleListeners("on")}_configureEventListeners(t,e){const s=this._parseEventListenerConfig(t,"external",this._parentComponent),i=this._parseEventListenerConfig(e,"internal",this);this._eventListenerConfigs=s.concat(i),this._listenerStatusFlags={},this._gainListeners={},this._loseListeners={}}_parseEventListenerConfig(t,e,s){return Object.keys(t).map((function(i,n){const r=i.split("#"),a=r[0],o=r[1],l=t[i];if(2!==r.length||"string"!=typeof a||0===a.length||"string"!=typeof o||0===o.length)throw new Error("Invalid event listener description: `"+i+"`");if("function"!=typeof l)throw new Error("Invalid or missing callback for event listener `"+i+"`");return{id:e+"_"+n+"_"+i,sourceName:a,eventName:o,callback:l,scope:s}}),this)}_toggleLifecycleListeners(t){this._parentComponent[t]("set_"+this._entityPropertyName,this._onSetEntity,this),this._parentComponent.system[t]("beforeremove",this._onParentComponentRemove,this),this._app.systems[t]("postPostInitialize",this._updateEntityReference,this),this._app[t]("tools:sceneloaded",this._onSceneLoaded,this);const e=[];for(let t=0;t<this._eventListenerConfigs.length;++t){const s=this._eventListenerConfigs[t],i=this._app.systems[s.sourceName];i&&(-1===e.indexOf(i)&&e.push(i),i&&"gain"===s.eventName&&(this._gainListeners[s.sourceName]=s),i&&"lose"===s.eventName&&(this._loseListeners[s.sourceName]=s))}for(let s=0;s<e.length;++s)e[s][t]("add",this._onComponentAdd,this),e[s][t]("beforeremove",this._onComponentRemove,this)}_onSetEntity(t,e,s){if(s instanceof El)this._updateEntityReference();else{if(null!=s&&"string"!=typeof s)return void console.warn("Entity field `"+this._entityPropertyName+"` was set to unexpected type '"+typeof s+"'");e!==s&&this._updateEntityReference()}}onParentComponentEnable(){this._entity||this._updateEntityReference()}_onSceneLoaded(){this._updateEntityReference()}_updateEntityReference(){let t,e=this._parentComponent.data[this._entityPropertyName];if(e instanceof El)t=e,e=t.getGuid(),this._parentComponent.data[this._entityPropertyName]=e;else{const s=this._parentComponent.system.app.root;t=this._parentComponent.entity.isDescendantOf(s)&&e?s.findByGuid(e):null}this._entity!==t&&(this._entity&&this._onBeforeEntityChange(),this._entity=t,this._entity&&this._onAfterEntityChange(),this.fire("set:entity",this._entity))}_onBeforeEntityChange(){this._toggleEntityListeners("off"),this._callAllGainOrLoseListeners(this._loseListeners)}_onAfterEntityChange(){this._toggleEntityListeners("on"),this._callAllGainOrLoseListeners(this._gainListeners)}_onComponentAdd(t,e){const s=e.system.id;t===this._entity&&(this._callGainOrLoseListener(s,this._gainListeners),this._toggleComponentListeners("on",s))}_onComponentRemove(t,e){const s=e.system.id;t===this._entity&&(this._callGainOrLoseListener(s,this._loseListeners),this._toggleComponentListeners("off",s,!0))}_callAllGainOrLoseListeners(t){for(const e in this._entity.c)this._callGainOrLoseListener(e,t)}_callGainOrLoseListener(t,e){if(this._entity.c.hasOwnProperty(t)&&e[t]){const s=e[t];s.callback.call(s.scope)}}_toggleEntityListeners(t,e){if(this._entity)for(let s=0;s<this._eventListenerConfigs.length;++s)this._safeToggleListener(t,this._eventListenerConfigs[s],e)}_toggleComponentListeners(t,e,s){for(let i=0;i<this._eventListenerConfigs.length;++i){const n=this._eventListenerConfigs[i];n.sourceName===e&&this._safeToggleListener(t,n,s)}}_safeToggleListener(t,e,s){const i="on"===t;if(i&&this._listenerStatusFlags[e.id])return;const n=this._getEventSource(e.sourceName,s);n&&(n[t](e.eventName,e.callback,e.scope),this._listenerStatusFlags[e.id]=i)}_getEventSource(t,e){if("entity"===t)return this._entity;const s=this._entity[t];return s||(e||console.warn("Entity has no component with name "+t),null)}_onEntityDestroy(t){this._entity===t&&(this._toggleEntityListeners("off",!0),this._entity=null)}_onParentComponentRemove(t,e){e===this._parentComponent&&(this._toggleLifecycleListeners("off"),this._toggleEntityListeners("off",!0))}hasComponent(t){return!(!this._entity||!this._entity.c)&&!!this._entity.c[t]}get entity(){return this._entity}}class zh extends ai{constructor(t,e){super(),this.skin=t,this.skinInstance=e}}class Nh{static createCachedSkinInstance(t,e,s){let i=Nh.getCachedSkinInstance(t,e);return i||(i=new Zi(t),i.resolve(e,s),Nh.addCachedSkinInstance(t,e,i)),i}static getCachedSkinInstance(t,e){let s=null;const i=Nh._skinInstanceCache.get(e);if(i){const e=i.find((e=>e.skin===t));e&&(e.incRefCount(),s=e.skinInstance)}return s}static addCachedSkinInstance(t,e,s){let i=Nh._skinInstanceCache.get(e);i||(i=[],Nh._skinInstanceCache.set(e,i));let n=i.find((e=>e.skin===t));n||(n=new zh(t,s),i.push(n)),n.incRefCount()}static removeCachedSkinInstance(t){if(t){const e=t.rootBone;if(e){const s=Nh._skinInstanceCache.get(e);if(s){const i=s.findIndex((e=>e.skinInstance===t));if(i>=0){const n=s[i];n.decRefCount(),0===n.refCount&&(s.splice(i,1),s.length||Nh._skinInstanceCache.delete(e),t&&(t.destroy(),n.skinInstance=null))}}}}}}Nh._skinInstanceCache=new Map;class Uh{constructor(t,e,s,i,n){this.propertyName=t,this.parent=e,this._scope=n,this._registry=s,this.id=null,this.url=null,this.asset=null,this._onAssetLoad=i.load,this._onAssetAdd=i.add,this._onAssetRemove=i.remove,this._onAssetUnload=i.unload}set id(t){if(this.url)throw Error("Can't set id and url");this._unbind(),this._id=t,this.asset=this._registry.get(this._id),this._bind()}get id(){return this._id}set url(t){if(this.id)throw Error("Can't set id and url");this._unbind(),this._url=t,this.asset=this._registry.getByUrl(this._url),this._bind()}get url(){return this._url}_bind(){this.id&&(this._onAssetLoad&&this._registry.on("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:"+this.id,this._onRemove,this),this._onAssetUnload&&this._registry.on("unload:"+this.id,this._onUnload,this)),this.url&&(this._onAssetLoad&&this._registry.on("load:url:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:url:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:url:"+this.url,this._onRemove,this))}_unbind(){this.id&&(this._onAssetLoad&&this._registry.off("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.id,this._onRemove,this),this._onAssetUnload&&this._registry.off("unload:"+this.id,this._onUnload,this)),this.url&&(this._onAssetLoad&&this._registry.off("load:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.url,this._onRemove,this))}_onLoad(t){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,t)}_onAdd(t){this.asset=t,this._onAssetAdd.call(this._scope,this.propertyName,this.parent,t)}_onRemove(t){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,t),this.asset=null}_onUnload(t){this._onAssetUnload.call(this._scope,this.propertyName,this.parent,t)}}class Vh extends ql{constructor(t,e){super(t,e),this._type="asset",this._castShadows=!0,this._receiveShadows=!0,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this._isStatic=!1,this._batchGroupId=-1,this._layers=[0],this._renderStyle=0,this._meshInstances=[],this._customAabb=null,this._area=null,this._assetReference=[],this._materialReferences=[],this._material=void 0,this._rootBone=void 0,this._rootBone=new Bh(this,"rootBone"),this._rootBone.on("set:entity",this._onSetRootBone,this),this._assetReference=new Uh("asset",this,t.app.assets,{add:this._onRenderAssetAdded,load:this._onRenderAssetLoad,remove:this._onRenderAssetRemove,unload:this._onRenderAssetUnload},this),this._material=t.defaultMaterial,e.on("remove",this.onRemoveChild,this),e.on("removehierarchy",this.onRemoveChild,this),e.on("insert",this.onInsertChild,this),e.on("inserthierarchy",this.onInsertChild,this)}set renderStyle(t){this._renderStyle!==t&&(this._renderStyle=t,Sn._prepareRenderStyleForArray(this._meshInstances,t))}get renderStyle(){return this._renderStyle}set customAabb(t){this._customAabb=t;const e=this._meshInstances;if(e)for(let t=0;t<e.length;t++)e[t].setCustomAabb(this._customAabb)}get customAabb(){return this._customAabb}set type(t){if(this._type!==t&&(this._area=null,this._type=t,this.destroyMeshInstances(),"asset"!==t)){let e=this._material;e&&e!==this.system.defaultMaterial||(e=this._materialReferences[0]&&this._materialReferences[0].asset&&this._materialReferences[0].asset.resource);const s=bi(this.system.app.graphicsDevice,t);this._area=s.area,this.meshInstances=[new Sn(s.mesh,e||this.system.defaultMaterial,this.entity)]}}get type(){return this._type}set meshInstances(t){if(this.destroyMeshInstances(),this._meshInstances=t,this._meshInstances){const t=this._meshInstances;for(let e=0;e<t.length;e++)t[e].node||(t[e].node=this.entity),t[e].castShadow=this._castShadows,t[e].receiveShadow=this._receiveShadows,t[e].isStatic=this._isStatic,t[e].renderStyle=this._renderStyle,t[e].setLightmapped(this._lightmapped),t[e].setCustomAabb(this._customAabb);this.enabled&&this.entity.enabled&&this.addToLayers()}}get meshInstances(){return this._meshInstances}set lightmapped(t){if(t!==this._lightmapped){this._lightmapped=t;const e=this._meshInstances;if(e)for(let s=0;s<e.length;s++)e[s].setLightmapped(t)}}get lightmapped(){return this._lightmapped}set castShadows(t){if(this._castShadows!==t){const e=this._meshInstances;if(e){const s=this.layers,i=this.system.app.scene;if(this._castShadows&&!t)for(let t=0;t<s.length;t++){const s=i.layers.getLayerById(this.layers[t]);s&&s.removeShadowCasters(e)}for(let s=0;s<e.length;s++)e[s].castShadow=t;if(!this._castShadows&&t)for(let t=0;t<s.length;t++){const n=i.layers.getLayerById(s[t]);n&&n.addShadowCasters(e)}}this._castShadows=t}}get castShadows(){return this._castShadows}set receiveShadows(t){if(this._receiveShadows!==t){this._receiveShadows=t;const e=this._meshInstances;if(e)for(let s=0;s<e.length;s++)e[s].receiveShadow=t}}get receiveShadows(){return this._receiveShadows}set castShadowsLightmap(t){this._castShadowsLightmap=t}get castShadowsLightmap(){return this._castShadowsLightmap}set lightmapSizeMultiplier(t){this._lightmapSizeMultiplier=t}get lightmapSizeMultiplier(){return this._lightmapSizeMultiplier}set isStatic(t){if(this._isStatic!==t){this._isStatic=t;const e=this._meshInstances;if(e)for(let s=0;s<e.length;s++)e[s].isStatic=t}}get isStatic(){return this._isStatic}set layers(t){const e=this.system.app.scene.layers;let s;if(this._meshInstances)for(let t=0;t<this._layers.length;t++)s=e.getLayerById(this._layers[t]),s&&s.removeMeshInstances(this._meshInstances);this._layers.length=0;for(let e=0;e<t.length;e++)this._layers[e]=t[e];if(this.enabled&&this.entity.enabled&&this._meshInstances)for(let t=0;t<this._layers.length;t++)s=e.getLayerById(this._layers[t]),s&&s.addMeshInstances(this._meshInstances)}get layers(){return this._layers}set batchGroupId(t){if(this._batchGroupId!==t){var e,s;if(this.entity.enabled&&this._batchGroupId>=0)null==(e=this.system.app.batcher)||e.remove(Qi.RENDER,this.batchGroupId,this.entity);if(this.entity.enabled&&t>=0)null==(s=this.system.app.batcher)||s.insert(Qi.RENDER,t,this.entity);t<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled&&this.addToLayers(),this._batchGroupId=t}}get batchGroupId(){return this._batchGroupId}set material(t){if(this._material!==t&&(this._material=t,this._meshInstances&&"asset"!==this._type))for(let e=0;e<this._meshInstances.length;e++)this._meshInstances[e].material=t}get material(){return this._material}set materialAssets(t=[]){if(this._materialReferences.length>t.length){for(let e=t.length;e<this._materialReferences.length;e++)this._materialReferences[e].id=null;this._materialReferences.length=t.length}for(let e=0;e<t.length;e++)if(this._materialReferences[e]||this._materialReferences.push(new Uh(e,this,this.system.app.assets,{add:this._onMaterialAdded,load:this._onMaterialLoad,remove:this._onMaterialRemove,unload:this._onMaterialUnload},this)),t[e]){const s=t[e]instanceof cl?t[e].id:t[e];this._materialReferences[e].id!==s&&(this._materialReferences[e].id=s),this._materialReferences[e].asset&&this._onMaterialAdded(e,this,this._materialReferences[e].asset)}else this._materialReferences[e].id=null,this._meshInstances[e]&&(this._meshInstances[e].material=this.system.defaultMaterial)}get materialAssets(){return this._materialReferences.map((function(t){return t.id}))}set asset(t){const e=t instanceof cl?t.id:t;this._assetReference.id!==e&&(this._assetReference.asset&&this._assetReference.asset.resource&&this._onRenderAssetRemove(),this._assetReference.id=e,this._assetReference.asset&&this._onRenderAssetAdded())}get asset(){return this._assetReference.id}assignAsset(t){const e=t instanceof cl?t.id:t;this._assetReference.id=e}_onSetRootBone(t){t&&this._onRootBoneChanged()}_onRootBoneChanged(){this._clearSkinInstances(),this.enabled&&this.entity.enabled&&this._cloneSkinInstances()}destroyMeshInstances(){const t=this._meshInstances;if(t){this.removeFromLayers(),this._clearSkinInstances();for(let e=0;e<t.length;e++)t[e].destroy();this._meshInstances.length=0}}addToLayers(){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.addMeshInstances(this._meshInstances)}}removeFromLayers(){if(this._meshInstances&&this._meshInstances.length){const t=this.system.app.scene.layers;for(let e=0;e<this._layers.length;e++){const s=t.getLayerById(this._layers[e]);s&&s.removeMeshInstances(this._meshInstances)}}}onRemoveChild(){this.removeFromLayers()}onInsertChild(){this._meshInstances&&this.enabled&&this.entity.enabled&&this.addToLayers()}onRemove(){this.destroyMeshInstances(),this.asset=null,this.materialAsset=null,this._assetReference.id=null;for(let t=0;t<this._materialReferences.length;t++)this._materialReferences[t].id=null;this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)}onLayersChanged(t,e){this.addToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||t.addMeshInstances(this._meshInstances)}onLayerRemoved(t){this.layers.indexOf(t.id)<0||t.removeMeshInstances(this._meshInstances)}onEnable(){const t=this.system.app,e=t.scene;this._rootBone.onParentComponentEnable(),this._cloneSkinInstances(),e.on("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.on("add",this.onLayerAdded,this),e.layers.on("remove",this.onLayerRemoved,this));const s="asset"===this._type;this._meshInstances&&this._meshInstances.length?this.addToLayers():s&&this.asset&&this._onRenderAssetAdded();for(let t=0;t<this._materialReferences.length;t++)this._materialReferences[t].asset&&this.system.app.assets.load(this._materialReferences[t].asset);var i;this._batchGroupId>=0&&(null==(i=t.batcher)||i.insert(Qi.RENDER,this.batchGroupId,this.entity))}onDisable(){const t=this.system.app,e=t.scene;var s;(e.off("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.off("add",this.onLayerAdded,this),e.layers.off("remove",this.onLayerRemoved,this)),this._batchGroupId>=0)&&(null==(s=t.batcher)||s.remove(Qi.RENDER,this.batchGroupId,this.entity));this.removeFromLayers()}hide(){if(this._meshInstances)for(let t=0;t<this._meshInstances.length;t++)this._meshInstances[t].visible=!1}show(){if(this._meshInstances)for(let t=0;t<this._meshInstances.length;t++)this._meshInstances[t].visible=!0}_onRenderAssetAdded(){this._assetReference.asset&&(this._assetReference.asset.resource?this._onRenderAssetLoad():this.enabled&&this.entity.enabled&&this.system.app.assets.load(this._assetReference.asset))}_onRenderAssetLoad(){if(this.destroyMeshInstances(),this._assetReference.asset){const t=this._assetReference.asset.resource;t.off("set:meshes",this._onSetMeshes,this),t.on("set:meshes",this._onSetMeshes,this),t.meshes&&this._onSetMeshes(t.meshes)}}_onSetMeshes(t){this._cloneMeshes(t)}_clearSkinInstances(){for(let t=0;t<this._meshInstances.length;t++){const e=this._meshInstances[t];Nh.removeCachedSkinInstance(e.skinInstance),e.skinInstance=null}}_cloneSkinInstances(){if(this._meshInstances.length&&this._rootBone.entity instanceof gn)for(let t=0;t<this._meshInstances.length;t++){const e=this._meshInstances[t],s=e.mesh;s.skin&&!e.skinInstance&&(e.skinInstance=Nh.createCachedSkinInstance(s.skin,this._rootBone.entity,this.entity))}}_cloneMeshes(t){if(t&&t.length){const e=[];for(let s=0;s<t.length;s++){const i=t[s],n=this._materialReferences[s]&&this._materialReferences[s].asset&&this._materialReferences[s].asset.resource,r=new Sn(i,n||this.system.defaultMaterial,this.entity);e.push(r),i.morph&&(r.morphInstance=new So(i.morph))}this.meshInstances=e,this._cloneSkinInstances()}}_onRenderAssetUnload(){"asset"===this._type&&this.destroyMeshInstances()}_onRenderAssetRemove(){this._assetReference.asset&&this._assetReference.asset.resource&&this._assetReference.asset.resource.off("set:meshes",this._onSetMeshes,this),this._onRenderAssetUnload()}_onMaterialAdded(t,e,s){s.resource?this._onMaterialLoad(t,e,s):this.enabled&&this.entity.enabled&&this.system.app.assets.load(s)}_updateMainMaterial(t,e){0===t&&(this.material=e)}_onMaterialLoad(t,e,s){this._meshInstances[t]&&(this._meshInstances[t].material=s.resource),this._updateMainMaterial(t,s.resource)}_onMaterialRemove(t,e,s){this._meshInstances[t]&&(this._meshInstances[t].material=this.system.defaultMaterial),this._updateMainMaterial(t,this.system.defaultMaterial)}_onMaterialUnload(t,e,s){this._meshInstances[t]&&(this._meshInstances[t].material=this.system.defaultMaterial),this._updateMainMaterial(t,this.system.defaultMaterial)}resolveDuplicatedEntityReferenceProperties(t,e){t.rootBone&&e[t.rootBone]&&(this.rootBone=e[t.rootBone]),this._clearSkinInstances()}}class Hh{constructor(){this.enabled=!0,this.rootBone=null}}const Gh=[{name:"rootBone",type:"entity"},"enabled"],Wh=["material","meshInstances","asset","materialAssets","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","renderStyle","type","layers","isStatic","batchGroupId"];class jh extends Xl{constructor(t){super(t),this.id="render",this.ComponentType=Vh,this.DataType=Hh,this.schema=Gh,this.defaultMaterial=qi(t.graphicsDevice),this.on("beforeremove",this.onRemove,this)}initializeComponentData(t,e,s){null!==e.batchGroupId&&void 0!==e.batchGroupId||(e.batchGroupId=-1),e.layers&&e.layers.length&&(e.layers=e.layers.slice(0));for(let s=0;s<Wh.length;s++)e.hasOwnProperty(Wh[s])&&(t[Wh[s]]=e[Wh[s]]);e.aabbCenter&&e.aabbHalfExtents&&(t.customAabb=new $(new R(e.aabbCenter),new R(e.aabbHalfExtents))),super.initializeComponentData(t,e,Gh)}cloneComponent(t,e){const s={};for(let e=0;e<Wh.length;e++)s[Wh[e]]=t.render[Wh[e]];s.enabled=t.render.enabled,delete s.meshInstances;const i=this.addComponent(e,s),n=t.render.meshInstances,r=n.map((t=>t.mesh));i._onSetMeshes(r);for(let t=0;t<n.length;t++)i.meshInstances[t].material=n[t].material;return t.render.customAabb&&(i.customAabb=t.render.customAabb.clone()),i}onRemove(t,e){e.onRemove()}}ql._buildAccessors(Vh.prototype,Gh);class qh{constructor(t,e){this.effect=t,this.inputTarget=e,this.outputTarget=null,this.name=t.constructor.name}}class Xh{constructor(t,e){this.app=t,this.camera=e,this.destinationRenderTarget=null,this.effects=[],this.enabled=!1,this.depthTarget=null,e.on("set:rect",this.onCameraRectChanged,this)}_allocateColorBuffer(t,e){var s,i,n,r;const a=this.camera.rect,o=Math.floor(a.z*(null!=(s=null==(i=this.camera.renderTarget)?void 0:i.width)?s:this.app.graphicsDevice.width)),l=Math.floor(a.w*(null!=(n=null==(r=this.camera.renderTarget)?void 0:r.height)?n:this.app.graphicsDevice.height));return new Ue(this.app.graphicsDevice,{name:e,format:t,width:o,height:l,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})}_createOffscreenTarget(t,e){const s=this.app.graphicsDevice,i=e&&s.getHdrFormat(!1,!0,!1,!1)||7,n=this.camera.entity.name+"-posteffect-"+this.effects.length,r=this._allocateColorBuffer(i,n);return new pe({colorBuffer:r,depth:t,stencil:t&&this.app.graphicsDevice.supportsStencil,samples:t?s.samples:1})}_resizeOffscreenTarget(t){const e=t.colorBuffer.format,s=t.colorBuffer.name;t.destroyFrameBuffers(),t.destroyTextureBuffers(),t._colorBuffer=this._allocateColorBuffer(e,s),t._colorBuffers=[t._colorBuffer]}_destroyOffscreenTarget(t){t.destroyTextureBuffers(),t.destroy()}addEffect(t){const e=this.effects,s=0===e.length,i=this._createOffscreenTarget(s,t.hdr),n=new qh(t,i);e.push(n),this._sourceTarget=n.inputTarget,e.length>1&&(e[e.length-2].outputTarget=n.inputTarget),this._newPostEffect=t,t.needsDepthBuffer&&this._requestDepthMap(),this.enable(),this._newPostEffect=void 0}removeEffect(t){let e=-1;for(let s=0,i=this.effects.length;s<i;s++)if(this.effects[s].effect===t){e=s;break}e>=0&&(e>0?this.effects[e-1].outputTarget=e+1<this.effects.length?this.effects[e+1].inputTarget:null:this.effects.length>1&&(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),this.camera.renderTarget=this.effects[1].inputTarget),this._destroyOffscreenTarget(this.effects[e].inputTarget),this.effects.splice(e,1)),this.enabled&&t.needsDepthBuffer&&this._releaseDepthMap(),0===this.effects.length&&this.disable()}_requestDepthMaps(){for(let t=0,e=this.effects.length;t<e;t++){const e=this.effects[t].effect;this._newPostEffect!==e&&(e.needsDepthBuffer&&this._requestDepthMap())}}_releaseDepthMaps(){for(let t=0,e=this.effects.length;t<e;t++){this.effects[t].effect.needsDepthBuffer&&this._releaseDepthMap()}}_requestDepthMap(){const t=this.app.scene.layers.getLayerById(1);t&&(t.incrementCounter(),this.camera.requestSceneDepthMap(!0))}_releaseDepthMap(){const t=this.app.scene.layers.getLayerById(1);t&&(t.decrementCounter(),this.camera.requestSceneDepthMap(!1))}destroy(){for(let t=0,e=this.effects.length;t<e;t++)this.effects[t].inputTarget.destroy();this.effects.length=0,this.disable()}enable(){!this.enabled&&this.effects.length&&(this.enabled=!0,this._requestDepthMaps(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.destinationRenderTarget=this.camera.renderTarget,this.camera.renderTarget=this.effects[0].inputTarget,this.camera.onPostprocessing=()=>{if(this.enabled){let t=null;const e=this.effects.length;if(e)for(let s=0;s<e;s++){const i=this.effects[s];let n=i.outputTarget;s===e-1&&(t=this.camera.rect,this.destinationRenderTarget&&(n=this.destinationRenderTarget)),i.effect.render(i.inputTarget,n,t)}}})}disable(){this.enabled&&(this.enabled=!1,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this._releaseDepthMaps(),this._destroyOffscreenTarget(this._sourceTarget),this.camera.renderTarget=null,this.camera.onPostprocessing=null)}_onCanvasResized(t,e){const s=this.camera.rect,i=this.app.graphicsDevice;this.camera.camera.aspectRatio=i.width*s.z/(i.height*s.w),this.resizeRenderTargets()}resizeRenderTargets(){const t=this.camera.rect,e=Math.floor(t.z*this.app.graphicsDevice.width),s=Math.floor(t.w*this.app.graphicsDevice.height),i=this.effects;for(let t=0,n=i.length;t<n;t++){const n=i[t];n.inputTarget.width===e&&n.inputTarget.height===s||this._resizeOffscreenTarget(n.inputTarget)}}onCameraRectChanged(t,e,s){this.enabled&&this.resizeRenderTargets()}}class $h extends ql{constructor(t,e){super(t,e),this.onPostprocessing=null,this.onPreRender=null,this.onPostRender=null,this._renderSceneDepthMap=0,this._renderSceneColorMap=0,this._sceneDepthMapRequested=!1,this._sceneColorMapRequested=!1,this._priority=0,this._disablePostEffectsLayer=4,this._camera=new An,this._camera.node=e,this._postEffects=new Xh(t.app,this)}setShaderPass(t){const e=Ni.get(this.system.app.graphicsDevice),s=t?e.allocate(t,{isForward:!0}):null;return this._camera.shaderPassInfo=s,s.index}getShaderPass(){var t;return null==(t=this._camera.shaderPassInfo)?void 0:t.name}set aperture(t){this._camera.aperture=t}get aperture(){return this._camera.aperture}set aspectRatio(t){this._camera.aspectRatio=t}get aspectRatio(){return this._camera.aspectRatio}set aspectRatioMode(t){this._camera.aspectRatioMode=t}get aspectRatioMode(){return this._camera.aspectRatioMode}set calculateProjection(t){this._camera.calculateProjection=t}get calculateProjection(){return this._camera.calculateProjection}set calculateTransform(t){this._camera.calculateTransform=t}get calculateTransform(){return this._camera.calculateTransform}get camera(){return this._camera}set clearColor(t){this._camera.clearColor=t}get clearColor(){return this._camera.clearColor}set clearColorBuffer(t){this._camera.clearColorBuffer=t,this.dirtyLayerCompositionCameras()}get clearColorBuffer(){return this._camera.clearColorBuffer}set clearDepthBuffer(t){this._camera.clearDepthBuffer=t,this.dirtyLayerCompositionCameras()}get clearDepthBuffer(){return this._camera.clearDepthBuffer}set clearStencilBuffer(t){this._camera.clearStencilBuffer=t,this.dirtyLayerCompositionCameras()}get clearStencilBuffer(){return this._camera.clearStencilBuffer}set cullFaces(t){this._camera.cullFaces=t}get cullFaces(){return this._camera.cullFaces}set disablePostEffectsLayer(t){this._disablePostEffectsLayer=t,this.dirtyLayerCompositionCameras()}get disablePostEffectsLayer(){return this._disablePostEffectsLayer}set farClip(t){this._camera.farClip=t}get farClip(){return this._camera.farClip}set flipFaces(t){this._camera.flipFaces=t}get flipFaces(){return this._camera.flipFaces}set fov(t){this._camera.fov=t}get fov(){return this._camera.fov}get frustum(){return this._camera.frustum}set frustumCulling(t){this._camera.frustumCulling=t}get frustumCulling(){return this._camera.frustumCulling}set horizontalFov(t){this._camera.horizontalFov=t}get horizontalFov(){return this._camera.horizontalFov}set layers(t){const e=this._camera.layers;for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.removeCamera(this)}if(this._camera.layers=t,this.enabled&&this.entity.enabled)for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&s.addCamera(this)}}get layers(){return this._camera.layers}get layersSet(){return this._camera.layersSet}set nearClip(t){this._camera.nearClip=t}get nearClip(){return this._camera.nearClip}set orthoHeight(t){this._camera.orthoHeight=t}get orthoHeight(){return this._camera.orthoHeight}get postEffects(){return this._postEffects}get postEffectsEnabled(){return this._postEffects.enabled}set priority(t){this._priority=t,this.dirtyLayerCompositionCameras()}get priority(){return this._priority}set projection(t){this._camera.projection=t}get projection(){return this._camera.projection}get projectionMatrix(){return this._camera.projectionMatrix}set rect(t){this._camera.rect=t,this.fire("set:rect",this._camera.rect)}get rect(){return this._camera.rect}set renderSceneColorMap(t){t&&!this._sceneColorMapRequested?(this.requestSceneColorMap(!0),this._sceneColorMapRequested=!0):this._sceneColorMapRequested&&(this.requestSceneColorMap(!1),this._sceneColorMapRequested=!1)}get renderSceneColorMap(){return this._renderSceneColorMap>0}set renderSceneDepthMap(t){t&&!this._sceneDepthMapRequested?(this.requestSceneDepthMap(!0),this._sceneDepthMapRequested=!0):this._sceneDepthMapRequested&&(this.requestSceneDepthMap(!1),this._sceneDepthMapRequested=!1)}get renderSceneDepthMap(){return this._renderSceneDepthMap>0}set renderTarget(t){this._camera.renderTarget=t,this.dirtyLayerCompositionCameras()}get renderTarget(){return this._camera.renderTarget}set scissorRect(t){this._camera.scissorRect=t}get scissorRect(){return this._camera.scissorRect}set sensitivity(t){this._camera.sensitivity=t}get sensitivity(){return this._camera.sensitivity}set shutter(t){this._camera.shutter=t}get shutter(){return this._camera.shutter}get viewMatrix(){return this._camera.viewMatrix}_enableDepthLayer(t){if(this.layers.find((t=>1===t))){const e=this.system.app.scene.layers.getLayerById(1);t?null==e||e.incrementCounter():null==e||e.decrementCounter()}else if(t)return!1;return!0}requestSceneColorMap(t){this._renderSceneColorMap+=t?1:-1,this._enableDepthLayer(t)}requestSceneDepthMap(t){this._renderSceneDepthMap+=t?1:-1,this._enableDepthLayer(t)}dirtyLayerCompositionCameras(){this.system.app.scene.layers._dirtyCameras=!0}screenToWorld(t,e,s,i){const n=this.system.app.graphicsDevice,r=n.clientRect.width,a=n.clientRect.height;return this._camera.screenToWorld(t,e,s,r,a,i)}worldToScreen(t,e){const s=this.system.app.graphicsDevice,i=s.clientRect.width,n=s.clientRect.height;return this._camera.worldToScreen(t,i,n,e)}onAppPrerender(){this._camera._viewMatDirty=!0,this._camera._viewProjMatDirty=!0}addCameraToLayers(){const t=this.layers;for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&s.addCamera(this)}}removeCameraFromLayers(){const t=this.layers;for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&s.removeCamera(this)}}onLayersChanged(t,e){this.addCameraToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)<0||t.addCamera(this)}onLayerRemoved(t){this.layers.indexOf(t.id)<0||t.removeCamera(this)}onEnable(){const t=this.system,e=t.app.scene,s=e.layers;t.addCamera(this),e.on("set:layers",this.onLayersChanged,this),s&&(s.on("add",this.onLayerAdded,this),s.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addCameraToLayers(),this.postEffects.enable()}onDisable(){const t=this.system,e=t.app.scene,s=e.layers;this.postEffects.disable(),this.removeCameraFromLayers(),e.off("set:layers",this.onLayersChanged,this),s&&(s.off("add",this.onLayerAdded,this),s.off("remove",this.onLayerRemoved,this)),t.removeCamera(this)}onRemove(){this.onDisable(),this.off()}calculateAspectRatio(t){const e=this.system.app.graphicsDevice,s=t?t.width:e.width,i=t?t.height:e.height;return s*this.rect.z/(i*this.rect.w)}frameUpdate(t){0===this.aspectRatioMode&&(this.aspectRatio=this.calculateAspectRatio(t))}startXr(t,e,s){this.system.app.xr.start(this,t,e,s)}endXr(t){this._camera.xr?this._camera.xr.end(t):t&&t(new Error("Camera is not in XR"))}copy(t){this.aperture=t.aperture,this.aspectRatio=t.aspectRatio,this.aspectRatioMode=t.aspectRatioMode,this.calculateProjection=t.calculateProjection,this.calculateTransform=t.calculateTransform,this.clearColor=t.clearColor,this.clearColorBuffer=t.clearColorBuffer,this.clearDepthBuffer=t.clearDepthBuffer,this.clearStencilBuffer=t.clearStencilBuffer,this.cullFaces=t.cullFaces,this.disablePostEffectsLayer=t.disablePostEffectsLayer,this.farClip=t.farClip,this.flipFaces=t.flipFaces,this.fov=t.fov,this.frustumCulling=t.frustumCulling,this.horizontalFov=t.horizontalFov,this.layers=t.layers,this.nearClip=t.nearClip,this.orthoHeight=t.orthoHeight,this.priority=t.priority,this.projection=t.projection,this.rect=t.rect,this.renderTarget=t.renderTarget,this.scissorRect=t.scissorRect,this.sensitivity=t.sensitivity,this.shutter=t.shutter}}class Kh{constructor(){this.enabled=!0}}const Yh=["enabled"];class Qh extends Xl{constructor(t){super(t),this.cameras=[],this.id="camera",this.ComponentType=$h,this.DataType=Kh,this.schema=Yh,this.on("beforeremove",this.onBeforeRemove,this),this.app.on("prerender",this.onAppPrerender,this),this.app.systems.on("update",this.onUpdate,this)}initializeComponentData(t,e,s){s=["aspectRatio","aspectRatioMode","calculateProjection","calculateTransform","clearColor","clearColorBuffer","clearDepthBuffer","clearStencilBuffer","renderSceneColorMap","renderSceneDepthMap","cullFaces","farClip","flipFaces","fov","frustumCulling","horizontalFov","layers","renderTarget","nearClip","orthoHeight","projection","priority","rect","scissorRect","aperture","shutter","sensitivity"];for(let i=0;i<s.length;i++){const n=s[i];if(e.hasOwnProperty(n)){const s=e[n];switch(n){case"rect":case"scissorRect":Array.isArray(s)?t[n]=new O(s[0],s[1],s[2],s[3]):t[n]=s;break;case"clearColor":Array.isArray(s)?t[n]=new D(s[0],s[1],s[2],s[3]):t[n]=s;break;default:t[n]=s}}}super.initializeComponentData(t,e,["enabled"])}cloneComponent(t,e){const s=t.camera;return this.addComponent(e,{aspectRatio:s.aspectRatio,aspectRatioMode:s.aspectRatioMode,calculateProjection:s.calculateProjection,calculateTransform:s.calculateTransform,clearColor:s.clearColor,clearColorBuffer:s.clearColorBuffer,clearDepthBuffer:s.clearDepthBuffer,clearStencilBuffer:s.clearStencilBuffer,renderSceneDepthMap:s.renderSceneDepthMap,renderSceneColorMap:s.renderSceneColorMap,cullFaces:s.cullFaces,enabled:s.enabled,farClip:s.farClip,flipFaces:s.flipFaces,fov:s.fov,frustumCulling:s.frustumCulling,horizontalFov:s.horizontalFov,layers:s.layers,renderTarget:s.renderTarget,nearClip:s.nearClip,orthoHeight:s.orthoHeight,projection:s.projection,priority:s.priority,rect:s.rect,scissorRect:s.scissorRect,aperture:s.aperture,sensitivity:s.sensitivity,shutter:s.shutter})}onBeforeRemove(t,e){this.removeCamera(e)}onUpdate(t){}onAppPrerender(){for(let t=0,e=this.cameras.length;t<e;t++)this.cameras[t].onAppPrerender()}addCamera(t){this.cameras.push(t),ao(this.cameras)}removeCamera(t){const e=this.cameras.indexOf(t);e>=0&&(this.cameras.splice(e,1),ao(this.cameras))}destroy(){super.destroy(),this.app.systems.off("update",this.onUpdate,this)}}ql._buildAccessors($h.prototype,Yh);const Jh=[],Zh=[];class tc extends ql{constructor(t,e){super(t,e),this._cookieAsset=null,this._cookieAssetId=null,this._cookieAssetAdd=!1,this._cookieMatrix=null}addLightToLayers(){for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);e&&e.addLight(this)}}removeLightFromLayers(){for(let t=0;t<this.layers.length;t++){const e=this.system.app.scene.layers.getLayerById(this.layers[t]);e&&e.removeLight(this)}}onLayersChanged(t,e){this.enabled&&this.entity.enabled&&this.addLightToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)}onLayerAdded(t){this.layers.indexOf(t.id)>=0&&this.enabled&&this.entity.enabled&&t.addLight(this)}onLayerRemoved(t){this.layers.indexOf(t.id)>=0&&t.removeLight(this)}refreshProperties(){for(let t=0;t<Jh.length;t++){const e=Jh[t];this[e]=this[e]}this.enabled&&this.entity.enabled&&this.onEnable()}onCookieAssetSet(){let t=!1;"cubemap"!==this._cookieAsset.type||this._cookieAsset.loadFaces||(this._cookieAsset.loadFaces=!0,t=!0),this._cookieAsset.resource&&!t||this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad()}onCookieAssetAdd(t){this._cookieAssetId===t.id&&(this._cookieAsset=t,this.light.enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this))}onCookieAssetLoad(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource)}onCookieAssetRemove(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)}onEnable(){this.light.enabled=!0,this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet()}onDisable(){this.light.enabled=!1,this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.removeLightFromLayers()}onRemove(){this.onDisable(),this.light.destroy(),this.cookieAsset=null}set shadowUpdateOverrides(t){this.light.shadowUpdateOverrides=t}get shadowUpdateOverrides(){return this.light.shadowUpdateOverrides}set penumbraSize(t){this.light.penumbraSize=t}get penumbraSize(){return this.light.penumbraSize}}function ec(t,e,s,i){const n=tc.prototype;Jh.push(t),Zh.push(e),Object.defineProperty(n,t,{get:function(){return this.data[t]},set:function(e){const n=this.data,r=n[t];(i||r!==e)&&(n[t]=e,s&&s.call(this,e,r))},configurable:!0})}ec("enabled",!0,(function(t,e){this.onSetEnabled(null,e,t)})),ec("light",null),ec("type","directional",(function(t,e){this.system.changeType(this,e,t),this.refreshProperties()})),ec("color",new D(1,1,1),(function(t,e){this.light.setColor(t)}),!0),ec("intensity",1,(function(t,e){this.light.intensity=t})),ec("luminance",0,(function(t,e){this.light.luminance=t})),ec("shape",0,(function(t,e){this.light.shape=t})),ec("affectSpecularity",!0,(function(t,e){this.light.affectSpecularity=t})),ec("castShadows",!1,(function(t,e){this.light.castShadows=t})),ec("shadowDistance",40,(function(t,e){this.light.shadowDistance=t})),ec("shadowIntensity",1,(function(t,e){this.light.shadowIntensity=t})),ec("shadowResolution",1024,(function(t,e){this.light.shadowResolution=t})),ec("shadowBias",.05,(function(t,e){this.light.shadowBias=-.01*k.clamp(t,0,1)})),ec("numCascades",1,(function(t,e){this.light.numCascades=k.clamp(Math.floor(t),1,4)})),ec("bakeNumSamples",1,(function(t,e){this.light.bakeNumSamples=k.clamp(Math.floor(t),1,255)})),ec("bakeArea",0,(function(t,e){this.light.bakeArea=k.clamp(t,0,180)})),ec("cascadeDistribution",.5,(function(t,e){this.light.cascadeDistribution=k.clamp(t,0,1)})),ec("normalOffsetBias",0,(function(t,e){this.light.normalOffsetBias=k.clamp(t,0,1)})),ec("range",10,(function(t,e){this.light.attenuationEnd=t})),ec("innerConeAngle",40,(function(t,e){this.light.innerConeAngle=t})),ec("outerConeAngle",45,(function(t,e){this.light.outerConeAngle=t})),ec("falloffMode",0,(function(t,e){this.light.falloffMode=t})),ec("shadowType",0,(function(t,e){this.light.shadowType=t})),ec("vsmBlurSize",11,(function(t,e){this.light.vsmBlurSize=t})),ec("vsmBlurMode",1,(function(t,e){this.light.vsmBlurMode=t})),ec("vsmBias",.0025,(function(t,e){this.light.vsmBias=k.clamp(t,0,1)})),ec("cookieAsset",null,(function(t,e){if(!this._cookieAssetId||!(t instanceof cl&&t.id===this._cookieAssetId||t===this._cookieAssetId))if(this.onCookieAssetRemove(),this._cookieAssetId=null,t instanceof cl)this.data.cookieAsset=t.id,this._cookieAssetId=t.id,this.onCookieAssetAdd(t);else if("number"==typeof t){this._cookieAssetId=t;const e=this.system.app.assets.get(t);e?this.onCookieAssetAdd(e):(this._cookieAssetAdd=!0,this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this))}})),ec("cookie",null,(function(t,e){this.light.cookie=t})),ec("cookieIntensity",1,(function(t,e){this.light.cookieIntensity=k.clamp(t,0,1)})),ec("cookieFalloff",!0,(function(t,e){this.light.cookieFalloff=t})),ec("cookieChannel","rgb",(function(t,e){this.light.cookieChannel=t})),ec("cookieAngle",0,(function(t,e){if(0!==t||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new O);let e=1,s=1;this.cookieScale&&(e=this.cookieScale.x,s=this.cookieScale.y);const i=Math.cos(t*k.DEG_TO_RAD),n=Math.sin(t*k.DEG_TO_RAD);this._cookieMatrix.set(i/e,-n/e,n/s,i/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null})),ec("cookieScale",null,(function(t,e){if(null!==t||0!==this.cookieAngle){this._cookieMatrix||(this._cookieMatrix=new O);const e=t.x,s=t.y,i=Math.cos(this.cookieAngle*k.DEG_TO_RAD),n=Math.sin(this.cookieAngle*k.DEG_TO_RAD);this._cookieMatrix.set(i/e,-n/e,n/s,i/s),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null}),!0),ec("cookieOffset",null,(function(t,e){this.light.cookieOffset=t}),!0),ec("shadowUpdateMode",2,(function(t,e){this.light.shadowUpdateMode=t}),!0),ec("mask",1,(function(t,e){this.light.mask=t})),ec("affectDynamic",!0,(function(t,e){t?this.light.mask|=1:this.light.mask&=-2,this.light.layersDirty()})),ec("affectLightmapped",!1,(function(t,e){t?(this.light.mask|=2,this.bake&&(this.light.mask&=-5)):(this.light.mask&=-3,this.bake&&(this.light.mask|=4))})),ec("bake",!1,(function(t,e){t?(this.light.mask|=4,this.affectLightmapped&&(this.light.mask&=-3)):(this.light.mask&=-5,this.affectLightmapped&&(this.light.mask|=2)),this.light.layersDirty()})),ec("bakeDir",!0,(function(t,e){this.light.bakeDir=t})),ec("isStatic",!1,(function(t,e){this.light.isStatic=t})),ec("layers",[0],(function(t,e){for(let t=0;t<e.length;t++){const s=this.system.app.scene.layers.getLayerById(e[t]);s&&s.removeLight(this)}for(let e=0;e<t.length;e++){const s=this.system.app.scene.layers.getLayerById(t[e]);s&&this.enabled&&this.entity.enabled&&s.addLight(this)}})),Jh.push("penumbraSize"),Zh.push(1);class sc{constructor(){const t=Jh,e=Zh;for(let s=0;s<t.length;s++){const i=e[s];i&&i.clone?this[t[s]]=i.clone():this[t[s]]=i}}}class ic extends Xl{constructor(t){super(t),this.id="light",this.ComponentType=tc,this.DataType=sc,this.on("beforeremove",this._onRemoveComponent,this)}initializeComponentData(t,e){const s=Jh,i={};for(let t=0,n=s.length;t<n;t++){const n=s[t];i[n]=e[n]}i.type||(i.type=t.data.type),t.data.type=i.type,i.layers&&Array.isArray(i.layers)&&(i.layers=i.layers.slice(0)),i.color&&Array.isArray(i.color)&&(i.color=new D(i.color[0],i.color[1],i.color[2])),i.cookieOffset&&i.cookieOffset instanceof Array&&(i.cookieOffset=new I(i.cookieOffset[0],i.cookieOffset[1])),i.cookieScale&&i.cookieScale instanceof Array&&(i.cookieScale=new I(i.cookieScale[0],i.cookieScale[1])),i.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),i.enabled=i.enable),i.shape||(i.shape=0);const n=new yo(this.app.graphicsDevice);n.type=go[i.type],n._node=t.entity,n._scene=this.app.scene,t.data.light=n,super.initializeComponentData(t,i,s)}_onRemoveComponent(t,e){e.onRemove()}cloneComponent(t,e){const s=t.light,i=[];let n;const r=Jh;for(let t=0;t<r.length;t++)n=r[t],"light"!==n&&(s[n]&&s[n].clone?i[n]=s[n].clone():i[n]=s[n]);return this.addComponent(e,i)}changeType(t,e,s){e!==s&&(t.light.type=go[s])}}class nc extends h{constructor(){super(),this._meshes=null}set meshes(t){this.decRefMeshes(),this._meshes=t,this.incRefMeshes(),this.fire("set:meshes",t)}get meshes(){return this._meshes}destroy(){this.meshes=null}decRefMeshes(){if(this._meshes){const t=this._meshes.length;for(let e=0;e<t;e++){const t=this._meshes[e];t&&(t.decRefCount(),t.refCount<1&&(t.destroy(),this._meshes[e]=null))}}}incRefMeshes(){if(this._meshes){const t=this._meshes.length;for(let e=0;e<t;e++)this._meshes[e]&&this._meshes[e].incRefCount()}}}function rc(t){const e=this;if(!e.resource)return;const s=t.resource,i=s.renders&&s.renders[e.data.renderIndex];i&&(e.resource.meshes=i.resource.meshes)}function ac(t){const e=this;e.registry.off("load:"+t.id,rc,e),e.registry.on("load:"+t.id,rc,e),e.registry.off("remove:"+t.id,oc,e),e.registry.once("remove:"+t.id,oc,e),t.resource?rc.call(e,t):e.registry.load(t)}function oc(t){const e=this;e.registry.off("load:"+t.id,rc,e),e.resource&&e.resource.destroy()}class lc{constructor(t){this.handlerType="render",this._registry=t.assets}load(t,e,s){}open(t,e){return new nc}patch(t,e){if(!t.data.containerAsset)return;const s=e.get(t.data.containerAsset);s?ac.call(t,s):e.once("add:"+t.data.containerAsset,ac,t)}}class hc{constructor(t,e,s,i){this._paths=t,this._input=e,this._output=s,this._interpolation=i}get paths(){return this._paths}get input(){return this._input}get output(){return this._output}get interpolation(){return this._interpolation}}class cc{constructor(t,e){this._components=t,this._data=e}get components(){return this._components}get data(){return this._data}}function dc(t,e){let s;const i=(t,e)=>{switch(e){case s.DT_INT8:return new Int8Array(t.buffer,t.byteOffset,t.byteLength);case s.DT_INT16:return new Int16Array(t.buffer,t.byteOffset,t.byteLength/2);case s.DT_INT32:return new Int32Array(t.buffer,t.byteOffset,t.byteLength/4);case s.DT_UINT8:return new Uint8Array(t.buffer,t.byteOffset,t.byteLength);case s.DT_UINT16:return new Uint16Array(t.buffer,t.byteOffset,t.byteLength/2);case s.DT_UINT32:return new Uint32Array(t.buffer,t.byteOffset,t.byteLength/4);case s.DT_FLOAT32:return new Float32Array(t.buffer,t.byteOffset,t.byteLength/4)}return null},n=t=>t.num_components()*(t=>{switch(t){case s.DT_INT8:return 1;case s.DT_INT16:return 2;case s.DT_INT32:return 4;case s.DT_UINT8:return 1;case s.DT_UINT16:return 2;case s.DT_UINT32:case s.DT_FLOAT32:return 4}return 1})(t.data_type()),r={0:0,1:1,5:2,2:3,7:4,8:5,4:6,3:7},a=(t,e)=>{const s=(t,e,s)=>{t[0]=e[0]-s[0],t[1]=e[1]-s[1],t[2]=e[2]-s[2]},i=(t,e,s)=>{t[0]=e[1]*s[2]-s[1]*e[2],t[1]=e[2]*s[0]-s[2]*e[0],t[2]=e[0]*s[1]-s[0]*e[1]},n=(t,e)=>{const s=t[e+0],i=t[e+1],n=t[e+2],r=1/Math.sqrt(s*s+i*i+n*n);t[e+0]*=r,t[e+1]*=r,t[e+2]*=r},r=(t,e,s)=>{for(let i=0;i<3;++i)t[i]=e[s+i]},a=e.length/3,o=t.length/3,l=new Float32Array(t.length),h=[0,0,0],c=[0,0,0],d=[0,0,0],u=[0,0,0],p=[0,0,0],f=[0,0,0];for(let o=0;o<a;++o){const a=3*e[3*o+0],m=3*e[3*o+1],g=3*e[3*o+2];r(h,t,a),r(c,t,m),r(d,t,g),s(u,c,h),s(p,d,h),i(f,u,p),n(f,0);for(let t=0;t<3;++t)l[a+t]+=f[t],l[m+t]+=f[t],l[g+t]+=f[t]}for(let t=0;t<o;++t)n(l,3*t);return new Uint8Array(l.buffer)},o=t=>{const e=(t=>{const e={},o=new s.DecoderBuffer;o.Init(t,t.length);const l=new s.Decoder;if(l.GetEncodedGeometryType(o)!==s.TRIANGULAR_MESH)return e.error="Failed to decode draco mesh: not a mesh",e;const h=new s.Mesh,c=l.DecodeBufferToMesh(o,h);if(!c||!c.ok()||0===h.ptr)return e.error="Failed to decode draco asset",e;const d=3*h.num_faces(),u=h.num_points()<=65535,p=d*(u?2:4),f=s._malloc(p);u?(l.GetTrianglesUInt16Array(h,p,f),e.indices=new Uint16Array(s.HEAPU16.buffer,f,d).slice().buffer):(l.GetTrianglesUInt32Array(h,p,f),e.indices=new Uint32Array(s.HEAPU32.buffer,f,d).slice().buffer),s._free(f);const m=[];for(let t=0;t<h.num_attributes();++t)m.push(l.GetAttribute(h,t));m.sort(((t,e)=>{var s,i;return(null!=(s=r[t.attribute_type()])?s:r.length)-(null!=(i=r[e.attribute_type()])?i:r.length)})),e.attributes=m.map((t=>t.unique_id()));let g=0;const _=m.map((t=>{const e=g;return g+=4*Math.ceil(n(t)/4),e})),v=m.some((t=>1===t.attribute_type())),b=_[1];if(!v){for(let t=1;t<_.length;++t)_[t]+=12;g+=12}e.vertices=new ArrayBuffer(h.num_points()*g);const y=new Uint8Array(e.vertices);for(let t=0;t<h.num_attributes();++t){const r=m[t],o=n(r),c=h.num_points()*o,d=s._malloc(c);l.GetAttributeDataArrayForAllPoints(h,r,r.data_type(),c,d);const p=new Uint8Array(s.HEAPU8.buffer,d,c);for(let e=0;e<h.num_points();++e)for(let s=0;s<o;++s)y[e*g+_[t]+s]=p[e*o+s];if(!v&&0===r.attribute_type()){const t=a(i(p,r.data_type()),u?new Uint16Array(e.indices):new Uint32Array(e.indices));for(let e=0;e<h.num_points();++e)for(let s=0;s<12;++s)y[e*g+b+s]=t[12*e+s]}s._free(d)}return s.destroy(h),s.destroy(l),s.destroy(o),e})(new Uint8Array(t.buffer));self.postMessage({jobId:t.jobId,error:e.error,indices:e.indices,vertices:e.vertices,attributes:e.attributes},[e.indices,e.vertices].filter((t=>null!=t)))},l=[];self.onmessage=t=>{const e=t.data;switch(e.type){case"init":self.DracoDecoderModule({instantiateWasm:(t,s)=>(WebAssembly.instantiate(e.module,t).then((t=>s(t))).catch((t=>console.error("instantiate failed + "+t))),{})}).then((t=>{s=t,l.forEach((t=>o(t)))}));break;case"decodeMesh":s?o(e):l.push(e)}}}class uc{constructor(){this.workers=[[],[],[]],this.jobId=0,this.jobQueue=[],this.jobCallbacks=new Map,this.run=(t,e)=>{t.postMessage({type:"decodeMesh",jobId:e.jobId,buffer:e.buffer},[e.buffer])}}init(t){for(t.forEach((t=>{t.addEventListener("message",(e=>{const s=e.data,i=this.jobCallbacks.get(s.jobId);if(i&&i(s.error,{indices:s.indices,vertices:s.vertices,attributes:s.attributes}),this.jobCallbacks.delete(s.jobId),this.jobQueue.length>0){const e=this.jobQueue.shift();this.run(t,e)}else{const e=this.workers[2].indexOf(t);if(-1!==e)this.workers[2].splice(e,1),this.workers[1].push(t);else{const e=this.workers[1].indexOf(t);-1!==e&&(this.workers[1].splice(e,1),this.workers[0].push(t))}}}))})),this.workers[0]=t;this.jobQueue.length&&(this.workers[0].length||this.workers[1].length);){const t=this.jobQueue.shift();if(this.workers[0].length>0){const e=this.workers[0].shift();this.workers[1].push(e),this.run(e,t)}else{const e=this.workers[1].shift();this.workers[2].push(e),this.run(e,t)}}}enqueueJob(t,e){const s={jobId:this.jobId++,buffer:t};if(this.jobCallbacks.set(s.jobId,e),this.workers[0].length>0){const t=this.workers[0].shift();this.workers[1].push(t),this.run(t,s)}else if(this.workers[1].length>0){const t=this.workers[1].shift();this.workers[2].push(t),this.run(t,s)}else this.jobQueue.push(s)}}const pc=t=>new Promise(((e,s)=>{const i={cache:!0,responseType:"text",retry:!0,maxRetries:3};Js.get(t,i,((t,i)=>{t?s(t):e(i)}))})),fc=t=>{const e=()=>fetch(t).then((t=>t.arrayBuffer())).then((t=>WebAssembly.compile(t)));return WebAssembly.compileStreaming?WebAssembly.compileStreaming(fetch(t)).catch((t=>e())):e()};let mc;const gc=(t,e)=>!!(t=>{if(mc)return!0;if(!t){const e=C.getConfig("DracoDecoderModule");t=e?{jsUrl:e.glueUrl,wasmUrl:e.wasmUrl,numWorkers:e.numWorkers}:{jsUrl:"draco.wasm.js",wasmUrl:"draco.wasm.wasm",numWorkers:1}}return!(!t.jsUrl||!t.wasmUrl||(mc=new uc,Promise.all([pc(t.jsUrl),fc(t.wasmUrl)]).then((([e,s])=>{const i=["/* draco */",e,"/* worker */",`(\n${dc.toString()}\n)()\n\n`].join("\n"),n=new Blob([i],{type:"application/javascript"}),r=URL.createObjectURL(n),a=Math.max(1,Math.min(16,t.numWorkers||1)),o=[];for(let t=0;t<a;++t){const t=new Worker(r);t.postMessage({type:"init",module:s}),o.push(t)}mc.init(o)})),0))})()&&(mc.enqueueJob(t,e),!0);class _c{constructor(){this.gltf=void 0,this.nodes=void 0,this.scenes=void 0,this.animations=void 0,this.textures=void 0,this.materials=void 0,this.variants=void 0,this.meshVariants=void 0,this.meshDefaultMaterials=void 0,this.renders=void 0,this.skins=void 0,this.lights=void 0,this.cameras=void 0}destroy(){this.renders&&this.renders.forEach((t=>{t.meshes=null}))}}const vc=t=>/^data:.*,.*$/i.test(t),bc=t=>{switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":default:return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}},yc=t=>{switch(t){case 5120:default:return 0;case 5121:return zt;case 5122:return 2;case 5123:return 3;case 5124:return 4;case 5125:return 5;case 5126:return 6}},xc=t=>{switch(t){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:return 0}},wc={POSITION:at,NORMAL:ot,TANGENT:lt,COLOR_0:dt,JOINTS_0:ct,WEIGHTS_0:ht,TEXCOORD_0:pt,TEXCOORD_1:ft,TEXCOORD_2:mt,TEXCOORD_3:gt,TEXCOORD_4:_t,TEXCOORD_5:vt,TEXCOORD_6:bt,TEXCOORD_7:yt},Sc={[at]:0,[ot]:1,[lt]:2,[dt]:3,[ct]:4,[ht]:5,[pt]:6,[ft]:7,[mt]:8,[gt]:9,[_t]:10,[vt]:11,[bt]:12,[yt]:13},Cc=(t,e,s)=>{const i=(t=>{switch(t){case 0:return t=>Math.max(t/127,-1);case zt:return t=>t/255;case 2:return t=>Math.max(t/32767,-1);case 3:return t=>t/65535;default:return t=>t}})(s),n=e.length;for(let s=0;s<n;++s)t[s]=i(e[s]);return t},Tc=(t,e,s=!1)=>{const i=bc(t.type),n=(t=>{switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}})(t.componentType);if(!n)return null;let r;if(t.sparse){const s=t.sparse,a={count:s.count,type:"SCALAR"},o=Tc(Object.assign(a,s.indices),e,!0),l={count:s.count,type:t.type,componentType:t.componentType},h=Tc(Object.assign(l,s.values),e,!0);if(t.hasOwnProperty("bufferView")){const s={bufferView:t.bufferView,byteOffset:t.byteOffset,componentType:t.componentType,count:t.count,type:t.type};r=Tc(s,e,!0).slice()}else r=new n(t.count*i);for(let t=0;t<s.count;++t){const e=o[t];for(let s=0;s<i;++s)r[e*i+s]=h[t*i+s]}}else if(t.hasOwnProperty("bufferView")){const a=e[t.bufferView];if(s&&a.hasOwnProperty("byteStride")){const e=i*n.BYTES_PER_ELEMENT,s=new ArrayBuffer(t.count*e),o=new Uint8Array(s);let l=0;for(let s=0;s<t.count;++s){let i=(t.byteOffset||0)+s*a.byteStride;for(let t=0;t<e;++t)o[l++]=a[i++]}r=new n(s)}else r=new n(a.buffer,a.byteOffset+(t.byteOffset||0),t.count*i)}else r=new n(t.count*i);return r},Ec=(t,e)=>{const s=Tc(t,e,!0);if(s instanceof Float32Array||!t.normalized)return s;const i=new Float32Array(s.length);return Cc(i,s,yc(t.componentType)),i},Pc=t=>{let e=t.min,s=t.max;if(!e||!s)return null;if(t.normalized){const i=yc(t.componentType);e=Cc([],e,i),s=Cc([],s,i)}return new $(new R(.5*(s[0]+e[0]),.5*(s[1]+e[1]),.5*(s[2]+e[2])),new R(.5*(s[0]-e[0]),.5*(s[1]-e[1]),.5*(s[2]-e[2])))},Mc=t=>{if(!t.hasOwnProperty("mode"))return 4;switch(t.mode){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:default:return 4;case 5:return rt;case 6:return 6}},Ac=(t,e)=>{const s=t[at];if(!s||3!==s.components)return;let i;if(s.size!==s.stride){const t=s.stride/Wt[s.type],e=new Gt[s.type](s.buffer,s.offset,s.count*t);i=new Gt[s.type](3*s.count);for(let n=0;n<s.count;++n)i[3*n+0]=e[n*t+0],i[3*n+1]=e[n*t+1],i[3*n+2]=e[n*t+2]}else i=new Gt[s.type](s.buffer,s.offset,3*s.count);const n=s.count;e||(e=(t=>{const e=new Uint16Array(t);for(let s=0;s<t;s++)e[s]=s;return e})(n));const r=function(t,e){const s=e.length/3,i=t.length/3,n=new R,r=new R,a=new R,o=new R,l=new R,h=new R,c=[];for(let e=0;e<t.length;e++)c[e]=0;for(let i=0;i<s;i++){const s=e[3*i],d=e[3*i+1],u=e[3*i+2];n.set(t[3*s],t[3*s+1],t[3*s+2]),r.set(t[3*d],t[3*d+1],t[3*d+2]),a.set(t[3*u],t[3*u+1],t[3*u+2]),o.sub2(r,n),l.sub2(a,n),h.cross(o,l).normalize(),c[3*s]+=h.x,c[3*s+1]+=h.y,c[3*s+2]+=h.z,c[3*d]+=h.x,c[3*d+1]+=h.y,c[3*d+2]+=h.z,c[3*u]+=h.x,c[3*u+1]+=h.y,c[3*u+2]+=h.z}for(let t=0;t<i;t++){const e=c[3*t],s=c[3*t+1],i=c[3*t+2],n=1/Math.sqrt(e*e+s*s+i*i);c[3*t]*=n,c[3*t+1]*=n,c[3*t+2]*=n}return c}(i,e),a=new Float32Array(r.length);a.set(r),t[ot]={buffer:a.buffer,size:12,offset:0,stride:12,count:n,components:3,type:6}},kc=t=>{const e=new cl(t.name+"_clone",t.type,t.file,t.data,t.options);return e.loaded=!0,e.resource=(t=>{const e=new Ue(t.device,t);return e._levels=(t=>{const e=[];for(let s=0;s<t._levels.length;++s){let i=[];if(t.cubemap)for(let e=0;e<6;++e)i.push(t._levels[s][e]);else i=t._levels[s];e.push(i)}return e})(t),e})(t.resource),t.registry.add(e),e},Dc=(t,e,s)=>{const i=e[at];if(!i)return null;const n=i.count,r=[];for(const t in e)e.hasOwnProperty(t)&&r.push({semantic:t,components:e[t].components,type:e[t].type,normalize:!!e[t].normalize});let a,o,l,h,c,d;r.sort(((t,e)=>Sc[t.semantic]-Sc[e.semantic]));const u=new he(t,r);let p=!0;for(a=0;a<u.elements.length;++a)if(c=u.elements[a],h=e[c.name],d=h.offset-i.offset,h.buffer!==i.buffer||h.stride!==c.stride||h.size!==c.size||d!==c.offset){p=!1;break}const f=new oe(t,u,n,0),m=f.lock(),g=new Uint32Array(m);let _;if(p)_=new Uint32Array(i.buffer,i.offset,n*f.format.size/4),g.set(_);else{let t,s;for(a=0;a<f.format.elements.length;++a){c=f.format.elements[a],t=c.stride/4,h=e[c.name],s=h.stride/4,_=new Uint32Array(h.buffer,h.offset,(h.count-1)*s+(h.size+3)/4);let i=0,r=c.offset/4;const d=Math.floor((h.size+3)/4);for(o=0;o<n;++o){for(l=0;l<d;++l)g[r+l]=_[i+l];i+=s,r+=t}}}return s&&(t=>{let e,s;const i=[],n=[],r=[];for(e=0;e<t.format.elements.length;++e){const s=t.format.elements[e];if(s.name===pt||s.name===ft)switch(s.dataType){case 6:i.push({offset:s.offset/4+1,stride:s.stride/4});break;case 3:n.push({offset:s.offset/2+1,stride:s.stride/2});break;case zt:r.push({offset:s.offset+1,stride:s.stride})}}const a=(i,n,r)=>{const a=new n(t.storage);for(e=0;e<i.length;++e){let n=i[e].offset;const o=i[e].stride;for(s=0;s<t.numVertices;++s)a[n]=r-a[n],n+=o}};i.length>0&&a(i,Float32Array,1),n.length>0&&a(n,Uint16Array,65535),r.length>0&&a(r,Uint8Array,255)})(f),f.unlock(),f},Rc=(t,e,s,i,n,r,a,o,l,h)=>{const c=[];return e.primitives.forEach((d=>{var u;if(null!=(u=d.extensions)&&u.KHR_draco_mesh_compression)c.push(((t,e,s,i,n,r,a)=>{var o;const l=new di(t);l.aabb=Pc(s[e.attributes.POSITION]);const h=[];for(const[t,i]of Object.entries(e.attributes)){var c;const e=s[i],n=wc[t],r=yc(e.componentType);h.push({semantic:n,components:bc(e.type),type:r,normalize:null!=(c=e.normalized)?c:n===dt&&(r===zt||3===r)})}if(a.push(new Promise(((s,n)=>{const r=e.extensions.KHR_draco_mesh_compression;gc(i[r.bufferView].slice().buffer,((i,a)=>{if(i)console.log(i),n(i);else{var o;const i={};for(const[t,e]of Object.entries(r.attributes))i[wc[t]]=a.attributes.indexOf(e);h.sort(((t,e)=>i[t.semantic]-i[e.semantic])),null!=(o=e.attributes)&&o.NORMAL||h.splice(1,0,{semantic:"NORMAL",components:3,type:6});const n=new he(t,h),c=a.vertices.byteLength/n.size,d=c<=65535?1:2,u=a.indices.byteLength/(c<=65535?2:4),p=new oe(t,n,c,0,a.vertices),f=new _s(t,d,u,0,a.indices);l.vertexBuffer=p,l.indexBuffer[0]=f,l.primitive[0].type=Mc(e),l.primitive[0].base=0,l.primitive[0].count=f?u:c,l.primitive[0].indexed=!!f,s()}}))}))),null!=e&&null!=(o=e.extensions)&&o.KHR_materials_variants){const t=e.extensions.KHR_materials_variants,s={};t.mappings.forEach((t=>{t.variants.forEach((e=>{s[e]=t.material}))})),n[l.id]=s}return r[l.id]=e.material,l})(t,d,s,i,a,o,h));else{let h=d.hasOwnProperty("indices")?Tc(s[d.indices],i,!0):null;const u=((t,e,s,i,n,r,a)=>{const o={},l=[];for(const t in e)e.hasOwnProperty(t)&&wc.hasOwnProperty(t)&&(o[t]=e[t],l.push(t+":"+e[t]));l.sort();const h=l.join();let c=a[h];if(!c){const l={};for(const t in o){const s=i[e[t]],r=Tc(s,n),a=n[s.bufferView],o=wc[t],h=bc(s.type)*xc(s.componentType),c=a&&a.hasOwnProperty("byteStride")?a.byteStride:h;l[o]={buffer:r.buffer,size:h,offset:r.byteOffset,stride:c,count:s.count,components:bc(s.type),type:yc(s.componentType),normalize:s.normalized}}l.hasOwnProperty(ot)||Ac(l,s),c=Dc(t,l,r),a[h]=c}return c})(t,d.attributes,h,s,i,n,r),p=Mc(d),f=new di(t);if(f.vertexBuffer=u,f.primitive[0].type=p,f.primitive[0].base=0,f.primitive[0].indexed=null!==h,null!==h){let e;e=h instanceof Uint8Array?0:h instanceof Uint16Array?1:2,2!==e||t.extUintElement||(e=1,h=new Uint16Array(h)),0===e&&t.isWebGPU&&(e=1,h=new Uint16Array(h));const s=new _s(t,e,h.length,0,h);f.indexBuffer[0]=s,f.primitive[0].count=h.length}else f.primitive[0].count=u.numVertices;if(d.hasOwnProperty("extensions")&&d.extensions.hasOwnProperty("KHR_materials_variants")){const t=d.extensions.KHR_materials_variants,e={};t.mappings.forEach((t=>{t.variants.forEach((s=>{e[s]=t.material}))})),a[f.id]=e}o[f.id]=d.material;let m=s[d.attributes.POSITION];if(f.aabb=Pc(m),d.hasOwnProperty("targets")){const n=[];d.targets.forEach(((t,r)=>{const a={};t.hasOwnProperty("POSITION")&&(m=s[t.POSITION],a.deltaPositions=Ec(m,i),a.deltaPositionsType=6,a.aabb=Pc(m)),t.hasOwnProperty("NORMAL")&&(m=s[t.NORMAL],a.deltaNormals=Ec(m,i),a.deltaNormalsType=6),e.hasOwnProperty("extras")&&e.extras.hasOwnProperty("targetNames")?a.name=e.extras.targetNames[r]:a.name=r.toString(10),e.hasOwnProperty("weights")&&(a.defaultWeight=e.weights[r]),a.preserveData=l.morphPreserveData,n.push(new Eo(a))})),f.morph=new To(n,t,{preferHighPrecision:l.morphPreferHighPrecision})}c.push(f)}})),c},Lc=(t,e,s)=>{var i;let n;const r=t.texCoord;if(r)for(n=0;n<s.length;++n)e[s[n]+"MapUv"]=r;const a=[0,0],o=[1,1],l=null==(i=t.extensions)?void 0:i.KHR_texture_transform;if(l){const t=l.offset||a,i=l.scale||o,r=l.rotation?-l.rotation*k.RAD_TO_DEG:0,h=new I(i[0],i[1]),c=new I(t[0],1-i[1]-t[1]);for(n=0;n<s.length;++n)e[`${s[n]}MapTiling`]=h,e[`${s[n]}MapOffset`]=c,e[`${s[n]}MapRotation`]=r}},Ic=(t,e,s)=>{let i,n;if(t.hasOwnProperty("diffuseFactor")?(i=t.diffuseFactor,e.diffuse.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2)),e.opacity=i[3]):(e.diffuse.set(1,1,1),e.opacity=1),t.hasOwnProperty("diffuseTexture")){const i=t.diffuseTexture;n=s[i.index],e.diffuseMap=n,e.diffuseMapChannel="rgb",e.opacityMap=n,e.opacityMapChannel="a",Lc(i,e,["diffuse","opacity"])}if(e.useMetalness=!1,t.hasOwnProperty("specularFactor")?(i=t.specularFactor,e.specular.set(Math.pow(i[0],1/2.2),Math.pow(i[1],1/2.2),Math.pow(i[2],1/2.2))):e.specular.set(1,1,1),t.hasOwnProperty("glossinessFactor")?e.gloss=t.glossinessFactor:e.gloss=1,t.hasOwnProperty("specularGlossinessTexture")){const i=t.specularGlossinessTexture;e.specularEncoding="srgb",e.specularMap=e.glossMap=s[i.index],e.specularMapChannel="rgb",e.glossMapChannel="a",Lc(i,e,["gloss","metalness"])}},Oc=(t,e,s)=>{if(t.hasOwnProperty("clearcoatFactor")?e.clearCoat=.25*t.clearcoatFactor:e.clearCoat=0,t.hasOwnProperty("clearcoatTexture")){const i=t.clearcoatTexture;e.clearCoatMap=s[i.index],e.clearCoatMapChannel="r",Lc(i,e,["clearCoat"])}if(t.hasOwnProperty("clearcoatRoughnessFactor")?e.clearCoatGloss=t.clearcoatRoughnessFactor:e.clearCoatGloss=0,t.hasOwnProperty("clearcoatRoughnessTexture")){const i=t.clearcoatRoughnessTexture;e.clearCoatGlossMap=s[i.index],e.clearCoatGlossMapChannel="g",Lc(i,e,["clearCoatGloss"])}if(t.hasOwnProperty("clearcoatNormalTexture")){const i=t.clearcoatNormalTexture;e.clearCoatNormalMap=s[i.index],Lc(i,e,["clearCoatNormal"]),i.hasOwnProperty("scale")&&(e.clearCoatBumpiness=i.scale)}e.clearCoatGlossInvert=!0},Fc=(t,e,s)=>{e.useLighting=!1,e.emissive.copy(e.diffuse),e.emissiveTint=e.diffuseTint,e.emissiveMap=e.diffuseMap,e.emissiveMapUv=e.diffuseMapUv,e.emissiveMapTiling.copy(e.diffuseMapTiling),e.emissiveMapOffset.copy(e.diffuseMapOffset),e.emissiveMapRotation=e.diffuseMapRotation,e.emissiveMapChannel=e.diffuseMapChannel,e.emissiveVertexColor=e.diffuseVertexColor,e.emissiveVertexColorChannel=e.diffuseVertexColorChannel,e.useLighting=!1,e.useSkybox=!1,e.diffuse.set(0,0,0),e.diffuseTint=!1,e.diffuseMap=null,e.diffuseVertexColor=!1},Bc=(t,e,s)=>{if(e.useMetalnessSpecularColor=!0,t.hasOwnProperty("specularColorTexture")&&(e.specularEncoding="srgb",e.specularMap=s[t.specularColorTexture.index],e.specularMapChannel="rgb",Lc(t.specularColorTexture,e,["specular"])),t.hasOwnProperty("specularColorFactor")){const s=t.specularColorFactor;e.specular.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}else e.specular.set(1,1,1);t.hasOwnProperty("specularFactor")?e.specularityFactor=t.specularFactor:e.specularityFactor=1,t.hasOwnProperty("specularTexture")&&(e.specularityFactorMapChannel="a",e.specularityFactorMap=s[t.specularTexture.index],Lc(t.specularTexture,e,["specularityFactor"]))},zc=(t,e,s)=>{t.hasOwnProperty("ior")&&(e.refractionIndex=1/t.ior)},Nc=(t,e,s)=>{e.blendType=2,e.useDynamicRefraction=!0,t.hasOwnProperty("transmissionFactor")&&(e.refraction=t.transmissionFactor),t.hasOwnProperty("transmissionTexture")&&(e.refractionMapChannel="r",e.refractionMap=s[t.transmissionTexture.index],Lc(t.transmissionTexture,e,["refraction"]))},Uc=(t,e,s)=>{if(e.useSheen=!0,t.hasOwnProperty("sheenColorFactor")){const s=t.sheenColorFactor;e.sheen.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}else e.sheen.set(1,1,1);t.hasOwnProperty("sheenColorTexture")&&(e.sheenMap=s[t.sheenColorTexture.index],e.sheenEncoding="srgb",Lc(t.sheenColorTexture,e,["sheen"])),t.hasOwnProperty("sheenRoughnessFactor")?e.sheenGloss=t.sheenRoughnessFactor:e.sheenGloss=0,t.hasOwnProperty("sheenRoughnessTexture")&&(e.sheenGlossMap=s[t.sheenRoughnessTexture.index],e.sheenGlossMapChannel="a",Lc(t.sheenRoughnessTexture,e,["sheenGloss"])),e.sheenGlossInvert=!0},Vc=(t,e,s)=>{if(e.blendType=2,e.useDynamicRefraction=!0,t.hasOwnProperty("thicknessFactor")&&(e.thickness=t.thicknessFactor),t.hasOwnProperty("thicknessTexture")&&(e.thicknessMap=s[t.thicknessTexture.index],e.thicknessMapChannel="g",Lc(t.thicknessTexture,e,["thickness"])),t.hasOwnProperty("attenuationDistance")&&(e.attenuationDistance=t.attenuationDistance),t.hasOwnProperty("attenuationColor")){const s=t.attenuationColor;e.attenuation.set(Math.pow(s[0],1/2.2),Math.pow(s[1],1/2.2),Math.pow(s[2],1/2.2))}},Hc=(t,e,s)=>{t.hasOwnProperty("emissiveStrength")&&(e.emissiveIntensity=t.emissiveStrength)},Gc=(t,e,s)=>{e.useIridescence=!0,t.hasOwnProperty("iridescenceFactor")&&(e.iridescence=t.iridescenceFactor),t.hasOwnProperty("iridescenceTexture")&&(e.iridescenceMapChannel="r",e.iridescenceMap=s[t.iridescenceTexture.index],Lc(t.iridescenceTexture,e,["iridescence"])),t.hasOwnProperty("iridescenceIor")&&(e.iridescenceRefractionIndex=t.iridescenceIor),t.hasOwnProperty("iridescenceThicknessMinimum")&&(e.iridescenceThicknessMin=t.iridescenceThicknessMinimum),t.hasOwnProperty("iridescenceThicknessMaximum")&&(e.iridescenceThicknessMax=t.iridescenceThicknessMaximum),t.hasOwnProperty("iridescenceThicknessTexture")&&(e.iridescenceThicknessMapChannel="g",e.iridescenceThicknessMap=s[t.iridescenceThicknessTexture.index],Lc(t.iridescenceThicknessTexture,e,["iridescenceThickness"]))},Wc=(t,e,s)=>{const i=new Da;let n,r;if(i.occludeSpecular=1,i.diffuseTint=!0,i.diffuseVertexColor=!0,i.specularTint=!0,i.specularVertexColor=!0,t.hasOwnProperty("name")&&(i.name=t.name),t.hasOwnProperty("pbrMetallicRoughness")){const s=t.pbrMetallicRoughness;if(s.hasOwnProperty("baseColorFactor")?(n=s.baseColorFactor,i.diffuse.set(Math.pow(n[0],1/2.2),Math.pow(n[1],1/2.2),Math.pow(n[2],1/2.2)),i.opacity=n[3]):(i.diffuse.set(1,1,1),i.opacity=1),s.hasOwnProperty("baseColorTexture")){const t=s.baseColorTexture;r=e[t.index],i.diffuseMap=r,i.diffuseMapChannel="rgb",i.opacityMap=r,i.opacityMapChannel="a",Lc(t,i,["diffuse","opacity"])}if(i.useMetalness=!0,i.specular.set(1,1,1),s.hasOwnProperty("metallicFactor")?i.metalness=s.metallicFactor:i.metalness=1,s.hasOwnProperty("roughnessFactor")?i.gloss=s.roughnessFactor:i.gloss=1,i.glossInvert=!0,s.hasOwnProperty("metallicRoughnessTexture")){const t=s.metallicRoughnessTexture;i.metalnessMap=i.glossMap=e[t.index],i.metalnessMapChannel="b",i.glossMapChannel="g",Lc(t,i,["gloss","metalness"])}}if(t.hasOwnProperty("normalTexture")){const s=t.normalTexture;i.normalMap=e[s.index],Lc(s,i,["normal"]),s.hasOwnProperty("scale")&&(i.bumpiness=s.scale)}if(t.hasOwnProperty("occlusionTexture")){const s=t.occlusionTexture;i.aoMap=e[s.index],i.aoMapChannel="r",Lc(s,i,["ao"])}if(t.hasOwnProperty("emissiveFactor")?(n=t.emissiveFactor,i.emissive.set(Math.pow(n[0],1/2.2),Math.pow(n[1],1/2.2),Math.pow(n[2],1/2.2)),i.emissiveTint=!0):(i.emissive.set(0,0,0),i.emissiveTint=!1),t.hasOwnProperty("emissiveTexture")){const s=t.emissiveTexture;i.emissiveMap=e[s.index],Lc(s,i,["emissive"])}if(t.hasOwnProperty("alphaMode"))switch(t.alphaMode){case"MASK":i.blendType=3,t.hasOwnProperty("alphaCutoff")?i.alphaTest=t.alphaCutoff:i.alphaTest=.5;break;case"BLEND":i.blendType=2,i.depthWrite=!1;break;default:i.blendType=3}else i.blendType=3;t.hasOwnProperty("doubleSided")?(i.twoSidedLighting=t.doubleSided,i.cull=t.doubleSided?tt:1):(i.twoSidedLighting=!1,i.cull=1);const a={KHR_materials_clearcoat:Oc,KHR_materials_emissive_strength:Hc,KHR_materials_ior:zc,KHR_materials_iridescence:Gc,KHR_materials_pbrSpecularGlossiness:Ic,KHR_materials_sheen:Uc,KHR_materials_specular:Bc,KHR_materials_transmission:Nc,KHR_materials_unlit:Fc,KHR_materials_volume:Vc};if(t.hasOwnProperty("extensions"))for(const s in t.extensions){const n=a[s];void 0!==n&&n(t.extensions[s],i,e)}return i.update(),i},jc=new V,qc=new R,Xc=(t,e)=>{const s=new gn;if(t.hasOwnProperty("name")&&t.name.length>0?s.name=t.name:s.name="node_"+e,t.hasOwnProperty("matrix")&&(jc.data.set(t.matrix),jc.getTranslation(qc),s.setLocalPosition(qc),jc.getEulerAngles(qc),s.setLocalEulerAngles(qc),jc.getScale(qc),s.setLocalScale(qc)),t.hasOwnProperty("rotation")){const e=t.rotation;s.setLocalRotation(e[0],e[1],e[2],e[3])}if(t.hasOwnProperty("translation")){const e=t.translation;s.setLocalPosition(e[0],e[1],e[2])}if(t.hasOwnProperty("scale")){const e=t.scale;s.setLocalScale(e[0],e[1],e[2])}return s},$c=(t,e)=>{const s="orthographic"===t.type?1:0,i=1===s?t.orthographic:t.perspective,n={enabled:!1,projection:s,nearClip:i.znear,aspectRatioMode:0};i.zfar&&(n.farClip=i.zfar),1===s?(n.orthoHeight=.5*i.ymag,i.ymag&&(n.aspectRatioMode=1,n.aspectRatio=i.xmag/i.ymag)):(n.fov=i.yfov*k.RAD_TO_DEG,i.aspectRatio&&(n.aspectRatioMode=1,n.aspectRatio=i.aspectRatio));const r=new El(t.name);return r.addComponent("camera",n),r},Kc=(t,e)=>{const s={enabled:!1,type:"point"===t.type?"omni":t.type,color:t.hasOwnProperty("color")?new D(t.color):D.WHITE,range:t.hasOwnProperty("range")?t.range:9999,falloffMode:1,intensity:t.hasOwnProperty("intensity")?k.clamp(t.intensity,0,2):1};t.hasOwnProperty("spot")&&(s.innerConeAngle=t.spot.hasOwnProperty("innerConeAngle")?t.spot.innerConeAngle*k.RAD_TO_DEG:0,s.outerConeAngle=t.spot.hasOwnProperty("outerConeAngle")?t.spot.outerConeAngle*k.RAD_TO_DEG:Math.PI/4),t.hasOwnProperty("intensity")&&(s.luminance=t.intensity*yo.getLightUnitConversion(go[s.type],s.outerConeAngle,s.innerConeAngle));const i=new El(e.name);return i.rotateLocal(90,0,0),i.addComponent("light",s),i},Yc=(t,e,s,i)=>{if(!e.hasOwnProperty("skins")||0===e.skins.length)return[];const n=new Map;return e.skins.map((r=>((t,e,s,i,n,r)=>{let a,o,l;const h=e.joints,c=h.length,d=[];if(e.hasOwnProperty("inverseBindMatrices")){const t=e.inverseBindMatrices,n=Tc(s[t],i,!0),r=[];for(a=0;a<c;a++){for(o=0;o<16;o++)r[o]=n[16*a+o];l=new V,l.set(r),d.push(l)}}else for(a=0;a<c;a++)l=new V,d.push(l);const u=[];for(a=0;a<c;a++)u[a]=n[h[a]].name;const p=u.join("#");let f=r.get(p);return f||(f=new Oo(t,d,u),r.set(p,f)),f})(t,r,e.accessors,i,s,n)))},Qc=(t,e,s,i)=>{var n,r;if(!t.hasOwnProperty("animations")||0===t.animations.length)return[];const a=null==i||null==(n=i.animation)?void 0:n.preprocess,o=null==i||null==(r=i.animation)?void 0:r.postprocess;return t.animations.map(((i,n)=>{a&&a(i);const r=((t,e,s,i,n,r,a)=>{const o=t=>new cc(bc(t.type),Ec(t,i)),l={STEP:0,LINEAR:1,CUBICSPLINE:2},h={},c={},d={};let u,p=1;for(u=0;u<t.samplers.length;++u){const e=t.samplers[u];h.hasOwnProperty(e.input)||(h[e.input]=o(s[e.input])),c.hasOwnProperty(e.output)||(c[e.output]=o(s[e.output]));const i=e.hasOwnProperty("interpolation")&&l.hasOwnProperty(e.interpolation)?l[e.interpolation]:1,n={paths:[],input:e.input,output:e.output,interpolation:i};d[u]=n}const f=[],m={translation:"localPosition",rotation:"localRotation",scale:"localScale"},g=t=>{const e=[];for(;t;)e.unshift(t.name),t=t.parent;return e},_=(t,e,s)=>{const i=c[t.output];if(!i)return;let n;if(r&&r[e.mesh]){const t=r[e.mesh];t.hasOwnProperty("extras")&&t.extras.hasOwnProperty("targetNames")&&(n=t.extras.targetNames)}const a=i.data,o=a.length/h[t.input].data.length,l=a.length/o,f=4*l,m=new ArrayBuffer(f*o);for(let e=0;e<o;e++){var g;const i=new Float32Array(m,f*e,l);for(let t=0;t<l;t++)i[t]=a[t*o+e];const r=new cc(1,i),h=null!=(g=n)&&g[e]?`name.${n[e]}`:e;c[-p]=r;const _={paths:[{entityPath:s,component:"graph",propertyPath:[`weight.${h}`]}],input:t.input,output:-p,interpolation:t.interpolation};p++,d[`morphCurve-${u}-${e}`]=_}};for(u=0;u<t.channels.length;++u){const e=t.channels[u],s=e.target,i=d[e.sampler],r=n[s.node],o=a[s.node],l=g(r);s.path.startsWith("weights")?(_(i,o,l),d[e.sampler].morphCurve=!0):i.paths.push({entityPath:l,component:"graph",propertyPath:[m[s.path]]})}const v=[],b=[],y=[];for(const t in h)v.push(h[t]),h[t]=v.length-1;for(const t in c)b.push(c[t]),c[t]=b.length-1;for(const t in d){const e=d[t];e.morphCurve||(y.push(new hc(e.paths,h[e.input],c[e.output],e.interpolation)),e.paths.length>0&&"localRotation"===e.paths[0].propertyPath[0]&&2!==e.interpolation&&f.push(y[y.length-1].output))}f.sort();let x,w=null;for(u=0;u<f.length;++u){const t=f[u];if(0===u||t!==w){if(x=b[t],4===x.components){const t=x.data,e=t.length-4;for(let s=0;s<e;s+=4)t[s+0]*t[s+4]+t[s+1]*t[s+5]+t[s+2]*t[s+6]+t[s+3]*t[s+7]<0&&(t[s+4]*=-1,t[s+5]*=-1,t[s+6]*=-1,t[s+7]*=-1)}w=t}}let S=0;for(u=0;u<v.length;u++)x=v[u]._data,S=Math.max(S,0===x.length?0:x[x.length-1]);return new uh(t.hasOwnProperty("name")?t.name:"animation_"+e,S,v,b,y)})(i,n,t.accessors,s,e,t.meshes,t.nodes);return o&&o(i,r),r}))},Jc=async(t,e,s,i,n)=>{var r,a;const o=null==n||null==(r=n.global)?void 0:r.preprocess,l=null==n||null==(a=n.global)?void 0:a.postprocess;o&&o(e);const h=e.asset&&"PlayCanvas"===e.asset.generator,c=((t,e)=>{var s,i,n,r;if(!t.hasOwnProperty("nodes")||0===t.nodes.length)return[];const a=null==e||null==(s=e.node)?void 0:s.preprocess,o=null!=(i=null==e||null==(n=e.node)?void 0:n.process)?i:Xc,l=null==e||null==(r=e.node)?void 0:r.postprocess,h=t.nodes.map(((t,e)=>{a&&a(t);const s=o(t,e);return l&&l(t,s),s}));for(let e=0;e<t.nodes.length;++e){const s=t.nodes[e];if(s.hasOwnProperty("children")){const t=h[e],i={};for(let e=0;e<s.children.length;++e){const n=h[s.children[e]];n.parent||(i.hasOwnProperty(n.name)?n.name+=i[n.name]++:i[n.name]=1,t.addChild(n))}}}return h})(e,n),d=((t,e)=>{var s;const i=[],n=t.scenes.length;if(1===n&&1===(null==(s=t.scenes[0].nodes)?void 0:s.length)){const s=t.scenes[0].nodes[0];i.push(e[s])}else for(let s=0;s<n;s++){const n=t.scenes[s];if(n.nodes){const t=new gn(n.name);for(let s=0;s<n.nodes.length;s++){const i=e[n.nodes[s]];t.addChild(i)}i.push(t)}}return i})(e,c),u=((t,e,s)=>{let i=null;if(t.hasOwnProperty("nodes")&&t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_lights_punctual")&&t.extensions.KHR_lights_punctual.hasOwnProperty("lights")){const l=t.extensions.KHR_lights_punctual.lights;if(l.length){var n,r,a,o;const h=null==s||null==(n=s.light)?void 0:n.preprocess,c=null!=(r=null==s||null==(a=s.light)?void 0:a.process)?r:Kc,d=null==s||null==(o=s.light)?void 0:o.postprocess;t.nodes.forEach(((t,s)=>{if(t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_lights_punctual")&&t.extensions.KHR_lights_punctual.hasOwnProperty("light")){const n=t.extensions.KHR_lights_punctual.light,r=l[n];if(r){h&&h(r);const n=c(r,e[s]);d&&d(r,n),n&&(i||(i=new Map),i.set(t,n))}}}))}}return i})(e,c,n),p=((t,e,s)=>{let i=null;if(t.hasOwnProperty("nodes")&&t.hasOwnProperty("cameras")&&t.cameras.length>0){var n,r,a,o;const l=null==s||null==(n=s.camera)?void 0:n.preprocess,h=null!=(r=null==s||null==(a=s.camera)?void 0:a.process)?r:$c,c=null==s||null==(o=s.camera)?void 0:o.postprocess;t.nodes.forEach(((s,n)=>{if(s.hasOwnProperty("camera")){const r=t.cameras[s.camera];if(r){l&&l(r);const t=h(r,e[n]);c&&c(r,t),t&&(i||(i=new Map),i.set(s,t))}}}))}return i})(e,c,n),f=(t=>{if(!t.hasOwnProperty("extensions")||!t.extensions.hasOwnProperty("KHR_materials_variants"))return null;const e=t.extensions.KHR_materials_variants.variants,s={};for(let t=0;t<e.length;t++)s[e[t].name]=t;return s})(e),m=await Promise.all(s),{meshes:g,meshVariants:_,meshDefaultMaterials:v,promises:b}=((t,e,s,i,n)=>{var r,a,o;const l={},h={},c={},d=[];return{meshes:!n.skipMeshes&&(null==e||null==(r=e.meshes)?void 0:r.length)&&(null==e||null==(a=e.accessors)?void 0:a.length)&&(null==e||null==(o=e.bufferViews)?void 0:o.length)?e.meshes.map((r=>Rc(t,r,e.accessors,s,i,l,h,c,n,d))):[],meshVariants:h,meshDefaultMaterials:c,promises:d}})(t,e,m,h,n),y=Qc(e,c,m,n),x=await Promise.all(i),w=x.map((t=>t.resource)),S=((t,e,s,i)=>{var n,r,a,o;if(!t.hasOwnProperty("materials")||0===t.materials.length)return[];const l=null==s||null==(n=s.material)?void 0:n.preprocess,h=null!=(r=null==s||null==(a=s.material)?void 0:a.process)?r:Wc,c=null==s||null==(o=s.material)?void 0:o.postprocess;return t.materials.map((t=>{l&&l(t);const s=h(t,e,i);return c&&c(t,s),s}))})(e,w,n,h),C=Yc(t,e,c,m),T=[];for(let t=0;t<g.length;t++)T[t]=new nc,T[t].meshes=g[t];((t,e,s)=>{t.nodes.forEach((t=>{t.hasOwnProperty("mesh")&&t.hasOwnProperty("skin")&&e[t.mesh].meshes.forEach((e=>{e.skin=s[t.skin]}))}))})(e,T,C);const E=new _c;return E.gltf=e,E.nodes=c,E.scenes=d,E.animations=y,E.textures=x,E.materials=S,E.variants=f,E.meshVariants=_,E.meshDefaultMaterials=v,E.renders=T,E.skins=C,E.lights=u,E.cameras=p,l&&l(e,E),await Promise.all(b),E};let Zc=0;const td=(t,e,s)=>{t&&t.toLowerCase().endsWith(".glb")||(()=>{const t=new Uint8Array(e);return 103===t[0]&&108===t[1]&&84===t[2]&&70===t[3]})()?((t,e)=>{const s=t instanceof ArrayBuffer?new DataView(t):new DataView(t.buffer,t.byteOffset,t.byteLength),i=s.getUint32(0,!0),n=s.getUint32(4,!0),r=s.getUint32(8,!0);if(1179937895!==i)return void e("Invalid magic number found in glb header. Expected 0x46546C67, found 0x"+i.toString(16));if(2!==n)return void e("Invalid version number found in glb header. Expected 2, found "+n);if(r<=0||r>s.byteLength)return void e("Invalid length found in glb header. Found "+r);const a=[];let o=12;for(;o<r;){const t=s.getUint32(o,!0);o+t+8>s.byteLength&&e(`Invalid chunk length found in glb. Found ${t}`);const i=s.getUint32(o+4,!0),n=new Uint8Array(s.buffer,s.byteOffset+o+8,t);a.push({length:t,type:i,data:n}),o+=t+8}1===a.length||2===a.length?1313821514===a[0].type?a.length>1&&5130562!==a[1].type?e(`Invalid chunk type found in glb file. Expected 0x004E4942, found 0x${a[1].type.toString(16)}`):e(null,{gltfChunk:a[0].data,binaryChunk:2===a.length?a[1].data:null}):e(`Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x${a[0].type.toString(16)}`):e("Invalid number of chunks found in glb file.")})(e,s):s(null,{gltfChunk:e,binaryChunk:null})};class ed{static parse(t,e,s,i,n,r,a){td(t,s,((t,s)=>{t?a(t):((t,e)=>{const s=JSON.parse((t=>{if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(t);let e="";for(let s=0;s<t.length;s++)e+=String.fromCharCode(t[s]);return decodeURIComponent(escape(e))})(t));s.asset&&s.asset.version&&parseFloat(s.asset.version)<2?e(`Invalid gltf version. Expected version 2.0 or above but found version '${s.asset.version}'.`):e(null,s)})(s.gltfChunk,((t,o)=>{if(t)return void a(t);const l=((t,e,s,i)=>{var n,r,a;if(!t.buffers||0===t.buffers.length)return[];const o=null==i||null==(n=i.buffer)?void 0:n.preprocess,l=null==i||null==(r=i.buffer)?void 0:r.processAsync,h=null==i||null==(a=i.buffer)?void 0:a.postprocess;return t.buffers.map(((i,n)=>{let r;return o&&o(i),r=new Promise(l?(t,e)=>{l(i,((s,i)=>{s?e(s):t(i)}))}:t=>{t(null)}),r=r.then((t=>{if(t)return t;if(i.hasOwnProperty("uri")){if(vc(i.uri)){const t=atob(i.uri.split(",")[1]),e=new Uint8Array(t.length);for(let s=0;s<t.length;s++)e[s]=t.charCodeAt(s);return e}return new Promise(((t,e)=>{Js.get(rl.test(i.uri)?i.uri:u.join(s,i.uri),{cache:!0,responseType:"arraybuffer",retry:!1},((s,i)=>{s?e(s):t(new Uint8Array(i))}))}))}return e})),h&&(r=r.then((e=>(h(t.buffers[n],e),e)))),r}))})(o,s.binaryChunk,e,r),h=((t,e,s)=>{var i,n,r,a;const o=[],l=null==s||null==(i=s.bufferView)?void 0:i.preprocess,h=null==s||null==(n=s.bufferView)?void 0:n.processAsync,c=null==s||null==(r=s.bufferView)?void 0:r.postprocess;if(null==(a=t.bufferViews)||!a.length)return o;for(let s=0;s<t.bufferViews.length;++s){const i=t.bufferViews[s];let n;l&&l(i),n=new Promise(h?(t,s)=>{h(i,e,((e,i)=>{e?s(e):t(i)}))}:t=>{t(null)}),n=n.then((t=>t||e[i.buffer].then((t=>new Uint8Array(t.buffer,t.byteOffset+(i.byteOffset||0),i.byteLength))))),i.hasOwnProperty("byteStride")&&(n=n.then((t=>(t.byteStride=i.byteStride,t)))),c&&(n=n.then((t=>(c(i,t),t)))),o.push(n)}return o})(o,l,r),c=((t,e,s,i,n)=>{var r,a,o;if(!t.images||0===t.images.length)return[];const l=null==n||null==(r=n.image)?void 0:r.preprocess,h=null==n||null==(a=n.image)?void 0:a.processAsync,c=null==n||null==(o=n.image)?void 0:o.postprocess,d={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/ktx2":"ktx2","image/vnd-ms.dds":"dds"},p=(t,e,s,n,r)=>new Promise(((a,o)=>{const l=s=>{const l=(t.name||"gltf-texture")+"-"+Zc++,h={url:e||l};if(s&&(h.contents=s.slice(0).buffer),n){const t=d[n];t&&(h.filename=h.url+"."+t)}const c=new cl(l,"texture",h,null,r);c.on("load",(t=>a(t))),c.on("error",(t=>o(t))),i.add(c),i.load(c)};s?s.then((t=>l(t))):l(null)}));return t.images.map(((t,i)=>{let n;return l&&l(t),n=new Promise(h?(e,s)=>{h(t,((t,i)=>{t?s(t):e(i)}))}:t=>{t(null)}),n=n.then((n=>{return n||(t.hasOwnProperty("uri")?vc(t.uri)?p(t,t.uri,null,(r=t.uri).substring(r.indexOf(":")+1,r.indexOf(";")),null):p(t,rl.test(t.uri)?t.uri:u.join(s,t.uri),null,null,{crossOrigin:"anonymous"}):t.hasOwnProperty("bufferView")&&t.hasOwnProperty("mimeType")?p(t,null,e[t.bufferView],t.mimeType,null):Promise.reject(new Error(`Invalid image found in gltf (neither uri or bufferView found). index=${i}`)));var r})),c&&(n=n.then((e=>(c(t,e),e)))),n}))})(o,h,e,n,r),d=((t,e,s)=>{var i,n,r,a,o;if(null==t||null==(i=t.images)||!i.length||null==t||null==(n=t.textures)||!n.length)return[];const l=null==s||null==(r=s.texture)?void 0:r.preprocess,h=null==s||null==(a=s.texture)?void 0:a.processAsync,c=null==s||null==(o=s.texture)?void 0:o.postprocess,d=new Set;return t.textures.map((s=>{let i;return l&&l(s),i=new Promise(h?(e,i)=>{h(s,t.images,((t,s)=>{t?i(t):e(s)}))}:t=>{t(null)}),i=i.then((i=>{var n,r,a,o,l,h,c;i=null!=(n=null!=(r=null!=(a=i)?a:null==s||null==(o=s.extensions)||null==(l=o.KHR_texture_basisu)?void 0:l.source)?r:null==s||null==(h=s.extensions)||null==(c=h.EXT_texture_webp)?void 0:c.source)?n:s.source;const u=d.has(i);return d.add(i),e[i].then((e=>{var i;const n=u?kc(e):e;return((t,e)=>{const s=(t,e)=>{switch(t){case 9728:return 0;case 9729:return 1;case 9984:return 2;case 9985:return 4;case 9986:return 3;case 9987:return 5;default:return e}},i=(t,e)=>{switch(t){case 33071:return 1;case 33648:return 2;case 10497:return 0;default:return e}};var n;t&&(e=null!=(n=e)?n:{},t.minFilter=s(e.minFilter,5),t.magFilter=s(e.magFilter,1),t.addressU=i(e.wrapS,0),t.addressV=i(e.wrapT,0))})(n.resource,(null!=(i=t.samplers)?i:[])[s.sampler]),n}))})),c&&(i=i.then((t=>(c(s,t),t)))),i}))})(o,c,r);Jc(i,o,h,d,r).then((t=>a(null,t))).catch((t=>a(t)))}))}))}static createDefaultMaterial(){return Wc({name:"defaultGlbMaterial"},[])}}class sd{constructor(t){this.handlerType="animclip",this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};t.load.startsWith("blob:")&&(s.responseType=Qs.ResponseType.JSON),Js.get(t.load,s,(function(s,i){s?e(`Error loading animation clip resource: ${t.original} [${s}]`):e(null,i)}))}open(t,e){const s=e.name,i=e.duration,n=e.inputs.map((function(t){return new cc(1,t)})),r=e.outputs.map((function(t){return new cc(t.components,t.data)})),a=e.curves.map((function(t){return new hc([t.path],t.inputIndex,t.outputIndex,t.interpolation)}));return new uh(s,i,n,r,a)}patch(t,e){}}class id{constructor(t){this.handlerType="animstategraph",this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t});const s={retry:this.maxRetries>0,maxRetries:this.maxRetries};t.load.startsWith("blob:")&&(s.responseType=Qs.ResponseType.JSON),Js.get(t.load,s,(function(s,i){s?e(`Error loading animation state graph resource: ${t.original} [${s}]`):e(null,i)}))}open(t,e){return new Rh(e)}patch(t,e){}}class nd{constructor(t){this.handlerType="binary",this.maxRetries=0}load(t,e){"string"==typeof t&&(t={load:t,original:t}),Js.get(t.load,{responseType:Qs.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},(function(s,i){s?e(`Error loading binary resource: ${t.original} [${s}]`):e(null,i)}))}open(t,e){return e}patch(t,e){}}class rd{constructor(t,e,s,i){const n=function(t,i,n){const r=rd.createAsset(e.name,t,i,n);return s.add(r),r},r=[];for(let e=0;e<t.renders.length;++e)r.push(n("render",t.renders[e],e));const a=[];for(let e=0;e<t.materials.length;++e)a.push(n("material",t.materials[e],e));const o=[];for(let e=0;e<t.animations.length;++e)o.push(n("animation",t.animations[e],e));this.data=t,this._model=null,this._assetName=e.name,this._assets=s,this._defaultMaterial=i,this.renders=r,this.materials=a,this.textures=t.textures,this.animations=o}get model(){if(!this._model){const t=rd.createModel(this.data,this._defaultMaterial),e=rd.createAsset(this._assetName,"model",t,0);this._assets.add(e),this._model=e}return this._model}static createAsset(t,e,s,i){const n=new cl(t+"/"+e+"/"+i,e,{url:""});return n.resource=s,n.loaded=!0,n}instantiateModelEntity(t){const e=new El;return e.addComponent("model",Object.assign({type:"asset",asset:this.model},t)),e}instantiateRenderEntity(t){const e=this._defaultMaterial,s=[],i=function(t,i,n,r,a,o,l){const h=a[n.id],c=void 0===h?e:r[h],d=new Sn(n,c);return n.morph&&(d.morphInstance=new So(n.morph)),l.hasOwnProperty("skin")&&s.push({meshInstance:d,rootBone:t,entity:i}),d},n=(e,s,r)=>{const a=new El;s._cloneInternal(a),e||(e=a);let o=null,l=null;for(let t=0;t<r.nodes.length;t++){if(r.nodes[t]===s){const s=r.gltf.nodes[t];if(s.hasOwnProperty("mesh")){const t=r.renders[s.mesh].meshes;l=this.renders[s.mesh];for(let n=0;n<t.length;n++){const l=t[n];if(l){const t=i(e,a,l,r.materials,r.meshDefaultMaterials,r.skins,s);o||(o=[]),o.push(t)}}}if(r.lights){const t=r.lights.get(s);t&&a.addChild(t.clone())}if(r.cameras){const t=r.cameras.get(s);t&&t.camera.system.cloneComponent(t,a)}}}o&&(a.addComponent("render",Object.assign({type:"asset",meshInstances:o,rootBone:e},t)),a.render.assignAsset(l));const h=s.children;for(let t=0;t<h.length;t++){const s=n(e,h[t],r);a.addChild(s)}return a},r=[];for(const t of this.data.scenes)r.push(n(null,t,this.data));return s.forEach((t=>{t.meshInstance.skinInstance=Nh.createCachedSkinInstance(t.meshInstance.mesh.skin,t.rootBone,t.entity)})),rd.createSceneHierarchy(r,"Entity")}getMaterialVariants(){return this.data.variants?Object.keys(this.data.variants):[]}applyMaterialVariant(t,e){const s=e?this.data.variants[e]:null;if(void 0===s)return;const i=t.findComponents("render");for(let t=0;t<i.length;t++){const e=i[t];this._applyMaterialVariant(s,e.meshInstances)}}applyMaterialVariantInstances(t,e){const s=e?this.data.variants[e]:null;void 0!==s&&this._applyMaterialVariant(s,t)}_applyMaterialVariant(t,e){e.forEach((e=>{if(null===t)e.material=this._defaultMaterial;else{const s=this.data.meshVariants[e.mesh.id];s&&(e.material=this.data.materials[s[t]])}}))}static createSceneHierarchy(t,e){let s=null;if(1===t.length)s=t[0];else{s=new e("SceneGroup");for(const e of t)s.addChild(e)}return s}static createModel(t,e){const s=function(s,i,n,r,a,o,l){const h=t.meshDefaultMaterials[i.id],c=void 0===h?e:a[h],d=new Sn(i,c,o);if(i.morph){const t=new So(i.morph);d.morphInstance=t,s.morphInstances.push(t)}if(l.hasOwnProperty("skin")){const t=l.skin,e=n[t];i.skin=e;const a=r[t];d.skinInstance=a,s.skinInstances.push(a)}s.meshInstances.push(d)},i=new Co,n=[];for(const e of t.skins){const t=new Zi(e);t.bones=e.bones,n.push(t)}i.graph=rd.createSceneHierarchy(t.scenes,"GraphNode");for(let e=0;e<t.nodes.length;e++){const r=t.nodes[e];if(r.root===i.graph){const a=t.gltf.nodes[e];if(a.hasOwnProperty("mesh")){const e=t.renders[a.mesh].meshes;for(let o=0;o<e.length;o++){const l=e[o];l&&s(i,l,t.skins,n,t.materials,r,a)}}}}return i}destroy(){const t=this._assets,e=function(e){t.remove(e),e.unload()},s=function(t){t.forEach((function(t){e(t)}))};this.animations&&(s(this.animations),this.animations=null),this.textures&&(s(this.textures),this.textures=null),this.materials&&(s(this.materials),this.materials=null),this.renders&&(s(this.renders),this.renders=null),this._model&&(e(this._model),this._model=null),this.data=null,this.assets=null}}class ad{constructor(t,e,s){this._device=t,this._assets=e,this._defaultMaterial=ed.createDefaultMaterial(),this.maxRetries=s}_getUrlWithoutParams(t){return t.indexOf("?")>=0?t.split("?")[0]:t}load(t,e,s){cl.fetchArrayBuffer(t.load,((i,n)=>{i?e(i):ed.parse(this._getUrlWithoutParams(t.original),u.extractPath(t.load),n,this._device,s.registry,s.options,((t,i)=>{t?e(t):e(null,new rd(i,s,this._assets,this._defaultMaterial))}))}),s,this.maxRetries)}open(t,e,s){return e}patch(t,e){}}class od{constructor(t){this.handlerType="container",this.glbContainerParser=new ad(t.graphicsDevice,t.assets,0),this.parsers={}}set maxRetries(t){this.glbContainerParser.maxRetries=t;for(const e in this.parsers)this.parsers.hasOwnProperty(e)&&(this.parsers[e].maxRetries=t)}get maxRetries(){return this.glbContainerParser.maxRetries}_getUrlWithoutParams(t){return t.indexOf("?")>=0?t.split("?")[0]:t}_getParser(t){const e=t?u.getExtension(this._getUrlWithoutParams(t)).toLowerCase().replace(".",""):null;return this.parsers[e]||this.glbContainerParser}load(t,e,s){"string"==typeof t&&(t={load:t,original:t}),this._getParser(t.original).load(t,e,s)}open(t,e,s){return this._getParser(t).open(t,e,s)}patch(t,e){}}class ld{constructor(t){this.handlerType="cubemap",this._device=t.graphicsDevice,this._registry=t.assets,this._loader=t.loader}load(t,e,s){this.loadAssets(s,e)}open(t,e,s){return s?s.resource:null}patch(t,e){this.loadAssets(t,(function(s,i){s&&(e.fire("error",t),e.fire("error:"+t.id,s,t),t.fire("error",t))}))}getAssetIds(t){const e=[];if(e[0]=t.file,(t.loadFaces||!t.file)&&t.data&&t.data.textures)for(let s=0;s<6;++s)e[s+1]=t.data.textures[s];else e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=null;return e}compareAssetIds(t,e){return t&&e?parseInt(t,10)===t||"string"==typeof t?t===e:t.url===e.url:null!==t==(null!==e)}update(t,e,s){const i=t.data||{},n=t._handlerState.assets,r=t._resources;let a,o,l;const h=[null,null,null,null,null,null,null],c=function(){return i.hasOwnProperty("type")?i.type:i.hasOwnProperty("rgbm")?i.rgbm?Dt:kt:null};if(t.loaded&&s[0]===n[0])h[1]=r[1]||null,h[2]=r[2]||null,h[3]=r[3]||null,h[4]=r[4]||null,h[5]=r[5]||null,h[6]=r[6]||null;else if(s[0])if(a=s[0].resource,a.cubemap)for(l=0;l<6;++l)h[l+1]=new Ue(this._device,{name:t.name+"_prelitCubemap"+(a.width>>l),cubemap:!0,type:c()||a.type,width:a.width>>l,height:a.height>>l,format:a.format,levels:[a._levels[l]],fixCubemapSeams:!0,addressU:1,addressV:1,mipmaps:0===l});else a.type=Lt,h[1]=a;const d=s.slice(1);if(t.loaded&&this.cmpArrays(d,n.slice(1)))h[0]=r[0]||null;else if(-1===d.indexOf(null)){var u;const e=d.map((function(t){return t.resource})),n=[];for(o=0;o<e[0]._levels.length;++o)n.push(e.map((function(t){return t._levels[o]})));const r=e[0].format,a=new Ue(this._device,{name:t.name+"_faces",cubemap:!0,type:c()||e[0].type,width:e[0].width,height:e[0].height,format:6===r?7:r,mipmaps:null==(u=i.mipmaps)||u,levels:n,minFilter:i.hasOwnProperty("minFilter")?i.minFilter:e[0].minFilter,magFilter:i.hasOwnProperty("magFilter")?i.magFilter:e[0].magFilter,anisotropy:i.hasOwnProperty("anisotropy")?i.anisotropy:1,addressU:1,addressV:1,fixCubemapSeams:!!s[0]});h[0]=a}if(!this.cmpArrays(h,r))for(t.resources=h,t._handlerState.assetIds=e,t._handlerState.assets=s,l=0;l<r.length;++l)null!==r[l]&&-1===h.indexOf(r[l])&&r[l].destroy();for(l=0;l<n.length;++l)null!==n[l]&&-1===s.indexOf(n[l])&&n[l].unload()}cmpArrays(t,e){if(t.length!==e.length)return!1;for(let s=0;s<t.length;++s)if(t[s]!==e[s])return!1;return!0}resolveId(t){const e=parseInt(t,10);return e===t||e.toString()===t?e:t}loadAssets(t,e){t.hasOwnProperty("_handlerState")||(t._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});const s=this,i=s.getAssetIds(t),n=[null,null,null,null,null,null,null],r=t._handlerState.assetIds,a=t._handlerState.assets,o=s._registry;let l=7;const h=function(r,a){n[r]=a,l--,0===l&&(s.update(t,i,n),e(null,t.resources))},c=function(t,s,i){e(s)},d=function(t,e){e.loaded?h(t,e):(o.once("load:"+e.id,h.bind(s,t)),o.once("error:"+e.id,c.bind(s,t)),e.loading||o.load(e))};let u;for(let e=0;e<7;++e){const n=this.resolveId(i[e]);if(n)if(s.compareAssetIds(n,r[e]))h(e,a[e]);else if(parseInt(n,10)===n)u=o.get(n),u?d(e,u):setTimeout(function(t,e){const s=o.get(e);s?d(t,s):c(0,"failed to find dependent cubemap asset="+e)}.bind(null,e,n));else{const i="string"==typeof n?{url:n,filename:n}:n;u=new cl(t.name+"_part_"+e,"texture",i),o.add(u),o.once("load:"+u.id,h.bind(s,e)),o.once("error:"+u.id,c.bind(s,e)),o.load(u)}else h(e,null)}}}function hd(){const t=0,e=1,s=2,i=3,n=8,r=9,a=10,o=11,l=12,h=13,c=14,d=16,u={astc:a,dxt:s,etc1:t,etc2:t,pvr:n,atc:o,none:c},p={astc:a,dxt:i,etc1:d,etc2:e,pvr:r,atc:l,none:d},f=21,m=22,g=23,_=8,v=10,b=26,y=27,x=28,w=29,S=30,C=7,T=3,E=5,P=(u,p)=>{switch(u){case t:return p.formats.etc1?f:m;case e:return g;case s:return _;case i:return v;case n:return b;case r:return y;case a:return x;case o:return w;case l:return S;case h:return C;case c:return T;case d:return E}},M=t=>{const e=function(t,e){const s=t*(2/255)-1,i=e*(2/255)-1,n=Math.sqrt(1-Math.min(1,s*s+i*i));return Math.max(0,Math.min(255,Math.floor(.5*(n+1)*255)))};for(let s=0;s<t.length;s+=4){const i=t[s+3],n=t[s+1];t[s+0]=i,t[s+2]=e(i,n),t[s+3]=255}return t},A=t=>{const e=new Uint16Array(t.length/4);for(let s=0;s<t.length;s+=4){const i=t[s+0],n=t[s+1],r=t[s+2];e[s/4]=(248&i)<<8|(252&n)<<3|r>>3}return e},k=()=>"undefined"!=typeof performance?performance.now():0;let D,R,L;const I=(t,e,s)=>{if(s){if(t.formats.astc)return"astc"}else if(e){if(t.formats.etc2)return"etc2"}else if(t.formats.etc1||t.formats.etc2)return"etc1";return(e=>{for(let s=0;s<e.length;++s){const i=e[s];if(t.formats[i])return i}return"none"})(e?L:R)},O=(h,c,d,u)=>{switch(d){case t:case e:return!0;case s:case i:return 0==(3&h)&&0==(3&c);case n:case r:return((t,e)=>0==(t&t-1)&&0==(e&e-1))(h,c)&&(h===c||u);case a:case o:case l:return!0}},F=(t,e,s)=>s.isKTX2?((t,e,s)=>{if(!D.KTX2File)throw new Error("Basis transcoder module does not include support for KTX2.");const i=k(),n=new D.KTX2File(new Uint8Array(e)),r=n.getWidth(),a=n.getHeight(),o=n.getLevels(),l=!!n.getHasAlpha(),f=n.isUASTC&&n.isUASTC();if(!r||!a||!o)throw n.close(),n.delete(),new Error(`Invalid image dimensions url=${t} width=${r} height=${a} levels=${o}`);const m=I(s.deviceDetails,l,f),g=!!s.isGGGR&&"pvr"===m;let _,v;if(g?_=h:(_=l?p[m]:u[m],O(r,a,_,s.deviceDetails.webgl2)||(_=l?h:c)),!n.startTranscoding())throw n.close(),n.delete(),new Error("Failed to start transcoding url="+t);const b=[];for(let e=0;e<o;++e){const s=n.getImageTranscodedSizeInBytes(e,0,0,_),i=new Uint8Array(s);if(!n.transcodeImage(i,e,0,0,_,0,-1,-1))throw n.close(),n.delete(),new Error("Failed to transcode image url="+t);const r=_===c||_===d;b.push(r?new Uint16Array(i.buffer):i)}if(n.close(),n.delete(),g)for(_=c,v=0;v<b.length;++v)b[v]=A(M(b[v]));return{format:P(_,s.deviceDetails),width:r,height:a,levels:b,cubemap:!1,transcodeTime:k()-i,url:t,unswizzledGGGR:g}})(t,e,s):((t,e,s)=>{const i=k(),n=new D.BasisFile(new Uint8Array(e)),r=n.getImageWidth(0,0),a=n.getImageHeight(0,0),o=n.getNumImages(),l=n.getNumLevels(0),f=!!n.getHasAlpha(),m=n.isUASTC&&n.isUASTC();if(!(r&&a&&o&&l))throw n.close(),n.delete(),new Error(`Invalid image dimensions url=${t} width=${r} height=${a} images=${o} levels=${l}`);const g=I(s.deviceDetails,f,m),_=!!s.isGGGR&&"pvr"===g;let v,b;if(_?v=h:(v=f?p[g]:u[g],O(r,a,v,s.deviceDetails.webgl2)||(v=f?h:c)),!n.startTranscoding())throw n.close(),n.delete(),new Error("Failed to start transcoding url="+t);const y=[];for(let e=0;e<l;++e){const s=n.getImageTranscodedSizeInBytes(0,e,v),i=new Uint8Array(s);if(!n.transcodeImage(i,0,e,v,0,0))throw n.close(),n.delete(),new Error("Failed to transcode image url="+t);const r=v===c||v===d;y.push(r?new Uint16Array(i.buffer):i)}if(n.close(),n.delete(),_)for(v=c,b=0;b<y.length;++b)y[b]=A(M(y[b]));return{format:P(v,s.deviceDetails),width:r,height:a,levels:y,cubemap:!1,transcodeTime:k()-i,url:t,unswizzledGGGR:_}})(t,e,s),B=(t,e,s)=>{try{const i=F(t,e,s);i.levels=i.levels.map((t=>t.buffer)),self.postMessage({url:t,data:i},i.levels)}catch(e){self.postMessage({url:t,err:e},null)}},z=[];self.onmessage=t=>{const e=t.data;switch(e.type){case"init":s=e.config,i=()=>{for(let t=0;t<z.length;++t)B(z[t].url,z[t].data,z[t].options);z.length=0},self.BASIS(s.module?{instantiateWasm:(t,e)=>(WebAssembly.instantiate(s.module,t).then((t=>{e(t)})).catch((t=>{console.error("instantiate failed + "+t)})),{})}:null).then((t=>{t.initializeBasis(),D=t,R=s.rgbPriority,L=s.rgbaPriority,i(null)}));break;case"transcode":D?B(e.url,e.data,e.options):z.push(e)}var s,i}}const cd=t=>({astc:!!t.extCompressedTextureASTC,atc:!!t.extCompressedTextureATC,dxt:!!t.extCompressedTextureS3TC,etc1:!!t.extCompressedTextureETC1,etc2:!!t.extCompressedTextureETC,pvr:!!t.extCompressedTexturePVRTC}),dd=(t,e)=>{const s=t=>{const e=["/* basis */",t,"","("+hd.toString()+")()\n\n"].join("\n");return new Blob([e],{type:"application/javascript"})},i=(i,n)=>{e(null,{workerUrl:URL.createObjectURL(s(i)),module:n,rgbPriority:t.rgbPriority,rgbaPriority:t.rgbaPriority})},n={cache:!0,responseType:"text",retry:t.maxRetries>0,maxRetries:t.maxRetries};if(t.glueUrl&&t.wasmUrl&&(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const t=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(t instanceof WebAssembly.Module)return new WebAssembly.Instance(t)instanceof WebAssembly.Instance}}catch(t){}return!1})()){let s=null,r=null;Js.get(t.glueUrl,n,((t,n)=>{t?e(t):r?i(n,r):s=n}));const a=fetch(t.wasmUrl),o=()=>{a.then((t=>t.arrayBuffer())).then((t=>WebAssembly.compile(t))).then((t=>{s?i(s,t):r=t})).catch((t=>{e(t,null)}))};WebAssembly.compileStreaming?WebAssembly.compileStreaming(a).then((t=>{s?i(s,t):r=t})).catch((t=>{o()})):o()}else Js.get(t.fallbackUrl,n,((t,s)=>{t?e(t,null):i(s,null)}))};class ud{constructor(t,e,s){this.queue=t,this.worker=new Worker(e.workerUrl),this.worker.addEventListener("message",(t=>{const e=t.data;this.queue.handleResponse(e.url,e.err,e.data),this.eager||this.queue.enqueueClient(this)})),this.worker.postMessage({type:"init",config:e}),this.eager=s}run(t){const e=[];t.data instanceof ArrayBuffer&&e.push(t.data),this.worker.postMessage({type:"transcode",url:t.url,format:t.format,data:t.data,options:t.options},e),this.eager&&this.queue.enqueueClient(this)}}const pd=1,fd=["etc1","etc2","astc","dxt","pvr","atc"],md=["astc","dxt","etc2","pvr","atc"],gd=5,_d=new class{constructor(){this.callbacks={},this.queue=[],this.clients=[]}enqueueJob(t,e,s,i){if(this.callbacks.hasOwnProperty(t))this.callbacks[t].push(s);else{this.callbacks[t]=[s];const n={url:t,data:e,options:i};this.clients.length>0?this.clients.shift().run(n):this.queue.push(n)}}enqueueClient(t){this.queue.length>0?t.run(this.queue.shift()):this.clients.push(t)}handleResponse(t,e,s){const i=this.callbacks[t];if(e)for(let t=0;t<i.length;++t)i[t](e);else{3===s.format||5===s.format?s.levels=s.levels.map((function(t){return new Uint16Array(t)})):s.levels=s.levels.map((function(t){return new Uint8Array(t)}));for(let t=0;t<i.length;++t)i[t](null,s)}delete this.callbacks[t]}};let vd=null,bd=!1;function yd(t){if(!bd){if(t){if(t.lazyInit)return void(vd=t)}else t=vd||{};if(!t.glueUrl||!t.wasmUrl||!t.fallbackUrl){const e=((window.config?window.config.wasmModules:window.PRELOAD_MODULES)||[]).find((function(t){return"BASIS"===t.moduleName}));if(e){const s=window.ASSET_PREFIX||"";t.glueUrl||(t.glueUrl=s+e.glueUrl),t.wasmUrl||(t.wasmUrl=s+e.wasmUrl),t.fallbackUrl||(t.fallbackUrl=s+e.fallbackUrl)}}if(t.glueUrl||t.wasmUrl||t.fallbackUrl){bd=!0;const e=Math.max(1,Math.min(16,t.numWorkers||pd)),s=1===t.numWorkers||!t.hasOwnProperty("eagerWorkers")||t.eagerWorkers;t.rgbPriority=t.rgbPriority||fd,t.rgbaPriority=t.rgbaPriority||md,t.maxRetries=t.hasOwnProperty("maxRetries")?t.maxRetries:gd,dd(t,((t,i)=>{if(t)console.error(`failed to initialize basis worker: ${t}`);else for(let t=0;t<e;++t)_d.enqueueClient(new ud(_d,i,s))}))}}}let xd=null;function wd(t,e,s,i,n){return yd(),xd||(xd={webgl2:t.webgl2,formats:cd(t)}),_d.enqueueJob(e,s,i,{deviceDetails:xd,isGGGR:!(null==n||!n.isGGGR),isKTX2:!(null==n||!n.isKTX2)}),bd}class Sd{constructor(t,e){this.device=e,this.maxRetries=0}load(t,e,s){const i=this.device;cl.fetchArrayBuffer(t.load,((n,r)=>{var a,o,l,h;n?e(n):(a=r,wd(i,t.load,a,e,{isGGGR:0!=(8&(null==s||null==(o=s.file)||null==(l=o.variants)||null==(h=l.basis)?void 0:h.opt))})||e(`Basis module not found. Asset '${s.name}' basis texture variant will not be loaded.`))}),s,this.maxRetries)}open(t,e,s,i={}){const n=new Ue(s,$t({name:t,addressU:e.cubemap?1:0,addressV:e.cubemap?1:0,width:e.width,height:e.height,format:e.format,cubemap:e.cubemap,levels:e.levels},i));return n.upload(),n}}class Cd{constructor(t,e){this.crossOrigin=t.prefix?"anonymous":null,this.maxRetries=0,this.device=e}load(t,e,s){var i;const n=!(null==s||null==(i=s.file)||!i.contents);if(n){if(this.device.supportsImageBitmap)return void this._loadImageBitmapFromBlob(new Blob([s.file.contents]),e);t={load:URL.createObjectURL(new Blob([s.file.contents])),original:t.original}}const r=(s,i)=>{n&&URL.revokeObjectURL(t.load),e(s,i)};let a;s&&s.options&&s.options.hasOwnProperty("crossOrigin")?a=s.options.crossOrigin:rl.test(t.load)&&(a=this.crossOrigin),this.device.supportsImageBitmap?this._loadImageBitmap(t.load,t.original,a,r):this._loadImage(t.load,t.original,a,r)}open(t,e,s,i={}){const n=new Ue(s,$t({name:t,width:e.width,height:e.height,format:7},i));return n.setSource(e),n}_loadImage(t,e,s,i){const n=new Image;s&&(n.crossOrigin=s);let r=0;const a=this.maxRetries;let o;n.onload=function(){i(null,n)},n.onerror=function(){if(!o)if(a>0&&++r<=a){const s=100*Math.pow(2,r);console.log(`Error loading Texture from: '${e}' - Retrying in ${s}ms...`);const i=t.indexOf("?")>=0?"&":"?";o=setTimeout((function(){n.src=t+i+"retry="+Date.now(),o=null}),s)}else i(`Error loading Texture from: '${e}'`)},n.src=t}_loadImageBitmap(t,e,s,i){const n={cache:!0,responseType:"blob",retry:this.maxRetries>0,maxRetries:this.maxRetries};Js.get(t,n,((t,e)=>{t?i(t):this._loadImageBitmapFromBlob(e,i)}))}_loadImageBitmapFromBlob(t,e){createImageBitmap(t,{premultiplyAlpha:"none",colorSpaceConversion:"none"}).then((t=>e(null,t))).catch((t=>e(t)))}}const Td=[1481919403,3140563232,169478669],Ed={33776:8,33778:9,33779:10,36196:21,37492:22,37496:23,35840:26,35841:24,35842:27,35843:25,32849:6,32856:7,35905:19,35907:20,35898:18,34843:11,34842:et};class Pd{constructor(t){this.maxRetries=0}load(t,e,s){cl.fetchArrayBuffer(t.load,e,s,this.maxRetries)}open(t,e,s,i={}){const n=this.parse(e);if(!n)return null;const r=new Ue(s,$t({name:t,addressU:n.cubemap?1:0,addressV:n.cubemap?1:0,width:n.width,height:n.height,format:n.format,cubemap:n.cubemap,levels:n.levels},i));return r.upload(),r}parse(t){const e=new Uint32Array(t);if(Td[0]!==e[0]||Td[1]!==e[1]||Td[2]!==e[2])return null;const s={endianness:e[3],glType:e[4],glTypeSize:e[5],glFormat:e[6],glInternalFormat:e[7],glBaseInternalFormat:e[8],pixelWidth:e[9],pixelHeight:e[10],pixelDepth:e[11],numberOfArrayElements:e[12],numberOfFaces:e[13],numberOfMipmapLevels:e[14],bytesOfKeyValueData:e[15]};if(s.pixelDepth>1)return null;if(0!==s.numberOfArrayElements)return null;const i=Ed[s.glInternalFormat];if(void 0===i)return null;let n=16+s.bytesOfKeyValueData/4;const r=s.numberOfFaces>1,a=[];for(let c=0;c<(s.numberOfMipmapLevels||1);c++){const s=e[n++];r&&a.push([]);const d=r?a[c]:a;for(let e=0;e<(r?6:1);++e)d.push((o=t,l=4*n,h=s,18===i?new Uint32Array(o,l,h/4):new Uint8Array(o,l,h))),n+=s+3>>2}var o,l,h;return{format:i,width:s.pixelWidth,height:s.pixelHeight,levels:a,cubemap:r}}}const Md=166;class Ad{constructor(t,e){this.maxRetries=0,this.device=e}load(t,e,s){cl.fetchArrayBuffer(t.load,((i,n)=>{i?e(i,n):this.parse(n,t,e,s)}),s,this.maxRetries)}open(t,e,s,i={}){const n=new Ue(s,$t({name:t,addressU:e.cubemap?1:0,addressV:e.cubemap?1:0,width:e.width,height:e.height,format:e.format,cubemap:e.cubemap,levels:e.levels},i));return n.upload(),n}parse(t,e,s,i){const n=new T(t),r=[n.readU32be(),n.readU32be(),n.readU32be()];if(2873840728!==r[0]||540160187!==r[1]||218765834!==r[2])return null;const a={vkFormat:n.readU32(),typeSize:n.readU32(),pixelWidth:n.readU32(),pixelHeight:n.readU32(),pixelDepth:n.readU32(),layerCount:n.readU32(),faceCount:n.readU32(),levelCount:n.readU32(),supercompressionScheme:n.readU32()},o={dfdByteOffset:n.readU32(),dfdByteLength:n.readU32(),kvdByteOffset:n.readU32(),kvdByteLength:n.readU32(),sgdByteOffset:n.readU64(),sgdByteLength:n.readU64()},l=[];for(let t=0;t<Math.max(1,a.levelCount);++t)l.push({byteOffset:n.readU64(),byteLength:n.readU64(),uncompressedByteLength:n.readU64()});if(n.readU32()!==o.kvdByteOffset-o.dfdByteOffset)return null;n.skip(8);const h=n.readU8();if(n.skip(o.dfdByteLength-9),n.skip(o.kvdByteLength),1===a.supercompressionScheme||h===Md){var c,d,u;wd(this.device,e.load,t,s,{isGGGR:0!=(8&(null==i||null==(c=i.file)||null==(d=c.variants)||null==(u=d.basis)?void 0:u.opt)),isKTX2:!0})||s('Basis module not found. Asset "'+i.name+'" basis texture variant will not be loaded.')}else s("unsupported KTX2 pixel format")}}class kd{constructor(t){this.maxRetries=0}load(t,e,s){cl.fetchArrayBuffer(t.load,e,s,this.maxRetries)}open(t,e,s,i={}){const n=new Uint32Array(e,0,32),r=n[4],a=n[3],o=Math.max(n[7],1),l=4===n[20],h=n[21],c=n[22],d=65024===n[28],u=827611204,p=825438800,f=825439312;let m,g=!1,_=!1,v=!1,b=!1,y=null,x=1;if(l?h===u?(y=8,g=!0):894720068===h?(y=10,g=!0):113===h?(y=et,x=2):116===h?(y=st,x=4):826496069===h?(y=21,g=!0,_=!0):h===p||825504336===h?(y=h===p?24:25,g=!0,v=!0):h!==f&&825504848!==h||(y=h===f?26:27,g=!0,b=!0):32===c&&(y=7),!y)return m=new Ue(s,{width:4,height:4,format:6,name:"dds-legacy-empty"}),m;m=new Ue(s,$t({name:t,addressU:d?1:0,addressV:d?1:0,width:r,height:a,format:y,cubemap:d,mipmaps:o>1},i));let w=128;const S=d?6:1;let C;const T=h===u?8:16;let E,P,M;for(let t=0;t<S;t++){let s=r,i=a;for(let n=0;n<o;n++){g?_?C=Math.floor((s+3)/4)*Math.floor((i+3)/4)*8:v?C=Math.max(s,16)*Math.max(i,8)/4:b?C=Math.max(s,8)*Math.max(i,8)/2:(E=Math.floor((s+4-1)/4),P=Math.floor((i+4-1)/4),M=E*P,C=M*T):C=s*i*4;const r=y===st?new Float32Array(e,w,C):y===et?new Uint16Array(e,w,C):new Uint8Array(e,w,C);d?(m._levels[n]||(m._levels[n]=[]),m._levels[n][t]=r):m._levels[n]=r,w+=C*x,s=Math.max(.5*s,1),i=Math.max(.5*i,1)}}return m.upload(),m}}class Dd{constructor(t){this.maxRetries=0}load(t,e,s){cl.fetchArrayBuffer(t.load,e,s,this.maxRetries)}open(t,e,s,i={}){const n=this.parse(e);if(!n)return null;const r=new Ue(s,$t({name:t,addressU:0,addressV:1,minFilter:0,magFilter:0,width:n.width,height:n.height,levels:n.levels,format:7,type:Rt,mipmaps:!1},i));return r.upload(),r}parse(t){const e=new T(t);if(!e.readLine().startsWith("#?RADIANCE"))return null;const s={};for(;;){const t=e.readLine();if(0===t.length)break;{const e=t.split("=");2===e.length&&(s[e[0]]=e[1])}}if(!s.hasOwnProperty("FORMAT"))return null;const i=e.readLine().split(" ");if(4!==i.length)return null;const n=parseInt(i[1],10),r=parseInt(i[3],10),a=this._readPixels(e,r,n,"-Y"===i[0]);return a?{width:r,height:n,levels:[a]}:null}_readPixels(t,e,s,i){if(e<8||e>32767)return this._readPixelsFlat(t,e,s);const n=[0,0,0,0];if(t.readArray(n),2!==n[0]||2!==n[1]||0!=(128&n[2]))return t.skip(-4),this._readPixelsFlat(t,e,s);const r=new ArrayBuffer(e*s*4),a=new Uint8Array(r);let o,l,h,c,d,u,p=i?0:4*e*(s-1);for(l=0;l<s;++l){if(l&&t.readArray(n),(n[2]<<8)+n[3]!==e)return null;for(c=0;c<4;++c)for(o=0;o<e;)if(d=t.readU8(),d>128){if(d-=128,o+d>e)return null;for(u=t.readU8(),h=0;h<d;++h)a[p+c+4*o++]=u}else{if(0===d||o+d>e)return null;for(h=0;h<d;++h)a[p+c+4*o++]=t.readU8()}p+=4*e*(i?1:-1)}return a}_readPixelsFlat(t,e,s){return t.remainingBytes===e*s*4?new Uint8Array(t.arraybuffer,t.offset):null}}const Rd={repeat:0,clamp:1,mirror:2},Ld={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},Id={default:kt,rgbm:Dt,rgbe:Rt,rgbp:Lt,swizzleGGGR:It};class Od{constructor(t){this.handlerType="texture";const e=t.assets,s=t.graphicsDevice;this._device=s,this._assets=e,this.imgParser=new Cd(e,s),this.parsers={dds:new kd(e),ktx:new Pd(e),ktx2:new Ad(e,s),basis:new Sd(e,s),hdr:new Dd(e)}}set crossOrigin(t){this.imgParser.crossOrigin=t}get crossOrigin(){return this.imgParser.crossOrigin}set maxRetries(t){this.imgParser.maxRetries=t;for(const e in this.parsers)this.parsers.hasOwnProperty(e)&&(this.parsers[e].maxRetries=t)}get maxRetries(){return this.imgParser.maxRetries}_getUrlWithoutParams(t){return t.indexOf("?")>=0?t.split("?")[0]:t}_getParser(t){const e=u.getExtension(this._getUrlWithoutParams(t)).toLowerCase().replace(".","");return this.parsers[e]||this.imgParser}_getTextureOptions(t){const e={};if(t){var s;(null==(s=t.name)?void 0:s.length)>0&&(e.name=t.name);const i=t.data;i.hasOwnProperty("minfilter")&&(e.minFilter=Ld[i.minfilter]),i.hasOwnProperty("magfilter")&&(e.magFilter=Ld[i.magfilter]),i.hasOwnProperty("addressu")&&(e.addressU=Rd[i.addressu]),i.hasOwnProperty("addressv")&&(e.addressV=Rd[i.addressv]),i.hasOwnProperty("mipmaps")&&(e.mipmaps=i.mipmaps),i.hasOwnProperty("anisotropy")&&(e.anisotropy=i.anisotropy),i.hasOwnProperty("flipY")&&(e.flipY=!!i.flipY),i.hasOwnProperty("type")?e.type=Id[i.type]:i.hasOwnProperty("rgbm")&&i.rgbm?e.type=Dt:t.file&&0!=(8&t.file.opt)&&(e.type=It)}return e}load(t,e,s){"string"==typeof t&&(t={load:t,original:t}),this._getParser(t.original).load(t,e,s)}open(t,e,s){if(!t)return;const i=this._getTextureOptions(s);let n=this._getParser(t).open(t,e,this._device,i);return null===n?n=new Ue(this._device,{width:4,height:4,format:6}):(!function(t){const e=Math.log2(Math.max(t._width,t._height))+1;if(7!==t._format&&t._format!==st||t._volume||t._compressed||1===t._levels.length||t._levels.length===e||(s=t._cubemap?t._levels[0][0]:t._levels[0])instanceof HTMLCanvasElement||s instanceof HTMLImageElement||s instanceof HTMLVideoElement)return;var s;const i=function(t,e,s){const i=Math.max(1,t>>1),n=Math.max(1,e>>1),r=new s.constructor(i*n*4),a=Math.floor(t/i),o=Math.floor(e/n),l=a*o;for(let e=0;e<n;++e)for(let n=0;n<i;++n)for(let h=0;h<4;++h){let c=0;for(let i=0;i<o;++i)for(let r=0;r<a;++r)c+=s[4*(n*a+r+(e*o+i)*t)+h];r[4*(n+e*i)+h]=c/l}return r};for(let s=t._levels.length;s<e;++s){const e=Math.max(1,t._width>>s-1),n=Math.max(1,t._height>>s-1);if(t._cubemap){const r=[];for(let a=0;a<6;++a)r.push(i(e,n,t._levels[s-1][a]));t._levels.push(r)}else t._levels.push(i(e,n,t._levels[s-1]))}t._levelsUpdated=t._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]}(n),e.unswizzledGGGR&&(s.file.variants.basis.opt&=-9)),n}patch(t,e){const s=t.resource;if(!s)return;const i=this._getTextureOptions(t);for(const t of Object.keys(i))s[t]=i[t]}}const Fd="immersive-vr",Bd="immersive-ar",zd="viewer",Nd="cpu-optimized";class Ud extends h{constructor(t){super(),this._manager=void 0,this._available=!1,this._depthInfoCpu=null,this._depthInfoGpu=null,this._usage=null,this._dataFormat=null,this._matrixDirty=!1,this._matrix=new V,this._emptyBuffer=new Uint8Array(32),this._depthBuffer=null,this._texture=void 0,this._manager=t,this._texture=new Ue(this._manager.app.graphicsDevice,{format:2,mipmaps:!1,addressU:1,addressV:1,minFilter:1,magFilter:1,name:"XRDepthSensing"}),this.supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}destroy(){this._texture.destroy(),this._texture=null}_onSessionStart(){const t=this._manager.session;try{this._usage=t.depthUsage,this._dataFormat=t.depthDataFormat}catch(t){this._usage=null,this._dataFormat=null,this._available=!1,this.fire("error",t)}}_onSessionEnd(){this._depthInfoCpu=null,this._depthInfoGpu=null,this._usage=null,this._dataFormat=null,this._available&&(this._available=!1,this.fire("unavailable")),this._depthBuffer=null,this._texture._width=4,this._texture._height=4,this._texture._levels[0]=this._emptyBuffer,this._texture.upload()}_updateTexture(){const t=this._depthInfoCpu||this._depthInfoGpu;if(t){let e=!1;if(t.width===this._texture.width&&t.height===this._texture.height||(this._texture._width=t.width,this._texture._height=t.height,this._matrixDirty=!0,e=!0),this._depthInfoCpu){const t=this._depthInfoCpu.data;this._depthBuffer=new Uint8Array(t),this._texture._levels[0]=this._depthBuffer,this._texture.upload()}else this._depthInfoGpu&&(this._texture._levels[0]=this._depthInfoGpu.texture,this._texture.upload());e&&this.fire("resize",t.width,t.height)}else this._depthBuffer&&(this._depthBuffer=null,this._texture._width=4,this._texture._height=4,this._texture._levels[0]=this._emptyBuffer,this._texture.upload())}update(t,e){if(!this._usage)return;let s=null,i=null;if(this._usage===Nd&&e?s=t.getDepthInformation(e):"gpu-optimized"===this._usage&&e&&(i=t.getDepthInformation(e)),(this._depthInfoCpu&&!s||!this._depthInfoCpu&&s||this.depthInfoGpu&&!i||!this._depthInfoGpu&&i)&&(this._matrixDirty=!0),this._depthInfoCpu=s,this._depthInfoGpu=i,this._updateTexture(),this._matrixDirty){this._matrixDirty=!1;const t=this._depthInfoCpu||this._depthInfoGpu;t?this._matrix.data.set(t.normDepthBufferFromNormView.matrix):this._matrix.setIdentity()}!this._depthInfoCpu&&!this._depthInfoGpu||this._available?this._depthInfoCpu||this._depthInfoGpu||!this._available||(this._available=!1,this.fire("unavailable")):(this._available=!0,this.fire("available"))}getDepth(t,e){return this._depthInfoCpu?this._depthInfoCpu.getDepthInMeters(t,e):null}get supported(){return w.browser&&!!window.XRDepthInformation}get available(){return this._available}get usage(){return this._usage}get dataFormat(){return this._dataFormat}get width(){const t=this._depthInfoCpu||this._depthInfoGpu;return t&&t.width||0}get height(){const t=this._depthInfoCpu||this._depthInfoGpu;return t&&t.height||0}get texture(){return this._texture}get uvMatrix(){return this._matrix}get rawValueToMeters(){const t=this._depthInfoCpu||this._depthInfoGpu;return t&&t.rawValueToMeters||0}}class Vd{constructor(t){this._manager=void 0,this._supported=w.browser&&!!window.XRDOMOverlayState,this._root=null,this._manager=t}get supported(){return this._supported}get available(){return this._supported&&this._manager.active&&null!==this._manager._session.domOverlayState}get state(){return this._supported&&this._manager.active&&this._manager._session.domOverlayState?this._manager._session.domOverlayState.type:null}set root(t){this._supported&&!this._manager.active&&(this._root=t)}get root(){return this._root}}const Hd=[],Gd=[];class Wd extends h{constructor(t,e,s){super(),this.manager=void 0,this._xrHitTestSource=void 0,this._transient=void 0,this.manager=t,this._xrHitTestSource=e,this._transient=s}remove(){if(!this._xrHitTestSource)return;const t=this.manager.hitTest.sources,e=t.indexOf(this);-1!==e&&t.splice(e,1),this.onStop()}onStop(){this._xrHitTestSource.cancel(),this._xrHitTestSource=null,this.fire("remove"),this.manager.hitTest.fire("remove",this)}update(t){if(this._transient){const e=t.getHitTestResultsForTransientInput(this._xrHitTestSource);for(let t=0;t<e.length;t++){const s=e[t];let i;s.inputSource&&(i=this.manager.input._getByInputSource(s.inputSource)),this.updateHitResults(s.results,i)}}else this.updateHitResults(t.getHitTestResults(this._xrHitTestSource))}updateHitResults(t,e){for(let s=0;s<t.length;s++){const i=t[s].getPose(this.manager._referenceSpace);let n=Hd.pop();n||(n=new R),n.copy(i.transform.position);let r=Gd.pop();r||(r=new H),r.copy(i.transform.orientation),this.fire("result",n,r,e),this.manager.hitTest.fire("result",this,n,r,e),Hd.push(n),Gd.push(r)}}}class jd extends h{constructor(t){super(),this.manager=void 0,this._supported=w.browser&&!(!window.XRSession||!window.XRSession.prototype.requestHitTestSource),this._session=null,this.sources=[],this.manager=t,this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}_onSessionStart(){this.manager.type===Bd&&(this._session=this.manager.session)}_onSessionEnd(){if(this._session){this._session=null;for(let t=0;t<this.sources.length;t++)this.sources[t].onStop();this.sources=[]}}isAvailable(t,e){let s;return this._supported||(s=new Error("XR HitTest is not supported")),this._session||(s=new Error("XR Session is not started (1)")),this.manager.type!==Bd&&(s=new Error("XR HitTest is available only for AR")),!s||(t&&t(s),e&&e.fire("error",s),!1)}start(t={}){if(!this.isAvailable(t.callback,this))return;let e;t.profile||t.spaceType||(t.spaceType=zd);const s=t.offsetRay;if(s){const t=new DOMPoint(s.origin.x,s.origin.y,s.origin.z,1),i=new DOMPoint(s.direction.x,s.direction.y,s.direction.z,0);e=new XRRay(t,i)}const i=t.callback;t.spaceType?this._session.requestReferenceSpace(t.spaceType).then((s=>{if(!this._session){const t=new Error("XR Session is not started (2)");return i&&i(t),void this.fire("error",t)}this._session.requestHitTestSource({space:s,entityTypes:t.entityTypes||void 0,offsetRay:e}).then((t=>{this._onHitTestSource(t,!1,i)})).catch((t=>{i&&i(t),this.fire("error",t)}))})).catch((t=>{i&&i(t),this.fire("error",t)})):this._session.requestHitTestSourceForTransientInput({profile:t.profile,entityTypes:t.entityTypes||void 0,offsetRay:e}).then((t=>{this._onHitTestSource(t,!0,i)})).catch((t=>{i&&i(t),this.fire("error",t)}))}_onHitTestSource(t,e,s){if(!this._session){t.cancel();const e=new Error("XR Session is not started (3)");return s&&s(e),void this.fire("error",e)}const i=new Wd(this.manager,t,e);this.sources.push(i),s&&s(null,i),this.fire("add",i)}update(t){for(let e=0;e<this.sources.length;e++)this.sources[e].update(t)}get supported(){return this._supported}}class qd extends h{constructor(t,e){super(),this._image=void 0,this._width=void 0,this._bitmap=null,this._measuredWidth=0,this._trackable=!1,this._tracking=!1,this._emulated=!1,this._pose=null,this._position=new R,this._rotation=new H,this._image=t,this._width=e}get image(){return this._image}set width(t){this._width=t}get width(){return this._width}get trackable(){return this._trackable}get tracking(){return this._tracking}get emulated(){return this._emulated}prepare(){return this._bitmap?{image:this._bitmap,widthInMeters:this._width}:createImageBitmap(this._image).then((t=>(this._bitmap=t,{image:this._bitmap,widthInMeters:this._width})))}destroy(){this._image=null,this._pose=null,this._bitmap&&(this._bitmap.close(),this._bitmap=null)}getPosition(){return this._pose&&this._position.copy(this._pose.transform.position),this._position}getRotation(){return this._pose&&this._rotation.copy(this._pose.transform.orientation),this._rotation}}class Xd extends h{constructor(t){super(),this._manager=void 0,this._supported=w.browser&&!!window.XRImageTrackingResult,this._available=!1,this._images=[],this._manager=t,this._supported&&(this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this))}add(t,e){if(!this._supported||this._manager.active)return null;const s=new qd(t,e);return this._images.push(s),s}remove(t){if(this._manager.active)return;const e=this._images.indexOf(t);-1!==e&&(t.destroy(),this._images.splice(e,1))}_onSessionStart(){this._manager.session.getTrackedImageScores().then((t=>{this._available=!0;for(let e=0;e<t.length;e++)this._images[e]._trackable="trackable"===t[e]})).catch((t=>{this._available=!1,this.fire("error",t)}))}_onSessionEnd(){this._available=!1;for(let t=0;t<this._images.length;t++){const e=this._images[t];e._pose=null,e._measuredWidth=0,e._tracking&&(e._tracking=!1,e.fire("untracked"))}}prepareImages(t){this._images.length?Promise.all(this._images.map((function(t){return t.prepare()}))).then((function(e){t(null,e)})).catch((function(e){t(e,null)})):t(null,null)}update(t){if(!this._available)return;const e=t.getImageTrackingResults(),s={};for(let i=0;i<e.length;i++){s[e[i].index]=e[i];const n=this._images[e[i].index];n._emulated="emulated"===e[i].trackingState,n._measuredWidth=e[i].measuredWidthInMeters,n._pose=t.getPose(e[i].imageSpace,this._manager._referenceSpace)}for(let t=0;t<this._images.length;t++)this._images[t]._tracking&&!s[t]?(this._images[t]._tracking=!1,this._images[t].fire("untracked")):!this._images[t]._tracking&&s[t]&&(this._images[t]._tracking=!0,this._images[t].fire("tracked"))}get supported(){return this._supported}get available(){return this._available}get images(){return this._images}}class $d{constructor(t,e){this._index=void 0,this._hand=void 0,this._joints=[],this._tip=null,this._index=t,this._hand=e,this._hand._fingers.push(this)}get index(){return this._index}get hand(){return this._hand}get joints(){return this._joints}get tip(){return this._tip}}const Kd=w.browser&&window.XRHand?["thumb-tip","index-finger-tip","middle-finger-tip","ring-finger-tip","pinky-finger-tip"]:[],Yd={};for(let t=0;t<Kd.length;t++)Yd[Kd[t]]=!0;class Qd{constructor(t,e,s,i=null){this._index=void 0,this._id=void 0,this._hand=void 0,this._finger=void 0,this._wrist=void 0,this._tip=void 0,this._radius=null,this._localTransform=new V,this._worldTransform=new V,this._localPosition=new R,this._localRotation=new H,this._position=new R,this._rotation=new H,this._dirtyLocal=!0,this._index=t,this._id=e,this._hand=s,this._finger=i,this._wrist="wrist"===e,this._tip=this._finger&&!!Yd[e]}update(t){this._dirtyLocal=!0,this._radius=t.radius,this._localPosition.copy(t.transform.position),this._localRotation.copy(t.transform.orientation)}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,R.ONE));const t=this._hand._manager.camera.parent;t?this._worldTransform.mul2(t.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}getPosition(){return this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position}getRotation(){return this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation}get index(){return this._index}get hand(){return this._hand}get finger(){return this._finger}get wrist(){return this._wrist}get tip(){return this._tip}get radius(){return this._radius||.005}}let Jd=[];const Zd=new R,tu=new R,eu=new R;w.browser&&window.XRHand&&(Jd=[["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]]);class su extends h{constructor(t){super(),this._manager=void 0,this._inputSource=void 0,this._tracking=!1,this._fingers=[],this._joints=[],this._jointsById={},this._tips=[],this._wrist=null;const e=t._xrInputSource.hand;if(this._manager=t._manager,this._inputSource=t,e.get("wrist")){const t=new Qd(0,"wrist",this,null);this._wrist=t,this._joints.push(t),this._jointsById.wrist=t}for(let t=0;t<Jd.length;t++){const s=new $d(t,this);for(let i=0;i<Jd[t].length;i++){const n=Jd[t][i];if(!e.get(n))continue;const r=new Qd(i,n,this,s);this._joints.push(r),this._jointsById[n]=r,r.tip&&(this._tips.push(r),s._tip=r),s._joints.push(r)}}}update(t){const e=this._inputSource._xrInputSource;for(let s=0;s<this._joints.length;s++){const i=this._joints[s],n=e.hand.get(i._id);if(n){let e;if("hidden"!==t.session.visibilityState&&(e=t.getJointPose(n,this._manager._referenceSpace)),e)i.update(e),i.wrist&&!this._tracking&&(this._tracking=!0,this.fire("tracking"));else if(i.wrist){this._tracking&&(this._tracking=!1,this.fire("trackinglost"));break}}}const s=this._jointsById["thumb-metacarpal"],i=this._jointsById["thumb-tip"],n=this._jointsById["index-finger-phalanx-proximal"],r=this._jointsById["index-finger-tip"],a=this._jointsById["ring-finger-phalanx-proximal"],o=this._jointsById["pinky-finger-phalanx-proximal"];if(s&&i&&n&&r&&a&&o){this._inputSource._dirtyRay=!0,this._inputSource._rayLocal.origin.lerp(i._localPosition,r._localPosition,.5);let t=s,e=o;if("left"===this._inputSource.handedness){const s=t;t=e,e=s}Zd.sub2(t._localPosition,this._wrist._localPosition),tu.sub2(e._localPosition,this._wrist._localPosition),eu.cross(Zd,tu).normalize(),Zd.lerp(n._localPosition,a._localPosition,.5),Zd.sub(this._wrist._localPosition).normalize(),this._inputSource._rayLocal.direction.lerp(eu,Zd,.5).normalize()}this._fingerIsClosed(1)&&this._fingerIsClosed(2)&&this._fingerIsClosed(3)&&this._fingerIsClosed(4)?this._inputSource._squeezing||(this._inputSource._squeezing=!0,this._inputSource.fire("squeezestart"),this._manager.input.fire("squeezestart",this._inputSource)):this._inputSource._squeezing&&(this._inputSource._squeezing=!1,this._inputSource.fire("squeeze"),this._manager.input.fire("squeeze",this._inputSource),this._inputSource.fire("squeezeend"),this._manager.input.fire("squeezeend",this._inputSource))}_fingerIsClosed(t){const e=this._fingers[t];return Zd.sub2(e.joints[0]._localPosition,e.joints[1]._localPosition).normalize(),tu.sub2(e.joints[2]._localPosition,e.joints[3]._localPosition).normalize(),Zd.dot(tu)<-.8}getJointById(t){return this._jointsById[t]||null}get fingers(){return this._fingers}get joints(){return this._joints}get tips(){return this._tips}get wrist(){return this._wrist}get tracking(){return this._tracking}}const iu=new H;let nu=0;class ru extends h{constructor(t,e){super(),this._id=void 0,this._manager=void 0,this._xrInputSource=void 0,this._ray=new Z,this._rayLocal=new Z,this._grip=!1,this._hand=null,this._localTransform=null,this._worldTransform=null,this._position=new R,this._rotation=new H,this._localPosition=null,this._localRotation=null,this._dirtyLocal=!0,this._dirtyRay=!1,this._selecting=!1,this._squeezing=!1,this._elementInput=!0,this._elementEntity=null,this._hitTestSources=[],this._id=++nu,this._manager=t,this._xrInputSource=e,e.hand&&(this._hand=new su(this))}get id(){return this._id}get inputSource(){return this._xrInputSource}get targetRayMode(){return this._xrInputSource.targetRayMode}get handedness(){return this._xrInputSource.handedness}get profiles(){return this._xrInputSource.profiles}get grip(){return this._grip}get hand(){return this._hand}get gamepad(){return this._xrInputSource.gamepad||null}get selecting(){return this._selecting}get squeezing(){return this._squeezing}set elementInput(t){this._elementInput!==t&&(this._elementInput=t,this._elementInput||(this._elementEntity=null))}get elementInput(){return this._elementInput}get elementEntity(){return this._elementEntity}get hitTestSources(){return this._hitTestSources}update(t){if(this._hand)this._hand.update(t);else{if(this._xrInputSource.gripSpace){const e=t.getPose(this._xrInputSource.gripSpace,this._manager._referenceSpace);e&&(this._grip||(this._grip=!0,this._localTransform=new V,this._worldTransform=new V,this._localPosition=new R,this._localRotation=new H),this._dirtyLocal=!0,this._localPosition.copy(e.transform.position),this._localRotation.copy(e.transform.orientation))}const e=t.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);e&&(this._dirtyRay=!0,this._rayLocal.origin.copy(e.transform.position),this._rayLocal.direction.set(0,0,-1),iu.copy(e.transform.orientation),iu.transformVector(this._rayLocal.direction,this._rayLocal.direction))}}_updateTransforms(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,R.ONE));const t=this._manager.camera.parent;t?this._worldTransform.mul2(t.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)}_updateRayTransforms(){const t=this._dirtyRay;this._dirtyRay=!1;if(this._manager.camera.parent){const t=this._manager.camera.parent.getWorldTransform();t.getTranslation(this._position),this._rotation.setFromMat4(t),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction)}else t&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction))}getPosition(){return this._position?(this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position):null}getLocalPosition(){return this._localPosition}getRotation(){return this._rotation?(this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation):null}getLocalRotation(){return this._localRotation}getOrigin(){return this._updateRayTransforms(),this._ray.origin}getDirection(){return this._updateRayTransforms(),this._ray.direction}hitTestStart(t={}){t.profile=this._xrInputSource.profiles[0];const e=t.callback;t.callback=(t,s)=>{s&&this.onHitTestSourceAdd(s),e&&e(t,s)},this._manager.hitTest.start(t)}onHitTestSourceAdd(t){this._hitTestSources.push(t),this.fire("hittest:add",t),t.on("result",(function(e,s,i){i===this&&this.fire("hittest:result",t,e,s)}),this),t.once("remove",(function(){this.onHitTestSourceRemove(t),this.fire("hittest:remove",t)}),this)}onHitTestSourceRemove(t){const e=this._hitTestSources.indexOf(t);-1!==e&&this._hitTestSources.splice(e,1)}}class au extends h{constructor(t){super(),this.manager=void 0,this._inputSources=[],this._onInputSourcesChangeEvt=void 0,this.manager=t,this._onInputSourcesChangeEvt=t=>{this._onInputSourcesChange(t)},this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this)}_onSessionStart(){const t=this.manager.session;t.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt),t.addEventListener("select",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e.fire("select",t),this.fire("select",e,t)})),t.addEventListener("selectstart",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e._selecting=!0,e.fire("selectstart",t),this.fire("selectstart",e,t)})),t.addEventListener("selectend",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e._selecting=!1,e.fire("selectend",t),this.fire("selectend",e,t)})),t.addEventListener("squeeze",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e.fire("squeeze",t),this.fire("squeeze",e,t)})),t.addEventListener("squeezestart",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e._squeezing=!0,e.fire("squeezestart",t),this.fire("squeezestart",e,t)})),t.addEventListener("squeezeend",(t=>{const e=this._getByInputSource(t.inputSource);e.update(t.frame),e._squeezing=!1,e.fire("squeezeend",t),this.fire("squeezeend",e,t)}));const e=t.inputSources;for(let t=0;t<e.length;t++)this._addInputSource(e[t])}_onSessionEnd(){let t=this._inputSources.length;for(;t--;){const e=this._inputSources[t];this._inputSources.splice(t,1),e.fire("remove"),this.fire("remove",e)}this.manager.session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt)}_onInputSourcesChange(t){for(let e=0;e<t.removed.length;e++)this._removeInputSource(t.removed[e]);for(let e=0;e<t.added.length;e++)this._addInputSource(t.added[e])}_getByInputSource(t){for(let e=0;e<this._inputSources.length;e++)if(this._inputSources[e].inputSource===t)return this._inputSources[e];return null}_addInputSource(t){if(this._getByInputSource(t))return;const e=new ru(this.manager,t);this._inputSources.push(e),this.fire("add",e)}_removeInputSource(t){for(let e=0;e<this._inputSources.length;e++){if(this._inputSources[e].inputSource!==t)continue;const s=this._inputSources[e];this._inputSources.splice(e,1);let i=s.hitTestSources.length;for(;i--;)s.hitTestSources[i].remove();return s.fire("remove"),void this.fire("remove",s)}}update(t){for(let e=0;e<this._inputSources.length;e++)this._inputSources[e].update(t)}get inputSources(){return this._inputSources}}const ou=new R,lu=new R,hu=new V,cu=new V;class du extends h{constructor(t){super(),this._manager=void 0,this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null,this._intensity=0,this._rotation=new H,this._color=new D,this._sphericalHarmonics=new Float32Array(27),this._manager=t,this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}_onSessionStart(){!!this._manager.session.requestLightProbe&&(this._supported=!0)}_onSessionEnd(){this._supported=!1,this._available=!1,this._lightProbeRequested=!1,this._lightProbe=null}start(){let t;this._manager.session||(t=new Error("XR session is not running")),t||this._manager.type===Bd||(t=new Error("XR session type is not AR")),t||this._supported||(t=new Error("light-estimation is not supported")),(!t&&this._lightProbe||this._lightProbeRequested)&&(t=new Error("light estimation is already requested")),t?this.fire("error",t):(this._lightProbeRequested=!0,this._manager.session.requestLightProbe().then((t=>{const e=this._lightProbeRequested;this._lightProbeRequested=!1,this._manager.active?e&&(this._lightProbe=t):this.fire("error",new Error("XR session is not active"))})).catch((t=>{this._lightProbeRequested=!1,this.fire("error",t)})))}end(){this._lightProbeRequested=!1,this._lightProbe=null,this._available=!1}update(t){if(!this._lightProbe)return;const e=t.getLightEstimate(this._lightProbe);if(!e)return;this._available||(this._available=!0,this.fire("available"));const s=e.primaryLightIntensity;this._intensity=Math.max(1,Math.max(s.x,Math.max(s.y,s.z))),ou.copy(s).mulScalar(1/this._intensity),this._color.set(ou.x,ou.y,ou.z),ou.set(0,0,0),lu.copy(e.primaryLightDirection),hu.setLookAt(lu,ou,R.UP),cu.setFromAxisAngle(R.RIGHT,90),hu.mul(cu),this._rotation.setFromMat4(hu),this._sphericalHarmonics.set(e.sphericalHarmonicsCoefficients)}get supported(){return this._supported}get available(){return this._available}get intensity(){return this._available?this._intensity:null}get color(){return this._available?this._color:null}get rotation(){return this._available?this._rotation:null}get sphericalHarmonics(){return this._available?this._sphericalHarmonics:null}}let uu=0;class pu extends h{constructor(t,e){super(),this._id=void 0,this._planeDetection=void 0,this._xrPlane=void 0,this._lastChangedTime=void 0,this._orientation=void 0,this._position=new R,this._rotation=new H,this._id=++uu,this._planeDetection=t,this._xrPlane=e,this._lastChangedTime=e.lastChangedTime,this._orientation=e.orientation}destroy(){this.fire("remove")}update(t){const e=this._planeDetection._manager,s=t.getPose(this._xrPlane.planeSpace,e._referenceSpace);s&&(this._position.copy(s.transform.position),this._rotation.copy(s.transform.orientation)),this._lastChangedTime!==this._xrPlane.lastChangedTime&&(this._lastChangedTime=this._xrPlane.lastChangedTime,this.fire("change"))}getPosition(){return this._position}getRotation(){return this._rotation}get id(){return this._id}get orientation(){return this._orientation}get points(){return this._xrPlane.polygon}}class fu extends h{constructor(t){super(),this._manager=void 0,this._supported=w.browser&&!!window.XRPlane,this._available=!1,this._planesIndex=new Map,this._planes=null,this._manager=t,this._supported&&this._manager.on("end",this._onSessionEnd,this)}_onSessionEnd(){if(this._planes)for(let t=0;t<this._planes.length;t++)this._planes[t].destroy();this._planesIndex.clear(),this._planes=null,this._available&&(this._available=!1,this.fire("unavailable"))}update(t){let e;if(this._available)e=t.detectedPlanes;else try{e=t.detectedPlanes,this._planes=[],this._available=!0,this.fire("available")}catch(t){return}for(const[t,s]of this._planesIndex)e.has(t)||(this._planesIndex.delete(t),this._planes.splice(this._planes.indexOf(s),1),s.destroy(),this.fire("remove",s));for(const s of e){let e=this._planesIndex.get(s);e?e.update(t):(e=new pu(this,s),this._planesIndex.set(s,e),this._planes.push(e),e.update(t),this.fire("add",e))}}get supported(){return this._supported}get available(){return this._available}get planes(){return this._planes}}class mu extends h{constructor(t){super(),this.app=void 0,this._supported=w.browser&&!!navigator.xr,this._available={},this._type=null,this._spaceType=null,this._session=null,this._baseLayer=null,this._referenceSpace=null,this.depthSensing=void 0,this.domOverlay=void 0,this.hitTest=void 0,this.imageTracking=void 0,this.planeDetection=void 0,this.input=void 0,this.lightEstimation=void 0,this._camera=null,this.views=[],this.viewsPool=[],this._localPosition=new R,this._localRotation=new H,this._depthNear=.1,this._depthFar=1e3,this._width=0,this._height=0,this.app=t,this._available.inline=!1,this._available[Fd]=!1,this._available[Bd]=!1,this.depthSensing=new Ud(this),this.domOverlay=new Vd(this),this.hitTest=new jd(this),this.imageTracking=new Xd(this),this.planeDetection=new fu(this),this.input=new au(this),this.lightEstimation=new du(this),this._supported&&(navigator.xr.addEventListener("devicechange",(()=>{this._deviceAvailabilityCheck()})),this._deviceAvailabilityCheck())}destroy(){this.depthSensing.destroy(),this.depthSensing=null}start(t,e,s,i){let n=i;if("object"==typeof i&&(n=i.callback),!this._available[e])return void(n&&n(new Error("XR is not available")));if(this._session)return void(n&&n(new Error("XR session is already started")));this._camera=t,this._camera.camera.xr=this,this._type=e,this._spaceType=s,this._setClipPlanes(t.nearClip,t.farClip);const r={requiredFeatures:[s],optionalFeatures:[]};if(e===Bd){if(r.optionalFeatures.push("light-estimation"),r.optionalFeatures.push("hit-test"),i&&(i.imageTracking&&this.imageTracking.supported&&r.optionalFeatures.push("image-tracking"),i.planeDetection&&r.optionalFeatures.push("plane-detection")),this.domOverlay.supported&&this.domOverlay.root&&(r.optionalFeatures.push("dom-overlay"),r.domOverlay={root:this.domOverlay.root}),i&&i.depthSensing&&this.depthSensing.supported){r.optionalFeatures.push("depth-sensing");const t=[Nd],e=["luminance-alpha"];if(i.depthSensing.usagePreference){const e=t.indexOf(i.depthSensing.usagePreference);-1!==e&&t.splice(e,1),t.unshift(i.depthSensing.usagePreference)}if(i.depthSensing.dataFormatPreference){const t=e.indexOf(i.depthSensing.dataFormatPreference);-1!==t&&e.splice(t,1),e.unshift(i.depthSensing.dataFormatPreference)}r.depthSensing={usagePreference:t,dataFormatPreference:e}}}else e===Fd&&r.optionalFeatures.push("hand-tracking");i&&i.optionalFeatures&&(r.optionalFeatures=r.optionalFeatures.concat(i.optionalFeatures)),this.imageTracking.supported&&this.imageTracking.images.length?this.imageTracking.prepareImages(((t,i)=>{if(t)return n&&n(t),void this.fire("error",t);null!==i&&(r.trackedImages=i),this._onStartOptionsReady(e,s,r,n)})):this._onStartOptionsReady(e,s,r,n)}_onStartOptionsReady(t,e,s,i){navigator.xr.requestSession(t,s).then((t=>{this._onSessionStart(t,e,i)})).catch((t=>{this._camera.camera.xr=null,this._camera=null,this._type=null,this._spaceType=null,i&&i(t),this.fire("error",t)}))}end(t){this._session?(t&&this.once("end",t),this._session.end()):t&&t(new Error("XR Session is not initialized"))}isAvailable(t){return this._available[t]}_deviceAvailabilityCheck(){for(const t in this._available)this._sessionSupportCheck(t)}_sessionSupportCheck(t){navigator.xr.isSessionSupported(t).then((e=>{this._available[t]!==e&&(this._available[t]=e,this.fire("available",t,e),this.fire("available:"+t,e))})).catch((t=>{this.fire("error",t)}))}_onSessionStart(t,e,s){let i=!1;this._session=t;const n=()=>{this.fire("visibility:change",t.visibilityState)},r=()=>{this._setClipPlanes(this._camera.nearClip,this._camera.farClip)},a=()=>{this._camera&&(this._camera.off("set_nearClip",r),this._camera.off("set_farClip",r),this._camera.camera.xr=null,this._camera=null),t.removeEventListener("end",a),t.removeEventListener("visibilitychange",n),i||this.fire("end"),this._session=null,this._referenceSpace=null,this.views=[],this._width=0,this._height=0,this._type=null,this._spaceType=null,this.app.tick()};t.addEventListener("end",a),t.addEventListener("visibilitychange",n),this._camera.on("set_nearClip",r),this._camera.on("set_farClip",r);const o=this.app.graphicsDevice.maxPixelRatio/window.devicePixelRatio;this._baseLayer=new XRWebGLLayer(t,this.app.graphicsDevice.gl,{alpha:!0,depth:!0,stencil:!0,framebufferScaleFactor:o}),t.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar}),t.requestReferenceSpace(e).then((t=>{this._referenceSpace=t,this.app.tick(),s&&s(null),this.fire("start")})).catch((e=>{i=!0,t.end(),s&&s(e),this.fire("error",e)}))}_setClipPlanes(t,e){this._depthNear===t&&this._depthFar===e||(this._depthNear=t,this._depthFar=e,this._session&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar}))}update(t){if(!this._session)return!1;const e=t.session.renderState.baseLayer.framebufferWidth,s=t.session.renderState.baseLayer.framebufferHeight;this._width===e&&this._height===s||(this._width=e,this._height=s,this.app.graphicsDevice.setResolution(e,s));const i=t.getViewerPose(this._referenceSpace);if(!i)return!1;const n=this.views.length,r=i.views.length;for(;r>this.views.length;){let t=this.viewsPool.pop();t||(t={viewport:new O,projMat:new V,viewMat:new V,viewOffMat:new V,viewInvMat:new V,viewInvOffMat:new V,projViewOffMat:new V,viewMat3:new L,position:new Float32Array(3),rotation:new H}),this.views.push(t)}for(;r<this.views.length;)this.viewsPool.push(this.views.pop());const a=i.transform.position,o=i.transform.orientation;this._localPosition.set(a.x,a.y,a.z),this._localRotation.set(o.x,o.y,o.z,o.w);const l=t.session.renderState.baseLayer;for(let t=0;t<i.views.length;t++){const e=i.views[t],s=this.views[t],n=l.getViewport(e);s.viewport.x=n.x,s.viewport.y=n.y,s.viewport.z=n.width,s.viewport.w=n.height,s.projMat.set(e.projectionMatrix),s.viewMat.set(e.transform.inverse.matrix),s.viewInvMat.set(e.transform.matrix)}if(0===n&&this.views.length>0){const t=new V,e=this.views[0];t.copy(e.projMat);const s=t.data,i=2*Math.atan(1/s[5])*180/Math.PI,n=s[5]/s[0],r=s[14]/(s[10]+1),a=s[14]/(s[10]-1),o=!1;this._camera.camera.setXrProperties({aspectRatio:n,farClip:r,fov:i,horizontalFov:o,nearClip:a})}return this._camera.camera._node.setLocalPosition(this._localPosition),this._camera.camera._node.setLocalRotation(this._localRotation),this.input.update(t),this._type===Bd&&(this.hitTest.supported&&this.hitTest.update(t),this.lightEstimation.supported&&this.lightEstimation.update(t),this.depthSensing.supported&&this.depthSensing.update(t,i&&i.views[0]),this.imageTracking.supported&&this.imageTracking.update(t),this.planeDetection.supported&&this.planeDetection.update(t)),this.fire("update",t),!0}get supported(){return this._supported}get active(){return!!this._session}get type(){return this._type}get spaceType(){return this._spaceType}get session(){return this._session}get camera(){return this._camera?this._camera.entity:null}get visibilityState(){return this._session?this._session.visibilityState:null}}class gu{constructor(t,e,s){this.owner=t,this.name=e,this.fn=s}unbind(){this.owner&&(this.owner.unbind(this.name,this.fn),this.owner=null,this.name=null,this.fn=null)}call(){this.fn&&this.fn.call(this.owner,arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7])}on(t,e){return this.owner.on(t,e)}}class _u{constructor(){Object.defineProperty(this,"_events",{enumerable:!1,configurable:!1,writable:!0,value:{}}),this._suspendEvents=!1,this._additionalEmitters=[]}set suspendEvents(t){this._suspendEvents=!!t}get suspendEvents(){return this._suspendEvents}on(t,e){const s=this._events[t];return void 0===s?this._events[t]=[e]:-1===s.indexOf(e)&&s.push(e),new gu(this,t,e)}once(t,e){const s=this.on(t,((t,i,n,r,a,o,l,h)=>{e.call(this,t,i,n,r,a,o,l,h),s.unbind()}));return s}emit(t,e,s,i,n,r,a,o,l){if(this._suspendEvents)return this;let h=this._events[t];if(h&&h.length){h=h.slice(0);for(let c=0;c<h.length;c++)if(h[c])try{h[c].call(this,e,s,i,n,r,a,o,l)}catch(e){console.info("%c%s %c(event error)","color: #06f",t,"color: #f00"),console.log(e.stack)}}if(this._additionalEmitters.length){this._additionalEmitters.slice().forEach((h=>{h.emit(t,e,s,i,n,r,a,o,l)}))}return this}unbind(t,e){if(t){const s=this._events[t];if(!s)return this;if(e){const i=s.indexOf(e);-1!==i&&(1===s.length?delete this._events[t]:s.splice(i,1))}else delete this._events[t]}else this._events={};return this}addEmitter(t){this._additionalEmitters.includes(t)||this._additionalEmitters.push(t)}removeEmitter(t){const e=this._additionalEmitters.indexOf(t);-1!==e&&this._additionalEmitters.splice(e,1)}}const vu=(t,e)=>{if(!t||!e)return!1;const s=t.length;if(s!==e.length)return!1;for(let i=0;i<s;i++)if(t[i]instanceof Array&&e[i]instanceof Array){if(!vu(t[i],e[i]))return!1}else if(t[i]!==e[i])return!1;return!0};class bu extends _u{constructor(t,e={}){if(super(),this._destroyed=!1,this._path="",this._keys=[],this._data={},this._pathsWithDuplicates=null,e.pathsWithDuplicates){this._pathsWithDuplicates={};for(let t=0;t<e.pathsWithDuplicates.length;t++)this._pathsWithDuplicates[e.pathsWithDuplicates[t]]=!0}this.patch(t),this._parent=e.parent||null,this._parentPath=e.parentPath||"",this._parentField=e.parentField||null,this._parentKey=e.parentKey||null,this._latestFn=e.latestFn||null,this._silent=!1;const s=function(t){return function(e,s,i,n){if(!this._parent)return;let r,a=this._parentKey;!a&&this._parentField instanceof Array&&(a=this._parentField.indexOf(this),-1===a)||(e=this._parentPath+"."+a+"."+e,this._silent&&(r=this._parent.silence()),this._parent.emit(e+":"+t,s,i,n),this._parent.emit("*:"+t,e,s,i,n),this._silent&&this._parent.silenceRestore(r))}};this.on("*:set",s("set")),this.on("*:unset",s("unset")),this.on("*:insert",s("insert")),this.on("*:remove",s("remove")),this.on("*:move",s("move"))}static _splitPath(t){const e=bu._splitPathsCache;let s=e[t];return s?s=s.slice():(s=t.split("."),e[t]=s),s}silence(){this._silent=!0;const t=this.history&&this.history.enabled;t&&(this.history.enabled=!1);const e=this.sync&&this.sync.enabled;return e&&(this.sync.enabled=!1),[t,e]}silenceRestore(t){this._silent=!1,t[0]&&(this.history.enabled=!0),t[1]&&(this.sync.enabled=!0)}_prepare(t,e,s,i,n){let r,a;const o=(t._path?t._path+".":"")+e,l=typeof s;if(t._keys.push(e),"object"===l&&s instanceof Array){for(t._data[e]=s.slice(0),r=0;r<t._data[e].length;r++)"object"==typeof t._data[e][r]&&null!==t._data[e][r]?t._data[e][r]instanceof Array?t._data[e][r].slice(0):t._data[e][r]=new bu(t._data[e][r],{parent:this,parentPath:o,parentField:t._data[e],parentKey:null}):(a=this.silence(),this.emit(o+"."+r+":set",t._data[e][r],null,n),this.emit("*:set",o+"."+r,t._data[e][r],null,n),this.silenceRestore(a));i&&(a=this.silence()),this.emit(o+":set",t._data[e],null,n),this.emit("*:set",o,t._data[e],null,n),i&&this.silenceRestore(a)}else if("object"===l&&s instanceof Object){for(r in"object"!=typeof t._data[e]&&(t._data[e]={_path:o,_keys:[],_data:{}}),s)"object"==typeof s[r]?this._prepare(t._data[e],r,s[r],!0,n):(a=this.silence(),t._data[e]._data[r]=s[r],t._data[e]._keys.push(r),this.emit(o+"."+r+":set",s[r],null,n),this.emit("*:set",o+"."+r,s[r],null,n),this.silenceRestore(a));i&&(a=this.silence()),this.emit(o+":set",s,void 0,n),this.emit("*:set",o,s,void 0,n),i&&this.silenceRestore(a)}else i&&(a=this.silence()),t._data[e]=s,this.emit(o+":set",s,void 0,n),this.emit("*:set",o,s,void 0,n),i&&this.silenceRestore(a);return!0}set(t,e,s,i,n){let r,a,o=bu._splitPath(t);const l=o.length,h=o[l-1];let c,d,u=this,p="",f=this;for(r=0;r<l-1;r++)u instanceof Array?(u=u[o[r]],u instanceof bu&&(t=o.slice(r+1).join("."),f=u)):(r<l&&"object"!=typeof u._data[o[r]]&&(u._data[o[r]]&&f.unset((u.__path?u.__path+".":"")+o[r]),u._data[o[r]]={_path:t,_keys:[],_data:{}},u._keys.push(o[r])),r===l-1&&u.__path&&(p=u.__path+"."+o[r]),u=u._data[o[r]]);if(u instanceof Array){const r=parseInt(h,10);return!(u[r]===e&&!n)&&(a=u[r],a=a instanceof bu?a.json():f.json(a),u[r]=e,e instanceof bu&&(e._parent=f,e._parentPath=p,e._parentField=u,e._parentKey=null),s&&(c=f.silence()),f.emit(t+":set",e,a,i),f.emit("*:set",t,e,a,i),s&&f.silenceRestore(c),!0)}if(u._data&&!u._data.hasOwnProperty(h))return"object"==typeof e?f._prepare(u,h,e,!1,i):(u._data[h]=e,u._keys.push(h),s&&(c=f.silence()),f.emit(t+":set",e,null,i),f.emit("*:set",t,e,null,i),s&&f.silenceRestore(c),!0);if("object"==typeof e&&e instanceof Array){if(vu(e,u._data[h])&&!n)return!1;if(a=u._data[h],a instanceof bu||(a=f.json(a)),u._data[h]&&u._data[h].length===e.length){for(c=f.silence(),0===e.length&&(u._data[h]=e),r=0;r<u._data[h].length;r++)u._data[h][r]instanceof bu?u._data[h][r].patch(e[r],!0):u._data[h][r]!==e[r]&&(u._data[h][r]=e[r],f.emit(t+"."+r+":set",u._data[h][r],a&&a[r]||null,i),f.emit("*:set",t+"."+r,u._data[h][r],a&&a[r]||null,i));f.silenceRestore(c)}else{for(u._data[h]=[],e.forEach((t=>{this._doInsert(u,h,t,void 0,!0)})),c=f.silence(),r=0;r<u._data[h].length;r++)f.emit(t+"."+r+":set",u._data[h][r],a&&a[r]||null,i),f.emit("*:set",t+"."+r,u._data[h][r],a&&a[r]||null,i);f.silenceRestore(c)}return s&&(c=f.silence()),f.emit(t+":set",e,a,i),f.emit("*:set",t,e,a,i),s&&f.silenceRestore(c),!0}if("object"==typeof e&&e instanceof Object){let n,l=!1;a=u._data[h],a instanceof bu||(a=f.json(a)),o=Object.keys(e),u._data[h]&&u._data[h]._data||(u._data[h]?f.unset((u.__path?u.__path+".":"")+h):l=!0,u._data[h]={_path:t,_keys:[],_data:{}});for(const s in u._data[h]._data)e.hasOwnProperty(s)?u._data[h]._data.hasOwnProperty(s)?f._equals(u._data[h]._data[s],e[s])||(n=f.set(t+"."+s,e[s],!0),n&&(l=!0)):(n=f._prepare(u._data[h],s,e[s],!0,i),n&&(l=!0)):(n=f.unset(t+"."+s,!0),n&&(l=!0));for(r=0;r<o.length;r++)void 0===e[o[r]]&&u._data[h]._data.hasOwnProperty(o[r])?(n=f.unset(t+"."+o[r],!0),n&&(l=!0)):"object"==typeof e[o[r]]?u._data[h]._data.hasOwnProperty(o[r])?(n=f.set(t+"."+o[r],e[o[r]],!0),n&&(l=!0)):(n=f._prepare(u._data[h],o[r],e[o[r]],!0,i),n&&(l=!0)):f._equals(u._data[h]._data[o[r]],e[o[r]])||("object"==typeof e[o[r]]?(n=f.set(u._data[h]._path+"."+o[r],e[o[r]],!0),n&&(l=!0)):u._data[h]._data[o[r]]!==e[o[r]]&&(l=!0,-1===u._data[h]._keys.indexOf(o[r])&&u._data[h]._keys.push(o[r]),u._data[h]._data[o[r]]=e[o[r]],c=f.silence(),f.emit(u._data[h]._path+"."+o[r]+":set",u._data[h]._data[o[r]],null,i),f.emit("*:set",u._data[h]._path+"."+o[r],u._data[h]._data[o[r]],null,i),f.silenceRestore(c)));if(l){s&&(c=f.silence());const t=f.json(u._data[h]);return f.emit(u._data[h]._path+":set",t,a,i),f.emit("*:set",u._data[h]._path,t,a,i),s&&f.silenceRestore(c),!0}return!1}return d=!u.hasOwnProperty("_data")&&u.hasOwnProperty(h)?u:u._data,!(d[h]===e&&!n)&&(s&&(c=f.silence()),a=d[h],a instanceof bu||(a=f.json(a)),d[h]=e,f.emit(t+":set",e,a,i),f.emit("*:set",t,e,a,i),s&&f.silenceRestore(c),!0)}has(t){const e=bu._splitPath(t);let s=this;for(let t=0,i=e.length;t<i;t++){if(null==s)return;s=s._data?s._data[e[t]]:s[e[t]]}return void 0!==s}get(t,e){const s=bu._splitPath(t);let i=this;for(let t=0;t<s.length;t++){if(null==i)return;i=i._data?i._data[s[t]]:i[s[t]]}return e?i:null==i?null:this.json(i)}getRaw(t){return this.get(t,!0)}_equals(t,e){return t===e||!!(t instanceof Array&&e instanceof Array&&vu(t,e))}unset(t,e,s){let i;const n=bu._splitPath(t),r=n[n.length-1];let a=this,o=this;for(i=0;i<n.length-1;i++)a instanceof Array?(a=a[n[i]],a instanceof bu&&(t=n.slice(i+1).join("."),o=a)):a=a._data[n[i]];if(!a._data||!a._data.hasOwnProperty(r))return!1;let l,h=a._data[r];if(h instanceof bu||(h=o.json(h)),a._data[r]&&a._data[r]._data)for(i=a._data[r]._keys.length-1;i>=0;i--)o.unset(t+"."+a._data[r]._keys[i],!0);return a._keys.splice(a._keys.indexOf(r),1),delete a._data[r],e&&(l=o.silence()),o.emit(t+":unset",h,s),o.emit("*:unset",t,h,s),e&&o.silenceRestore(l),!0}remove(t,e,s,i){const n=bu._splitPath(t),r=n[n.length-1];let a=this,o=this;for(let e=0;e<n.length-1;e++)if(a instanceof Array)a=a[parseInt(n[e],10)],a instanceof bu&&(t=n.slice(e+1).join("."),o=a);else{if(!a._data||!a._data.hasOwnProperty(n[e]))return!1;a=a._data[n[e]]}if(!(a._data&&a._data.hasOwnProperty(r)&&a._data[r]instanceof Array))return!1;const l=a._data[r];if(l.length<e)return!1;let h,c=l[e];return c instanceof bu?c._parent=null:c=o.json(c),l.splice(e,1),s&&(h=o.silence()),o.emit(t+":remove",c,e,i),o.emit("*:remove",t,c,e,i),s&&o.silenceRestore(h),!0}removeValue(t,e,s,i){const n=bu._splitPath(t),r=n[n.length-1];let a=this,o=this;for(let e=0;e<n.length-1;e++)if(a instanceof Array)a=a[parseInt(n[e],10)],a instanceof bu&&(t=n.slice(e+1).join("."),o=a);else{if(!a._data||!a._data.hasOwnProperty(n[e]))return;a=a._data[n[e]]}if(!(a._data&&a._data.hasOwnProperty(r)&&a._data[r]instanceof Array))return;const l=a._data[r],h=l.indexOf(e);if(-1===h)return;if(l.length<h)return;let c;return(e=l[h])instanceof bu?e._parent=null:e=o.json(e),l.splice(h,1),s&&(c=o.silence()),o.emit(t+":remove",e,h,i),o.emit("*:remove",t,e,h,i),s&&o.silenceRestore(c),!0}insert(t,e,s,i,n){const r=bu._splitPath(t),a=r[r.length-1];let o=this,l=this;for(let e=0;e<r.length-1;e++)if(o instanceof Array)o=o[parseInt(r[e],10)],o instanceof bu&&(t=r.slice(e+1).join("."),l=o);else{if(!o._data||!o._data.hasOwnProperty(r[e]))return;o=o._data[r[e]]}if(!(o._data&&o._data.hasOwnProperty(a)&&o._data[a]instanceof Array))return;const h=o._data[a];let c;return e=l._doInsert(o,a,e,s),void 0===s&&(s=h.length-1),i&&(c=l.silence()),l.emit(t+":insert",e,s,n),l.emit("*:insert",t,e,s,n),i&&l.silenceRestore(c),!0}_doInsert(t,e,s,i,n){const r=t._data[e];"object"!=typeof s||s instanceof bu||null===s||(s=s instanceof Array?s.slice(0):new bu(s));const a=t._path?`${t._path}.${e}`:e;if(null===s||n||this._pathsWithDuplicates&&this._pathsWithDuplicates[a]||-1===r.indexOf(s))return void 0===i?r.push(s):r.splice(i,0,s),s instanceof bu?(s._parent=this,s._parentPath=a,s._parentField=r,s._parentKey=null):s=this.json(s),s}move(t,e,s,i,n){const r=bu._splitPath(t),a=r[r.length-1];let o=this,l=this;for(let e=0;e<r.length-1;e++)if(o instanceof Array)o=o[parseInt(r[e],10)],o instanceof bu&&(t=r.slice(e+1).join("."),l=o);else{if(!o._data||!o._data.hasOwnProperty(r[e]))return;o=o._data[r[e]]}if(!(o._data&&o._data.hasOwnProperty(a)&&o._data[a]instanceof Array))return;const h=o._data[a];if(h.length<e||h.length<s||e===s)return;let c,d=h[e];return h.splice(e,1),-1===s&&(s=h.length),h.splice(s,0,d),d instanceof bu||(d=l.json(d)),i&&(c=l.silence()),l.emit(t+":move",d,s,e,n),l.emit("*:move",t,d,s,e,n),i&&l.silenceRestore(c),!0}patch(t,e){if("object"==typeof t){for(const e in t)"object"!=typeof t[e]||this._data.hasOwnProperty(e)?this._data[e]!==t[e]&&this.set(e,t[e]):this._prepare(this,e,t[e]);if(e)for(const e in this._data)t.hasOwnProperty(e)||this.unset(e)}}json(t){let e,s,i={};const n=void 0===t?this:t;let r,a;if(n instanceof Object&&n._keys){r=n._keys.length;for(let t=0;t<r;t++){e=n._keys[t];const r=n._data[e],o=typeof r;if("object"===o&&r instanceof Array)for(i[e]=r.slice(0),a=i[e].length,s=0;s<a;s++)"object"==typeof i[e][s]&&(i[e][s]=this.json(i[e][s]));else i[e]="object"===o&&r instanceof Object?this.json(r):r}}else{if(null===n)return null;if("object"==typeof n&&n instanceof Array)for(i=n.slice(0),r=i.length,s=0;s<r;s++)i[s]=this.json(i[s]);else if("object"==typeof n)for(e in n)n.hasOwnProperty(e)&&(i[e]=n[e]);else i=n}return i}forEach(t,e,s=""){const i=e||this;for(let e=0;e<i._keys.length;e++){const n=i._keys[e],r=i._data[n],a=this.schema&&this.schema.has(s+n)&&this.schema.get(s+n).type.name.toLowerCase()||typeof r;"object"===a&&r instanceof Array?t(s+n,"array",r,n):"object"===a&&r instanceof Object?(t(s+n,"object",r,n),this.forEach(t,r,s+n+".")):t(s+n,a,r,n)}}latest(){return this._latestFn?this._latestFn():this}destroy(){this._destroyed||(this._destroyed=!0,this.emit("destroy"),this.unbind())}set latestFn(t){this._latestFn=t}get latestFn(){return this._latestFn}}function yu(t){return"./static/"+t}bu._splitPathsCache={};const xu=(t,e,s=2)=>{let i,n;const r=t=>{i=t.pageX,n=t.pageY};t.addEventListener("mousedown",r);const a=t=>{const r=Math.abs(t.pageX-i),a=Math.abs(t.pageY-n);r<s&&a<s&&e(t)};return t.addEventListener("mouseup",a),()=>{t.removeEventListener("mousedown",r),t.removeEventListener("mouseup",a)}},wu=(t,e)=>{const s=(t,e)=>{for(const s of e){if(!t.hasOwnProperty(s))return null;t=t[s]}return t},i={};for(const n of e){const e=n.split("."),r=s(t,e);let a=i;for(let t=0;t<e.length;++t){const s=e[t];t<e.length-1?(a.hasOwnProperty(s)||(a[s]={}),a=a[s]):a[s]=r}}return i};let Su;function Cu(t){if(Su.call(this,t),3===t);else this._blendState.setAlphaBlend(0,1,8)}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function Tu(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Eu={exports:{}},Pu={},Mu=Symbol.for("react.element"),Au=Symbol.for("react.portal"),ku=Symbol.for("react.fragment"),Du=Symbol.for("react.strict_mode"),Ru=Symbol.for("react.profiler"),Lu=Symbol.for("react.provider"),Iu=Symbol.for("react.context"),Ou=Symbol.for("react.forward_ref"),Fu=Symbol.for("react.suspense"),Bu=Symbol.for("react.memo"),zu=Symbol.for("react.lazy"),Nu=Symbol.iterator;var Uu={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},Vu=Object.assign,Hu={};function Gu(t,e,s){this.props=t,this.context=e,this.refs=Hu,this.updater=s||Uu}function Wu(){}function ju(t,e,s){this.props=t,this.context=e,this.refs=Hu,this.updater=s||Uu}Gu.prototype.isReactComponent={},Gu.prototype.setState=function(t,e){if("object"!=typeof t&&"function"!=typeof t&&null!=t)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,t,e,"setState")},Gu.prototype.forceUpdate=function(t){this.updater.enqueueForceUpdate(this,t,"forceUpdate")},Wu.prototype=Gu.prototype;var qu=ju.prototype=new Wu;qu.constructor=ju,Vu(qu,Gu.prototype),qu.isPureReactComponent=!0;var Xu=Array.isArray,$u=Object.prototype.hasOwnProperty,Ku={current:null},Yu={key:!0,ref:!0,__self:!0,__source:!0};function Qu(t,e,s){var i,n={},r=null,a=null;if(null!=e)for(i in void 0!==e.ref&&(a=e.ref),void 0!==e.key&&(r=""+e.key),e)$u.call(e,i)&&!Yu.hasOwnProperty(i)&&(n[i]=e[i]);var o=arguments.length-2;if(1===o)n.children=s;else if(1<o){for(var l=Array(o),h=0;h<o;h++)l[h]=arguments[h+2];n.children=l}if(t&&t.defaultProps)for(i in o=t.defaultProps)void 0===n[i]&&(n[i]=o[i]);return{$$typeof:Mu,type:t,key:r,ref:a,props:n,_owner:Ku.current}}function Ju(t){return"object"==typeof t&&null!==t&&t.$$typeof===Mu}var Zu=/\/+/g;function tp(t,e){return"object"==typeof t&&null!==t&&null!=t.key?function(t){var e={"=":"=0",":":"=2"};return"$"+t.replace(/[=:]/g,(function(t){return e[t]}))}(""+t.key):e.toString(36)}function ep(t,e,s,i,n){var r=typeof t;"undefined"!==r&&"boolean"!==r||(t=null);var a=!1;if(null===t)a=!0;else switch(r){case"string":case"number":a=!0;break;case"object":switch(t.$$typeof){case Mu:case Au:a=!0}}if(a)return n=n(a=t),t=""===i?"."+tp(a,0):i,Xu(n)?(s="",null!=t&&(s=t.replace(Zu,"$&/")+"/"),ep(n,e,s,"",(function(t){return t}))):null!=n&&(Ju(n)&&(n=function(t,e){return{$$typeof:Mu,type:t.type,key:e,ref:t.ref,props:t.props,_owner:t._owner}}(n,s+(!n.key||a&&a.key===n.key?"":(""+n.key).replace(Zu,"$&/")+"/")+t)),e.push(n)),1;if(a=0,i=""===i?".":i+":",Xu(t))for(var o=0;o<t.length;o++){var l=i+tp(r=t[o],o);a+=ep(r,e,s,l,n)}else if(l=function(t){return null===t||"object"!=typeof t?null:"function"==typeof(t=Nu&&t[Nu]||t["@@iterator"])?t:null}(t),"function"==typeof l)for(t=l.call(t),o=0;!(r=t.next()).done;)a+=ep(r=r.value,e,s,l=i+tp(r,o++),n);else if("object"===r)throw e=String(t),Error("Objects are not valid as a React child (found: "+("[object Object]"===e?"object with keys {"+Object.keys(t).join(", ")+"}":e)+"). If you meant to render a collection of children, use an array instead.");return a}function sp(t,e,s){if(null==t)return t;var i=[],n=0;return ep(t,i,"","",(function(t){return e.call(s,t,n++)})),i}function ip(t){if(-1===t._status){var e=t._result;(e=e()).then((function(e){0!==t._status&&-1!==t._status||(t._status=1,t._result=e)}),(function(e){0!==t._status&&-1!==t._status||(t._status=2,t._result=e)})),-1===t._status&&(t._status=0,t._result=e)}if(1===t._status)return t._result.default;throw t._result}var np={current:null},rp={transition:null},ap={ReactCurrentDispatcher:np,ReactCurrentBatchConfig:rp,ReactCurrentOwner:Ku};Pu.Children={map:sp,forEach:function(t,e,s){sp(t,(function(){e.apply(this,arguments)}),s)},count:function(t){var e=0;return sp(t,(function(){e++})),e},toArray:function(t){return sp(t,(function(t){return t}))||[]},only:function(t){if(!Ju(t))throw Error("React.Children.only expected to receive a single React element child.");return t}},Pu.Component=Gu,Pu.Fragment=ku,Pu.Profiler=Ru,Pu.PureComponent=ju,Pu.StrictMode=Du,Pu.Suspense=Fu,Pu.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=ap,Pu.cloneElement=function(t,e,s){if(null==t)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+t+".");var i=Vu({},t.props),n=t.key,r=t.ref,a=t._owner;if(null!=e){if(void 0!==e.ref&&(r=e.ref,a=Ku.current),void 0!==e.key&&(n=""+e.key),t.type&&t.type.defaultProps)var o=t.type.defaultProps;for(l in e)$u.call(e,l)&&!Yu.hasOwnProperty(l)&&(i[l]=void 0===e[l]&&void 0!==o?o[l]:e[l])}var l=arguments.length-2;if(1===l)i.children=s;else if(1<l){o=Array(l);for(var h=0;h<l;h++)o[h]=arguments[h+2];i.children=o}return{$$typeof:Mu,type:t.type,key:n,ref:r,props:i,_owner:a}},Pu.createContext=function(t){return(t={$$typeof:Iu,_currentValue:t,_currentValue2:t,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:Lu,_context:t},t.Consumer=t},Pu.createElement=Qu,Pu.createFactory=function(t){var e=Qu.bind(null,t);return e.type=t,e},Pu.createRef=function(){return{current:null}},Pu.forwardRef=function(t){return{$$typeof:Ou,render:t}},Pu.isValidElement=Ju,Pu.lazy=function(t){return{$$typeof:zu,_payload:{_status:-1,_result:t},_init:ip}},Pu.memo=function(t,e){return{$$typeof:Bu,type:t,compare:void 0===e?null:e}},Pu.startTransition=function(t){var e=rp.transition;rp.transition={};try{t()}finally{rp.transition=e}},Pu.unstable_act=function(){throw Error("act(...) is not supported in production builds of React.")},Pu.useCallback=function(t,e){return np.current.useCallback(t,e)},Pu.useContext=function(t){return np.current.useContext(t)},Pu.useDebugValue=function(){},Pu.useDeferredValue=function(t){return np.current.useDeferredValue(t)},Pu.useEffect=function(t,e){return np.current.useEffect(t,e)},Pu.useId=function(){return np.current.useId()},Pu.useImperativeHandle=function(t,e,s){return np.current.useImperativeHandle(t,e,s)},Pu.useInsertionEffect=function(t,e){return np.current.useInsertionEffect(t,e)},Pu.useLayoutEffect=function(t,e){return np.current.useLayoutEffect(t,e)},Pu.useMemo=function(t,e){return np.current.useMemo(t,e)},Pu.useReducer=function(t,e,s){return np.current.useReducer(t,e,s)},Pu.useRef=function(t){return np.current.useRef(t)},Pu.useState=function(t){return np.current.useState(t)},Pu.useSyncExternalStore=function(t,e,s){return np.current.useSyncExternalStore(t,e,s)},Pu.useTransition=function(){return np.current.useTransition()},Pu.version="18.2.0",Eu.exports=Pu;var op=Eu.exports,lp=Tu(op),hp={exports:{}},cp={},dp={exports:{}},up={};
/**
 * @license React
 * scheduler.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
!function(t){function e(t,e){var s=t.length;t.push(e);t:for(;0<s;){var i=s-1>>>1,r=t[i];if(!(0<n(r,e)))break t;t[i]=e,t[s]=r,s=i}}function s(t){return 0===t.length?null:t[0]}function i(t){if(0===t.length)return null;var e=t[0],s=t.pop();if(s!==e){t[0]=s;t:for(var i=0,r=t.length,a=r>>>1;i<a;){var o=2*(i+1)-1,l=t[o],h=o+1,c=t[h];if(0>n(l,s))h<r&&0>n(c,l)?(t[i]=c,t[h]=s,i=h):(t[i]=l,t[o]=s,i=o);else{if(!(h<r&&0>n(c,s)))break t;t[i]=c,t[h]=s,i=h}}}return e}function n(t,e){var s=t.sortIndex-e.sortIndex;return 0!==s?s:t.id-e.id}if("object"==typeof performance&&"function"==typeof performance.now){var r=performance;t.unstable_now=function(){return r.now()}}else{var a=Date,o=a.now();t.unstable_now=function(){return a.now()-o}}var l=[],h=[],c=1,d=null,u=3,p=!1,f=!1,m=!1,g="function"==typeof setTimeout?setTimeout:null,_="function"==typeof clearTimeout?clearTimeout:null,v="undefined"!=typeof setImmediate?setImmediate:null;function b(t){for(var n=s(h);null!==n;){if(null===n.callback)i(h);else{if(!(n.startTime<=t))break;i(h),n.sortIndex=n.expirationTime,e(l,n)}n=s(h)}}function y(t){if(m=!1,b(t),!f)if(null!==s(l))f=!0,R(x);else{var e=s(h);null!==e&&L(y,e.startTime-t)}}function x(e,n){f=!1,m&&(m=!1,_(T),T=-1),p=!0;var r=u;try{for(b(n),d=s(l);null!==d&&(!(d.expirationTime>n)||e&&!M());){var a=d.callback;if("function"==typeof a){d.callback=null,u=d.priorityLevel;var o=a(d.expirationTime<=n);n=t.unstable_now(),"function"==typeof o?d.callback=o:d===s(l)&&i(l),b(n)}else i(l);d=s(l)}if(null!==d)var c=!0;else{var g=s(h);null!==g&&L(y,g.startTime-n),c=!1}return c}finally{d=null,u=r,p=!1}}"undefined"!=typeof navigator&&void 0!==navigator.scheduling&&void 0!==navigator.scheduling.isInputPending&&navigator.scheduling.isInputPending.bind(navigator.scheduling);var w,S=!1,C=null,T=-1,E=5,P=-1;function M(){return!(t.unstable_now()-P<E)}function A(){if(null!==C){var e=t.unstable_now();P=e;var s=!0;try{s=C(!0,e)}finally{s?w():(S=!1,C=null)}}else S=!1}if("function"==typeof v)w=function(){v(A)};else if("undefined"!=typeof MessageChannel){var k=new MessageChannel,D=k.port2;k.port1.onmessage=A,w=function(){D.postMessage(null)}}else w=function(){g(A,0)};function R(t){C=t,S||(S=!0,w())}function L(e,s){T=g((function(){e(t.unstable_now())}),s)}t.unstable_IdlePriority=5,t.unstable_ImmediatePriority=1,t.unstable_LowPriority=4,t.unstable_NormalPriority=3,t.unstable_Profiling=null,t.unstable_UserBlockingPriority=2,t.unstable_cancelCallback=function(t){t.callback=null},t.unstable_continueExecution=function(){f||p||(f=!0,R(x))},t.unstable_forceFrameRate=function(t){0>t||125<t?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):E=0<t?Math.floor(1e3/t):5},t.unstable_getCurrentPriorityLevel=function(){return u},t.unstable_getFirstCallbackNode=function(){return s(l)},t.unstable_next=function(t){switch(u){case 1:case 2:case 3:var e=3;break;default:e=u}var s=u;u=e;try{return t()}finally{u=s}},t.unstable_pauseExecution=function(){},t.unstable_requestPaint=function(){},t.unstable_runWithPriority=function(t,e){switch(t){case 1:case 2:case 3:case 4:case 5:break;default:t=3}var s=u;u=t;try{return e()}finally{u=s}},t.unstable_scheduleCallback=function(i,n,r){var a=t.unstable_now();switch("object"==typeof r&&null!==r?r="number"==typeof(r=r.delay)&&0<r?a+r:a:r=a,i){case 1:var o=-1;break;case 2:o=250;break;case 5:o=1073741823;break;case 4:o=1e4;break;default:o=5e3}return i={id:c++,callback:n,priorityLevel:i,startTime:r,expirationTime:o=r+o,sortIndex:-1},r>a?(i.sortIndex=r,e(h,i),null===s(l)&&i===s(h)&&(m?(_(T),T=-1):m=!0,L(y,r-a))):(i.sortIndex=o,e(l,i),f||p||(f=!0,R(x))),i},t.unstable_shouldYield=M,t.unstable_wrapCallback=function(t){var e=u;return function(){var s=u;u=e;try{return t.apply(this,arguments)}finally{u=s}}}}(up),dp.exports=up;var pp=dp.exports,fp=op,mp=pp;
/**
 * @license React
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */function gp(t){for(var e="https://reactjs.org/docs/error-decoder.html?invariant="+t,s=1;s<arguments.length;s++)e+="&args[]="+encodeURIComponent(arguments[s]);return"Minified React error #"+t+"; visit "+e+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var _p=new Set,vp={};function bp(t,e){yp(t,e),yp(t+"Capture",e)}function yp(t,e){for(vp[t]=e,t=0;t<e.length;t++)_p.add(e[t])}var xp=!("undefined"==typeof window||void 0===window.document||void 0===window.document.createElement),wp=Object.prototype.hasOwnProperty,Sp=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,Cp={},Tp={};function Ep(t,e,s,i,n,r,a){this.acceptsBooleans=2===e||3===e||4===e,this.attributeName=i,this.attributeNamespace=n,this.mustUseProperty=s,this.propertyName=t,this.type=e,this.sanitizeURL=r,this.removeEmptyString=a}var Pp={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach((function(t){Pp[t]=new Ep(t,0,!1,t,null,!1,!1)})),[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach((function(t){var e=t[0];Pp[e]=new Ep(e,1,!1,t[1],null,!1,!1)})),["contentEditable","draggable","spellCheck","value"].forEach((function(t){Pp[t]=new Ep(t,2,!1,t.toLowerCase(),null,!1,!1)})),["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach((function(t){Pp[t]=new Ep(t,2,!1,t,null,!1,!1)})),"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach((function(t){Pp[t]=new Ep(t,3,!1,t.toLowerCase(),null,!1,!1)})),["checked","multiple","muted","selected"].forEach((function(t){Pp[t]=new Ep(t,3,!0,t,null,!1,!1)})),["capture","download"].forEach((function(t){Pp[t]=new Ep(t,4,!1,t,null,!1,!1)})),["cols","rows","size","span"].forEach((function(t){Pp[t]=new Ep(t,6,!1,t,null,!1,!1)})),["rowSpan","start"].forEach((function(t){Pp[t]=new Ep(t,5,!1,t.toLowerCase(),null,!1,!1)}));var Mp=/[\-:]([a-z])/g;function Ap(t){return t[1].toUpperCase()}function kp(t,e,s,i){var n=Pp.hasOwnProperty(e)?Pp[e]:null;(null!==n?0!==n.type:i||!(2<e.length)||"o"!==e[0]&&"O"!==e[0]||"n"!==e[1]&&"N"!==e[1])&&(function(t,e,s,i){if(null==e||function(t,e,s,i){if(null!==s&&0===s.type)return!1;switch(typeof e){case"function":case"symbol":return!0;case"boolean":return!i&&(null!==s?!s.acceptsBooleans:"data-"!==(t=t.toLowerCase().slice(0,5))&&"aria-"!==t);default:return!1}}(t,e,s,i))return!0;if(i)return!1;if(null!==s)switch(s.type){case 3:return!e;case 4:return!1===e;case 5:return isNaN(e);case 6:return isNaN(e)||1>e}return!1}(e,s,n,i)&&(s=null),i||null===n?function(t){return!!wp.call(Tp,t)||!wp.call(Cp,t)&&(Sp.test(t)?Tp[t]=!0:(Cp[t]=!0,!1))}(e)&&(null===s?t.removeAttribute(e):t.setAttribute(e,""+s)):n.mustUseProperty?t[n.propertyName]=null===s?3!==n.type&&"":s:(e=n.attributeName,i=n.attributeNamespace,null===s?t.removeAttribute(e):(s=3===(n=n.type)||4===n&&!0===s?"":""+s,i?t.setAttributeNS(i,e,s):t.setAttribute(e,s))))}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach((function(t){var e=t.replace(Mp,Ap);Pp[e]=new Ep(e,1,!1,t,null,!1,!1)})),"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach((function(t){var e=t.replace(Mp,Ap);Pp[e]=new Ep(e,1,!1,t,"http://www.w3.org/1999/xlink",!1,!1)})),["xml:base","xml:lang","xml:space"].forEach((function(t){var e=t.replace(Mp,Ap);Pp[e]=new Ep(e,1,!1,t,"http://www.w3.org/XML/1998/namespace",!1,!1)})),["tabIndex","crossOrigin"].forEach((function(t){Pp[t]=new Ep(t,1,!1,t.toLowerCase(),null,!1,!1)})),Pp.xlinkHref=new Ep("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1),["src","href","action","formAction"].forEach((function(t){Pp[t]=new Ep(t,1,!1,t.toLowerCase(),null,!0,!0)}));var Dp=fp.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,Rp=Symbol.for("react.element"),Lp=Symbol.for("react.portal"),Ip=Symbol.for("react.fragment"),Op=Symbol.for("react.strict_mode"),Fp=Symbol.for("react.profiler"),Bp=Symbol.for("react.provider"),zp=Symbol.for("react.context"),Np=Symbol.for("react.forward_ref"),Up=Symbol.for("react.suspense"),Vp=Symbol.for("react.suspense_list"),Hp=Symbol.for("react.memo"),Gp=Symbol.for("react.lazy"),Wp=Symbol.for("react.offscreen"),jp=Symbol.iterator;function qp(t){return null===t||"object"!=typeof t?null:"function"==typeof(t=jp&&t[jp]||t["@@iterator"])?t:null}var Xp,$p=Object.assign;function Kp(t){if(void 0===Xp)try{throw Error()}catch(t){var e=t.stack.trim().match(/\n( *(at )?)/);Xp=e&&e[1]||""}return"\n"+Xp+t}var Yp=!1;function Qp(t,e){if(!t||Yp)return"";Yp=!0;var s=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(e)if(e=function(){throw Error()},Object.defineProperty(e.prototype,"props",{set:function(){throw Error()}}),"object"==typeof Reflect&&Reflect.construct){try{Reflect.construct(e,[])}catch(t){var i=t}Reflect.construct(t,[],e)}else{try{e.call()}catch(t){i=t}t.call(e.prototype)}else{try{throw Error()}catch(t){i=t}t()}}catch(e){if(e&&i&&"string"==typeof e.stack){for(var n=e.stack.split("\n"),r=i.stack.split("\n"),a=n.length-1,o=r.length-1;1<=a&&0<=o&&n[a]!==r[o];)o--;for(;1<=a&&0<=o;a--,o--)if(n[a]!==r[o]){if(1!==a||1!==o)do{if(a--,0>--o||n[a]!==r[o]){var l="\n"+n[a].replace(" at new "," at ");return t.displayName&&l.includes("<anonymous>")&&(l=l.replace("<anonymous>",t.displayName)),l}}while(1<=a&&0<=o);break}}}finally{Yp=!1,Error.prepareStackTrace=s}return(t=t?t.displayName||t.name:"")?Kp(t):""}function Jp(t){switch(t.tag){case 5:return Kp(t.type);case 16:return Kp("Lazy");case 13:return Kp("Suspense");case 19:return Kp("SuspenseList");case 0:case 2:case 15:return t=Qp(t.type,!1);case 11:return t=Qp(t.type.render,!1);case 1:return t=Qp(t.type,!0);default:return""}}function Zp(t){if(null==t)return null;if("function"==typeof t)return t.displayName||t.name||null;if("string"==typeof t)return t;switch(t){case Ip:return"Fragment";case Lp:return"Portal";case Fp:return"Profiler";case Op:return"StrictMode";case Up:return"Suspense";case Vp:return"SuspenseList"}if("object"==typeof t)switch(t.$$typeof){case zp:return(t.displayName||"Context")+".Consumer";case Bp:return(t._context.displayName||"Context")+".Provider";case Np:var e=t.render;return(t=t.displayName)||(t=""!==(t=e.displayName||e.name||"")?"ForwardRef("+t+")":"ForwardRef"),t;case Hp:return null!==(e=t.displayName||null)?e:Zp(t.type)||"Memo";case Gp:e=t._payload,t=t._init;try{return Zp(t(e))}catch(t){}}return null}function tf(t){var e=t.type;switch(t.tag){case 24:return"Cache";case 9:return(e.displayName||"Context")+".Consumer";case 10:return(e._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return t=(t=e.render).displayName||t.name||"",e.displayName||(""!==t?"ForwardRef("+t+")":"ForwardRef");case 7:return"Fragment";case 5:return e;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return Zp(e);case 8:return e===Op?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if("function"==typeof e)return e.displayName||e.name||null;if("string"==typeof e)return e}return null}function ef(t){switch(typeof t){case"boolean":case"number":case"string":case"undefined":case"object":return t;default:return""}}function sf(t){var e=t.type;return(t=t.nodeName)&&"input"===t.toLowerCase()&&("checkbox"===e||"radio"===e)}function nf(t){t._valueTracker||(t._valueTracker=function(t){var e=sf(t)?"checked":"value",s=Object.getOwnPropertyDescriptor(t.constructor.prototype,e),i=""+t[e];if(!t.hasOwnProperty(e)&&void 0!==s&&"function"==typeof s.get&&"function"==typeof s.set){var n=s.get,r=s.set;return Object.defineProperty(t,e,{configurable:!0,get:function(){return n.call(this)},set:function(t){i=""+t,r.call(this,t)}}),Object.defineProperty(t,e,{enumerable:s.enumerable}),{getValue:function(){return i},setValue:function(t){i=""+t},stopTracking:function(){t._valueTracker=null,delete t[e]}}}}(t))}function rf(t){if(!t)return!1;var e=t._valueTracker;if(!e)return!0;var s=e.getValue(),i="";return t&&(i=sf(t)?t.checked?"true":"false":t.value),(t=i)!==s&&(e.setValue(t),!0)}function af(t){if(void 0===(t=t||("undefined"!=typeof document?document:void 0)))return null;try{return t.activeElement||t.body}catch(e){return t.body}}function of(t,e){var s=e.checked;return $p({},e,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=s?s:t._wrapperState.initialChecked})}function lf(t,e){var s=null==e.defaultValue?"":e.defaultValue,i=null!=e.checked?e.checked:e.defaultChecked;s=ef(null!=e.value?e.value:s),t._wrapperState={initialChecked:i,initialValue:s,controlled:"checkbox"===e.type||"radio"===e.type?null!=e.checked:null!=e.value}}function hf(t,e){null!=(e=e.checked)&&kp(t,"checked",e,!1)}function cf(t,e){hf(t,e);var s=ef(e.value),i=e.type;if(null!=s)"number"===i?(0===s&&""===t.value||t.value!=s)&&(t.value=""+s):t.value!==""+s&&(t.value=""+s);else if("submit"===i||"reset"===i)return void t.removeAttribute("value");e.hasOwnProperty("value")?uf(t,e.type,s):e.hasOwnProperty("defaultValue")&&uf(t,e.type,ef(e.defaultValue)),null==e.checked&&null!=e.defaultChecked&&(t.defaultChecked=!!e.defaultChecked)}function df(t,e,s){if(e.hasOwnProperty("value")||e.hasOwnProperty("defaultValue")){var i=e.type;if(!("submit"!==i&&"reset"!==i||void 0!==e.value&&null!==e.value))return;e=""+t._wrapperState.initialValue,s||e===t.value||(t.value=e),t.defaultValue=e}""!==(s=t.name)&&(t.name=""),t.defaultChecked=!!t._wrapperState.initialChecked,""!==s&&(t.name=s)}function uf(t,e,s){"number"===e&&af(t.ownerDocument)===t||(null==s?t.defaultValue=""+t._wrapperState.initialValue:t.defaultValue!==""+s&&(t.defaultValue=""+s))}var pf=Array.isArray;function ff(t,e,s,i){if(t=t.options,e){e={};for(var n=0;n<s.length;n++)e["$"+s[n]]=!0;for(s=0;s<t.length;s++)n=e.hasOwnProperty("$"+t[s].value),t[s].selected!==n&&(t[s].selected=n),n&&i&&(t[s].defaultSelected=!0)}else{for(s=""+ef(s),e=null,n=0;n<t.length;n++){if(t[n].value===s)return t[n].selected=!0,void(i&&(t[n].defaultSelected=!0));null!==e||t[n].disabled||(e=t[n])}null!==e&&(e.selected=!0)}}function mf(t,e){if(null!=e.dangerouslySetInnerHTML)throw Error(gp(91));return $p({},e,{value:void 0,defaultValue:void 0,children:""+t._wrapperState.initialValue})}function gf(t,e){var s=e.value;if(null==s){if(s=e.children,e=e.defaultValue,null!=s){if(null!=e)throw Error(gp(92));if(pf(s)){if(1<s.length)throw Error(gp(93));s=s[0]}e=s}null==e&&(e=""),s=e}t._wrapperState={initialValue:ef(s)}}function _f(t,e){var s=ef(e.value),i=ef(e.defaultValue);null!=s&&((s=""+s)!==t.value&&(t.value=s),null==e.defaultValue&&t.defaultValue!==s&&(t.defaultValue=s)),null!=i&&(t.defaultValue=""+i)}function vf(t){var e=t.textContent;e===t._wrapperState.initialValue&&""!==e&&null!==e&&(t.value=e)}function bf(t){switch(t){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function yf(t,e){return null==t||"http://www.w3.org/1999/xhtml"===t?bf(e):"http://www.w3.org/2000/svg"===t&&"foreignObject"===e?"http://www.w3.org/1999/xhtml":t}var xf,wf,Sf=(wf=function(t,e){if("http://www.w3.org/2000/svg"!==t.namespaceURI||"innerHTML"in t)t.innerHTML=e;else{for((xf=xf||document.createElement("div")).innerHTML="<svg>"+e.valueOf().toString()+"</svg>",e=xf.firstChild;t.firstChild;)t.removeChild(t.firstChild);for(;e.firstChild;)t.appendChild(e.firstChild)}},"undefined"!=typeof MSApp&&MSApp.execUnsafeLocalFunction?function(t,e,s,i){MSApp.execUnsafeLocalFunction((function(){return wf(t,e)}))}:wf);function Cf(t,e){if(e){var s=t.firstChild;if(s&&s===t.lastChild&&3===s.nodeType)return void(s.nodeValue=e)}t.textContent=e}var Tf={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Ef=["Webkit","ms","Moz","O"];function Pf(t,e,s){return null==e||"boolean"==typeof e||""===e?"":s||"number"!=typeof e||0===e||Tf.hasOwnProperty(t)&&Tf[t]?(""+e).trim():e+"px"}function Mf(t,e){for(var s in t=t.style,e)if(e.hasOwnProperty(s)){var i=0===s.indexOf("--"),n=Pf(s,e[s],i);"float"===s&&(s="cssFloat"),i?t.setProperty(s,n):t[s]=n}}Object.keys(Tf).forEach((function(t){Ef.forEach((function(e){e=e+t.charAt(0).toUpperCase()+t.substring(1),Tf[e]=Tf[t]}))}));var Af=$p({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function kf(t,e){if(e){if(Af[t]&&(null!=e.children||null!=e.dangerouslySetInnerHTML))throw Error(gp(137,t));if(null!=e.dangerouslySetInnerHTML){if(null!=e.children)throw Error(gp(60));if("object"!=typeof e.dangerouslySetInnerHTML||!("__html"in e.dangerouslySetInnerHTML))throw Error(gp(61))}if(null!=e.style&&"object"!=typeof e.style)throw Error(gp(62))}}function Df(t,e){if(-1===t.indexOf("-"))return"string"==typeof e.is;switch(t){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var Rf=null;function Lf(t){return(t=t.target||t.srcElement||window).correspondingUseElement&&(t=t.correspondingUseElement),3===t.nodeType?t.parentNode:t}var If=null,Of=null,Ff=null;function Bf(t){if(t=kv(t)){if("function"!=typeof If)throw Error(gp(280));var e=t.stateNode;e&&(e=Rv(e),If(t.stateNode,t.type,e))}}function zf(t){Of?Ff?Ff.push(t):Ff=[t]:Of=t}function Nf(){if(Of){var t=Of,e=Ff;if(Ff=Of=null,Bf(t),e)for(t=0;t<e.length;t++)Bf(e[t])}}function Uf(t,e){return t(e)}function Vf(){}var Hf=!1;function Gf(t,e,s){if(Hf)return t(e,s);Hf=!0;try{return Uf(t,e,s)}finally{Hf=!1,(null!==Of||null!==Ff)&&(Vf(),Nf())}}function Wf(t,e){var s=t.stateNode;if(null===s)return null;var i=Rv(s);if(null===i)return null;s=i[e];t:switch(e){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(i=!i.disabled)||(i=!("button"===(t=t.type)||"input"===t||"select"===t||"textarea"===t)),t=!i;break t;default:t=!1}if(t)return null;if(s&&"function"!=typeof s)throw Error(gp(231,e,typeof s));return s}var jf=!1;if(xp)try{var qf={};Object.defineProperty(qf,"passive",{get:function(){jf=!0}}),window.addEventListener("test",qf,qf),window.removeEventListener("test",qf,qf)}catch(wf){jf=!1}function Xf(t,e,s,i,n,r,a,o,l){var h=Array.prototype.slice.call(arguments,3);try{e.apply(s,h)}catch(t){this.onError(t)}}var $f=!1,Kf=null,Yf=!1,Qf=null,Jf={onError:function(t){$f=!0,Kf=t}};function Zf(t,e,s,i,n,r,a,o,l){$f=!1,Kf=null,Xf.apply(Jf,arguments)}function tm(t){var e=t,s=t;if(t.alternate)for(;e.return;)e=e.return;else{t=e;do{0!=(4098&(e=t).flags)&&(s=e.return),t=e.return}while(t)}return 3===e.tag?s:null}function em(t){if(13===t.tag){var e=t.memoizedState;if(null===e&&(null!==(t=t.alternate)&&(e=t.memoizedState)),null!==e)return e.dehydrated}return null}function sm(t){if(tm(t)!==t)throw Error(gp(188))}function im(t){return t=function(t){var e=t.alternate;if(!e){if(null===(e=tm(t)))throw Error(gp(188));return e!==t?null:t}for(var s=t,i=e;;){var n=s.return;if(null===n)break;var r=n.alternate;if(null===r){if(null!==(i=n.return)){s=i;continue}break}if(n.child===r.child){for(r=n.child;r;){if(r===s)return sm(n),t;if(r===i)return sm(n),e;r=r.sibling}throw Error(gp(188))}if(s.return!==i.return)s=n,i=r;else{for(var a=!1,o=n.child;o;){if(o===s){a=!0,s=n,i=r;break}if(o===i){a=!0,i=n,s=r;break}o=o.sibling}if(!a){for(o=r.child;o;){if(o===s){a=!0,s=r,i=n;break}if(o===i){a=!0,i=r,s=n;break}o=o.sibling}if(!a)throw Error(gp(189))}}if(s.alternate!==i)throw Error(gp(190))}if(3!==s.tag)throw Error(gp(188));return s.stateNode.current===s?t:e}(t),null!==t?nm(t):null}function nm(t){if(5===t.tag||6===t.tag)return t;for(t=t.child;null!==t;){var e=nm(t);if(null!==e)return e;t=t.sibling}return null}var rm=mp.unstable_scheduleCallback,am=mp.unstable_cancelCallback,om=mp.unstable_shouldYield,lm=mp.unstable_requestPaint,hm=mp.unstable_now,cm=mp.unstable_getCurrentPriorityLevel,dm=mp.unstable_ImmediatePriority,um=mp.unstable_UserBlockingPriority,pm=mp.unstable_NormalPriority,fm=mp.unstable_LowPriority,mm=mp.unstable_IdlePriority,gm=null,_m=null;var vm=Math.clz32?Math.clz32:function(t){return t>>>=0,0===t?32:31-(bm(t)/ym|0)|0},bm=Math.log,ym=Math.LN2;var xm=64,wm=4194304;function Sm(t){switch(t&-t){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return 4194240&t;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return 130023424&t;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return t}}function Cm(t,e){var s=t.pendingLanes;if(0===s)return 0;var i=0,n=t.suspendedLanes,r=t.pingedLanes,a=268435455&s;if(0!==a){var o=a&~n;0!==o?i=Sm(o):0!==(r&=a)&&(i=Sm(r))}else 0!==(a=s&~n)?i=Sm(a):0!==r&&(i=Sm(r));if(0===i)return 0;if(0!==e&&e!==i&&0==(e&n)&&((n=i&-i)>=(r=e&-e)||16===n&&0!=(4194240&r)))return e;if(0!=(4&i)&&(i|=16&s),0!==(e=t.entangledLanes))for(t=t.entanglements,e&=i;0<e;)n=1<<(s=31-vm(e)),i|=t[s],e&=~n;return i}function Tm(t,e){switch(t){case 1:case 2:case 4:return e+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return e+5e3;default:return-1}}function Em(t){return 0!==(t=-1073741825&t.pendingLanes)?t:1073741824&t?1073741824:0}function Pm(){var t=xm;return 0==(4194240&(xm<<=1))&&(xm=64),t}function Mm(t){for(var e=[],s=0;31>s;s++)e.push(t);return e}function Am(t,e,s){t.pendingLanes|=e,536870912!==e&&(t.suspendedLanes=0,t.pingedLanes=0),(t=t.eventTimes)[e=31-vm(e)]=s}function km(t,e){var s=t.entangledLanes|=e;for(t=t.entanglements;s;){var i=31-vm(s),n=1<<i;n&e|t[i]&e&&(t[i]|=e),s&=~n}}var Dm=0;function Rm(t){return 1<(t&=-t)?4<t?0!=(268435455&t)?16:536870912:4:1}var Lm,Im,Om,Fm,Bm,zm=!1,Nm=[],Um=null,Vm=null,Hm=null,Gm=new Map,Wm=new Map,jm=[],qm="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function Xm(t,e){switch(t){case"focusin":case"focusout":Um=null;break;case"dragenter":case"dragleave":Vm=null;break;case"mouseover":case"mouseout":Hm=null;break;case"pointerover":case"pointerout":Gm.delete(e.pointerId);break;case"gotpointercapture":case"lostpointercapture":Wm.delete(e.pointerId)}}function $m(t,e,s,i,n,r){return null===t||t.nativeEvent!==r?(t={blockedOn:e,domEventName:s,eventSystemFlags:i,nativeEvent:r,targetContainers:[n]},null!==e&&(null!==(e=kv(e))&&Im(e)),t):(t.eventSystemFlags|=i,e=t.targetContainers,null!==n&&-1===e.indexOf(n)&&e.push(n),t)}function Km(t){var e=Av(t.target);if(null!==e){var s=tm(e);if(null!==s)if(13===(e=s.tag)){if(null!==(e=em(s)))return t.blockedOn=e,void Bm(t.priority,(function(){Om(s)}))}else if(3===e&&s.stateNode.current.memoizedState.isDehydrated)return void(t.blockedOn=3===s.tag?s.stateNode.containerInfo:null)}t.blockedOn=null}function Ym(t){if(null!==t.blockedOn)return!1;for(var e=t.targetContainers;0<e.length;){var s=og(t.domEventName,t.eventSystemFlags,e[0],t.nativeEvent);if(null!==s)return null!==(e=kv(s))&&Im(e),t.blockedOn=s,!1;var i=new(s=t.nativeEvent).constructor(s.type,s);Rf=i,s.target.dispatchEvent(i),Rf=null,e.shift()}return!0}function Qm(t,e,s){Ym(t)&&s.delete(e)}function Jm(){zm=!1,null!==Um&&Ym(Um)&&(Um=null),null!==Vm&&Ym(Vm)&&(Vm=null),null!==Hm&&Ym(Hm)&&(Hm=null),Gm.forEach(Qm),Wm.forEach(Qm)}function Zm(t,e){t.blockedOn===e&&(t.blockedOn=null,zm||(zm=!0,mp.unstable_scheduleCallback(mp.unstable_NormalPriority,Jm)))}function tg(t){function e(e){return Zm(e,t)}if(0<Nm.length){Zm(Nm[0],t);for(var s=1;s<Nm.length;s++){var i=Nm[s];i.blockedOn===t&&(i.blockedOn=null)}}for(null!==Um&&Zm(Um,t),null!==Vm&&Zm(Vm,t),null!==Hm&&Zm(Hm,t),Gm.forEach(e),Wm.forEach(e),s=0;s<jm.length;s++)(i=jm[s]).blockedOn===t&&(i.blockedOn=null);for(;0<jm.length&&null===(s=jm[0]).blockedOn;)Km(s),null===s.blockedOn&&jm.shift()}var eg=Dp.ReactCurrentBatchConfig,sg=!0;function ig(t,e,s,i){var n=Dm,r=eg.transition;eg.transition=null;try{Dm=1,rg(t,e,s,i)}finally{Dm=n,eg.transition=r}}function ng(t,e,s,i){var n=Dm,r=eg.transition;eg.transition=null;try{Dm=4,rg(t,e,s,i)}finally{Dm=n,eg.transition=r}}function rg(t,e,s,i){if(sg){var n=og(t,e,s,i);if(null===n)ev(t,e,i,ag,s),Xm(t,i);else if(function(t,e,s,i,n){switch(e){case"focusin":return Um=$m(Um,t,e,s,i,n),!0;case"dragenter":return Vm=$m(Vm,t,e,s,i,n),!0;case"mouseover":return Hm=$m(Hm,t,e,s,i,n),!0;case"pointerover":var r=n.pointerId;return Gm.set(r,$m(Gm.get(r)||null,t,e,s,i,n)),!0;case"gotpointercapture":return r=n.pointerId,Wm.set(r,$m(Wm.get(r)||null,t,e,s,i,n)),!0}return!1}(n,t,e,s,i))i.stopPropagation();else if(Xm(t,i),4&e&&-1<qm.indexOf(t)){for(;null!==n;){var r=kv(n);if(null!==r&&Lm(r),null===(r=og(t,e,s,i))&&ev(t,e,i,ag,s),r===n)break;n=r}null!==n&&i.stopPropagation()}else ev(t,e,i,null,s)}}var ag=null;function og(t,e,s,i){if(ag=null,null!==(t=Av(t=Lf(i))))if(null===(e=tm(t)))t=null;else if(13===(s=e.tag)){if(null!==(t=em(e)))return t;t=null}else if(3===s){if(e.stateNode.current.memoizedState.isDehydrated)return 3===e.tag?e.stateNode.containerInfo:null;t=null}else e!==t&&(t=null);return ag=t,null}function lg(t){switch(t){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(cm()){case dm:return 1;case um:return 4;case pm:case fm:return 16;case mm:return 536870912;default:return 16}default:return 16}}var hg=null,cg=null,dg=null;function ug(){if(dg)return dg;var t,e,s=cg,i=s.length,n="value"in hg?hg.value:hg.textContent,r=n.length;for(t=0;t<i&&s[t]===n[t];t++);var a=i-t;for(e=1;e<=a&&s[i-e]===n[r-e];e++);return dg=n.slice(t,1<e?1-e:void 0)}function pg(t){var e=t.keyCode;return"charCode"in t?0===(t=t.charCode)&&13===e&&(t=13):t=e,10===t&&(t=13),32<=t||13===t?t:0}function fg(){return!0}function mg(){return!1}function gg(t){function e(e,s,i,n,r){for(var a in this._reactName=e,this._targetInst=i,this.type=s,this.nativeEvent=n,this.target=r,this.currentTarget=null,t)t.hasOwnProperty(a)&&(e=t[a],this[a]=e?e(n):n[a]);return this.isDefaultPrevented=(null!=n.defaultPrevented?n.defaultPrevented:!1===n.returnValue)?fg:mg,this.isPropagationStopped=mg,this}return $p(e.prototype,{preventDefault:function(){this.defaultPrevented=!0;var t=this.nativeEvent;t&&(t.preventDefault?t.preventDefault():"unknown"!=typeof t.returnValue&&(t.returnValue=!1),this.isDefaultPrevented=fg)},stopPropagation:function(){var t=this.nativeEvent;t&&(t.stopPropagation?t.stopPropagation():"unknown"!=typeof t.cancelBubble&&(t.cancelBubble=!0),this.isPropagationStopped=fg)},persist:function(){},isPersistent:fg}),e}var _g,vg,bg,yg={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(t){return t.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},xg=gg(yg),wg=$p({},yg,{view:0,detail:0}),Sg=gg(wg),Cg=$p({},wg,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:Fg,button:0,buttons:0,relatedTarget:function(t){return void 0===t.relatedTarget?t.fromElement===t.srcElement?t.toElement:t.fromElement:t.relatedTarget},movementX:function(t){return"movementX"in t?t.movementX:(t!==bg&&(bg&&"mousemove"===t.type?(_g=t.screenX-bg.screenX,vg=t.screenY-bg.screenY):vg=_g=0,bg=t),_g)},movementY:function(t){return"movementY"in t?t.movementY:vg}}),Tg=gg(Cg),Eg=gg($p({},Cg,{dataTransfer:0})),Pg=gg($p({},wg,{relatedTarget:0})),Mg=gg($p({},yg,{animationName:0,elapsedTime:0,pseudoElement:0})),Ag=$p({},yg,{clipboardData:function(t){return"clipboardData"in t?t.clipboardData:window.clipboardData}}),kg=gg(Ag),Dg=gg($p({},yg,{data:0})),Rg={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},Lg={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},Ig={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function Og(t){var e=this.nativeEvent;return e.getModifierState?e.getModifierState(t):!!(t=Ig[t])&&!!e[t]}function Fg(){return Og}var Bg=$p({},wg,{key:function(t){if(t.key){var e=Rg[t.key]||t.key;if("Unidentified"!==e)return e}return"keypress"===t.type?13===(t=pg(t))?"Enter":String.fromCharCode(t):"keydown"===t.type||"keyup"===t.type?Lg[t.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:Fg,charCode:function(t){return"keypress"===t.type?pg(t):0},keyCode:function(t){return"keydown"===t.type||"keyup"===t.type?t.keyCode:0},which:function(t){return"keypress"===t.type?pg(t):"keydown"===t.type||"keyup"===t.type?t.keyCode:0}}),zg=gg(Bg),Ng=gg($p({},Cg,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0})),Ug=gg($p({},wg,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:Fg})),Vg=gg($p({},yg,{propertyName:0,elapsedTime:0,pseudoElement:0})),Hg=$p({},Cg,{deltaX:function(t){return"deltaX"in t?t.deltaX:"wheelDeltaX"in t?-t.wheelDeltaX:0},deltaY:function(t){return"deltaY"in t?t.deltaY:"wheelDeltaY"in t?-t.wheelDeltaY:"wheelDelta"in t?-t.wheelDelta:0},deltaZ:0,deltaMode:0}),Gg=gg(Hg),Wg=[9,13,27,32],jg=xp&&"CompositionEvent"in window,qg=null;xp&&"documentMode"in document&&(qg=document.documentMode);var Xg=xp&&"TextEvent"in window&&!qg,$g=xp&&(!jg||qg&&8<qg&&11>=qg),Kg=String.fromCharCode(32),Yg=!1;function Qg(t,e){switch(t){case"keyup":return-1!==Wg.indexOf(e.keyCode);case"keydown":return 229!==e.keyCode;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function Jg(t){return"object"==typeof(t=t.detail)&&"data"in t?t.data:null}var Zg=!1;var t_={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function e_(t){var e=t&&t.nodeName&&t.nodeName.toLowerCase();return"input"===e?!!t_[t.type]:"textarea"===e}function s_(t,e,s,i){zf(i),0<(e=iv(e,"onChange")).length&&(s=new xg("onChange","change",null,s,i),t.push({event:s,listeners:e}))}var i_=null,n_=null;function r_(t){K_(t,0)}function a_(t){if(rf(Dv(t)))return t}function o_(t,e){if("change"===t)return e}var l_=!1;if(xp){var h_;if(xp){var c_="oninput"in document;if(!c_){var d_=document.createElement("div");d_.setAttribute("oninput","return;"),c_="function"==typeof d_.oninput}h_=c_}else h_=!1;l_=h_&&(!document.documentMode||9<document.documentMode)}function u_(){i_&&(i_.detachEvent("onpropertychange",p_),n_=i_=null)}function p_(t){if("value"===t.propertyName&&a_(n_)){var e=[];s_(e,n_,t,Lf(t)),Gf(r_,e)}}function f_(t,e,s){"focusin"===t?(u_(),n_=s,(i_=e).attachEvent("onpropertychange",p_)):"focusout"===t&&u_()}function m_(t){if("selectionchange"===t||"keyup"===t||"keydown"===t)return a_(n_)}function g_(t,e){if("click"===t)return a_(e)}function __(t,e){if("input"===t||"change"===t)return a_(e)}var v_="function"==typeof Object.is?Object.is:function(t,e){return t===e&&(0!==t||1/t==1/e)||t!=t&&e!=e};function b_(t,e){if(v_(t,e))return!0;if("object"!=typeof t||null===t||"object"!=typeof e||null===e)return!1;var s=Object.keys(t),i=Object.keys(e);if(s.length!==i.length)return!1;for(i=0;i<s.length;i++){var n=s[i];if(!wp.call(e,n)||!v_(t[n],e[n]))return!1}return!0}function y_(t){for(;t&&t.firstChild;)t=t.firstChild;return t}function x_(t,e){var s,i=y_(t);for(t=0;i;){if(3===i.nodeType){if(s=t+i.textContent.length,t<=e&&s>=e)return{node:i,offset:e-t};t=s}t:{for(;i;){if(i.nextSibling){i=i.nextSibling;break t}i=i.parentNode}i=void 0}i=y_(i)}}function w_(t,e){return!(!t||!e)&&(t===e||(!t||3!==t.nodeType)&&(e&&3===e.nodeType?w_(t,e.parentNode):"contains"in t?t.contains(e):!!t.compareDocumentPosition&&!!(16&t.compareDocumentPosition(e))))}function S_(){for(var t=window,e=af();e instanceof t.HTMLIFrameElement;){try{var s="string"==typeof e.contentWindow.location.href}catch(t){s=!1}if(!s)break;e=af((t=e.contentWindow).document)}return e}function C_(t){var e=t&&t.nodeName&&t.nodeName.toLowerCase();return e&&("input"===e&&("text"===t.type||"search"===t.type||"tel"===t.type||"url"===t.type||"password"===t.type)||"textarea"===e||"true"===t.contentEditable)}function T_(t){var e=S_(),s=t.focusedElem,i=t.selectionRange;if(e!==s&&s&&s.ownerDocument&&w_(s.ownerDocument.documentElement,s)){if(null!==i&&C_(s))if(e=i.start,void 0===(t=i.end)&&(t=e),"selectionStart"in s)s.selectionStart=e,s.selectionEnd=Math.min(t,s.value.length);else if((t=(e=s.ownerDocument||document)&&e.defaultView||window).getSelection){t=t.getSelection();var n=s.textContent.length,r=Math.min(i.start,n);i=void 0===i.end?r:Math.min(i.end,n),!t.extend&&r>i&&(n=i,i=r,r=n),n=x_(s,r);var a=x_(s,i);n&&a&&(1!==t.rangeCount||t.anchorNode!==n.node||t.anchorOffset!==n.offset||t.focusNode!==a.node||t.focusOffset!==a.offset)&&((e=e.createRange()).setStart(n.node,n.offset),t.removeAllRanges(),r>i?(t.addRange(e),t.extend(a.node,a.offset)):(e.setEnd(a.node,a.offset),t.addRange(e)))}for(e=[],t=s;t=t.parentNode;)1===t.nodeType&&e.push({element:t,left:t.scrollLeft,top:t.scrollTop});for("function"==typeof s.focus&&s.focus(),s=0;s<e.length;s++)(t=e[s]).element.scrollLeft=t.left,t.element.scrollTop=t.top}}var E_=xp&&"documentMode"in document&&11>=document.documentMode,P_=null,M_=null,A_=null,k_=!1;function D_(t,e,s){var i=s.window===s?s.document:9===s.nodeType?s:s.ownerDocument;k_||null==P_||P_!==af(i)||("selectionStart"in(i=P_)&&C_(i)?i={start:i.selectionStart,end:i.selectionEnd}:i={anchorNode:(i=(i.ownerDocument&&i.ownerDocument.defaultView||window).getSelection()).anchorNode,anchorOffset:i.anchorOffset,focusNode:i.focusNode,focusOffset:i.focusOffset},A_&&b_(A_,i)||(A_=i,0<(i=iv(M_,"onSelect")).length&&(e=new xg("onSelect","select",null,e,s),t.push({event:e,listeners:i}),e.target=P_)))}function R_(t,e){var s={};return s[t.toLowerCase()]=e.toLowerCase(),s["Webkit"+t]="webkit"+e,s["Moz"+t]="moz"+e,s}var L_={animationend:R_("Animation","AnimationEnd"),animationiteration:R_("Animation","AnimationIteration"),animationstart:R_("Animation","AnimationStart"),transitionend:R_("Transition","TransitionEnd")},I_={},O_={};function F_(t){if(I_[t])return I_[t];if(!L_[t])return t;var e,s=L_[t];for(e in s)if(s.hasOwnProperty(e)&&e in O_)return I_[t]=s[e];return t}xp&&(O_=document.createElement("div").style,"AnimationEvent"in window||(delete L_.animationend.animation,delete L_.animationiteration.animation,delete L_.animationstart.animation),"TransitionEvent"in window||delete L_.transitionend.transition);var B_=F_("animationend"),z_=F_("animationiteration"),N_=F_("animationstart"),U_=F_("transitionend"),V_=new Map,H_="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function G_(t,e){V_.set(t,e),bp(e,[t])}for(var W_=0;W_<H_.length;W_++){var j_=H_[W_];G_(j_.toLowerCase(),"on"+(j_[0].toUpperCase()+j_.slice(1)))}G_(B_,"onAnimationEnd"),G_(z_,"onAnimationIteration"),G_(N_,"onAnimationStart"),G_("dblclick","onDoubleClick"),G_("focusin","onFocus"),G_("focusout","onBlur"),G_(U_,"onTransitionEnd"),yp("onMouseEnter",["mouseout","mouseover"]),yp("onMouseLeave",["mouseout","mouseover"]),yp("onPointerEnter",["pointerout","pointerover"]),yp("onPointerLeave",["pointerout","pointerover"]),bp("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),bp("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),bp("onBeforeInput",["compositionend","keypress","textInput","paste"]),bp("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),bp("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),bp("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var q_="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),X_=new Set("cancel close invalid load scroll toggle".split(" ").concat(q_));function $_(t,e,s){var i=t.type||"unknown-event";t.currentTarget=s,function(t,e,s,i,n,r,a,o,l){if(Zf.apply(this,arguments),$f){if(!$f)throw Error(gp(198));var h=Kf;$f=!1,Kf=null,Yf||(Yf=!0,Qf=h)}}(i,e,void 0,t),t.currentTarget=null}function K_(t,e){e=0!=(4&e);for(var s=0;s<t.length;s++){var i=t[s],n=i.event;i=i.listeners;t:{var r=void 0;if(e)for(var a=i.length-1;0<=a;a--){var o=i[a],l=o.instance,h=o.currentTarget;if(o=o.listener,l!==r&&n.isPropagationStopped())break t;$_(n,o,h),r=l}else for(a=0;a<i.length;a++){if(l=(o=i[a]).instance,h=o.currentTarget,o=o.listener,l!==r&&n.isPropagationStopped())break t;$_(n,o,h),r=l}}}if(Yf)throw t=Qf,Yf=!1,Qf=null,t}function Y_(t,e){var s=e[Ev];void 0===s&&(s=e[Ev]=new Set);var i=t+"__bubble";s.has(i)||(tv(e,t,2,!1),s.add(i))}function Q_(t,e,s){var i=0;e&&(i|=4),tv(s,t,i,e)}var J_="_reactListening"+Math.random().toString(36).slice(2);function Z_(t){if(!t[J_]){t[J_]=!0,_p.forEach((function(e){"selectionchange"!==e&&(X_.has(e)||Q_(e,!1,t),Q_(e,!0,t))}));var e=9===t.nodeType?t:t.ownerDocument;null===e||e[J_]||(e[J_]=!0,Q_("selectionchange",!1,e))}}function tv(t,e,s,i){switch(lg(e)){case 1:var n=ig;break;case 4:n=ng;break;default:n=rg}s=n.bind(null,e,s,t),n=void 0,!jf||"touchstart"!==e&&"touchmove"!==e&&"wheel"!==e||(n=!0),i?void 0!==n?t.addEventListener(e,s,{capture:!0,passive:n}):t.addEventListener(e,s,!0):void 0!==n?t.addEventListener(e,s,{passive:n}):t.addEventListener(e,s,!1)}function ev(t,e,s,i,n){var r=i;if(0==(1&e)&&0==(2&e)&&null!==i)t:for(;;){if(null===i)return;var a=i.tag;if(3===a||4===a){var o=i.stateNode.containerInfo;if(o===n||8===o.nodeType&&o.parentNode===n)break;if(4===a)for(a=i.return;null!==a;){var l=a.tag;if((3===l||4===l)&&((l=a.stateNode.containerInfo)===n||8===l.nodeType&&l.parentNode===n))return;a=a.return}for(;null!==o;){if(null===(a=Av(o)))return;if(5===(l=a.tag)||6===l){i=r=a;continue t}o=o.parentNode}}i=i.return}Gf((function(){var i=r,n=Lf(s),a=[];t:{var o=V_.get(t);if(void 0!==o){var l=xg,h=t;switch(t){case"keypress":if(0===pg(s))break t;case"keydown":case"keyup":l=zg;break;case"focusin":h="focus",l=Pg;break;case"focusout":h="blur",l=Pg;break;case"beforeblur":case"afterblur":l=Pg;break;case"click":if(2===s.button)break t;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":l=Tg;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":l=Eg;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":l=Ug;break;case B_:case z_:case N_:l=Mg;break;case U_:l=Vg;break;case"scroll":l=Sg;break;case"wheel":l=Gg;break;case"copy":case"cut":case"paste":l=kg;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":l=Ng}var c=0!=(4&e),d=!c&&"scroll"===t,u=c?null!==o?o+"Capture":null:o;c=[];for(var p,f=i;null!==f;){var m=(p=f).stateNode;if(5===p.tag&&null!==m&&(p=m,null!==u&&(null!=(m=Wf(f,u))&&c.push(sv(f,m,p)))),d)break;f=f.return}0<c.length&&(o=new l(o,h,null,s,n),a.push({event:o,listeners:c}))}}if(0==(7&e)){if(l="mouseout"===t||"pointerout"===t,(!(o="mouseover"===t||"pointerover"===t)||s===Rf||!(h=s.relatedTarget||s.fromElement)||!Av(h)&&!h[Tv])&&(l||o)&&(o=n.window===n?n:(o=n.ownerDocument)?o.defaultView||o.parentWindow:window,l?(l=i,null!==(h=(h=s.relatedTarget||s.toElement)?Av(h):null)&&(h!==(d=tm(h))||5!==h.tag&&6!==h.tag)&&(h=null)):(l=null,h=i),l!==h)){if(c=Tg,m="onMouseLeave",u="onMouseEnter",f="mouse","pointerout"!==t&&"pointerover"!==t||(c=Ng,m="onPointerLeave",u="onPointerEnter",f="pointer"),d=null==l?o:Dv(l),p=null==h?o:Dv(h),(o=new c(m,f+"leave",l,s,n)).target=d,o.relatedTarget=p,m=null,Av(n)===i&&((c=new c(u,f+"enter",h,s,n)).target=p,c.relatedTarget=d,m=c),d=m,l&&h)t:{for(u=h,f=0,p=c=l;p;p=nv(p))f++;for(p=0,m=u;m;m=nv(m))p++;for(;0<f-p;)c=nv(c),f--;for(;0<p-f;)u=nv(u),p--;for(;f--;){if(c===u||null!==u&&c===u.alternate)break t;c=nv(c),u=nv(u)}c=null}else c=null;null!==l&&rv(a,o,l,c,!1),null!==h&&null!==d&&rv(a,d,h,c,!0)}if("select"===(l=(o=i?Dv(i):window).nodeName&&o.nodeName.toLowerCase())||"input"===l&&"file"===o.type)var g=o_;else if(e_(o))if(l_)g=__;else{g=m_;var _=f_}else(l=o.nodeName)&&"input"===l.toLowerCase()&&("checkbox"===o.type||"radio"===o.type)&&(g=g_);switch(g&&(g=g(t,i))?s_(a,g,s,n):(_&&_(t,o,i),"focusout"===t&&(_=o._wrapperState)&&_.controlled&&"number"===o.type&&uf(o,"number",o.value)),_=i?Dv(i):window,t){case"focusin":(e_(_)||"true"===_.contentEditable)&&(P_=_,M_=i,A_=null);break;case"focusout":A_=M_=P_=null;break;case"mousedown":k_=!0;break;case"contextmenu":case"mouseup":case"dragend":k_=!1,D_(a,s,n);break;case"selectionchange":if(E_)break;case"keydown":case"keyup":D_(a,s,n)}var v;if(jg)t:{switch(t){case"compositionstart":var b="onCompositionStart";break t;case"compositionend":b="onCompositionEnd";break t;case"compositionupdate":b="onCompositionUpdate";break t}b=void 0}else Zg?Qg(t,s)&&(b="onCompositionEnd"):"keydown"===t&&229===s.keyCode&&(b="onCompositionStart");b&&($g&&"ko"!==s.locale&&(Zg||"onCompositionStart"!==b?"onCompositionEnd"===b&&Zg&&(v=ug()):(cg="value"in(hg=n)?hg.value:hg.textContent,Zg=!0)),0<(_=iv(i,b)).length&&(b=new Dg(b,t,null,s,n),a.push({event:b,listeners:_}),v?b.data=v:null!==(v=Jg(s))&&(b.data=v))),(v=Xg?function(t,e){switch(t){case"compositionend":return Jg(e);case"keypress":return 32!==e.which?null:(Yg=!0,Kg);case"textInput":return(t=e.data)===Kg&&Yg?null:t;default:return null}}(t,s):function(t,e){if(Zg)return"compositionend"===t||!jg&&Qg(t,e)?(t=ug(),dg=cg=hg=null,Zg=!1,t):null;switch(t){case"paste":default:return null;case"keypress":if(!(e.ctrlKey||e.altKey||e.metaKey)||e.ctrlKey&&e.altKey){if(e.char&&1<e.char.length)return e.char;if(e.which)return String.fromCharCode(e.which)}return null;case"compositionend":return $g&&"ko"!==e.locale?null:e.data}}(t,s))&&(0<(i=iv(i,"onBeforeInput")).length&&(n=new Dg("onBeforeInput","beforeinput",null,s,n),a.push({event:n,listeners:i}),n.data=v))}K_(a,e)}))}function sv(t,e,s){return{instance:t,listener:e,currentTarget:s}}function iv(t,e){for(var s=e+"Capture",i=[];null!==t;){var n=t,r=n.stateNode;5===n.tag&&null!==r&&(n=r,null!=(r=Wf(t,s))&&i.unshift(sv(t,r,n)),null!=(r=Wf(t,e))&&i.push(sv(t,r,n))),t=t.return}return i}function nv(t){if(null===t)return null;do{t=t.return}while(t&&5!==t.tag);return t||null}function rv(t,e,s,i,n){for(var r=e._reactName,a=[];null!==s&&s!==i;){var o=s,l=o.alternate,h=o.stateNode;if(null!==l&&l===i)break;5===o.tag&&null!==h&&(o=h,n?null!=(l=Wf(s,r))&&a.unshift(sv(s,l,o)):n||null!=(l=Wf(s,r))&&a.push(sv(s,l,o))),s=s.return}0!==a.length&&t.push({event:e,listeners:a})}var av=/\r\n?/g,ov=/\u0000|\uFFFD/g;function lv(t){return("string"==typeof t?t:""+t).replace(av,"\n").replace(ov,"")}function hv(t,e,s){if(e=lv(e),lv(t)!==e&&s)throw Error(gp(425))}function cv(){}var dv=null,uv=null;function pv(t,e){return"textarea"===t||"noscript"===t||"string"==typeof e.children||"number"==typeof e.children||"object"==typeof e.dangerouslySetInnerHTML&&null!==e.dangerouslySetInnerHTML&&null!=e.dangerouslySetInnerHTML.__html}var fv="function"==typeof setTimeout?setTimeout:void 0,mv="function"==typeof clearTimeout?clearTimeout:void 0,gv="function"==typeof Promise?Promise:void 0,_v="function"==typeof queueMicrotask?queueMicrotask:void 0!==gv?function(t){return gv.resolve(null).then(t).catch(vv)}:fv;function vv(t){setTimeout((function(){throw t}))}function bv(t,e){var s=e,i=0;do{var n=s.nextSibling;if(t.removeChild(s),n&&8===n.nodeType)if("/$"===(s=n.data)){if(0===i)return t.removeChild(n),void tg(e);i--}else"$"!==s&&"$?"!==s&&"$!"!==s||i++;s=n}while(s);tg(e)}function yv(t){for(;null!=t;t=t.nextSibling){var e=t.nodeType;if(1===e||3===e)break;if(8===e){if("$"===(e=t.data)||"$!"===e||"$?"===e)break;if("/$"===e)return null}}return t}function xv(t){t=t.previousSibling;for(var e=0;t;){if(8===t.nodeType){var s=t.data;if("$"===s||"$!"===s||"$?"===s){if(0===e)return t;e--}else"/$"===s&&e++}t=t.previousSibling}return null}var wv=Math.random().toString(36).slice(2),Sv="__reactFiber$"+wv,Cv="__reactProps$"+wv,Tv="__reactContainer$"+wv,Ev="__reactEvents$"+wv,Pv="__reactListeners$"+wv,Mv="__reactHandles$"+wv;function Av(t){var e=t[Sv];if(e)return e;for(var s=t.parentNode;s;){if(e=s[Tv]||s[Sv]){if(s=e.alternate,null!==e.child||null!==s&&null!==s.child)for(t=xv(t);null!==t;){if(s=t[Sv])return s;t=xv(t)}return e}s=(t=s).parentNode}return null}function kv(t){return!(t=t[Sv]||t[Tv])||5!==t.tag&&6!==t.tag&&13!==t.tag&&3!==t.tag?null:t}function Dv(t){if(5===t.tag||6===t.tag)return t.stateNode;throw Error(gp(33))}function Rv(t){return t[Cv]||null}var Lv=[],Iv=-1;function Ov(t){return{current:t}}function Fv(t){0>Iv||(t.current=Lv[Iv],Lv[Iv]=null,Iv--)}function Bv(t,e){Iv++,Lv[Iv]=t.current,t.current=e}var zv={},Nv=Ov(zv),Uv=Ov(!1),Vv=zv;function Hv(t,e){var s=t.type.contextTypes;if(!s)return zv;var i=t.stateNode;if(i&&i.__reactInternalMemoizedUnmaskedChildContext===e)return i.__reactInternalMemoizedMaskedChildContext;var n,r={};for(n in s)r[n]=e[n];return i&&((t=t.stateNode).__reactInternalMemoizedUnmaskedChildContext=e,t.__reactInternalMemoizedMaskedChildContext=r),r}function Gv(t){return null!=(t=t.childContextTypes)}function Wv(){Fv(Uv),Fv(Nv)}function jv(t,e,s){if(Nv.current!==zv)throw Error(gp(168));Bv(Nv,e),Bv(Uv,s)}function qv(t,e,s){var i=t.stateNode;if(e=e.childContextTypes,"function"!=typeof i.getChildContext)return s;for(var n in i=i.getChildContext())if(!(n in e))throw Error(gp(108,tf(t)||"Unknown",n));return $p({},s,i)}function Xv(t){return t=(t=t.stateNode)&&t.__reactInternalMemoizedMergedChildContext||zv,Vv=Nv.current,Bv(Nv,t),Bv(Uv,Uv.current),!0}function $v(t,e,s){var i=t.stateNode;if(!i)throw Error(gp(169));s?(t=qv(t,e,Vv),i.__reactInternalMemoizedMergedChildContext=t,Fv(Uv),Fv(Nv),Bv(Nv,t)):Fv(Uv),Bv(Uv,s)}var Kv=null,Yv=!1,Qv=!1;function Jv(t){null===Kv?Kv=[t]:Kv.push(t)}function Zv(){if(!Qv&&null!==Kv){Qv=!0;var t=0,e=Dm;try{var s=Kv;for(Dm=1;t<s.length;t++){var i=s[t];do{i=i(!0)}while(null!==i)}Kv=null,Yv=!1}catch(e){throw null!==Kv&&(Kv=Kv.slice(t+1)),rm(dm,Zv),e}finally{Dm=e,Qv=!1}}return null}var tb=[],eb=0,sb=null,ib=0,nb=[],rb=0,ab=null,ob=1,lb="";function hb(t,e){tb[eb++]=ib,tb[eb++]=sb,sb=t,ib=e}function cb(t,e,s){nb[rb++]=ob,nb[rb++]=lb,nb[rb++]=ab,ab=t;var i=ob;t=lb;var n=32-vm(i)-1;i&=~(1<<n),s+=1;var r=32-vm(e)+n;if(30<r){var a=n-n%5;r=(i&(1<<a)-1).toString(32),i>>=a,n-=a,ob=1<<32-vm(e)+n|s<<n|i,lb=r+t}else ob=1<<r|s<<n|i,lb=t}function db(t){null!==t.return&&(hb(t,1),cb(t,1,0))}function ub(t){for(;t===sb;)sb=tb[--eb],tb[eb]=null,ib=tb[--eb],tb[eb]=null;for(;t===ab;)ab=nb[--rb],nb[rb]=null,lb=nb[--rb],nb[rb]=null,ob=nb[--rb],nb[rb]=null}var pb=null,fb=null,mb=!1,gb=null;function _b(t,e){var s=HS(5,null,null,0);s.elementType="DELETED",s.stateNode=e,s.return=t,null===(e=t.deletions)?(t.deletions=[s],t.flags|=16):e.push(s)}function vb(t,e){switch(t.tag){case 5:var s=t.type;return null!==(e=1!==e.nodeType||s.toLowerCase()!==e.nodeName.toLowerCase()?null:e)&&(t.stateNode=e,pb=t,fb=yv(e.firstChild),!0);case 6:return null!==(e=""===t.pendingProps||3!==e.nodeType?null:e)&&(t.stateNode=e,pb=t,fb=null,!0);case 13:return null!==(e=8!==e.nodeType?null:e)&&(s=null!==ab?{id:ob,overflow:lb}:null,t.memoizedState={dehydrated:e,treeContext:s,retryLane:1073741824},(s=HS(18,null,null,0)).stateNode=e,s.return=t,t.child=s,pb=t,fb=null,!0);default:return!1}}function bb(t){return 0!=(1&t.mode)&&0==(128&t.flags)}function yb(t){if(mb){var e=fb;if(e){var s=e;if(!vb(t,e)){if(bb(t))throw Error(gp(418));e=yv(s.nextSibling);var i=pb;e&&vb(t,e)?_b(i,s):(t.flags=-4097&t.flags|2,mb=!1,pb=t)}}else{if(bb(t))throw Error(gp(418));t.flags=-4097&t.flags|2,mb=!1,pb=t}}}function xb(t){for(t=t.return;null!==t&&5!==t.tag&&3!==t.tag&&13!==t.tag;)t=t.return;pb=t}function wb(t){if(t!==pb)return!1;if(!mb)return xb(t),mb=!0,!1;var e;if((e=3!==t.tag)&&!(e=5!==t.tag)&&(e="head"!==(e=t.type)&&"body"!==e&&!pv(t.type,t.memoizedProps)),e&&(e=fb)){if(bb(t))throw Sb(),Error(gp(418));for(;e;)_b(t,e),e=yv(e.nextSibling)}if(xb(t),13===t.tag){if(!(t=null!==(t=t.memoizedState)?t.dehydrated:null))throw Error(gp(317));t:{for(t=t.nextSibling,e=0;t;){if(8===t.nodeType){var s=t.data;if("/$"===s){if(0===e){fb=yv(t.nextSibling);break t}e--}else"$"!==s&&"$!"!==s&&"$?"!==s||e++}t=t.nextSibling}fb=null}}else fb=pb?yv(t.stateNode.nextSibling):null;return!0}function Sb(){for(var t=fb;t;)t=yv(t.nextSibling)}function Cb(){fb=pb=null,mb=!1}function Tb(t){null===gb?gb=[t]:gb.push(t)}var Eb=Dp.ReactCurrentBatchConfig;function Pb(t,e){if(t&&t.defaultProps){for(var s in e=$p({},e),t=t.defaultProps)void 0===e[s]&&(e[s]=t[s]);return e}return e}var Mb=Ov(null),Ab=null,kb=null,Db=null;function Rb(){Db=kb=Ab=null}function Lb(t){var e=Mb.current;Fv(Mb),t._currentValue=e}function Ib(t,e,s){for(;null!==t;){var i=t.alternate;if((t.childLanes&e)!==e?(t.childLanes|=e,null!==i&&(i.childLanes|=e)):null!==i&&(i.childLanes&e)!==e&&(i.childLanes|=e),t===s)break;t=t.return}}function Ob(t,e){Ab=t,Db=kb=null,null!==(t=t.dependencies)&&null!==t.firstContext&&(0!=(t.lanes&e)&&(kx=!0),t.firstContext=null)}function Fb(t){var e=t._currentValue;if(Db!==t)if(t={context:t,memoizedValue:e,next:null},null===kb){if(null===Ab)throw Error(gp(308));kb=t,Ab.dependencies={lanes:0,firstContext:t}}else kb=kb.next=t;return e}var Bb=null;function zb(t){null===Bb?Bb=[t]:Bb.push(t)}function Nb(t,e,s,i){var n=e.interleaved;return null===n?(s.next=s,zb(e)):(s.next=n.next,n.next=s),e.interleaved=s,Ub(t,i)}function Ub(t,e){t.lanes|=e;var s=t.alternate;for(null!==s&&(s.lanes|=e),s=t,t=t.return;null!==t;)t.childLanes|=e,null!==(s=t.alternate)&&(s.childLanes|=e),s=t,t=t.return;return 3===s.tag?s.stateNode:null}var Vb=!1;function Hb(t){t.updateQueue={baseState:t.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function Gb(t,e){t=t.updateQueue,e.updateQueue===t&&(e.updateQueue={baseState:t.baseState,firstBaseUpdate:t.firstBaseUpdate,lastBaseUpdate:t.lastBaseUpdate,shared:t.shared,effects:t.effects})}function Wb(t,e){return{eventTime:t,lane:e,tag:0,payload:null,callback:null,next:null}}function jb(t,e,s){var i=t.updateQueue;if(null===i)return null;if(i=i.shared,0!=(2&Nw)){var n=i.pending;return null===n?e.next=e:(e.next=n.next,n.next=e),i.pending=e,Ub(t,s)}return null===(n=i.interleaved)?(e.next=e,zb(i)):(e.next=n.next,n.next=e),i.interleaved=e,Ub(t,s)}function qb(t,e,s){if(null!==(e=e.updateQueue)&&(e=e.shared,0!=(4194240&s))){var i=e.lanes;s|=i&=t.pendingLanes,e.lanes=s,km(t,s)}}function Xb(t,e){var s=t.updateQueue,i=t.alternate;if(null!==i&&s===(i=i.updateQueue)){var n=null,r=null;if(null!==(s=s.firstBaseUpdate)){do{var a={eventTime:s.eventTime,lane:s.lane,tag:s.tag,payload:s.payload,callback:s.callback,next:null};null===r?n=r=a:r=r.next=a,s=s.next}while(null!==s);null===r?n=r=e:r=r.next=e}else n=r=e;return s={baseState:i.baseState,firstBaseUpdate:n,lastBaseUpdate:r,shared:i.shared,effects:i.effects},void(t.updateQueue=s)}null===(t=s.lastBaseUpdate)?s.firstBaseUpdate=e:t.next=e,s.lastBaseUpdate=e}function $b(t,e,s,i){var n=t.updateQueue;Vb=!1;var r=n.firstBaseUpdate,a=n.lastBaseUpdate,o=n.shared.pending;if(null!==o){n.shared.pending=null;var l=o,h=l.next;l.next=null,null===a?r=h:a.next=h,a=l;var c=t.alternate;null!==c&&((o=(c=c.updateQueue).lastBaseUpdate)!==a&&(null===o?c.firstBaseUpdate=h:o.next=h,c.lastBaseUpdate=l))}if(null!==r){var d=n.baseState;for(a=0,c=h=l=null,o=r;;){var u=o.lane,p=o.eventTime;if((i&u)===u){null!==c&&(c=c.next={eventTime:p,lane:0,tag:o.tag,payload:o.payload,callback:o.callback,next:null});t:{var f=t,m=o;switch(u=e,p=s,m.tag){case 1:if("function"==typeof(f=m.payload)){d=f.call(p,d,u);break t}d=f;break t;case 3:f.flags=-65537&f.flags|128;case 0:if(null==(u="function"==typeof(f=m.payload)?f.call(p,d,u):f))break t;d=$p({},d,u);break t;case 2:Vb=!0}}null!==o.callback&&0!==o.lane&&(t.flags|=64,null===(u=n.effects)?n.effects=[o]:u.push(o))}else p={eventTime:p,lane:u,tag:o.tag,payload:o.payload,callback:o.callback,next:null},null===c?(h=c=p,l=d):c=c.next=p,a|=u;if(null===(o=o.next)){if(null===(o=n.shared.pending))break;o=(u=o).next,u.next=null,n.lastBaseUpdate=u,n.shared.pending=null}}if(null===c&&(l=d),n.baseState=l,n.firstBaseUpdate=h,n.lastBaseUpdate=c,null!==(e=n.shared.interleaved)){n=e;do{a|=n.lane,n=n.next}while(n!==e)}else null===r&&(n.shared.lanes=0);Xw|=a,t.lanes=a,t.memoizedState=d}}function Kb(t,e,s){if(t=e.effects,e.effects=null,null!==t)for(e=0;e<t.length;e++){var i=t[e],n=i.callback;if(null!==n){if(i.callback=null,i=s,"function"!=typeof n)throw Error(gp(191,n));n.call(i)}}}var Yb=(new fp.Component).refs;function Qb(t,e,s,i){s=null==(s=s(i,e=t.memoizedState))?e:$p({},e,s),t.memoizedState=s,0===t.lanes&&(t.updateQueue.baseState=s)}var Jb={isMounted:function(t){return!!(t=t._reactInternals)&&tm(t)===t},enqueueSetState:function(t,e,s){t=t._reactInternals;var i=dS(),n=uS(t),r=Wb(i,n);r.payload=e,null!=s&&(r.callback=s),null!==(e=jb(t,r,n))&&(pS(e,t,n,i),qb(e,t,n))},enqueueReplaceState:function(t,e,s){t=t._reactInternals;var i=dS(),n=uS(t),r=Wb(i,n);r.tag=1,r.payload=e,null!=s&&(r.callback=s),null!==(e=jb(t,r,n))&&(pS(e,t,n,i),qb(e,t,n))},enqueueForceUpdate:function(t,e){t=t._reactInternals;var s=dS(),i=uS(t),n=Wb(s,i);n.tag=2,null!=e&&(n.callback=e),null!==(e=jb(t,n,i))&&(pS(e,t,i,s),qb(e,t,i))}};function Zb(t,e,s,i,n,r,a){return"function"==typeof(t=t.stateNode).shouldComponentUpdate?t.shouldComponentUpdate(i,r,a):!e.prototype||!e.prototype.isPureReactComponent||(!b_(s,i)||!b_(n,r))}function ty(t,e,s){var i=!1,n=zv,r=e.contextType;return"object"==typeof r&&null!==r?r=Fb(r):(n=Gv(e)?Vv:Nv.current,r=(i=null!=(i=e.contextTypes))?Hv(t,n):zv),e=new e(s,r),t.memoizedState=null!==e.state&&void 0!==e.state?e.state:null,e.updater=Jb,t.stateNode=e,e._reactInternals=t,i&&((t=t.stateNode).__reactInternalMemoizedUnmaskedChildContext=n,t.__reactInternalMemoizedMaskedChildContext=r),e}function ey(t,e,s,i){t=e.state,"function"==typeof e.componentWillReceiveProps&&e.componentWillReceiveProps(s,i),"function"==typeof e.UNSAFE_componentWillReceiveProps&&e.UNSAFE_componentWillReceiveProps(s,i),e.state!==t&&Jb.enqueueReplaceState(e,e.state,null)}function sy(t,e,s,i){var n=t.stateNode;n.props=s,n.state=t.memoizedState,n.refs=Yb,Hb(t);var r=e.contextType;"object"==typeof r&&null!==r?n.context=Fb(r):(r=Gv(e)?Vv:Nv.current,n.context=Hv(t,r)),n.state=t.memoizedState,"function"==typeof(r=e.getDerivedStateFromProps)&&(Qb(t,e,r,s),n.state=t.memoizedState),"function"==typeof e.getDerivedStateFromProps||"function"==typeof n.getSnapshotBeforeUpdate||"function"!=typeof n.UNSAFE_componentWillMount&&"function"!=typeof n.componentWillMount||(e=n.state,"function"==typeof n.componentWillMount&&n.componentWillMount(),"function"==typeof n.UNSAFE_componentWillMount&&n.UNSAFE_componentWillMount(),e!==n.state&&Jb.enqueueReplaceState(n,n.state,null),$b(t,s,n,i),n.state=t.memoizedState),"function"==typeof n.componentDidMount&&(t.flags|=4194308)}function iy(t,e,s){if(null!==(t=s.ref)&&"function"!=typeof t&&"object"!=typeof t){if(s._owner){if(s=s._owner){if(1!==s.tag)throw Error(gp(309));var i=s.stateNode}if(!i)throw Error(gp(147,t));var n=i,r=""+t;return null!==e&&null!==e.ref&&"function"==typeof e.ref&&e.ref._stringRef===r?e.ref:(e=function(t){var e=n.refs;e===Yb&&(e=n.refs={}),null===t?delete e[r]:e[r]=t},e._stringRef=r,e)}if("string"!=typeof t)throw Error(gp(284));if(!s._owner)throw Error(gp(290,t))}return t}function ny(t,e){throw t=Object.prototype.toString.call(e),Error(gp(31,"[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t))}function ry(t){return(0,t._init)(t._payload)}function ay(t){function e(e,s){if(t){var i=e.deletions;null===i?(e.deletions=[s],e.flags|=16):i.push(s)}}function s(s,i){if(!t)return null;for(;null!==i;)e(s,i),i=i.sibling;return null}function i(t,e){for(t=new Map;null!==e;)null!==e.key?t.set(e.key,e):t.set(e.index,e),e=e.sibling;return t}function n(t,e){return(t=WS(t,e)).index=0,t.sibling=null,t}function r(e,s,i){return e.index=i,t?null!==(i=e.alternate)?(i=i.index)<s?(e.flags|=2,s):i:(e.flags|=2,s):(e.flags|=1048576,s)}function a(e){return t&&null===e.alternate&&(e.flags|=2),e}function o(t,e,s,i){return null===e||6!==e.tag?((e=$S(s,t.mode,i)).return=t,e):((e=n(e,s)).return=t,e)}function l(t,e,s,i){var r=s.type;return r===Ip?c(t,e,s.props.children,i,s.key):null!==e&&(e.elementType===r||"object"==typeof r&&null!==r&&r.$$typeof===Gp&&ry(r)===e.type)?((i=n(e,s.props)).ref=iy(t,e,s),i.return=t,i):((i=jS(s.type,s.key,s.props,null,t.mode,i)).ref=iy(t,e,s),i.return=t,i)}function h(t,e,s,i){return null===e||4!==e.tag||e.stateNode.containerInfo!==s.containerInfo||e.stateNode.implementation!==s.implementation?((e=KS(s,t.mode,i)).return=t,e):((e=n(e,s.children||[])).return=t,e)}function c(t,e,s,i,r){return null===e||7!==e.tag?((e=qS(s,t.mode,i,r)).return=t,e):((e=n(e,s)).return=t,e)}function d(t,e,s){if("string"==typeof e&&""!==e||"number"==typeof e)return(e=$S(""+e,t.mode,s)).return=t,e;if("object"==typeof e&&null!==e){switch(e.$$typeof){case Rp:return(s=jS(e.type,e.key,e.props,null,t.mode,s)).ref=iy(t,null,e),s.return=t,s;case Lp:return(e=KS(e,t.mode,s)).return=t,e;case Gp:return d(t,(0,e._init)(e._payload),s)}if(pf(e)||qp(e))return(e=qS(e,t.mode,s,null)).return=t,e;ny(t,e)}return null}function u(t,e,s,i){var n=null!==e?e.key:null;if("string"==typeof s&&""!==s||"number"==typeof s)return null!==n?null:o(t,e,""+s,i);if("object"==typeof s&&null!==s){switch(s.$$typeof){case Rp:return s.key===n?l(t,e,s,i):null;case Lp:return s.key===n?h(t,e,s,i):null;case Gp:return u(t,e,(n=s._init)(s._payload),i)}if(pf(s)||qp(s))return null!==n?null:c(t,e,s,i,null);ny(t,s)}return null}function p(t,e,s,i,n){if("string"==typeof i&&""!==i||"number"==typeof i)return o(e,t=t.get(s)||null,""+i,n);if("object"==typeof i&&null!==i){switch(i.$$typeof){case Rp:return l(e,t=t.get(null===i.key?s:i.key)||null,i,n);case Lp:return h(e,t=t.get(null===i.key?s:i.key)||null,i,n);case Gp:return p(t,e,s,(0,i._init)(i._payload),n)}if(pf(i)||qp(i))return c(e,t=t.get(s)||null,i,n,null);ny(e,i)}return null}function f(n,a,o,l){for(var h=null,c=null,f=a,m=a=0,g=null;null!==f&&m<o.length;m++){f.index>m?(g=f,f=null):g=f.sibling;var _=u(n,f,o[m],l);if(null===_){null===f&&(f=g);break}t&&f&&null===_.alternate&&e(n,f),a=r(_,a,m),null===c?h=_:c.sibling=_,c=_,f=g}if(m===o.length)return s(n,f),mb&&hb(n,m),h;if(null===f){for(;m<o.length;m++)null!==(f=d(n,o[m],l))&&(a=r(f,a,m),null===c?h=f:c.sibling=f,c=f);return mb&&hb(n,m),h}for(f=i(n,f);m<o.length;m++)null!==(g=p(f,n,m,o[m],l))&&(t&&null!==g.alternate&&f.delete(null===g.key?m:g.key),a=r(g,a,m),null===c?h=g:c.sibling=g,c=g);return t&&f.forEach((function(t){return e(n,t)})),mb&&hb(n,m),h}function m(n,a,o,l){var h=qp(o);if("function"!=typeof h)throw Error(gp(150));if(null==(o=h.call(o)))throw Error(gp(151));for(var c=h=null,f=a,m=a=0,g=null,_=o.next();null!==f&&!_.done;m++,_=o.next()){f.index>m?(g=f,f=null):g=f.sibling;var v=u(n,f,_.value,l);if(null===v){null===f&&(f=g);break}t&&f&&null===v.alternate&&e(n,f),a=r(v,a,m),null===c?h=v:c.sibling=v,c=v,f=g}if(_.done)return s(n,f),mb&&hb(n,m),h;if(null===f){for(;!_.done;m++,_=o.next())null!==(_=d(n,_.value,l))&&(a=r(_,a,m),null===c?h=_:c.sibling=_,c=_);return mb&&hb(n,m),h}for(f=i(n,f);!_.done;m++,_=o.next())null!==(_=p(f,n,m,_.value,l))&&(t&&null!==_.alternate&&f.delete(null===_.key?m:_.key),a=r(_,a,m),null===c?h=_:c.sibling=_,c=_);return t&&f.forEach((function(t){return e(n,t)})),mb&&hb(n,m),h}return function t(i,r,o,l){if("object"==typeof o&&null!==o&&o.type===Ip&&null===o.key&&(o=o.props.children),"object"==typeof o&&null!==o){switch(o.$$typeof){case Rp:t:{for(var h=o.key,c=r;null!==c;){if(c.key===h){if((h=o.type)===Ip){if(7===c.tag){s(i,c.sibling),(r=n(c,o.props.children)).return=i,i=r;break t}}else if(c.elementType===h||"object"==typeof h&&null!==h&&h.$$typeof===Gp&&ry(h)===c.type){s(i,c.sibling),(r=n(c,o.props)).ref=iy(i,c,o),r.return=i,i=r;break t}s(i,c);break}e(i,c),c=c.sibling}o.type===Ip?((r=qS(o.props.children,i.mode,l,o.key)).return=i,i=r):((l=jS(o.type,o.key,o.props,null,i.mode,l)).ref=iy(i,r,o),l.return=i,i=l)}return a(i);case Lp:t:{for(c=o.key;null!==r;){if(r.key===c){if(4===r.tag&&r.stateNode.containerInfo===o.containerInfo&&r.stateNode.implementation===o.implementation){s(i,r.sibling),(r=n(r,o.children||[])).return=i,i=r;break t}s(i,r);break}e(i,r),r=r.sibling}(r=KS(o,i.mode,l)).return=i,i=r}return a(i);case Gp:return t(i,r,(c=o._init)(o._payload),l)}if(pf(o))return f(i,r,o,l);if(qp(o))return m(i,r,o,l);ny(i,o)}return"string"==typeof o&&""!==o||"number"==typeof o?(o=""+o,null!==r&&6===r.tag?(s(i,r.sibling),(r=n(r,o)).return=i,i=r):(s(i,r),(r=$S(o,i.mode,l)).return=i,i=r),a(i)):s(i,r)}}var oy=ay(!0),ly=ay(!1),hy={},cy=Ov(hy),dy=Ov(hy),uy=Ov(hy);function py(t){if(t===hy)throw Error(gp(174));return t}function fy(t,e){switch(Bv(uy,e),Bv(dy,t),Bv(cy,hy),t=e.nodeType){case 9:case 11:e=(e=e.documentElement)?e.namespaceURI:yf(null,"");break;default:e=yf(e=(t=8===t?e.parentNode:e).namespaceURI||null,t=t.tagName)}Fv(cy),Bv(cy,e)}function my(){Fv(cy),Fv(dy),Fv(uy)}function gy(t){py(uy.current);var e=py(cy.current),s=yf(e,t.type);e!==s&&(Bv(dy,t),Bv(cy,s))}function _y(t){dy.current===t&&(Fv(cy),Fv(dy))}var vy=Ov(0);function by(t){for(var e=t;null!==e;){if(13===e.tag){var s=e.memoizedState;if(null!==s&&(null===(s=s.dehydrated)||"$?"===s.data||"$!"===s.data))return e}else if(19===e.tag&&void 0!==e.memoizedProps.revealOrder){if(0!=(128&e.flags))return e}else if(null!==e.child){e.child.return=e,e=e.child;continue}if(e===t)break;for(;null===e.sibling;){if(null===e.return||e.return===t)return null;e=e.return}e.sibling.return=e.return,e=e.sibling}return null}var yy=[];function xy(){for(var t=0;t<yy.length;t++)yy[t]._workInProgressVersionPrimary=null;yy.length=0}var wy=Dp.ReactCurrentDispatcher,Sy=Dp.ReactCurrentBatchConfig,Cy=0,Ty=null,Ey=null,Py=null,My=!1,Ay=!1,ky=0,Dy=0;function Ry(){throw Error(gp(321))}function Ly(t,e){if(null===e)return!1;for(var s=0;s<e.length&&s<t.length;s++)if(!v_(t[s],e[s]))return!1;return!0}function Iy(t,e,s,i,n,r){if(Cy=r,Ty=e,e.memoizedState=null,e.updateQueue=null,e.lanes=0,wy.current=null===t||null===t.memoizedState?_x:vx,t=s(i,n),Ay){r=0;do{if(Ay=!1,ky=0,25<=r)throw Error(gp(301));r+=1,Py=Ey=null,e.updateQueue=null,wy.current=bx,t=s(i,n)}while(Ay)}if(wy.current=gx,e=null!==Ey&&null!==Ey.next,Cy=0,Py=Ey=Ty=null,My=!1,e)throw Error(gp(300));return t}function Oy(){var t=0!==ky;return ky=0,t}function Fy(){var t={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return null===Py?Ty.memoizedState=Py=t:Py=Py.next=t,Py}function By(){if(null===Ey){var t=Ty.alternate;t=null!==t?t.memoizedState:null}else t=Ey.next;var e=null===Py?Ty.memoizedState:Py.next;if(null!==e)Py=e,Ey=t;else{if(null===t)throw Error(gp(310));t={memoizedState:(Ey=t).memoizedState,baseState:Ey.baseState,baseQueue:Ey.baseQueue,queue:Ey.queue,next:null},null===Py?Ty.memoizedState=Py=t:Py=Py.next=t}return Py}function zy(t,e){return"function"==typeof e?e(t):e}function Ny(t){var e=By(),s=e.queue;if(null===s)throw Error(gp(311));s.lastRenderedReducer=t;var i=Ey,n=i.baseQueue,r=s.pending;if(null!==r){if(null!==n){var a=n.next;n.next=r.next,r.next=a}i.baseQueue=n=r,s.pending=null}if(null!==n){r=n.next,i=i.baseState;var o=a=null,l=null,h=r;do{var c=h.lane;if((Cy&c)===c)null!==l&&(l=l.next={lane:0,action:h.action,hasEagerState:h.hasEagerState,eagerState:h.eagerState,next:null}),i=h.hasEagerState?h.eagerState:t(i,h.action);else{var d={lane:c,action:h.action,hasEagerState:h.hasEagerState,eagerState:h.eagerState,next:null};null===l?(o=l=d,a=i):l=l.next=d,Ty.lanes|=c,Xw|=c}h=h.next}while(null!==h&&h!==r);null===l?a=i:l.next=o,v_(i,e.memoizedState)||(kx=!0),e.memoizedState=i,e.baseState=a,e.baseQueue=l,s.lastRenderedState=i}if(null!==(t=s.interleaved)){n=t;do{r=n.lane,Ty.lanes|=r,Xw|=r,n=n.next}while(n!==t)}else null===n&&(s.lanes=0);return[e.memoizedState,s.dispatch]}function Uy(t){var e=By(),s=e.queue;if(null===s)throw Error(gp(311));s.lastRenderedReducer=t;var i=s.dispatch,n=s.pending,r=e.memoizedState;if(null!==n){s.pending=null;var a=n=n.next;do{r=t(r,a.action),a=a.next}while(a!==n);v_(r,e.memoizedState)||(kx=!0),e.memoizedState=r,null===e.baseQueue&&(e.baseState=r),s.lastRenderedState=r}return[r,i]}function Vy(){}function Hy(t,e){var s=Ty,i=By(),n=e(),r=!v_(i.memoizedState,n);if(r&&(i.memoizedState=n,kx=!0),i=i.queue,tx(jy.bind(null,s,i,t),[t]),i.getSnapshot!==e||r||null!==Py&&1&Py.memoizedState.tag){if(s.flags|=2048,Ky(9,Wy.bind(null,s,i,n,e),void 0,null),null===Uw)throw Error(gp(349));0!=(30&Cy)||Gy(s,e,n)}return n}function Gy(t,e,s){t.flags|=16384,t={getSnapshot:e,value:s},null===(e=Ty.updateQueue)?(e={lastEffect:null,stores:null},Ty.updateQueue=e,e.stores=[t]):null===(s=e.stores)?e.stores=[t]:s.push(t)}function Wy(t,e,s,i){e.value=s,e.getSnapshot=i,qy(e)&&Xy(t)}function jy(t,e,s){return s((function(){qy(e)&&Xy(t)}))}function qy(t){var e=t.getSnapshot;t=t.value;try{var s=e();return!v_(t,s)}catch(t){return!0}}function Xy(t){var e=Ub(t,1);null!==e&&pS(e,t,1,-1)}function $y(t){var e=Fy();return"function"==typeof t&&(t=t()),e.memoizedState=e.baseState=t,t={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:zy,lastRenderedState:t},e.queue=t,t=t.dispatch=ux.bind(null,Ty,t),[e.memoizedState,t]}function Ky(t,e,s,i){return t={tag:t,create:e,destroy:s,deps:i,next:null},null===(e=Ty.updateQueue)?(e={lastEffect:null,stores:null},Ty.updateQueue=e,e.lastEffect=t.next=t):null===(s=e.lastEffect)?e.lastEffect=t.next=t:(i=s.next,s.next=t,t.next=i,e.lastEffect=t),t}function Yy(){return By().memoizedState}function Qy(t,e,s,i){var n=Fy();Ty.flags|=t,n.memoizedState=Ky(1|e,s,void 0,void 0===i?null:i)}function Jy(t,e,s,i){var n=By();i=void 0===i?null:i;var r=void 0;if(null!==Ey){var a=Ey.memoizedState;if(r=a.destroy,null!==i&&Ly(i,a.deps))return void(n.memoizedState=Ky(e,s,r,i))}Ty.flags|=t,n.memoizedState=Ky(1|e,s,r,i)}function Zy(t,e){return Qy(8390656,8,t,e)}function tx(t,e){return Jy(2048,8,t,e)}function ex(t,e){return Jy(4,2,t,e)}function sx(t,e){return Jy(4,4,t,e)}function ix(t,e){return"function"==typeof e?(t=t(),e(t),function(){e(null)}):null!=e?(t=t(),e.current=t,function(){e.current=null}):void 0}function nx(t,e,s){return s=null!=s?s.concat([t]):null,Jy(4,4,ix.bind(null,e,t),s)}function rx(){}function ax(t,e){var s=By();e=void 0===e?null:e;var i=s.memoizedState;return null!==i&&null!==e&&Ly(e,i[1])?i[0]:(s.memoizedState=[t,e],t)}function ox(t,e){var s=By();e=void 0===e?null:e;var i=s.memoizedState;return null!==i&&null!==e&&Ly(e,i[1])?i[0]:(t=t(),s.memoizedState=[t,e],t)}function lx(t,e,s){return 0==(21&Cy)?(t.baseState&&(t.baseState=!1,kx=!0),t.memoizedState=s):(v_(s,e)||(s=Pm(),Ty.lanes|=s,Xw|=s,t.baseState=!0),e)}function hx(t,e){var s=Dm;Dm=0!==s&&4>s?s:4,t(!0);var i=Sy.transition;Sy.transition={};try{t(!1),e()}finally{Dm=s,Sy.transition=i}}function cx(){return By().memoizedState}function dx(t,e,s){var i=uS(t);if(s={lane:i,action:s,hasEagerState:!1,eagerState:null,next:null},px(t))fx(e,s);else if(null!==(s=Nb(t,e,s,i))){pS(s,t,i,dS()),mx(s,e,i)}}function ux(t,e,s){var i=uS(t),n={lane:i,action:s,hasEagerState:!1,eagerState:null,next:null};if(px(t))fx(e,n);else{var r=t.alternate;if(0===t.lanes&&(null===r||0===r.lanes)&&null!==(r=e.lastRenderedReducer))try{var a=e.lastRenderedState,o=r(a,s);if(n.hasEagerState=!0,n.eagerState=o,v_(o,a)){var l=e.interleaved;return null===l?(n.next=n,zb(e)):(n.next=l.next,l.next=n),void(e.interleaved=n)}}catch(t){}null!==(s=Nb(t,e,n,i))&&(pS(s,t,i,n=dS()),mx(s,e,i))}}function px(t){var e=t.alternate;return t===Ty||null!==e&&e===Ty}function fx(t,e){Ay=My=!0;var s=t.pending;null===s?e.next=e:(e.next=s.next,s.next=e),t.pending=e}function mx(t,e,s){if(0!=(4194240&s)){var i=e.lanes;s|=i&=t.pendingLanes,e.lanes=s,km(t,s)}}var gx={readContext:Fb,useCallback:Ry,useContext:Ry,useEffect:Ry,useImperativeHandle:Ry,useInsertionEffect:Ry,useLayoutEffect:Ry,useMemo:Ry,useReducer:Ry,useRef:Ry,useState:Ry,useDebugValue:Ry,useDeferredValue:Ry,useTransition:Ry,useMutableSource:Ry,useSyncExternalStore:Ry,useId:Ry,unstable_isNewReconciler:!1},_x={readContext:Fb,useCallback:function(t,e){return Fy().memoizedState=[t,void 0===e?null:e],t},useContext:Fb,useEffect:Zy,useImperativeHandle:function(t,e,s){return s=null!=s?s.concat([t]):null,Qy(4194308,4,ix.bind(null,e,t),s)},useLayoutEffect:function(t,e){return Qy(4194308,4,t,e)},useInsertionEffect:function(t,e){return Qy(4,2,t,e)},useMemo:function(t,e){var s=Fy();return e=void 0===e?null:e,t=t(),s.memoizedState=[t,e],t},useReducer:function(t,e,s){var i=Fy();return e=void 0!==s?s(e):e,i.memoizedState=i.baseState=e,t={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:t,lastRenderedState:e},i.queue=t,t=t.dispatch=dx.bind(null,Ty,t),[i.memoizedState,t]},useRef:function(t){return t={current:t},Fy().memoizedState=t},useState:$y,useDebugValue:rx,useDeferredValue:function(t){return Fy().memoizedState=t},useTransition:function(){var t=$y(!1),e=t[0];return t=hx.bind(null,t[1]),Fy().memoizedState=t,[e,t]},useMutableSource:function(){},useSyncExternalStore:function(t,e,s){var i=Ty,n=Fy();if(mb){if(void 0===s)throw Error(gp(407));s=s()}else{if(s=e(),null===Uw)throw Error(gp(349));0!=(30&Cy)||Gy(i,e,s)}n.memoizedState=s;var r={value:s,getSnapshot:e};return n.queue=r,Zy(jy.bind(null,i,r,t),[t]),i.flags|=2048,Ky(9,Wy.bind(null,i,r,s,e),void 0,null),s},useId:function(){var t=Fy(),e=Uw.identifierPrefix;if(mb){var s=lb;e=":"+e+"R"+(s=(ob&~(1<<32-vm(ob)-1)).toString(32)+s),0<(s=ky++)&&(e+="H"+s.toString(32)),e+=":"}else e=":"+e+"r"+(s=Dy++).toString(32)+":";return t.memoizedState=e},unstable_isNewReconciler:!1},vx={readContext:Fb,useCallback:ax,useContext:Fb,useEffect:tx,useImperativeHandle:nx,useInsertionEffect:ex,useLayoutEffect:sx,useMemo:ox,useReducer:Ny,useRef:Yy,useState:function(){return Ny(zy)},useDebugValue:rx,useDeferredValue:function(t){return lx(By(),Ey.memoizedState,t)},useTransition:function(){return[Ny(zy)[0],By().memoizedState]},useMutableSource:Vy,useSyncExternalStore:Hy,useId:cx,unstable_isNewReconciler:!1},bx={readContext:Fb,useCallback:ax,useContext:Fb,useEffect:tx,useImperativeHandle:nx,useInsertionEffect:ex,useLayoutEffect:sx,useMemo:ox,useReducer:Uy,useRef:Yy,useState:function(){return Uy(zy)},useDebugValue:rx,useDeferredValue:function(t){var e=By();return null===Ey?e.memoizedState=t:lx(e,Ey.memoizedState,t)},useTransition:function(){return[Uy(zy)[0],By().memoizedState]},useMutableSource:Vy,useSyncExternalStore:Hy,useId:cx,unstable_isNewReconciler:!1};function yx(t,e){try{var s="",i=e;do{s+=Jp(i),i=i.return}while(i);var n=s}catch(t){n="\nError generating stack: "+t.message+"\n"+t.stack}return{value:t,source:e,stack:n,digest:null}}function xx(t,e,s){return{value:t,source:null,stack:null!=s?s:null,digest:null!=e?e:null}}function wx(t,e){try{console.error(e.value)}catch(t){setTimeout((function(){throw t}))}}var Sx="function"==typeof WeakMap?WeakMap:Map;function Cx(t,e,s){(s=Wb(-1,s)).tag=3,s.payload={element:null};var i=e.value;return s.callback=function(){eS||(eS=!0,sS=i),wx(0,e)},s}function Tx(t,e,s){(s=Wb(-1,s)).tag=3;var i=t.type.getDerivedStateFromError;if("function"==typeof i){var n=e.value;s.payload=function(){return i(n)},s.callback=function(){wx(0,e)}}var r=t.stateNode;return null!==r&&"function"==typeof r.componentDidCatch&&(s.callback=function(){wx(0,e),"function"!=typeof i&&(null===iS?iS=new Set([this]):iS.add(this));var t=e.stack;this.componentDidCatch(e.value,{componentStack:null!==t?t:""})}),s}function Ex(t,e,s){var i=t.pingCache;if(null===i){i=t.pingCache=new Sx;var n=new Set;i.set(e,n)}else void 0===(n=i.get(e))&&(n=new Set,i.set(e,n));n.has(s)||(n.add(s),t=FS.bind(null,t,e,s),e.then(t,t))}function Px(t){do{var e;if((e=13===t.tag)&&(e=null===(e=t.memoizedState)||null!==e.dehydrated),e)return t;t=t.return}while(null!==t);return null}function Mx(t,e,s,i,n){return 0==(1&t.mode)?(t===e?t.flags|=65536:(t.flags|=128,s.flags|=131072,s.flags&=-52805,1===s.tag&&(null===s.alternate?s.tag=17:((e=Wb(-1,1)).tag=2,jb(s,e,1))),s.lanes|=1),t):(t.flags|=65536,t.lanes=n,t)}var Ax=Dp.ReactCurrentOwner,kx=!1;function Dx(t,e,s,i){e.child=null===t?ly(e,null,s,i):oy(e,t.child,s,i)}function Rx(t,e,s,i,n){s=s.render;var r=e.ref;return Ob(e,n),i=Iy(t,e,s,i,r,n),s=Oy(),null===t||kx?(mb&&s&&db(e),e.flags|=1,Dx(t,e,i,n),e.child):(e.updateQueue=t.updateQueue,e.flags&=-2053,t.lanes&=~n,ew(t,e,n))}function Lx(t,e,s,i,n){if(null===t){var r=s.type;return"function"!=typeof r||GS(r)||void 0!==r.defaultProps||null!==s.compare||void 0!==s.defaultProps?((t=jS(s.type,null,i,e,e.mode,n)).ref=e.ref,t.return=e,e.child=t):(e.tag=15,e.type=r,Ix(t,e,r,i,n))}if(r=t.child,0==(t.lanes&n)){var a=r.memoizedProps;if((s=null!==(s=s.compare)?s:b_)(a,i)&&t.ref===e.ref)return ew(t,e,n)}return e.flags|=1,(t=WS(r,i)).ref=e.ref,t.return=e,e.child=t}function Ix(t,e,s,i,n){if(null!==t){var r=t.memoizedProps;if(b_(r,i)&&t.ref===e.ref){if(kx=!1,e.pendingProps=i=r,0==(t.lanes&n))return e.lanes=t.lanes,ew(t,e,n);0!=(131072&t.flags)&&(kx=!0)}}return Bx(t,e,s,i,n)}function Ox(t,e,s){var i=e.pendingProps,n=i.children,r=null!==t?t.memoizedState:null;if("hidden"===i.mode)if(0==(1&e.mode))e.memoizedState={baseLanes:0,cachePool:null,transitions:null},Bv(Ww,Gw),Gw|=s;else{if(0==(1073741824&s))return t=null!==r?r.baseLanes|s:s,e.lanes=e.childLanes=1073741824,e.memoizedState={baseLanes:t,cachePool:null,transitions:null},e.updateQueue=null,Bv(Ww,Gw),Gw|=t,null;e.memoizedState={baseLanes:0,cachePool:null,transitions:null},i=null!==r?r.baseLanes:s,Bv(Ww,Gw),Gw|=i}else null!==r?(i=r.baseLanes|s,e.memoizedState=null):i=s,Bv(Ww,Gw),Gw|=i;return Dx(t,e,n,s),e.child}function Fx(t,e){var s=e.ref;(null===t&&null!==s||null!==t&&t.ref!==s)&&(e.flags|=512,e.flags|=2097152)}function Bx(t,e,s,i,n){var r=Gv(s)?Vv:Nv.current;return r=Hv(e,r),Ob(e,n),s=Iy(t,e,s,i,r,n),i=Oy(),null===t||kx?(mb&&i&&db(e),e.flags|=1,Dx(t,e,s,n),e.child):(e.updateQueue=t.updateQueue,e.flags&=-2053,t.lanes&=~n,ew(t,e,n))}function zx(t,e,s,i,n){if(Gv(s)){var r=!0;Xv(e)}else r=!1;if(Ob(e,n),null===e.stateNode)tw(t,e),ty(e,s,i),sy(e,s,i,n),i=!0;else if(null===t){var a=e.stateNode,o=e.memoizedProps;a.props=o;var l=a.context,h=s.contextType;"object"==typeof h&&null!==h?h=Fb(h):h=Hv(e,h=Gv(s)?Vv:Nv.current);var c=s.getDerivedStateFromProps,d="function"==typeof c||"function"==typeof a.getSnapshotBeforeUpdate;d||"function"!=typeof a.UNSAFE_componentWillReceiveProps&&"function"!=typeof a.componentWillReceiveProps||(o!==i||l!==h)&&ey(e,a,i,h),Vb=!1;var u=e.memoizedState;a.state=u,$b(e,i,a,n),l=e.memoizedState,o!==i||u!==l||Uv.current||Vb?("function"==typeof c&&(Qb(e,s,c,i),l=e.memoizedState),(o=Vb||Zb(e,s,o,i,u,l,h))?(d||"function"!=typeof a.UNSAFE_componentWillMount&&"function"!=typeof a.componentWillMount||("function"==typeof a.componentWillMount&&a.componentWillMount(),"function"==typeof a.UNSAFE_componentWillMount&&a.UNSAFE_componentWillMount()),"function"==typeof a.componentDidMount&&(e.flags|=4194308)):("function"==typeof a.componentDidMount&&(e.flags|=4194308),e.memoizedProps=i,e.memoizedState=l),a.props=i,a.state=l,a.context=h,i=o):("function"==typeof a.componentDidMount&&(e.flags|=4194308),i=!1)}else{a=e.stateNode,Gb(t,e),o=e.memoizedProps,h=e.type===e.elementType?o:Pb(e.type,o),a.props=h,d=e.pendingProps,u=a.context,"object"==typeof(l=s.contextType)&&null!==l?l=Fb(l):l=Hv(e,l=Gv(s)?Vv:Nv.current);var p=s.getDerivedStateFromProps;(c="function"==typeof p||"function"==typeof a.getSnapshotBeforeUpdate)||"function"!=typeof a.UNSAFE_componentWillReceiveProps&&"function"!=typeof a.componentWillReceiveProps||(o!==d||u!==l)&&ey(e,a,i,l),Vb=!1,u=e.memoizedState,a.state=u,$b(e,i,a,n);var f=e.memoizedState;o!==d||u!==f||Uv.current||Vb?("function"==typeof p&&(Qb(e,s,p,i),f=e.memoizedState),(h=Vb||Zb(e,s,h,i,u,f,l)||!1)?(c||"function"!=typeof a.UNSAFE_componentWillUpdate&&"function"!=typeof a.componentWillUpdate||("function"==typeof a.componentWillUpdate&&a.componentWillUpdate(i,f,l),"function"==typeof a.UNSAFE_componentWillUpdate&&a.UNSAFE_componentWillUpdate(i,f,l)),"function"==typeof a.componentDidUpdate&&(e.flags|=4),"function"==typeof a.getSnapshotBeforeUpdate&&(e.flags|=1024)):("function"!=typeof a.componentDidUpdate||o===t.memoizedProps&&u===t.memoizedState||(e.flags|=4),"function"!=typeof a.getSnapshotBeforeUpdate||o===t.memoizedProps&&u===t.memoizedState||(e.flags|=1024),e.memoizedProps=i,e.memoizedState=f),a.props=i,a.state=f,a.context=l,i=h):("function"!=typeof a.componentDidUpdate||o===t.memoizedProps&&u===t.memoizedState||(e.flags|=4),"function"!=typeof a.getSnapshotBeforeUpdate||o===t.memoizedProps&&u===t.memoizedState||(e.flags|=1024),i=!1)}return Nx(t,e,s,i,r,n)}function Nx(t,e,s,i,n,r){Fx(t,e);var a=0!=(128&e.flags);if(!i&&!a)return n&&$v(e,s,!1),ew(t,e,r);i=e.stateNode,Ax.current=e;var o=a&&"function"!=typeof s.getDerivedStateFromError?null:i.render();return e.flags|=1,null!==t&&a?(e.child=oy(e,t.child,null,r),e.child=oy(e,null,o,r)):Dx(t,e,o,r),e.memoizedState=i.state,n&&$v(e,s,!0),e.child}function Ux(t){var e=t.stateNode;e.pendingContext?jv(0,e.pendingContext,e.pendingContext!==e.context):e.context&&jv(0,e.context,!1),fy(t,e.containerInfo)}function Vx(t,e,s,i,n){return Cb(),Tb(n),e.flags|=256,Dx(t,e,s,i),e.child}var Hx,Gx,Wx,jx,qx={dehydrated:null,treeContext:null,retryLane:0};function Xx(t){return{baseLanes:t,cachePool:null,transitions:null}}function $x(t,e,s){var i,n=e.pendingProps,r=vy.current,a=!1,o=0!=(128&e.flags);if((i=o)||(i=(null===t||null!==t.memoizedState)&&0!=(2&r)),i?(a=!0,e.flags&=-129):null!==t&&null===t.memoizedState||(r|=1),Bv(vy,1&r),null===t)return yb(e),null!==(t=e.memoizedState)&&null!==(t=t.dehydrated)?(0==(1&e.mode)?e.lanes=1:"$!"===t.data?e.lanes=8:e.lanes=1073741824,null):(o=n.children,t=n.fallback,a?(n=e.mode,a=e.child,o={mode:"hidden",children:o},0==(1&n)&&null!==a?(a.childLanes=0,a.pendingProps=o):a=XS(o,n,0,null),t=qS(t,n,s,null),a.return=e,t.return=e,a.sibling=t,e.child=a,e.child.memoizedState=Xx(s),e.memoizedState=qx,t):Kx(e,o));if(null!==(r=t.memoizedState)&&null!==(i=r.dehydrated))return function(t,e,s,i,n,r,a){if(s)return 256&e.flags?(e.flags&=-257,Yx(t,e,a,i=xx(Error(gp(422))))):null!==e.memoizedState?(e.child=t.child,e.flags|=128,null):(r=i.fallback,n=e.mode,i=XS({mode:"visible",children:i.children},n,0,null),(r=qS(r,n,a,null)).flags|=2,i.return=e,r.return=e,i.sibling=r,e.child=i,0!=(1&e.mode)&&oy(e,t.child,null,a),e.child.memoizedState=Xx(a),e.memoizedState=qx,r);if(0==(1&e.mode))return Yx(t,e,a,null);if("$!"===n.data){if(i=n.nextSibling&&n.nextSibling.dataset)var o=i.dgst;return i=o,Yx(t,e,a,i=xx(r=Error(gp(419)),i,void 0))}if(o=0!=(a&t.childLanes),kx||o){if(null!==(i=Uw)){switch(a&-a){case 4:n=2;break;case 16:n=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:n=32;break;case 536870912:n=268435456;break;default:n=0}0!==(n=0!=(n&(i.suspendedLanes|a))?0:n)&&n!==r.retryLane&&(r.retryLane=n,Ub(t,n),pS(i,t,n,-1))}return ES(),Yx(t,e,a,i=xx(Error(gp(421))))}return"$?"===n.data?(e.flags|=128,e.child=t.child,e=zS.bind(null,t),n._reactRetry=e,null):(t=r.treeContext,fb=yv(n.nextSibling),pb=e,mb=!0,gb=null,null!==t&&(nb[rb++]=ob,nb[rb++]=lb,nb[rb++]=ab,ob=t.id,lb=t.overflow,ab=e),e=Kx(e,i.children),e.flags|=4096,e)}(t,e,o,n,i,r,s);if(a){a=n.fallback,o=e.mode,i=(r=t.child).sibling;var l={mode:"hidden",children:n.children};return 0==(1&o)&&e.child!==r?((n=e.child).childLanes=0,n.pendingProps=l,e.deletions=null):(n=WS(r,l)).subtreeFlags=14680064&r.subtreeFlags,null!==i?a=WS(i,a):(a=qS(a,o,s,null)).flags|=2,a.return=e,n.return=e,n.sibling=a,e.child=n,n=a,a=e.child,o=null===(o=t.child.memoizedState)?Xx(s):{baseLanes:o.baseLanes|s,cachePool:null,transitions:o.transitions},a.memoizedState=o,a.childLanes=t.childLanes&~s,e.memoizedState=qx,n}return t=(a=t.child).sibling,n=WS(a,{mode:"visible",children:n.children}),0==(1&e.mode)&&(n.lanes=s),n.return=e,n.sibling=null,null!==t&&(null===(s=e.deletions)?(e.deletions=[t],e.flags|=16):s.push(t)),e.child=n,e.memoizedState=null,n}function Kx(t,e){return(e=XS({mode:"visible",children:e},t.mode,0,null)).return=t,t.child=e}function Yx(t,e,s,i){return null!==i&&Tb(i),oy(e,t.child,null,s),(t=Kx(e,e.pendingProps.children)).flags|=2,e.memoizedState=null,t}function Qx(t,e,s){t.lanes|=e;var i=t.alternate;null!==i&&(i.lanes|=e),Ib(t.return,e,s)}function Jx(t,e,s,i,n){var r=t.memoizedState;null===r?t.memoizedState={isBackwards:e,rendering:null,renderingStartTime:0,last:i,tail:s,tailMode:n}:(r.isBackwards=e,r.rendering=null,r.renderingStartTime=0,r.last=i,r.tail=s,r.tailMode=n)}function Zx(t,e,s){var i=e.pendingProps,n=i.revealOrder,r=i.tail;if(Dx(t,e,i.children,s),0!=(2&(i=vy.current)))i=1&i|2,e.flags|=128;else{if(null!==t&&0!=(128&t.flags))t:for(t=e.child;null!==t;){if(13===t.tag)null!==t.memoizedState&&Qx(t,s,e);else if(19===t.tag)Qx(t,s,e);else if(null!==t.child){t.child.return=t,t=t.child;continue}if(t===e)break t;for(;null===t.sibling;){if(null===t.return||t.return===e)break t;t=t.return}t.sibling.return=t.return,t=t.sibling}i&=1}if(Bv(vy,i),0==(1&e.mode))e.memoizedState=null;else switch(n){case"forwards":for(s=e.child,n=null;null!==s;)null!==(t=s.alternate)&&null===by(t)&&(n=s),s=s.sibling;null===(s=n)?(n=e.child,e.child=null):(n=s.sibling,s.sibling=null),Jx(e,!1,n,s,r);break;case"backwards":for(s=null,n=e.child,e.child=null;null!==n;){if(null!==(t=n.alternate)&&null===by(t)){e.child=n;break}t=n.sibling,n.sibling=s,s=n,n=t}Jx(e,!0,s,null,r);break;case"together":Jx(e,!1,null,null,void 0);break;default:e.memoizedState=null}return e.child}function tw(t,e){0==(1&e.mode)&&null!==t&&(t.alternate=null,e.alternate=null,e.flags|=2)}function ew(t,e,s){if(null!==t&&(e.dependencies=t.dependencies),Xw|=e.lanes,0==(s&e.childLanes))return null;if(null!==t&&e.child!==t.child)throw Error(gp(153));if(null!==e.child){for(s=WS(t=e.child,t.pendingProps),e.child=s,s.return=e;null!==t.sibling;)t=t.sibling,(s=s.sibling=WS(t,t.pendingProps)).return=e;s.sibling=null}return e.child}function sw(t,e){if(!mb)switch(t.tailMode){case"hidden":e=t.tail;for(var s=null;null!==e;)null!==e.alternate&&(s=e),e=e.sibling;null===s?t.tail=null:s.sibling=null;break;case"collapsed":s=t.tail;for(var i=null;null!==s;)null!==s.alternate&&(i=s),s=s.sibling;null===i?e||null===t.tail?t.tail=null:t.tail.sibling=null:i.sibling=null}}function iw(t){var e=null!==t.alternate&&t.alternate.child===t.child,s=0,i=0;if(e)for(var n=t.child;null!==n;)s|=n.lanes|n.childLanes,i|=14680064&n.subtreeFlags,i|=14680064&n.flags,n.return=t,n=n.sibling;else for(n=t.child;null!==n;)s|=n.lanes|n.childLanes,i|=n.subtreeFlags,i|=n.flags,n.return=t,n=n.sibling;return t.subtreeFlags|=i,t.childLanes=s,e}function nw(t,e,s){var i=e.pendingProps;switch(ub(e),e.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return iw(e),null;case 1:case 17:return Gv(e.type)&&Wv(),iw(e),null;case 3:return i=e.stateNode,my(),Fv(Uv),Fv(Nv),xy(),i.pendingContext&&(i.context=i.pendingContext,i.pendingContext=null),null!==t&&null!==t.child||(wb(e)?e.flags|=4:null===t||t.memoizedState.isDehydrated&&0==(256&e.flags)||(e.flags|=1024,null!==gb&&(_S(gb),gb=null))),Gx(t,e),iw(e),null;case 5:_y(e);var n=py(uy.current);if(s=e.type,null!==t&&null!=e.stateNode)Wx(t,e,s,i,n),t.ref!==e.ref&&(e.flags|=512,e.flags|=2097152);else{if(!i){if(null===e.stateNode)throw Error(gp(166));return iw(e),null}if(t=py(cy.current),wb(e)){i=e.stateNode,s=e.type;var r=e.memoizedProps;switch(i[Sv]=e,i[Cv]=r,t=0!=(1&e.mode),s){case"dialog":Y_("cancel",i),Y_("close",i);break;case"iframe":case"object":case"embed":Y_("load",i);break;case"video":case"audio":for(n=0;n<q_.length;n++)Y_(q_[n],i);break;case"source":Y_("error",i);break;case"img":case"image":case"link":Y_("error",i),Y_("load",i);break;case"details":Y_("toggle",i);break;case"input":lf(i,r),Y_("invalid",i);break;case"select":i._wrapperState={wasMultiple:!!r.multiple},Y_("invalid",i);break;case"textarea":gf(i,r),Y_("invalid",i)}for(var a in kf(s,r),n=null,r)if(r.hasOwnProperty(a)){var o=r[a];"children"===a?"string"==typeof o?i.textContent!==o&&(!0!==r.suppressHydrationWarning&&hv(i.textContent,o,t),n=["children",o]):"number"==typeof o&&i.textContent!==""+o&&(!0!==r.suppressHydrationWarning&&hv(i.textContent,o,t),n=["children",""+o]):vp.hasOwnProperty(a)&&null!=o&&"onScroll"===a&&Y_("scroll",i)}switch(s){case"input":nf(i),df(i,r,!0);break;case"textarea":nf(i),vf(i);break;case"select":case"option":break;default:"function"==typeof r.onClick&&(i.onclick=cv)}i=n,e.updateQueue=i,null!==i&&(e.flags|=4)}else{a=9===n.nodeType?n:n.ownerDocument,"http://www.w3.org/1999/xhtml"===t&&(t=bf(s)),"http://www.w3.org/1999/xhtml"===t?"script"===s?((t=a.createElement("div")).innerHTML="<script><\/script>",t=t.removeChild(t.firstChild)):"string"==typeof i.is?t=a.createElement(s,{is:i.is}):(t=a.createElement(s),"select"===s&&(a=t,i.multiple?a.multiple=!0:i.size&&(a.size=i.size))):t=a.createElementNS(t,s),t[Sv]=e,t[Cv]=i,Hx(t,e,!1,!1),e.stateNode=t;t:{switch(a=Df(s,i),s){case"dialog":Y_("cancel",t),Y_("close",t),n=i;break;case"iframe":case"object":case"embed":Y_("load",t),n=i;break;case"video":case"audio":for(n=0;n<q_.length;n++)Y_(q_[n],t);n=i;break;case"source":Y_("error",t),n=i;break;case"img":case"image":case"link":Y_("error",t),Y_("load",t),n=i;break;case"details":Y_("toggle",t),n=i;break;case"input":lf(t,i),n=of(t,i),Y_("invalid",t);break;case"option":default:n=i;break;case"select":t._wrapperState={wasMultiple:!!i.multiple},n=$p({},i,{value:void 0}),Y_("invalid",t);break;case"textarea":gf(t,i),n=mf(t,i),Y_("invalid",t)}for(r in kf(s,n),o=n)if(o.hasOwnProperty(r)){var l=o[r];"style"===r?Mf(t,l):"dangerouslySetInnerHTML"===r?null!=(l=l?l.__html:void 0)&&Sf(t,l):"children"===r?"string"==typeof l?("textarea"!==s||""!==l)&&Cf(t,l):"number"==typeof l&&Cf(t,""+l):"suppressContentEditableWarning"!==r&&"suppressHydrationWarning"!==r&&"autoFocus"!==r&&(vp.hasOwnProperty(r)?null!=l&&"onScroll"===r&&Y_("scroll",t):null!=l&&kp(t,r,l,a))}switch(s){case"input":nf(t),df(t,i,!1);break;case"textarea":nf(t),vf(t);break;case"option":null!=i.value&&t.setAttribute("value",""+ef(i.value));break;case"select":t.multiple=!!i.multiple,null!=(r=i.value)?ff(t,!!i.multiple,r,!1):null!=i.defaultValue&&ff(t,!!i.multiple,i.defaultValue,!0);break;default:"function"==typeof n.onClick&&(t.onclick=cv)}switch(s){case"button":case"input":case"select":case"textarea":i=!!i.autoFocus;break t;case"img":i=!0;break t;default:i=!1}}i&&(e.flags|=4)}null!==e.ref&&(e.flags|=512,e.flags|=2097152)}return iw(e),null;case 6:if(t&&null!=e.stateNode)jx(t,e,t.memoizedProps,i);else{if("string"!=typeof i&&null===e.stateNode)throw Error(gp(166));if(s=py(uy.current),py(cy.current),wb(e)){if(i=e.stateNode,s=e.memoizedProps,i[Sv]=e,(r=i.nodeValue!==s)&&null!==(t=pb))switch(t.tag){case 3:hv(i.nodeValue,s,0!=(1&t.mode));break;case 5:!0!==t.memoizedProps.suppressHydrationWarning&&hv(i.nodeValue,s,0!=(1&t.mode))}r&&(e.flags|=4)}else(i=(9===s.nodeType?s:s.ownerDocument).createTextNode(i))[Sv]=e,e.stateNode=i}return iw(e),null;case 13:if(Fv(vy),i=e.memoizedState,null===t||null!==t.memoizedState&&null!==t.memoizedState.dehydrated){if(mb&&null!==fb&&0!=(1&e.mode)&&0==(128&e.flags))Sb(),Cb(),e.flags|=98560,r=!1;else if(r=wb(e),null!==i&&null!==i.dehydrated){if(null===t){if(!r)throw Error(gp(318));if(!(r=null!==(r=e.memoizedState)?r.dehydrated:null))throw Error(gp(317));r[Sv]=e}else Cb(),0==(128&e.flags)&&(e.memoizedState=null),e.flags|=4;iw(e),r=!1}else null!==gb&&(_S(gb),gb=null),r=!0;if(!r)return 65536&e.flags?e:null}return 0!=(128&e.flags)?(e.lanes=s,e):((i=null!==i)!==(null!==t&&null!==t.memoizedState)&&i&&(e.child.flags|=8192,0!=(1&e.mode)&&(null===t||0!=(1&vy.current)?0===jw&&(jw=3):ES())),null!==e.updateQueue&&(e.flags|=4),iw(e),null);case 4:return my(),Gx(t,e),null===t&&Z_(e.stateNode.containerInfo),iw(e),null;case 10:return Lb(e.type._context),iw(e),null;case 19:if(Fv(vy),null===(r=e.memoizedState))return iw(e),null;if(i=0!=(128&e.flags),null===(a=r.rendering))if(i)sw(r,!1);else{if(0!==jw||null!==t&&0!=(128&t.flags))for(t=e.child;null!==t;){if(null!==(a=by(t))){for(e.flags|=128,sw(r,!1),null!==(i=a.updateQueue)&&(e.updateQueue=i,e.flags|=4),e.subtreeFlags=0,i=s,s=e.child;null!==s;)t=i,(r=s).flags&=14680066,null===(a=r.alternate)?(r.childLanes=0,r.lanes=t,r.child=null,r.subtreeFlags=0,r.memoizedProps=null,r.memoizedState=null,r.updateQueue=null,r.dependencies=null,r.stateNode=null):(r.childLanes=a.childLanes,r.lanes=a.lanes,r.child=a.child,r.subtreeFlags=0,r.deletions=null,r.memoizedProps=a.memoizedProps,r.memoizedState=a.memoizedState,r.updateQueue=a.updateQueue,r.type=a.type,t=a.dependencies,r.dependencies=null===t?null:{lanes:t.lanes,firstContext:t.firstContext}),s=s.sibling;return Bv(vy,1&vy.current|2),e.child}t=t.sibling}null!==r.tail&&hm()>Zw&&(e.flags|=128,i=!0,sw(r,!1),e.lanes=4194304)}else{if(!i)if(null!==(t=by(a))){if(e.flags|=128,i=!0,null!==(s=t.updateQueue)&&(e.updateQueue=s,e.flags|=4),sw(r,!0),null===r.tail&&"hidden"===r.tailMode&&!a.alternate&&!mb)return iw(e),null}else 2*hm()-r.renderingStartTime>Zw&&1073741824!==s&&(e.flags|=128,i=!0,sw(r,!1),e.lanes=4194304);r.isBackwards?(a.sibling=e.child,e.child=a):(null!==(s=r.last)?s.sibling=a:e.child=a,r.last=a)}return null!==r.tail?(e=r.tail,r.rendering=e,r.tail=e.sibling,r.renderingStartTime=hm(),e.sibling=null,s=vy.current,Bv(vy,i?1&s|2:1&s),e):(iw(e),null);case 22:case 23:return wS(),i=null!==e.memoizedState,null!==t&&null!==t.memoizedState!==i&&(e.flags|=8192),i&&0!=(1&e.mode)?0!=(1073741824&Gw)&&(iw(e),6&e.subtreeFlags&&(e.flags|=8192)):iw(e),null;case 24:case 25:return null}throw Error(gp(156,e.tag))}function rw(t,e){switch(ub(e),e.tag){case 1:return Gv(e.type)&&Wv(),65536&(t=e.flags)?(e.flags=-65537&t|128,e):null;case 3:return my(),Fv(Uv),Fv(Nv),xy(),0!=(65536&(t=e.flags))&&0==(128&t)?(e.flags=-65537&t|128,e):null;case 5:return _y(e),null;case 13:if(Fv(vy),null!==(t=e.memoizedState)&&null!==t.dehydrated){if(null===e.alternate)throw Error(gp(340));Cb()}return 65536&(t=e.flags)?(e.flags=-65537&t|128,e):null;case 19:return Fv(vy),null;case 4:return my(),null;case 10:return Lb(e.type._context),null;case 22:case 23:return wS(),null;default:return null}}Hx=function(t,e){for(var s=e.child;null!==s;){if(5===s.tag||6===s.tag)t.appendChild(s.stateNode);else if(4!==s.tag&&null!==s.child){s.child.return=s,s=s.child;continue}if(s===e)break;for(;null===s.sibling;){if(null===s.return||s.return===e)return;s=s.return}s.sibling.return=s.return,s=s.sibling}},Gx=function(){},Wx=function(t,e,s,i){var n=t.memoizedProps;if(n!==i){t=e.stateNode,py(cy.current);var r,a=null;switch(s){case"input":n=of(t,n),i=of(t,i),a=[];break;case"select":n=$p({},n,{value:void 0}),i=$p({},i,{value:void 0}),a=[];break;case"textarea":n=mf(t,n),i=mf(t,i),a=[];break;default:"function"!=typeof n.onClick&&"function"==typeof i.onClick&&(t.onclick=cv)}for(h in kf(s,i),s=null,n)if(!i.hasOwnProperty(h)&&n.hasOwnProperty(h)&&null!=n[h])if("style"===h){var o=n[h];for(r in o)o.hasOwnProperty(r)&&(s||(s={}),s[r]="")}else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(vp.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in i){var l=i[h];if(o=null!=n?n[h]:void 0,i.hasOwnProperty(h)&&l!==o&&(null!=l||null!=o))if("style"===h)if(o){for(r in o)!o.hasOwnProperty(r)||l&&l.hasOwnProperty(r)||(s||(s={}),s[r]="");for(r in l)l.hasOwnProperty(r)&&o[r]!==l[r]&&(s||(s={}),s[r]=l[r])}else s||(a||(a=[]),a.push(h,s)),s=l;else"dangerouslySetInnerHTML"===h?(l=l?l.__html:void 0,o=o?o.__html:void 0,null!=l&&o!==l&&(a=a||[]).push(h,l)):"children"===h?"string"!=typeof l&&"number"!=typeof l||(a=a||[]).push(h,""+l):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(vp.hasOwnProperty(h)?(null!=l&&"onScroll"===h&&Y_("scroll",t),a||o===l||(a=[])):(a=a||[]).push(h,l))}s&&(a=a||[]).push("style",s);var h=a;(e.updateQueue=h)&&(e.flags|=4)}},jx=function(t,e,s,i){s!==i&&(e.flags|=4)};var aw=!1,ow=!1,lw="function"==typeof WeakSet?WeakSet:Set,hw=null;function cw(t,e){var s=t.ref;if(null!==s)if("function"==typeof s)try{s(null)}catch(s){OS(t,e,s)}else s.current=null}function dw(t,e,s){try{s()}catch(s){OS(t,e,s)}}var uw=!1;function pw(t,e,s){var i=e.updateQueue;if(null!==(i=null!==i?i.lastEffect:null)){var n=i=i.next;do{if((n.tag&t)===t){var r=n.destroy;n.destroy=void 0,void 0!==r&&dw(e,s,r)}n=n.next}while(n!==i)}}function fw(t,e){if(null!==(e=null!==(e=e.updateQueue)?e.lastEffect:null)){var s=e=e.next;do{if((s.tag&t)===t){var i=s.create;s.destroy=i()}s=s.next}while(s!==e)}}function mw(t){var e=t.ref;if(null!==e){var s=t.stateNode;t.tag,t=s,"function"==typeof e?e(t):e.current=t}}function gw(t){var e=t.alternate;null!==e&&(t.alternate=null,gw(e)),t.child=null,t.deletions=null,t.sibling=null,5===t.tag&&(null!==(e=t.stateNode)&&(delete e[Sv],delete e[Cv],delete e[Ev],delete e[Pv],delete e[Mv])),t.stateNode=null,t.return=null,t.dependencies=null,t.memoizedProps=null,t.memoizedState=null,t.pendingProps=null,t.stateNode=null,t.updateQueue=null}function _w(t){return 5===t.tag||3===t.tag||4===t.tag}function vw(t){t:for(;;){for(;null===t.sibling;){if(null===t.return||_w(t.return))return null;t=t.return}for(t.sibling.return=t.return,t=t.sibling;5!==t.tag&&6!==t.tag&&18!==t.tag;){if(2&t.flags)continue t;if(null===t.child||4===t.tag)continue t;t.child.return=t,t=t.child}if(!(2&t.flags))return t.stateNode}}function bw(t,e,s){var i=t.tag;if(5===i||6===i)t=t.stateNode,e?8===s.nodeType?s.parentNode.insertBefore(t,e):s.insertBefore(t,e):(8===s.nodeType?(e=s.parentNode).insertBefore(t,s):(e=s).appendChild(t),null!=(s=s._reactRootContainer)||null!==e.onclick||(e.onclick=cv));else if(4!==i&&null!==(t=t.child))for(bw(t,e,s),t=t.sibling;null!==t;)bw(t,e,s),t=t.sibling}function yw(t,e,s){var i=t.tag;if(5===i||6===i)t=t.stateNode,e?s.insertBefore(t,e):s.appendChild(t);else if(4!==i&&null!==(t=t.child))for(yw(t,e,s),t=t.sibling;null!==t;)yw(t,e,s),t=t.sibling}var xw=null,ww=!1;function Sw(t,e,s){for(s=s.child;null!==s;)Cw(t,e,s),s=s.sibling}function Cw(t,e,s){if(_m&&"function"==typeof _m.onCommitFiberUnmount)try{_m.onCommitFiberUnmount(gm,s)}catch(t){}switch(s.tag){case 5:ow||cw(s,e);case 6:var i=xw,n=ww;xw=null,Sw(t,e,s),ww=n,null!==(xw=i)&&(ww?(t=xw,s=s.stateNode,8===t.nodeType?t.parentNode.removeChild(s):t.removeChild(s)):xw.removeChild(s.stateNode));break;case 18:null!==xw&&(ww?(t=xw,s=s.stateNode,8===t.nodeType?bv(t.parentNode,s):1===t.nodeType&&bv(t,s),tg(t)):bv(xw,s.stateNode));break;case 4:i=xw,n=ww,xw=s.stateNode.containerInfo,ww=!0,Sw(t,e,s),xw=i,ww=n;break;case 0:case 11:case 14:case 15:if(!ow&&(null!==(i=s.updateQueue)&&null!==(i=i.lastEffect))){n=i=i.next;do{var r=n,a=r.destroy;r=r.tag,void 0!==a&&(0!=(2&r)||0!=(4&r))&&dw(s,e,a),n=n.next}while(n!==i)}Sw(t,e,s);break;case 1:if(!ow&&(cw(s,e),"function"==typeof(i=s.stateNode).componentWillUnmount))try{i.props=s.memoizedProps,i.state=s.memoizedState,i.componentWillUnmount()}catch(t){OS(s,e,t)}Sw(t,e,s);break;case 21:Sw(t,e,s);break;case 22:1&s.mode?(ow=(i=ow)||null!==s.memoizedState,Sw(t,e,s),ow=i):Sw(t,e,s);break;default:Sw(t,e,s)}}function Tw(t){var e=t.updateQueue;if(null!==e){t.updateQueue=null;var s=t.stateNode;null===s&&(s=t.stateNode=new lw),e.forEach((function(e){var i=NS.bind(null,t,e);s.has(e)||(s.add(e),e.then(i,i))}))}}function Ew(t,e){var s=e.deletions;if(null!==s)for(var i=0;i<s.length;i++){var n=s[i];try{var r=t,a=e,o=a;t:for(;null!==o;){switch(o.tag){case 5:xw=o.stateNode,ww=!1;break t;case 3:case 4:xw=o.stateNode.containerInfo,ww=!0;break t}o=o.return}if(null===xw)throw Error(gp(160));Cw(r,a,n),xw=null,ww=!1;var l=n.alternate;null!==l&&(l.return=null),n.return=null}catch(t){OS(n,e,t)}}if(12854&e.subtreeFlags)for(e=e.child;null!==e;)Pw(e,t),e=e.sibling}function Pw(t,e){var s=t.alternate,i=t.flags;switch(t.tag){case 0:case 11:case 14:case 15:if(Ew(e,t),Mw(t),4&i){try{pw(3,t,t.return),fw(3,t)}catch(e){OS(t,t.return,e)}try{pw(5,t,t.return)}catch(e){OS(t,t.return,e)}}break;case 1:Ew(e,t),Mw(t),512&i&&null!==s&&cw(s,s.return);break;case 5:if(Ew(e,t),Mw(t),512&i&&null!==s&&cw(s,s.return),32&t.flags){var n=t.stateNode;try{Cf(n,"")}catch(e){OS(t,t.return,e)}}if(4&i&&null!=(n=t.stateNode)){var r=t.memoizedProps,a=null!==s?s.memoizedProps:r,o=t.type,l=t.updateQueue;if(t.updateQueue=null,null!==l)try{"input"===o&&"radio"===r.type&&null!=r.name&&hf(n,r),Df(o,a);var h=Df(o,r);for(a=0;a<l.length;a+=2){var c=l[a],d=l[a+1];"style"===c?Mf(n,d):"dangerouslySetInnerHTML"===c?Sf(n,d):"children"===c?Cf(n,d):kp(n,c,d,h)}switch(o){case"input":cf(n,r);break;case"textarea":_f(n,r);break;case"select":var u=n._wrapperState.wasMultiple;n._wrapperState.wasMultiple=!!r.multiple;var p=r.value;null!=p?ff(n,!!r.multiple,p,!1):u!==!!r.multiple&&(null!=r.defaultValue?ff(n,!!r.multiple,r.defaultValue,!0):ff(n,!!r.multiple,r.multiple?[]:"",!1))}n[Cv]=r}catch(e){OS(t,t.return,e)}}break;case 6:if(Ew(e,t),Mw(t),4&i){if(null===t.stateNode)throw Error(gp(162));n=t.stateNode,r=t.memoizedProps;try{n.nodeValue=r}catch(e){OS(t,t.return,e)}}break;case 3:if(Ew(e,t),Mw(t),4&i&&null!==s&&s.memoizedState.isDehydrated)try{tg(e.containerInfo)}catch(e){OS(t,t.return,e)}break;case 4:default:Ew(e,t),Mw(t);break;case 13:Ew(e,t),Mw(t),8192&(n=t.child).flags&&(r=null!==n.memoizedState,n.stateNode.isHidden=r,!r||null!==n.alternate&&null!==n.alternate.memoizedState||(Jw=hm())),4&i&&Tw(t);break;case 22:if(c=null!==s&&null!==s.memoizedState,1&t.mode?(ow=(h=ow)||c,Ew(e,t),ow=h):Ew(e,t),Mw(t),8192&i){if(h=null!==t.memoizedState,(t.stateNode.isHidden=h)&&!c&&0!=(1&t.mode))for(hw=t,c=t.child;null!==c;){for(d=hw=c;null!==hw;){switch(p=(u=hw).child,u.tag){case 0:case 11:case 14:case 15:pw(4,u,u.return);break;case 1:cw(u,u.return);var f=u.stateNode;if("function"==typeof f.componentWillUnmount){i=u,s=u.return;try{e=i,f.props=e.memoizedProps,f.state=e.memoizedState,f.componentWillUnmount()}catch(t){OS(i,s,t)}}break;case 5:cw(u,u.return);break;case 22:if(null!==u.memoizedState){Rw(d);continue}}null!==p?(p.return=u,hw=p):Rw(d)}c=c.sibling}t:for(c=null,d=t;;){if(5===d.tag){if(null===c){c=d;try{n=d.stateNode,h?"function"==typeof(r=n.style).setProperty?r.setProperty("display","none","important"):r.display="none":(o=d.stateNode,a=null!=(l=d.memoizedProps.style)&&l.hasOwnProperty("display")?l.display:null,o.style.display=Pf("display",a))}catch(e){OS(t,t.return,e)}}}else if(6===d.tag){if(null===c)try{d.stateNode.nodeValue=h?"":d.memoizedProps}catch(e){OS(t,t.return,e)}}else if((22!==d.tag&&23!==d.tag||null===d.memoizedState||d===t)&&null!==d.child){d.child.return=d,d=d.child;continue}if(d===t)break t;for(;null===d.sibling;){if(null===d.return||d.return===t)break t;c===d&&(c=null),d=d.return}c===d&&(c=null),d.sibling.return=d.return,d=d.sibling}}break;case 19:Ew(e,t),Mw(t),4&i&&Tw(t);case 21:}}function Mw(t){var e=t.flags;if(2&e){try{t:{for(var s=t.return;null!==s;){if(_w(s)){var i=s;break t}s=s.return}throw Error(gp(160))}switch(i.tag){case 5:var n=i.stateNode;32&i.flags&&(Cf(n,""),i.flags&=-33),yw(t,vw(t),n);break;case 3:case 4:var r=i.stateNode.containerInfo;bw(t,vw(t),r);break;default:throw Error(gp(161))}}catch(e){OS(t,t.return,e)}t.flags&=-3}4096&e&&(t.flags&=-4097)}function Aw(t,e,s){hw=t,kw(t)}function kw(t,e,s){for(var i=0!=(1&t.mode);null!==hw;){var n=hw,r=n.child;if(22===n.tag&&i){var a=null!==n.memoizedState||aw;if(!a){var o=n.alternate,l=null!==o&&null!==o.memoizedState||ow;o=aw;var h=ow;if(aw=a,(ow=l)&&!h)for(hw=n;null!==hw;)l=(a=hw).child,22===a.tag&&null!==a.memoizedState?Lw(n):null!==l?(l.return=a,hw=l):Lw(n);for(;null!==r;)hw=r,kw(r),r=r.sibling;hw=n,aw=o,ow=h}Dw(t)}else 0!=(8772&n.subtreeFlags)&&null!==r?(r.return=n,hw=r):Dw(t)}}function Dw(t){for(;null!==hw;){var e=hw;if(0!=(8772&e.flags)){var s=e.alternate;try{if(0!=(8772&e.flags))switch(e.tag){case 0:case 11:case 15:ow||fw(5,e);break;case 1:var i=e.stateNode;if(4&e.flags&&!ow)if(null===s)i.componentDidMount();else{var n=e.elementType===e.type?s.memoizedProps:Pb(e.type,s.memoizedProps);i.componentDidUpdate(n,s.memoizedState,i.__reactInternalSnapshotBeforeUpdate)}var r=e.updateQueue;null!==r&&Kb(e,r,i);break;case 3:var a=e.updateQueue;if(null!==a){if(s=null,null!==e.child)switch(e.child.tag){case 5:case 1:s=e.child.stateNode}Kb(e,a,s)}break;case 5:var o=e.stateNode;if(null===s&&4&e.flags){s=o;var l=e.memoizedProps;switch(e.type){case"button":case"input":case"select":case"textarea":l.autoFocus&&s.focus();break;case"img":l.src&&(s.src=l.src)}}break;case 6:case 4:case 12:case 19:case 17:case 21:case 22:case 23:case 25:break;case 13:if(null===e.memoizedState){var h=e.alternate;if(null!==h){var c=h.memoizedState;if(null!==c){var d=c.dehydrated;null!==d&&tg(d)}}}break;default:throw Error(gp(163))}ow||512&e.flags&&mw(e)}catch(t){OS(e,e.return,t)}}if(e===t){hw=null;break}if(null!==(s=e.sibling)){s.return=e.return,hw=s;break}hw=e.return}}function Rw(t){for(;null!==hw;){var e=hw;if(e===t){hw=null;break}var s=e.sibling;if(null!==s){s.return=e.return,hw=s;break}hw=e.return}}function Lw(t){for(;null!==hw;){var e=hw;try{switch(e.tag){case 0:case 11:case 15:var s=e.return;try{fw(4,e)}catch(t){OS(e,s,t)}break;case 1:var i=e.stateNode;if("function"==typeof i.componentDidMount){var n=e.return;try{i.componentDidMount()}catch(t){OS(e,n,t)}}var r=e.return;try{mw(e)}catch(t){OS(e,r,t)}break;case 5:var a=e.return;try{mw(e)}catch(t){OS(e,a,t)}}}catch(t){OS(e,e.return,t)}if(e===t){hw=null;break}var o=e.sibling;if(null!==o){o.return=e.return,hw=o;break}hw=e.return}}var Iw,Ow=Math.ceil,Fw=Dp.ReactCurrentDispatcher,Bw=Dp.ReactCurrentOwner,zw=Dp.ReactCurrentBatchConfig,Nw=0,Uw=null,Vw=null,Hw=0,Gw=0,Ww=Ov(0),jw=0,qw=null,Xw=0,$w=0,Kw=0,Yw=null,Qw=null,Jw=0,Zw=1/0,tS=null,eS=!1,sS=null,iS=null,nS=!1,rS=null,aS=0,oS=0,lS=null,hS=-1,cS=0;function dS(){return 0!=(6&Nw)?hm():-1!==hS?hS:hS=hm()}function uS(t){return 0==(1&t.mode)?1:0!=(2&Nw)&&0!==Hw?Hw&-Hw:null!==Eb.transition?(0===cS&&(cS=Pm()),cS):0!==(t=Dm)?t:t=void 0===(t=window.event)?16:lg(t.type)}function pS(t,e,s,i){if(50<oS)throw oS=0,lS=null,Error(gp(185));Am(t,s,i),0!=(2&Nw)&&t===Uw||(t===Uw&&(0==(2&Nw)&&($w|=s),4===jw&&vS(t,Hw)),fS(t,i),1===s&&0===Nw&&0==(1&e.mode)&&(Zw=hm()+500,Yv&&Zv()))}function fS(t,e){var s=t.callbackNode;!function(t,e){for(var s=t.suspendedLanes,i=t.pingedLanes,n=t.expirationTimes,r=t.pendingLanes;0<r;){var a=31-vm(r),o=1<<a,l=n[a];-1===l?0!=(o&s)&&0==(o&i)||(n[a]=Tm(o,e)):l<=e&&(t.expiredLanes|=o),r&=~o}}(t,e);var i=Cm(t,t===Uw?Hw:0);if(0===i)null!==s&&am(s),t.callbackNode=null,t.callbackPriority=0;else if(e=i&-i,t.callbackPriority!==e){if(null!=s&&am(s),1===e)0===t.tag?function(t){Yv=!0,Jv(t)}(bS.bind(null,t)):Jv(bS.bind(null,t)),_v((function(){0==(6&Nw)&&Zv()})),s=null;else{switch(Rm(i)){case 1:s=dm;break;case 4:s=um;break;case 16:default:s=pm;break;case 536870912:s=mm}s=US(s,mS.bind(null,t))}t.callbackPriority=e,t.callbackNode=s}}function mS(t,e){if(hS=-1,cS=0,0!=(6&Nw))throw Error(gp(327));var s=t.callbackNode;if(LS()&&t.callbackNode!==s)return null;var i=Cm(t,t===Uw?Hw:0);if(0===i)return null;if(0!=(30&i)||0!=(i&t.expiredLanes)||e)e=PS(t,i);else{e=i;var n=Nw;Nw|=2;var r=TS();for(Uw===t&&Hw===e||(tS=null,Zw=hm()+500,SS(t,e));;)try{AS();break}catch(e){CS(t,e)}Rb(),Fw.current=r,Nw=n,null!==Vw?e=0:(Uw=null,Hw=0,e=jw)}if(0!==e){if(2===e&&(0!==(n=Em(t))&&(i=n,e=gS(t,n))),1===e)throw s=qw,SS(t,0),vS(t,i),fS(t,hm()),s;if(6===e)vS(t,i);else{if(n=t.current.alternate,0==(30&i)&&!function(t){for(var e=t;;){if(16384&e.flags){var s=e.updateQueue;if(null!==s&&null!==(s=s.stores))for(var i=0;i<s.length;i++){var n=s[i],r=n.getSnapshot;n=n.value;try{if(!v_(r(),n))return!1}catch(t){return!1}}}if(s=e.child,16384&e.subtreeFlags&&null!==s)s.return=e,e=s;else{if(e===t)break;for(;null===e.sibling;){if(null===e.return||e.return===t)return!0;e=e.return}e.sibling.return=e.return,e=e.sibling}}return!0}(n)&&(2===(e=PS(t,i))&&(0!==(r=Em(t))&&(i=r,e=gS(t,r))),1===e))throw s=qw,SS(t,0),vS(t,i),fS(t,hm()),s;switch(t.finishedWork=n,t.finishedLanes=i,e){case 0:case 1:throw Error(gp(345));case 2:case 5:RS(t,Qw,tS);break;case 3:if(vS(t,i),(130023424&i)===i&&10<(e=Jw+500-hm())){if(0!==Cm(t,0))break;if(((n=t.suspendedLanes)&i)!==i){dS(),t.pingedLanes|=t.suspendedLanes&n;break}t.timeoutHandle=fv(RS.bind(null,t,Qw,tS),e);break}RS(t,Qw,tS);break;case 4:if(vS(t,i),(4194240&i)===i)break;for(e=t.eventTimes,n=-1;0<i;){var a=31-vm(i);r=1<<a,(a=e[a])>n&&(n=a),i&=~r}if(i=n,10<(i=(120>(i=hm()-i)?120:480>i?480:1080>i?1080:1920>i?1920:3e3>i?3e3:4320>i?4320:1960*Ow(i/1960))-i)){t.timeoutHandle=fv(RS.bind(null,t,Qw,tS),i);break}RS(t,Qw,tS);break;default:throw Error(gp(329))}}}return fS(t,hm()),t.callbackNode===s?mS.bind(null,t):null}function gS(t,e){var s=Yw;return t.current.memoizedState.isDehydrated&&(SS(t,e).flags|=256),2!==(t=PS(t,e))&&(e=Qw,Qw=s,null!==e&&_S(e)),t}function _S(t){null===Qw?Qw=t:Qw.push.apply(Qw,t)}function vS(t,e){for(e&=~Kw,e&=~$w,t.suspendedLanes|=e,t.pingedLanes&=~e,t=t.expirationTimes;0<e;){var s=31-vm(e),i=1<<s;t[s]=-1,e&=~i}}function bS(t){if(0!=(6&Nw))throw Error(gp(327));LS();var e=Cm(t,0);if(0==(1&e))return fS(t,hm()),null;var s=PS(t,e);if(0!==t.tag&&2===s){var i=Em(t);0!==i&&(e=i,s=gS(t,i))}if(1===s)throw s=qw,SS(t,0),vS(t,e),fS(t,hm()),s;if(6===s)throw Error(gp(345));return t.finishedWork=t.current.alternate,t.finishedLanes=e,RS(t,Qw,tS),fS(t,hm()),null}function yS(t,e){var s=Nw;Nw|=1;try{return t(e)}finally{0===(Nw=s)&&(Zw=hm()+500,Yv&&Zv())}}function xS(t){null!==rS&&0===rS.tag&&0==(6&Nw)&&LS();var e=Nw;Nw|=1;var s=zw.transition,i=Dm;try{if(zw.transition=null,Dm=1,t)return t()}finally{Dm=i,zw.transition=s,0==(6&(Nw=e))&&Zv()}}function wS(){Gw=Ww.current,Fv(Ww)}function SS(t,e){t.finishedWork=null,t.finishedLanes=0;var s=t.timeoutHandle;if(-1!==s&&(t.timeoutHandle=-1,mv(s)),null!==Vw)for(s=Vw.return;null!==s;){var i=s;switch(ub(i),i.tag){case 1:null!=(i=i.type.childContextTypes)&&Wv();break;case 3:my(),Fv(Uv),Fv(Nv),xy();break;case 5:_y(i);break;case 4:my();break;case 13:case 19:Fv(vy);break;case 10:Lb(i.type._context);break;case 22:case 23:wS()}s=s.return}if(Uw=t,Vw=t=WS(t.current,null),Hw=Gw=e,jw=0,qw=null,Kw=$w=Xw=0,Qw=Yw=null,null!==Bb){for(e=0;e<Bb.length;e++)if(null!==(i=(s=Bb[e]).interleaved)){s.interleaved=null;var n=i.next,r=s.pending;if(null!==r){var a=r.next;r.next=n,i.next=a}s.pending=i}Bb=null}return t}function CS(t,e){for(;;){var s=Vw;try{if(Rb(),wy.current=gx,My){for(var i=Ty.memoizedState;null!==i;){var n=i.queue;null!==n&&(n.pending=null),i=i.next}My=!1}if(Cy=0,Py=Ey=Ty=null,Ay=!1,ky=0,Bw.current=null,null===s||null===s.return){jw=1,qw=e,Vw=null;break}t:{var r=t,a=s.return,o=s,l=e;if(e=Hw,o.flags|=32768,null!==l&&"object"==typeof l&&"function"==typeof l.then){var h=l,c=o,d=c.tag;if(0==(1&c.mode)&&(0===d||11===d||15===d)){var u=c.alternate;u?(c.updateQueue=u.updateQueue,c.memoizedState=u.memoizedState,c.lanes=u.lanes):(c.updateQueue=null,c.memoizedState=null)}var p=Px(a);if(null!==p){p.flags&=-257,Mx(p,a,o,0,e),1&p.mode&&Ex(r,h,e),l=h;var f=(e=p).updateQueue;if(null===f){var m=new Set;m.add(l),e.updateQueue=m}else f.add(l);break t}if(0==(1&e)){Ex(r,h,e),ES();break t}l=Error(gp(426))}else if(mb&&1&o.mode){var g=Px(a);if(null!==g){0==(65536&g.flags)&&(g.flags|=256),Mx(g,a,o,0,e),Tb(yx(l,o));break t}}r=l=yx(l,o),4!==jw&&(jw=2),null===Yw?Yw=[r]:Yw.push(r),r=a;do{switch(r.tag){case 3:r.flags|=65536,e&=-e,r.lanes|=e,Xb(r,Cx(0,l,e));break t;case 1:o=l;var _=r.type,v=r.stateNode;if(0==(128&r.flags)&&("function"==typeof _.getDerivedStateFromError||null!==v&&"function"==typeof v.componentDidCatch&&(null===iS||!iS.has(v)))){r.flags|=65536,e&=-e,r.lanes|=e,Xb(r,Tx(r,o,e));break t}}r=r.return}while(null!==r)}DS(s)}catch(t){e=t,Vw===s&&null!==s&&(Vw=s=s.return);continue}break}}function TS(){var t=Fw.current;return Fw.current=gx,null===t?gx:t}function ES(){0!==jw&&3!==jw&&2!==jw||(jw=4),null===Uw||0==(268435455&Xw)&&0==(268435455&$w)||vS(Uw,Hw)}function PS(t,e){var s=Nw;Nw|=2;var i=TS();for(Uw===t&&Hw===e||(tS=null,SS(t,e));;)try{MS();break}catch(e){CS(t,e)}if(Rb(),Nw=s,Fw.current=i,null!==Vw)throw Error(gp(261));return Uw=null,Hw=0,jw}function MS(){for(;null!==Vw;)kS(Vw)}function AS(){for(;null!==Vw&&!om();)kS(Vw)}function kS(t){var e=Iw(t.alternate,t,Gw);t.memoizedProps=t.pendingProps,null===e?DS(t):Vw=e,Bw.current=null}function DS(t){var e=t;do{var s=e.alternate;if(t=e.return,0==(32768&e.flags)){if(null!==(s=nw(s,e,Gw)))return void(Vw=s)}else{if(null!==(s=rw(s,e)))return s.flags&=32767,void(Vw=s);if(null===t)return jw=6,void(Vw=null);t.flags|=32768,t.subtreeFlags=0,t.deletions=null}if(null!==(e=e.sibling))return void(Vw=e);Vw=e=t}while(null!==e);0===jw&&(jw=5)}function RS(t,e,s){var i=Dm,n=zw.transition;try{zw.transition=null,Dm=1,function(t,e,s,i){do{LS()}while(null!==rS);if(0!=(6&Nw))throw Error(gp(327));s=t.finishedWork;var n=t.finishedLanes;if(null===s)return null;if(t.finishedWork=null,t.finishedLanes=0,s===t.current)throw Error(gp(177));t.callbackNode=null,t.callbackPriority=0;var r=s.lanes|s.childLanes;if(function(t,e){var s=t.pendingLanes&~e;t.pendingLanes=e,t.suspendedLanes=0,t.pingedLanes=0,t.expiredLanes&=e,t.mutableReadLanes&=e,t.entangledLanes&=e,e=t.entanglements;var i=t.eventTimes;for(t=t.expirationTimes;0<s;){var n=31-vm(s),r=1<<n;e[n]=0,i[n]=-1,t[n]=-1,s&=~r}}(t,r),t===Uw&&(Vw=Uw=null,Hw=0),0==(2064&s.subtreeFlags)&&0==(2064&s.flags)||nS||(nS=!0,US(pm,(function(){return LS(),null}))),r=0!=(15990&s.flags),0!=(15990&s.subtreeFlags)||r){r=zw.transition,zw.transition=null;var a=Dm;Dm=1;var o=Nw;Nw|=4,Bw.current=null,function(t,e){if(dv=sg,C_(t=S_())){if("selectionStart"in t)var s={start:t.selectionStart,end:t.selectionEnd};else{var i=(s=(s=t.ownerDocument)&&s.defaultView||window).getSelection&&s.getSelection();if(i&&0!==i.rangeCount){s=i.anchorNode;var n=i.anchorOffset,r=i.focusNode;i=i.focusOffset;var a=0,o=-1,l=-1,h=0,c=0,d=t,u=null;t:for(;;){for(var p;d!==s||0!==n&&3!==d.nodeType||(o=a+n),d!==r||0!==i&&3!==d.nodeType||(l=a+i),3===d.nodeType&&(a+=d.nodeValue.length),null!==(p=d.firstChild);)u=d,d=p;for(;;){if(d===t)break t;if(u===s&&++h===n&&(o=a),u===r&&++c===i&&(l=a),null!==(p=d.nextSibling))break;u=(d=u).parentNode}d=p}s=-1===o||-1===l?null:{start:o,end:l}}else s=null}s=s||{start:0,end:0}}else s=null;for(uv={focusedElem:t,selectionRange:s},sg=!1,hw=e;null!==hw;)if(t=(e=hw).child,0!=(1028&e.subtreeFlags)&&null!==t)t.return=e,hw=t;else for(;null!==hw;){e=hw;try{var f=e.alternate;if(0!=(1024&e.flags))switch(e.tag){case 0:case 11:case 15:case 5:case 6:case 4:case 17:break;case 1:if(null!==f){var m=f.memoizedProps,g=f.memoizedState,_=e.stateNode,v=_.getSnapshotBeforeUpdate(e.elementType===e.type?m:Pb(e.type,m),g);_.__reactInternalSnapshotBeforeUpdate=v}break;case 3:var b=e.stateNode.containerInfo;1===b.nodeType?b.textContent="":9===b.nodeType&&b.documentElement&&b.removeChild(b.documentElement);break;default:throw Error(gp(163))}}catch(t){OS(e,e.return,t)}if(null!==(t=e.sibling)){t.return=e.return,hw=t;break}hw=e.return}f=uw,uw=!1}(t,s),Pw(s,t),T_(uv),sg=!!dv,uv=dv=null,t.current=s,Aw(s),lm(),Nw=o,Dm=a,zw.transition=r}else t.current=s;if(nS&&(nS=!1,rS=t,aS=n),r=t.pendingLanes,0===r&&(iS=null),function(t){if(_m&&"function"==typeof _m.onCommitFiberRoot)try{_m.onCommitFiberRoot(gm,t,void 0,128==(128&t.current.flags))}catch(t){}}(s.stateNode),fS(t,hm()),null!==e)for(i=t.onRecoverableError,s=0;s<e.length;s++)n=e[s],i(n.value,{componentStack:n.stack,digest:n.digest});if(eS)throw eS=!1,t=sS,sS=null,t;0!=(1&aS)&&0!==t.tag&&LS(),r=t.pendingLanes,0!=(1&r)?t===lS?oS++:(oS=0,lS=t):oS=0,Zv()}(t,e,s,i)}finally{zw.transition=n,Dm=i}return null}function LS(){if(null!==rS){var t=Rm(aS),e=zw.transition,s=Dm;try{if(zw.transition=null,Dm=16>t?16:t,null===rS)var i=!1;else{if(t=rS,rS=null,aS=0,0!=(6&Nw))throw Error(gp(331));var n=Nw;for(Nw|=4,hw=t.current;null!==hw;){var r=hw,a=r.child;if(0!=(16&hw.flags)){var o=r.deletions;if(null!==o){for(var l=0;l<o.length;l++){var h=o[l];for(hw=h;null!==hw;){var c=hw;switch(c.tag){case 0:case 11:case 15:pw(8,c,r)}var d=c.child;if(null!==d)d.return=c,hw=d;else for(;null!==hw;){var u=(c=hw).sibling,p=c.return;if(gw(c),c===h){hw=null;break}if(null!==u){u.return=p,hw=u;break}hw=p}}}var f=r.alternate;if(null!==f){var m=f.child;if(null!==m){f.child=null;do{var g=m.sibling;m.sibling=null,m=g}while(null!==m)}}hw=r}}if(0!=(2064&r.subtreeFlags)&&null!==a)a.return=r,hw=a;else t:for(;null!==hw;){if(0!=(2048&(r=hw).flags))switch(r.tag){case 0:case 11:case 15:pw(9,r,r.return)}var _=r.sibling;if(null!==_){_.return=r.return,hw=_;break t}hw=r.return}}var v=t.current;for(hw=v;null!==hw;){var b=(a=hw).child;if(0!=(2064&a.subtreeFlags)&&null!==b)b.return=a,hw=b;else t:for(a=v;null!==hw;){if(0!=(2048&(o=hw).flags))try{switch(o.tag){case 0:case 11:case 15:fw(9,o)}}catch(t){OS(o,o.return,t)}if(o===a){hw=null;break t}var y=o.sibling;if(null!==y){y.return=o.return,hw=y;break t}hw=o.return}}if(Nw=n,Zv(),_m&&"function"==typeof _m.onPostCommitFiberRoot)try{_m.onPostCommitFiberRoot(gm,t)}catch(t){}i=!0}return i}finally{Dm=s,zw.transition=e}}return!1}function IS(t,e,s){t=jb(t,e=Cx(0,e=yx(s,e),1),1),e=dS(),null!==t&&(Am(t,1,e),fS(t,e))}function OS(t,e,s){if(3===t.tag)IS(t,t,s);else for(;null!==e;){if(3===e.tag){IS(e,t,s);break}if(1===e.tag){var i=e.stateNode;if("function"==typeof e.type.getDerivedStateFromError||"function"==typeof i.componentDidCatch&&(null===iS||!iS.has(i))){e=jb(e,t=Tx(e,t=yx(s,t),1),1),t=dS(),null!==e&&(Am(e,1,t),fS(e,t));break}}e=e.return}}function FS(t,e,s){var i=t.pingCache;null!==i&&i.delete(e),e=dS(),t.pingedLanes|=t.suspendedLanes&s,Uw===t&&(Hw&s)===s&&(4===jw||3===jw&&(130023424&Hw)===Hw&&500>hm()-Jw?SS(t,0):Kw|=s),fS(t,e)}function BS(t,e){0===e&&(0==(1&t.mode)?e=1:(e=wm,0==(130023424&(wm<<=1))&&(wm=4194304)));var s=dS();null!==(t=Ub(t,e))&&(Am(t,e,s),fS(t,s))}function zS(t){var e=t.memoizedState,s=0;null!==e&&(s=e.retryLane),BS(t,s)}function NS(t,e){var s=0;switch(t.tag){case 13:var i=t.stateNode,n=t.memoizedState;null!==n&&(s=n.retryLane);break;case 19:i=t.stateNode;break;default:throw Error(gp(314))}null!==i&&i.delete(e),BS(t,s)}function US(t,e){return rm(t,e)}function VS(t,e,s,i){this.tag=t,this.key=s,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=e,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=i,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function HS(t,e,s,i){return new VS(t,e,s,i)}function GS(t){return!(!(t=t.prototype)||!t.isReactComponent)}function WS(t,e){var s=t.alternate;return null===s?((s=HS(t.tag,e,t.key,t.mode)).elementType=t.elementType,s.type=t.type,s.stateNode=t.stateNode,s.alternate=t,t.alternate=s):(s.pendingProps=e,s.type=t.type,s.flags=0,s.subtreeFlags=0,s.deletions=null),s.flags=14680064&t.flags,s.childLanes=t.childLanes,s.lanes=t.lanes,s.child=t.child,s.memoizedProps=t.memoizedProps,s.memoizedState=t.memoizedState,s.updateQueue=t.updateQueue,e=t.dependencies,s.dependencies=null===e?null:{lanes:e.lanes,firstContext:e.firstContext},s.sibling=t.sibling,s.index=t.index,s.ref=t.ref,s}function jS(t,e,s,i,n,r){var a=2;if(i=t,"function"==typeof t)GS(t)&&(a=1);else if("string"==typeof t)a=5;else t:switch(t){case Ip:return qS(s.children,n,r,e);case Op:a=8,n|=8;break;case Fp:return(t=HS(12,s,e,2|n)).elementType=Fp,t.lanes=r,t;case Up:return(t=HS(13,s,e,n)).elementType=Up,t.lanes=r,t;case Vp:return(t=HS(19,s,e,n)).elementType=Vp,t.lanes=r,t;case Wp:return XS(s,n,r,e);default:if("object"==typeof t&&null!==t)switch(t.$$typeof){case Bp:a=10;break t;case zp:a=9;break t;case Np:a=11;break t;case Hp:a=14;break t;case Gp:a=16,i=null;break t}throw Error(gp(130,null==t?t:typeof t,""))}return(e=HS(a,s,e,n)).elementType=t,e.type=i,e.lanes=r,e}function qS(t,e,s,i){return(t=HS(7,t,i,e)).lanes=s,t}function XS(t,e,s,i){return(t=HS(22,t,i,e)).elementType=Wp,t.lanes=s,t.stateNode={isHidden:!1},t}function $S(t,e,s){return(t=HS(6,t,null,e)).lanes=s,t}function KS(t,e,s){return(e=HS(4,null!==t.children?t.children:[],t.key,e)).lanes=s,e.stateNode={containerInfo:t.containerInfo,pendingChildren:null,implementation:t.implementation},e}function YS(t,e,s,i,n){this.tag=e,this.containerInfo=t,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=Mm(0),this.expirationTimes=Mm(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=Mm(0),this.identifierPrefix=i,this.onRecoverableError=n,this.mutableSourceEagerHydrationData=null}function QS(t,e,s,i,n,r,a,o,l){return t=new YS(t,e,s,o,l),1===e?(e=1,!0===r&&(e|=8)):e=0,r=HS(3,null,null,e),t.current=r,r.stateNode=t,r.memoizedState={element:i,isDehydrated:s,cache:null,transitions:null,pendingSuspenseBoundaries:null},Hb(r),t}function JS(t){if(!t)return zv;t:{if(tm(t=t._reactInternals)!==t||1!==t.tag)throw Error(gp(170));var e=t;do{switch(e.tag){case 3:e=e.stateNode.context;break t;case 1:if(Gv(e.type)){e=e.stateNode.__reactInternalMemoizedMergedChildContext;break t}}e=e.return}while(null!==e);throw Error(gp(171))}if(1===t.tag){var s=t.type;if(Gv(s))return qv(t,s,e)}return e}function ZS(t,e,s,i,n,r,a,o,l){return(t=QS(s,i,!0,t,0,r,0,o,l)).context=JS(null),s=t.current,(r=Wb(i=dS(),n=uS(s))).callback=null!=e?e:null,jb(s,r,n),t.current.lanes=n,Am(t,n,i),fS(t,i),t}function tC(t,e,s,i){var n=e.current,r=dS(),a=uS(n);return s=JS(s),null===e.context?e.context=s:e.pendingContext=s,(e=Wb(r,a)).payload={element:t},null!==(i=void 0===i?null:i)&&(e.callback=i),null!==(t=jb(n,e,a))&&(pS(t,n,a,r),qb(t,n,a)),a}function eC(t){return(t=t.current).child?(t.child.tag,t.child.stateNode):null}function sC(t,e){if(null!==(t=t.memoizedState)&&null!==t.dehydrated){var s=t.retryLane;t.retryLane=0!==s&&s<e?s:e}}function iC(t,e){sC(t,e),(t=t.alternate)&&sC(t,e)}Iw=function(t,e,s){if(null!==t)if(t.memoizedProps!==e.pendingProps||Uv.current)kx=!0;else{if(0==(t.lanes&s)&&0==(128&e.flags))return kx=!1,function(t,e,s){switch(e.tag){case 3:Ux(e),Cb();break;case 5:gy(e);break;case 1:Gv(e.type)&&Xv(e);break;case 4:fy(e,e.stateNode.containerInfo);break;case 10:var i=e.type._context,n=e.memoizedProps.value;Bv(Mb,i._currentValue),i._currentValue=n;break;case 13:if(null!==(i=e.memoizedState))return null!==i.dehydrated?(Bv(vy,1&vy.current),e.flags|=128,null):0!=(s&e.child.childLanes)?$x(t,e,s):(Bv(vy,1&vy.current),null!==(t=ew(t,e,s))?t.sibling:null);Bv(vy,1&vy.current);break;case 19:if(i=0!=(s&e.childLanes),0!=(128&t.flags)){if(i)return Zx(t,e,s);e.flags|=128}if(null!==(n=e.memoizedState)&&(n.rendering=null,n.tail=null,n.lastEffect=null),Bv(vy,vy.current),i)break;return null;case 22:case 23:return e.lanes=0,Ox(t,e,s)}return ew(t,e,s)}(t,e,s);kx=0!=(131072&t.flags)}else kx=!1,mb&&0!=(1048576&e.flags)&&cb(e,ib,e.index);switch(e.lanes=0,e.tag){case 2:var i=e.type;tw(t,e),t=e.pendingProps;var n=Hv(e,Nv.current);Ob(e,s),n=Iy(null,e,i,t,n,s);var r=Oy();return e.flags|=1,"object"==typeof n&&null!==n&&"function"==typeof n.render&&void 0===n.$$typeof?(e.tag=1,e.memoizedState=null,e.updateQueue=null,Gv(i)?(r=!0,Xv(e)):r=!1,e.memoizedState=null!==n.state&&void 0!==n.state?n.state:null,Hb(e),n.updater=Jb,e.stateNode=n,n._reactInternals=e,sy(e,i,t,s),e=Nx(null,e,i,!0,r,s)):(e.tag=0,mb&&r&&db(e),Dx(null,e,n,s),e=e.child),e;case 16:i=e.elementType;t:{switch(tw(t,e),t=e.pendingProps,i=(n=i._init)(i._payload),e.type=i,n=e.tag=function(t){if("function"==typeof t)return GS(t)?1:0;if(null!=t){if((t=t.$$typeof)===Np)return 11;if(t===Hp)return 14}return 2}(i),t=Pb(i,t),n){case 0:e=Bx(null,e,i,t,s);break t;case 1:e=zx(null,e,i,t,s);break t;case 11:e=Rx(null,e,i,t,s);break t;case 14:e=Lx(null,e,i,Pb(i.type,t),s);break t}throw Error(gp(306,i,""))}return e;case 0:return i=e.type,n=e.pendingProps,Bx(t,e,i,n=e.elementType===i?n:Pb(i,n),s);case 1:return i=e.type,n=e.pendingProps,zx(t,e,i,n=e.elementType===i?n:Pb(i,n),s);case 3:t:{if(Ux(e),null===t)throw Error(gp(387));i=e.pendingProps,n=(r=e.memoizedState).element,Gb(t,e),$b(e,i,null,s);var a=e.memoizedState;if(i=a.element,r.isDehydrated){if(r={element:i,isDehydrated:!1,cache:a.cache,pendingSuspenseBoundaries:a.pendingSuspenseBoundaries,transitions:a.transitions},e.updateQueue.baseState=r,e.memoizedState=r,256&e.flags){e=Vx(t,e,i,s,n=yx(Error(gp(423)),e));break t}if(i!==n){e=Vx(t,e,i,s,n=yx(Error(gp(424)),e));break t}for(fb=yv(e.stateNode.containerInfo.firstChild),pb=e,mb=!0,gb=null,s=ly(e,null,i,s),e.child=s;s;)s.flags=-3&s.flags|4096,s=s.sibling}else{if(Cb(),i===n){e=ew(t,e,s);break t}Dx(t,e,i,s)}e=e.child}return e;case 5:return gy(e),null===t&&yb(e),i=e.type,n=e.pendingProps,r=null!==t?t.memoizedProps:null,a=n.children,pv(i,n)?a=null:null!==r&&pv(i,r)&&(e.flags|=32),Fx(t,e),Dx(t,e,a,s),e.child;case 6:return null===t&&yb(e),null;case 13:return $x(t,e,s);case 4:return fy(e,e.stateNode.containerInfo),i=e.pendingProps,null===t?e.child=oy(e,null,i,s):Dx(t,e,i,s),e.child;case 11:return i=e.type,n=e.pendingProps,Rx(t,e,i,n=e.elementType===i?n:Pb(i,n),s);case 7:return Dx(t,e,e.pendingProps,s),e.child;case 8:case 12:return Dx(t,e,e.pendingProps.children,s),e.child;case 10:t:{if(i=e.type._context,n=e.pendingProps,r=e.memoizedProps,a=n.value,Bv(Mb,i._currentValue),i._currentValue=a,null!==r)if(v_(r.value,a)){if(r.children===n.children&&!Uv.current){e=ew(t,e,s);break t}}else for(null!==(r=e.child)&&(r.return=e);null!==r;){var o=r.dependencies;if(null!==o){a=r.child;for(var l=o.firstContext;null!==l;){if(l.context===i){if(1===r.tag){(l=Wb(-1,s&-s)).tag=2;var h=r.updateQueue;if(null!==h){var c=(h=h.shared).pending;null===c?l.next=l:(l.next=c.next,c.next=l),h.pending=l}}r.lanes|=s,null!==(l=r.alternate)&&(l.lanes|=s),Ib(r.return,s,e),o.lanes|=s;break}l=l.next}}else if(10===r.tag)a=r.type===e.type?null:r.child;else if(18===r.tag){if(null===(a=r.return))throw Error(gp(341));a.lanes|=s,null!==(o=a.alternate)&&(o.lanes|=s),Ib(a,s,e),a=r.sibling}else a=r.child;if(null!==a)a.return=r;else for(a=r;null!==a;){if(a===e){a=null;break}if(null!==(r=a.sibling)){r.return=a.return,a=r;break}a=a.return}r=a}Dx(t,e,n.children,s),e=e.child}return e;case 9:return n=e.type,i=e.pendingProps.children,Ob(e,s),i=i(n=Fb(n)),e.flags|=1,Dx(t,e,i,s),e.child;case 14:return n=Pb(i=e.type,e.pendingProps),Lx(t,e,i,n=Pb(i.type,n),s);case 15:return Ix(t,e,e.type,e.pendingProps,s);case 17:return i=e.type,n=e.pendingProps,n=e.elementType===i?n:Pb(i,n),tw(t,e),e.tag=1,Gv(i)?(t=!0,Xv(e)):t=!1,Ob(e,s),ty(e,i,n),sy(e,i,n,s),Nx(null,e,i,!0,t,s);case 19:return Zx(t,e,s);case 22:return Ox(t,e,s)}throw Error(gp(156,e.tag))};var nC="function"==typeof reportError?reportError:function(t){console.error(t)};function rC(t){this._internalRoot=t}function aC(t){this._internalRoot=t}function oC(t){return!(!t||1!==t.nodeType&&9!==t.nodeType&&11!==t.nodeType)}function lC(t){return!(!t||1!==t.nodeType&&9!==t.nodeType&&11!==t.nodeType&&(8!==t.nodeType||" react-mount-point-unstable "!==t.nodeValue))}function hC(){}function cC(t,e,s,i,n){var r=s._reactRootContainer;if(r){var a=r;if("function"==typeof n){var o=n;n=function(){var t=eC(a);o.call(t)}}tC(e,a,t,n)}else a=function(t,e,s,i,n){if(n){if("function"==typeof i){var r=i;i=function(){var t=eC(a);r.call(t)}}var a=ZS(e,i,t,0,null,!1,0,"",hC);return t._reactRootContainer=a,t[Tv]=a.current,Z_(8===t.nodeType?t.parentNode:t),xS(),a}for(;n=t.lastChild;)t.removeChild(n);if("function"==typeof i){var o=i;i=function(){var t=eC(l);o.call(t)}}var l=QS(t,0,!1,null,0,!1,0,"",hC);return t._reactRootContainer=l,t[Tv]=l.current,Z_(8===t.nodeType?t.parentNode:t),xS((function(){tC(e,l,s,i)})),l}(s,e,t,n,i);return eC(a)}aC.prototype.render=rC.prototype.render=function(t){var e=this._internalRoot;if(null===e)throw Error(gp(409));tC(t,e,null,null)},aC.prototype.unmount=rC.prototype.unmount=function(){var t=this._internalRoot;if(null!==t){this._internalRoot=null;var e=t.containerInfo;xS((function(){tC(null,t,null,null)})),e[Tv]=null}},aC.prototype.unstable_scheduleHydration=function(t){if(t){var e=Fm();t={blockedOn:null,target:t,priority:e};for(var s=0;s<jm.length&&0!==e&&e<jm[s].priority;s++);jm.splice(s,0,t),0===s&&Km(t)}},Lm=function(t){switch(t.tag){case 3:var e=t.stateNode;if(e.current.memoizedState.isDehydrated){var s=Sm(e.pendingLanes);0!==s&&(km(e,1|s),fS(e,hm()),0==(6&Nw)&&(Zw=hm()+500,Zv()))}break;case 13:xS((function(){var e=Ub(t,1);if(null!==e){var s=dS();pS(e,t,1,s)}})),iC(t,1)}},Im=function(t){if(13===t.tag){var e=Ub(t,134217728);if(null!==e)pS(e,t,134217728,dS());iC(t,134217728)}},Om=function(t){if(13===t.tag){var e=uS(t),s=Ub(t,e);if(null!==s)pS(s,t,e,dS());iC(t,e)}},Fm=function(){return Dm},Bm=function(t,e){var s=Dm;try{return Dm=t,e()}finally{Dm=s}},If=function(t,e,s){switch(e){case"input":if(cf(t,s),e=s.name,"radio"===s.type&&null!=e){for(s=t;s.parentNode;)s=s.parentNode;for(s=s.querySelectorAll("input[name="+JSON.stringify(""+e)+'][type="radio"]'),e=0;e<s.length;e++){var i=s[e];if(i!==t&&i.form===t.form){var n=Rv(i);if(!n)throw Error(gp(90));rf(i),cf(i,n)}}}break;case"textarea":_f(t,s);break;case"select":null!=(e=s.value)&&ff(t,!!s.multiple,e,!1)}},Uf=yS,Vf=xS;var dC={usingClientEntryPoint:!1,Events:[kv,Dv,Rv,zf,Nf,yS]},uC={findFiberByHostInstance:Av,bundleType:0,version:"18.2.0",rendererPackageName:"react-dom"},pC={bundleType:uC.bundleType,version:uC.version,rendererPackageName:uC.rendererPackageName,rendererConfig:uC.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:Dp.ReactCurrentDispatcher,findHostInstanceByFiber:function(t){return null===(t=im(t))?null:t.stateNode},findFiberByHostInstance:uC.findFiberByHostInstance||function(){return null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.2.0-next-9e3b772b8-20220608"};if("undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__){var fC=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!fC.isDisabled&&fC.supportsFiber)try{gm=fC.inject(pC),_m=fC}catch(wf){}}cp.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=dC,cp.createPortal=function(t,e){var s=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;if(!oC(e))throw Error(gp(200));return function(t,e,s){var i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:Lp,key:null==i?null:""+i,children:t,containerInfo:e,implementation:s}}(t,e,null,s)},cp.createRoot=function(t,e){if(!oC(t))throw Error(gp(299));var s=!1,i="",n=nC;return null!=e&&(!0===e.unstable_strictMode&&(s=!0),void 0!==e.identifierPrefix&&(i=e.identifierPrefix),void 0!==e.onRecoverableError&&(n=e.onRecoverableError)),e=QS(t,1,!1,null,0,s,0,i,n),t[Tv]=e.current,Z_(8===t.nodeType?t.parentNode:t),new rC(e)},cp.findDOMNode=function(t){if(null==t)return null;if(1===t.nodeType)return t;var e=t._reactInternals;if(void 0===e){if("function"==typeof t.render)throw Error(gp(188));throw t=Object.keys(t).join(","),Error(gp(268,t))}return t=null===(t=im(e))?null:t.stateNode},cp.flushSync=function(t){return xS(t)},cp.hydrate=function(t,e,s){if(!lC(e))throw Error(gp(200));return cC(null,t,e,!0,s)},cp.hydrateRoot=function(t,e,s){if(!oC(t))throw Error(gp(405));var i=null!=s&&s.hydratedSources||null,n=!1,r="",a=nC;if(null!=s&&(!0===s.unstable_strictMode&&(n=!0),void 0!==s.identifierPrefix&&(r=s.identifierPrefix),void 0!==s.onRecoverableError&&(a=s.onRecoverableError)),e=ZS(e,null,t,1,null!=s?s:null,n,0,r,a),t[Tv]=e.current,Z_(t),i)for(t=0;t<i.length;t++)n=(n=(s=i[t])._getVersion)(s._source),null==e.mutableSourceEagerHydrationData?e.mutableSourceEagerHydrationData=[s,n]:e.mutableSourceEagerHydrationData.push(s,n);return new aC(e)},cp.render=function(t,e,s){if(!lC(e))throw Error(gp(200));return cC(null,t,e,!1,s)},cp.unmountComponentAtNode=function(t){if(!lC(t))throw Error(gp(40));return!!t._reactRootContainer&&(xS((function(){cC(null,null,t,!1,(function(){t._reactRootContainer=null,t[Tv]=null}))})),!0)},cp.unstable_batchedUpdates=yS,cp.unstable_renderSubtreeIntoContainer=function(t,e,s,i){if(!lC(s))throw Error(gp(200));if(null==t||void 0===t._reactInternals)throw Error(gp(38));return cC(t,e,s,!1,i)},cp.version="18.2.0-next-9e3b772b8-20220608",function t(){if("undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE)try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(t)}catch(t){console.error(t)}}(),hp.exports=cp;var mC=hp.exports,gC=Tu(mC);const _C="pcui-flex",vC="pcui-grid",bC="pcui-hidden",yC="pcui-scrollable",xC="pcui-resizable",wC="pcui-readonly",SC="pcui-disabled",CC="pcui-collapsible",TC="pcui-collapsed",EC="pcui-focus",PC="pcui-multiple-values",MC="pcui-error",AC="flash",kC="pcui-not-flexible",DC="font-regular",RC="font-bold",LC=["flexDirection","flexGrow","flexBasis","flexShrink","flexWrap","alignItems","alignSelf","justifyContent","justifySelf"],IC=new Map;let OC=class extends _u{constructor(t={}){var e,s,i;if(super(),this._destroyed=!1,this._parent=null,this._eventsParent=[],this._flashTimeout=null,this._suppressChange=!1,this._onMouseOver=t=>{this.emit("hover",t)},this._onMouseOut=t=>{this.emit("hoverend",t)},"string"==typeof t.dom?this._dom=document.createElement(t.dom):t.dom instanceof Node?this._dom=t.dom:this._dom=document.createElement("div"),void 0!==t.id&&(this._dom.id=t.id),this._dom.ui=this,this._onClickEvt=this._onClick.bind(this),this._dom.addEventListener("click",this._onClickEvt),this._dom.addEventListener("mouseover",this._onMouseOver),this._dom.addEventListener("mouseout",this._onMouseOut),this._dom.classList.add("pcui-element",DC),t.class){const e=Array.isArray(t.class)?t.class:[t.class];for(const t of e)this._dom.classList.add(t)}this.enabled=void 0===t.enabled||t.enabled,this._hiddenParents=!t.isRoot,this.hidden=null!==(e=t.hidden)&&void 0!==e&&e,this.readOnly=null!==(s=t.readOnly)&&void 0!==s&&s,this.ignoreParent=null!==(i=t.ignoreParent)&&void 0!==i&&i,void 0!==t.width&&(this.width=t.width),void 0!==t.height&&(this.height=t.height),void 0!==t.tabIndex&&(this.tabIndex=t.tabIndex);for(const e in t)void 0!==t[e]&&-1!==LC.indexOf(e)&&(this[e]=t[e]);t.binding&&(this.binding=t.binding)}destroy(){if(this._destroyed)return;if(this._destroyed=!0,this.binding?this.binding=null:this.unlink(),this.parent){const t=this.parent;for(const t of this._eventsParent)t.unbind();this._eventsParent.length=0,t.remove&&!t._destroyed&&t.remove(this),this._parent=null,!t._destroyed&&this._dom&&this._dom.parentElement&&this._dom.parentElement.removeChild(this._dom)}const t=this._dom;t&&(t.removeEventListener("click",this._onClickEvt),t.removeEventListener("mouseover",this._onMouseOver),t.removeEventListener("mouseout",this._onMouseOut),delete t.ui,this._dom=null),this._flashTimeout&&window.clearTimeout(this._flashTimeout),this.emit("destroy",t,this),this.unbind()}link(t,e){this._binding&&this._binding.link(t,e)}unlink(){this._binding&&this._binding.unlink()}flash(){this._flashTimeout||(this.class.add(AC),this._flashTimeout=window.setTimeout((()=>{this._flashTimeout=null,this.class.remove(AC)}),200))}_onClick(t){this.enabled&&this.emit("click",t)}_onHiddenToRootChange(t){this.emit(t?"hideToRoot":"showToRoot")}_onEnabledChange(t){t?this.class.remove(SC):this.class.add(SC),this.emit(t?"enable":"disable")}_onParentDestroy(){this.destroy()}_onParentDisable(){this._ignoreParent||this._enabled&&this._onEnabledChange(!1)}_onParentEnable(){this._ignoreParent||this._enabled&&this._onEnabledChange(!0)}_onParentShowToRoot(){const t=this.hiddenToRoot;this._hiddenParents=!1,t!==this.hiddenToRoot&&this._onHiddenToRootChange(this.hiddenToRoot)}_onParentHideToRoot(){const t=this.hiddenToRoot;this._hiddenParents=!0,t!==this.hiddenToRoot&&this._onHiddenToRootChange(this.hiddenToRoot)}_onReadOnlyChange(t){t?this.class.add(wC):this.class.remove(wC),this.emit("readOnly",t)}_onParentReadOnlyChange(t){this._ignoreParent||(t?this._readOnly||this._onReadOnlyChange(!0):this._readOnly||this._onReadOnlyChange(!1))}unbind(t,e){return super.unbind(t,e)}static register(t,e,s){IC.set(t,{cls:e,defaultArguments:s})}static unregister(t){IC.delete(t)}static create(t,e){const s=IC.get(t);if(!s)return void console.error("Invalid type passed to Element.create:",t);return new(0,s.cls)(Object.assign(Object.assign({},s.defaultArguments),e))}set enabled(t){if(this._enabled===t)return;const e=this.enabled;this._enabled=t,e!==t&&this._onEnabledChange(t)}get enabled(){return this._ignoreParent?this._enabled:this._enabled&&(!this._parent||this._parent.enabled)}set ignoreParent(t){this._ignoreParent=t,this._onEnabledChange(this.enabled),this._onReadOnlyChange(this.readOnly)}get ignoreParent(){return this._ignoreParent}get dom(){return this._dom}set parent(t){if(t===this._parent)return;const e=this.enabled,s=this.readOnly,i=this.hiddenToRoot;if(this._parent){for(let t=0;t<this._eventsParent.length;t++)this._eventsParent[t].unbind();this._eventsParent.length=0}this._parent=t,this._parent?(this._eventsParent.push(this._parent.once("destroy",this._onParentDestroy.bind(this))),this._eventsParent.push(this._parent.on("disable",this._onParentDisable.bind(this))),this._eventsParent.push(this._parent.on("enable",this._onParentEnable.bind(this))),this._eventsParent.push(this._parent.on("readOnly",this._onParentReadOnlyChange.bind(this))),this._eventsParent.push(this._parent.on("showToRoot",this._onParentShowToRoot.bind(this))),this._eventsParent.push(this._parent.on("hideToRoot",this._onParentHideToRoot.bind(this))),this._hiddenParents=this._parent.hiddenToRoot):this._hiddenParents=!0,this.emit("parent",this._parent);const n=this.enabled;n!==e&&this._onEnabledChange(n);const r=this.readOnly;r!==s&&this._onReadOnlyChange(r);const a=this.hiddenToRoot;a!==i&&this._onHiddenToRootChange(a)}get parent(){return this._parent}set hidden(t){if(t===this._hidden)return;const e=this.hiddenToRoot;this._hidden=t,t?this.class.add(bC):this.class.remove(bC),this.emit(t?"hide":"show"),this.hiddenToRoot!==e&&this._onHiddenToRootChange(this.hiddenToRoot)}get hidden(){return this._hidden}get hiddenToRoot(){return this._hidden||this._hiddenParents}set readOnly(t){this._readOnly!==t&&(this._readOnly=t,this._onReadOnlyChange(t))}get readOnly(){return this._ignoreParent?this._readOnly:this._readOnly||!(!this._parent||!this._parent.readOnly)}set error(t){this._hasError!==t&&(this._hasError=t,t?this.class.add(MC):this.class.remove(MC))}get error(){return this._hasError}get style(){return this._dom.style}get class(){return this._dom.classList}set width(t){"number"==typeof t&&(t=String(t)+"px"),this.style.width=t}get width(){return this._dom.clientWidth}set height(t){"number"==typeof t&&(t=String(t)+"px"),this.style.height=t}get height(){return this._dom.clientHeight}set tabIndex(t){this._dom.tabIndex=t}get tabIndex(){return this._dom.tabIndex}set binding(t){if(this._binding===t)return;let e,s;this._binding&&(e=this._binding.observers,s=this._binding.paths,this.unlink(),this._binding.element=null,this._binding=null),this._binding=t,this._binding&&(this._binding.element=this,e&&s&&this.link(e,s))}get binding(){return this._binding}get destroyed(){return this._destroyed}set flexDirection(t){this.style.flexDirection=t}get flexDirection(){return this.style.flexDirection}set flexGrow(t){this.style.flexGrow=t}get flexGrow(){return this.style.flexGrow}set flexBasis(t){this.style.flexBasis=t}get flexBasis(){return this.style.flexBasis}set flexShrink(t){this.style.flexShrink=t}get flexShrink(){return this.style.flexShrink}set flexWrap(t){this.style.flexWrap=t}get flexWrap(){return this.style.flexWrap}set alignItems(t){this.style.alignItems=t}get alignItems(){return this.style.alignItems}set alignSelf(t){this.style.alignSelf=t}get alignSelf(){return this.style.alignSelf}set justifyContent(t){this.style.justifyContent=t}get justifyContent(){return this.style.justifyContent}set justifySelf(t){this.style.justifySelf=t}get justifySelf(){return this.style.justifySelf}set disabled(t){this.enabled=!t}get disabled(){return!this.enabled}set element(t){this._dom=t}get element(){return this.dom}set innerElement(t){this._domContent=t}get innerElement(){return this._domContent}};OC.EVENT_ENABLE="enable",OC.EVENT_DISABLE="disable",OC.EVENT_HIDE="hide",OC.EVENT_HIDE_TO_ROOT="hideToRoot",OC.EVENT_SHOW="show",OC.EVENT_SHOW_TO_ROOT="showToRoot",OC.EVENT_READ_ONLY="readOnly",OC.EVENT_PARENT="parent",OC.EVENT_CLICK="click",OC.EVENT_HOVER="hover",OC.EVENT_HOVER_END="hoverend",OC.EVENT_DESTROY="destroy";var FC=OC;const BC=[null,"top","right","bottom","left"],zC=xC+"-resizing",NC="pcui-container",UC=NC+"-dragged",VC=UC+"-child";class HC extends FC{constructor(t={}){var e;super(t),this._scrollable=!1,this._flex=!1,this._grid=!1,this._domResizeHandle=null,this._resizePointerId=null,this._resizeData=null,this._resizeHorizontally=!0,this._resizeMin=100,this._resizeMax=300,this._draggedStartIndex=-1,this._onScroll=t=>{this.emit("scroll",t)},this._onResizeStart=t=>{null===this._resizePointerId&&(t.preventDefault(),t.stopPropagation(),this._domResizeHandle.setPointerCapture(t.pointerId),this._resizePointerId=t.pointerId,this._resizeStart())},this._onResizeMove=t=>{this._resizePointerId===t.pointerId&&(t.preventDefault(),t.stopPropagation(),this._resizeMove(t.clientX,t.clientY))},this._onResizeEnd=t=>{this._resizePointerId===t.pointerId&&(t.preventDefault(),t.stopPropagation(),this._resizeEnd(),this._domResizeHandle.releasePointerCapture(t.pointerId),this._resizePointerId=null)},this.class.add(NC),this.domContent=this._dom,t.scrollable&&(this.scrollable=!0),this.flex=!!t.flex;let s=!!t.grid;s&&this.flex&&(console.error('Invalid Container arguments: "grid" and "flex" cannot both be true.'),s=!1),this.grid=s,this.resizable=null!==(e=t.resizable)&&void 0!==e?e:null,void 0!==t.resizeMin&&(this.resizeMin=t.resizeMin),void 0!==t.resizeMax&&(this.resizeMax=t.resizeMax)}destroy(){this._destroyed||(this.domContent=null,this._domResizeHandle&&(this._domResizeHandle.removeEventListener("pointerdown",this._onResizeStart),this._domResizeHandle.removeEventListener("pointermove",this._onResizeMove),this._domResizeHandle.removeEventListener("pointerup",this._onResizeEnd)),super.destroy())}append(t){const e=this._getDomFromElement(t);this._domContent.appendChild(e),this._onAppendChild(t)}appendBefore(t,e){const s=this._getDomFromElement(t);this._domContent.appendChild(s);const i=e&&this._getDomFromElement(e);this._domContent.insertBefore(s,i),this._onAppendChild(t)}appendAfter(t,e){const s=this._getDomFromElement(t),i=e&&this._getDomFromElement(e),n=i?i.nextSibling:null;n?this._domContent.insertBefore(s,n):this._domContent.appendChild(s),this._onAppendChild(t)}prepend(t){const e=this._getDomFromElement(t),s=this._domContent.firstChild;s?this._domContent.insertBefore(e,s):this._domContent.appendChild(e),this._onAppendChild(t)}remove(t){if(t.parent!==this)return;const e=this._getDomFromElement(t);this._domContent.removeChild(e),this._onRemoveChild(t)}move(t,e){let s=-1;for(let e=0;e<this.dom.childNodes.length;e++)if(this.dom.childNodes[e].ui===t){s=e;break}-1===s?this.appendBefore(t,this.dom.childNodes[e]):e!==s&&(this.remove(t),e<s?this.appendBefore(t,this.dom.childNodes[e]):this.appendAfter(t,this.dom.childNodes[e-1]))}clear(){let t=this._domContent.childNodes.length;for(;t--;){const e=this._domContent.childNodes[t];e.ui&&e.ui!==this&&e.ui.destroy()}this._domResizeHandle&&(this._domResizeHandle.removeEventListener("pointerdown",this._onResizeStart),this._domResizeHandle.removeEventListener("pointermove",this._onResizeMove),this._domResizeHandle.removeEventListener("pointerup",this._onResizeEnd),this._domResizeHandle=null),this._domContent.innerHTML="",this.resizable&&(this._createResizeHandle(),this._dom.appendChild(this._domResizeHandle))}_getDomFromElement(t){return t.dom?t.dom:t.element?t.element:t}_onAppendChild(t){t.parent=this,this.emit("append",t)}_onRemoveChild(t){t.parent=null,this.emit("remove",t)}_createResizeHandle(){const t=document.createElement("div");t.classList.add("pcui-resizable-handle"),t.ui=this,t.addEventListener("pointerdown",this._onResizeStart),t.addEventListener("pointermove",this._onResizeMove),t.addEventListener("pointerup",this._onResizeEnd),this._domResizeHandle=t}_resizeStart(){this.class.add(zC)}_resizeMove(t,e){if(this._resizeData){if(this._resizeHorizontally){let e=this._resizeData.x-t;"right"===this._resizable&&(e=-e),this.width=4+Math.max(this._resizeMin,Math.min(this._resizeMax,this._resizeData.width+e))}else{let t=this._resizeData.y-e;"bottom"===this._resizable&&(t=-t),this.height=Math.max(this._resizeMin,Math.min(this._resizeMax,this._resizeData.height+t))}this.emit("resize")}else this._resizeData={x:t,y:e,width:this.dom.clientWidth,height:this.dom.clientHeight}}_resizeEnd(){this._resizeData=null,this.class.remove(zC)}resize(t,e){t=t||0,e=e||0,this._resizeStart(),this._resizeMove(0,0),this._resizeMove(4-t,-e),this._resizeEnd()}_getDraggedChildIndex(t){for(let e=0;e<this.dom.childNodes.length;e++)if(this.dom.childNodes[e].ui===t)return e;return-1}_onChildDragStart(t,e){this.class.add(VC),this._draggedStartIndex=this._getDraggedChildIndex(e),e.class.add(UC),this.emit("child:dragstart",e,this._draggedStartIndex)}_onChildDragMove(t,e){const s=this.dom.getBoundingClientRect(),i=t.clientX<s.left||t.clientX>s.right||t.clientY<s.top||t.clientY>s.bottom,n=this._getDraggedChildIndex(e);if(i)return e.class.remove(UC),void(this._draggedStartIndex!==n&&(this.remove(e),this._draggedStartIndex<n?this.appendBefore(e,this.dom.childNodes[this._draggedStartIndex]):this.appendAfter(e,this.dom.childNodes[this._draggedStartIndex-1])));e.class.add(UC);const r=t.clientY-s.top;let a=null;for(let t=0;t<this.dom.childNodes.length;t++){const s=this.dom.childNodes[t].ui,i=s.dom.offsetTop;if(t<n){if(r<=i+s.header.height){a=t;break}}else if(t>n&&r+e.height>=i+s.height){a=t;break}}null!==a&&n!==a&&(this.remove(e),a<n?this.appendBefore(e,this.dom.childNodes[a]):this.appendAfter(e,this.dom.childNodes[a-1]))}_onChildDragEnd(t,e){this.class.remove(VC),e.class.remove(UC);const s=this._getDraggedChildIndex(e);this.emit("child:dragend",e,s,this._draggedStartIndex),this._draggedStartIndex=-1}forEachChild(t){for(let e=0;e<this.dom.childNodes.length;e++){const s=this.dom.childNodes[e].ui;if(s){if(!1===t(s,e))break}}}_buildDomNode(t){const e=Object.keys(t);let s;return e.includes("root")?(s=this._buildDomNode(t.root),t.children.forEach((t=>{const e=this._buildDomNode(t);null!==e&&s.append(e)}))):(s=t[e[0]],this[`_${e[0]}`]=s),s}buildDom(t){t.forEach((t=>{const e=this._buildDomNode(t);this.append(e)}))}set flex(t){t!==this._flex&&(this._flex=t,t?this.class.add(_C):this.class.remove(_C))}get flex(){return this._flex}set grid(t){t!==this._grid&&(this._grid=t,t?this.class.add(vC):this.class.remove(vC))}get grid(){return this._grid}set scrollable(t){this._scrollable!==t&&(this._scrollable=t,t?this.class.add(yC):this.class.remove(yC))}get scrollable(){return this._scrollable}set resizable(t){t!==this._resizable&&(-1!==BC.indexOf(t)?(this._resizable&&this.class.remove(`${xC}-${this._resizable}`),this._resizable=t,this._resizeHorizontally="right"===t||"left"===t,t?(this.class.add(xC),this.class.add(`${xC}-${t}`),this._domResizeHandle||this._createResizeHandle(),this._dom.appendChild(this._domResizeHandle)):(this.class.remove(xC),this._domResizeHandle&&this._dom.removeChild(this._domResizeHandle))):console.error("Invalid resizable value: must be one of "+BC.join(",")))}get resizable(){return this._resizable}set resizeMin(t){this._resizeMin=Math.max(0,Math.min(t,this._resizeMax))}get resizeMin(){return this._resizeMin}set resizeMax(t){this._resizeMax=Math.max(this._resizeMin,t)}get resizeMax(){return this._resizeMax}set domContent(t){this._domContent!==t&&(this._domContent&&this._domContent.removeEventListener("scroll",this._onScroll),this._domContent=t,this._domContent&&this._domContent.addEventListener("scroll",this._onScroll))}get domContent(){return this._domContent}}HC.EVENT_APPEND="append",HC.EVENT_REMOVE="remove",HC.EVENT_SCROLL="scroll",HC.EVENT_RESIZE="resize",FC.register("container",HC);var GC=HC;class WC extends FC{constructor(t={}){var e,s,i;super(Object.assign({dom:"span"},t)),this.class.add("pcui-label"),this._unsafe=null!==(e=t.unsafe)&&void 0!==e&&e,this.text=null!==(i=null!==(s=t.text)&&void 0!==s?s:t.value)&&void 0!==i?i:"",t.allowTextSelection&&this.class.add("pcui-default-mousedown"),t.nativeTooltip&&(this.dom.title=this.text),this.placeholder=t.placeholder,this.renderChanges=t.renderChanges,this.on("change",(()=>{this.renderChanges&&this.flash()}))}_updateText(t){return this.class.remove(PC),this._text!==t&&(this._text=t,this._unsafe?this._dom.innerHTML=t:this._dom.textContent=t,this.emit("change",t),!0)}set text(t){null==t&&(t="");this._updateText(t)&&this._binding&&this._binding.setValue(t)}get text(){return this._text}set value(t){this.text=t}get value(){return this.text}set values(t){const e=t.some((e=>e!==t[0]));e?(this._updateText(""),this.class.add(PC)):this._updateText(t[0])}set placeholder(t){t?this.dom.setAttribute("placeholder",t):this.dom.removeAttribute("placeholder")}get placeholder(){return this.dom.getAttribute("placeholder")}set renderChanges(t){this._renderChanges=t}get renderChanges(){return this._renderChanges}}FC.register("label",WC);var jC=WC;class qC extends FC{constructor(t={}){super(Object.assign({dom:"button"},t)),this._onKeyDown=t=>{"Escape"===t.key?this.blur():"Enter"===t.key&&this._onClick(t)},this.class.add("pcui-button"),this._unsafe=t.unsafe,this.text=t.text,this.size=t.size,this.icon=t.icon,this.dom.addEventListener("keydown",this._onKeyDown)}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),super.destroy())}_onClick(t){this.blur(),this.readOnly||super._onClick(t)}focus(){this.dom.focus()}blur(){this.dom.blur()}set text(t){this._text!==t&&(this._text=t,this._unsafe?this.dom.innerHTML=t:this.dom.textContent=t)}get text(){return this._text}set icon(t){this._icon!==t&&t.match(/^E[0-9]{0,4}$/)&&(this._icon=t,t?this.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(t,16))):this.dom.removeAttribute("data-icon"))}get icon(){return this._icon}set size(t){this._size!==t&&(this._size&&(this.class.remove("pcui-"+this._size),this._size=null),this._size=t,this._size&&this.class.add("pcui-"+this._size))}get size(){return this._size}}FC.register("button",qC);var XC=qC;const $C="pcui-panel",KC=$C+"-header",YC=KC+"-title",QC=$C+"-content",JC=$C+"-horizontal",ZC=$C+"-sortable-icon",tT=$C+"-remove";class eT extends GC{constructor(t={}){var e;const s=Object.assign(Object.assign({},t),{flex:!0});delete s.grid,delete s.flexDirection,delete s.scrollable,super(s),this._reflowTimeout=null,this._widthBeforeCollapse=null,this._heightBeforeCollapse=null,this._iconSort=null,this._btnRemove=null,this._onHeaderClick=t=>{this._collapsible&&(t.target!==this.header.dom&&t.target!==this._labelTitle.dom||(this.collapsed=!this.collapsed))},this._onDragStart=t=>{this.enabled&&!this.readOnly&&(t.stopPropagation(),t.preventDefault(),window.addEventListener("mouseup",this._onDragEndEvt),window.addEventListener("mouseleave",this._onDragEndEvt),window.addEventListener("mousemove",this._onDragMove),this.emit("dragstart"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragStart(t,this))},this._onDragMove=t=>{this.emit("dragmove"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragMove(t,this)},this.class.add($C),t.panelType&&this.class.add($C+"-"+t.panelType),this._suspendReflow=!0,this._initializeHeader(t),this._initializeContent(t),this.headerSize=null!==(e=t.headerSize)&&void 0!==e?e:32,this.collapsible=t.collapsible||!1,this.collapsed=t.collapsed||!1,this.collapseHorizontally=t.collapseHorizontally||!1,this.sortable=t.sortable||!1,this.removable=t.removable||!!t.onRemove||!1,this.domContent=this._containerContent.dom,this._suspendReflow=!1,this._reflow(),this._onDragEndEvt=this._onDragEnd.bind(this)}destroy(){this._destroyed||(this._reflowTimeout&&(cancelAnimationFrame(this._reflowTimeout),this._reflowTimeout=null),window.removeEventListener("mouseup",this._onDragEndEvt),window.removeEventListener("mouseleave",this._onDragEndEvt),window.removeEventListener("mousemove",this._onDragMove),super.destroy())}_initializeHeader(t){this._containerHeader=new GC({flex:!0,flexDirection:"row",class:[KC,RC]}),this._labelTitle=new jC({text:t.headerText,class:[YC,RC]}),this._containerHeader.append(this._labelTitle),this._containerHeader.dom.addEventListener("click",this._onHeaderClick),this.append(this._containerHeader)}_onClickRemove(t){t.preventDefault(),t.stopPropagation(),this.emit("click:remove")}_initializeContent(t){this._containerContent=new GC({class:QC,grid:t.grid,flex:t.flex,flexDirection:t.flexDirection,scrollable:t.scrollable,dom:t.content}),this.append(this._containerContent)}_reflow(){this._suspendReflow||(this._reflowTimeout&&(cancelAnimationFrame(this._reflowTimeout),this._reflowTimeout=null),!this.hidden&&this.collapsible&&(this.collapsed&&this.collapseHorizontally?this._containerHeader.style.top=-this.headerSize+"px":this._containerHeader.style.top="",this._reflowTimeout=requestAnimationFrame((()=>{this._reflowTimeout=null,this.collapsed?(this._widthBeforeCollapse||(this._widthBeforeCollapse=this.style.width),this._heightBeforeCollapse||(this._heightBeforeCollapse=this.style.height),this._collapseHorizontally?(this.height="",this.width=this.headerSize):this.height=this.headerSize,this.class.add(TC)):(this.class.remove(TC),this._collapseHorizontally?(this.height="",null!==this._widthBeforeCollapse&&(this.width=this._widthBeforeCollapse)):null!==this._heightBeforeCollapse&&(this.height=this._heightBeforeCollapse),this._widthBeforeCollapse=null,this._heightBeforeCollapse=null)}))))}_onDragEnd(t){window.removeEventListener("mouseup",this._onDragEndEvt),window.removeEventListener("mouseleave",this._onDragEndEvt),window.removeEventListener("mousemove",this._onDragMove),this._draggedChild===this&&(this._draggedChild=null),this.emit("dragend"),this.parent&&this.parent._onChildDragStart&&this.parent._onChildDragEnd(t,this)}set collapsible(t){t!==this._collapsible&&(this._collapsible=t,t?this.class.add(CC):this.class.remove(CC),this._reflow(),this.collapsed&&this.emit(t?"collapse":"expand"))}get collapsible(){return this._collapsible}set collapsed(t){this._collapsed!==t&&(this._collapsed=t,this._reflow(),this.collapsible&&this.emit(t?"collapse":"expand"))}get collapsed(){return this._collapsed}set sortable(t){this._sortable!==t&&(this._sortable=t,t?(this._iconSort=new jC({class:ZC}),this._iconSort.dom.addEventListener("mousedown",this._onDragStart),this.header.prepend(this._iconSort)):this._iconSort&&(this._iconSort.destroy(),this._iconSort=null))}get sortable(){return this._sortable}set removable(t){this.removable!==t&&(t?(this._btnRemove=new XC({icon:"E289",class:tT}),this._btnRemove.on("click",this._onClickRemove.bind(this)),this.header.append(this._btnRemove)):(this._btnRemove.destroy(),this._btnRemove=null))}get removable(){return!!this._btnRemove}set collapseHorizontally(t){this._collapseHorizontally!==t&&(this._collapseHorizontally=t,t?this.class.add(JC):this.class.remove(JC),this._reflow())}get collapseHorizontally(){return this._collapseHorizontally}get content(){return this._containerContent}get header(){return this._containerHeader}set headerText(t){this._labelTitle.text=t}get headerText(){return this._labelTitle.text}set headerSize(t){this._headerSize=t;const e=this._containerHeader.dom.style;e.height=Math.max(0,t)+"px",e.lineHeight=e.height,this._reflow()}get headerSize(){return this._headerSize}}eT.EVENT_COLLAPSE="collapse",eT.EVENT_EXPAND="expand",FC.register("panel",eT);var sT=eT;var iT=class extends FC{constructor(t={}){var e,s,i,n,r;super(t),this._onInputFocus=t=>{this.class.add(EC),this.emit("focus",t),this._prevValue=this._domInput.value},this._onInputBlur=t=>{this.class.remove(EC),this.emit("blur",t)},this._onInputKeyUp=t=>{"Escape"!==t.key&&this._onInputChange(t),this.emit("keyup",t)},this._onInputCtxMenu=t=>{this._domInput.select()},this._updateInputReadOnly=()=>{!this.enabled||this.readOnly?this._domInput.setAttribute("readonly","true"):this._domInput.removeAttribute("readonly")},this.class.add("pcui-input-element");let a=t.input;a||(a=document.createElement("input"),a.type="text"),a.ui=this,a.tabIndex=0,a.autocomplete="off",this._onInputKeyDownEvt=this._onInputKeyDown.bind(this),this._onInputChangeEvt=this._onInputChange.bind(this),a.addEventListener("change",this._onInputChangeEvt),a.addEventListener("keydown",this._onInputKeyDownEvt),a.addEventListener("focus",this._onInputFocus),a.addEventListener("blur",this._onInputBlur),a.addEventListener("contextmenu",this._onInputCtxMenu,!1),this.dom.appendChild(a),this._domInput=a,this._suspendInputChangeEvt=!1,void 0!==t.value&&(this._domInput.value=t.value),this.placeholder=null!==(e=t.placeholder)&&void 0!==e?e:"",this.renderChanges=null!==(s=t.renderChanges)&&void 0!==s&&s,this.blurOnEnter=null===(i=t.blurOnEnter)||void 0===i||i,this.blurOnEscape=null===(n=t.blurOnEscape)||void 0===n||n,this.keyChange=null!==(r=t.keyChange)&&void 0!==r&&r,this._prevValue=null,this.on("change",(()=>{this.renderChanges&&this.flash()})),this.on("disable",this._updateInputReadOnly),this.on("enable",this._updateInputReadOnly),this.on("readOnly",this._updateInputReadOnly),this._updateInputReadOnly()}destroy(){if(this._destroyed)return;const t=this._domInput;t.removeEventListener("change",this._onInputChangeEvt),t.removeEventListener("keydown",this._onInputKeyDownEvt),t.removeEventListener("focus",this._onInputFocus),t.removeEventListener("blur",this._onInputBlur),t.removeEventListener("keyup",this._onInputKeyUp),t.removeEventListener("contextmenu",this._onInputCtxMenu),super.destroy()}_onInputKeyDown(t){if("Enter"===t.key&&this.blurOnEnter)this._suspendInputChangeEvt=this.keyChange,this._domInput.blur(),this._suspendInputChangeEvt=!1;else if("Escape"===t.key){this._suspendInputChangeEvt=!0;const e=this._domInput.value;this._domInput.value=this._prevValue,this._suspendInputChangeEvt=!1,this.keyChange&&e!==this._prevValue&&this._onInputChange(t),this.blurOnEscape&&this._domInput.blur()}this.emit("keydown",t)}_onInputChange(t){}focus(t){this._domInput.focus(),t&&this._domInput.select()}blur(){this._domInput.blur()}set placeholder(t){t?this.dom.setAttribute("placeholder",t):this.dom.removeAttribute("placeholder")}get placeholder(){var t;return null!==(t=this.dom.getAttribute("placeholder"))&&void 0!==t?t:""}set keyChange(t){this._keyChange!==t&&(this._keyChange=t,t?this._domInput.addEventListener("keyup",this._onInputKeyUp):this._domInput.removeEventListener("keyup",this._onInputKeyUp))}get keyChange(){return this._keyChange}get input(){return this._domInput}set blurOnEnter(t){this._blurOnEnter=t}get blurOnEnter(){return this._blurOnEnter}set blurOnEscape(t){this._blurOnEscape=t}get blurOnEscape(){return this._blurOnEscape}set renderChanges(t){this._renderChanges=t}get renderChanges(){return this._renderChanges}};const nT="pcui-numeric-input",rT=nT+"-slider-control",aT=rT+"-active",oT=rT+"-hidden",lT=/,/g;class hT extends iT{constructor(t={}){var e,s,i,n;const r=Object.assign({},t);delete r.value,delete r.renderChanges,super(r),this._sliderUsed=!1,this._onSliderMouseWheel=t=>{this._updatePosition(t.deltaY,t.shiftKey)},this._onSliderMouseMove=t=>{this._updatePosition(t.movementX,t.shiftKey)},this._onSliderMouseDown=()=>{this._sliderControl.dom.requestPointerLock(),this._sliderMovement=0,this._sliderPrevValue=this.value,this._sliderUsed=!0,this.binding&&(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this.binding.historyPostfix=`(${Date.now()})`)},this._onSliderMouseUp=()=>{document.exitPointerLock(),this._sliderUsed&&(this._sliderUsed=!1,this.value=this._sliderPrevValue+this._sliderMovement,this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix,this._historyCombine=!1,this._historyPostfix=null),this.focus())},this._onPointerLockChange=()=>{this._isScrolling()?(this._sliderControl.dom.addEventListener("mousemove",this._onSliderMouseMove,!1),this._sliderControl.dom.addEventListener("wheel",this._onSliderMouseWheel,{passive:!0}),this._sliderControl.class.add(aT)):(this._sliderControl.dom.removeEventListener("mousemove",this._onSliderMouseMove,!1),this._sliderControl.dom.removeEventListener("wheel",this._onSliderMouseWheel),this._sliderControl.class.remove(aT))},this.class.add(nT),this._min=null!==(e=t.min)&&void 0!==e?e:null,this._max=null!==(s=t.max)&&void 0!==s?s:null,this._allowNull=null!==(i=t.allowNull)&&void 0!==i&&i,this._precision=null!==(n=t.precision)&&void 0!==n?n:7,Number.isFinite(t.step)?this._step=t.step:t.precision?this._step=10/Math.pow(10,t.precision):this._step=1,Number.isFinite(t.stepPrecision)?this._stepPrecision=t.stepPrecision:this._stepPrecision=.1*this._step,this._oldValue=void 0,Number.isFinite(t.value)?this.value=t.value:this._allowNull||(this.value=0),this._historyCombine=!1,this._historyPostfix=null,this._sliderPrevValue=0,this.renderChanges=t.renderChanges,t.hideSlider||(this._sliderControl=new FC,this._sliderControl.class.add(rT),this.dom.append(this._sliderControl.dom),this._sliderControl.dom.addEventListener("mousedown",this._onSliderMouseDown),this._sliderControl.dom.addEventListener("mouseup",this._onSliderMouseUp),document.addEventListener("pointerlockchange",this._onPointerLockChange,!1))}destroy(){this.destroyed||(this._sliderControl&&(this._sliderControl.dom.removeEventListener("mousedown",this._onSliderMouseDown),this._sliderControl.dom.removeEventListener("mouseup",this._onSliderMouseUp),this._sliderControl.dom.removeEventListener("mousemove",this._onSliderMouseMove,!1),this._sliderControl.dom.removeEventListener("wheel",this._onSliderMouseWheel),document.removeEventListener("pointerlockchange",this._onPointerLockChange,!1)),super.destroy())}_updatePosition(t,e){this._sliderMovement+=t/100*(e?this._stepPrecision:this._step),this.value=this._sliderPrevValue+this._sliderMovement}_onInputChange(t){this.value=this._normalizeValue(this._domInput.value)}_onInputKeyDown(t){if(this.enabled&&!this.readOnly){if("ArrowUp"===t.key||"ArrowDown"===t.key){const e="ArrowDown"===t.key?-1:1;this.value+=(t.shiftKey?this._stepPrecision:this._step)*e}super._onInputKeyDown(t)}}_isScrolling(){return!!this._sliderControl&&document.pointerLockElement===this._sliderControl.dom}_normalizeValue(t){try{if("string"==typeof t){if("0"===t)return 0;if(null!==(t=(t=(t=t.replace(lT,".")).replace(/\s/g,"")).match(/^[*/+\-0-9().]+$/))&&t[0].length<20){let e=t[0];["+","-","/","*"].forEach((t=>{const s=e.split(t);s.forEach(((t,e)=>{s[e]=s[e].replace(/^0+/,"")})),e=s.join(t)})),t=Function('"use strict";return ('+e+")")()}}}catch(e){t=null}if(null===t||isNaN(t)){if(this._allowNull)return null;t=0}return null!==this.min&&t<this.min&&(t=this.min),null!==this.max&&t>this.max&&(t=this.max),null!==this.precision&&(t=parseFloat(Number(t).toFixed(this.precision))),t}_updateValue(t,e){const s=t!==this._oldValue||e;return this._oldValue=t,this._domInput.value=null===t?"":String(t),this.class.remove(PC),s&&this.emit("change",t),s}set value(t){t=this._normalizeValue(t);const e=this.class.contains(PC)&&null===t&&this._allowNull;this._updateValue(t,e)&&this.binding&&this.binding.setValue(t),this._sliderControl&&this._sliderControl.class.remove(oT)}get value(){const t=this._domInput.value;return""!==t?parseFloat(t):null}set values(t){const e=t.map((t=>this._normalizeValue(t))),s=e.some((t=>t!==e[0]));s?(this._updateValue(null),this.class.add(PC),this._sliderControl&&this._sliderControl.class.add(oT)):(this._updateValue(e[0]),this._sliderControl&&this._sliderControl.class.remove(oT))}set min(t){this._min!==t&&(this._min=t,null!==this._min&&(this.value=this.value))}get min(){return this._min}set max(t){this._max!==t&&(this._max=t,null!==this._max&&(this.value=this.value))}get max(){return this._max}set precision(t){this._precision!==t&&(this._precision=t,null!==this._precision&&(this.value=this.value))}get precision(){return this._precision}set step(t){this._step=t}get step(){return this._step}}FC.register("number",hT,{renderChanges:!0});var cT=hT;let dT=class extends op.Component{constructor(t){super(t),this.attachElement=(t,e)=>{if(!t)return;this.elementClass===FC?this.element=new this.elementClass(t,Object.assign(Object.assign({},this.props),{container:e,parent:void 0})):this.element=new this.elementClass(Object.assign(Object.assign({},this.props),{dom:t,content:e,parent:void 0}));const s=this.props.class;this.class=new Set(s?Array.isArray(s)?s.slice():[s]:void 0),this.onClick&&this.element.on("click",this.onClick),this.onRemove&&this.element.on("click:remove",this.onRemove),this.onChange&&this.element.on("change",this.onChange),this.props.parent&&(this.element.parent=this.props.parent),this.onAttach&&this.onAttach()},this.getPropertyDescriptor=(t,e)=>{let s;do{s=Object.getOwnPropertyDescriptor(t,e)}while(!s&&(t=Object.getPrototypeOf(t)));return s},this.elementClass=FC,t.onClick&&(this.onClick=t.onClick),t.onRemove&&(this.onRemove=t.onRemove),t.onChange&&(this.onChange=t.onChange),t.link&&(this.link=t.link)}componentDidMount(){this.link&&this.element.link(this.link.observer,this.link.path)}componentDidUpdate(t){Object.keys(this.props).forEach((t=>{const e=this.getPropertyDescriptor(this.element,t);if(e&&e.set)"value"===t?(this.element._suppressChange=!0,this.element[t]=this.props[t],this.element._suppressChange=!1):this.element[t]=this.props[t];else if("class"===t){const e=this.props[t],s=new Set(e?Array.isArray(e)?e.slice():[e]:void 0);s.forEach((t=>{this.class.has(t)||(this.element.class.add(t),this.class.add(t))})),this.class.forEach((t=>{s.has(t)||(this.element.class.remove(t),this.class.delete(t))}))}})),t.link!==this.props.link&&this.props.link&&this.element.link(this.props.link.observer,this.props.link.path)}render(){return op.createElement("div",{ref:this.attachElement})}};var uT=dT;const pT="pcui-boolean-input",fT=pT+"-ticked",mT=pT+"-toggle";class gT extends FC{constructor(t={}){var e;super(Object.assign({tabIndex:0},t)),this._onKeyDown=t=>{"Escape"!==t.key?this.enabled&&!this.readOnly&&" "===t.key&&(t.stopPropagation(),t.preventDefault(),this.value=!this.value):this.blur()},this._onFocus=()=>{this.emit("focus")},this._onBlur=()=>{this.emit("blur")},"toggle"===t.type?this.class.add(mT):this.class.add(pT),this.class.add(kC),this.dom.addEventListener("keydown",this._onKeyDown),this.dom.addEventListener("focus",this._onFocus),this.dom.addEventListener("blur",this._onBlur),this._value=null,void 0!==t.value&&(this.value=t.value),this.renderChanges=null!==(e=t.renderChanges)&&void 0!==e&&e}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),this.dom.removeEventListener("focus",this._onFocus),this.dom.removeEventListener("blur",this._onBlur),super.destroy())}_onClick(t){return this.enabled&&this.focus(),this.enabled&&!this.readOnly&&(this.value=!this.value),super._onClick(t)}_updateValue(t){return this.class.remove(PC),t!==this.value&&(this._value=t,t?this.class.add(fT):this.class.remove(fT),this.renderChanges&&this.flash(),this.emit("change",t),!0)}focus(){this.dom.focus()}blur(){this.dom.blur()}set value(t){this._updateValue(t)&&this._binding&&this._binding.setValue(t)}get value(){return this._value}set values(t){const e=t.some((e=>e!==t[0]));e?(this._updateValue(null),this.class.add(PC)):this._updateValue(t[0])}set renderChanges(t){this._renderChanges=t}get renderChanges(){return this._renderChanges}}FC.register("boolean",gT,{renderChanges:!0});var _T=gT;let vT=class extends uT{constructor(t={}){super(t),this.elementClass=_T}render(){return super.render()}};vT.ctor=_T;var bT=vT;let yT=class extends uT{constructor(t={}){super(t),this.elementClass=XC}render(){return op.createElement("button",{ref:this.attachElement})}};yT.ctor=XC;var xT=yT;const wT="pcui-overlay",ST=wT+"-inner",CT=wT+"-clickable",TT=wT+"-transparent",ET=wT+"-content";class PT extends GC{constructor(t={}){super(t),this._onMouseDown=t=>{this.clickable&&(document.body.blur(),requestAnimationFrame((()=>{this.hidden=!0})),t.preventDefault())},this.class.add(wT),this._domClickableOverlay=document.createElement("div"),this._domClickableOverlay.ui=this,this._domClickableOverlay.classList.add(ST),this.dom.appendChild(this._domClickableOverlay),this._domClickableOverlay.addEventListener("mousedown",this._onMouseDown),this.domContent=document.createElement("div"),this.domContent.ui=this,this.domContent.classList.add(ET),this.dom.appendChild(this.domContent),this.clickable=t.clickable||!1,this.transparent=t.transparent||!1}destroy(){this._destroyed||(this._domClickableOverlay.removeEventListener("mousedown",this._onMouseDown),super.destroy())}position(t,e){const s=this._domClickableOverlay.getBoundingClientRect(),i=this.domContent.getBoundingClientRect();t=Math.max(0,Math.min(s.width-i.width,t)),e=Math.max(0,Math.min(s.height-i.height,e)),this.domContent.style.position="absolute",this.domContent.style.left=`${t}px`,this.domContent.style.top=`${e}px`}set clickable(t){t?this.class.add(CT):this.class.remove(CT)}get clickable(){return this.class.contains(CT)}set transparent(t){t?this.class.add(TT):this.class.remove(TT)}get transparent(){return this.class.contains(TT)}}FC.register("overlay",PT);var MT=PT;let AT=class extends iT{constructor(t={}){super(t),this.class.add("pcui-text-input"),t.onValidate&&(this.onValidate=t.onValidate)}_onInputChange(t){if(!this._suspendInputChangeEvt){if(this._onValidate){const t=!this._onValidate(this.value);if(this.error=t,t)return}else this.error=!1;this.emit("change",this.value),this._binding&&this._binding.setValue(this.value)}}_updateValue(t){if(this.class.remove(PC),t&&"object"==typeof t)if(Array.isArray(t)){let e=!1;for(let s=0;s<t.length;s++)if(t[s]&&"object"==typeof t[s]){e=!0;break}t=e?"[Not available]":t.map((t=>null===t?"null":t)).join(",")}else t="[Not available]";return t!==this.value&&(this._suspendInputChangeEvt=!0,this._domInput.value=null==t?"":String(t),this._suspendInputChangeEvt=!1,this.emit("change",t),!0)}set value(t){const e=this._updateValue(t);e&&(this.error=!1),e&&this._binding&&this._binding.setValue(t)}get value(){return this._domInput.value}set values(t){const e=t.some((e=>e!==t[0]));e?(this._updateValue(null),this.class.add(PC)):this._updateValue(t[0])}set onValidate(t){this._onValidate=t}get onValidate(){return this._onValidate}};FC.register("string",AT,{renderChanges:!0});var kT=AT;function DT(t){const e=t[0]/255,s=t[1]/255,i=t[2]/255;let n,r;const a=Math.max(e,s,i),o=a-Math.min(e,s,i),l=t=>(a-t)/6/o+.5;if(0===o)return n=r=0,[n,r,a];r=o/a;const h=l(e),c=l(s),d=l(i);return e===a?n=d-c:s===a?n=1/3+h-d:i===a&&(n=2/3+c-h),n<0?n+=1:n>1&&(n-=1),[n,r,a]}function RT(t){const e=t[0],s=t[1],i=t[2];let n,r,a;const o=Math.floor(6*e),l=6*e-o,h=i*(1-s),c=i*(1-l*s),d=i*(1-(1-l)*s);switch(o%6){case 0:n=i,r=d,a=h;break;case 1:n=c,r=i,a=h;break;case 2:n=h,r=i,a=d;break;case 3:n=h,r=c,a=i;break;case 4:n=d,r=h,a=i;break;case 5:n=i,r=h,a=c}return[Math.round(255*n),Math.round(255*r),Math.round(255*a)]}let LT=class extends FC{constructor(t={}){var e,s,i;super(t),this._historyCombine=!1,this._historyPostfix=null,this._size=144,this._directInput=!0,this._colorHSV=[0,0,0],this._pickerChannels=[],this._channelsNumber=4,this._changing=!1,this._dragging=!1,this._callingCallback=!1,this._pickRectPointerId=null,this._pickHuePointerId=null,this._pickOpacityPointerId=null,this._evtColorPick=null,this._evtColorToPicker=null,this._evtColorPickStart=null,this._evtColorPickEnd=null,this._onKeyDown=t=>{"Escape"===t.key&&this.blur(),"Enter"===t.key&&this.enabled&&!this.readOnly&&(t.stopPropagation(),t.preventDefault())},this._onFocus=t=>{this.emit("focus")},this._onBlur=t=>{this.emit("blur")},this._pickRectPointerDown=t=>{null===this._pickRectPointerId&&(this._pickRect.setPointerCapture(t.pointerId),this._pickRectPointerId=t.pointerId,t.preventDefault(),t.stopPropagation(),this.emit("picker:color:start"),this._pickRectPointerMove(t))},this._pickRectPointerMove=t=>{if(this._pickRectPointerId!==t.pointerId)return;this._changing=!0;const e=this._pickRect.getBoundingClientRect(),s=Math.max(0,Math.min(this._size,Math.floor(t.clientX-e.left))),i=Math.max(0,Math.min(this._size,Math.floor(t.clientY-e.top)));this._colorHSV[1]=s/this._size,this._colorHSV[2]=1-i/this._size,this._directInput=!1;const n=RT(this._colorHSV);for(let t=0;t<3;t++)this._pickerChannels[t].value=n[t];this._fieldHex.value=this._getHex(),this._directInput=!0,this._pickRectHandle.style.left=Math.max(4,Math.min(this._size-4,s))+"px",this._pickRectHandle.style.top=Math.max(4,Math.min(this._size-4,i))+"px",this._changing=!1},this._pickRectPointerUp=t=>{this._pickRectPointerId===t.pointerId&&(this.emit("picker:color:end"),this._pickRect.releasePointerCapture(t.pointerId),this._pickRectPointerId=null)},this._pickHuePointerDown=t=>{null===this._pickHuePointerId&&(this._pickHue.setPointerCapture(t.pointerId),this._pickHuePointerId=t.pointerId,t.preventDefault(),t.stopPropagation(),this.emit("picker:color:start"),this._pickHuePointerMove(t))},this._pickHuePointerMove=t=>{if(this._pickHuePointerId!==t.pointerId)return;this._changing=!0;const e=this._pickHue.getBoundingClientRect(),s=Math.max(0,Math.min(this._size,Math.floor(t.clientY-e.top)))/this._size,i=RT([s,this._colorHSV[1],this._colorHSV[2]]);this._colorHSV[0]=s,this._directInput=!1;for(let t=0;t<3;t++)this._pickerChannels[t].value=i[t];this._fieldHex.value=this._getHex(),this._onChangeRgb(),this._directInput=!0,this._changing=!1},this._pickHuePointerUp=t=>{this._pickHuePointerId===t.pointerId&&(this.emit("picker:color:end"),this._pickHue.releasePointerCapture(t.pointerId),this._pickHuePointerId=null)},this._pickOpacityPointerDown=t=>{null===this._pickOpacityPointerId&&(this._pickOpacity.setPointerCapture(t.pointerId),this._pickOpacityPointerId=t.pointerId,t.preventDefault(),t.stopPropagation(),this.emit("picker:color:start"),this._pickOpacityPointerMove(t))},this._pickOpacityPointerMove=t=>{if(this._pickOpacityPointerId!==t.pointerId)return;this._changing=!0;const e=this._pickOpacity.getBoundingClientRect(),s=1-Math.max(0,Math.min(this._size,Math.floor(t.clientY-e.top)))/this._size;this._directInput=!1,this._pickerChannels[3].value=Math.max(0,Math.min(255,Math.round(255*s))),this._fieldHex.value=this._getHex(),this._directInput=!0,this._changing=!1},this._pickOpacityPointerUp=t=>{this._pickOpacityPointerId===t.pointerId&&(this.emit("picker:color:end"),this._pickOpacity.releasePointerCapture(t.pointerId),this._pickOpacityPointerId=null)},this.class.add("pcui-color-input",kC),this._domColor=document.createElement("div"),this.dom.appendChild(this._domColor),this.dom.addEventListener("keydown",this._onKeyDown),this.dom.addEventListener("focus",this._onFocus),this.dom.addEventListener("blur",this._onBlur),this.on("click",(()=>{this.enabled&&!this.readOnly&&this._openColorPicker()})),this._value=null!==(e=t.value)&&void 0!==e?e:[0,0,255,1],this._channels=null!==(s=t.channels)&&void 0!==s?s:3,this._setValue(this._value),this.renderChanges=null!==(i=t.renderChanges)&&void 0!==i&&i,this.on("change",(()=>{this.renderChanges&&this.flash()})),this._overlay=new MT({class:"picker-color",clickable:!0,hidden:!0,transparent:!0}),this.dom.appendChild(this._overlay.dom),this._pickRect=document.createElement("div"),this._pickRect.classList.add("pick-rect"),this._overlay.append(this._pickRect),this._pickRect.addEventListener("pointerdown",this._pickRectPointerDown),this._pickRect.addEventListener("pointermove",this._pickRectPointerMove),this._pickRect.addEventListener("pointerup",this._pickRectPointerUp),this._pickRectWhite=document.createElement("div"),this._pickRectWhite.classList.add("white"),this._pickRect.appendChild(this._pickRectWhite),this._pickRectBlack=document.createElement("div"),this._pickRectBlack.classList.add("black"),this._pickRect.appendChild(this._pickRectBlack),this._pickRectHandle=document.createElement("div"),this._pickRectHandle.classList.add("handle"),this._pickRect.appendChild(this._pickRectHandle),this._pickHue=document.createElement("div"),this._pickHue.classList.add("pick-hue"),this._overlay.append(this._pickHue),this._pickHue.addEventListener("pointerdown",this._pickHuePointerDown),this._pickHue.addEventListener("pointermove",this._pickHuePointerMove),this._pickHue.addEventListener("pointerup",this._pickHuePointerUp),this._pickHueHandle=document.createElement("div"),this._pickHueHandle.classList.add("handle"),this._pickHue.appendChild(this._pickHueHandle),this._pickOpacity=document.createElement("div"),this._pickOpacity.classList.add("pick-opacity"),this._overlay.append(this._pickOpacity),this._pickOpacity.addEventListener("pointerdown",this._pickOpacityPointerDown),this._pickOpacity.addEventListener("pointermove",this._pickOpacityPointerMove),this._pickOpacity.addEventListener("pointerup",this._pickOpacityPointerUp),this._pickOpacityHandle=document.createElement("div"),this._pickOpacityHandle.classList.add("handle"),this._pickOpacity.appendChild(this._pickOpacityHandle),this._panelFields=document.createElement("div"),this._panelFields.classList.add("fields"),this._overlay.append(this._panelFields),this._overlay.on("hide",(()=>{this._evtColorPick.unbind(),this._evtColorPick=null,this._evtColorToPicker.unbind(),this._evtColorToPicker=null,this._evtColorPickStart.unbind(),this._evtColorPickStart=null,this._evtColorPickEnd.unbind(),this._evtColorPickEnd=null}));const n=t=>new cT({class:["field","field-"+t],precision:0,step:1,min:0,max:255,placeholder:t}),r=n("r");r.on("change",(()=>{this._onChangeRgb()})),this._pickerChannels.push(r),this._panelFields.appendChild(r.dom);const a=n("g");a.on("change",(()=>{this._onChangeRgb()})),this._pickerChannels.push(a),this._panelFields.appendChild(a.dom);const o=n("b");o.on("change",(()=>{this._onChangeRgb()})),this._pickerChannels.push(o),this._panelFields.appendChild(o.dom);const l=n("a");l.on("change",(t=>{this._onChangeAlpha(t)})),this._pickerChannels.push(l),this._panelFields.appendChild(l.dom),this._fieldHex=new kT({class:["field","field-hex"],placeholder:"#"}),this._fieldHex.on("change",(()=>{this._onChangeHex()})),this._panelFields.appendChild(this._fieldHex.dom)}destroy(){this._destroyed||(this.dom.removeEventListener("keydown",this._onKeyDown),this.dom.removeEventListener("focus",this._onFocus),this.dom.removeEventListener("blur",this._onBlur),this._pickRect.removeEventListener("pointerdown",this._pickRectPointerDown),this._pickRect.removeEventListener("pointermove",this._pickRectPointerMove),this._pickRect.removeEventListener("pointerup",this._pickRectPointerUp),this._pickHue.removeEventListener("pointerdown",this._pickHuePointerDown),this._pickHue.removeEventListener("pointermove",this._pickHuePointerMove),this._pickHue.removeEventListener("pointerup",this._pickHuePointerUp),this._pickOpacity.removeEventListener("pointerdown",this._pickOpacityPointerDown),this._pickOpacity.removeEventListener("pointermove",this._pickOpacityPointerMove),this._pickOpacity.removeEventListener("pointerup",this._pickOpacityPointerUp),super.destroy())}focus(){this.dom.focus()}blur(){this.dom.blur()}_setColorPickerPosition(t,e){this._overlay.position(t,e)}_setPickerColor(t){if(!this._changing&&!this._dragging){if(this._channelsNumber>=3){const e=DT(t);this._colorHSV[0]=e[0],this._colorHSV[1]=e[1],this._colorHSV[2]=e[2]}this._directInput=!1;for(let e=0;e<t.length;e++)this._pickerChannels[e].value=t[e];this._fieldHex.value=this._getHex(),this._directInput=!0}}_openColorPicker(){this._callPicker(this.value.map((t=>Math.floor(255*t)))),this._evtColorPick=this.on("picker:color",(t=>{this.value=t.map((t=>t/255))})),this._evtColorPickStart=this.on("picker:color:start",(()=>{this.binding?(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this._binding.historyPostfix=`(${Date.now()})`):(this._historyCombine=!1,this._historyPostfix=null)})),this._evtColorPickEnd=this.on("picker:color:end",(()=>{this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix)}));const t=this._overlay.dom.getBoundingClientRect(),e=this.dom.getBoundingClientRect();this._setColorPickerPosition(e.left-t.width,e.top+25),this._evtColorToPicker=this.on("change",(()=>{this._setPickerColor(this.value.map((t=>Math.floor(255*t))))}))}_callPicker(t){for(let e=0;e<4;e++)t.length-1<e?this._overlay.class.remove("c-"+(e+1)):this._overlay.class.add("c-"+(e+1));if(this._channelsNumber=t.length,this._channelsNumber>=3){const e=DT(t);this._colorHSV[0]=e[0],this._colorHSV[1]=e[1],this._colorHSV[2]=e[2]}this._directInput=!1;for(let e=0;e<t.length;e++)this._pickerChannels[e].value=t[e];this._fieldHex.value=this._getHex(),this._directInput=!0,this._overlay.hidden=!1,this._fieldHex.dom.focus(),window.setTimeout((()=>{this._fieldHex.dom.focus()}),100)}_valueToColor(t){return t=Math.floor(255*t),Math.max(0,Math.min(t,255))}_setValue(t){const e=this._valueToColor(t[0]),s=this._valueToColor(t[1]),i=this._valueToColor(t[2]),n=t[3];1===this._channels?this._domColor.style.backgroundColor=`rgb(${e}, ${e}, ${e})`:3===this._channels?this._domColor.style.backgroundColor=`rgb(${e}, ${s}, ${i})`:4===this._channels&&(this._domColor.style.backgroundColor=`rgba(${e}, ${s}, ${i}, ${n})`)}_updateValue(t){let e=!1;for(let s=0;s<t.length;s++)this._value[s]!==t[s]&&(e=!0,this._value[s]=t[s]);return this.class.remove(PC),e&&(this._setValue(t),this.emit("change",t)),e}_getHex(){let t="";for(let e=0;e<this._channelsNumber;e++)t+=("00"+this._pickerChannels[e].value.toString(16)).slice(-2).toUpperCase();return t}_onChangeHex(){if(!this._directInput)return;this._changing=!0;const t=this._fieldHex.value.trim().toLowerCase();if(/^([0-9a-f]{2}){3,4}$/.test(t))for(let e=0;e<this._channelsNumber;e++)this._pickerChannels[e].value=parseInt(t.slice(2*e,2*e+2),16);this._changing=!1}_onChangeRgb(){const t=this._pickerChannels.map((function(t){return t.value||0})).slice(0,this._channelsNumber),e=DT(t);if(this._directInput){const s=t[0]+t[1]+t[2];765!==s&&0!==s&&(this._colorHSV[0]=e[0]),this._colorHSV[1]=e[1],this._colorHSV[2]=e[2],this._dragging=!0,this.emit("picker:color:start")}if(this._pickHueHandle.style.top=Math.floor(this._size*this._colorHSV[0])+"px",this._pickRectHandle.style.left=Math.max(4,Math.min(this._size-4,this._size*this._colorHSV[1]))+"px",this._pickRectHandle.style.top=Math.max(4,Math.min(this._size-4,this._size*(1-this._colorHSV[2])))+"px",this._channelsNumber>=3){const e=RT([this._colorHSV[0],1,1]).join(",");this._pickRect.style.backgroundColor="rgb("+e+")",this._pickRectHandle.style.backgroundColor="rgb("+t.slice(0,3).join(",")+")",this._pickHueHandle.style.backgroundColor="rgb("+e+")"}this.callCallback()}_onChangeAlpha(t){4===this._channelsNumber&&(this._pickOpacityHandle.style.top=Math.floor(this._size*(1-Math.max(0,Math.min(255,t))/255))+"px",this._pickOpacityHandle.style.backgroundColor=`rgb(${t}, ${t}, ${t})`,this.callCallback())}callbackHandle(){this._callingCallback=!1,this.emit("picker:color",this._pickerChannels.map((function(t){return t.value||0})).slice(0,this._channelsNumber))}callCallback(){this._callingCallback||(this._callingCallback=!0,window.setTimeout((()=>{this.callbackHandle()}),1e3/60))}set value(t){t=t||[0,0,0,0];this._updateValue(t)&&this._binding&&this._binding.setValue(t)}get value(){return this._value.slice(0,this._channels)}set values(t){let e=!1;const s=t[0];for(let i=1;i<t.length;i++)if(Array.isArray(s)){if(!s.equals(t[i])){e=!0;break}}else if(s!==t[i]){e=!0;break}e?(this.value=null,this.class.add(PC)):this.value=t[0]}set channels(t){this._channels!==t&&(this._channels=Math.max(0,Math.min(t,4)),this._setValue(this.value))}get channels(){return this._channels}set renderChanges(t){this._renderChanges=t}get renderChanges(){return this._renderChanges}};FC.register("rgb",LT),FC.register("rgba",LT,{channels:4});var IT=LT;class OT extends uT{constructor(t){super(t),this.elementClass=IT}render(){return op.createElement("div",{ref:this.attachElement})}}OT.ctor=IT;var FT=OT;let BT=class extends uT{constructor(t={}){super(t),this.getParent=()=>this,this.elementClass=GC}componentDidMount(){this.props.onResize&&this.element.on("resize",this.props.onResize)}render(){let t=op.Children.toArray(this.props.children);return 1===t.length?t=op.cloneElement(t[0],{parent:this.element}):t.length>0&&(t=t.map((t=>op.cloneElement(t,{parent:this.element})))),op.createElement("div",{ref:this.attachElement},t)}};BT.ctor=GC;var zT=BT;const NT=(t,e)=>{if(0===t.length)return e.length;if(0===e.length)return t.length;if(t===e)return 0;const s=[];for(let t=0;t<=e.length;t++)s[t]=[t];for(let e=0;e<=t.length;e++)s[0][e]=e;for(let i=1;i<=e.length;i++)for(let n=1;n<=t.length;n++)e.charAt(i-1)===t.charAt(n-1)?s[i][n]=s[i-1][n-1]:s[i][n]=Math.min(s[i-1][n-1]+1,Math.min(s[i][n-1]+1,s[i-1][n]+1));return s[e.length][t.length]},UT=(t,e)=>{if(t===e)return t.length;let s=0;const i=new Set;for(let t=0;t<e.length;t++)i.add(e.charAt(t));for(let e=0;e<t.length;e++)i.has(t.charAt(e))&&s++;return s},VT=t=>{const e=[],s=t.replace(/([^A-Z])([A-Z][^A-Z])/g,"$1 $2").replace(/([A-Z0-9]{2,})/g," $1").split(/(\s|\-|_)/g);for(let t=0;t<s.length;t++)s[t]=s[t].toLowerCase().trim(),s[t]&&"-"!==s[t]&&"_"!==s[t]&&e.push(s[t]);return e},HT=(t,e,s)=>{const i=[];for(const n of t){if(n.subFull!==1/0){i.push(n),n.edits===1/0&&(n.edits=0),n.sub===1/0&&(n.sub=n.subFull);continue}if(n.name===e||0===n.name.indexOf(e)){i.push(n),n.edits===1/0&&(n.edits=0),n.sub===1/0&&(n.sub=0);continue}if(UT(e,n.name)/e.length<s.containsCharsTolerance)continue;let t=1/0,r=1/0;for(let i=0;i<n.tokens.length;i++){if(n.tokens[i]===e){t=0,r=i;break}const a=NT(e,n.tokens[i]);(r===1/0||a<t)&&-1!==n.tokens[i].indexOf(e)?(r=i,t=a):r===1/0&&a<t&&a/Math.max(e.length,n.tokens[i].length)<=s.editsDistanceTolerance&&(t=a)}t!==1/0&&(i.push(n),n.edits=n.edits===1/0?t:n.edits+t,n.sub=n.sub===1/0?r:n.sub+r)}return i},GT=(t,e="",s={})=>{if(!(e=e.toLowerCase().trim()))return[];const i=VT(e);if(!i.length)return[];s.containsCharsTolerance=s.containsCharsTolerance||.5,s.editsDistanceTolerance=s.editsDistanceTolerance||.5;let n=[];for(const s of t){const t=s[0].toLowerCase().trim().indexOf(e);n.push({name:s[0],item:s[1],tokens:VT(s[0]),edits:1/0,subFull:-1!==t?t:1/0,sub:1/0})}for(let t=0;t<i.length;t++)n=HT(n,i[t],s);n.sort(((t,e)=>t.subFull!==e.subFull?t.subFull-e.subFull:t.sub!==e.sub?t.sub-e.sub:t.edits!==e.edits?t.edits-e.edits:t.name.length-e.name.length));let r=n.map((t=>t.item));return s.hasOwnProperty("limitResults")&&r.length>s.limitResults&&(r=r.slice(0,s.limitResults)),r},WT="pcui-select-input",jT=WT+"-container-value",qT=WT+"-multi",XT=WT+"-disabled-value",$T=WT+"-has-disabled-value",KT=WT+"-value",YT=WT+"-icon",QT=WT+"-textinput",JT=WT+"-list",ZT=WT+"-tags",tE=WT+"-tags-empty",eE=WT+"-tag",sE=WT+"-tag-not-everywhere",iE=WT+"-shadow",nE=WT+"-fit-height",rE="pcui-selected",aE=WT+"-label-highlighted",oE=WT+"-create-new",lE="pcui-open";class hE extends FC{constructor(t={}){var e,s,i,n;const r=new GC({dom:t.dom});super(Object.assign(Object.assign({},t),{dom:r.dom})),this._timeoutLabelValueTabIndex=null,this._valueToText={},this._valueToLabel={},this._labelToValue=new Map,this._labelHighlighted=null,this._disabledOptions={},this._prefix="",this._onInputChange=t=>{this._suspendInputChange||this._lastInputValue!==t&&(this.open(),this._lastInputValue=t,this._filterOptions(t))},this._onInputKeyDown=t=>{if("Enter"===t.key&&this.enabled&&!this.readOnly){let e;if(t.stopPropagation(),t.preventDefault(),e=this._labelHighlighted&&this._labelToValue.has(this._labelHighlighted)?this._labelToValue.get(this._labelHighlighted):this._input.value,void 0!==e)return this.focus(),this.close(),void(this._valueToText[e]?this._onSelectValue(e):this._allowCreate&&(this._createFn?this._createFn(e):this._onSelectValue(e)))}this._onKeyDown(t)},this._onWindowMouseDown=t=>{this.dom.contains(t.target)||this.close()},this._onKeyDown=t=>{if("Escape"!==t.key)if("Tab"!==t.key){if(this.enabled&&!this.readOnly)if("Enter"!==t.key||this._allowInput){if("ArrowUp"===t.key||"ArrowDown"===t.key)if(t.stopPropagation(),t.preventDefault(),(this._allowInput||this.multiSelect)&&this._containerOptions.hidden)this.open();else if(this._containerOptions.hidden){if(!this._options.length)return;let e=-1;for(let t=0;t<this._options.length;t++)if(this._options[t].v===this.value){e=t;break}"ArrowUp"===t.key?e--:"ArrowDown"===t.key&&e++,e>=0&&e<this._options.length&&this._onSelectValue(this._options[e].v)}else{if(!this._containerOptions.dom.childNodes.length)return;if(this._labelHighlighted){let e=this._labelHighlighted.dom;do{"ArrowUp"===t.key?e=e.previousSibling:"ArrowDown"===t.key&&(e=e.nextSibling)}while(e&&e.ui.hidden);e&&this._highlightLabel(e.ui)}else this._highlightLabel(this._containerOptions.dom.childNodes[0].ui)}}else this._labelHighlighted&&this._labelToValue.has(this._labelHighlighted)&&(this._onSelectValue(this._labelToValue.get(this._labelHighlighted)),this.close())}else this.close();else this.close()},this._onMouseDown=()=>{this._allowInput||this.focus()},this._onFocus=()=>{this.class.add(EC),this.emit("focus"),this._input.hidden||this.open()},this._onBlur=()=>{this.class.remove(EC),this.emit("blur")},this._onWheel=t=>{t.stopPropagation()},this._container=r,this._container.parent=this,this.class.add(WT),this._containerValue=new GC({class:jT}),this._container.append(this._containerValue),this._domShadow=document.createElement("div"),this._domShadow.classList.add(iE),this._containerValue.append(this._domShadow),this._allowInput=t.allowInput,this._allowInput&&this.class.add("pcui-select-input-allow-input"),this._allowCreate=t.allowCreate,this._createFn=t.createFn,this._createLabelText=t.createLabelText,this._labelValue=new jC({class:KT,tabIndex:0}),this._labelValue.on("click",(()=>{this.enabled&&!this.readOnly&&this.toggle()})),this._containerValue.append(this._labelValue),this._labelIcon=new jC({class:YT,hidden:t.allowInput&&t.multiSelect}),this._containerValue.append(this._labelIcon),this._input=new kT({class:QT,blurOnEnter:!1,keyChange:!0}),this._containerValue.append(this._input),this._lastInputValue="",this._suspendInputChange=!1,this._input.on("change",this._onInputChange),this._input.on("keydown",this._onInputKeyDown),this._input.on("focus",this._onFocus),this._input.on("blur",this._onBlur),t.placeholder&&(this.placeholder=t.placeholder),this._containerOptions=new GC({class:JT,hidden:!0}),this._containerValue.append(this._containerOptions),this._containerTags=new GC({class:ZT,flex:!0,flexDirection:"row",hidden:!0}),this._container.append(this._containerTags),t.multiSelect&&(this.class.add(qT),this._containerTags.hidden=!1),this._labelValue.dom.addEventListener("keydown",this._onKeyDown),this._labelValue.dom.addEventListener("focus",this._onFocus),this._labelValue.dom.addEventListener("blur",this._onBlur),this._labelValue.dom.addEventListener("mousedown",this._onMouseDown),this._containerOptions.dom.addEventListener("wheel",this._onWheel,{passive:!0}),this.on("hide",(()=>{this.close()})),this._type=null!==(e=t.type)&&void 0!==e?e:"string",this.invalidOptions=null!==(s=t.invalidOptions)&&void 0!==s?s:[],this.options=null!==(i=t.options)&&void 0!==i?i:[],this._optionsFn=t.optionsFn,this._allowNull=t.allowNull,this._values=null,void 0!==t.value?this.value=t.value:t.defaultValue?this.value=t.defaultValue:this.value=null,this._renderChanges=t.renderChanges,this.on("change",(()=>{this._updateInputFieldsVisibility(),this.renderChanges&&!this.multiSelect&&this._labelValue.flash()})),this._updateInputFieldsVisibility(!1),this._onSelect=t.onSelect,this.fallbackOrder=t.fallbackOrder,this.disabledOptions=t.disabledOptions,this._prefix=null!==(n=t.prefix)&&void 0!==n?n:""}destroy(){this._destroyed||(this._labelValue.dom.removeEventListener("keydown",this._onKeyDown),this._labelValue.dom.removeEventListener("mousedown",this._onMouseDown),this._labelValue.dom.removeEventListener("focus",this._onFocus),this._labelValue.dom.removeEventListener("blur",this._onBlur),this._containerOptions.dom.removeEventListener("wheel",this._onWheel),window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("mousedown",this._onWindowMouseDown),this._timeoutLabelValueTabIndex&&(cancelAnimationFrame(this._timeoutLabelValueTabIndex),this._timeoutLabelValueTabIndex=null),super.destroy())}_initializeCreateLabel(){const t=new GC({class:oE,flex:!0,flexDirection:"row"}),e=new jC({text:this._input.value,tabIndex:-1});t.append(e);let s=this._input.on("change",(s=>{e.destroyed||(e.text=s,this.invalidOptions&&-1!==this.invalidOptions.indexOf(s)?t.hidden||(t.hidden=!0,this._resizeShadow()):t.hidden&&(t.hidden=!1,this._resizeShadow()))}));t.on("click",(t=>{t.stopPropagation();const s=e.text;this.focus(),this.close(),this._createFn?this._createFn(s):s&&this._onSelectValue(s)})),e.on("destroy",(()=>{s.unbind(),s=null}));const i=new jC({text:this._createLabelText});return t.append(i),this._containerOptions.append(t),t}_convertSingleValue(t){if(null===t&&this._allowNull)return t;if("string"===this._type)t=t?t.toString():"";else if("number"===this._type)t=t?parseInt(t,10):0;else if("boolean"===this._type)return!!t;return t}_convertValue(t){return null===t&&this._allowNull?t:this.multiSelect?Array.isArray(t)?t.map((t=>this._convertSingleValue(t))):t:this._convertSingleValue(t)}_onSelectValue(t){if(t=this._convertSingleValue(t),this.multiSelect)if(this._values){let e=!1;this._values.forEach((s=>{s?-1===s.indexOf(t)&&(s.push(t),e=!0):(s=[t],e=!0)})),e&&(this._onMultipleValuesChange(this._values),this.emit("change",this.value),this._binding&&this._binding.addValues([t]))}else this._value&&Array.isArray(this._value)?-1===this._value.indexOf(t)&&(this._value.push(t),this._addTag(t),this.emit("change",this.value),this._binding&&this._binding.addValues([t])):this.value=[t];else this.value=t}_highlightLabel(t){if(this._labelHighlighted!==t&&(this._labelHighlighted&&this._labelHighlighted.class.remove(aE),this._labelHighlighted=t,this._labelHighlighted)){this._labelHighlighted.class.add(aE);const t=this._labelHighlighted.dom.offsetTop,e=this._containerOptions.dom.scrollTop;t<e?this._containerOptions.dom.scrollTop=t:t+this._labelHighlighted.height>this._containerOptions.height+e&&(this._containerOptions.dom.scrollTop=t+this._labelHighlighted.height-this._containerOptions.height)}}_onValueChange(t){if(this.multiSelect){if(this._labelValue.value="",this._containerTags.clear(),this._containerTags.class.add(tE),t&&Array.isArray(t)){for(const e of t){this._addTag(e);const t=this._valueToLabel[e];t&&t.class.add(rE)}for(const e in this._valueToLabel){const s=this._valueToLabel[e];-1!==t.indexOf(this._convertSingleValue(e))?s.class.add(rE):s.class.remove(rE)}}}else{this._labelValue.value=this._prefix+(this._valueToText[t]||""),t=""+t;for(const e in this._valueToLabel){const s=this._valueToLabel[e];e===t?s.class.add(rE):s.class.remove(rE)}}}_onMultipleValuesChange(t){this._labelValue.value="",this._containerTags.clear(),this._containerTags.class.add(tE);const e={},s={};t.forEach((t=>{t&&t.forEach((t=>{e[t]?s[t]++:(e[t]=this._addTag(t),s[t]=1)}))}));for(const i in s)if(s[i]!==t.length){e[i].class.add(sE);const t=this._valueToLabel[i];t&&t.class.remove(rE)}}_addTag(t){const e=new GC({flex:!0,flexDirection:"row",class:eE});e.append(new jC({text:this._valueToText[t]||t}));const s=new XC({size:"small",icon:"E132",tabIndex:-1});e.append(s),s.on("click",(()=>this._removeTag(e,t))),this._containerTags.append(e),this._containerTags.class.remove(tE);const i=this._valueToLabel[t];return i&&i.class.add(rE),e.value=t,e}_removeTag(t,e){t.destroy();const s=this._valueToLabel[e];if(s&&s.class.remove(rE),this._values)this._values.forEach((t=>{if(!t)return;const s=t.indexOf(e);-1!==s&&t.splice(s,1)}));else if(this._value&&Array.isArray(this._value)){const t=this._value.indexOf(e);-1!==t&&this._value.splice(t,1)}this.emit("change",this.value),this._binding&&this._binding.removeValues([e])}_filterOptions(t){const e=this._containerOptions.dom;for(;e.firstChild;)e.removeChild(e.lastChild);if(t){const s=this.options.map((t=>[t.t,t.v]));GT(s,t).forEach((t=>{const s=this._valueToLabel[t];e.appendChild(s.dom)}))}else for(const t of this._options){const s=this._valueToLabel[t.v];e.appendChild(s.dom)}this._createLabelContainer&&e.appendChild(this._createLabelContainer.dom),e.firstChild&&this._highlightLabel(e.firstChild.ui),this._resizeShadow()}_resizeShadow(){this._domShadow.style.height=this._containerValue.height+this._containerOptions.height+"px"}_updateInputFieldsVisibility(t){let e=!1,s=!1;this._allowInput&&(t?(e=!0,s=!0):e=this.multiSelect||!this._valueToLabel[this.value]),this._labelValue.hidden=e,this._labelIcon.hidden=e,this._input.hidden=!e,s&&this._input.focus(),this._labelValue.hidden||(this._labelValue.tabIndex=-1,this._timeoutLabelValueTabIndex||(this._timeoutLabelValueTabIndex=requestAnimationFrame((()=>{this._timeoutLabelValueTabIndex=null,this._labelValue.tabIndex=0}))))}focus(){this._input.hidden?this._labelValue.dom.focus():this._input.focus()}blur(){this._allowInput?this._input.blur():this._labelValue.dom.blur()}open(){if(!this._containerOptions.hidden||!this.enabled||this.readOnly)return;if(this._updateInputFieldsVisibility(!0),this._optionsFn&&(this.options=this._optionsFn()),0===this._containerOptions.dom.childNodes.length)return;this._containerOptions.forEachChild((t=>{t.hidden=!1,this._labelToValue.get(t)===this.value&&this._highlightLabel(t)})),this._labelHighlighted||this._highlightLabel(this._containerOptions.dom.childNodes[0].ui),this._containerOptions.hidden=!1,this.class.add(lE),window.addEventListener("keydown",this._onKeyDown),window.addEventListener("mousedown",this._onWindowMouseDown);const t=(this._allowInput?this._input.dom:this._labelValue.dom).getBoundingClientRect();let e=t.bottom+this._containerOptions.height+25>=window.innerHeight;e&&t.top-this._containerOptions.height<0&&(e=!1,this._containerOptions.style.maxHeight=window.innerHeight-t.bottom-25+"px"),e?this.class.add(nE):this.class.remove(nE),this._resizeShadow()}close(){this._containerOptions.style.maxHeight="",this._highlightLabel(null),this._updateInputFieldsVisibility(!1),this._suspendInputChange=!0,this._input.value="",this._lastInputValue&&(this._lastInputValue="",this._filterOptions(null)),this._suspendInputChange=!1,this._containerOptions.hidden||(this._containerOptions.hidden=!0,this._domShadow.style.height="",this.class.remove(lE),window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("mousedown",this._onWindowMouseDown))}toggle(){this._containerOptions.hidden?this.open():this.close()}unlink(){super.unlink(),this._containerOptions.hidden||this.close()}_updateValue(t){t!==this._value&&(this._value=t,this._onValueChange(t),this._suppressChange||this.emit("change",t),this._binding&&this._binding.setValue(t))}_updateDisabledValue(t){const e={};this._containerOptions.forEachChild((t=>{e[t.dom.id]=t,this._disabledOptions[t.dom.id]?(t.enabled=!1,t.text=this._disabledOptions[t.dom.id]):(t.enabled=!0,t.text=this._valueToText[t.dom.id]),t.class.remove(XT)}));const s=this._disabledOptions[t]?t:null;let i=null;if(s){if(this._fallbackOrder)for(let e=0;e<this._fallbackOrder.length;e++)if(this._fallbackOrder[e]!==t){i=this._fallbackOrder[e];break}this.disabledValue=s,e[s].class.add(XT)}else this._disabledValue?(i=this._disabledValue,this.disabledValue=null):(i=t,this.disabledValue=null);return i}set options(t){if(!this._options||JSON.stringify(this._options)!==JSON.stringify(t)){this._containerOptions.clear(),this._labelHighlighted=null,this._valueToText={},this._valueToLabel={},this._options=t;for(const t of this._options){if(this._valueToText[t.v]=t.t,""===t.v)return;const e=new jC({text:t.t,tabIndex:-1,id:t.v});this._labelToValue.set(e,t.v),this._valueToLabel[t.v]=e,e.on("click",(e=>{e.stopPropagation(),this._onSelectValue(t.v),this.close(),this._onSelect&&this._onSelect(this.value)})),this._containerOptions.append(e)}this._createLabelContainer=null,this._createLabelText&&(this._createLabelContainer=this._initializeCreateLabel()),this.multiSelect&&this._values?this._onMultipleValuesChange(this._values):this._onValueChange(this.value),this._lastInputValue&&this._filterOptions(this._lastInputValue)}}get options(){return this._options.slice()}set invalidOptions(t){this._invalidOptions=t||null}get invalidOptions(){return this._invalidOptions}set disabledValue(t){this._disabledValue=t,null!==this._disabledValue?this.class.add($T):this.class.remove($T)}set disabledOptions(t){if(JSON.stringify(this._disabledOptions)===JSON.stringify(t))return;this._disabledOptions=t||{};const e=this._updateDisabledValue(this._value);this._updateValue(e)}set fallbackOrder(t){this._fallbackOrder=t||null}get multiSelect(){return this.class.contains(qT)}set value(t){this._values=null,this._suspendInputChange=!0,this._input.value="",this._lastInputValue&&(this._lastInputValue="",this._filterOptions(null)),this._suspendInputChange=!1,this.class.remove(PC),t=this._convertValue(t),(!(this._value===t||this.multiSelect&&this._value&&this._value.equals(t))||null===t&&this._allowNull&&this.class.contains(PC))&&(this.disabledValue=null,this._updateValue(t))}get value(){if(!this.multiSelect)return this._value;const t=[];return this._containerTags.dom.childNodes.forEach((e=>{t.push(e.ui.value)})),t}set values(t){t=t.map((t=>this._convertValue(t)));let e=!1;const s=t[0],i=this.multiSelect;this._values=null;for(let n=1;n<t.length;n++)if(!(t[n]===s||i&&t[n]&&t[n].equals(s))){e=!0;break}e?(this._labelValue.values=t,i?(this._values=t,this._value=null,this._onMultipleValuesChange(this._values),this.emit("change",this.value)):null!==this._value&&(this._value=null,this.emit("change",null)),this.class.add(PC)):this.value=t[0]}set placeholder(t){this._input.placeholder=t}get placeholder(){return this._input.placeholder}set renderChanges(t){this._renderChanges=t}get renderChanges(){return this._renderChanges}}FC.register("select",hE,{renderChanges:!0}),FC.register("multiselect",hE,{multiSelect:!0,renderChanges:!0}),FC.register("tags",hE,{allowInput:!0,allowCreate:!0,multiSelect:!0,renderChanges:!0});var cE=hE;let dE=class extends GC{constructor(t={}){var e,s,i,n;super(t),this._titleElement=new FC,this._textElement=new FC,this.class.add("pcui-infobox"),this.append(this._titleElement),this.append(this._textElement),this._unsafe=null!==(e=t.unsafe)&&void 0!==e&&e,this.icon=null!==(s=t.icon)&&void 0!==s?s:"",this.title=null!==(i=t.title)&&void 0!==i?i:"",this.text=null!==(n=t.text)&&void 0!==n?n:""}set icon(t){this._icon!==t&&(this._icon=t,t?this.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(t,16))):this.dom.removeAttribute("data-icon"))}get icon(){return this._icon}set title(t){this._title!==t&&(this._title=t,this._unsafe?this._titleElement.dom.innerHTML=t:this._titleElement.dom.textContent=t)}get title(){return this._title}set text(t){this._text!==t&&(this._text=t,this._unsafe?this._textElement.dom.innerHTML=t:this._textElement.dom.textContent=t)}get text(){return this._text}};FC.register("infobox",dE);var uE=dE;class pE extends uT{constructor(t){super(t),this.elementClass=uE}render(){return op.createElement("span",{ref:this.attachElement})}}pE.ctor=uE;var fE=pE;let mE=class extends uT{constructor(t={}){super(t),this.elementClass=jC}render(){return op.createElement("span",{ref:this.attachElement})}};mE.ctor=jC;var gE=mE;let _E=class extends uT{constructor(t){super(t),this.elementClass=cT}render(){return super.render()}};_E.ctor=cT;var vE=_E;let bE=class extends uT{constructor(t={}){super(t),this.elementClass=sT}componentDidMount(){this.attachElement(this.nodeElement,this.containerElement)}render(){let t=op.Children.toArray(this.props.children);return 1===t.length?t=op.cloneElement(t[0],{parent:this.element}):t.length>0&&(t=t.map((t=>op.cloneElement(t,{parent:this.element})))),op.createElement("div",{ref:t=>{this.nodeElement=t}},op.createElement("div",{ref:t=>{this.containerElement=t}},t))}};bE.ctor=sT;var yE=bE;let xE=class extends uT{constructor(t){super(t),this.elementClass=cE,this.onSelect=t.onSelect,this.onAttach=this.onAttachFn.bind(this)}onAttachFn(){this.props.onSelect&&this.element.on("select",this.onSelect)}render(){return super.render()}};xE.ctor=cE;var wE=xE;const SE="pcui-slider",CE=SE+"-container",TE=SE+"-bar",EE=SE+"-handle",PE=SE+"-active",ME=/Chrome\//.test(navigator.userAgent);class AE extends FC{constructor(t={}){var e,s,i,n,r;super(t),this._historyCombine=!1,this._historyPostfix=null,this._cursorHandleOffset=0,this._touchId=null,this._onMouseDown=t=>{0===t.button&&this.enabled&&!this.readOnly&&this._onSlideStart(t.pageX)},this._onMouseMove=t=>{t.stopPropagation(),t.preventDefault(),this._onSlideMove(t.pageX)},this._onMouseUp=t=>{t.stopPropagation(),t.preventDefault(),this._onSlideEnd(t.pageX)},this._onTouchStart=t=>{if(this.enabled&&!this.readOnly)for(let e=0;e<t.changedTouches.length;e++){const s=t.changedTouches[e],i=s.target;if(i.ui&&i.ui===this){this._touchId=s.identifier,this._onSlideStart(s.pageX);break}}},this._onTouchMove=t=>{for(let e=0;e<t.changedTouches.length;e++){const s=t.changedTouches[e];if(s.identifier===this._touchId){t.stopPropagation(),t.preventDefault(),this._onSlideMove(s.pageX);break}}},this._onTouchEnd=t=>{for(let e=0;e<t.changedTouches.length;e++){const s=t.changedTouches[e];if(s.identifier===this._touchId){t.stopPropagation(),t.preventDefault(),this._onSlideEnd(s.pageX),this._touchId=null;break}}},this._onKeyDown=t=>{if("Escape"===t.key)return void this.blur();if(!this.enabled||this.readOnly)return;if("ArrowLeft"!==t.key&&"ArrowRight"!==t.key)return;t.stopPropagation(),t.preventDefault();let e="ArrowLeft"===t.key?-1:1;t.shiftKey&&(e*=10),this.value+=e*this.step},this.class.add(SE);const a=new cT({allowNull:t.allowNull,hideSlider:!0,min:t.min,max:t.max,keyChange:t.keyChange,placeholder:t.placeholder,precision:null!==(e=t.precision)&&void 0!==e?e:2,renderChanges:t.renderChanges,step:t.step});a.on("change",(t=>{this._onValueChange(t)})),a.on("focus",(()=>{this.emit("focus")})),a.on("blur",(()=>{this.emit("blur")})),a.parent=this,this.dom.appendChild(a.dom),this._numericInput=a,this._sliderMin=null!==(i=null!==(s=t.sliderMin)&&void 0!==s?s:t.min)&&void 0!==i?i:0,this._sliderMax=null!==(r=null!==(n=t.sliderMax)&&void 0!==n?n:t.max)&&void 0!==r?r:1,this._domSlider=document.createElement("div"),this._domSlider.classList.add(CE),this.dom.appendChild(this._domSlider),this._domBar=document.createElement("div"),this._domBar.classList.add(TE),this._domBar.ui=this,this._domSlider.appendChild(this._domBar),this._domHandle=document.createElement("div"),this._domHandle.ui=this,this._domHandle.tabIndex=0,this._domHandle.classList.add(EE),this._domBar.appendChild(this._domHandle),this._domSlider.addEventListener("mousedown",this._onMouseDown),this._domSlider.addEventListener("touchstart",this._onTouchStart,{passive:!0}),this._domHandle.addEventListener("keydown",this._onKeyDown),void 0!==t.value&&(this.value=t.value),void 0!==t.values&&(this.values=t.values),0===this.value&&this._updateHandle(0)}destroy(){this._destroyed||(this._domSlider.removeEventListener("mousedown",this._onMouseDown),this._domSlider.removeEventListener("touchstart",this._onTouchStart),this._domHandle.removeEventListener("keydown",this._onKeyDown),this.dom.removeEventListener("mouseup",this._onMouseUp),this.dom.removeEventListener("mousemove",this._onMouseMove),this.dom.removeEventListener("touchmove",this._onTouchMove),this.dom.removeEventListener("touchend",this._onTouchEnd),super.destroy())}_updateHandle(t){const e=100*Math.max(0,Math.min(1,((t||0)-this._sliderMin)/(this._sliderMax-this._sliderMin))),s=this._domHandle.getBoundingClientRect().width;this._domHandle.style.left=`calc(${e}% + ${s/2}px)`}_onValueChange(t){this._updateHandle(t),this._suppressChange||this.emit("change",t),this._binding&&this._binding.setValue(t)}_calculateCursorHandleOffset(t){const e=ME?2:0,s=this._domHandle.getBoundingClientRect(),i=s.left-e,n=s.right;return this._cursorHandleOffset=t>=i&&t<=n?t-(i+(n-i)/2):0,this._cursorHandleOffset}_onSlideStart(t){this._domHandle.focus(),null===this._touchId?(window.addEventListener("mousemove",this._onMouseMove),window.addEventListener("mouseup",this._onMouseUp)):(window.addEventListener("touchmove",this._onTouchMove),window.addEventListener("touchend",this._onTouchEnd)),this.class.add(PE),this._calculateCursorHandleOffset(t)||this._onSlideMove(t),this.binding&&(this._historyCombine=this.binding.historyCombine,this._historyPostfix=this.binding.historyPostfix,this.binding.historyCombine=!0,this.binding.historyPostfix=`(${Date.now()})`)}_onSlideMove(t){const e=this._domBar.getBoundingClientRect();t-=this._cursorHandleOffset;let s=Math.max(0,Math.min(1,(t-e.left)/e.width))*(this._sliderMax-this._sliderMin)+this._sliderMin;s=parseFloat(s.toFixed(this.precision)),this.value=s}_onSlideEnd(t){this._calculateCursorHandleOffset(t)||this._onSlideMove(t),this.class.remove(PE),null===this._touchId?(window.removeEventListener("mousemove",this._onMouseMove),window.removeEventListener("mouseup",this._onMouseUp)):(window.removeEventListener("touchmove",this._onTouchMove),window.removeEventListener("touchend",this._onTouchEnd)),this.binding&&(this.binding.historyCombine=this._historyCombine,this.binding.historyPostfix=this._historyPostfix,this._historyCombine=!1,this._historyPostfix=null)}focus(){this._numericInput.focus()}blur(){this._domHandle.blur(),this._numericInput.blur()}set sliderMin(t){this._sliderMin!==t&&(this._sliderMin=t,this._updateHandle(this.value))}get sliderMin(){return this._sliderMin}set sliderMax(t){this._sliderMax!==t&&(this._sliderMax=t,this._updateHandle(this.value))}get sliderMax(){return this._sliderMax}set value(t){this._numericInput.value=t,this._numericInput.class.contains(PC)?this.class.add(PC):this.class.remove(PC)}get value(){return this._numericInput.value}set values(t){this._numericInput.values=t,this._numericInput.class.contains(PC)?this.class.add(PC):this.class.remove(PC)}set renderChanges(t){this._numericInput.renderChanges=t}get renderChanges(){return this._numericInput.renderChanges}set min(t){this._numericInput.min=t}get min(){return this._numericInput.min}set max(t){this._numericInput.max=t}get max(){return this._numericInput.max}set step(t){this._numericInput.step=t}get step(){return this._numericInput.step}set precision(t){this._numericInput.precision=t}get precision(){return this._numericInput.precision}set keyChange(t){this._numericInput.keyChange=t}get keyChange(){return this._numericInput.keyChange}set placeholder(t){this._numericInput.placeholder=t}get placeholder(){return this._numericInput.placeholder}}FC.register("slider",AE,{renderChanges:!0});var kE=AE;let DE=class extends uT{constructor(t){super(t),this.elementClass=kE}render(){return super.render()}};DE.ctor=kE;var RE=DE;class LE extends FC{constructor(t={}){var e,s;if((null!==(e=t.type)&&void 0!==e?e:"small-thick")===LE.TYPE_SMALL_THICK){const e=function(t,e){const s=e||document.createElementNS("http://www.w3.org/2000/svg","svg");return s.classList.add("spin"),s.setAttribute("width",t),s.setAttribute("height",t),s.setAttribute("viewBox","0 0 14 14"),s.setAttribute("fill","none"),s.innerHTML='<path d="M7 14C3.13871 14 0 10.8613 0 7C0 3.13871 3.13871 0 7 0C10.8613 0 14 3.13871 14 7C14 10.8613 10.8613 14 7 14ZM7 2.25806C4.38064 2.25806 2.25806 4.38064 2.25806 7C2.25806 9.61935 4.38064 11.7419 7 11.7419C9.61935 11.7419 11.7419 9.61935 11.7419 7C11.7419 4.38064 9.61935 2.25806 7 2.25806Z" fill="#773417"/><path class="pcui-spinner-highlight" d="M7 14V11.7419C9.61935 11.7419 11.7419 9.61935 11.7419 7H14C14 10.8613 10.8613 14 7 14Z" fill="#FF6600"/>',s}(null!==(s=t.size)&&void 0!==s?s:12,t.dom);t=Object.assign(Object.assign({},t),{dom:e})}super(t),this.class.add("pcui-spinner")}}LE.TYPE_SMALL_THICK="small-thick";var IE=LE;let OE=class extends uT{constructor(t){super(t),this.elementClass=IE}render(){return op.createElement("svg",{ref:this.attachElement})}};OE.ctor=IE;var FE=OE;class BE extends uT{constructor(t={}){super(t),this.elementClass=kT,t.onValidate&&(this.onValidate=t.onValidate),this.onAttach=this.onAttachFn.bind(this)}onAttachFn(){this.onValidate&&(this.element.onValidate=this.onValidate)}render(){return super.render()}}BE.ctor=kT;var zE=BE;const NE="pcui-treeview-item",UE=NE+"-icon",VE=NE+"-text",HE=NE+"-selected",GE=NE+"-open",WE=NE+"-contents",jE=NE+"-empty",qE=NE+"-rename";class XE extends GC{constructor(t={}){var e,s,i,n;super(t),this._numChildren=0,this._onContentKeyDown=t=>{"INPUT"!==t.target.tagName&&this.allowSelect&&this._treeView&&this._treeView._onChildKeyDown(t,this)},this._onContentMouseDown=t=>{this._treeView&&this._treeView.allowDrag&&this._allowDrag&&(this._treeView._updateModifierKeys(t),t.stopPropagation())},this._onContentMouseUp=t=>{t.stopPropagation(),t.preventDefault(),window.removeEventListener("mouseup",this._onContentMouseUp),this._treeView&&this._treeView._onChildDragEnd(t,this)},this._onContentMouseOver=t=>{t.stopPropagation(),this._treeView&&this._treeView._onChildDragOver(t,this),this.emit("hover",t)},this._onContentDragStart=t=>{t.stopPropagation(),t.preventDefault(),this._treeView&&this._treeView.allowDrag&&(this.class.contains(qE)||(this._treeView._onChildDragStart(t,this),window.addEventListener("mouseup",this._onContentMouseUp)))},this._onContentClick=t=>{if(!this.allowSelect||0!==t.button)return;if("INPUT"===t.target.tagName)return;t.stopPropagation();const e=this._containerContents.dom.getBoundingClientRect();this._numChildren>0&&t.clientX-e.left<0?(this.open=!this.open,t.altKey&&this._dfs((t=>{t.open=this.open})),this.focus()):this._treeView&&this._treeView._onChildClick(t,this)},this._onContentDblClick=t=>{if(!this._treeView||!this._treeView.allowRenaming||0!==t.button)return;if("INPUT"===t.target.tagName)return;t.stopPropagation();const e=this._containerContents.dom.getBoundingClientRect();this.numChildren&&t.clientX-e.left<0||(this.allowSelect&&(this._treeView.deselect(),this._treeView._onChildClick(t,this)),this.rename())},this._onContentContextMenu=t=>{this._treeView&&this._treeView._onContextMenu&&this._treeView._onContextMenu(t,this)},this._onContentFocus=t=>{this.emit("focus")},this._onContentBlur=t=>{this.emit("blur")},this.class.add(NE,jE),this._containerContents=new GC({class:WE,flex:!0,flexDirection:"row",tabIndex:0}),this.append(this._containerContents),this._containerContents.dom.draggable=!0,this._labelIcon=new jC({class:UE}),this._containerContents.append(this._labelIcon),this.icon=null!==(e=t.icon)&&void 0!==e?e:"E360",this._labelText=new jC({class:VE}),this._containerContents.append(this._labelText),this.allowSelect=null===(s=t.allowSelect)||void 0===s||s,this.allowDrop=null===(i=t.allowDrop)||void 0===i||i,this.allowDrag=null===(n=t.allowDrag)||void 0===n||n,t.text&&(this.text=t.text),t.selected&&(this.selected=t.selected);const r=this._containerContents.dom;r.addEventListener("focus",this._onContentFocus),r.addEventListener("blur",this._onContentBlur),r.addEventListener("keydown",this._onContentKeyDown),r.addEventListener("dragstart",this._onContentDragStart),r.addEventListener("mousedown",this._onContentMouseDown),r.addEventListener("mouseover",this._onContentMouseOver),r.addEventListener("click",this._onContentClick),r.addEventListener("dblclick",this._onContentDblClick),r.addEventListener("contextmenu",this._onContentContextMenu)}destroy(){if(this._destroyed)return;const t=this._containerContents.dom;t.removeEventListener("focus",this._onContentFocus),t.removeEventListener("blur",this._onContentBlur),t.removeEventListener("keydown",this._onContentKeyDown),t.removeEventListener("dragstart",this._onContentDragStart),t.removeEventListener("mousedown",this._onContentMouseDown),t.removeEventListener("mouseover",this._onContentMouseOver),t.removeEventListener("click",this._onContentClick),t.removeEventListener("dblclick",this._onContentDblClick),t.removeEventListener("contextmenu",this._onContentContextMenu),window.removeEventListener("mouseup",this._onContentMouseUp),super.destroy()}_onAppendChild(t){super._onAppendChild(t),t instanceof XE&&(this._numChildren++,this._parent!==this._treeView&&this.class.remove(jE),this._treeView&&this._treeView._onAppendTreeViewItem(t))}_onRemoveChild(t){t instanceof XE&&(this._numChildren--,0===this._numChildren&&this.class.add(jE),this._treeView&&this._treeView._onRemoveTreeViewItem(t)),super._onRemoveChild(t)}_dfs(t){t(this);let e=this.firstChild;for(;e;)e._dfs(t),e=e.nextSibling}rename(){this.class.add(qE);const t=new kT({renderChanges:!1,value:this.text,class:DC});t.on("blur",(()=>{t.destroy()})),t.on("destroy",(()=>{this.class.remove(qE),this.focus()})),t.on("change",(e=>{(e=e.trim())&&(this.text=e,t.destroy())})),t.on("disable",(()=>{t.input.removeAttribute("readonly")})),this._containerContents.append(t),t.focus(!0)}focus(){this._containerContents.dom.focus()}blur(){this._containerContents.dom.blur()}set selected(t){t!==this.selected?t?(this._containerContents.class.add(HE),this.emit("select",this),this._treeView&&this._treeView._onChildSelected(this),this.focus()):(this._containerContents.class.remove(HE),this.blur(),this.emit("deselect",this),this._treeView&&this._treeView._onChildDeselected(this)):t&&this.focus()}get selected(){return this._containerContents.class.contains(HE)}set text(t){this._labelText.value!==t&&(this._labelText.value=t,this._treeView&&this._treeView._onChildRename(this,t))}get text(){return this._labelText.value}get textLabel(){return this._labelText}get iconLabel(){return this._labelIcon}set open(t){if(this.open!==t)if(t){if(!this.numChildren)return;this.class.add(GE),this.emit("open",this)}else this.class.remove(GE),this.emit("close",this)}get open(){return this.class.contains(GE)||this.parent===this._treeView}set parentsOpen(t){let e=this.parent;for(;e&&e instanceof XE;)e.open=t,e=e.parent}get parentsOpen(){let t=this.parent;for(;t&&t instanceof XE;){if(!t.open)return!1;t=t.parent}return!0}set allowDrop(t){this._allowDrop=t}get allowDrop(){return this._allowDrop}set allowDrag(t){this._allowDrag=t}get allowDrag(){return this._allowDrag}set allowSelect(t){this._allowSelect=t}get allowSelect(){return this._allowSelect}set treeView(t){this._treeView=t}get treeView(){return this._treeView}get numChildren(){return this._numChildren}get firstChild(){if(this._numChildren)for(const t of this.dom.childNodes)if(t.ui instanceof XE)return t.ui;return null}get lastChild(){if(this._numChildren)for(let t=this.dom.childNodes.length-1;t>=0;t--)if(this.dom.childNodes[t].ui instanceof XE)return this.dom.childNodes[t].ui;return null}get nextSibling(){let t=this.dom.nextSibling;for(;t&&!(t.ui instanceof XE);)t=t.nextSibling;return t&&t.ui}get previousSibling(){let t=this.dom.previousSibling;for(;t&&!(t.ui instanceof XE);)t=t.previousSibling;return t&&t.ui}set icon(t){this._icon!==t&&t.match(/^E[0-9]{0,4}$/)&&(this._icon=t,t?this._labelIcon.dom.setAttribute("data-icon",String.fromCodePoint(parseInt(t,16))):this._labelIcon.dom.removeAttribute("data-icon"))}get icon(){return this._icon}}XE.EVENT_SELECT="select",XE.EVENT_DESELECT="deselect",XE.EVENT_OPEN="open",XE.EVENT_CLOSE="close";var $E=XE;const KE="pcui-treeview",YE=KE+"-item-dragged",QE=KE+"-drag-handle",JE=KE+"-filtering",ZE=JE+"-result",tP="inside",eP="before",sP="after";class iP extends GC{constructor(t={}){var e,s,i;super(t),this._selectedItems=[],this._dragItems=[],this._dragging=!1,this._dragOverItem=null,this._dragArea=tP,this._dragScroll=0,this._dragScrollInterval=null,this._pressedCtrl=!1,this._pressedShift=!1,this._filter=null,this._filterResults=[],this._updateModifierKeys=t=>{this._pressedCtrl=t.ctrlKey||t.metaKey,this._pressedShift=t.shiftKey},this._onMouseLeave=t=>{this._allowDrag&&this._dragging&&(this._dragOverItem=null,this._updateDragHandle())},this._onMouseMove=t=>{if(!this._dragging)return;const e=this.dom.getBoundingClientRect();this._dragScroll=0;let s=e.top,i=e.bottom;if(this._dragScrollElement!==this){const t=this._dragScrollElement.dom.getBoundingClientRect();s=Math.max(s+this._dragScrollElement.dom.scrollTop,t.top),i=Math.min(i+this._dragScrollElement.dom.scrollTop,t.bottom)}s=Math.max(0,s),i=Math.min(i,document.body.clientHeight),t.pageY<s+32&&this._dragScrollElement.dom.scrollTop>0?this._dragScroll=-1:t.pageY>i-32&&this._dragScrollElement.dom.scrollHeight>this._dragScrollElement.height+this._dragScrollElement.dom.scrollTop&&(this._dragScroll=1)},this._onDragMove=t=>{if(t.preventDefault(),t.stopPropagation(),!this._allowDrag||!this._dragOverItem)return;const e=this._dragHandle.dom.getBoundingClientRect(),s=Math.floor((t.clientY-e.top)/e.height*5),i=this._dragArea,n=this._dragOverItem;if(this._dragOverItem.parent===this){let t=!1;for(let e=0;e<this._dragItems.length;e++)if(this._dragItems[e].parent===this._dragOverItem){t=!0,this._dragOverItem=null;break}t||(this._dragArea=tP)}else{let t=!1;for(let e=0;e<this._dragItems.length;e++)if(this._dragItems[e].dom.contains(this._dragOverItem.dom)){t=!0;break}if(t)this._dragOverItem=null;else if(this._allowReordering&&s<=1&&-1===this._dragItems.indexOf(this._dragOverItem.previousSibling))this._dragArea=eP;else if(this._allowReordering&&s>=4&&-1===this._dragItems.indexOf(this._dragOverItem.nextSibling)&&(0===this._dragOverItem.numChildren||!this._dragOverItem.open))this._dragArea=sP;else{let t=!1;if(this._allowReordering&&this._dragOverItem.open)for(let e=0;e<this._dragItems.length;e++)if(this._dragItems[e].parent===this._dragOverItem){t=!0,this._dragArea=eP;break}t||(this._dragArea=tP)}}i===this._dragArea&&n===this._dragOverItem||this._updateDragHandle()},this.class.add(KE),this._allowDrag=null===(e=t.allowDrag)||void 0===e||e,this._allowReordering=null===(s=t.allowReordering)||void 0===s||s,this._allowRenaming=null!==(i=t.allowRenaming)&&void 0!==i&&i,this._dragHandle=new FC({class:QE}),this._dragScrollElement=t.dragScrollElement||this,this.append(this._dragHandle),this._onContextMenu=t.onContextMenu,this._onReparentFn=t.onReparent,this._wasDraggingAllowedBeforeFiltering=this._allowDrag,window.addEventListener("keydown",this._updateModifierKeys),window.addEventListener("keyup",this._updateModifierKeys),window.addEventListener("mousedown",this._updateModifierKeys),this.dom.addEventListener("mouseleave",this._onMouseLeave),this._dragHandle.dom.addEventListener("mousemove",this._onDragMove),this._dragHandle.on("destroy",(t=>{t.removeEventListener("mousemove",this._onDragMove)}))}destroy(){this._destroyed||(window.removeEventListener("keydown",this._updateModifierKeys),window.removeEventListener("keyup",this._updateModifierKeys),window.removeEventListener("mousedown",this._updateModifierKeys),window.removeEventListener("mousemove",this._onMouseMove),this.dom.removeEventListener("mouseleave",this._onMouseLeave),this._dragScrollInterval&&(window.clearInterval(this._dragScrollInterval),this._dragScrollInterval=null),super.destroy())}_findNextVisibleTreeItem(t){if(t.numChildren>0&&t.open)return t.firstChild;const e=t.nextSibling;if(e)return e;let s=t.parent;if(!(s instanceof $E))return null;let i=s.nextSibling;for(;!i&&(s=s.parent,s instanceof $E);)i=s.nextSibling;return i}_findLastVisibleChildTreeItem(t){if(!t.numChildren||!t.open)return null;let e=t.lastChild;for(;e&&e.numChildren&&e.open;)e=e.lastChild;return e}_findPreviousVisibleTreeItem(t){const e=t.previousSibling;if(e)return e.numChildren>0&&e.open?this._findLastVisibleChildTreeItem(e):e;const s=t.parent;return s instanceof $E?s:null}_getChildrenRange(t,e){const s=[];if(this._filterResults.length){const i=this.dom.querySelectorAll(`.${KE}-item.${ZE}`);let n=-1,r=-1;for(let a=0;a<i.length;a++){const o=i[a].ui;if(o===t?n=a:o===e&&(r=a),-1!==n&&-1!==r){const t=n<r?r:n;for(let e=n<r?n:r;e<=t;e++)s.push(i[e].ui);break}}}else{let i=t;const n=t.dom.getBoundingClientRect(),r=e.dom.getBoundingClientRect();if(n.top<r.top)for(;i&&i!==e;)i=this._findNextVisibleTreeItem(i),i&&i!==e&&s.push(i);else for(;i&&i!==e;)i=this._findPreviousVisibleTreeItem(i),i&&i!==e&&s.push(i);s.push(e)}return s}_onAppendChild(t){super._onAppendChild(t),t instanceof $E&&this._onAppendTreeViewItem(t)}_onRemoveChild(t){t instanceof $E&&this._onRemoveTreeViewItem(t),super._onRemoveChild(t)}_onAppendTreeViewItem(t){t.treeView=this,this._filter&&this._searchItems([[t.text,t]],this._filter),t.forEachChild((t=>{t instanceof $E&&this._onAppendTreeViewItem(t)}))}_onRemoveTreeViewItem(t){t.selected=!1,t.forEachChild((t=>{t instanceof $E&&this._onRemoveTreeViewItem(t)}))}_onChildKeyDown(t,e){if(-1!==["Tab","ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].indexOf(t.key))if(t.preventDefault(),t.stopPropagation(),"ArrowDown"===t.key){if(this._selectedItems.length){const t=this._findNextVisibleTreeItem(e);t&&(this._pressedShift||this._pressedCtrl?t.selected=!0:this._selectSingleItem(t))}}else if("ArrowUp"===t.key){if(this._selectedItems.length){const t=this._findPreviousVisibleTreeItem(e);t&&(this._pressedShift||this._pressedCtrl?t.selected=!0:this._selectSingleItem(t))}}else"ArrowLeft"===t.key?e.parent!==this&&(e.open=!1):"ArrowRight"===t.key&&(e.open=!0)}_onChildClick(t,e){if(0===t.button&&e.allowSelect)if(this._pressedCtrl)e.selected=!e.selected;else if(this._pressedShift){if(!this._selectedItems.length||1===this._selectedItems.length&&this._selectedItems[0]===e)return void(e.selected=!0);const t=this._selectedItems[this._selectedItems.length-1];this._openHierarchy(t);this._getChildrenRange(t,e).forEach((t=>{t.allowSelect&&(t.selected=!0)}))}else this._selectSingleItem(e)}_traverseDepthFirst(t){function e(s){if(s&&s instanceof $E&&(t(s),s.numChildren))for(const t of s.dom.childNodes)e(t.ui)}for(const t of this.dom.childNodes)e(t.ui)}_getTreeOrder(){const t=new Map;let e=0;return this._traverseDepthFirst((s=>{t.set(s,e++)})),t}_getChildIndex(t,e){return Array.prototype.indexOf.call(e.dom.childNodes,t.dom)-1}_onChildDragStart(t,e){if(this.allowDrag&&!this._dragging){if(this._dragItems=[],-1!==this._selectedItems.indexOf(e)){const t=[];let e=-1;for(let s=0;s<this._selectedItems.length;s++){let i=this._selectedItems[s].parent,n=0,r=!1;for(;i&&i instanceof $E;){if(-1!==this._selectedItems.indexOf(i)){r=!0;break}n++,i=i.parent}if(!r){if(-1===e)e=n;else if(e!==n)return;t.push(this._selectedItems[s])}}this._dragItems=t}else e.class.add(YE),this._dragItems.push(e);this._dragItems.length&&(this._dragItems.forEach((t=>{t.class.add(YE)})),this.isDragging=!0,this.emit("dragstart",this._dragItems.slice()))}}_onChildDragEnd(t,e){if(!this.allowDrag||!this._dragging)return;this._dragItems.forEach((t=>t.class.remove(YE)));let s=!1;for(let t=0;t<this._dragItems.length;t++)if(this._dragItems[t].parent===this){s=!0;break}if(!s&&this._dragOverItem){if(this._dragItems.length>1){const t=this._getTreeOrder();this._dragItems.sort(((e,s)=>t.get(e)-t.get(s)))}if(this._dragItems.length){const t=[];if(this._onReparentFn){const e=[],s=t=>{let s=e.findIndex((e=>e.parent===t));return-1===s&&(e.push({parent:t,children:[...t.dom.childNodes]}),s=e.length-1),e[s].children};this._dragItems.forEach((e=>{if(e.parent===this._dragOverItem&&this._dragArea===tP)return;t.push({item:e,oldParent:e.parent});const i=s(e.parent),n=i.indexOf(e.dom);i.splice(n,1)})),t.forEach(((e,i)=>{if(this._dragArea===eP){e.newParent=this._dragOverItem.parent;const t=s(this._dragOverItem.parent),i=t.indexOf(this._dragOverItem.dom);t.splice(i,0,e.item.dom),e.newChildIndex=i}else if(this._dragArea===tP){e.newParent=this._dragOverItem;const t=s(this._dragOverItem);t.push(e.item.dom),e.newChildIndex=t.length-1}else if(this._dragArea===sP){e.newParent=this._dragOverItem.parent;const n=s(this._dragOverItem.parent),r=i>0?t[i-1].item:this._dragOverItem,a=n.indexOf(r.dom);n.splice(a+1,0,e.item.dom),e.newChildIndex=a+1}e.newChildIndex--}))}else this._dragItems.forEach((e=>{e.parent===this._dragOverItem&&this._dragArea===tP||(t.push({item:e,oldParent:e.parent}),e.parent.remove(e))})),t.forEach(((e,s)=>{this._dragArea===eP?(e.newParent=this._dragOverItem.parent,e.newParent.appendBefore(e.item,this._dragOverItem),e.newChildIndex=this._getChildIndex(e.item,e.newParent)):this._dragArea===tP?(e.newParent=this._dragOverItem,e.newParent.append(e.item),e.newParent.open=!0,e.newChildIndex=this._getChildIndex(e.item,e.newParent)):this._dragArea===sP&&(e.newParent=this._dragOverItem.parent,e.newParent.appendAfter(e.item,s>0?t[s-1].item:this._dragOverItem),e.newChildIndex=this._getChildIndex(e.item,e.newParent))}));t.length&&(this._onReparentFn&&this._onReparentFn(t),this.emit("reparent",t))}}this._dragItems=[],this.isDragging=!1,this.emit("dragend")}_onChildDragOver(t,e){this._allowDrag&&this._dragging&&(e.allowDrop&&-1===this._dragItems.indexOf(e)?this._dragOverItem=e:this._dragOverItem=null,this._updateDragHandle(),this._onDragMove(t))}_scrollWhileDragging(){this._dragging&&0!==this._dragScroll&&(this._dragScrollElement.dom.scrollTop+=8*this._dragScroll,this._dragOverItem=null,this._updateDragHandle())}_updateDragHandle(t,e){if(e||this._allowDrag&&this._dragging)if(t||(t=this._dragOverItem),t&&!t.hidden&&t.parentsOpen){const e=t._containerContents.dom.getBoundingClientRect();this._dragHandle.hidden=!1,this._dragHandle.class.remove(sP,eP,tP),this._dragHandle.class.add(this._dragArea);const s=e.top;let i=e.left,n=e.width;if(this.dom.parentElement){const t=this.dom.parentElement.getBoundingClientRect();i=Math.max(i,t.left),n=Math.min(n,this.dom.parentElement.clientWidth-i+t.left)}this._dragHandle.style.top=s+"px",this._dragHandle.style.left=i+"px",this._dragHandle.style.width=n-7+"px"}else this._dragHandle.hidden=!0}_openHierarchy(t){t.parentsOpen=!0}_selectSingleItem(t){let e=this._selectedItems.length,s=!1;for(;e--;)this._selectedItems[e]&&this._selectedItems[e]!==t&&(this._selectedItems[e].selected=!1,s=!0);t.selected=!!s||!t.selected}_onChildSelected(t){this._selectedItems.push(t),this._openHierarchy(t),this.emit("select",t)}_onChildDeselected(t){const e=this._selectedItems.indexOf(t);-1!==e&&(this._selectedItems.splice(e,1),this.emit("deselect",t))}_onChildRename(t,e){if(this._filter){t.class.remove(ZE);const e=this._filterResults.indexOf(t);-1!==e&&this._filterResults.splice(e,1),this._searchItems([[t.text,t]],this._filter)}this.emit("rename",t,e)}_searchItems(t,e){const s=GT(t,e);s.length&&s.forEach((t=>{this._filterResults.push(t),t.class.add(ZE)}))}_applyFilter(t){this._clearFilter(),this._wasDraggingAllowedBeforeFiltering=this._allowDrag,this._allowDrag=!1,this.class.add(JE);const e=[];this._traverseDepthFirst((t=>{e.push([t.text,t])})),this._searchItems(e,t)}_clearFilter(){this._filterResults.forEach((t=>{t.destroyed||t.class.remove(ZE)})),this._filterResults.length=0,this.class.remove(JE),this._allowDrag=this._wasDraggingAllowedBeforeFiltering}showDragHandle(t){this._updateDragHandle(t,!0)}deselect(){let t=this._selectedItems.length;for(;t--;)this._selectedItems[t]&&(this._selectedItems[t].selected=!1)}clearTreeItems(){let t=this.dom.childNodes.length;for(;t--;){const e=this.dom.childNodes[t];if(!e)continue;const s=e.ui;s instanceof $E&&s.destroy()}this._selectedItems=[],this._dragItems=[],this._allowDrag=this._wasDraggingAllowedBeforeFiltering}set allowDrag(t){this._allowDrag=t,this._filter&&(this._wasDraggingAllowedBeforeFiltering=t)}get allowDrag(){return this._allowDrag}set allowReordering(t){this._allowReordering=t}get allowReordering(){return this._allowReordering}set allowRenaming(t){this._allowRenaming=t}get allowRenaming(){return this._allowRenaming}set isDragging(t){this._dragging!==t&&(t?(this._dragging=!0,this._updateDragHandle(),(this.scrollable||this._dragScrollElement!==this)&&(window.removeEventListener("mousemove",this._onMouseMove),window.addEventListener("mousemove",this._onMouseMove),this._dragScrollInterval||(this._dragScrollInterval=window.setInterval((()=>{this._scrollWhileDragging()}),1e3/60)))):(this._dragOverItem=null,this._updateDragHandle(),this._dragging=!1,window.removeEventListener("mousemove",this._onMouseMove),this._dragScrollInterval&&(window.clearInterval(this._dragScrollInterval),this._dragScrollInterval=null)))}get isDragging(){return this._dragging}get selected(){return this._selectedItems.slice()}set filter(t){this._filter!==t&&(this._filter=t,t?this._applyFilter(t):this._clearFilter())}get filter(){return this._filter}get pressedCtrl(){return this._pressedCtrl}get pressedShift(){return this._pressedShift}}iP.EVENT_DRAGSTART="dragstart",iP.EVENT_DRAGEND="dragend",iP.EVENT_REPARENT="reparent",iP.EVENT_SELECT="select",iP.EVENT_DESELECT="deselect",iP.EVENT_RENAME="rename";var nP=iP;let rP=class extends uT{constructor(t){super(t),this.element=new nP(Object.assign({},t)),this.loadChildren(this.props.children,this.element)}loadChildren(t,e){t&&(Array.isArray(t)||(t=[t]),t.forEach((t=>{const s=new $E({text:t.props.text,icon:t.props.icon,open:!1});t.props.onSelect&&s.on("select",t.props.onSelect),t.props.onDeselect&&s.on("deselect",t.props.onDeselect),e.append(s),this.loadChildren(t.props.children,s)})))}componentDidUpdate(){this.parentElement.removeChild(this.element.dom),this.element=new nP(Object.assign({},this.props)),this.loadChildren(this.props.children,this.element),this.parentElement.appendChild(this.element.dom)}parentElementRendered(t){t&&(this.parentElement=t,this.parentElement.appendChild(this.element.dom))}render(){return op.createElement("div",{ref:this.parentElementRendered.bind(this)})}};rP.ctor=nP;var aP=rP;let oP=class extends uT{constructor(t){super(t),this.elementClass=$E,this.onSelect=()=>{t.onSelect&&t.onSelect((()=>{this.element.selected=!1}))},t.onDeselect&&(this.onDeselect=t.onDeselect),this.onAttach=this.onAttachFn.bind(this)}onAttachFn(){this.props.onSelect&&this.element.on("select",this.onSelect),this.props.onDeselect&&this.element.on("deselect",this.onDeselect)}render(){return super.render()}};oP.ctor=$E;var lP=oP;class hP extends FC{constructor(t={}){var e,s,i;const n=Object.assign({},t);delete n.binding,super(n),this._inputs=[],this._applyingChange=!1,this.class.add("pcui-vector-input");const r=Math.max(2,Math.min(4,null!==(e=t.dimensions)&&void 0!==e?e:3));for(let e=0;e<r;e++){const n=new cT({min:t.min,max:t.max,precision:null!==(s=t.precision)&&void 0!==s?s:7,step:null!==(i=t.step)&&void 0!==i?i:1,stepPrecision:t.stepPrecision,renderChanges:t.renderChanges,placeholder:t.placeholder?Array.isArray(t.placeholder)?t.placeholder[e]:t.placeholder:null});n.on("change",(()=>{this._onInputChange()})),n.on("focus",(()=>{this.emit("focus")})),n.on("blur",(()=>{this.emit("blur")})),this.dom.appendChild(n.dom),n.parent=this,this._inputs.push(n)}t.binding&&(this.binding=t.binding),void 0!==t.value&&(this.value=t.value)}_onInputChange(){if(this._applyingChange)return;this._inputs.some((t=>t.class.contains(PC)))?this.class.add(PC):this.class.remove(PC),this.emit("change",this.value)}_updateValue(t){return this.class.remove(PC),JSON.stringify(this.value)!==JSON.stringify(t)&&(this._applyingChange=!0,this._inputs.forEach(((e,s)=>{const i=e.binding;let n=!1;i&&(n=i.applyingChange,i.applyingChange=!0),e.value=t&&void 0!==t[s]?t[s]:null,i&&(i.applyingChange=n)})),this.emit("change",this.value),this._applyingChange=!1,!0)}link(t,e){super.link(t,e),t=Array.isArray(t)?t:[t];if(1===(e=Array.isArray(e)?e:[e]).length||t.length!==e.length)for(let s=0;s<this._inputs.length;s++)this._inputs[s].link(t,e[0]+`.${s}`);else for(let s=0;s<this._inputs.length;s++)this._inputs[s].link(t,e.map((t=>`${t}.${s}`)))}unlink(){super.unlink();for(const t of this._inputs)t.unlink()}focus(){this._inputs[0].focus()}blur(){for(const t of this._inputs)t.blur()}set value(t){if("string"==typeof t)try{if(t=JSON.parse(t),Array.isArray(t)&&t.some((t=>!Number.isFinite(t))))throw new Error("VectorInput value set to string which doesn't contain an array of numbers")}catch(e){console.error(e),t=[]}Array.isArray(t)||(t=[]);this._updateValue(t)&&this._binding&&this._binding.setValue(t)}get value(){return this._inputs.map((t=>t.value))}set values(t){t=this._inputs.map(((e,s)=>t.map((t=>t?t[s]:void 0)))),this._inputs.forEach(((e,s)=>{e.values=t[s]}))}set binding(t){super.binding=t;for(const e of this._inputs)e.binding=t?t.clone():null}get binding(){return super.binding}set placeholder(t){for(let e=0;e<this._inputs.length;e++)this._inputs[e].placeholder=t[e]||t||null}get placeholder(){return this._inputs.map((t=>t.placeholder))}get inputs(){return this._inputs.slice()}set renderChanges(t){for(const e of this._inputs)e.renderChanges=t}get renderChanges(){return this._inputs[0].renderChanges}set min(t){for(const e of this._inputs)e.min=t}get min(){return this._inputs[0].min}set max(t){for(const e of this._inputs)e.max=t}get max(){return this._inputs[0].max}set precision(t){for(const e of this._inputs)e.precision=t}get precision(){return this._inputs[0].precision}set step(t){for(const e of this._inputs)e.step=t}get step(){return this._inputs[0].step}}FC.register("vec2",hP,{dimensions:2,renderChanges:!0}),FC.register("vec3",hP,{dimensions:3,renderChanges:!0}),FC.register("vec4",hP,{dimensions:4,renderChanges:!0});var cP=hP;class dP extends uT{constructor(t){super(t),this.elementClass=cP}render(){return super.render()}}dP.ctor=cP;var uP=dP;const pP=t=>lp.createElement(zT,{class:"panel-option"},lp.createElement(gE,{class:"panel-label",text:t.label}),lp.createElement(gE,{class:"panel-value",text:String(t.value)})),fP=t=>{var e;return lp.createElement(zT,{class:"panel-option",enabled:null===(e=t.enabled)||void 0===e||e},lp.createElement(gE,{class:"panel-label",text:t.label}),lp.createElement(uP,{class:"panel-value",dimensions:t.dimensions,value:t.value,precision:7}))},mP=t=>{var e;return lp.createElement(zT,{class:"panel-option",enabled:null===(e=t.enabled)||void 0===e||e},lp.createElement(gE,{class:"panel-label",text:t.label}),lp.createElement(bT,{class:"panel-value-boolean",type:"toggle",value:t.value,onChange:e=>t.setProperty(e)}))},gP=t=>lp.createElement(zT,{class:"panel-option"},lp.createElement(gE,{class:"panel-label",text:t.label}),lp.createElement(zT,{class:"panel-value"},lp.createElement(bT,{type:"toggle",value:t.booleanValue,onChange:e=>t.setBooleanProperty(e)}),lp.createElement(FT,{class:"panel-value-toggle-color",value:t.colorValue,onChange:e=>t.setColorProperty(e)}))),_P=t=>{var e,s;return lp.createElement(zT,{class:"panel-option",enabled:null===(e=t.enabled)||void 0===e||e},lp.createElement(gE,{class:"panel-label",text:t.label}),lp.createElement(RE,{class:"panel-value",min:t.min,max:t.max,sliderMin:t.min,sliderMax:t.max,precision:t.precision,step:null!==(s=t.step)&&void 0!==s?s:.01,onChange:e=>{t.setProperty(e)},value:t.value}))},vP=t=>{var e;return lp.createElement(zT,{class:"panel-option",enabled:null===(e=t.enabled)||void 0===e||e},lp.createElement(gE,{class:"panel-label",text:t.label}),lp.createElement(vE,{class:"panel-value",min:t.min,max:t.max,onChange:e=>{t.setProperty(e)},value:t.value}))},bP=t=>{var e;return lp.createElement(zT,{class:"panel-option",hidden:t.hidden,enabled:null===(e=t.enabled)||void 0===e||e},lp.createElement(gE,{class:"panel-label",text:t.label}),lp.createElement(FT,{class:"panel-value",value:t.value,onChange:e=>t.setProperty(e)}))},yP=t=>{var e;return lp.createElement(zT,{class:"panel-option",enabled:null===(e=t.enabled)||void 0===e||e},lp.createElement(gE,{class:"morph-label",flexGrow:"1",flexShrink:"1",text:t.label?t.label:t.name.substring(0,1).toUpperCase()+t.name.substring(1,t.name.length),flex:!0}),lp.createElement(RE,{class:"morph-value",flexGrow:"0",flexShrink:"0",min:t.min,max:t.max,sliderMin:t.min,sliderMax:t.max,precision:t.precision,step:.01,onChange:e=>{t.setProperty(e)},value:t.value}))},xP=t=>{var e;return lp.createElement(zT,{class:"panel-option",enabled:null===(e=t.enabled)||void 0===e||e},lp.createElement(gE,{class:"panel-label",text:t.label}),lp.createElement(wE,{class:"panel-value",type:t.type,options:t.options,value:t.value,onChange:e=>{t.setProperty(e)}}))},wP=t=>{var e;return lp.createElement(wE,{id:t.id,class:t.class,width:t.width,type:t.type,options:t.options,enabled:null===(e=t.enabled)||void 0===e||e,value:t.value,onChange:e=>{t.setProperty(e)}})},SP=t=>{var e;return lp.createElement(RE,{id:t.id,class:t.class,width:t.width,min:t.min,max:t.max,sliderMin:t.min,sliderMax:t.max,precision:t.precision,step:.01,enabled:null===(e=t.enabled)||void 0===e||e,value:t.value,onChange:e=>{t.setProperty(e)}})};var CP,TP={exports:{}};CP=function(t,e){return function(t){var e={};function s(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}return s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)s.d(i,n,function(e){return t[e]}.bind(null,n));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=4)}([function(t,e,s){t.exports=s(5)()},function(e,s){e.exports=t},function(t,s){t.exports=e},function(t,e){t.exports=function(t,e,s){var i=t.direction,n=t.value;switch(i){case"top":return s.top+n<e.top&&s.bottom>e.bottom&&s.left<e.left&&s.right>e.right;case"left":return s.left+n<e.left&&s.bottom>e.bottom&&s.top<e.top&&s.right>e.right;case"bottom":return s.bottom-n>e.bottom&&s.left<e.left&&s.right>e.right&&s.top<e.top;case"right":return s.right-n>e.right&&s.left<e.left&&s.top<e.top&&s.bottom>e.bottom}}},function(t,e,s){s.r(e),s.d(e,"default",(function(){return _}));var i=s(1),n=s.n(i),r=s(2),a=s.n(r),o=s(0),l=s.n(o),h=s(3),c=s.n(h);function d(t){return d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},d(t)}function u(t,e){for(var s=0;s<e.length;s++){var i=e[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function p(t){return p=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},p(t)}function f(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function m(t,e){return m=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},m(t,e)}function g(t,e,s){return e in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}var _=function(t){function e(t){var s;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),s=function(t,e){return!e||"object"!==d(e)&&"function"!=typeof e?f(t):e}(this,p(e).call(this,t)),g(f(s),"getContainer",(function(){return s.props.containment||window})),g(f(s),"addEventListener",(function(t,e,i,n){var r;s.debounceCheck||(s.debounceCheck={});var a=function(){r=null,s.check()},o={target:t,fn:n>-1?function(){r||(r=setTimeout(a,n||0))}:function(){clearTimeout(r),r=setTimeout(a,i||0)},getLastTimeout:function(){return r}};t.addEventListener(e,o.fn),s.debounceCheck[e]=o})),g(f(s),"startWatching",(function(){s.debounceCheck||s.interval||(s.props.intervalCheck&&(s.interval=setInterval(s.check,s.props.intervalDelay)),s.props.scrollCheck&&s.addEventListener(s.getContainer(),"scroll",s.props.scrollDelay,s.props.scrollThrottle),s.props.resizeCheck&&s.addEventListener(window,"resize",s.props.resizeDelay,s.props.resizeThrottle),!s.props.delayedCall&&s.check())})),g(f(s),"stopWatching",(function(){if(s.debounceCheck)for(var t in s.debounceCheck)if(s.debounceCheck.hasOwnProperty(t)){var e=s.debounceCheck[t];clearTimeout(e.getLastTimeout()),e.target.removeEventListener(t,e.fn),s.debounceCheck[t]=null}s.debounceCheck=null,s.interval&&(s.interval=clearInterval(s.interval))})),g(f(s),"check",(function(){var t,e,i=s.node;if(!i)return s.state;if(t=function(t){return void 0===t.width&&(t.width=t.right-t.left),void 0===t.height&&(t.height=t.bottom-t.top),t}(s.roundRectDown(i.getBoundingClientRect())),s.props.containment){var n=s.props.containment.getBoundingClientRect();e={top:n.top,left:n.left,bottom:n.bottom,right:n.right}}else e={top:0,left:0,bottom:window.innerHeight||document.documentElement.clientHeight,right:window.innerWidth||document.documentElement.clientWidth};var r=s.props.offset||{};"object"===d(r)&&(e.top+=r.top||0,e.left+=r.left||0,e.bottom-=r.bottom||0,e.right-=r.right||0);var a={top:t.top>=e.top,left:t.left>=e.left,bottom:t.bottom<=e.bottom,right:t.right<=e.right},o=t.height>0&&t.width>0,l=o&&a.top&&a.left&&a.bottom&&a.right;if(o&&s.props.partialVisibility){var h=t.top<=e.bottom&&t.bottom>=e.top&&t.left<=e.right&&t.right>=e.left;"string"==typeof s.props.partialVisibility&&(h=a[s.props.partialVisibility]),l=s.props.minTopValue?h&&t.top<=e.bottom-s.props.minTopValue:h}"string"==typeof r.direction&&"number"==typeof r.value&&(console.warn("[notice] offset.direction and offset.value have been deprecated. They still work for now, but will be removed in next major version. Please upgrade to the new syntax: { %s: %d }",r.direction,r.value),l=c()(r,t,e));var u=s.state;return s.state.isVisible!==l&&(u={isVisible:l,visibilityRect:a},s.setState(u),s.props.onChange&&s.props.onChange(l)),u})),s.state={isVisible:null,visibilityRect:{}},s}var s,i,r;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&m(t,e)}(e,t),s=e,(i=[{key:"componentDidMount",value:function(){this.node=a.a.findDOMNode(this),this.props.active&&this.startWatching()}},{key:"componentWillUnmount",value:function(){this.stopWatching()}},{key:"componentDidUpdate",value:function(t){this.node=a.a.findDOMNode(this),this.props.active&&!t.active?(this.setState({isVisible:null,visibilityRect:{}}),this.startWatching()):this.props.active||this.stopWatching()}},{key:"roundRectDown",value:function(t){return{top:Math.floor(t.top),left:Math.floor(t.left),bottom:Math.floor(t.bottom),right:Math.floor(t.right)}}},{key:"render",value:function(){return this.props.children instanceof Function?this.props.children({isVisible:this.state.isVisible,visibilityRect:this.state.visibilityRect}):n.a.Children.only(this.props.children)}}])&&u(s.prototype,i),r&&u(s,r),e}(n.a.Component);g(_,"defaultProps",{active:!0,partialVisibility:!1,minTopValue:0,scrollCheck:!1,scrollDelay:250,scrollThrottle:-1,resizeCheck:!1,resizeDelay:250,resizeThrottle:-1,intervalCheck:!0,intervalDelay:100,delayedCall:!1,offset:{},containment:null,children:n.a.createElement("span",null)}),g(_,"propTypes",{onChange:l.a.func,active:l.a.bool,partialVisibility:l.a.oneOfType([l.a.bool,l.a.oneOf(["top","right","bottom","left"])]),delayedCall:l.a.bool,offset:l.a.oneOfType([l.a.shape({top:l.a.number,left:l.a.number,bottom:l.a.number,right:l.a.number}),l.a.shape({direction:l.a.oneOf(["top","right","bottom","left"]),value:l.a.number})]),scrollCheck:l.a.bool,scrollDelay:l.a.number,scrollThrottle:l.a.number,resizeCheck:l.a.bool,resizeDelay:l.a.number,resizeThrottle:l.a.number,intervalCheck:l.a.bool,intervalDelay:l.a.number,containment:"undefined"!=typeof window?l.a.instanceOf(window.Element):l.a.any,children:l.a.oneOfType([l.a.element,l.a.func]),minTopValue:l.a.number})},function(t,e,s){var i=s(6);function n(){}function r(){}r.resetWarningCache=n,t.exports=function(){function t(t,e,s,n,r,a){if(a!==i){var o=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw o.name="Invariant Violation",o}}function e(){return t}t.isRequired=t;var s={array:t,bool:t,func:t,number:t,object:t,string:t,symbol:t,any:t,arrayOf:e,element:t,elementType:t,instanceOf:e,node:t,objectOf:e,oneOf:e,oneOfType:e,shape:e,exact:e,checkPropTypes:r,resetWarningCache:n};return s.PropTypes=s,s}},function(t,e,s){t.exports="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED"}])};var EP=Tu(TP.exports=CP(op,mC));class PP extends lp.Component{shouldComponentUpdate(t){return JSON.stringify(t.morphs)!==JSON.stringify(this.props.morphs)}render(){const t=this.props.morphs;return t?lp.createElement(yE,{headerText:"MORPH TARGETS",class:"scene-morph-panel",collapsible:!1},Object.keys(t).map((e=>{const s=t[e];return lp.createElement("div",{key:`${e}.${s.name}`},lp.createElement(yE,{headerText:s.name,collapsible:!0,class:"morph-target-panel"},Object.keys(s.targets).map((t=>{const i=s.targets[t];return lp.createElement("div",{key:t},lp.createElement(EP,{offset:{top:-750,bottom:-750}},(({isVisible:s})=>lp.createElement("div",null,s?lp.createElement(yP,{name:`${i.name}`,precision:2,min:0,max:1,value:i.weight,setProperty:s=>this.props.setProperty(`morphs.${e}.targets.${t}.weight`,s)}):lp.createElement("div",{style:{width:30,height:30}})))))}))))}))):null}}var MP=PP;const AP=()=>{const t=document.getElementById("panel-left");t&&t.classList.toggle("collapsed")};let kP;const DP=t=>{const e=["Bytes","KB","MB","GB","TB"];if(0===t)return"n/a";const s=Math.min(Math.floor(Math.log(t)/Math.log(1024)),e.length-1);return 0===s?`${t} ${e[s]}`:`${(t/Math.pow(1024,s)).toFixed(1)} ${e[s]}`};class RP extends lp.Component{shouldComponentUpdate(t){return JSON.stringify(t.sceneData.filenames)!==JSON.stringify(this.props.sceneData.filenames)||t.sceneData.loadTime!==this.props.sceneData.loadTime||t.sceneData.meshCount!==this.props.sceneData.meshCount||t.sceneData.vertexCount!==this.props.sceneData.vertexCount||t.sceneData.primitiveCount!==this.props.sceneData.primitiveCount||t.sceneData.materialCount!==this.props.sceneData.materialCount||t.sceneData.textureVRAM!==this.props.sceneData.textureVRAM||t.sceneData.meshVRAM!==this.props.sceneData.meshVRAM||t.sceneData.bounds!==this.props.sceneData.bounds||t.sceneData.variant.selected!==this.props.sceneData.variant.selected||t.sceneData.variants.list!==this.props.sceneData.variants.list}render(){const t=this.props.sceneData,e=JSON.parse(t.variants.list).map((t=>({v:t,t:t})));return lp.createElement(yE,{headerText:"SCENE",id:"scene-panel",flexShrink:"0",flexGrow:"0",collapsible:!1},lp.createElement(pP,{label:"Filename",value:t.filenames.join(", ")}),lp.createElement(pP,{label:"Meshes",value:t.meshCount}),lp.createElement(pP,{label:"Materials",value:t.materialCount}),lp.createElement(pP,{label:"Textures",value:t.textureCount}),lp.createElement(pP,{label:"Primitives",value:t.primitiveCount}),lp.createElement(pP,{label:"Verts",value:t.vertexCount}),lp.createElement(pP,{label:"Mesh VRAM",value:DP(t.meshVRAM)}),lp.createElement(pP,{label:"Texture VRAM",value:DP(t.textureVRAM)}),lp.createElement(pP,{label:"Load time",value:t.loadTime}),lp.createElement(fP,{label:"Bounds",dimensions:3,value:t.bounds,enabled:!1}),lp.createElement(xP,{label:"Variant",type:"string",options:e,value:t.variant.selected,setProperty:t=>{this.props.setProperty("scene.variant.selected",t)},enabled:e.length>0}))}}class LP extends lp.Component{shouldComponentUpdate(t){return t.sceneData.nodes!==this.props.sceneData.nodes}render(){const t=this.props.sceneData,e=JSON.parse(t.nodes),s=t=>t.map((t=>lp.createElement(lP,{text:`${t.name}`,key:t.path,onSelect:e=>{this.props.setProperty("scene.selectedNode.path",t.path);const s=xu(document.body,(()=>{e.selected=!1,s()}),4)},onDeselect:()=>this.props.setProperty("scene.selectedNode.path","")},s(t.children))));return lp.createElement(yE,{headerText:"HIERARCHY",class:"scene-hierarchy-panel",enabled:e.length>0,collapsible:!1},e.length>0&&lp.createElement(aP,{allowReordering:!1,allowDrag:!1},s(e)))}}class IP extends lp.Component{constructor(t){super(t),this.isMobile=/Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}shouldComponentUpdate(t){return JSON.stringify(t.observerData.scene)!==JSON.stringify(this.props.observerData.scene)}componentDidMount(){document.getElementById("panel-toggle").addEventListener("click",(function(){AP()})),document.getElementById("title").addEventListener("click",(function(){AP()})),setTimeout((()=>AP()))}componentDidUpdate(t){this.isMobile||"[]"!==t.observerData.scene.nodes||"[]"===this.props.observerData.scene.nodes||(kP||(kP=document.getElementById("panel-left")),kP&&kP.classList.contains("collapsed")&&kP.classList.remove("collapsed"))}render(){const t=this.props.observerData.scene,e=this.props.observerData.morphs;return lp.createElement(zT,{id:"scene-container",flex:!0},lp.createElement(RP,{sceneData:t,setProperty:this.props.setProperty}),lp.createElement("div",{id:"scene-scrolly-bits"},lp.createElement(LP,{sceneData:t,setProperty:this.props.setProperty}),lp.createElement(MP,{progress:this.props.observerData.animation.progress,morphs:e,setProperty:this.props.setProperty})))}}var OP=IP;class FP extends lp.Component{shouldComponentUpdate(t){return t.sceneData.nodes!==this.props.sceneData.nodes||t.sceneData.selectedNode.path!==this.props.sceneData.selectedNode.path||t.sceneData.selectedNode.name!==this.props.sceneData.selectedNode.name||t.sceneData.selectedNode.position!==this.props.sceneData.selectedNode.position||t.sceneData.selectedNode.rotation!==this.props.sceneData.selectedNode.rotation||t.sceneData.selectedNode.scale!==this.props.sceneData.selectedNode.scale}render(){const t=this.props.sceneData,e="[]"!==t.nodes,s=t.selectedNode.path;return e&&s?lp.createElement("div",{className:"selected-node-panel-parent"},lp.createElement(zT,{class:"selected-node-panel",flex:!0},lp.createElement(pP,{label:"Name",value:t.selectedNode.name}),lp.createElement(fP,{label:"Position",dimensions:3,value:t.selectedNode.position,enabled:!1}),lp.createElement(fP,{label:"Rotation",dimensions:3,value:t.selectedNode.rotation,enabled:!1}),lp.createElement(fP,{label:"Scale",dimensions:3,value:t.selectedNode.scale,enabled:!1}))):null}}var BP=FP;class zP extends lp.Component{shouldComponentUpdate(t){return t.animationData.list!==this.props.animationData.list||t.animationData.playing!==this.props.animationData.playing||t.animationData.selectedTrack!==this.props.animationData.selectedTrack}render(){const t=this.props,e=JSON.parse(t.animationData.list).map((t=>({v:t,t:t})));return lp.createElement(wP,{id:"anim-track-select",width:160,type:"string",options:e,setProperty:e=>t.setProperty("animation.selectedTrack",e),value:t.animationData.selectedTrack})}}class NP extends lp.Component{shouldComponentUpdate(t){return t.animationData.speed!==this.props.animationData.speed}render(){const t=this.props;return lp.createElement(wP,{id:"anim-speed-select",width:60,type:"string",setProperty:e=>t.setProperty("animation.speed",e),value:t.animationData.speed,options:[{v:"0.25",t:"0.25x"},{v:"0.5",t:"0.5x"},{v:"1",t:"1x"},{v:"1.5",t:"1.5x"},{v:"2",t:"2x"}]})}}class UP extends lp.Component{shouldComponentUpdate(t){return JSON.stringify(t.animationData)!==JSON.stringify(this.props.animationData)}componentDidUpdate(){this.animationState=this.props.animationData}render(){const t=this.props;return JSON.parse(t.animationData.list).length>0?lp.createElement("div",{className:"animation-controls-panel-parent"},lp.createElement(xT,{class:"anim-control-button",width:30,height:30,icon:t.animationData.playing?"E376":"E286",text:"",onClick:()=>{t.setProperty("animation.playing",!this.animationState.playing)}}),lp.createElement(zP,{animationData:this.props.animationData,setProperty:this.props.setProperty}),lp.createElement(SP,{id:"anim-scrub-slider",width:240,precision:2,min:0,max:1,setProperty:e=>{const s=this.animationState;s.playing=!1,s.progress=e,t.setProperty("animation",s)},value:t.animationData.progress}),lp.createElement(NP,{animationData:this.props.animationData,setProperty:this.props.setProperty})):lp.createElement("div",null)}}var VP=UP,HP={exports:{}};HP.exports=function(){var t=function(){},e=Object.prototype.hasOwnProperty,s=Array.prototype.slice;function i(e,s){var i;return"function"==typeof Object.create?i=Object.create(e):(t.prototype=e,i=new t,t.prototype=null),s&&r(!0,i,s),i}function n(t,e,s,n){var a=this;return"string"!=typeof t&&(n=s,s=e,e=t,t=null),"function"!=typeof e&&(n=s,s=e,e=function(){return a.apply(this,arguments)}),r(!1,e,a,n),e.prototype=i(a.prototype,s),e.prototype.constructor=e,e.class_=t||a.class_,e.super_=a,e}function r(t,i,n){for(var r,a,o=0,l=(n=s.call(arguments,2)).length;o<l;o++)for(r in a=n[o])t&&!e.call(a,r)||(i[r]=a[r])}var a=n;function o(){}o.class_="Nevis",o.super_=Object,o.extend=a;var l=o,h=l.extend((function(t,e,s){this.qrious=t,this.element=e,this.element.qrious=t,this.enabled=Boolean(s)}),{draw:function(t){},getElement:function(){return this.enabled||(this.enabled=!0,this.render()),this.element},getModuleSize:function(t){var e=this.qrious,s=e.padding||0,i=Math.floor((e.size-2*s)/t.width);return Math.max(1,i)},getOffset:function(t){var e=this.qrious,s=e.padding;if(null!=s)return s;var i=this.getModuleSize(t),n=Math.floor((e.size-i*t.width)/2);return Math.max(0,n)},render:function(t){this.enabled&&(this.resize(),this.reset(),this.draw(t))},reset:function(){},resize:function(){}}),c=h,d=c.extend({draw:function(t){var e,s,i=this.qrious,n=this.getModuleSize(t),r=this.getOffset(t),a=this.element.getContext("2d");for(a.fillStyle=i.foreground,a.globalAlpha=i.foregroundAlpha,e=0;e<t.width;e++)for(s=0;s<t.width;s++)t.buffer[s*t.width+e]&&a.fillRect(n*e+r,n*s+r,n,n)},reset:function(){var t=this.qrious,e=this.element.getContext("2d"),s=t.size;e.lineWidth=1,e.clearRect(0,0,s,s),e.fillStyle=t.background,e.globalAlpha=t.backgroundAlpha,e.fillRect(0,0,s,s)},resize:function(){var t=this.element;t.width=t.height=this.qrious.size}}),u=d,p=l.extend(null,{BLOCK:[0,11,15,19,23,27,31,16,18,20,22,24,26,28,20,22,24,24,26,28,28,22,24,24,26,26,28,28,24,24,26,26,26,28,28,24,26,26,26,28,28]}),f=l.extend(null,{BLOCKS:[1,0,19,7,1,0,16,10,1,0,13,13,1,0,9,17,1,0,34,10,1,0,28,16,1,0,22,22,1,0,16,28,1,0,55,15,1,0,44,26,2,0,17,18,2,0,13,22,1,0,80,20,2,0,32,18,2,0,24,26,4,0,9,16,1,0,108,26,2,0,43,24,2,2,15,18,2,2,11,22,2,0,68,18,4,0,27,16,4,0,19,24,4,0,15,28,2,0,78,20,4,0,31,18,2,4,14,18,4,1,13,26,2,0,97,24,2,2,38,22,4,2,18,22,4,2,14,26,2,0,116,30,3,2,36,22,4,4,16,20,4,4,12,24,2,2,68,18,4,1,43,26,6,2,19,24,6,2,15,28,4,0,81,20,1,4,50,30,4,4,22,28,3,8,12,24,2,2,92,24,6,2,36,22,4,6,20,26,7,4,14,28,4,0,107,26,8,1,37,22,8,4,20,24,12,4,11,22,3,1,115,30,4,5,40,24,11,5,16,20,11,5,12,24,5,1,87,22,5,5,41,24,5,7,24,30,11,7,12,24,5,1,98,24,7,3,45,28,15,2,19,24,3,13,15,30,1,5,107,28,10,1,46,28,1,15,22,28,2,17,14,28,5,1,120,30,9,4,43,26,17,1,22,28,2,19,14,28,3,4,113,28,3,11,44,26,17,4,21,26,9,16,13,26,3,5,107,28,3,13,41,26,15,5,24,30,15,10,15,28,4,4,116,28,17,0,42,26,17,6,22,28,19,6,16,30,2,7,111,28,17,0,46,28,7,16,24,30,34,0,13,24,4,5,121,30,4,14,47,28,11,14,24,30,16,14,15,30,6,4,117,30,6,14,45,28,11,16,24,30,30,2,16,30,8,4,106,26,8,13,47,28,7,22,24,30,22,13,15,30,10,2,114,28,19,4,46,28,28,6,22,28,33,4,16,30,8,4,122,30,22,3,45,28,8,26,23,30,12,28,15,30,3,10,117,30,3,23,45,28,4,31,24,30,11,31,15,30,7,7,116,30,21,7,45,28,1,37,23,30,19,26,15,30,5,10,115,30,19,10,47,28,15,25,24,30,23,25,15,30,13,3,115,30,2,29,46,28,42,1,24,30,23,28,15,30,17,0,115,30,10,23,46,28,10,35,24,30,19,35,15,30,17,1,115,30,14,21,46,28,29,19,24,30,11,46,15,30,13,6,115,30,14,23,46,28,44,7,24,30,59,1,16,30,12,7,121,30,12,26,47,28,39,14,24,30,22,41,15,30,6,14,121,30,6,34,47,28,46,10,24,30,2,64,15,30,17,4,122,30,29,14,46,28,49,10,24,30,24,46,15,30,4,18,122,30,13,32,46,28,48,14,24,30,42,32,15,30,20,4,117,30,40,7,47,28,43,22,24,30,10,67,15,30,19,6,118,30,18,31,47,28,34,34,24,30,20,61,15,30],FINAL_FORMAT:[30660,29427,32170,30877,26159,25368,27713,26998,21522,20773,24188,23371,17913,16590,20375,19104,13663,12392,16177,14854,9396,8579,11994,11245,5769,5054,7399,6608,1890,597,3340,2107],LEVELS:{L:1,M:2,Q:3,H:4}}),m=l.extend(null,{EXPONENT:[1,2,4,8,16,32,64,128,29,58,116,232,205,135,19,38,76,152,45,90,180,117,234,201,143,3,6,12,24,48,96,192,157,39,78,156,37,74,148,53,106,212,181,119,238,193,159,35,70,140,5,10,20,40,80,160,93,186,105,210,185,111,222,161,95,190,97,194,153,47,94,188,101,202,137,15,30,60,120,240,253,231,211,187,107,214,177,127,254,225,223,163,91,182,113,226,217,175,67,134,17,34,68,136,13,26,52,104,208,189,103,206,129,31,62,124,248,237,199,147,59,118,236,197,151,51,102,204,133,23,46,92,184,109,218,169,79,158,33,66,132,21,42,84,168,77,154,41,82,164,85,170,73,146,57,114,228,213,183,115,230,209,191,99,198,145,63,126,252,229,215,179,123,246,241,255,227,219,171,75,150,49,98,196,149,55,110,220,165,87,174,65,130,25,50,100,200,141,7,14,28,56,112,224,221,167,83,166,81,162,89,178,121,242,249,239,195,155,43,86,172,69,138,9,18,36,72,144,61,122,244,245,247,243,251,235,203,139,11,22,44,88,176,125,250,233,207,131,27,54,108,216,173,71,142,0],LOG:[255,0,1,25,2,50,26,198,3,223,51,238,27,104,199,75,4,100,224,14,52,141,239,129,28,193,105,248,200,8,76,113,5,138,101,47,225,36,15,33,53,147,142,218,240,18,130,69,29,181,194,125,106,39,249,185,201,154,9,120,77,228,114,166,6,191,139,98,102,221,48,253,226,152,37,179,16,145,34,136,54,208,148,206,143,150,219,189,241,210,19,92,131,56,70,64,30,66,182,163,195,72,126,110,107,58,40,84,250,133,186,61,202,94,155,159,10,21,121,43,78,212,229,172,115,243,167,87,7,112,192,247,140,128,99,13,103,74,222,237,49,197,254,24,227,165,153,119,38,184,180,124,17,68,146,217,35,32,137,46,55,63,209,91,149,188,207,205,144,135,151,178,220,252,190,97,242,86,211,171,20,42,93,158,132,60,57,83,71,109,65,162,31,45,67,216,183,123,164,118,196,23,73,236,127,12,111,246,108,161,59,82,41,157,85,170,251,96,134,177,187,204,62,90,203,89,95,176,156,169,160,81,11,245,22,235,122,117,44,215,79,174,213,233,230,231,173,232,116,214,244,234,168,80,88,175]}),g=l.extend(null,{BLOCK:[3220,1468,2713,1235,3062,1890,2119,1549,2344,2936,1117,2583,1330,2470,1667,2249,2028,3780,481,4011,142,3098,831,3445,592,2517,1776,2234,1951,2827,1070,2660,1345,3177]}),_=g,v=l.extend((function(t){var e,s,i,n,r,a=t.value.length;for(this._badness=[],this._level=f.LEVELS[t.level],this._polynomial=[],this._value=t.value,this._version=0,this._stringBuffer=[];this._version<40&&(this._version++,i=4*(this._level-1)+16*(this._version-1),n=f.BLOCKS[i++],r=f.BLOCKS[i++],e=f.BLOCKS[i++],s=f.BLOCKS[i],!(a<=(i=e*(n+r)+r-3+(this._version<=9)))););this._dataBlock=e,this._eccBlock=s,this._neccBlock1=n,this._neccBlock2=r;var o=this.width=17+4*this._version;this.buffer=v._createArray(o*o),this._ecc=v._createArray(e+(e+s)*(n+r)+r),this._mask=v._createArray((o*(o+1)+1)/2),this._insertFinders(),this._insertAlignments(),this.buffer[8+o*(o-8)]=1,this._insertTimingGap(),this._reverseMask(),this._insertTimingRowAndColumn(),this._insertVersion(),this._syncMask(),this._convertBitStream(a),this._calculatePolynomial(),this._appendEccToData(),this._interleaveBlocks(),this._pack(),this._finish()}),{_addAlignment:function(t,e){var s,i=this.buffer,n=this.width;for(i[t+n*e]=1,s=-2;s<2;s++)i[t+s+n*(e-2)]=1,i[t-2+n*(e+s+1)]=1,i[t+2+n*(e+s)]=1,i[t+s+1+n*(e+2)]=1;for(s=0;s<2;s++)this._setMask(t-1,e+s),this._setMask(t+1,e-s),this._setMask(t-s,e-1),this._setMask(t+s,e+1)},_appendData:function(t,e,s,i){var n,r,a,o=this._polynomial,l=this._stringBuffer;for(r=0;r<i;r++)l[s+r]=0;for(r=0;r<e;r++){if(255!==(n=m.LOG[l[t+r]^l[s]]))for(a=1;a<i;a++)l[s+a-1]=l[s+a]^m.EXPONENT[v._modN(n+o[i-a])];else for(a=s;a<s+i;a++)l[a]=l[a+1];l[s+i-1]=255===n?0:m.EXPONENT[v._modN(n+o[0])]}},_appendEccToData:function(){var t,e=0,s=this._dataBlock,i=this._calculateMaxLength(),n=this._eccBlock;for(t=0;t<this._neccBlock1;t++)this._appendData(e,s,i,n),e+=s,i+=n;for(t=0;t<this._neccBlock2;t++)this._appendData(e,s+1,i,n),e+=s+1,i+=n},_applyMask:function(t){var e,s,i,n,r=this.buffer,a=this.width;switch(t){case 0:for(n=0;n<a;n++)for(i=0;i<a;i++)i+n&1||this._isMasked(i,n)||(r[i+n*a]^=1);break;case 1:for(n=0;n<a;n++)for(i=0;i<a;i++)1&n||this._isMasked(i,n)||(r[i+n*a]^=1);break;case 2:for(n=0;n<a;n++)for(e=0,i=0;i<a;i++,e++)3===e&&(e=0),e||this._isMasked(i,n)||(r[i+n*a]^=1);break;case 3:for(s=0,n=0;n<a;n++,s++)for(3===s&&(s=0),e=s,i=0;i<a;i++,e++)3===e&&(e=0),e||this._isMasked(i,n)||(r[i+n*a]^=1);break;case 4:for(n=0;n<a;n++)for(e=0,s=n>>1&1,i=0;i<a;i++,e++)3===e&&(e=0,s=!s),s||this._isMasked(i,n)||(r[i+n*a]^=1);break;case 5:for(s=0,n=0;n<a;n++,s++)for(3===s&&(s=0),e=0,i=0;i<a;i++,e++)3===e&&(e=0),(i&n&1)+!(!e|!s)||this._isMasked(i,n)||(r[i+n*a]^=1);break;case 6:for(s=0,n=0;n<a;n++,s++)for(3===s&&(s=0),e=0,i=0;i<a;i++,e++)3===e&&(e=0),(i&n&1)+(e&&e===s)&1||this._isMasked(i,n)||(r[i+n*a]^=1);break;case 7:for(s=0,n=0;n<a;n++,s++)for(3===s&&(s=0),e=0,i=0;i<a;i++,e++)3===e&&(e=0),(e&&e===s)+(i+n&1)&1||this._isMasked(i,n)||(r[i+n*a]^=1)}},_calculateMaxLength:function(){return this._dataBlock*(this._neccBlock1+this._neccBlock2)+this._neccBlock2},_calculatePolynomial:function(){var t,e,s=this._eccBlock,i=this._polynomial;for(i[0]=1,t=0;t<s;t++){for(i[t+1]=1,e=t;e>0;e--)i[e]=i[e]?i[e-1]^m.EXPONENT[v._modN(m.LOG[i[e]]+t)]:i[e-1];i[0]=m.EXPONENT[v._modN(m.LOG[i[0]]+t)]}for(t=0;t<=s;t++)i[t]=m.LOG[i[t]]},_checkBadness:function(){var t,e,s,i,n,r=0,a=this._badness,o=this.buffer,l=this.width;for(n=0;n<l-1;n++)for(i=0;i<l-1;i++)(o[i+l*n]&&o[i+1+l*n]&&o[i+l*(n+1)]&&o[i+1+l*(n+1)]||!(o[i+l*n]||o[i+1+l*n]||o[i+l*(n+1)]||o[i+1+l*(n+1)]))&&(r+=v.N2);var h=0;for(n=0;n<l;n++){for(s=0,a[0]=0,t=0,i=0;i<l;i++)t===(e=o[i+l*n])?a[s]++:a[++s]=1,h+=(t=e)?1:-1;r+=this._getBadness(s)}h<0&&(h=-h);var c=0,d=h;for(d+=d<<2,d<<=1;d>l*l;)d-=l*l,c++;for(r+=c*v.N4,i=0;i<l;i++){for(s=0,a[0]=0,t=0,n=0;n<l;n++)t===(e=o[i+l*n])?a[s]++:a[++s]=1,t=e;r+=this._getBadness(s)}return r},_convertBitStream:function(t){var e,s,i=this._ecc,n=this._version;for(s=0;s<t;s++)i[s]=this._value.charCodeAt(s);var r=this._stringBuffer=i.slice(),a=this._calculateMaxLength();t>=a-2&&(t=a-2,n>9&&t--);var o=t;if(n>9){for(r[o+2]=0,r[o+3]=0;o--;)e=r[o],r[o+3]|=255&e<<4,r[o+2]=e>>4;r[2]|=255&t<<4,r[1]=t>>4,r[0]=64|t>>12}else{for(r[o+1]=0,r[o+2]=0;o--;)e=r[o],r[o+2]|=255&e<<4,r[o+1]=e>>4;r[1]|=255&t<<4,r[0]=64|t>>4}for(o=t+3-(n<10);o<a;)r[o++]=236,r[o++]=17},_getBadness:function(t){var e,s=0,i=this._badness;for(e=0;e<=t;e++)i[e]>=5&&(s+=v.N1+i[e]-5);for(e=3;e<t-1;e+=2)i[e-2]===i[e+2]&&i[e+2]===i[e-1]&&i[e-1]===i[e+1]&&3*i[e-1]===i[e]&&(0===i[e-3]||e+3>t||3*i[e-3]>=4*i[e]||3*i[e+3]>=4*i[e])&&(s+=v.N3);return s},_finish:function(){var t,e;this._stringBuffer=this.buffer.slice();var s=0,i=3e4;for(e=0;e<8&&(this._applyMask(e),(t=this._checkBadness())<i&&(i=t,s=e),7!==s);e++)this.buffer=this._stringBuffer.slice();s!==e&&this._applyMask(s),i=f.FINAL_FORMAT[s+(this._level-1<<3)];var n=this.buffer,r=this.width;for(e=0;e<8;e++,i>>=1)1&i&&(n[r-1-e+8*r]=1,e<6?n[8+r*e]=1:n[8+r*(e+1)]=1);for(e=0;e<7;e++,i>>=1)1&i&&(n[8+r*(r-7+e)]=1,e?n[6-e+8*r]=1:n[7+8*r]=1)},_interleaveBlocks:function(){var t,e,s=this._dataBlock,i=this._ecc,n=this._eccBlock,r=0,a=this._calculateMaxLength(),o=this._neccBlock1,l=this._neccBlock2,h=this._stringBuffer;for(t=0;t<s;t++){for(e=0;e<o;e++)i[r++]=h[t+e*s];for(e=0;e<l;e++)i[r++]=h[o*s+t+e*(s+1)]}for(e=0;e<l;e++)i[r++]=h[o*s+t+e*(s+1)];for(t=0;t<n;t++)for(e=0;e<o+l;e++)i[r++]=h[a+t+e*n];this._stringBuffer=i},_insertAlignments:function(){var t,e,s,i=this._version,n=this.width;if(i>1)for(t=p.BLOCK[i],s=n-7;;){for(e=n-7;e>t-3&&(this._addAlignment(e,s),!(e<t));)e-=t;if(s<=t+9)break;s-=t,this._addAlignment(6,s),this._addAlignment(s,6)}},_insertFinders:function(){var t,e,s,i,n=this.buffer,r=this.width;for(t=0;t<3;t++){for(e=0,i=0,1===t&&(e=r-7),2===t&&(i=r-7),n[i+3+r*(e+3)]=1,s=0;s<6;s++)n[i+s+r*e]=1,n[i+r*(e+s+1)]=1,n[i+6+r*(e+s)]=1,n[i+s+1+r*(e+6)]=1;for(s=1;s<5;s++)this._setMask(i+s,e+1),this._setMask(i+1,e+s+1),this._setMask(i+5,e+s),this._setMask(i+s+1,e+5);for(s=2;s<4;s++)n[i+s+r*(e+2)]=1,n[i+2+r*(e+s+1)]=1,n[i+4+r*(e+s)]=1,n[i+s+1+r*(e+4)]=1}},_insertTimingGap:function(){var t,e,s=this.width;for(e=0;e<7;e++)this._setMask(7,e),this._setMask(s-8,e),this._setMask(7,e+s-7);for(t=0;t<8;t++)this._setMask(t,7),this._setMask(t+s-8,7),this._setMask(t,s-8)},_insertTimingRowAndColumn:function(){var t,e=this.buffer,s=this.width;for(t=0;t<s-14;t++)1&t?(this._setMask(8+t,6),this._setMask(6,8+t)):(e[8+t+6*s]=1,e[6+s*(8+t)]=1)},_insertVersion:function(){var t,e,s,i,n=this.buffer,r=this._version,a=this.width;if(r>6)for(t=_.BLOCK[r-7],e=17,s=0;s<6;s++)for(i=0;i<3;i++,e--)1&(e>11?r>>e-12:t>>e)?(n[5-s+a*(2-i+a-11)]=1,n[2-i+a-11+a*(5-s)]=1):(this._setMask(5-s,2-i+a-11),this._setMask(2-i+a-11,5-s))},_isMasked:function(t,e){var s=v._getMaskBit(t,e);return 1===this._mask[s]},_pack:function(){var t,e,s,i=1,n=1,r=this.width,a=r-1,o=r-1,l=(this._dataBlock+this._eccBlock)*(this._neccBlock1+this._neccBlock2)+this._neccBlock2;for(e=0;e<l;e++)for(t=this._stringBuffer[e],s=0;s<8;s++,t<<=1){128&t&&(this.buffer[a+r*o]=1);do{n?a--:(a++,i?0!==o?o--:(i=!i,6==(a-=2)&&(a--,o=9)):o!==r-1?o++:(i=!i,6==(a-=2)&&(a--,o-=8))),n=!n}while(this._isMasked(a,o))}},_reverseMask:function(){var t,e,s=this.width;for(t=0;t<9;t++)this._setMask(t,8);for(t=0;t<8;t++)this._setMask(t+s-8,8),this._setMask(8,t);for(e=0;e<7;e++)this._setMask(8,e+s-7)},_setMask:function(t,e){var s=v._getMaskBit(t,e);this._mask[s]=1},_syncMask:function(){var t,e,s=this.width;for(e=0;e<s;e++)for(t=0;t<=e;t++)this.buffer[t+s*e]&&this._setMask(t,e)}},{_createArray:function(t){var e,s=[];for(e=0;e<t;e++)s[e]=0;return s},_getMaskBit:function(t,e){var s;return t>e&&(s=t,t=e,e=s),s=e,s+=e*e,s>>=1,s+=t},_modN:function(t){for(;t>=255;)t=((t-=255)>>8)+(255&t);return t},N1:3,N2:3,N3:40,N4:10}),b=v,y=c.extend({draw:function(){this.element.src=this.qrious.toDataURL()},reset:function(){this.element.src=""},resize:function(){var t=this.element;t.width=t.height=this.qrious.size}}),x=l.extend((function(t,e,s,i){this.name=t,this.modifiable=Boolean(e),this.defaultValue=s,this._valueTransformer=i}),{transform:function(t){var e=this._valueTransformer;return"function"==typeof e?e(t,this):t}}),w=l.extend(null,{abs:function(t){return null!=t?Math.abs(t):null},hasOwn:function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},noop:function(){},toUpperCase:function(t){return null!=t?t.toUpperCase():null}}),S=l.extend((function(t){this.options={},t.forEach((function(t){this.options[t.name]=t}),this)}),{exists:function(t){return null!=this.options[t]},get:function(t,e){return S._get(this.options[t],e)},getAll:function(t){var e,s=this.options,i={};for(e in s)w.hasOwn(s,e)&&(i[e]=S._get(s[e],t));return i},init:function(t,e,s){var i,n;for(i in"function"!=typeof s&&(s=w.noop),this.options)w.hasOwn(this.options,i)&&(n=this.options[i],S._set(n,n.defaultValue,e),S._createAccessor(n,e,s));this._setAll(t,e,!0)},set:function(t,e,s){return this._set(t,e,s)},setAll:function(t,e){return this._setAll(t,e)},_set:function(t,e,s,i){var n=this.options[t];if(!n)throw new Error("Invalid option: "+t);if(!n.modifiable&&!i)throw new Error("Option cannot be modified: "+t);return S._set(n,e,s)},_setAll:function(t,e,s){if(!t)return!1;var i,n=!1;for(i in t)w.hasOwn(t,i)&&this._set(i,t[i],e,s)&&(n=!0);return n}},{_createAccessor:function(t,e,s){var i={get:function(){return S._get(t,e)}};t.modifiable&&(i.set=function(i){S._set(t,i,e)&&s(i,t)}),Object.defineProperty(e,t.name,i)},_get:function(t,e){return e["_"+t.name]},_set:function(t,e,s){var i="_"+t.name,n=s[i],r=t.transform(null!=e?e:t.defaultValue);return s[i]=r,r!==n}}),C=S,T=l.extend((function(){this._services={}}),{getService:function(t){var e=this._services[t];if(!e)throw new Error("Service is not being managed with name: "+t);return e},setService:function(t,e){if(this._services[t])throw new Error("Service is already managed with name: "+t);e&&(this._services[t]=e)}}),E=new C([new x("background",!0,"white"),new x("backgroundAlpha",!0,1,w.abs),new x("element"),new x("foreground",!0,"black"),new x("foregroundAlpha",!0,1,w.abs),new x("level",!0,"L",w.toUpperCase),new x("mime",!0,"image/png"),new x("padding",!0,null,w.abs),new x("size",!0,100,w.abs),new x("value",!0,"")]),P=new T,M=l.extend((function(t){E.init(t,this,this.update.bind(this));var e=E.get("element",this),s=P.getService("element"),i=e&&s.isCanvas(e)?e:s.createCanvas(),n=e&&s.isImage(e)?e:s.createImage();this._canvasRenderer=new u(this,i,!0),this._imageRenderer=new y(this,n,n===e),this.update()}),{get:function(){return E.getAll(this)},set:function(t){E.setAll(t,this)&&this.update()},toDataURL:function(t){return this.canvas.toDataURL(t||this.mime)},update:function(){var t=new b({level:this.level,value:this.value});this._canvasRenderer.render(t),this._imageRenderer.render(t)}},{use:function(t){P.setService(t.getName(),t)}});Object.defineProperties(M.prototype,{canvas:{get:function(){return this._canvasRenderer.getElement()}},image:{get:function(){return this._imageRenderer.getElement()}}});var A=M,k=A,D=l.extend({getName:function(){}}).extend({createCanvas:function(){},createImage:function(){},getName:function(){return"element"},isCanvas:function(t){},isImage:function(t){}}).extend({createCanvas:function(){return document.createElement("canvas")},createImage:function(){return document.createElement("img")},isCanvas:function(t){return t instanceof HTMLCanvasElement},isImage:function(t){return t instanceof HTMLImageElement}});return k.use(new D),k}();var GP=Tu(HP.exports);const WP=t=>[t.r,t.g,t.b,1],jP=t=>({r:t[0],g:t[1],b:t[2]});class qP extends lp.Component{shouldComponentUpdate(t){const e=["ui","debug","animation.playing"],s=wu(t.observerData,e),i=wu(this.props.observerData,e);return JSON.stringify(s)!==JSON.stringify(i)}render(){const t=this.props;return lp.createElement("div",{className:"popup-panel-parent"},lp.createElement(zT,{class:"popup-panel",flex:!0,hidden:"camera"!==t.observerData.ui.active},lp.createElement(gE,{text:"Camera",class:"popup-panel-heading"}),lp.createElement(_P,{label:"Fov",precision:0,min:35,max:150,value:t.observerData.camera.fov,setProperty:e=>t.setProperty("camera.fov",e)}),lp.createElement(xP,{label:"Tonemap",type:"string",options:["Linear","Filmic","Hejl","ACES","ACES2"].map((t=>({v:t,t:t}))),value:t.observerData.camera.tonemapping,setProperty:e=>t.setProperty("camera.tonemapping",e)}),lp.createElement(xP,{label:"Pixel Scale",value:t.observerData.camera.pixelScale,type:"number",options:[1,2,4,8,16].map((t=>({v:t,t:Number(t).toString()}))),setProperty:e=>t.setProperty("camera.pixelScale",e)}),lp.createElement(mP,{label:"Multisample",value:t.observerData.camera.multisample,enabled:t.observerData.camera.multisampleSupported,setProperty:e=>t.setProperty("camera.multisample",e)}),lp.createElement(mP,{label:"High Quality",value:t.observerData.camera.hq,enabled:!t.observerData.animation.playing&&!t.observerData.debug.stats,setProperty:e=>t.setProperty("camera.hq",e)})))}}class XP extends lp.Component{shouldComponentUpdate(t){return JSON.stringify(t.skyboxData)!==JSON.stringify(this.props.skyboxData)||JSON.stringify(t.uiData)!==JSON.stringify(this.props.uiData)}render(){const t=this.props;return lp.createElement("div",{className:"popup-panel-parent"},lp.createElement(zT,{class:"popup-panel",flex:!0,hidden:"skybox"!==t.uiData.active},lp.createElement(gE,{text:"Sky",class:"popup-panel-heading"}),lp.createElement(xP,{label:"Environment",type:"string",options:JSON.parse(t.skyboxData.options),value:t.skyboxData.value,setProperty:e=>t.setProperty("skybox.value",e)}),lp.createElement(_P,{label:"Exposure",value:t.skyboxData.exposure,setProperty:e=>t.setProperty("skybox.exposure",e),precision:2,min:-6,max:6,enabled:"None"!==t.skyboxData.value}),lp.createElement(_P,{label:"Rotation",precision:0,min:-180,max:180,value:t.skyboxData.rotation,setProperty:e=>t.setProperty("skybox.rotation",e),enabled:"None"!==t.skyboxData.value}),lp.createElement(xP,{label:"Background",type:"string",options:["Solid Color","Infinite Sphere","Projective Dome"].map((t=>({v:t,t:t}))),value:t.skyboxData.background,setProperty:e=>t.setProperty("skybox.background",e),enabled:"None"!==t.skyboxData.value}),lp.createElement(bP,{label:"Background Color",value:WP(t.skyboxData.backgroundColor),setProperty:e=>t.setProperty("skybox.backgroundColor",jP(e)),enabled:"None"===t.skyboxData.value||"Solid Color"===t.skyboxData.background}),lp.createElement(_P,{label:"Blur",value:t.skyboxData.blur,setProperty:e=>t.setProperty("skybox.blur",e),enabled:"None"!==t.skyboxData.value&&"Infinite Sphere"===t.skyboxData.background,min:0,max:5,precision:0,step:1}),lp.createElement(vP,{label:"Dome Radius",value:t.skyboxData.domeProjection.domeRadius,setProperty:e=>t.setProperty("skybox.domeProjection.domeRadius",e),min:0,max:1e3,enabled:"None"!==t.skyboxData.value&&"Projective Dome"===t.skyboxData.background}),lp.createElement(_P,{label:"Dome Offset",value:t.skyboxData.domeProjection.domeOffset,setProperty:e=>t.setProperty("skybox.domeProjection.domeOffset",e),min:-1,max:1,precision:2,enabled:"None"!==t.skyboxData.value&&"Projective Dome"===t.skyboxData.background}),lp.createElement(_P,{label:"Tripod Offset",value:t.skyboxData.domeProjection.tripodOffset,setProperty:e=>t.setProperty("skybox.domeProjection.tripodOffset",e),min:0,max:1,precision:2,enabled:"None"!==t.skyboxData.value&&"Projective Dome"===t.skyboxData.background})))}}class $P extends lp.Component{shouldComponentUpdate(t){return JSON.stringify(t.lightData)!==JSON.stringify(this.props.lightData)||JSON.stringify(t.uiData)!==JSON.stringify(this.props.uiData)}render(){const t=this.props;return lp.createElement("div",{className:"popup-panel-parent"},lp.createElement(zT,{class:"popup-panel",flex:!0,hidden:"light"!==t.uiData.active},lp.createElement(gE,{text:"Light",class:"popup-panel-heading"}),lp.createElement(mP,{label:"Enabled",value:t.lightData.enabled,setProperty:e=>t.setProperty("light.enabled",e)}),lp.createElement(mP,{label:"Follow Camera",value:t.lightData.follow,setProperty:e=>t.setProperty("light.follow",e)}),lp.createElement(bP,{label:"Color",value:WP(t.lightData.color),setProperty:e=>t.setProperty("light.color",jP(e))}),lp.createElement(_P,{label:"Intensity",precision:2,min:0,max:6,value:t.lightData.intensity,setProperty:e=>t.setProperty("light.intensity",e)}),lp.createElement(mP,{label:"Cast Shadow",value:t.lightData.shadow,setProperty:e=>t.setProperty("light.shadow",e)}),lp.createElement(mP,{label:"Shadow Catcher",value:t.shadowCatcherData.enabled,setProperty:e=>t.setProperty("shadowCatcher.enabled",e)}),lp.createElement(_P,{label:"Catcher Intensity",precision:2,min:0,max:1,value:t.shadowCatcherData.intensity,setProperty:e=>t.setProperty("shadowCatcher.intensity",e)})))}}class KP extends lp.Component{shouldComponentUpdate(t){return JSON.stringify(t.debugData)!==JSON.stringify(this.props.debugData)||JSON.stringify(t.uiData)!==JSON.stringify(this.props.uiData)}render(){const t=this.props;return lp.createElement("div",{className:"popup-panel-parent"},lp.createElement(zT,{class:"popup-panel",flex:!0,hidden:"debug"!==t.uiData.active},lp.createElement(gE,{text:"Debug",class:"popup-panel-heading"}),lp.createElement(xP,{label:"Render Mode",type:"string",options:[{t:"Default",v:"default"},{t:"Lighting",v:"lighting"},{t:"Albedo",v:"albedo"},{t:"Emissive",v:"emission"},{t:"WorldNormal",v:"world_normal"},{t:"Metalness",v:"metalness"},{t:"Gloss",v:"gloss"},{t:"Ao",v:"ao"},{t:"Specularity",v:"specularity"},{t:"Opacity",v:"opacity"},{t:"Uv0",v:"uv0"}],value:t.debugData.renderMode,setProperty:e=>t.setProperty("debug.renderMode",e)}),lp.createElement(gP,{label:"Wireframe",booleanValue:t.debugData.wireframe,setBooleanProperty:e=>t.setProperty("debug.wireframe",e),colorValue:WP(t.debugData.wireframeColor),setColorProperty:e=>t.setProperty("debug.wireframeColor",jP(e))}),lp.createElement(mP,{label:"Grid",value:t.debugData.grid,setProperty:e=>t.setProperty("debug.grid",e)}),lp.createElement(mP,{label:"Axes",value:t.debugData.axes,setProperty:e=>t.setProperty("debug.axes",e)}),lp.createElement(mP,{label:"Skeleton",value:t.debugData.skeleton,setProperty:e=>t.setProperty("debug.skeleton",e)}),lp.createElement(mP,{label:"Bounds",value:t.debugData.bounds,setProperty:e=>t.setProperty("debug.bounds",e)}),lp.createElement(_P,{label:"Normals",precision:2,min:0,max:1,setProperty:e=>t.setProperty("debug.normals",e),value:t.debugData.normals}),lp.createElement(mP,{label:"Stats",value:t.debugData.stats,setProperty:e=>t.setProperty("debug.stats",e)})))}}class YP extends lp.Component{get shareUrl(){return`${location.origin}${location.pathname}?${this.props.sceneData.urls.map((t=>`load=${t}`)).join("&")}`}constructor(t){super(t),this.isMobile=/Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}shouldComponentUpdate(t){return JSON.stringify(t.sceneData)!==JSON.stringify(this.props.sceneData)||JSON.stringify(t.uiData)!==JSON.stringify(this.props.uiData)}get hasQRCode(){return this.props.sceneData.urls.length>0&&!this.isMobile}updateQRCode(){const t=document.getElementById("share-qr");new GP({element:t,value:this.shareUrl,size:t.getBoundingClientRect().width*window.devicePixelRatio})}componentDidMount(){this.hasQRCode&&this.updateQRCode()}componentDidUpdate(){this.hasQRCode&&this.updateQRCode()}render(){const t=this.props;return lp.createElement("div",{className:"popup-panel-parent"},lp.createElement(zT,{id:"view-panel",class:"popup-panel",flex:!0,hidden:"view"!==t.uiData.active},this.hasQRCode?lp.createElement(lp.Fragment,null,lp.createElement(gE,{text:"View and share on mobile with QR code"}),lp.createElement("div",{id:"qr-wrapper"},lp.createElement("canvas",{id:"share-qr"})),lp.createElement(gE,{text:"View and share on mobile with URL"}),lp.createElement("div",{id:"share-url-wrapper"},lp.createElement(zE,{class:"secondary",value:this.shareUrl,enabled:!1}),lp.createElement(xT,{id:"copy-button",icon:"E126",onClick:()=>{navigator.clipboard&&window.isSecureContext&&navigator.clipboard.writeText(this.shareUrl)}}))):null,lp.createElement(xT,{class:"secondary",text:"TAKE A SNAPSHOT AS PNG",onClick:()=>{window.viewer&&window.viewer.downloadPngScreenshot()}})))}}
/**
 * @license
 * PlayCanvas Engine v1.64.4 revision 7fc5c5c22
 * Copyright 2011-2023 PlayCanvas Ltd. All rights reserved.
 */class QP{constructor(t){this._frameIndex=0,this._frameTimings=[],this._timings=[],this._prevTimings=[],this.unitsName="ms",this.decimalPlaces=1,this.enabled=!0,t.on("frameupdate",this.begin.bind(this,"update")),t.on("framerender",this.mark.bind(this,"render")),t.on("frameend",this.mark.bind(this,"other"))}begin(t){if(!this.enabled)return;this._frameIndex<this._frameTimings.length&&this._frameTimings.splice(this._frameIndex);const e=this._prevTimings;this._prevTimings=this._timings,this._timings=this._frameTimings,this._frameTimings=e,this._frameIndex=0,this.mark(t)}mark(t){if(!this.enabled)return;const e=P();if(this._frameIndex>0){const t=this._frameTimings[this._frameIndex-1];t[1]=e-t[1]}else if(this._timings.length>0){const t=this._timings[this._timings.length-1];t[1]=e-t[1]}if(this._frameIndex>=this._frameTimings.length)this._frameTimings.push([t,e]);else{const s=this._frameTimings[this._frameIndex];s[0]=t,s[1]=e}this._frameIndex++}get timings(){return this._timings.slice(0,-1).map((t=>t[1]))}}
/**
 * @license
 * PlayCanvas Engine v1.64.4 revision 7fc5c5c22
 * Copyright 2011-2023 PlayCanvas Ltd. All rights reserved.
 */class JP{constructor(t){this._gl=t.graphicsDevice.gl,this._ext=t.graphicsDevice.extDisjointTimerQuery,this._freeQueries=[],this._frameQueries=[],this._frames=[],this._timings=[],this._prevTimings=[],this.enabled=!0,this.unitsName="ms",this.decimalPlaces=1,t.on("frameupdate",this.begin.bind(this,"update")),t.on("framerender",this.mark.bind(this,"render")),t.on("frameend",this.end.bind(this))}loseContext(){this._freeQueries=[],this._frameQueries=[],this._frames=[]}begin(t){if(this.enabled){if(this._frameQueries.length>0&&this.end(),this._checkDisjoint(),this._frames.length>0&&this._resolveFrameTimings(this._frames[0],this._prevTimings)){const t=this._prevTimings;this._prevTimings=this._timings,this._timings=t,this._freeQueries=this._freeQueries.concat(this._frames.splice(0,1)[0])}this.mark(t)}}mark(t){if(!this.enabled)return;this._frameQueries.length>0&&this._gl.endQuery(this._ext.TIME_ELAPSED_EXT);const e=this._allocateQuery();e[0]=t,this._gl.beginQuery(this._ext.TIME_ELAPSED_EXT,e[1]),this._frameQueries.push(e)}end(){this.enabled&&(this._gl.endQuery(this._ext.TIME_ELAPSED_EXT),this._frames.push(this._frameQueries),this._frameQueries=[])}_checkDisjoint(){this._gl.getParameter(this._ext.GPU_DISJOINT_EXT)&&(this._freeQueries=[this._frames,[this._frameQueries],[this._freeQueries]].flat(2),this._frameQueries=[],this._frames=[])}_allocateQuery(){return this._freeQueries.length>0?this._freeQueries.splice(-1,1)[0]:["",this._gl.createQuery()]}_resolveFrameTimings(t,e){if(!this._gl.getQueryParameter(t[t.length-1][1],this._gl.QUERY_RESULT_AVAILABLE))return!1;for(let s=0;s<t.length;++s)e[s]=[t[s][0],1e-6*this._gl.getQueryParameter(t[s][1],this._gl.QUERY_RESULT)];return!0}get timings(){return this._timings.map((t=>t[1]))}}
/**
 * @license
 * PlayCanvas Engine v1.64.4 revision 7fc5c5c22
 * Copyright 2011-2023 PlayCanvas Ltd. All rights reserved.
 */class ZP{constructor(t,e,s,i,n){this.app=t,this.values=[],this.statNames=e,this.statNames.length>3&&(this.statNames.length=3),this.unitsName=i,this.decimalPlaces=s,this.multiplier=n||1;const r=(t,e)=>t.split(".").reduce(((t,e)=>t?t[e]:null),e||this);t.on("frameupdate",(t=>{for(let t=0;t<this.statNames.length;t++)this.values[t]=r(this.statNames[t],this.app.stats)*this.multiplier}))}get timings(){return this.values}}
/**
 * @license
 * PlayCanvas Engine v1.64.4 revision 7fc5c5c22
 * Copyright 2011-2023 PlayCanvas Ltd. All rights reserved.
 */class tM{constructor(t,e,s,i,n){this.name=t,this.device=e.graphicsDevice,this.timer=n,this.watermark=s,this.enabled=!1,this.textRefreshRate=i,this.avgTotal=0,this.avgTimer=0,this.avgCount=0,this.timingText="",this.texture=null,this.yOffset=0,this.cursor=0,this.sample=new Uint8ClampedArray(4),this.sample.set([0,0,0,255]),e.on("frameupdate",this.update.bind(this)),this.counter=0}loseContext(){this.timer&&"function"==typeof this.timer.loseContext&&this.timer.loseContext()}update(t){const e=this.timer.timings,s=e.reduce(((t,e)=>t+e),0);if(this.avgTotal+=s,this.avgTimer+=t,this.avgCount++,this.avgTimer>this.textRefreshRate&&(this.timingText=(this.avgTotal/this.avgCount).toFixed(this.timer.decimalPlaces),this.avgTimer=0,this.avgTotal=0,this.avgCount=0),this.enabled){let t=0;const s=1.5*this.watermark;for(let i=0;i<e.length;++i)t+=Math.floor(e[i]/s*255),this.sample[i]=t;this.sample[3]=this.watermark/s*255;const i=this.device.gl;this.device.bindTexture(this.texture),i.texSubImage2D(i.TEXTURE_2D,0,this.cursor,this.yOffset,1,1,i.RGBA,i.UNSIGNED_BYTE,this.sample),this.cursor++,this.cursor===this.texture.width&&(this.cursor=0)}}render(t,e,s,i,n){t.quad(this.texture,e+i,s,-i,n,this.cursor,.5+this.yOffset,-i,0,this.enabled)}}
/**
 * @license
 * PlayCanvas Engine v1.64.4 revision 7fc5c5c22
 * Copyright 2011-2023 PlayCanvas Ltd. All rights reserved.
 */class eM{constructor(t,e){const s=document.createElement("canvas");s.width=t.width,s.height=t.height;const i=s.getContext("2d",{alpha:!0});i.font='10px "Lucida Console", Monaco, monospace',i.textAlign="left",i.textBaseline="alphabetic",i.fillStyle="rgb(255, 255, 255)";let n=5,r=5;const a=[];for(let t=0;t<e.length;++t){const o=i.measureText(e[t]),l=Math.ceil(-o.actualBoundingBoxLeft),h=Math.ceil(o.actualBoundingBoxRight),c=Math.ceil(o.actualBoundingBoxAscent),d=Math.ceil(o.actualBoundingBoxDescent),u=l+h,p=c+d;n+u>=s.width&&(n=5,r+=16),i.fillStyle=1===e[t].length?"rgb(255, 255, 255)":"rgb(150, 150, 150)",i.fillText(e[t],n-l,r+c),a.push({l:l,r:h,a:c,d:d,x:n,y:r,w:u,h:p}),n+=u+5}const o={};e.forEach(((t,e)=>{o[t]=e})),this.words=e,this.wordMap=o,this.placements=a,this.texture=t;const l=i.getImageData(0,0,s.width,s.height),h=t.lock();for(let e=0;e<l.height;++e)for(let s=0;s<l.width;++s){const i=4*(s+e*t.width);h[i]=255,h[i+1]=255,h[i+2]=255;const n=l.data[4*(s+(l.height-1-e)*l.width)],r=l.data[4*(s+(l.height-1-e)*l.width)+3];h[i+3]=r*(n>150?1:.7)}}render(t,e,s,i){const n=this.placements[this.wordMap[e]];if(n){const e=1;return t.quad(this.texture,s+n.l-e,i-n.d+e,n.w+2*e,n.h+2*e,n.x-e,64-n.y-n.h-e,void 0,void 0,!0),n.w}return 0}}
/**
 * @license
 * PlayCanvas Engine v1.64.4 revision 7fc5c5c22
 * Copyright 2011-2023 PlayCanvas Ltd. All rights reserved.
 */class sM{constructor(t,e,s=512){const i=new he(t,[{semantic:at,components:3,type:6},{semantic:pt,components:4,type:6}]),n=new Uint16Array(6*s);for(let t=0;t<s;++t)n[6*t+0]=4*t,n[6*t+1]=4*t+1,n[6*t+2]=4*t+2,n[6*t+3]=4*t,n[6*t+4]=4*t+2,n[6*t+5]=4*t+3;this.device=t,this.shader=Ei.createShaderFromCode(t,"attribute vec3 vertex_position;\nattribute vec4 vertex_texCoord0;\nuniform vec4 screenAndTextureSize;\nvarying vec4 uv0;\nvarying float enabled;\nvoid main(void) {\n    vec2 pos = vertex_position.xy / screenAndTextureSize.xy;\n    gl_Position = vec4(pos * 2.0 - 1.0, 0.5, 1.0);\n    uv0 = vec4(vertex_texCoord0.xy / screenAndTextureSize.zw, vertex_texCoord0.zw);\n    enabled = vertex_position.z;\n}\n","varying vec4 uv0;\nvarying float enabled;\nuniform vec4 clr;\nuniform vec4 col0;\nuniform vec4 col1;\nuniform vec4 col2;\nuniform vec4 watermark;\nuniform float watermarkSize;\nuniform vec4 background;\nuniform sampler2D source;\nvoid main (void) {\n    vec4 tex = texture2D(source, uv0.xy);\n    if (!(tex.rgb == vec3(1.0, 1.0, 1.0))) {\n       if (enabled < 0.5)\n           tex = background;\n       else if (abs(uv0.w - tex.a) < watermarkSize)\n           tex = watermark;\n       else if (uv0.w < tex.r)\n           tex = col0;\n       else if (uv0.w < tex.g)\n           tex = col1;\n       else if (uv0.w < tex.b)\n           tex = col2;\n       else\n           tex = background;\n    }\n    gl_FragColor = tex * clr;\n}\n","mini-stats"),this.buffer=new oe(t,i,4*s,2),this.data=new Float32Array(this.buffer.numBytes/4),this.indexBuffer=new _s(t,1,6*s,0,n),this.prims=[],this.prim=null,this.primIndex=-1,this.quads=0;const r=(e,s)=>{this[e]=new Float32Array([s.r,s.g,s.b,s.a]),this[e+"Id"]=t.scope.resolve(e)};r("col0",e.graph0),r("col1",e.graph1),r("col2",e.graph2),r("watermark",e.watermark),r("background",e.background),this.watermarkSizeId=t.scope.resolve("watermarkSize"),this.clrId=t.scope.resolve("clr"),this.clr=new Float32Array(4),this.screenTextureSizeId=t.scope.resolve("screenAndTextureSize"),this.screenTextureSize=new Float32Array(4),this.blendState=new Zt(!0,0,6,8,0,1,1)}quad(t,e,s,i,n,r,a,o,l,h){const c=this.quads++;let d=this.prim;d&&d.texture===t?d.count+=6:(this.primIndex++,this.primIndex===this.prims.length?(d={type:4,indexed:!0,base:6*c,count:6,texture:t},this.prims.push(d)):(d=this.prims[this.primIndex],d.base=6*c,d.count=6,d.texture=t),this.prim=d);const u=e+i,p=s+n,f=r+(void 0===o?i:o),m=a+(void 0===l?n:l),g=h?1:0;this.data.set([e,s,g,r,a,0,0,u,s,g,f,a,1,0,u,p,g,f,m,1,1,e,p,g,r,m,0,1],28*c)}render(t,e){const s=this.device,i=this.buffer;i.setData(this.data.buffer),s.updateBegin(),s.setCullMode(tt),s.setBlendState(this.blendState),s.setDepthState(te.NODEPTH),s.setStencilState(null,null),s.setVertexBuffer(i,0),s.setIndexBuffer(this.indexBuffer),s.setShader(this.shader),this.clr.set(t,0),this.clrId.setValue(this.clr),this.screenTextureSize[0]=s.canvas.scrollWidth,this.screenTextureSize[1]=s.canvas.scrollHeight,this.col0Id.setValue(this.col0),this.col1Id.setValue(this.col1),this.col2Id.setValue(this.col2),this.watermarkId.setValue(this.watermark),this.backgroundId.setValue(this.background);for(let t=0;t<=this.primIndex;++t){const i=this.prims[t];this.screenTextureSize[2]=i.texture.width,this.screenTextureSize[3]=i.texture.height,this.screenTextureSizeId.setValue(this.screenTextureSize),s.constantTexSource.setValue(i.texture),this.watermarkSizeId.setValue(.5/e),s.draw(i)}s.updateEnd(),this.prim=null,this.primIndex=-1,this.quads=0}}
/**
 * @license
 * PlayCanvas Engine v1.64.4 revision 7fc5c5c22
 * Copyright 2011-2023 PlayCanvas Ltd. All rights reserved.
 */class iM{constructor(t,e){const s=t.graphicsDevice;this._contextLostHandler=t=>{if(t.preventDefault(),this.graphs)for(let t=0;t<this.graphs.length;t++)this.graphs[t].loseContext()},s.canvas.addEventListener("webglcontextlost",this._contextLostHandler,!1),e=e||iM.getDefaultOptions();const i=this.initGraphs(t,s,e);let n=["","ms","0","1","2","3","4","5","6","7","8","9","."];i.forEach((t=>{n.push(t.name)})),e.stats&&e.stats.forEach((t=>{t.unitsName&&n.push(t.unitsName)})),n=n.filter(((t,e)=>n.indexOf(t)>=e));const r=e.sizes.reduce(((t,e)=>e.width>t?e.width:t),0),a=this.initWordAtlas(s,n,r,i.length),o=a.texture;i.forEach(((t,e)=>{t.texture=o,t.yOffset=e})),this.sizes=e.sizes,this._activeSizeIndex=e.startSizeIndex;const l=document.createElement("div");l.style.cssText="position:fixed;bottom:0;left:0;background:transparent;",document.body.appendChild(l),l.addEventListener("mouseenter",(t=>{this.opacity=1})),l.addEventListener("mouseleave",(t=>{this.opacity=.5})),l.addEventListener("click",(t=>{t.preventDefault(),this._enabled&&(this.activeSizeIndex=(this.activeSizeIndex+1)%this.sizes.length,this.resize(this.sizes[this.activeSizeIndex].width,this.sizes[this.activeSizeIndex].height,this.sizes[this.activeSizeIndex].graphs))})),s.on("resizecanvas",(()=>{this.updateDiv()})),t.on("postrender",(()=>{this._enabled&&this.render()})),this.device=s,this.texture=o,this.wordAtlas=a.atlas,this.render2d=new sM(s,e.colors),this.graphs=i,this.div=l,this.width=0,this.height=0,this.gspacing=2,this.clr=[1,1,1,.5],this._enabled=!0,this.activeSizeIndex=this._activeSizeIndex}static getDefaultOptions(){return{sizes:[{width:100,height:16,spacing:0,graphs:!1},{width:128,height:32,spacing:2,graphs:!0},{width:256,height:64,spacing:2,graphs:!0}],startSizeIndex:0,textRefreshRate:500,colors:{graph0:new D(.7,.2,.2,1),graph1:new D(.2,.7,.2,1),graph2:new D(.2,.2,.7,1),watermark:new D(.4,.4,.2,1),background:new D(0,0,0,1)},cpu:{enabled:!0,watermark:33},gpu:{enabled:!0,watermark:33},stats:[{name:"Frame",stats:["frame.ms"],decimalPlaces:1,unitsName:"ms",watermark:33},{name:"DrawCalls",stats:["drawCalls.total"],watermark:1e3}]}}set activeSizeIndex(t){this._activeSizeIndex=t,this.gspacing=this.sizes[t].spacing,this.resize(this.sizes[t].width,this.sizes[t].height,this.sizes[t].graphs)}get activeSizeIndex(){return this._activeSizeIndex}set opacity(t){this.clr[3]=t}get opacity(){return this.clr[3]}get overallHeight(){const t=this.graphs,e=this.gspacing;return this.height*t.length+e*(t.length-1)}set enabled(t){if(t!==this._enabled){this._enabled=t;for(let e=0;e<this.graphs.length;++e)this.graphs[e].enabled=t,this.graphs[e].timer.enabled=t}}get enabled(){return this._enabled}initWordAtlas(t,e,s,i){const n=new Ue(t,{name:"mini-stats",width:k.nextPowerOfTwo(s),height:64,mipmaps:!1,minFilter:0,magFilter:0}),r=new eM(n,e),a=n.lock();for(let t=0;t<n.width*i;++t)a.set([0,0,0,255],4*t);return n.unlock(),t.setTexture(n,0),{atlas:r,texture:n}}initGraphs(t,e,s){const i=[];if(s.cpu.enabled){const e=new QP(t),n=new tM("CPU",t,s.cpu.watermark,s.textRefreshRate,e);i.push(n)}if(s.gpu.enabled&&e.extDisjointTimerQuery){const e=new JP(t),n=new tM("GPU",t,s.gpu.watermark,s.textRefreshRate,e);i.push(n)}return s.stats&&s.stats.forEach((e=>{const n=new ZP(t,e.stats,e.decimalPlaces,e.unitsName,e.multiplier),r=new tM(e.name,t,e.watermark,s.textRefreshRate,n);i.push(r)})),i}render(){const t=this.graphs,e=this.wordAtlas,s=this.render2d,i=this.width,n=this.height,r=this.gspacing;for(let a=0;a<t.length;++a){const o=t[a];let l=a*(n+r);o.render(s,0,l,i,n);let h=1;l+=n-13,h+=e.render(s,o.name,h,l)+10;const c=o.timingText;for(let t=0;t<c.length;++t)h+=e.render(s,c[t],h,l);o.timer.unitsName&&(h+=3,e.render(s,o.timer.unitsName,h,l))}s.render(this.clr,n)}resize(t,e,s){const i=this.graphs;for(let t=0;t<i.length;++t)i[t].enabled=s;this.width=t,this.height=e,this.updateDiv()}updateDiv(){const t=this.device.canvas.getBoundingClientRect();this.div.style.left=t.left+"px",this.div.style.bottom=window.innerHeight-t.bottom+"px",this.div.style.width=this.width+"px",this.div.style.height=this.overallHeight+"px"}}
/**
 * @license
 * PlayCanvas Engine v1.64.4 revision 7fc5c5c22
 * Copyright 2011-2023 PlayCanvas Ltd. All rights reserved.
 */class nM{textureToCanvas(t,e={}){const s=t.getSource();if("undefined"!=typeof HTMLImageElement&&s instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&s instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&s instanceof OffscreenCanvas||"undefined"!=typeof ImageBitmap&&s instanceof ImageBitmap){const{width:t,height:i}=this.calcTextureSize(s.width,s.height,e.maxTextureSize),n=document.createElement("canvas");n.width=t,n.height=i;const r=n.getContext("2d");if(r.drawImage(s,0,0,n.width,n.height),e.color){const{r:s,g:n,b:a}=e.color,o=r.getImageData(0,0,t,i),l=o.data;for(let t=0;t<l.length;t+=4)l[t+0]=l[t+0]*s,l[t+1]=l[t+1]*n,l[t+2]=l[t+2]*a;r.putImageData(o,0,0)}return Promise.resolve(n)}const i=t.device,{width:n,height:r}=this.calcTextureSize(t.width,t.height,e.maxTextureSize),a=new Ue(i,{name:"ExtractedTexture",width:n,height:r,format:7,cubemap:!1,mipmaps:!1,minFilter:1,magFilter:1,addressU:1,addressV:1}),o=new pe({colorBuffer:a,depth:!1}),l=Ai(i,"\n\t\tattribute vec2 vertex_position;\n\t\tvarying vec2 uv0;\n\t\tvoid main(void) {\n\t\t\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\t\t\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n\t\t}","\n\t\tvarying vec2 uv0;\n\t\tuniform sampler2D blitTexture;\n\t\tvoid main(void) {\n\t\t\t\tgl_FragColor = texture2D(blitTexture, uv0);\n\t\t}","ShaderCoreExporterBlit");i.scope.resolve("blitTexture").setValue(t),i.setBlendState(Zt.NOBLEND),Fi(i,o,l);const h=new Uint8ClampedArray(n*r*4);i.readPixels(0,0,n,r,h),a.destroy(),o.destroy();const c=new ImageData(h,n,r),d=document.createElement("canvas");d.width=n,d.height=r;return d.getContext("2d").putImageData(c,0,0),Promise.resolve(d)}calcTextureSize(t,e,s){if(s){const i=Math.min(s/Math.max(t,e),1);t=Math.round(t*i),e=Math.round(e*i)}return{width:t,height:e}}}var rM=Uint8Array,aM=Uint16Array,oM=Int32Array,lM=new rM([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),hM=new rM([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),cM=new rM([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),dM=function(t,e){for(var s=new aM(31),i=0;i<31;++i)s[i]=e+=1<<t[i-1];var n=new oM(s[30]);for(i=1;i<30;++i)for(var r=s[i];r<s[i+1];++r)n[r]=r-s[i]<<5|i;return{b:s,r:n}},uM=dM(lM,2),pM=uM.b,fM=uM.r;pM[28]=258,fM[258]=28;for(var mM=dM(hM,0).r,gM=new aM(32768),_M=0;_M<32768;++_M){var vM=(43690&_M)>>1|(21845&_M)<<1;vM=(61680&(vM=(52428&vM)>>2|(13107&vM)<<2))>>4|(3855&vM)<<4,gM[_M]=((65280&vM)>>8|(255&vM)<<8)>>1}var bM=function(t,e,s){for(var i=t.length,n=0,r=new aM(e);n<i;++n)t[n]&&++r[t[n]-1];var a,o=new aM(e);for(n=1;n<e;++n)o[n]=o[n-1]+r[n-1]<<1;if(s){a=new aM(1<<e);var l=15-e;for(n=0;n<i;++n)if(t[n])for(var h=n<<4|t[n],c=e-t[n],d=o[t[n]-1]++<<c,u=d|(1<<c)-1;d<=u;++d)a[gM[d]>>l]=h}else for(a=new aM(i),n=0;n<i;++n)t[n]&&(a[n]=gM[o[t[n]-1]++]>>15-t[n]);return a},yM=new rM(288);for(_M=0;_M<144;++_M)yM[_M]=8;for(_M=144;_M<256;++_M)yM[_M]=9;for(_M=256;_M<280;++_M)yM[_M]=7;for(_M=280;_M<288;++_M)yM[_M]=8;var xM=new rM(32);for(_M=0;_M<32;++_M)xM[_M]=5;var wM=bM(yM,9,0),SM=bM(xM,5,0),CM=function(t){return(t+7)/8|0},TM=function(t,e,s){(null==e||e<0)&&(e=0),(null==s||s>t.length)&&(s=t.length);var i=new rM(s-e);return i.set(t.subarray(e,s)),i},EM=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],PM=function(t,e,s){var i=new Error(e||EM[t]);if(i.code=t,Error.captureStackTrace&&Error.captureStackTrace(i,PM),!s)throw i;return i},MM=function(t,e,s){s<<=7&e;var i=e/8|0;t[i]|=s,t[i+1]|=s>>8},AM=function(t,e,s){s<<=7&e;var i=e/8|0;t[i]|=s,t[i+1]|=s>>8,t[i+2]|=s>>16},kM=function(t,e){for(var s=[],i=0;i<t.length;++i)t[i]&&s.push({s:i,f:t[i]});var n=s.length,r=s.slice();if(!n)return{t:BM,l:0};if(1==n){var a=new rM(s[0].s+1);return a[s[0].s]=1,{t:a,l:1}}s.sort((function(t,e){return t.f-e.f})),s.push({s:-1,f:25001});var o=s[0],l=s[1],h=0,c=1,d=2;for(s[0]={s:-1,f:o.f+l.f,l:o,r:l};c!=n-1;)o=s[s[h].f<s[d].f?h++:d++],l=s[h!=c&&s[h].f<s[d].f?h++:d++],s[c++]={s:-1,f:o.f+l.f,l:o,r:l};var u=r[0].s;for(i=1;i<n;++i)r[i].s>u&&(u=r[i].s);var p=new aM(u+1),f=DM(s[c-1],p,0);if(f>e){i=0;var m=0,g=f-e,_=1<<g;for(r.sort((function(t,e){return p[e.s]-p[t.s]||t.f-e.f}));i<n;++i){var v=r[i].s;if(!(p[v]>e))break;m+=_-(1<<f-p[v]),p[v]=e}for(m>>=g;m>0;){var b=r[i].s;p[b]<e?m-=1<<e-p[b]++-1:++i}for(;i>=0&&m;--i){var y=r[i].s;p[y]==e&&(--p[y],++m)}f=e}return{t:new rM(p),l:f}},DM=function(t,e,s){return-1==t.s?Math.max(DM(t.l,e,s+1),DM(t.r,e,s+1)):e[t.s]=s},RM=function(t){for(var e=t.length;e&&!t[--e];);for(var s=new aM(++e),i=0,n=t[0],r=1,a=function(t){s[i++]=t},o=1;o<=e;++o)if(t[o]==n&&o!=e)++r;else{if(!n&&r>2){for(;r>138;r-=138)a(32754);r>2&&(a(r>10?r-11<<5|28690:r-3<<5|12305),r=0)}else if(r>3){for(a(n),--r;r>6;r-=6)a(8304);r>2&&(a(r-3<<5|8208),r=0)}for(;r--;)a(n);r=1,n=t[o]}return{c:s.subarray(0,i),n:e}},LM=function(t,e){for(var s=0,i=0;i<e.length;++i)s+=t[i]*e[i];return s},IM=function(t,e,s){var i=s.length,n=CM(e+2);t[n]=255&i,t[n+1]=i>>8,t[n+2]=255^t[n],t[n+3]=255^t[n+1];for(var r=0;r<i;++r)t[n+r+4]=s[r];return 8*(n+4+i)},OM=function(t,e,s,i,n,r,a,o,l,h,c){MM(e,c++,s),++n[256];for(var d=kM(n,15),u=d.t,p=d.l,f=kM(r,15),m=f.t,g=f.l,_=RM(u),v=_.c,b=_.n,y=RM(m),x=y.c,w=y.n,S=new aM(19),C=0;C<v.length;++C)++S[31&v[C]];for(C=0;C<x.length;++C)++S[31&x[C]];for(var T=kM(S,7),E=T.t,P=T.l,M=19;M>4&&!E[cM[M-1]];--M);var A,k,D,R,L=h+5<<3,I=LM(n,yM)+LM(r,xM)+a,O=LM(n,u)+LM(r,m)+a+14+3*M+LM(S,E)+2*S[16]+3*S[17]+7*S[18];if(l>=0&&L<=I&&L<=O)return IM(e,c,t.subarray(l,l+h));if(MM(e,c,1+(O<I)),c+=2,O<I){A=bM(u,p,0),k=u,D=bM(m,g,0),R=m;var F=bM(E,P,0);MM(e,c,b-257),MM(e,c+5,w-1),MM(e,c+10,M-4),c+=14;for(C=0;C<M;++C)MM(e,c+3*C,E[cM[C]]);c+=3*M;for(var B=[v,x],z=0;z<2;++z){var N=B[z];for(C=0;C<N.length;++C){var U=31&N[C];MM(e,c,F[U]),c+=E[U],U>15&&(MM(e,c,N[C]>>5&127),c+=N[C]>>12)}}}else A=wM,k=yM,D=SM,R=xM;for(C=0;C<o;++C){var V=i[C];if(V>255){AM(e,c,A[(U=V>>18&31)+257]),c+=k[U+257],U>7&&(MM(e,c,V>>23&31),c+=lM[U]);var H=31&V;AM(e,c,D[H]),c+=R[H],H>3&&(AM(e,c,V>>5&8191),c+=hM[H])}else AM(e,c,A[V]),c+=k[V]}return AM(e,c,A[256]),c+k[256]},FM=new oM([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),BM=new rM(0),zM=function(){for(var t=new Int32Array(256),e=0;e<256;++e){for(var s=e,i=9;--i;)s=(1&s&&-306674912)^s>>>1;t[e]=s}return t}(),NM=function(){var t=-1;return{p:function(e){for(var s=t,i=0;i<e.length;++i)s=zM[255&s^e[i]]^s>>>8;t=s},d:function(){return~t}}},UM=function(t,e,s,i,n){if(!n&&(n={l:1},e.dictionary)){var r=e.dictionary.subarray(-32768),a=new rM(r.length+t.length);a.set(r),a.set(t,r.length),t=a,n.w=r.length}return function(t,e,s,i,n,r){var a=r.z||t.length,o=new rM(i+a+5*(1+Math.ceil(a/7e3))+n),l=o.subarray(i,o.length-n),h=r.l,c=7&(r.r||0);if(e){c&&(l[0]=r.r>>3);for(var d=FM[e-1],u=d>>13,p=8191&d,f=(1<<s)-1,m=r.p||new aM(32768),g=r.h||new aM(f+1),_=Math.ceil(s/3),v=2*_,b=function(e){return(t[e]^t[e+1]<<_^t[e+2]<<v)&f},y=new oM(25e3),x=new aM(288),w=new aM(32),S=0,C=0,T=r.i||0,E=0,P=r.w||0,M=0;T+2<a;++T){var A=b(T),k=32767&T,D=g[A];if(m[k]=D,g[A]=k,P<=T){var R=a-T;if((S>7e3||E>24576)&&(R>423||!h)){c=OM(t,l,0,y,x,w,C,E,M,T-M,c),E=S=C=0,M=T;for(var L=0;L<286;++L)x[L]=0;for(L=0;L<30;++L)w[L]=0}var I=2,O=0,F=p,B=k-D&32767;if(R>2&&A==b(T-B))for(var z=Math.min(u,R)-1,N=Math.min(32767,T),U=Math.min(258,R);B<=N&&--F&&k!=D;){if(t[T+I]==t[T+I-B]){for(var V=0;V<U&&t[T+V]==t[T+V-B];++V);if(V>I){if(I=V,O=B,V>z)break;var H=Math.min(B,V-2),G=0;for(L=0;L<H;++L){var W=T-B+L&32767,j=W-m[W]&32767;j>G&&(G=j,D=W)}}}B+=(k=D)-(D=m[k])&32767}if(O){y[E++]=268435456|fM[I]<<18|mM[O];var q=31&fM[I],X=31&mM[O];C+=lM[q]+hM[X],++x[257+q],++w[X],P=T+I,++S}else y[E++]=t[T],++x[t[T]]}}for(T=Math.max(T,P);T<a;++T)y[E++]=t[T],++x[t[T]];c=OM(t,l,h,y,x,w,C,E,M,T-M,c),h||(r.r=7&c|l[c/8|0]<<3,c-=7,r.h=g,r.p=m,r.i=T,r.w=P)}else{for(T=r.w||0;T<a+h;T+=65535){var $=T+65535;$>=a&&(l[c/8|0]=h,$=a),c=IM(l,c+1,t.subarray(T,$))}r.i=a}return TM(o,0,i+CM(c)+n)}(t,null==e.level?6:e.level,null==e.mem?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(t.length)))):12+e.mem,s,i,n)},VM=function(t,e){var s={};for(var i in t)s[i]=t[i];for(var i in e)s[i]=e[i];return s},HM=function(t,e,s){for(;s;++e)t[e]=s,s>>>=8};function GM(t,e){return UM(t,e||{},0,0)}var WM=function(t,e,s,i){for(var n in t){var r=t[n],a=e+n,o=i;Array.isArray(r)&&(o=VM(i,r[1]),r=r[0]),r instanceof rM?s[a]=[r,o]:(s[a+="/"]=[new rM(0),o],WM(r,a,s,i))}},jM="undefined"!=typeof TextEncoder&&new TextEncoder,qM="undefined"!=typeof TextDecoder&&new TextDecoder;try{qM.decode(BM,{stream:!0})}catch(t){}function XM(t,e){if(e){for(var s=new rM(t.length),i=0;i<t.length;++i)s[i]=t.charCodeAt(i);return s}if(jM)return jM.encode(t);var n=t.length,r=new rM(t.length+(t.length>>1)),a=0,o=function(t){r[a++]=t};for(i=0;i<n;++i){if(a+5>r.length){var l=new rM(a+8+(n-i<<1));l.set(r),r=l}var h=t.charCodeAt(i);h<128||e?o(h):h<2048?(o(192|h>>6),o(128|63&h)):h>55295&&h<57344?(o(240|(h=65536+(1047552&h)|1023&t.charCodeAt(++i))>>18),o(128|h>>12&63),o(128|h>>6&63),o(128|63&h)):(o(224|h>>12),o(128|h>>6&63),o(128|63&h))}return TM(r,0,a)}var $M=function(t){var e=0;if(t)for(var s in t){var i=t[s].length;i>65535&&PM(9),e+=i+4}return e},KM=function(t,e,s,i,n,r,a,o){var l=i.length,h=s.extra,c=o&&o.length,d=$M(h);HM(t,e,null!=a?33639248:67324752),e+=4,null!=a&&(t[e++]=20,t[e++]=s.os),t[e]=20,e+=2,t[e++]=s.flag<<1|(r<0&&8),t[e++]=n&&8,t[e++]=255&s.compression,t[e++]=s.compression>>8;var u=new Date(null==s.mtime?Date.now():s.mtime),p=u.getFullYear()-1980;if((p<0||p>119)&&PM(10),HM(t,e,p<<25|u.getMonth()+1<<21|u.getDate()<<16|u.getHours()<<11|u.getMinutes()<<5|u.getSeconds()>>1),e+=4,-1!=r&&(HM(t,e,s.crc),HM(t,e+4,r<0?-r-2:r),HM(t,e+8,s.size)),HM(t,e+12,l),HM(t,e+14,d),e+=16,null!=a&&(HM(t,e,c),HM(t,e+6,s.attrs),HM(t,e+10,a),e+=14),t.set(i,e),e+=l,d)for(var f in h){var m=h[f],g=m.length;HM(t,e,+f),HM(t,e+2,g),t.set(m,e+4),e+=4+g}return c&&(t.set(o,e),e+=c),e};function YM(t,e){e||(e={});var s={},i=[];WM(t,"",s,e);var n=0,r=0;for(var a in s){var o=s[a],l=o[0],h=o[1],c=0==h.level?0:8,d=(S=XM(a)).length,u=h.comment,p=u&&XM(u),f=p&&p.length,m=$M(h.extra);d>65535&&PM(11);var g=c?GM(l,h):l,_=g.length,v=NM();v.p(l),i.push(VM(h,{size:l.length,crc:v.d(),c:g,f:S,m:p,u:d!=a.length||p&&u.length!=f,o:n,compression:c})),n+=30+d+m+_,r+=76+2*(d+m)+(f||0)+_}for(var b=new rM(r+22),y=n,x=r-n,w=0;w<i.length;++w){var S=i[w];KM(b,S.o,S,S.f,S.u,S.c.length);var C=30+S.f.length+$M(S.extra);b.set(S.c,S.o+C),KM(b,n,S,S.f,S.u,S.c.length,S.o,S.m),n+=16+C+(S.m?S.m.length:0)}return function(t,e,s,i,n){HM(t,e,101010256),HM(t,e+8,s),HM(t,e+10,s),HM(t,e+12,i),HM(t,e+16,n)}(b,n,i.length,x,y),b}
/**
 * @license
 * PlayCanvas Engine v1.64.4 revision 7fc5c5c22
 * Copyright 2011-2023 PlayCanvas Ltd. All rights reserved.
 */const QM="root",JM=(t,e,s)=>`                    ${t} inputs:${e} = ${s}`;class ZM extends nM{constructor(...t){super(...t),this.meshMap=void 0,this.materialMap=void 0,this.materials=void 0,this.textureMap=void 0,this.nodeNames=void 0,this.files=void 0}init(){this.meshMap=new Map,this.textureMap=new Map,this.materialMap=new Map,this.materials=[],this.files={},this.nodeNames=new Set}done(){this.meshMap=null,this.textureMap=null,this.materialMap=null,this.materials=null,this.files=null,this.nodeNames=null}build(t,e={}){this.init(),this.addFile(null,QM);const s=[];if(t){t.findComponents("render").forEach((t=>{s.push(...t.meshInstances)}))}let i="";s.forEach((t=>{i+=this.buildMeshInstance(t)})),i+=`\ndef "Materials"\n{\n\t\t${this.materials.join("\n")}\n}\n`,this.addFile(null,QM,"",i);const n={maxTextureSize:e.maxTextureSize},r=Array.from(this.textureMap.keys()),a=[];for(let t=0;t<r.length;t++){const e="image/png",s=r[t],i=this.textureToCanvas(s,n).then((t=>t?new Promise((s=>t.toBlob(s,e,1))).then((t=>t.arrayBuffer())):(console.warn(`Export of texture ${s.name} is not currently supported.`),new Promise((t=>t(null))))));a.push(i)}const o=Promise.all(a).then((t=>{t.forEach(((t,e)=>{const s=r[e],i=this.getTextureFileIds(s);this.files[i.fileName]=new Uint8Array(t)})),this.alignFiles();const e=YM(this.files,{level:0});return this.done(),e}));return o}alignFiles(){let t=0;for(const e in this.files){const s=this.files[e];t+=34+e.length;const i=63&t;if(4!==i){const t=new Uint8Array(64-i);this.files[e]=[s,{extra:{12345:t}}]}t=s.length}}getFileIds(t,e,s,i="usda"){const n=(t?`${t}/`:"")+`${e}.${i}`;return{name:e,fileName:n,refName:`@./${n}@</${s}>`}}getTextureFileIds(t){return this.getFileIds("texture",`Texture_${t.id}`,"Texture","png")}addFile(t,e,s="",i=null){let n=null;i&&(n=XM(i='#usda 1.0\n(\n\t\tcustomLayerData = {\n\t\t\t\tstring creator = "PlayCanvas UsdzExporter"\n\t\t}\n\t\tmetersPerUnit = 1\n\t\tupAxis = "Y"\n)\n\n'+i));const r=this.getFileIds(t,e,s);return this.files[r.fileName]=n,r.refName}getMaterialRef(t){let e=this.materialMap.get(t);return e||(e=this.buildMaterial(t),this.materialMap.set(t,e)),e}getMeshRef(t){let e=this.meshMap.get(t);return e||(e=this.buildMesh(t),this.meshMap.set(t,e)),e}buildArray2(t){const e=[],s=t.length;for(let i=0;i<s;i+=2)e.push(`(${t[i]}, ${1-t[i+1]})`);return e.join(", ")}buildArray3(t){const e=[],s=t.length;for(let i=0;i<s;i+=3)e.push(`(${t[i]}, ${t[i+1]}, ${t[i+2]})`);return e.join(", ")}buildMat4(t){const e=t.data,s=[];for(let t=0;t<16;t+=4)s.push(`(${e[t]}, ${e[t+1]}, ${e[t+2]}, ${e[t+3]})`);return`( ${s.join(", ")} )`}buildMaterial(t){const e=`Material_${t.id}`,s=`/Materials/${e}`,i=t=>`<${s}${t}>`,n=[],r=[],a=(e,s,a,o,l,h=!1,c=!1)=>{const d=t[e];if(d){const h=this.getTextureFileIds(d);this.textureMap.set(d,h.refName);const u=t[e+"Channel"]||"rgb",p=i(`/${h.name}_${l}.outputs:${u}`);n.push(JM(a,`${o}.connect`,p));const f=t[e+"Tiling"],m=t[e+"Offset"],g=t[e+"Rotation"],_=1===t[e+"Uv"]?"st1":"st",v=c&&s?s:D.WHITE;r.push(((t,e,s,n,r,a,o,l)=>`\n\t\t\t\t\t\t\t\tdef Shader "Transform2d_${s}" (\n\t\t\t\t\t\t\t\t\t\tsdrMetadata = {\n\t\t\t\t\t\t\t\t\t\t\t\tstring role = "math"\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tuniform token info:id = "UsdTransform2d"\n\t\t\t\t\t\t\t\t\t\tfloat2 inputs:in.connect = ${i(`/uvReader_${n}.outputs:result`)}\n\t\t\t\t\t\t\t\t\t\tfloat inputs:rotation = ${o}\n\t\t\t\t\t\t\t\t\t\tfloat2 inputs:scale = (${r.x}, ${r.y})\n\t\t\t\t\t\t\t\t\t\tfloat2 inputs:translation = (${a.x}, ${a.y})\n\t\t\t\t\t\t\t\t\t\tfloat2 outputs:result\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tdef Shader "Texture_${t.id}_${s}"\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tuniform token info:id = "UsdUVTexture"\n\t\t\t\t\t\t\t\t\t\tasset inputs:file = @${e.fileName}@\n\t\t\t\t\t\t\t\t\t\tfloat2 inputs:st.connect = ${i(`/Transform2d_${s}.outputs:result`)}\n\t\t\t\t\t\t\t\t\t\ttoken inputs:wrapS = "repeat"\n\t\t\t\t\t\t\t\t\t\ttoken inputs:wrapT = "repeat"\n\t\t\t\t\t\t\t\t\t\tfloat4 inputs:scale = (${l.r}, ${l.g}, ${l.b}, ${l.a})\n\t\t\t\t\t\t\t\t\t\tfloat outputs:r\n\t\t\t\t\t\t\t\t\t\tfloat outputs:g\n\t\t\t\t\t\t\t\t\t\tfloat outputs:b\n\t\t\t\t\t\t\t\t\t\tfloat3 outputs:rgb\n\t\t\t\t\t\t\t\t\t\tfloat outputs:a\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t`)(d,h,l,_,f,m,g,v))}else if(s){const t="float"===a?`${s}`:`(${s.r}, ${s.g}, ${s.b})`;n.push(JM(a,o,t))}};a("diffuseMap",t.diffuse,"color3f","diffuseColor","diffuse",!1,!0),(t.transparent||t.alphaTest>0)&&a("opacityMap",t.opacity,"float","opacity","opacity",!0),a("normalMap",null,"normal3f","normal","normal"),a("emissiveMap",t.emissive,"color3f","emissiveColor","emissive",!1,!0),a("aoMap",null,"float","occlusion","occlusion"),a("metalnessMap",t.metalness,"float","metallic","metallic"),a("glossMap",t.gloss,"float","roughness","roughness");const o=`\n\t\t\t\t\t\tdef Material "${e}"\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tdef Shader "PreviewSurface"\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tuniform token info:id = "UsdPreviewSurface"\n${n.join("\n")}\n\t\t\t\t\t\t\t\t\t\tint inputs:useSpecularWorkflow = 0\n\t\t\t\t\t\t\t\t\t\ttoken outputs:surface\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\ttoken outputs:surface.connect = ${i("/PreviewSurface.outputs:surface")}\n\n\t\t\t\t\t\t\t\tdef Shader "uvReader_st"\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tuniform token info:id = "UsdPrimvarReader_float2"\n\t\t\t\t\t\t\t\t\t\ttoken inputs:varname = "st"\n\t\t\t\t\t\t\t\t\t\tfloat2 inputs:fallback = (0.0, 0.0)\n\t\t\t\t\t\t\t\t\t\tfloat2 outputs:result\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tdef Shader "uvReader_st1"\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tuniform token info:id = "UsdPrimvarReader_float2"\n\t\t\t\t\t\t\t\t\t\ttoken inputs:varname = "st1"\n\t\t\t\t\t\t\t\t\t\tfloat2 inputs:fallback = (0.0, 0.0)\n\t\t\t\t\t\t\t\t\t\tfloat2 outputs:result\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t${r.join("\n")}\n\t\t\t\t\t\t}\n\t\t\t\t`;return this.materials.push(o),i("")}buildMesh(t){let e=[];const s=[];let i=[],n=[],r=[];t.getVertexStream(at,e),t.getVertexStream(ot,i),t.getVertexStream(pt,n),t.getVertexStream(ft,r),t.getIndices(s);const a=s.length||e.length,o=Array(a/3).fill(3).join(", ");if(!s.length)for(let t=0;t<a;t++)s[t]=t;const l=e.length/3;i=i.length?i:Array(3*l).fill(0),n=n.length?n:Array(2*l).fill(0),r=r.length?r:Array(2*l).fill(0),e=this.buildArray3(e),i=this.buildArray3(i),n=this.buildArray2(n),r=this.buildArray2(r);const h=((t,e,s,i,n,r)=>`\ndef "Mesh"\n{\n\t\tdef Mesh "Mesh"\n\t\t{\n\t\t\t\tint[] faceVertexCounts = [${t}]\n\t\t\t\tint[] faceVertexIndices = [${e}]\n\t\t\t\tnormal3f[] normals = [${s}] (\n\t\t\t\t\t\tinterpolation = "vertex"\n\t\t\t\t)\n\t\t\t\tpoint3f[] points = [${i}]\n\t\t\t\ttexCoord2f[] primvars:st = [${n}] (\n\t\t\t\t\t\tinterpolation = "vertex"\n\t\t\t\t)\n\t\t\t\ttexCoord2f[] primvars:st1 = [${r}] (\n\t\t\t\t\t\tinterpolation = "vertex"\n\t\t\t\t)\n\t\t\t\tuniform token subdivisionScheme = "none"\n\t\t}\n}\n`)(o,s,i,e,n,r);return this.addFile("mesh",`Mesh_${t.id}`,"Mesh",h)}buildMeshInstance(t){const e=this.getMeshRef(t.mesh),s=this.getMaterialRef(t.material),i=this.buildMat4(t.node.getWorldTransform()),n=t.node.name.replace(/[^a-z0-9]/gi,"_");let r=n;for(;this.nodeNames.has(r);)r=`${n}_${Math.random().toString(36).slice(2,7)}`;return this.nodeNames.add(r),((t,e,s,i)=>`\ndef Xform "${t}" (\n\t\tprepend references = ${e}\n)\n{\n\t\tmatrix4d xformOp:transform = ${s}\n\t\tuniform token[] xformOpOrder = ["xformOp:transform"]\n\n\t\trel material:binding = ${i}\n}\n`)(r,e,i,s)}}const tA=t=>lp.createElement(lp.Fragment,null,lp.createElement(qP,{setProperty:t.setProperty,observerData:t.observerData}),lp.createElement(XP,{setProperty:t.setProperty,skyboxData:t.observerData.skybox,uiData:t.observerData.ui}),lp.createElement($P,{setProperty:t.setProperty,lightData:t.observerData.light,uiData:t.observerData.ui,shadowCatcherData:t.observerData.shadowCatcher}),lp.createElement(KP,{setProperty:t.setProperty,debugData:t.observerData.debug,uiData:t.observerData.ui}),lp.createElement(YP,{setProperty:t.setProperty,sceneData:t.observerData.scene,uiData:t.observerData.ui}));class eA extends lp.Component{render(){let t;const e=e=>{this.props.setProperty("ui.active",this.props.observerData.ui.active===e?null:e),this.popupPanelElement||(this.popupPanelElement=document.getElementById("popup")),setTimeout((()=>{t&&t();t=xu(document.body,(e=>{this.popupPanelElement.contains(e.target)||(this.props.setProperty("ui.active",null),t(),t=null)}),4)}))},s=t=>this.props.observerData.ui.active===t?["popup-button","selected"]:["popup-button"];return lp.createElement("div",{id:"popup-buttons-parent"},lp.createElement(VP,{animationData:this.props.observerData.animation,setProperty:this.props.setProperty}),lp.createElement(xT,{class:s("camera"),icon:"E212",width:40,height:40,onClick:()=>e("camera")}),lp.createElement(xT,{class:s("skybox"),icon:"E200",width:40,height:40,onClick:()=>e("skybox")}),lp.createElement(xT,{class:s("light"),icon:"E194",width:40,height:40,onClick:()=>e("light")}),lp.createElement(xT,{class:s("debug"),icon:"E134",width:40,height:40,onClick:()=>e("debug")}),lp.createElement(xT,{class:s("view"),icon:"E301",width:40,height:40,onClick:()=>e("view")}))}}class sA extends lp.Component{get hasArSupport(){return this.props.observerData.xrSupported||this.usdzExporter}constructor(t){var e;super(t),this.link=document.getElementById("ar-link"),(this.link.relList.supports("ar")||Boolean(null===(e=window.webkit)||void 0===e?void 0:e.messageHandlers)&&Boolean(/CriOS\/|EdgiOS\/|FxiOS\/|GSA\/|DuckDuckGo\//.test(navigator.userAgent)))&&(this.usdzExporter=new ZM)}render(){return lp.createElement("div",{id:"popup",className:"[]"===this.props.observerData.scene.nodes?"empty":null},lp.createElement(tA,{observerData:this.props.observerData,setProperty:this.props.setProperty}),lp.createElement(eA,{observerData:this.props.observerData,setProperty:this.props.setProperty}),lp.createElement("div",{id:"floating-buttons-parent"},lp.createElement(xT,{class:"popup-button",icon:"E189",hidden:!this.hasArSupport||"[]"===this.props.observerData.scene.nodes,width:40,height:40,onClick:()=>{if(this.usdzExporter){const t=window.viewer.app.root.findByName("sceneRoot");this.usdzExporter.build(t).then((t=>{const e=new Blob([t],{type:"application/octet-stream"});this.link.href=URL.createObjectURL(e),this.link.click()})).catch(console.error)}else window.viewer&&window.viewer.xrMode.start()}}),lp.createElement(xT,{class:"popup-button",id:"fullscreen-button",icon:"E127",width:40,height:40,onClick:()=>{document.getElementById("panel-left").classList.toggle("collapsed")}})))}}var iA=sA;var nA=t=>{const[e,s]=op.useState(!1),i=op.useRef(null);return lp.createElement("div",{id:"load-controls"},lp.createElement(zT,{class:"load-button-panel",enabled:!0,flex:!0},lp.createElement("div",{className:"header"},lp.createElement("img",{src:yu("pluto-logo.png")}),lp.createElement("div",null,lp.createElement(gE,{text:"Pluto View: try https://getpluto.win/viewer/static/img/pluto.glb"})),lp.createElement(xT,{onClick:()=>{window.open("https://github.com/syonfox/pluto","_blank").focus()},icon:"E259"})),lp.createElement("input",{type:"file",id:"file",multiple:!0,onChange:t=>{const e=window.viewer,s=t.target.files;if(e&&s.length){const t=[];for(let e=0;e<s.length;++e){const i=s[e];t.push({url:URL.createObjectURL(i),filename:i.name})}e.loadFiles(t)}},ref:i,style:{display:"none"}}),lp.createElement("div",{id:"drag-drop",onClick:()=>{i.current.click()}},lp.createElement(xT,{id:"drag-drop-search-icon",icon:"E129"}),lp.createElement(gE,{class:"desktop",text:"Drag & drop your files or click to open files"}),lp.createElement(gE,{class:"mobile",text:"Click to open files"})),lp.createElement(gE,{id:"or-text",text:"OR",class:"centered-label"}),lp.createElement(zE,{class:"secondary",id:"glb-url-input",placeholder:"enter url",keyChange:!0,onValidate:t=>{const e=(t=>{try{return new URL(t),!0}catch(t){return!1}})(t);return s(e),e}}),lp.createElement(xT,{class:"secondary",id:"glb-url-button",text:"LOAD MODEL FROM URL",onClick:()=>{const t=window.viewer,e=document.getElementById("glb-url-input").ui.value,s=new URL(e).pathname.split("/").pop(),i=!!s.split(".").splice(1).pop();t.loadFiles([{url:e,filename:s+(i?"":".glb")}])},enabled:e})))};var rA=t=>lp.createElement(fE,{class:"pcui-error",title:"Error",hidden:!t.observerData.error,text:t.observerData.error,icon:"E218"});let aA=class extends lp.Component{constructor(t){super(t),this._retrieveState=()=>{const t={};return this.props.observer._keys.forEach((e=>{t[e]=this.props.observer.get(e)})),t},this._setStateProperty=(t,e)=>{this.props.observer.set(t,e)},this.canvasRef=lp.createRef(),this.state=this._retrieveState(),t.observer.on("*:set",(()=>{this.setState(this._retrieveState())}))}render(){return lp.createElement("div",{id:"application-container"},lp.createElement(zT,{id:"panel-left",flex:!0,resizable:"right",resizeMin:220,resizeMax:800},lp.createElement("div",{className:"header",style:{display:"none"}},lp.createElement("div",{id:"title"},lp.createElement("img",{src:yu("pluto-logo.png")}),lp.createElement("div",null,"Pluto Viewer"))),lp.createElement("div",{id:"panel-toggle"},lp.createElement("img",{src:yu("pluto-logo.png")})),lp.createElement(OP,{observerData:this.state,setProperty:this._setStateProperty})),lp.createElement("div",{id:"canvas-wrapper"},lp.createElement("canvas",{id:"application-canvas",ref:this.canvasRef}),lp.createElement(nA,{setProperty:this._setStateProperty}),lp.createElement(BP,{sceneData:this.state.scene}),lp.createElement(iA,{observerData:this.state,setProperty:this._setStateProperty}),lp.createElement(rA,{observerData:this.state}),lp.createElement(FE,{id:"spinner",size:30,hidden:!0})))}};function oA(t,e,s,i){return new(s||(s=Promise))((function(n,r){function a(t){try{l(i.next(t))}catch(t){r(t)}}function o(t){try{l(i.throw(t))}catch(t){r(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(a,o)}l((i=i.apply(t,e||[])).next())}))}class lA extends Rl{constructor(t,e){super(t);const s=new Ol;s.graphicsDevice=this.createDevice(t,e),this.addComponentSystems(s),this.addResourceHandles(s),s.elementInput=e.elementInput,s.keyboard=e.keyboard,s.mouse=e.mouse,s.touch=e.touch,s.gamepads=e.gamepads,s.scriptPrefix=e.scriptPrefix,s.assetPrefix=e.assetPrefix,s.scriptsOrder=e.scriptsOrder,s.lightmapper=jl,s.xr=mu,this.init(s)}createDevice(t,e){return e.graphicsDeviceOptions||(e.graphicsDeviceOptions={}),w.browser&&navigator.xr&&(e.graphicsDeviceOptions.xrCompatible=!0),e.graphicsDeviceOptions.alpha=e.graphicsDeviceOptions.alpha||!1,new ms(t,e.graphicsDeviceOptions)}addComponentSystems(t){t.componentSystems=[Fh,jh,Qh,ic]}addResourceHandles(t){t.resourceHandlers=[lc,sd,id,Od,ld,nd,od]}}var hA=function(){var t=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),e=new Uint8Array([32,0,65,2,1,106,34,33,3,128,11,4,13,64,6,253,10,7,15,116,127,5,8,12,40,16,19,54,20,9,27,255,113,17,42,67,24,23,146,148,18,14,22,45,70,69,56,114,101,21,25,63,75,136,108,28,118,29,73,115]);if("object"!=typeof WebAssembly)return{supported:!1};var s,i=WebAssembly.validate(t)?"b9H79TebbbeKl9Gbb9Gvuuuuueu9Giuuub9Geueuikqbbebeedddilve9Weeeviebeoweuec:q;Aekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbdY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVblE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtboK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbrL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbwl79IV9RbDq;t9tqlbzik9:evu8Jjjjjbcz9Rhbcbheincbhdcbhiinabcwfadfaicjuaead4ceGglE86bbaialfhiadcefgdcw9hmbkaec:q:yjjbfai86bbaecitc:q1jjbfab8Piw83ibaecefgecjd9hmbkk;h8JlHud97euo978Jjjjjbcj;kb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Rad;8qbbcj;abad9UhoaicefhldnadTmbaoc;WFbGgocjdaocjd6EhwcbhDinaDae9pmeawaeaD9RaDawfae6Egqcsfgoc9WGgkci2hxakcethmaocl4cifcd4hPabaDad2fhscbhzdnincehHalhOcbhAdninaraO9RaP6miavcj;cbfaAak2fhCaOaPfhlcbhidnakc;ab6mbaral9Rc;Gb6mbcbhoinaCaofhidndndndndnaOaoco4fRbbgXciGPlbedibkaipxbbbbbbbbbbbbbbbbpklbxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklbalczfhlkdndndndndnaXcd4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklzxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklzalczfhlkdndndndndnaXcl4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklaxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklaalczfhlkdndndndndnaXco4Plbedibkaipxbbbbbbbbbbbbbbbbpkl8WxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalclfaYpQbfaXc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalcwfaYpQbfaXc:q:yjjbfRbbfhlxekaialpbbbpkl8Walczfhlkaoc;abfhiaocjefak0meaihoaral9Rc;Fb0mbkkdndnaiak9pmbaici4hoinaral9RcK6mdaCaifhXdndndndndnaOaico4fRbbaocoG4ciGPlbedibkaXpxbbbbbbbbbbbbbbbbpklbxikaXalpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaXalpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaXalpbbbpklbalczfhlkaocdfhoaiczfgiak6mbkkalTmbaAci6hHalhOaAcefgohAaoclSmdxekkcbhlaHceGmdkdnakTmbavcjdfazfhiavazfpbdbhYcbhXinaiavcj;cbfaXfgopblbgLcep9TaLpxeeeeeeeeeeeeeeeegQp9op9Hp9rgLaoakfpblbg8Acep9Ta8AaQp9op9Hp9rg8ApmbzeHdOiAlCvXoQrLgEaoamfpblbg3cep9Ta3aQp9op9Hp9rg3aoaxfpblbg5cep9Ta5aQp9op9Hp9rg5pmbzeHdOiAlCvXoQrLg8EpmbezHdiOAlvCXorQLgQaQpmbedibedibedibediaYp9UgYp9AdbbaiadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaEa8EpmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwKDYq8AkEx3m5P8Es8FgLa3a5pmwKDYq8AkEx3m5P8Es8Fg8ApmbezHdiOAlvCXorQLgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfhiaXczfgXak6mbkkazclfgzad6mbkasavcjdfaqad2;8qbbavavcjdfaqcufad2fad;8qbbaqaDfhDc9:hoalmexikkc9:hoxekcbc99aral9Radcaadca0ESEhokavcj;kbf8Kjjjjbaokwbz:bjjjbk;uzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecje;8kbavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhDcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgrc;Ve0mbavc;abfalarcl4cu7fcsGcitfgPydlhsaPydbhzdnarcsGgPak9pmbavaiarcu7fcsGcdtfydbaxaPEhraPThPdndnadcd9hmbabaDcetfgHaz87ebaHcdfas87ebaHclfar87ebxekabaDcdtfgHazBdbaHclfasBdbaHcwfarBdbkaxaPfhxavc;abfalcitfgHarBdbaHasBdlavaicdtfarBdbavc;abfalcefcsGglcitfgHazBdbaHarBdlaiaPfhialcefhlxdkdndnaPcsSmbamaPfaPc987fcefhmxekaocefhrao8SbbgPcFeGhHdndnaPcu9mmbarhoxekaocvfhoaHcFbGhHcrhPdninar8SbbgOcFbGaPtaHVhHaOcu9kmearcefhraPcrfgPc8J9hmbxdkkarcefhokaHce4cbaHceG9R7amfhmkdndnadcd9hmbabaDcetfgraz87ebarcdfas87ebarclfam87ebxekabaDcdtfgrazBdbarclfasBdbarcwfamBdbkavc;abfalcitfgramBdbarasBdlavaicdtfamBdbavc;abfalcefcsGglcitfgrazBdbaramBdlaicefhialcefhlxekdnarcpe0mbaxcefgOavaiaqarcsGfRbbgPcl49RcsGcdtfydbaPcz6gHEhravaiaP9RcsGcdtfydbaOaHfgsaPcsGgOEhPaOThOdndnadcd9hmbabaDcetfgzax87ebazcdfar87ebazclfaP87ebxekabaDcdtfgzaxBdbazclfarBdbazcwfaPBdbkavaicdtfaxBdbavc;abfalcitfgzarBdbazaxBdlavaicefgicsGcdtfarBdbavc;abfalcefcsGcitfgzaPBdbazarBdlavaiaHfcsGgicdtfaPBdbavc;abfalcdfcsGglcitfgraxBdbaraPBdlalcefhlaiaOfhiasaOfhxxekaxcbaoRbbgzEgAarc;:eSgrfhsazcsGhCazcl4hXdndnazcs0mbascefhOxekashOavaiaX9RcsGcdtfydbhskdndnaCmbaOcefhxxekaOhxavaiaz9RcsGcdtfydbhOkdndnarTmbaocefhrxekaocdfhrao8SbegHcFeGhPdnaHcu9kmbaocofhAaPcFbGhPcrhodninar8SbbgHcFbGaotaPVhPaHcu9kmearcefhraocrfgoc8J9hmbkaAhrxekarcefhrkaPce4cbaPceG9R7amfgmhAkdndnaXcsSmbarhPxekarcefhPar8SbbgocFeGhHdnaocu9kmbarcvfhsaHcFbGhHcrhodninaP8SbbgrcFbGaotaHVhHarcu9kmeaPcefhPaocrfgoc8J9hmbkashPxekaPcefhPkaHce4cbaHceG9R7amfgmhskdndnaCcsSmbaPhoxekaPcefhoaP8SbbgrcFeGhHdnarcu9kmbaPcvfhOaHcFbGhHcrhrdninao8SbbgPcFbGartaHVhHaPcu9kmeaocefhoarcrfgrc8J9hmbkaOhoxekaocefhokaHce4cbaHceG9R7amfgmhOkdndnadcd9hmbabaDcetfgraA87ebarcdfas87ebarclfaO87ebxekabaDcdtfgraABdbarclfasBdbarcwfaOBdbkavc;abfalcitfgrasBdbaraABdlavaicdtfaABdbavc;abfalcefcsGcitfgraOBdbarasBdlavaicefgicsGcdtfasBdbavc;abfalcdfcsGcitfgraABdbaraOBdlavaiazcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiaDcifgDae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:llevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:EPliuo97eue978Jjjjjbca9Rhidndnadcl9hmbdnaec98GglTmbcbhvabhdinadadpbbbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpkbbadczfhdavclfgval6mbkkalae9pmeaiaeciGgvcdtgdVcbczad9R;8kbaiabalcdtfglad;8qbbdnavTmbaiaipblbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpklbkalaiad;8qbbskdnaec98GgxTmbcbhvabhdinadczfglalpbbbgopxbbbbbbFFbbbbbbFFgkp9oadpbbbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpkbbadaDakp9oawaopmbezHdiOAlvCXorQLp9qpkbbadcafhdavclfgvax6mbkkaxae9pmbaiaeciGgvcitgdfcbcaad9R;8kbaiabaxcitfglad;8qbbdnavTmbaiaipblzgopxbbbbbbFFbbbbbbFFgkp9oaipblbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpklzaiaDakp9oawaopmbezHdiOAlvCXorQLp9qpklbkalaiad;8qbbkk;4wllue97euv978Jjjjjbc8W9Rhidnaec98GglTmbcbhvabhoinaiaopbbbgraoczfgwpbbbgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklbaopxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblbpEb:T:j83ibaocwfarp5eaipblbpEe:T:j83ibawaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblbpEd:T:j83ibaocKfakp5eaipblbpEi:T:j83ibaocafhoavclfgval6mbkkdnalae9pmbaiaeciGgvcitgofcbcaao9R;8kbaiabalcitfgwao;8qbbdnavTmbaiaipblbgraipblzgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklaaipxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblapEb:T:j83ibaiarp5eaipblapEe:T:j83iwaiaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblapEd:T:j83izaiakp5eaipblapEi:T:j83iKkawaiao;8qbbkk:Pddiue978Jjjjjbc;ab9Rhidnadcd4ae2glc98GgvTmbcbhdabheinaeaepbbbgocwp:Recwp:Sep;6eaocep:SepxbbjZbbjZbbjZbbjZp:UepxbbjFbbjFbbjFbbjFp9op;Mepkbbaeczfheadclfgdav6mbkkdnaval9pmbaialciGgdcdtgeVcbc;abae9R;8kbaiabavcdtfgvae;8qbbdnadTmbaiaipblbgocwp:Recwp:Sep;6eaocep:SepxbbjZbbjZbbjZbbjZp:UepxbbjFbbjFbbjFbbjFp9op;Mepklbkavaiae;8qbbkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaikkkebcjwklz9Tbb":"b9H79Tebbbe8Fv9Gbb9Gvuuuuueu9Giuuub9Geueu9Giuuueuikqbeeedddillviebeoweuec:q;iekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbeY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVbdE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbiL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtblK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbol79IV9Rbrq:P8Yqdbk;3sezu8Jjjjjbcj;eb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Radz1jjjbhwcj;abad9UhoaicefhldnadTmbaoc;WFbGgocjdaocjd6EhDcbhqinaqae9pmeaDaeaq9RaqaDfae6Egkcsfgocl4cifcd4hxdndndndnaoc9WGgmTmbcbhPcehsawcjdfhzalhHinaraH9Rax6midnaraHaxfgl9RcK6mbczhoinawcj;cbfaogifgoc9WfhOdndndndndnaHaic9WfgAco4fRbbaAci4coG4ciGPlbedibkaO9cb83ibaOcwf9cb83ibxikaOalRblalRbbgAco4gCaCciSgCE86bbaocGfalclfaCfgORbbaAcl4ciGgCaCciSgCE86bbaocVfaOaCfgORbbaAcd4ciGgCaCciSgCE86bbaoc7faOaCfgORbbaAciGgAaAciSgAE86bbaoctfaOaAfgARbbalRbegOco4gCaCciSgCE86bbaoc91faAaCfgARbbaOcl4ciGgCaCciSgCE86bbaoc4faAaCfgARbbaOcd4ciGgCaCciSgCE86bbaoc93faAaCfgARbbaOciGgOaOciSgOE86bbaoc94faAaOfgARbbalRbdgOco4gCaCciSgCE86bbaoc95faAaCfgARbbaOcl4ciGgCaCciSgCE86bbaoc96faAaCfgARbbaOcd4ciGgCaCciSgCE86bbaoc97faAaCfgARbbaOciGgOaOciSgOE86bbaoc98faAaOfgORbbalRbiglco4gAaAciSgAE86bbaoc99faOaAfgORbbalcl4ciGgAaAciSgAE86bbaoc9:faOaAfgORbbalcd4ciGgAaAciSgAE86bbaocufaOaAfgoRbbalciGglalciSglE86bbaoalfhlxdkaOalRbwalRbbgAcl4gCaCcsSgCE86bbaocGfalcwfaCfgORbbaAcsGgAaAcsSgAE86bbaocVfaOaAfgORbbalRbegAcl4gCaCcsSgCE86bbaoc7faOaCfgORbbaAcsGgAaAcsSgAE86bbaoctfaOaAfgORbbalRbdgAcl4gCaCcsSgCE86bbaoc91faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc4faOaAfgORbbalRbigAcl4gCaCcsSgCE86bbaoc93faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc94faOaAfgORbbalRblgAcl4gCaCcsSgCE86bbaoc95faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc96faOaAfgORbbalRbvgAcl4gCaCcsSgCE86bbaoc97faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc98faOaAfgORbbalRbogAcl4gCaCcsSgCE86bbaoc99faOaCfgORbbaAcsGgAaAcsSgAE86bbaoc9:faOaAfgORbbalRbrglcl4gAaAcsSgAE86bbaocufaOaAfgoRbbalcsGglalcsSglE86bbaoalfhlxekaOal8Pbb83bbaOcwfalcwf8Pbb83bbalczfhlkdnaiam9pmbaiczfhoaral9RcL0mekkaiam6mialTmidnakTmbawaPfRbbhOcbhoazhiinaiawcj;cbfaofRbbgAce4cbaAceG9R7aOfgO86bbaiadfhiaocefgoak9hmbkkazcefhzaPcefgPad6hsalhHaPad9hmexvkkcbhlasceGmdxikalaxad2fhCdnakTmbcbhHcehsawcjdfhminaral9Rax6mialTmdalaxfhlawaHfRbbhOcbhoamhiinaiawcj;cbfaofRbbgAce4cbaAceG9R7aOfgO86bbaiadfhiaocefgoak9hmbkamcefhmaHcefgHad6hsaHad9hmbkaChlxikcbhocehsinaral9Rax6mdalTmealaxfhlaocefgoad6hsadao9hmbkaChlxdkcbhlasceGTmekc9:hoxikabaqad2fawcjdfakad2z1jjjb8Aawawcjdfakcufad2fadz1jjjb8Aakaqfhqalmbkc9:hoxekcbc99aral9Radcaadca0ESEhokavcj;ebf8Kjjjjbaok;yzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecjez:jjjjb8AavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhDcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgrc;Ve0mbavc;abfalarcl4cu7fcsGcitfgPydlhsaPydbhzdnarcsGgPak9pmbavaiarcu7fcsGcdtfydbaxaPEhraPThPdndnadcd9hmbabaDcetfgHaz87ebaHcdfas87ebaHclfar87ebxekabaDcdtfgHazBdbaHclfasBdbaHcwfarBdbkaxaPfhxavc;abfalcitfgHarBdbaHasBdlavaicdtfarBdbavc;abfalcefcsGglcitfgHazBdbaHarBdlaiaPfhialcefhlxdkdndnaPcsSmbamaPfaPc987fcefhmxekaocefhrao8SbbgPcFeGhHdndnaPcu9mmbarhoxekaocvfhoaHcFbGhHcrhPdninar8SbbgOcFbGaPtaHVhHaOcu9kmearcefhraPcrfgPc8J9hmbxdkkarcefhokaHce4cbaHceG9R7amfhmkdndnadcd9hmbabaDcetfgraz87ebarcdfas87ebarclfam87ebxekabaDcdtfgrazBdbarclfasBdbarcwfamBdbkavc;abfalcitfgramBdbarasBdlavaicdtfamBdbavc;abfalcefcsGglcitfgrazBdbaramBdlaicefhialcefhlxekdnarcpe0mbaxcefgOavaiaqarcsGfRbbgPcl49RcsGcdtfydbaPcz6gHEhravaiaP9RcsGcdtfydbaOaHfgsaPcsGgOEhPaOThOdndnadcd9hmbabaDcetfgzax87ebazcdfar87ebazclfaP87ebxekabaDcdtfgzaxBdbazclfarBdbazcwfaPBdbkavaicdtfaxBdbavc;abfalcitfgzarBdbazaxBdlavaicefgicsGcdtfarBdbavc;abfalcefcsGcitfgzaPBdbazarBdlavaiaHfcsGgicdtfaPBdbavc;abfalcdfcsGglcitfgraxBdbaraPBdlalcefhlaiaOfhiasaOfhxxekaxcbaoRbbgzEgAarc;:eSgrfhsazcsGhCazcl4hXdndnazcs0mbascefhOxekashOavaiaX9RcsGcdtfydbhskdndnaCmbaOcefhxxekaOhxavaiaz9RcsGcdtfydbhOkdndnarTmbaocefhrxekaocdfhrao8SbegHcFeGhPdnaHcu9kmbaocofhAaPcFbGhPcrhodninar8SbbgHcFbGaotaPVhPaHcu9kmearcefhraocrfgoc8J9hmbkaAhrxekarcefhrkaPce4cbaPceG9R7amfgmhAkdndnaXcsSmbarhPxekarcefhPar8SbbgocFeGhHdnaocu9kmbarcvfhsaHcFbGhHcrhodninaP8SbbgrcFbGaotaHVhHarcu9kmeaPcefhPaocrfgoc8J9hmbkashPxekaPcefhPkaHce4cbaHceG9R7amfgmhskdndnaCcsSmbaPhoxekaPcefhoaP8SbbgrcFeGhHdnarcu9kmbaPcvfhOaHcFbGhHcrhrdninao8SbbgPcFbGartaHVhHaPcu9kmeaocefhoarcrfgrc8J9hmbkaOhoxekaocefhokaHce4cbaHceG9R7amfgmhOkdndnadcd9hmbabaDcetfgraA87ebarcdfas87ebarclfaO87ebxekabaDcdtfgraABdbarclfasBdbarcwfaOBdbkavc;abfalcitfgrasBdbaraABdlavaicdtfaABdbavc;abfalcefcsGcitfgraOBdbarasBdlavaicefgicsGcdtfasBdbavc;abfalcdfcsGcitfgraABdbaraOBdlavaiazcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiaDcifgDae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:llevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaicd4cbaice4ceG9R7avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:Lvoeue99dud99eud99dndnadcl9hmbaeTmeindndnabcdfgd8Sbb:Yab8Sbbgi:Ygl:l:tabcefgv8Sbbgo:Ygr:l:tgwJbb;:9cawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai86bbdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad86bbdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad86bbabclfhbaecufgembxdkkaeTmbindndnabclfgd8Ueb:Yab8Uebgi:Ygl:l:tabcdfgv8Uebgo:Ygr:l:tgwJb;:FSawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai87ebdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad87ebdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad87ebabcwfhbaecufgembkkk;siliui99iue99dnaeTmbcbhiabhlindndnJ;Zl81Zalcof8UebgvciV:Y:vgoal8Ueb:YNgrJb;:FSNJbbbZJbbb:;arJbbbb9GEMgw:lJbbb9p9DTmbaw:OhDxekcjjjj94hDkalclf8Uebhqalcdf8UebhkabavcefciGaiVcetfaD87ebdndnaoak:YNgwJb;:FSNJbbbZJbbb:;awJbbbb9GEMgx:lJbbb9p9DTmbax:Ohkxekcjjjj94hkkabavcdfciGaiVcetfak87ebdndnaoaq:YNgoJb;:FSNJbbbZJbbb:;aoJbbbb9GEMgx:lJbbb9p9DTmbax:Ohqxekcjjjj94hqkabavcufciGaiVcetfaq87ebdndnJbbjZararN:tawawN:taoaoN:tgrJbbbbarJbbbb9GE:rJb;:FSNJbbbZMgr:lJbbb9p9DTmbar:Ohqxekcjjjj94hqkabavciGaiVcetfaq87ebalcwfhlaiclfhiaecufgembkkk9mbdnadcd4ae2geTmbinababydbgdcwtcw91:Yadce91cjjj;8ifcjjj98G::NUdbabclfhbaecufgembkkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaik;LeeeudndnaeabVciGTmbabhixekdndnadcz9pmbabhixekabhiinaiaeydbBdbaiclfaeclfydbBdbaicwfaecwfydbBdbaicxfaecxfydbBdbaiczfhiaeczfheadc9Wfgdcs0mbkkadcl6mbinaiaeydbBdbaeclfheaiclfhiadc98fgdci0mbkkdnadTmbinaiaeRbb86bbaicefhiaecefheadcufgdmbkkabk;aeedudndnabciGTmbabhixekaecFeGc:b:c:ew2hldndnadcz9pmbabhixekabhiinaialBdbaicxfalBdbaicwfalBdbaiclfalBdbaiczfhiadc9Wfgdcs0mbkkadcl6mbinaialBdbaiclfhiadc98fgdci0mbkkdnadTmbinaiae86bbaicefhiadcufgdmbkkabkkkebcjwklz9Kbb",n=WebAssembly.instantiate(r(i),{}).then((function(t){(s=t.instance).exports.__wasm_call_ctors()}));function r(t){for(var s=new Uint8Array(t.length),i=0;i<t.length;++i){var n=t.charCodeAt(i);s[i]=n>96?n-97:n>64?n-39:n+4}var r=0;for(i=0;i<t.length;++i)s[r++]=s[i]<60?e[s[i]]:64*(s[i]-60)+s[++i];return s.buffer.slice(0,r)}function a(t,e,i,n,r,a){var o=s.exports.sbrk,l=i+3&-4,h=o(l*n),c=o(r.length),d=new Uint8Array(s.exports.memory.buffer);d.set(r,c);var u=t(h,i,n,c,r.length);if(0==u&&a&&a(h,l,n),e.set(d.subarray(h,h+i*n)),o(h-o(0)),0!=u)throw new Error("Malformed buffer data: "+u)}var o={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},l={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"},h=[],c=0;function d(t){var e={object:new Worker(t),pending:0,requests:{}};return e.object.onmessage=function(t){var s=t.data;e.pending-=s.count,e.requests[s.id][s.action](s.value),delete e.requests[s.id]},e}function u(t){for(var e="var instance; var ready = WebAssembly.instantiate(new Uint8Array(["+new Uint8Array(r(i))+"]), {}).then(function(result) { instance = result.instance; instance.exports.__wasm_call_ctors(); });self.onmessage = workerProcess;"+a.toString()+p.toString(),s=new Blob([e],{type:"text/javascript"}),n=URL.createObjectURL(s),o=0;o<t;++o)h[o]=d(n);URL.revokeObjectURL(n)}function p(t){n.then((function(){var e=t.data;try{var i=new Uint8Array(e.count*e.size);a(s.exports[e.mode],i,e.count,e.size,e.source,s.exports[e.filter]),self.postMessage({id:e.id,count:e.count,action:"resolve",value:i},[i.buffer])}catch(t){self.postMessage({id:e.id,count:e.count,action:"reject",value:t})}}))}return{ready:n,supported:!0,useWorkers:function(t){u(t)},decodeVertexBuffer:function(t,e,i,n,r){a(s.exports.meshopt_decodeVertexBuffer,t,e,i,n,s.exports[o[r]])},decodeIndexBuffer:function(t,e,i,n){a(s.exports.meshopt_decodeIndexBuffer,t,e,i,n)},decodeIndexSequence:function(t,e,i,n){a(s.exports.meshopt_decodeIndexSequence,t,e,i,n)},decodeGltfBuffer:function(t,e,i,n,r,h){a(s.exports[l[r]],t,e,i,n,s.exports[o[h]])},decodeGltfBufferAsync:function(t,e,i,r,d){return h.length>0?function(t,e,s,i,n){for(var r=h[0],a=1;a<h.length;++a)h[a].pending<r.pending&&(r=h[a]);return new Promise((function(a,o){var l=new Uint8Array(s),h=c++;r.pending+=t,r.requests[h]={resolve:a,reject:o},r.object.postMessage({id:h,count:t,size:e,source:l,mode:i,filter:n},[l.buffer])}))}(t,e,i,l[r],o[d]):n.then((function(){var n=new Uint8Array(t*e);return a(s.exports[l[r]],n,t,e,i,s.exports[o[d]]),n}))}}}();class cA{constructor(t){this.dropHandler=t,window.addEventListener("dragstart",(t=>{t.preventDefault(),t.stopPropagation(),t.dataTransfer.effectAllowed="all"}),!1),window.addEventListener("dragover",(t=>{t.preventDefault(),t.stopPropagation(),t.dataTransfer.effectAllowed="all"}),!1),window.addEventListener("drop",(t=>this.handleDrop(t)),!1)}handleDrop(t){const e=e=>{const s=[];e.forEach((i=>{i.file((n=>{s.push({url:URL.createObjectURL(n),filename:i.fullPath.substring(1)}),s.length===e.length&&(s.length>1&&(t=>{const e=t=>{const e=t.split(u.delimiter);return[e[0],e.slice(1).join(u.delimiter)]};for(;;){const s=e(t[0].filename);if(0===s[1].length)return;for(let i=1;i<t.length;++i){const n=e(t[i].filename);if(s[0]!==n[0])return}for(let s=0;s<t.length;++s)t[s].filename=e(t[s].filename)[1]}})(s),this.dropHandler(s,!t.shiftKey))}))}))};t.preventDefault();const s=t.dataTransfer.items;if(!s)return;const i=[];for(let t=0;t<s.length;++t)i.push(s[t].webkitGetAsEntry());(t=>{let s=0;const i=[],n=t=>{t.forEach((t=>{if(t.isFile)i.push(t);else if(t.isDirectory){s++;t.createReader().readEntries((t=>{s--,n(t)}))}})),0===s&&e(i)};n(t)})(i)}}let dA=null,uA=null;const pA=new R,fA=new R,mA=new R,gA=new R(0,1,0),_A=new V,vA=[[[0,0,0],[-.5,0,.3]],[[0,0,0],[.5,0,.3]],[[0,0,0],[0,-.5,.3]],[[0,0,0],[0,.5,.3]],[[0,0,1],[-.5,0,.3]],[[0,0,1],[.5,0,.3]],[[0,0,1],[0,-.5,.3]],[[0,0,1],[0,.5,.3]],[[0,-.5,.3],[.5,0,.3]],[[.5,0,.3],[0,.5,.3]],[[0,.5,.3],[-.5,0,.3]],[[-.5,0,.3],[0,-.5,.3]]];class bA{constructor(t,e,s=!0){this.depthState=new te;const i=t.graphicsDevice,n=Ai(i,"\nattribute vec3 vertex_position;\nattribute vec4 vertex_color;\n\nvarying vec2 zw;\nvarying vec4 vColor;\n\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\n\nvoid main(void) {\n    vColor = vertex_color;\n\n    gl_Position = matrix_viewProjection * matrix_model * vec4(vertex_position, 1.0);\n\n    // store z/w for later use in fragment shader\n    zw = gl_Position.zw;\n\n    // disable depth clipping\n    gl_Position.z = 0.0;\n}","\nprecision highp float;\n\nvarying vec2 zw;\nvarying vec4 vColor;\nuniform vec4 uColor;\n\nvoid main(void) {\n    gl_FragColor = vColor * uColor;\n\n    // clamp depth in Z to [0, 1] range\n    gl_FragDepth = max(0.0, min(1.0, (zw.x / zw.y + 1.0) * 0.5));\n}","debug-lines",{vertex_position:at,vertex_color:dt});dA||(uA=new Qa({enabled:!0,name:"Debug Layer Behind",opaqueSortMode:0,transparentSortMode:0,passThrough:!0,overrideClear:!0,onDrawCall:()=>{this.depthState.copy(i.depthState),this.depthState.func=4,i.setDepthState(this.depthState)}}),dA=new Qa({enabled:!0,name:"Debug Layer",opaqueSortMode:0,transparentSortMode:0,passThrough:!0,overrideClear:!0}),t.scene.layers.pushTransparent(uA),t.scene.layers.pushTransparent(dA),e.camera.layers=e.camera.layers.concat([uA.id,dA.id]));const r=new he(i,[{semantic:at,components:3,type:6},{semantic:dt,components:4,type:zt,normalize:!0}]),a=new di(i);a.vertexBuffer=new oe(i,r,8192,1),a.primitive[0].type=1,a.primitive[0].base=0,a.primitive[0].indexed=!1,a.primitive[0].count=0;const o=new Ki;o.shader=n,o.setParameter("uColor",[1,1,1,.7]),o.blendType=2,o.update();const l=new Sn(a,o,new gn);if(l.cull=!1,l.visible=!1,dA.addMeshInstances([l],!0),this.meshInstances=[l],s){const t=new Ki;t.shader=n,t.setParameter("uColor",[.5,.5,.5,.5]),t.blendType=2,t.depthTest=!0,t.depthWrite=!1,t.update();const e=new Sn(a,t,new gn);e.cull=!1,e.visible=!1,uA.addMeshInstances([e],!0),this.meshInstances.push(e)}this.app=t,this.mesh=a,this.vertexFormat=r,this.vertexCursor=0,this.vertexData=new Float32Array(this.mesh.vertexBuffer.lock()),this.colorData=new Uint32Array(this.mesh.vertexBuffer.lock())}static matrixMad(t,e,s){if(s>0)for(let i=0;i<16;++i)t.data[i]+=e.data[i]*s}clear(){this.vertexCursor=0}box(t,e){this.line(new R(t.x,t.y,t.z),new R(e.x,t.y,t.z)),this.line(new R(e.x,t.y,t.z),new R(e.x,t.y,e.z)),this.line(new R(e.x,t.y,e.z),new R(t.x,t.y,e.z)),this.line(new R(t.x,t.y,e.z),new R(t.x,t.y,t.z)),this.line(new R(t.x,e.y,t.z),new R(e.x,e.y,t.z)),this.line(new R(e.x,e.y,t.z),new R(e.x,e.y,e.z)),this.line(new R(e.x,e.y,e.z),new R(t.x,e.y,e.z)),this.line(new R(t.x,e.y,e.z),new R(t.x,e.y,t.z)),this.line(new R(t.x,t.y,t.z),new R(t.x,e.y,t.z)),this.line(new R(e.x,t.y,t.z),new R(e.x,e.y,t.z)),this.line(new R(e.x,t.y,e.z),new R(e.x,e.y,e.z)),this.line(new R(t.x,t.y,e.z),new R(t.x,e.y,e.z))}line(t,e,s=4294967295){if(this.vertexCursor>=this.vertexData.length/8){const t=this.mesh.vertexBuffer,e=2*t.lock().byteLength,s=new ArrayBuffer(e);this.mesh.vertexBuffer=new oe(this.app.graphicsDevice,t.getFormat(),2*t.getNumVertices(),1,s),this.vertexData=new Float32Array(s),this.colorData=new Uint32Array(s),this.colorData.set(new Uint32Array(t.lock()))}const i=this.vertexCursor,n=this.vertexData,r=this.colorData;n[8*i+0]=t.x,n[8*i+1]=t.y,n[8*i+2]=t.z,r[8*i+3]=s,n[8*i+4]=e.x,n[8*i+5]=e.y,n[8*i+6]=e.z,r[8*i+7]=s,this.vertexCursor++}generateNormals(t,e,s,i){const n=new Ds(t),r=n.element[at],a=n.element[ot],o=n.element[ct],l=n.element[ht],h=t.getNumVertices(),c=new R,d=new R,u=new V;for(let t=0;t<h;++t){if(c.set(r.get(0),r.get(1),r.get(2)),d.set(a.get(0),a.get(1),a.get(2)),o&&l&&i){u.copy(V.ZERO);for(let t=0;t<4;++t)bA.matrixMad(u,i[o.get(t)],l.get(t));u.mul2(e,u),u.transformPoint(c,c),u.transformVector(d,d)}else e.transformPoint(c,c),e.transformVector(d,d);d.normalize().mulScalar(s).add(c),this.line(c,d),n.next()}}bone(t,e,s=4294967295){_A.setLookAt(t,e,gA),pA.sub2(e,t);const i=pA.length(),n=(t,e)=>{pA.set(e[0]*i*.3,e[1]*i*.3,e[2]*-i),_A.transformPoint(pA,t)};vA.forEach((t=>{n(fA,t[0]),n(mA,t[1]),this.line(fA,mA,s)}))}axis(t,e=1){t.getTranslation(pA),t.getScale(mA),mA.set(e/mA.x,e/mA.y,e/mA.z),t.getX(fA).mul(mA).add(pA),this.line(pA,fA,4294901760),t.getY(fA).mul(mA).add(pA),this.line(pA,fA,4278255360),t.getZ(fA).mul(mA).add(pA),this.line(pA,fA,4278190335)}generateSkeleton(t,e,s,i){const n=(r,a)=>{if(r.enabled){a||(a=r===i);for(let t=0;t<r.children.length;++t){const s=r.children[t];e&&this.bone(r.getPosition(),s.getPosition(),a?4294967040:4294967295),n(s,a)}if(s){const e=t.parent;e&&(pA.sub2(r.getPosition(),e.getPosition()),this.axis(r.getWorldTransform(),.05*pA.length()))}}};n(t,!1)}update(){0===this.vertexCursor?this.meshInstances.forEach((t=>{t.visible=!1})):(this.meshInstances.forEach((t=>{t.visible=!0})),this.mesh.vertexBuffer.unlock(),this.mesh.primitive[0].count=2*this.vertexCursor,this.vertexCursor=0)}}const yA=(t,e)=>1/(Math.sqrt(2*Math.PI)*e)*Math.exp(-t*t/(2*e*e)),xA=new Zt(!0,0,11,12),wA=new Zt(!1);class SA{constructor(t,e,s){this.shader=null,this.multiframeTexUniform=null,this.powerUniform=null,this.textureBiasUniform=null,this.accumTexture=null,this.accumRenderTarget=null,this.sampleId=0,this.samples=[],this.enabled=!0,this.totalWeight=0,this.blend=1,this.device=t,this.camera=e,this.textureBias=-Math.log2(s),this.samples=this.generateSamples(s,!1,2,0),this.camera.onPreRender=()=>{const t=this.camera.camera,e=t.projectionMatrix;if(this.enabled&&this.accumTexture){const t=this.samples[this.sampleId];e.data[8]=t.x/this.accumTexture.width,e.data[9]=t.y/this.accumTexture.height,this.textureBiasUniform.setValue(0===this.sampleId?0:this.textureBias)}else e.data[8]=0,e.data[9]=0,this.textureBiasUniform.setValue(0);t._viewProjMatDirty=!0},this.shader=Ai(t,"\nattribute vec2 vertex_position;\nvarying vec2 texcoord;\nvoid main(void) {\n    gl_Position = vec4(vertex_position, 0.5, 1.0);\n    texcoord = vertex_position.xy * 0.5 + 0.5;\n}\n","\nvarying vec2 texcoord;\nuniform sampler2D multiframeTex;\nuniform float power;\nvoid main(void) {\n    vec4 t = texture2D(multiframeTex, texcoord);\n    gl_FragColor = pow(t, vec4(power));\n}\n","multiframe",{vertex_position:at}),this.pixelFormat=(t=>(t=>t.extTextureHalfFloat&&t.textureHalfFloatRenderable)(t)?et:(t=>t.extTextureFloat&&t.textureFloatRenderable)(t)?st:7)(t),this.multiframeTexUniform=t.scope.resolve("multiframeTex"),this.powerUniform=t.scope.resolve("power"),this.textureBiasUniform=t.scope.resolve("textureBias");const i=()=>{this.destroy()};t.once("destroy",i),t.on("devicelost",i)}setSamples(t,e=!1,s=1,i=0){this.textureBias=-Math.log2(t),this.samples=this.generateSamples(t,e,s,i),this.sampleId=0}generateSamples(t,e=!1,s=1,i=0){const n=[],r=Math.ceil(3*i)+1,a=.5*s;let o,l,h;for(let s=0;s<t;++s)for(let c=0;c<t;++c)e?(o=(s+Math.random())/t*2-1,l=(c+Math.random())/t*2-1):(o=s/(t-1)*2-1,l=c/(t-1)*2-1),h=i<=0?1:yA(o*r,i)*yA(l*r,i),n.push(new R(o*a,l*a,h));let c=0;return n.forEach((t=>{c+=t.z})),n.forEach((t=>{t.z/=c})),n.sort(((t,e)=>{const s=t.length(),i=e.length();return s<i?-1:i<s?1:0})),n}destroy(){this.accumRenderTarget&&(this.accumRenderTarget.destroy(),this.accumRenderTarget=null),this.accumTexture&&(this.accumTexture.destroy(),this.accumTexture=null)}create(){const t=this.camera.renderTarget.colorBuffer;this.accumTexture=new Ue(this.device,{width:t.width,height:t.height,format:this.pixelFormat,mipmaps:!1,minFilter:0,magFilter:0}),this.accumRenderTarget=new pe({colorBuffer:this.accumTexture,depth:!1})}moved(){this.sampleId=0,this.totalWeight=0}update(){const t=this.device,e=this.samples.length,s=this.camera.renderTarget.colorBuffer;if(!this.enabled)return 1!==this.blend?(t.setBlendState(xA),t.setBlendColor(this.blend,this.blend,this.blend,this.blend)):t.setBlendState(wA),this.multiframeTexUniform.setValue(s),this.powerUniform.setValue(1),Fi(t,null,this.shader,null,null),this.activateBackbuffer(),!1;if(!this.accumTexture||this.accumTexture.width===s.width&&this.accumTexture.height===s.height||this.destroy(),this.accumTexture||this.create(),this.sampleId<e){const e=this.samples[this.sampleId].z,i=e/(this.totalWeight+e);t.setBlendState(xA),t.setBlendColor(i,i,i,i),this.multiframeTexUniform.setValue(s),this.powerUniform.setValue(2.2),Fi(t,this.accumRenderTarget,this.shader,null,null),this.totalWeight+=e}return 0===this.sampleId?(this.multiframeTexUniform.setValue(s),this.powerUniform.setValue(1)):(this.multiframeTexUniform.setValue(this.accumTexture),this.powerUniform.setValue(1/2.2)),1!==this.blend?(t.setBlendState(xA),t.setBlendColor(this.blend,this.blend,this.blend,this.blend)):t.setBlendState(wA),Fi(t,null,this.shader),this.sampleId<e&&this.sampleId++,this.activateBackbuffer(),this.sampleId<e}activateBackbuffer(){const t=this.device;t.setRenderTarget(null),t.updateBegin(),t.setViewport(0,0,t.width,t.height),t.setScissor(0,0,t.width,t.height)}copy(t){const e=this.device;this.multiframeTexUniform.setValue(this.accumTexture),this.powerUniform.setValue(1/2.2),Fi(e,t,this.shader)}}const CA=Ei.packDepthPS,TA=`\nvarying vec2 texcoord;\nuniform sampler2D depthTex;\nuniform vec4 texcoordRange;\n${CA}\nvoid main(void) {\n    vec2 t = mix(texcoordRange.xy, texcoordRange.zw, texcoord);\n    gl_FragColor = packFloat(texture2D(depthTex, t).x);\n}\n`,EA=new Zt(!1);class PA{constructor(t){this.pixels=new Uint8Array(4),this.texture=null,this.renderTarget=null,this.device=t,this.shader=Ai(t,"\nattribute vec2 vertex_position;\nvarying vec2 texcoord;\nvoid main(void) {\n    gl_Position = vec4(vertex_position, 0.5, 1.0);\n    texcoord = vertex_position.xy * 0.5 + 0.5; // + texcoordOffset;\n}\n",TA,"read-depth",{vertex_position:at}),this.depthTexUniform=t.scope.resolve("depthTex"),this.texcoordRangeUniform=t.scope.resolve("texcoordRange");const e=()=>{this.destroy()};t.once("destroy",e),t.on("devicelost",e)}destroy(){this.renderTarget&&(this.renderTarget.destroy(),this.renderTarget=null),this.texture&&(this.texture.destroy(),this.texture=null)}create(){this.texture=new Ue(this.device,{width:1,height:1,format:7,mipmaps:!1,minFilter:0,magFilter:0}),this.renderTarget=new pe({colorBuffer:this.texture,depth:!1})}read(t,e,s){this.texture||this.create(),console.log(`tex=${this.texture.width}x${this.texture.height} depth=${t.width}x${t.height}`);const i=this.device,n=e+.5/t.width,r=s+.5/t.height;this.depthTexUniform.setValue(t),this.texcoordRangeUniform.setValue([n,r,n,r]),i.setBlendState(EA),Fi(this.device,this.renderTarget,this.shader);const a=i.gl,o=i.renderTarget;return i.setRenderTarget(this.renderTarget),i.updateBegin(),a.readPixels(0,0,1,1,a.RGBA,a.UNSIGNED_BYTE,this.pixels),i.updateEnd(),i.setRenderTarget(o),i.updateBegin(),this.pixels[0]/4278190080+this.pixels[1]/16711680+this.pixels[2]/65280+this.pixels[3]/255}}class MA{constructor(t,e=.25){this.value=t.clone(),this.start=t.clone(),this.target=t.clone(),this.transitionTime=e,this.timer=0}goto(t){this.timer=0,this.start.copy(this.value),this.target.copy(t)}snapto(t){this.timer=this.transitionTime,this.target.copy(t)}update(t){if(this.timer<this.transitionTime){this.timer=Math.min(this.timer+t,this.transitionTime);const e=this.timer/this.transitionTime,s=Math.pow(e-1,5)+1;this.value.lerp(this.start,this.target,s)}else this.value.copy(this.target)}}const AA=new R,kA=new R,DA=new R,RA=new R;class LA{constructor(t,e){this.cameraNode=t,this.focalPoint=new MA(new R(0,0,0),e),this.azimElevDistance=new MA(new R(0,0,1),e)}vecToAzimElevDistance(t,e){const s=t.length(),i=Math.atan2(-t.x/s,-t.z/s)*k.RAD_TO_DEG,n=Math.asin(t.y/s)*k.RAD_TO_DEG;e.set(i,n,s)}calcForwardVec(t){const e=this.azimElevDistance.value.y*k.DEG_TO_RAD,s=this.azimElevDistance.value.x*k.DEG_TO_RAD,i=Math.sin(-e),n=Math.cos(-e),r=Math.sin(-s),a=Math.cos(-s);t.set(-n*r,i,n*a)}update(t){this.focalPoint.update(t),this.azimElevDistance.update(t);const e=this.azimElevDistance.value;this.calcForwardVec(AA),AA.mulScalar(e.z),AA.add(this.focalPoint.value),this.cameraNode.setLocalPosition(AA),this.cameraNode.setLocalEulerAngles(e.y,e.x,0)}}class IA{constructor(t,e){this.orbitSensitivity=.3,this.distanceSensitivity=.4,this.lookButtonDown=!1,this.panButtonDown=!1,this.lastPoint=new I,this.onMouseOutFunc=()=>{this.onMouseOut()},this.app=t,this.orbitCamera=e,this.app.mouse.on(Rs,this.onMouseDown,this),this.app.mouse.on(Is,this.onMouseUp,this),this.app.mouse.on(Ls,this.onMouseMove,this),this.app.mouse.on(Os,this.onMouseWheel,this),window.addEventListener("mouseout",this.onMouseOutFunc,!1),this.app.mouse.disableContextMenu()}destroy(){this.app.mouse.off(Rs,this.onMouseDown,this),this.app.mouse.off(Is,this.onMouseUp,this),this.app.mouse.off(Ls,this.onMouseMove,this),this.app.mouse.off(Os,this.onMouseWheel,this),window.removeEventListener("mouseout",this.onMouseOutFunc,!1)}pan(t){const e=this.orbitCamera.cameraNode.camera,s=this.orbitCamera.azimElevDistance.value.z;e.screenToWorld(t.x,t.y,s,kA),e.screenToWorld(this.lastPoint.x,this.lastPoint.y,s,DA),RA.sub2(DA,kA),RA.add(this.orbitCamera.focalPoint.target),this.orbitCamera.focalPoint.goto(RA)}onMouseDown(t){switch(t.button){case 0:this.lookButtonDown=!0;break;case 1:case 2:this.panButtonDown=!0}}onMouseUp(t){switch(t.button){case 0:this.lookButtonDown=!1;break;case 1:case 2:this.panButtonDown=!1}}onMouseMove(t){this.lookButtonDown?(AA.copy(this.orbitCamera.azimElevDistance.target),AA.y-=t.dy*this.orbitSensitivity,AA.x-=t.dx*this.orbitSensitivity,this.orbitCamera.azimElevDistance.goto(AA)):this.panButtonDown&&this.pan(t),this.lastPoint.set(t.x,t.y)}onMouseWheel(t){AA.copy(this.orbitCamera.azimElevDistance.target),AA.z-=-2*t.wheelDelta*this.distanceSensitivity*(.1*AA.z),this.orbitCamera.azimElevDistance.goto(AA),t.event.preventDefault()}onMouseOut(){this.lookButtonDown=!1,this.panButtonDown=!1}}class OA{constructor(t,e){this.orbitSensitivity=.3,this.distanceSensitivity=.4,this.lastTouchPoint=new I,this.lastPinchMidPoint=new I,this.lastPinchDistance=0,this.pinchMidPoint=new I,this.app=t,this.orbitCamera=e,this.app.touch&&(this.app.touch.on(Fs,this.onTouchStartEndCancel,this),this.app.touch.on(Bs,this.onTouchStartEndCancel,this),this.app.touch.on(Ns,this.onTouchStartEndCancel,this),this.app.touch.on(zs,this.onTouchMove,this))}destroy(){this.app.touch.off(Fs,this.onTouchStartEndCancel,this),this.app.touch.off(Bs,this.onTouchStartEndCancel,this),this.app.touch.off(Ns,this.onTouchStartEndCancel,this),this.app.touch.off(zs,this.onTouchMove,this)}getPinchDistance(t,e){const s=t.x-e.x,i=t.y-e.y;return Math.sqrt(s*s+i*i)}calcMidPoint(t,e,s){s.set(e.x-t.x,e.y-t.y),s.mulScalar(.5),s.x+=t.x,s.y+=t.y}onTouchStartEndCancel(t){const e=t.touches;1===e.length?this.lastTouchPoint.set(e[0].x,e[0].y):2===e.length&&(this.lastPinchDistance=this.getPinchDistance(e[0],e[1]),this.calcMidPoint(e[0],e[1],this.lastPinchMidPoint))}pan(t){const e=this.orbitCamera.cameraNode.camera,s=this.orbitCamera.azimElevDistance.target.z;e.screenToWorld(t.x,t.y,s,kA),e.screenToWorld(this.lastPinchMidPoint.x,this.lastPinchMidPoint.y,s,DA),RA.sub2(DA,kA),RA.add(this.orbitCamera.focalPoint.target),this.orbitCamera.focalPoint.goto(RA)}onTouchMove(t){const e=this.pinchMidPoint,s=this.orbitCamera.azimElevDistance.target.clone(),i=t.touches;if(1===i.length){const t=i[0];s.y-=(t.y-this.lastTouchPoint.y)*this.orbitSensitivity,s.x-=(t.x-this.lastTouchPoint.x)*this.orbitSensitivity,this.orbitCamera.azimElevDistance.goto(s),this.lastTouchPoint.set(t.x,t.y)}else if(2===i.length){const t=this.getPinchDistance(i[0],i[1]),n=t-this.lastPinchDistance;this.lastPinchDistance=t,s.z-=n*this.distanceSensitivity*.1*(.1*s.z),this.orbitCamera.azimElevDistance.goto(s),this.calcMidPoint(i[0],i[1],e),this.pan(e),this.lastPinchMidPoint.copy(e)}}}class FA{constructor(t,e){this.controls=[!1,!1,!1,!1,!1,!1],this.shift=!1,this.app=t,this.orbitCamera=e,t.keyboard.on("keydown",(t=>{switch(t.key){case 87:this.controls[0]=!0;break;case 83:this.controls[1]=!0;break;case 65:this.controls[2]=!0;break;case 68:this.controls[3]=!0;break;case 81:this.controls[4]=!0;break;case 69:this.controls[5]=!0}})),t.keyboard.on("keyup",(t=>{switch(t.key){case 87:this.controls[0]=!1;break;case 83:this.controls[1]=!1;break;case 65:this.controls[2]=!1;break;case 68:this.controls[3]=!1;break;case 81:this.controls[4]=!1;break;case 69:this.controls[5]=!1}}))}update(t,e){const s=(s,i)=>{AA.copy(s).mulScalar(t*e*i),AA.add(this.orbitCamera.focalPoint.value),this.orbitCamera.focalPoint.goto(AA)},i=this.app.keyboard.isPressed(16)?10:2;this.controls[0]&&s(this.orbitCamera.cameraNode.forward,i),this.controls[1]&&s(this.orbitCamera.cameraNode.forward,-i),this.controls[2]&&s(this.orbitCamera.cameraNode.right,-i),this.controls[3]&&s(this.orbitCamera.cameraNode.right,i),this.controls[4]&&s(this.orbitCamera.cameraNode.up,i),this.controls[5]&&s(this.orbitCamera.cameraNode.up,-i)}}function BA(t){(async()=>{const e=await new Promise(((e,s)=>{self.importScripts(`${t}static/lib/lodepng/lodepng.js`),e(self.lodepng({locateFile:()=>`${t}static/lib/lodepng/lodepng.wasm`}))}));self.onmessage=t=>{const s=t.data,i=((t,e,s,i)=>{const n=t._malloc(4),r=t._malloc(4),a=t._malloc(s*i*4);for(let n=0;n<i;++n){let r=n*s,o=a/4+(i-1-n)*s;for(let i=0;i<s;++i)t.HEAPU32[o++]=e[r++]}t._lodepng_encode32(n,r,a,s,i);const o=t.HEAPU8.slice(t.HEAPU32[n/4],t.HEAPU32[n/4]+t.HEAPU32[r/4]);return t._free(n),t._free(r),t._free(a),o})(e,s.words,s.width,s.height);self.postMessage({result:i},[i.buffer])}})()}const zA=t=>{const e=t._device,s=new Uint8ClampedArray(t.width*t.height*4);return e.setFramebuffer(t._glFrameBuffer),e.gl.readPixels(0,0,t.width,t.height,e.gl.RGBA,e.gl.UNSIGNED_BYTE,s),new Uint32Array(s.buffer)},NA=(t,e)=>{const s=new pe({colorBuffer:t,depth:!1,face:e});device.initRenderTarget(s);const i=zA(s);return s.destroy(),i};class UA{constructor(){let t;this.worker=(()=>{const t=new Blob([`(${BA.toString()})('${window.location.href.split("?")[0]}')\n\n`],{type:"application/javascript"});return new Worker(URL.createObjectURL(t))})(),this.worker.addEventListener("message",(e=>{t(e)})),this.promiseFunc=(e,s)=>{t=s=>{e(s.data.result),t=null}}}async export(t,e,s,i){((t,e)=>{const s=new Blob([e],{type:"octet/stream"}),i=window.URL.createObjectURL(s),n=document.createElement("a");if(n.download=t,n.href=i,document.createEvent){const t=document.createEvent("MouseEvents");t.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),n.dispatchEvent(t)}else n.fireEvent&&n.fireEvent("onclick");window.URL.revokeObjectURL(i)})(t,await((t,e,s)=>(this.worker.postMessage({words:t,width:e,height:s},[t.buffer]),new Promise(this.promiseFunc)))(e,s,i))}async exportRenderTarget(t,e){this.export(t,zA(e),e.width,e.height)}async exportTexture(t,e){if(e.cubemap){const s=["posx","negx","posy","negy","posz","negz"],i=t.lastIndexOf("."),n=-1===i?t:t.substring(0,i);for(let t=0;t<6;++t)this.export(`${n}_${s[t]}.png`,NA(e,t),e.width,e.height)}else this.export(t,NA(e,null),e.width,e.height)}}const VA=Ei.skyboxVS.replace(" * cubeMapRotationMatrix","");Ei.skyboxHDRPS="\nvoid intersectPlane(inout float t, vec3 pos, vec3 dir, vec4 plane) {\n    float d = dot(dir, plane.xyz);\n    if (d != 0.0) {\n        float n = -(dot(pos, plane.xyz) + plane.w) / d;\n        if (n >= 0.0 && n < t) {\n            t = n;\n        }\n    }\n}\n\nbool intersectSphere(inout float t, vec3 pos, vec3 dir, vec4 sphere) {\n    vec3 L = sphere.xyz - pos;\n    float tca = dot(L, dir);\n\n    float d2 = sphere.w - (dot(L, L) - tca * tca);\n    if (d2 >= 0.0) {\n        float thc = tca + sqrt(d2);\n        if (thc >= 0.0 && thc < t) {\n            t = thc;\n            return true;\n        }\n    }\n\n    return false;\n}\n\nvarying vec3 vViewDir;\n\nuniform samplerCube texture_cubeMap;\nuniform mat3 cubeMapRotationMatrix;\nuniform vec3 view_position;             // camera world position\nuniform vec4 tripodParams;              // x, y, z: world space origin of the tripod, w: blend factor\nuniform vec4 domeParams;                // x, y, z: world space dome center, w: (dome radius)^2\nuniform vec4 groundPlane;               // x, y, z, w: world space ground plane\n\nvoid main(void) {\n    // get world space ray\n    vec3 view_pos = view_position;\n    vec3 view_dir = normalize(vViewDir);\n\n    // intersect ray with world geometry\n    float t = 8000.0;   // max intersection distance\n    if (intersectSphere(t, view_pos, view_dir, domeParams) && view_dir.y < 0.0) {\n        intersectPlane(t, view_pos, view_dir, groundPlane);\n    }\n\n    // calculate world space intersection\n    vec3 world_pos = view_pos + view_dir * t;\n\n    // get vector from world space pos to tripod origin\n    vec3 env_dir = normalize(world_pos - tripodParams.xyz);\n\n    vec3 final_dir = mix(view_dir, env_dir, tripodParams.w) * cubeMapRotationMatrix;\n\n    vec3 linear = $DECODE(textureCube(texture_cubeMap, fixSeamsStatic(final_dir * vec3(-1.0, 1.0, 1.0), $FIXCONST)));\n\n    gl_FragColor = vec4(gammaCorrectOutput(toneMap(processEnvironment(linear))), 1.0);\n}\n",Ei.skyboxVS=VA;class HA{constructor(t){this._enabled=!1,this.origin=new R(0),this.tripodOffset=.1,this.domeRadius=1,this.domeOffset=.5,this.app=t,t.on("prerender",(()=>{const e=t.graphicsDevice.scope;e.resolve("tripodParams").setValue([this.origin.x,this.origin.y+this.domeRadius*this.tripodOffset,this.origin.z,this.enabled?1:0]),e.resolve("domeParams").setValue([this.origin.x,this.origin.y+this.domeRadius*this.domeOffset,this.origin.z,this.domeRadius*this.domeRadius]),e.resolve("groundPlane").setValue([0,1,0,-this.origin.y])}))}set enabled(t){this._enabled=t}get enabled(){return this._enabled}}class GA{constructor(t,e,s,i){this.layer=new Qa({name:"Shadow Layer"});const n=t.scene.layers,r=n.getLayerByName("World"),a=n.getTransparentIndex(r);n.insert(this.layer,a+1),this.material=new Da,this.material.useSkybox=!1,this.material.blendType=2,this.material.depthWrite=!1,this.material.diffuse.set(0,0,0),this.material.specular.set(0,0,0),this.material.chunks.endPS="\n    litShaderArgs.opacity = mix(light0_shadowIntensity, 0.0, shadow0);\n    gl_FragColor.rgb = vec3(0.0);\n",this.material.update(),this.plane=new El("ShadowPlane"),this.plane.addComponent("render",{type:"plane",castShadows:!1,material:this.material}),this.light=new El("ShadowLight"),this.light.addComponent("light",{type:"directional",castShadows:!0,normalOffsetBias:0,shadowBias:0,shadowResolution:1024,shadowType:2,shadowUpdateMode:2,vsmBlurSize:64,enabled:!0,shadowIntensity:.4}),s.addChild(this.plane),s.addChild(this.light),this.plane.render.layers=[this.layer.id],this.light.light.layers=[this.layer.id],e.layers=e.layers.concat([this.layer.id]),this.sceneRoot=i,this.camera=e}onEntityAdded(t){t.findComponents("render").forEach((t=>{this.layer.shadowCasters=this.layer.shadowCasters.concat(t.meshInstances)}))}onEntityRemoved(t){t.findComponents("render").forEach((t=>{this.layer.shadowCasters=this.layer.shadowCasters.filter((e=>-1===t.meshInstances.indexOf(e)))}))}onUpdate(t){const e=t,s=e.center,i=Math.sqrt(e.halfExtents.x*e.halfExtents.x+e.halfExtents.z*e.halfExtents.z);this.plane.setLocalScale(4*i,1,4*i),this.plane.setPosition(s.x,e.getMin().y,s.z),this.light.light.shadowDistance=this.camera.camera._farClip}set enabled(t){this.layer.enabled=t}get enabled(){return this.layer.enabled}set intensity(t){this.light.light.shadowIntensity=t}get intensity(){return this.light.light.shadowIntensity}}class WA{constructor(){this.suppressNextTouch=!1,this.touches=new Map,this.onPointerDown=t=>{t.preventDefault(),t.stopPropagation(),this.touches.set(t.pointerId,{previous:{x:t.clientX,y:t.clientY},current:{x:t.clientX,y:t.clientY}})},this.onPointerMove=t=>{var e;t.preventDefault(),t.stopPropagation();const s=this.touches.get(t.pointerId);if(s&&(s.previous.x=s.current.x,s.previous.y=s.current.y,s.current.x=t.clientX,s.current.y=t.clientY),2===this.touches.size){const t=Array.from(this.touches.keys()),s=this.touches.get(t[0]),i=this.touches.get(t[1]),n=Math.atan2(i.previous.y-s.previous.y,i.previous.x-s.previous.x),r=Math.atan2(i.current.y-s.current.y,i.current.x-s.current.x)-n;0!==r&&(null===(e=this.onRotate)||void 0===e||e.call(this,-180*r/Math.PI))}},this.onPointerUp=t=>{t.preventDefault(),t.stopPropagation(),this.suppressNextTouch||(this.suppressNextTouch=2===this.touches.size),this.touches.delete(t.pointerId)},this.dom=document.createElement("div"),this.dom.style.position="fixed",this.dom.style.top="0",this.dom.style.left="0",this.dom.style.width="100%",this.dom.style.height="100%",this.dom.style.opacity="0",this.dom.style.touchAction="none",this.dom.style.display="none",document.body.appendChild(this.dom)}started(){this.dom.style.display="block",this.dom.addEventListener("pointerdown",this.onPointerDown),this.dom.addEventListener("pointermove",this.onPointerMove),this.dom.addEventListener("pointerup",this.onPointerUp)}ended(){this.dom.style.display="none",this.dom.removeEventListener("pointerdown",this.onPointerDown),this.dom.removeEventListener("pointermove",this.onPointerMove),this.dom.removeEventListener("pointerup",this.onPointerUp)}}class jA{constructor(t,e,s,i){this.ray=new Z,this.supported=!1,this.active=!1,this.intensity=1,this.color=new D(1,1,1),this.rotation=new H,this.input=new WA,this.app=t,this.camera=e,this.observer=s,this.handlers=i,s.set("xrSupported",!1),s.set("xrActive",!1),this.app.xr.supported&&(t.xr.domOverlay.root=this.input.dom,this.input.onRotate=t=>{this.handlers.rotate(t)},t.xr.on("available:"+Bd,(t=>{this.supported=t,s.set("xrSupported",!!t)})),t.xr.on("start",(()=>{this.active=!0,s.set("xrActive",!0),this.onStarted()})),t.xr.on("end",(()=>{this.active=!1,s.set("xrActive",!1),this.onEnded()})))}onStarted(){console.log("Immersive AR session has started"),this.handlers.started(),this.performXrHitTest(null),this.app.xr.lightEstimation&&this.app.xr.lightEstimation.start(),this.app.xr.input.on("select",(t=>{const e=t.getDirection().clone().normalize();this.performXrHitTest(new Z(t.getOrigin(),e))})),this.input.started()}onEnded(){console.log("Immersive AR session has ended"),this.input.ended(),this.handlers.ended()}performXrHitTest(t){var e;if(t){const s=null===(e=this.app.xr.views)||void 0===e?void 0:e[0];s&&(s.viewOffMat.transformPoint(t.origin,this.ray.origin),s.viewOffMat.transformVector(t.direction,this.ray.direction))}this.app.xr.hitTest.start({spaceType:zd,entityTypes:["point","plane","mesh"],offsetRay:t?this.ray:null,callback:(t,e)=>{t?console.log(t):e.on("result",(t=>{e.remove(),this.input.suppressNextTouch?this.input.suppressNextTouch=!1:this.handlers.place(t)}))}})}start(){this.app.xr.isAvailable(Bd)&&(this.handlers.starting(),this.app.xr.start(this.camera.camera,Bd,"local",{callback:t=>{t&&console.log(t)}}))}onUpdate(t){this.active&&this.handlers.onUpdate(t)}onPrerender(){var t;if(this.active){const e=this.camera.camera.camera;this.app.xr._setClipPlanes(e._nearClip,e._farClip);const s=this.app.xr.lightEstimation;s.available&&(this.intensity=null!==(t=s.intensity)&&void 0!==t?t:1,s.color&&(this.color.r=Math.pow(s.color.r,1/2.2),this.color.g=Math.pow(s.color.g,1/2.2),this.color.b=Math.pow(s.color.b,1/2.2)),s.rotation&&this.rotation.copy(s.rotation),this.handlers.updateLighting(this.intensity,this.color,this.rotation,s.sphericalHarmonics)),this.handlers.onPrerender()}}getCameraMatrix(){return this.active?this.app.xr.views[0].viewInvOffMat:this.camera.getWorldTransform()}}const qA=["gltf","glb","vox"],XA=new $(new R(0,1,0),new R(1,1,1)),$A=new R;class KA{loadFilesFromNetwork(t,e=!1,s=!0){return oA(this,void 0,void 0,(function*(){const i=[];try{for(const e of t){const t=yield fetch(e),s=yield t.blob();i.push(s)}}catch(t){console.error("Error loading files:",t)}return e&&this.loadFiles(i,s),i}))}testNetworkFiles(){this.loadFilesFromNetwork(["/static/img/pluto.glb"],!0,!0).then((t=>{console.log("Loaded files:",t)})).catch((t=>{console.error("Error:",t)}))}constructor(t,e,s){this.controlEventKeys=null,this.pngExporter=null,this.multiframeBusy=!1,this.readDepth=null,this.cursorWorld=new R,this.loadTimestamp=null,this.projectiveSkybox=null,this.shadowCatcher=null,this.canvasResize=!0,this.canvas=t;const i=new lA(t,{mouse:new Xs(t),touch:new Ys(t),keyboard:new Ws(window),graphicsDeviceOptions:{preferWebGl2:!0,alpha:!0,antialias:!1,depth:!1,preserveDrawingBuffer:!0}});this.app=i,this.skyboxUrls=s,this.app.scene.clusteredLightingEnabled=!1;const n=i.mouse._moveHandler;i.mouse.detach(),i.mouse._moveHandler=e=>{e.target===t&&n(e)},i.mouse.attach(t);const r=i.touch._moveHandler;i.touch.detach(),i.touch._moveHandler=e=>{e.target===t&&r(e)},i.touch.attach(t);const a=i.graphicsDevice.maxSamples>1;e.set("camera.multisampleSupported",a),e.set("camera.multisample",a&&e.get("camera.multisample")),this.pngExporter=new UA,this.dropHandler=new cA(((t,e)=>{this.loadFiles(t,e)})),new ResizeObserver((()=>{this.xrMode.active||(this.canvasResize=!0,this.renderNextFrame())})).observe(window.document.getElementById("canvas-wrapper"));const o=i.scene.layers.getLayerById(1);i.scene.layers.remove(o),i.scene.layers.insertOpaque(o,2);const l=new El("Camera");l.addComponent("camera",{fov:75,frustumCulling:!0,clearColor:new D(0,0,0,0)}),l.camera.requestSceneColorMap(!0),this.orbitCamera=new LA(l,.25),this.orbitCameraInputMouse=new IA(this.app,this.orbitCamera),this.orbitCameraInputTouch=new OA(this.app,this.orbitCamera),this.orbitCameraInputKeyboard=new FA(this.app,this.orbitCamera),this.orbitCamera.focalPoint.snapto(new R(0,1,0)),i.root.addChild(l);const h=new El;h.addComponent("light",{type:"directional",shadowBias:.2,shadowResolution:2048}),i.root.addChild(h),i.autoRender=!1,this.prevCameraMat=new V,i.on("update",this.update,this),i.on("prerender",this.onPrerender,this),i.on("postrender",this.onPostrender,this),i.on("frameend",this.onFrameend,this);const c=new El("sceneRoot",i);i.root.addChild(c);const d=new El("debugRoot",i);i.root.addChild(d),this.camera=l,this.initialCameraPosition=null,this.light=h,this.sceneRoot=c,this.debugRoot=d,this.entities=[],this.entityAssets=[],this.assets=[],this.meshInstances=[],this.wireframeMeshInstances=[];const u=new Da;u.blendState=new Zt(!0,0,1,0,0,0,1),u.useLighting=!1,u.useSkybox=!1,u.ambient=new D(0,0,0),u.diffuse=new D(0,0,0),u.specular=new D(0,0,0),u.emissive=new D(1,1,1),u.update(),this.wireframeMaterial=u,this.animTracks=[],this.animationMap={},this.firstFrame=!1,this.skyboxLoaded=!1,this.animSpeed=e.get("animation.speed"),this.animTransition=e.get("animation.transition"),this.animLoops=e.get("animation.loops"),this.showWireframe=e.get("debug.wireframe"),this.showBounds=e.get("debug.bounds"),this.showSkeleton=e.get("debug.skeleton"),this.showAxes=e.get("debug.axes"),this.normalLength=e.get("debug.normals"),this.setTonemapping(e.get("camera.tonemapping")),this.setBackgroundColor(e.get("skybox.backgroundColor")),this.setLightColor(e.get("light.color")),this.setWireframeColor(e.get("debug.wireframeColor")),this.dirtyWireframe=!1,this.dirtyBounds=!1,this.dirtySkeleton=!1,this.dirtyGrid=!1,this.dirtyNormals=!1,this.sceneBounds=null,this.dynamicSceneBounds=null,this.debugBounds=new bA(i,l),this.debugSkeleton=new bA(i,l),this.debugGrid=new bA(i,l,!1),this.debugNormals=new bA(i,l,!1),this.miniStats=new iM(i),this.miniStats.enabled=e.get("debug.stats"),this.observer=e;const p=this.app.graphicsDevice;p.on("devicerestored",(()=>{this.renderNextFrame()})),this.multiframe=new SA(p,this.camera.camera,5),this.projectiveSkybox=new HA(i),this.shadowCatcher=new GA(i,this.camera.camera,this.debugRoot,this.sceneRoot),this.initXrMode(),this.bindControlEvents(),this.reloadSettings(),this.readDepth=new PA(p),this.cursorWorld=new R,t.addEventListener("dblclick",(e=>{const s=this.camera.camera,i=e.offsetX/t.clientWidth,n=1-e.offsetY/t.clientHeight,r=this.readDepth.read(s.renderTarget.depthBuffer,i,n);if(r<1){const t=new O(i,n,r,1).mulScalar(2).subScalar(1);s.projectionMatrix.clone().invert().transformVec4(t,t),t.mulScalar(1/t.w),this.cursorWorld.set(t.x,t.y,t.z),this.camera.getWorldTransform().transformPoint(this.cursorWorld,this.cursorWorld),this.orbitCamera.focalPoint.goto(this.cursorWorld)}})),i.start()}initXrMode(){const t={position:new R,rotation:new R},e=new R,s=new R,i=new R;let n=!1,r=0,a=0;const o=t=>{this.meshInstances.forEach((e=>{const s=e.material;s.ambientSH!==t&&(s.ambientSH=t,s.update())}))},l={starting:()=>{console.log("starting"),t.position.copy(this.sceneRoot.getLocalPosition()),t.rotation.copy(this.sceneRoot.getLocalEulerAngles()),n=!1;const e=this.calcSceneBounds().halfExtents.length(),s=this.camera.camera;a=1.4*e/Math.sin(.5*s.fov*s.aspectRatio*k.DEG_TO_RAD),this.setShadowCatcherEnabled(!0),this.setShadowCatcherIntensity(.4),this.setDebugGrid(!1),this.setDebugBounds(!1),this.setLightEnabled(!0),this.setLightShadow(!0),this.setLightFollow(!1),this.setSkyboxBackground("None"),this.setSkyboxExposure(0),this.setBackgroundColor(D.BLACK),this.app.scene.layers.getLayerById(2).enabled=!1,this.sceneRoot.enabled=!1},started:()=>{console.log("started"),this.multiframe.blend=.5,this.sceneRoot.enabled=!0},place:t=>{n=!0,this.multiframe.blend=1,r=0,i.copy(t),this.shadowCatcher.enabled=!0},rotate:t=>{s.y+=t},updateLighting:(t,e,s,i)=>{i&&o(i),this.light.light.intensity=t,this.light.light.color=e,this.light.setLocalRotation(s)},onUpdate:t=>{if(n)r=Math.min(1,r+3*t),e.lerp(e,i,.5*Math.sin((r-.5)*Math.PI)+.5);else{this.xrMode.getCameraMatrix().transformPoint(new R(0,0,-a),e)}},onPrerender:()=>{this.sceneRoot.setLocalPosition(e),this.sceneRoot.setLocalEulerAngles(s),this.sceneBounds=this.calcSceneBounds(),this.dirtyBounds=!0,this.dirtyGrid=!0},ended:()=>{o(null),this.multiframe.blend=1,this.reloadSettings(),this.sceneRoot.setLocalPosition(t.position),this.sceneRoot.setLocalEulerAngles(t.rotation),this.sceneBounds=this.calcSceneBounds(),this.dirtyBounds=!0,this.dirtyGrid=!0}};this.xrMode=new jA(this.app,this.camera,this.observer,l)}collectMeshInstances(t){const e=[];if(t){const s=t.findComponents("render");for(let t=0;t<s.length;t++){const i=s[t];if(i.meshInstances)for(let t=0;t<i.meshInstances.length;t++){const s=i.meshInstances[t];e.push(s)}}}return e}static calcMeshBoundingBox(t){const e=new $;for(let s=0;s<t.length;++s)0===s?e.copy(t[s].aabb):e.add(t[s].aabb);return e}static calcHierBoundingBox(t){const e=t.getPosition();let s=e.x,i=e.y,n=e.z,r=e.x,a=e.y,o=e.z;const l=t=>{const e=t.getPosition();e.x<s?s=e.x:e.x>r&&(r=e.x),e.y<i?i=e.y:e.y>a&&(a=e.y),e.z<n?n=e.z:e.z>o&&(o=e.z);for(let e=0;e<t.children.length;++e)l(t.children[e])};l(t);const h=new $;return h.setMinMax(new R(s,i,n),new R(r,a,o)),h}bindControlEvents(){const t={"camera.fov":this.setFov.bind(this),"camera.tonemapping":this.setTonemapping.bind(this),"camera.pixelScale":()=>{this.canvasResize=!0,this.renderNextFrame()},"camera.multisample":()=>{this.destroyRenderTargets(),this.renderNextFrame()},"camera.hq":t=>{this.multiframe.enabled=t,this.renderNextFrame()},"skybox.value":t=>{if(this.skyboxUrls.has(t)){const e=this.skyboxUrls.get(t);this.loadFiles([{url:e,filename:e}])}else"None"===t?this.clearSkybox():this.loadFiles([{url:t,filename:t}])},"skybox.blur":this.setSkyboxBlur.bind(this),"skybox.exposure":this.setSkyboxExposure.bind(this),"skybox.rotation":this.setSkyboxRotation.bind(this),"skybox.background":this.setSkyboxBackground.bind(this),"skybox.backgroundColor":this.setBackgroundColor.bind(this),"skybox.domeProjection.domeRadius":this.setSkyboxDomeRadius.bind(this),"skybox.domeProjection.domeOffset":this.setSkyboxDomeOffset.bind(this),"skybox.domeProjection.tripodOffset":this.setSkyboxTripodOffset.bind(this),"light.enabled":this.setLightEnabled.bind(this),"light.intensity":this.setLightIntensity.bind(this),"light.color":this.setLightColor.bind(this),"light.follow":this.setLightFollow.bind(this),"light.shadow":this.setLightShadow.bind(this),"shadowCatcher.enabled":this.setShadowCatcherEnabled.bind(this),"shadowCatcher.intensity":this.setShadowCatcherIntensity.bind(this),"debug.stats":this.setDebugStats.bind(this),"debug.wireframe":this.setDebugWireframe.bind(this),"debug.wireframeColor":this.setWireframeColor.bind(this),"debug.bounds":this.setDebugBounds.bind(this),"debug.skeleton":this.setDebugSkeleton.bind(this),"debug.axes":this.setDebugAxes.bind(this),"debug.grid":this.setDebugGrid.bind(this),"debug.normals":this.setNormalLength.bind(this),"debug.renderMode":this.setRenderMode.bind(this),"animation.playing":t=>{t?this.play():this.stop()},"animation.selectedTrack":this.setSelectedTrack.bind(this),"animation.speed":this.setSpeed.bind(this),"animation.transition":this.setTransition.bind(this),"animation.loops":this.setLoops.bind(this),"animation.progress":this.setAnimationProgress.bind(this),"scene.selectedNode.path":this.setSelectedNode.bind(this),"scene.variant.selected":this.setSelectedVariant.bind(this)};this.controlEventKeys=Object.keys(t),this.controlEventKeys.forEach((e=>{this.observer.on(`${e}:set`,t[e])}))}reloadSettings(){this.controlEventKeys.forEach((t=>{this.observer.set(t,this.observer.get(t),!1,!1,!0)}))}clearSkybox(){this.app.scene.envAtlas=null,this.app.scene.setSkybox(null),this.renderNextFrame(),this.skyboxLoaded=!1}initSkyboxFromTextureNew(t){const e=ua.generateSkyboxCubemap(t),s=ua.generateLightingSource(t),i=ua.generateAtlas(s,{});s.destroy(),this.app.scene.envAtlas=i,this.app.scene.skybox=e,this.renderNextFrame()}initSkyboxFromTexture(t){if(ua)return this.initSkyboxFromTextureNew(t);const e=this.app,s=e.graphicsDevice,i=t=>new Ue(s,{name:`skyboxFaces-${t}`,cubemap:!0,width:t,height:t,type:Dt,addressU:1,addressV:1,fixCubemapSeams:!0,mipmaps:!1}),n=[];n.push(ua.generateSkyboxCubemap(t));const r=ua.generateLightingSource(t),a=i(128);ca(r,a,{numSamples:1}),n.push(a);const o=[128,64,32,16,8,4],l=[1,512,128,32,8,2];for(let t=1;t<o.length;++t){const e=i(o[t]);ca(r,e,{numSamples:1024,specularPower:l[t],distribution:"ggx"}),n.push(e)}r.destroy(),e.scene.setSkybox(n),this.renderNextFrame()}loadSkybox(t){const e=this.app;if(6!==t.length){const s=new cl("skybox_equi","texture",{url:t[0].url,filename:t[0].filename});s.ready((()=>{const t=s.resource;t.type===kt&&7===t.format&&(t.type=Dt),this.initSkyboxFromTexture(t)})),e.assets.add(s),e.assets.load(s)}else{const s=[["posx","negx","posy","negy","posz","negz"],["px","nx","py","ny","pz","nz"],["right","left","up","down","front","back"],["right","left","top","bottom","forward","backward"],["0","1","2","3","4","5"]],i=t=>{const e=t.toLowerCase();for(let t=0;t<s.length;++t){const i=s[t];for(let t=0;t<i.length;++t)if(-1!==e.indexOf(i[t]+"."))return t}return 0},n=(t,e)=>{const s=i(t.filename),n=i(e.filename);return s<n?-1:n<s?1:0};t.sort(n);const r=t.map(((t,s)=>{const i=new cl("skybox_face"+s,"texture",t);return e.assets.add(i),e.assets.load(i),i})),a=new cl("skybox_cubemap","cubemap",null,{textures:r.map((t=>t.id))});a.loadFaces=!0,a.on("load",(()=>{this.initSkyboxFromTexture(a.resource)})),e.assets.add(a),e.assets.load(a)}this.skyboxLoaded=!0}getCanvasSize(){const t=this.canvas.getBoundingClientRect();return{width:t.width,height:t.height}}destroyRenderTargets(){const t=this.camera.camera.renderTarget;t&&(t.colorBuffer.destroy(),t.depthBuffer.destroy(),t.destroy(),this.camera.camera.renderTarget=null)}rebuildRenderTargets(){const t=this.app.graphicsDevice,e=t.width,s=t.height,i=this.camera.camera.renderTarget;if(i&&i.width===e&&i.height===s)return;this.destroyRenderTargets();const n=(e,s,i)=>new Ue(t,{width:e,height:s,format:i,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1}),r=n(e,s,7),a=n(e,s,it),o=new pe({colorBuffer:r,depthBuffer:a,flipY:!1,samples:this.observer.get("camera.multisample")?t.maxSamples:1,autoResolve:!1});this.camera.camera.renderTarget=o}resetScene(){const t=this.app;this.entities.forEach((t=>{this.sceneRoot.removeChild(t),this.shadowCatcher.onEntityRemoved(t),t.destroy()})),this.entities=[],this.entityAssets=[],this.assets.forEach((e=>{t.assets.remove(e),e.unload()})),this.assets=[],this.meshInstances=[],this.resetWireframeMeshes(),this.animTracks=[],this.animationMap={}}updateSceneInfo(){let t=0,e=0,s=0,i=0,n=0,r=0,a=0,o=[];this.assets.forEach((l=>{o=o.concat(l.resource.getMaterialVariants()),l.resource.renders.forEach((n=>{t+=n.resource.meshes.length,n.resource.meshes.forEach((t=>{var n,r;s+=t.vertexBuffer.getNumVertices(),i+=t.primitive[0].count,e+=t.vertexBuffer.numBytes+(null!==(r=null===(n=t.indexBuffer)||void 0===n?void 0:n.numBytes)&&void 0!==r?r:0)}))})),n+=l.resource.materials.length,r+=l.resource.textures.length,l.resource.textures.forEach((t=>{a+=t.resource.gpuSize}))}));const l=function(t){return t.children.map((t=>({name:t.name,path:t.path,children:l(t)})))},h=this.entities.map((t=>({name:t.name,path:t.path,children:l(t)})));this.observer.set("scene.nodes",JSON.stringify(h)),this.observer.set("scene.meshCount",t),this.observer.set("scene.materialCount",n),this.observer.set("scene.textureCount",r),this.observer.set("scene.vertexCount",s),this.observer.set("scene.primitiveCount",i),this.observer.set("scene.textureVRAM",a),this.observer.set("scene.meshVRAM",e),this.observer.set("scene.variants.list",JSON.stringify(o)),this.observer.set("scene.variant.selected",o[0])}downloadPngScreenshot(){const t=this.app.graphicsDevice,e=t.width,s=t.height,i=new Uint8Array(e*s*4);t.setRenderTarget(null),t.gl.readPixels(0,0,e,s,t.gl.RGBA,t.gl.UNSIGNED_BYTE,i),this.pngExporter.export("model-viewer.png",new Uint32Array(i.buffer),e,s)}focusCamera(){const t=this.camera.camera,e=this.calcSceneBounds(),s=1.4*e.halfExtents.length()/Math.sin(.5*t.fov*t.aspectRatio*k.DEG_TO_RAD);if(this.initialCameraPosition){const t=e.center.clone().sub(this.initialCameraPosition);this.orbitCamera.vecToAzimElevDistance(t,t),this.orbitCamera.azimElevDistance.snapto(t),this.initialCameraPosition=null}else{const t=this.orbitCamera.azimElevDistance.target.clone();t.z=s,this.orbitCamera.azimElevDistance.snapto(t)}this.orbitCamera.focalPoint.snapto(e.center)}fitCameraToScene(){const t=this.xrMode.getCameraMatrix(),e=t.getTranslation(),s=t.getZ(),i=this.dynamicSceneBounds,n=i.center,r=2*i.halfExtents.length();$A.sub2(n,e);const a=-$A.dot(s),o=a+r,l=Math.max(.001,a<r?o/1024:a-r);this.camera.camera.nearClip=l,this.camera.camera.farClip=o,this.light.light.shadowDistance=o,this.light.light.normalOffsetBias=o/1024}loadGltf(t,e){return new Promise(((s,i)=>{const n=new cl(t.filename,"container",t,null,{bufferView:{processAsync:function(t,e,s){if(t.extensions&&t.extensions.EXT_meshopt_compression){const i=t.extensions.EXT_meshopt_compression;Promise.all([hA.ready,e[i.buffer]]).then((t=>{const e=t[1],n=i.byteOffset||0,r=i.byteLength||0,a=i.count,o=i.byteStride,l=new Uint8Array(a*o),h=new Uint8Array(e.buffer,e.byteOffset+n,r);hA.decodeGltfBuffer(l,a,o,h,i.mode,i.filter),s(null,l)}))}else s(null,null)}.bind(this)},image:{processAsync:function(t,s){const i=e.find((e=>e.filename===u.normalize(t.uri||"")));if(i){const t=new cl(i.filename,"texture",{url:i.url,filename:i.filename});t.on("load",(()=>{s(null,t)})),this.app.assets.add(t),this.app.assets.load(t)}else s(null,null)}.bind(this),postprocess:(t,e)=>{e.resource.anisotropy=this.app.graphicsDevice.maxAnisotropy}},buffer:{processAsync:function(t,s){const i=e.find((e=>e.filename===u.normalize(t.uri||"")));if(i){const t=new cl(i.filename,"binary",{url:i.url,filename:i.filename});t.on("load",(()=>{s(null,new Uint8Array(t.resource))})),this.app.assets.add(t),this.app.assets.load(t)}else s(null,null)}.bind(this)}});n.on("load",(()=>s(n))),n.on("error",(t=>i(t))),this.app.assets.add(n),this.app.assets.load(n)}))}isModelFilename(t){const e=t.split("?")[0].split("/").pop().split(".");return 1===e.length||qA.includes(e.pop().toLowerCase())}loadFiles(t,e=!1){Array.isArray(t)||(t=[t]);const s=t.reduce(((t,e)=>t||this.isModelFilename(e.filename)),!1);if(s){e&&this.resetScene();const s=Date.now();this.observer.set("spinner",!0),this.observer.set("error",null),this.clearCta();const i=t.map((e=>this.isModelFilename(e.filename)?this.loadGltf(e,t):null));Promise.all(i).then((i=>{this.loadTimestamp=s,i.forEach((t=>{t&&this.addToScene(t)})),this.postSceneLoad();const n=t.map((t=>t.url)),r=t.map((t=>t.filename.split("/").pop()));e?(this.observer.set("scene.urls",n),this.observer.set("scene.filenames",r)):(this.observer.set("scene.urls",this.observer.get("scene.urls").concat(n)),this.observer.set("scene.filenames",this.observer.get("scene.filenames").concat(r)))})).catch((t=>{this.observer.set("error",t)})).finally((()=>{this.observer.set("spinner",!1)}))}else this.loadSkybox(t);return s}setSelectedTrack(t){if("ALL_TRACKS"!==t){const e=this.animationMap[t];this.entities.forEach((t=>{var s,i;null===(i=null===(s=t.anim)||void 0===s?void 0:s.baseLayer)||void 0===i||i.transition(e)}))}}play(){this.entities.forEach((t=>{var e;t.anim&&(t.anim.playing=!0,null===(e=t.anim.baseLayer)||void 0===e||e.play())}))}stop(){this.entities.forEach((t=>{var e;t.anim&&(t.anim.playing=!1,null===(e=t.anim.baseLayer)||void 0===e||e.pause())}))}setSpeed(t){this.animSpeed=t,this.entities.forEach((e=>{const s=e.anim;s&&(s.speed=t)}))}setTransition(t){this.animTransition=t,this.animTracks.length>0&&this.rebuildAnimTracks()}setLoops(t){this.animLoops=t,this.animTracks.length>0&&this.rebuildAnimTracks()}setAnimationProgress(t){this.suppressAnimationProgressUpdate||(this.entities.forEach((e=>{const s=e.anim,i=null==s?void 0:s.baseLayer;i&&(this.play(),i.activeStateCurrentTime=i.activeStateDuration*t,s.update(0),s.playing=!1)})),this.renderNextFrame())}setSelectedNode(t){const e=this.app.root.findByPath(t);e&&this.observer.set("scene.selectedNode",{name:e.name,path:t,position:e.getLocalPosition().toString(),rotation:e.getLocalEulerAngles().toString(),scale:e.getLocalScale().toString()}),this.selectedNode=e,this.dirtySkeleton=!0,this.renderNextFrame()}setSelectedVariant(t){t&&(this.entityAssets.forEach((e=>{-1!==e.asset.resource.getMaterialVariants().indexOf(t)&&e.asset.resource.applyMaterialVariant(e.entity,t)})),this.renderNextFrame())}setDebugStats(t){this.miniStats.enabled=t,this.renderNextFrame()}setDebugWireframe(t){this.showWireframe=t,this.dirtyWireframe=!0,this.renderNextFrame()}setWireframeColor(t){this.wireframeMaterial.emissive=new D(t.r,t.g,t.b),this.wireframeMaterial.update(),this.renderNextFrame()}setDebugBounds(t){this.showBounds=t,this.dirtyBounds=!0,this.renderNextFrame()}setDebugSkeleton(t){this.showSkeleton=t,this.dirtySkeleton=!0,this.renderNextFrame()}setDebugAxes(t){this.showAxes=t,this.dirtySkeleton=!0,this.renderNextFrame()}setDebugGrid(t){this.showGrid=t,this.dirtyGrid=!0,this.renderNextFrame()}setNormalLength(t){this.normalLength=t,this.dirtyNormals=!0,this.renderNextFrame()}setFov(t){this.camera.camera.fov=t,this.renderNextFrame()}setRenderMode(t){this.camera.camera.setShaderPass("default"!==t?`debug_${t}`:"forward"),this.renderNextFrame()}setLightEnabled(t){this.light.enabled=t,this.renderNextFrame()}setLightIntensity(t){this.light.light.intensity=t,this.renderNextFrame()}setLightColor(t){this.light.light.color=new D(t.r,t.g,t.b),this.renderNextFrame()}setLightFollow(t){this.light.reparent(t?this.camera:this.app.root),t?this.light.setLocalEulerAngles(90,0,0):this.light.setLocalEulerAngles(45,30,0),this.renderNextFrame()}setLightShadow(t){this.light.light.castShadows=t,this.renderNextFrame()}setShadowCatcherEnabled(t){this.shadowCatcher.enabled=t,this.renderNextFrame()}setShadowCatcherIntensity(t){this.shadowCatcher.intensity=t,this.renderNextFrame()}setSkyboxExposure(t){this.app.scene.skyboxIntensity=Math.pow(2,t),this.renderNextFrame()}setSkyboxRotation(t){const e=new H;e.setFromEulerAngles(0,t,0),this.app.scene.skyboxRotation=e,this.renderNextFrame()}setSkyboxBackground(t){this.app.scene.layers.getLayerById(2).enabled="Solid Color"!==t,this.app.scene.skyboxMip="Infinite Sphere"===t?this.observer.get("skybox.blur"):0,this.projectiveSkybox.enabled="Projective Dome"===t,this.renderNextFrame()}setSkyboxBlur(t){this.app.scene.skyboxMip="Infinite Sphere"===this.observer.get("skybox.background")?t:0,this.renderNextFrame()}setSkyboxDomeRadius(t){var e,s;this.projectiveSkybox.domeRadius=(null!==(s=null===(e=this.sceneBounds)||void 0===e?void 0:e.halfExtents.length())&&void 0!==s?s:1)*t,this.renderNextFrame()}setSkyboxDomeOffset(t){this.projectiveSkybox.domeOffset=t,this.renderNextFrame()}setSkyboxTripodOffset(t){this.projectiveSkybox.tripodOffset=t,this.renderNextFrame()}setTonemapping(t){const e={Linear:0,Filmic:1,Hejl:2,ACES:3,ACES2:4};this.app.scene.toneMapping=e.hasOwnProperty(t)?e[t]:3,this.renderNextFrame()}setBackgroundColor(t){const e=t=>Math.max(0,Math.min(255,Math.floor(255*t)));document.getElementById("canvas-wrapper").style.backgroundColor=`rgb(${e(t.r)}, ${e(t.g)}, ${e(t.b)})`}update(t){this.xrMode.onUpdate(t),this.xrMode.active||(this.orbitCameraInputKeyboard.update(t,this.sceneBounds?2*this.sceneBounds.halfExtents.length():1),this.orbitCamera.update(t));const e=this.camera.getWorldTransform();((t,e)=>{let s=0;for(let i=0;i<16;++i)s=Math.max(s,Math.abs(t.data[i]-e.data[i]));return s})(e,this.prevCameraMat)>1e-4&&(this.prevCameraMat.copy(e),this.renderNextFrame()),this.xrMode.active&&this.renderNextFrame();let s=!1;for(let t=0;t<this.entities.length;++t){const e=this.entities[t].anim;if(e&&e.baseLayer&&e.baseLayer.playing){s=!0;break}}s&&(this.dirtyBounds=!0,this.dirtySkeleton=!0,this.dirtyNormals=!0,this.renderNextFrame(),this.observer.emit("animationUpdate")),this.miniStats.enabled&&this.renderNextFrame()}renderNextFrame(){this.app.renderNextFrame=!0,this.multiframe&&this.multiframe.moved()}clearCta(){document.querySelector("#panel-left").classList.add("no-cta"),document.querySelector("#application-canvas").classList.add("no-cta"),document.querySelector(".load-button-panel").classList.add("hide")}addToScene(t){const e=t.resource,s=e.renders&&e.renders.length>0,i=e.animations&&e.animations.length>0,n=0===this.entities.length?null:this.entities[this.entities.length-1];let r;!s&&n&&n.findComponent("render")?r=n:(r=t.resource.instantiateRenderEntity(),this.entities.push(r),this.entityAssets.push({entity:r,asset:t}),this.sceneRoot.addChild(r),this.shadowCatcher.onEntityAdded(r)),i&&e.animations.forEach((t=>{this.animTracks.push(t.resource)})),this.assets.push(t)}postSceneLoad(){this.meshInstances=this.entities.map((t=>this.collectMeshInstances(t))).flat(),0===this.meshInstances.length&&this.observer.set("debug.skeleton",!0),this.updateSceneInfo(),this.animTracks.length>0&&this.rebuildAnimTracks();const t={},e={};this.meshInstances.forEach(((s,i)=>{if(s.morphInstance){const n=s.morphInstance;e[i]=n;const r=s&&s.node&&s.node.name||"Mesh "+i;t[i]={name:r,targets:{}},n.morph.targets.forEach(((s,n)=>{t[i].targets[n]={name:s.name,targetIndex:n},this.observer.on(`morphs.${i}.targets.${n}.weight:set`,(t=>{e[i].setWeight(n,t),this.dirtyNormals=!0,this.renderNextFrame()}))}))}})),this.observer.suspendEvents=!0,this.observer.set("morphs",t),this.observer.suspendEvents=!1;const s=this.observer;s.on("animationUpdate",(()=>{for(let t=0;t<this.entities.length;++t){const e=this.entities[t];if(e&&e.anim){const t=e.anim.baseLayer,i=t.activeStateCurrentTime/t.activeStateDuration;this.suppressAnimationProgressUpdate=!0,s.set("animation.progress",1===i?i:i%1),this.suppressAnimationProgressUpdate=!1;break}}})),this.dirtyWireframe=this.dirtyBounds=this.dirtySkeleton=this.dirtyGrid=this.dirtyNormals=!0,this.sceneRoot.setLocalPosition(0,0,0),this.firstFrame=!0,this.renderNextFrame()}rebuildAnimTracks(){this.entities.forEach((t=>{t.anim?t.anim.removeStateGraph():(t.addComponent("anim",{activate:!0,speed:this.animSpeed}),t.anim.rootBone=t),this.animTracks.forEach(((e,s)=>{e.events=new dh([{name:"transition",time:e.duration,nextTrack:"track_"+(s===this.animTracks.length-1?0:s+1)}]),t.anim.assignAnimation("track_"+s,e),this.animationMap[e.name]="track_"+s})),t.anim.on("transition",(e=>{"ALL_TRACKS"===this.observer.get("animation.selectedTrack")&&t.anim.baseLayer.activeStateProgress>=this.animLoops&&t.anim.baseLayer.transition(e.nextTrack,this.animTransition)}))}));const t=this.observer.get("animation"),e=Object.keys(this.animationMap);t.list=JSON.stringify(e),t.selectedTrack=e[0],t.playing=!0,this.observer.set("animation",t)}calcSceneBounds(){return this.meshInstances.length?KA.calcMeshBoundingBox(this.meshInstances):this.sceneRoot.children.length?KA.calcHierBoundingBox(this.sceneRoot):XA}resetWireframeMeshes(){this.app.scene.layers.getLayerByName("World").removeMeshInstances(this.wireframeMeshInstances),this.wireframeMeshInstances.forEach((t=>{t.clearShaders()})),this.wireframeMeshInstances=[]}buildWireframeMeshes(){this.wireframeMeshInstances=this.meshInstances.map((t=>{const e=new Sn(t.mesh,this.wireframeMaterial,t.node);return e.renderStyle=1,e.skinInstance=t.skinInstance,e.morphInstance=t.morphInstance,e})),this.app.scene.layers.getLayerByName("World").addMeshInstances(this.wireframeMeshInstances)}onPrerender(){if(this.canvasResize){const{width:t,height:e}=this.getCanvasSize(),s=this.observer.get("camera.pixelScale"),i=Math.floor(t*window.devicePixelRatio/s),n=Math.floor(e*window.devicePixelRatio/s);this.canvas.width=i,this.canvas.height=n,this.canvasResize=!1}if(this.rebuildRenderTargets(),!this.firstFrame){if(this.dirtyWireframe&&(this.dirtyWireframe=!1,this.resetWireframeMeshes(),this.showWireframe&&this.buildWireframeMeshes(),this.meshInstances.forEach((t=>{t.material.depthBias=this.showWireframe?-1:0,t.material.slopeDepthBias=this.showWireframe?1:0}))),this.dirtyBounds){this.dirtyBounds=!1,this.dynamicSceneBounds=this.calcSceneBounds(),this.debugBounds.clear(),this.showBounds&&this.debugBounds.box(this.dynamicSceneBounds.getMin(),this.dynamicSceneBounds.getMax()),this.debugBounds.update();const t=new R(2*this.dynamicSceneBounds.halfExtents.x,2*this.dynamicSceneBounds.halfExtents.y,2*this.dynamicSceneBounds.halfExtents.z);this.observer.set("scene.bounds",t.toString())}if(this.dirtyNormals){if(this.dirtyNormals=!1,this.debugNormals.clear(),this.normalLength>0)for(let t=0;t<this.meshInstances.length;++t){const e=this.meshInstances[t],s=e.morphInstance?e.morphInstance._vertexBuffer:e.mesh.vertexBuffer;if(s){const t=e.skinInstance?e.skinInstance.matrices:null;t&&e.skinInstance.updateMatrices(e.node),this.debugNormals.generateNormals(s,e.node.getWorldTransform(),this.normalLength,t)}}this.debugNormals.update()}if(this.dirtySkeleton&&(this.dirtySkeleton=!1,this.debugSkeleton.clear(),(this.showSkeleton||this.showAxes)&&this.entities.forEach((t=>{(0===this.meshInstances.length||t.findComponent("render"))&&this.debugSkeleton.generateSkeleton(t,this.showSkeleton,this.showAxes,this.selectedNode)})),this.debugSkeleton.update()),this.sceneBounds&&this.dirtyGrid){if(this.dirtyGrid=!1,this.debugGrid.clear(),this.showGrid){const t=Math.pow(10,Math.floor(Math.log10(this.sceneBounds.halfExtents.length()))),e=new R(0,0,0),s=new R(0,0,0),i=this.sceneBounds.getMin().y,n=10,r=n*t;for(let a=-n;a<n+1;++a){const n=a*t;e.set(-r,i,n),s.set(r,i,n),this.debugGrid.line(e,s,0===n?2147483648:2164260863),e.set(n,i,-r),s.set(n,i,r),this.debugGrid.line(e,s,0===n?2147483648:2164260863)}}this.debugGrid.update()}this.fitCameraToScene(),this.shadowCatcher.onUpdate(this.dynamicSceneBounds),this.xrMode.onPrerender()}}onPostrender(){!this.firstFrame&&this.camera.camera.renderTarget._samples>1&&this.camera.camera.renderTarget.resolve(),this.multiframeBusy=this.multiframe.update()}onFrameend(){this.firstFrame&&(this.firstFrame=!1,this.sceneBounds=this.calcSceneBounds(),this.sceneRoot.setLocalPosition(-this.sceneBounds.center.x,-this.sceneBounds.getMin().y,-this.sceneBounds.center.z),this.projectiveSkybox.domeRadius=this.sceneBounds.halfExtents.length()*this.observer.get("skybox.domeProjection.domeRadius"),this.focusCamera(),this.renderNextFrame()),null!==this.loadTimestamp&&(this.observer.set("scene.loadTime",Date.now()-this.loadTimestamp+"ms"),this.loadTimestamp=null),this.multiframeBusy&&(this.app.renderNextFrame=!0)}setSamples(t,e=!1,s=1,i=0){this.multiframe.setSamples(t,e,s,i),this.renderNextFrame()}}var YA=KA;console.log(`Model Viewer v3.4.0 | PCUI v4.1.1 (1a087da) | PlayCanvas Engine v${n} (${r})`);const QA=new URL(window.location.href),JA=new bu({ui:{active:null},camera:{fov:40,tonemapping:"Linear",pixelScale:1,multisampleSupported:!0,multisample:!0,hq:!0},skybox:{value:"Paul Lobe Haus",options:null,exposure:0,rotation:0,background:"Infinite Sphere",backgroundColor:{r:.4,g:.45,b:.5},blur:1,domeProjection:{domeRadius:20,domeOffset:.4,tripodOffset:.1}},light:{enabled:!1,color:{r:1,g:1,b:1},intensity:1,follow:!1,shadow:!1},shadowCatcher:{enabled:!1,intensity:.4},debug:{renderMode:"default",stats:!1,wireframe:!1,wireframeColor:{r:0,g:0,b:0},bounds:!1,skeleton:!1,axes:!1,grid:!0,normals:0},animation:{playing:!1,speed:1,transition:.1,loops:1,list:"[]",progress:0,selectedTrack:"ALL_TRACKS"},scene:{urls:[],filenames:[],nodes:"[]",selectedNode:{path:"",name:null,position:{0:0,1:0,2:0},rotation:{0:0,1:0,2:0,3:0},scale:{0:0,1:0,2:0}},meshCount:null,materialCount:null,textureCount:null,vertexCount:null,primitiveCount:null,textureVRAM:null,meshVRAM:null,bounds:null,variant:{selected:0},variants:{list:"[]"},loadTime:null},morphs:null,spinner:!1,error:null,xrSupported:!1,xrActive:!1});(()=>{const t=Object.getOwnPropertyDescriptor(Ki.prototype,"blendType");Su=t.set,Object.defineProperty(Ki.prototype,"blendType",{set(t){Cu.call(this,t)},get(){return t.get.call(this)}})})(),(t=>{gC.render(lp.createElement(aA,{observer:t}),document.getElementById("app"))})(JA),yd({glueUrl:yu("lib/basis/basis.wasm.js"),wasmUrl:yu("lib/basis/basis.wasm.wasm"),fallbackUrl:yu("lib/basis/basis.js"),lazyInit:!0}),C.setConfig("DracoDecoderModule",{glueUrl:yu("lib/draco/draco.wasm.js"),wasmUrl:yu("lib/draco/draco.wasm.wasm"),fallbackUrl:yu("lib/draco/draco.js")}),JA.on("spinner:set",(t=>{const e=document.getElementById("spinner");t?e.classList.remove("pcui-hidden"):e.classList.add("pcui-hidden")}));const ZA=new Map,tk=[{v:"None",t:"None"}];[{label:"Abandoned Tank Farm",url:"./skybox/abandoned_tank_farm_01_2k.hdr"},{label:"Adam's Place Bridge",url:"./skybox/adams_place_bridge_2k.hdr"},{label:"Artist Workshop",url:"./skybox/artist_workshop_2k.hdr"},{label:"Ballroom",url:"./skybox/ballroom_2k.hdr"},{label:"Circus Arena",url:"./skybox/circus_arena_2k.hdr"},{label:"Colorful Studio",url:"./skybox/colorful_studio.hdr"},{label:"Golf Course Sunrise",url:"./skybox/golf_course_sunrise_2k.hdr"},{label:"Helipad",url:"./skybox/Helipad_equi.png"},{label:"Kloppenheim",url:"./skybox/kloppenheim_02_2k.hdr"},{label:"Lebombo",url:"./skybox/lebombo_2k.hdr"},{label:"Outdoor Umbrellas",url:"./skybox/outdoor_umbrellas_2k.hdr"},{label:"Paul Lobe Haus",url:"./skybox/paul_lobe_haus_2k.hdr"},{label:"Reinforced Concrete",url:"./skybox/reinforced_concrete_01_2k.hdr"},{label:"Rural Asphalt Road",url:"./skybox/rural_asphalt_road_2k.hdr"},{label:"Spruit Sunrise",url:"./skybox/spruit_sunrise_2k.hdr"},{label:"Studio Small",url:"./skybox/studio_small_03_2k.hdr"},{label:"Venice Sunset",url:"./skybox/venice_sunset_1k.hdr"},{label:"Vignaioli Night",url:"./skybox/vignaioli_night_2k.hdr"},{label:"Wooden Motel",url:"./skybox/wooden_motel_2k.hdr"}].forEach((t=>{ZA.set(t.label,yu(t.url)),tk.push({v:t.label,t:t.label})}));const ek=JA.get("skybox");ek.options=JSON.stringify(tk),JA.set("skybox",ek),(t=>{QA.searchParams.has("default")||(((t,e)=>{const s=["skybox.options","debug.renderMode"],i=(t,n)=>{-1===s.indexOf(t)&&("object"==typeof n?Object.keys(n).forEach((e=>{i(t?`${t}.${e}`:e,n[e])})):("skybox.value"!==t||"None"===n||e.has(n))&&JA.set(t,n))},n=window.localStorage.getItem(`model-viewer-${t}`);if(n)try{i("",JSON.parse(n))}catch(t){}})("uistate",t),JA.on("*:set",(()=>{(t=>{const e=JA.json();window.localStorage.setItem(`model-viewer-${t}`,JSON.stringify({camera:e.camera,skybox:e.skybox,light:e.light,debug:e.debug,shadowCatcher:e.shadowCatcher}))})("uistate")})));const e=document.getElementById("application-canvas"),s=new YA(e,JA,t);window.viewer=s;const i=[];for(const[t,e]of QA.searchParams)switch(t){case"load":case"assetUrl":{const t=decodeURIComponent(e);i.push({url:t,filename:t});break}case"cameraPosition":{const t=e.split(",").map(Number);3===t.length&&(s.initialCameraPosition=new R(t));break}default:if(JA.has(t))switch(typeof JA.get(t)){case"boolean":JA.set(t,"true"===e.toLowerCase());break;case"number":JA.set(t,Number(e));break;default:JA.set(t,decodeURIComponent(e))}}i.length>0&&s.loadFiles(i)})(ZA);
//# sourceMappingURL=index.js.map
